<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>ç®—æ³•åŸºç¡€è¯¾(æŒç»­æ›´æ–°ä¸­)</title>
    <url>/algorithm_learning/</url>
    <content><![CDATA[<p>ç®—æ³•åŸºç¡€è¯¾</p>
<h2 id="åŸºç¡€ç®—æ³•ï¼ˆä¸€ï¼‰">åŸºç¡€ç®—æ³•ï¼ˆä¸€ï¼‰</h2>
<h3 id="å¿«é€Ÿæ’åº">å¿«é€Ÿæ’åº</h3>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">quick_sort</span><span class="params">(<span class="type">int</span> q[],<span class="type">int</span> l,<span class="type">int</span> r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(l&gt;=r)<span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> i=l<span class="number">-1</span>,j=r<span class="number">+1</span>,x=q[l+r&gt;&gt;<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">while</span>(i&lt;j)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">do</span> i++;<span class="keyword">while</span>(q[i]&lt;x);</span><br><span class="line">        <span class="keyword">do</span> j--;<span class="keyword">while</span>(q[j]&gt;x);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">quick_sort</span>(q,l,j);</span><br><span class="line">    <span class="built_in">quick_sort</span>(q,j<span class="number">+1</span>,r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="å½’å¹¶æ’åº">å½’å¹¶æ’åº</h3>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">merge_sort</span><span class="params">(<span class="type">int</span> q[],<span class="type">int</span> l,<span class="type">int</span> r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(l&gt;=r)<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> mid=l+r&gt;&gt;<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">merge_sort</span>(q,l,mid),<span class="built_in">merge_sort</span>(q,mid<span class="number">+1</span>,r)ï¼›</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> k=<span class="number">0</span>,i=l,j=mid<span class="number">+1</span>;</span><br><span class="line">    <span class="keyword">while</span>(i&lt;=mid&amp;&amp;j&lt;=r)</span><br><span class="line">        <span class="keyword">if</span>(q[i]&lt;=q[j])tmp[k++]=q[i++];</span><br><span class="line">    <span class="keyword">else</span> tmp[k++]=q[j++];</span><br><span class="line">    <span class="keyword">while</span>(i&lt;=mid)tmp[k++]=q[i++];</span><br><span class="line">    <span class="keyword">while</span>(j&lt;=r)tmp[k++]=q[j++];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i=l,j=<span class="number">0</span>;i&lt;=r;i++,j++)q[i]=tmp[j];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="äºŒåˆ†">äºŒåˆ†</h3>
<h4 id="æ•´æ•°äºŒåˆ†">æ•´æ•°äºŒåˆ†</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">check</span><span class="params">(<span class="type">int</span> x)</span> </span>&#123;<span class="comment">/* ... */</span>&#125; <span class="comment">// æ£€æŸ¥xæ˜¯å¦æ»¡è¶³æŸç§æ€§è´¨</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">// åŒºé—´[l, r]è¢«åˆ’åˆ†æˆ[l, mid]å’Œ[mid + 1, r]æ—¶ä½¿ç”¨ï¼š</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">bsearch_1</span><span class="params">(<span class="type">int</span> l, <span class="type">int</span> r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (l &lt; r)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> mid = l + r &gt;&gt; <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">check</span>(mid)) r = mid;    <span class="comment">// check()åˆ¤æ–­midæ˜¯å¦æ»¡è¶³æ€§è´¨</span></span><br><span class="line">        <span class="keyword">else</span> l = mid + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> l;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// åŒºé—´[l, r]è¢«åˆ’åˆ†æˆ[l, mid - 1]å’Œ[mid, r]æ—¶ä½¿ç”¨ï¼š</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">bsearch_2</span><span class="params">(<span class="type">int</span> l, <span class="type">int</span> r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (l &lt; r)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> mid = l + r + <span class="number">1</span> &gt;&gt; <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">check</span>(mid)) l = mid;</span><br><span class="line">        <span class="keyword">else</span> r = mid - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> l;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="æµ®ç‚¹æ•°äºŒåˆ†">æµ®ç‚¹æ•°äºŒåˆ†</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">check</span><span class="params">(<span class="type">double</span> x)</span> </span>&#123;<span class="comment">/* ... */</span>&#125; <span class="comment">// æ£€æŸ¥xæ˜¯å¦æ»¡è¶³æŸç§æ€§è´¨</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">double</span> <span class="title">bsearch_3</span><span class="params">(<span class="type">double</span> l, <span class="type">double</span> r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">double</span> eps = <span class="number">1e-6</span>;   <span class="comment">// eps è¡¨ç¤ºç²¾åº¦ï¼Œå–å†³äºé¢˜ç›®å¯¹ç²¾åº¦çš„è¦æ±‚</span></span><br><span class="line">    <span class="keyword">while</span> (r - l &gt; eps)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">double</span> mid = (l + r) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">check</span>(mid)) r = mid;</span><br><span class="line">        <span class="keyword">else</span> l = mid;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> l;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="åŸºç¡€ç®—æ³•ï¼ˆäºŒï¼‰">åŸºç¡€ç®—æ³•ï¼ˆäºŒï¼‰</h2>
<h3 id="é«˜ç²¾åº¦">é«˜ç²¾åº¦</h3>
<h4 id="é«˜ç²¾åº¦åŠ æ³•">é«˜ç²¾åº¦åŠ æ³•</h4>
<p>æœ¬è´¨ä¸Šæ˜¯æ¨¡æ‹Ÿäººè¿›è¡Œåˆ—ç«–å¼åŠ æ³•çš„è¿‡ç¨‹ï¼Œå³$a_1$+â€¦+$a_n$+tï¼Œå…¶ä¸­å½“$a$çš„é€€ä¸€ä½åŠ èµ·æ¥ä¸è¶…è¿‡10åˆ™$t=0$å¦åˆ™$t=1$ï¼Œä»¥æ­¤ç±»æ¨</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line">vector&lt;<span class="type">int</span>&gt;<span class="built_in">add</span>(vector&lt;<span class="type">int</span>&gt;&amp;A,vector&lt;<span class="type">int</span>&gt;&amp;B)</span><br><span class="line">&#123;</span><br><span class="line">    vector&lt;<span class="type">int</span>&gt;C;</span><br><span class="line">    <span class="type">int</span> t=<span class="number">0</span>;<span class="comment">//å­˜å‚¨æ¯ä¸€ä½ç›¸åŠ åçš„æ•°ï¼ŒåŒæ—¶å®Œæˆæ˜¯å¦éœ€è¦è¿›ä½çš„è€ƒé‡</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;A.<span class="built_in">size</span>()||i&lt;B.<span class="built_in">size</span>();i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(i&lt;A.<span class="built_in">size</span>())t+=A[i];</span><br><span class="line">        <span class="keyword">if</span>(i&lt;B.<span class="built_in">size</span>())t+=B[i];</span><br><span class="line">        C.<span class="built_in">push_back</span>(t%<span class="number">10</span>);</span><br><span class="line">        t/=<span class="number">10</span>;</span><br><span class="line">	&#125;    </span><br><span class="line">    <span class="keyword">if</span>(t)C.<span class="built_in">push_back</span>(<span class="number">1</span>);<span class="comment">//æœ€åä¸€ä¸ªtä»£è¡¨æœ€é«˜ä½ï¼Œå› æ­¤ç­‰forå¾ªç¯è¿è¡Œå®Œåå†ç”¨åˆ¤æ–­çœ‹çœ‹è¿›ä½æƒ…å†µï¼Œæ˜¯çš„è¯å°±åœ¨vectoråé¢å†åŠ ä¸€ä¸ª1</span></span><br><span class="line">    <span class="keyword">return</span> C;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string a,b;</span><br><span class="line">    vector&lt;<span class="type">int</span>&gt;A,B;</span><br><span class="line">    cin&gt;&gt;a&gt;&gt;b;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=a.<span class="built_in">size</span>()<span class="number">-1</span>;i&gt;=<span class="number">0</span>;i--)A.<span class="built_in">push_back</span>(a[i]-<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=b.<span class="built_in">size</span>()<span class="number">-1</span>;i&gt;=<span class="number">0</span>;i--)B.<span class="built_in">push_back</span>(b[i]-<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line"><span class="comment">//Aã€Bå…ƒç´ è¿›æ ˆéƒ½æ˜¯é€†åºè¿›æ ˆï¼Œæ¯”å¦‚a=&#x27;123456&#x27;,é‚£A=[6.5,4,3,2,1],ç›®çš„æ˜¯æ–¹ä¾¿è¿›ä½å¤šäº†1çš„æ—¶å€™æ•´ä½“æ•°ç»„æŒªåŠ¨ç©ºé—´ä¸å¤§ï¼Œå¦åˆ™è¦æ˜¯æœ€é«˜ä½åœ¨å‰è¾¹taè¿›ä½åé¢æ•°ç»„æ‰€æœ‰æ•°å­—éƒ½è¦å¾€åæŒª</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">auto</span> C=<span class="built_in">add</span>(A,B);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=C.<span class="built_in">size</span>()<span class="number">-1</span>;i&gt;=<span class="number">0</span>;i--)cout&lt;&lt;C[i];</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="vectorç›¸å…³çŸ¥è¯†ç‚¹">vectorç›¸å…³çŸ¥è¯†ç‚¹</h5>
<ul>
<li>
<p><strong>vectorå®šä¹‰</strong> <code>vector</code> æ˜¯ C++ æ ‡å‡†æ¨¡æ¿åº“ï¼ˆSTLï¼‰ä¸­çš„ä¸€ä¸ªå®¹å™¨ï¼Œå®ƒå¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªåŠ¨æ€æ•°ç»„ã€‚å®ƒèƒ½å­˜å‚¨ä¸€ç³»åˆ—ç›¸åŒç±»å‹çš„å…ƒç´ ï¼Œå¹¶ä¸”å¯ä»¥æ ¹æ®éœ€è¦è‡ªåŠ¨è°ƒæ•´å¤§å°ã€‚ä½¿ç”¨ <code>vector</code> éœ€è¦åŒ…å« <code>&lt;vector&gt;</code> å¤´æ–‡ä»¶ã€‚</p>
</li>
<li>
<p><strong>vectoræ•°ç»„ç›¸å…³æ“ä½œ</strong>ï¼ˆæœ€åé¢ï¼‰å¢åŠ ç”¨<code>.push_back(ä¸€ä¸ªæ•°)</code>ï¼Œï¼ˆæœ€åé¢ï¼‰åˆ é™¤<code>.pop_back(ä¸€ä¸ªæ•°)</code>ï¼ŒæŒ‡å®šä½ç½®æ’å…¥<code>.insert(å‘é‡,æŒ‡å®šä½ç½®)</code>ï¼ŒæŒ‡å®šä½ç½®åˆ é™¤<code>.erase(å‘é‡ï¼ŒæŒ‡å®šä½ç½®)</code>ï¼Œæ¸…ç©º<code>.clear()</code>ï¼ŒæŸ¥çœ‹å¤§å°<code>.size()</code></p>
</li>
<li>
<p><strong>vectorå…ƒç´ çš„ç´¢å¼•å’Œæ•°ç»„ä¸€æ ·ï¼Œä¹Ÿæ˜¯ä» 0 å¼€å§‹å­˜å‚¨çš„</strong></p>
</li>
<li>
<p><strong>vectorå’Œæ™®é€šæ•°ç»„åŒºåˆ«</strong></p>
<p>1.å¤§å°çµæ´»æ€§</p>
<ul>
<li><strong>æ™®é€šæ•°ç»„</strong>ï¼šå¤§å°åœ¨å®šä¹‰æ—¶å°±å¿…é¡»ç¡®å®šï¼Œä¸”åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ä¸èƒ½æ”¹å˜ã€‚ä¾‹å¦‚ <code>int arr[10];</code> å®šä¹‰äº†ä¸€ä¸ªå¤§å°ä¸º 10 çš„æ•´æ•°æ•°ç»„ï¼Œä¹‹åæ— æ³•å†æ”¹å˜å…¶å¤§å°ã€‚</li>
<li><strong>vector</strong>ï¼šå¯ä»¥åŠ¨æ€è°ƒæ•´å¤§å°ã€‚å¯ä»¥ä½¿ç”¨ <code>push_back()</code> æ–¹æ³•åœ¨æœ«å°¾æ·»åŠ å…ƒç´ ï¼Œå½“ç©ºé—´ä¸è¶³æ—¶ï¼Œ<code>vector</code> ä¼šè‡ªåŠ¨åˆ†é…æ›´å¤§çš„å†…å­˜ç©ºé—´æ¥å­˜å‚¨å…ƒç´ ã€‚</li>
</ul>
<p>2.å†…å­˜ç®¡ç†</p>
<ul>
<li><strong>æ™®é€šæ•°ç»„</strong>ï¼šç”±ç¨‹åºå‘˜æ‰‹åŠ¨ç®¡ç†å†…å­˜ã€‚å¦‚æœæ•°ç»„åœ¨æ ˆä¸Šåˆ†é…ï¼Œå…¶ç”Ÿå‘½å‘¨æœŸå—é™äºæ‰€åœ¨çš„ä»£ç å—ï¼›å¦‚æœåœ¨å †ä¸Šåˆ†é…ï¼ˆä½¿ç”¨ <code>new</code>ï¼‰ï¼Œåˆ™éœ€è¦æ‰‹åŠ¨ä½¿ç”¨ <code>delete</code> é‡Šæ”¾å†…å­˜ï¼Œå¦åˆ™ä¼šé€ æˆå†…å­˜æ³„æ¼ã€‚</li>
<li><strong>vector</strong>ï¼šè‡ªåŠ¨ç®¡ç†å†…å­˜ã€‚å½“ <code>vector</code> ä¸å†ä½¿ç”¨æ—¶ï¼Œå…¶å ç”¨çš„å†…å­˜ä¼šè‡ªåŠ¨é‡Šæ”¾ï¼Œæ— éœ€ç¨‹åºå‘˜æ‰‹åŠ¨å¹²é¢„ã€‚</li>
</ul>
<p>3.åŠŸèƒ½ä¸°å¯Œåº¦</p>
<ul>
<li><strong>æ™®é€šæ•°ç»„</strong>ï¼šåªæä¾›åŸºæœ¬çš„å…ƒç´ è®¿é—®åŠŸèƒ½ï¼Œæ“ä½œç›¸å¯¹æœ‰é™ã€‚</li>
<li><strong>vector</strong>ï¼šæä¾›äº†ä¸°å¯Œçš„æˆå‘˜å‡½æ•°ï¼Œå¦‚ <code>size()</code> è·å–å…ƒç´ æ•°é‡ã€<code>empty()</code> åˆ¤æ–­æ˜¯å¦ä¸ºç©ºã€<code>clear()</code> æ¸…ç©ºå…ƒç´ ç­‰ï¼Œä½¿ç”¨èµ·æ¥æ›´åŠ æ–¹ä¾¿ã€‚</li>
</ul>
</li>
<li>
<p><strong>ä½¿ç”¨ vector è€Œä¸ç”¨æ•°ç»„çš„åŸå› </strong></p>
<p>åœ¨å¤§æ•´æ•°ç›¸åŠ çš„åœºæ™¯ä¸­ï¼Œè¾“å…¥çš„æ•°å­—é•¿åº¦æ˜¯ä¸ç¡®å®šçš„ã€‚å¦‚æœä½¿ç”¨æ™®é€šæ•°ç»„ï¼Œéœ€è¦é¢„å…ˆå®šä¹‰ä¸€ä¸ªè¶³å¤Ÿå¤§çš„æ•°ç»„æ¥å­˜å‚¨æ•°å­—çš„æ¯ä¸€ä½ï¼Œä½†è¿™æ ·å¯èƒ½ä¼šæµªè´¹å¤§é‡çš„å†…å­˜ç©ºé—´ã€‚è€Œ <code>vector</code> å¯ä»¥æ ¹æ®è¾“å…¥æ•°å­—çš„å®é™…é•¿åº¦åŠ¨æ€è°ƒæ•´å¤§å°ï¼Œé¿å…äº†å†…å­˜çš„æµªè´¹ï¼Œå¹¶ä¸”å…¶æä¾›çš„ <code>push_back()</code> æ–¹æ³•å¯ä»¥æ–¹ä¾¿åœ°å°†æ•°å­—çš„æ¯ä¸€ä½æ·»åŠ åˆ°å®¹å™¨ä¸­ï¼ŒåŒæ—¶åœ¨å¤„ç†è¿›ä½æ—¶ä¹Ÿæ›´åŠ æ–¹ä¾¿ã€‚å› æ­¤ï¼Œä½¿ç”¨ <code>vector</code> èƒ½æ›´å¥½åœ°é€‚åº”è¿™ç§åŠ¨æ€é•¿åº¦çš„éœ€æ±‚ã€‚</p>
</li>
</ul>
<h5 id="addå‡½æ•°è¿è¡Œç¤ºä¾‹">addå‡½æ•°è¿è¡Œç¤ºä¾‹</h5>
<p>å‡è®¾æˆ‘ä»¬è¦è®¡ç®—ä¸¤ä¸ªå››ä½æ•° <code>a = 1234</code> å’Œ <code>b = 5678</code> çš„å’Œã€‚</p>
<p>åœ¨ä»£ç ä¸­ï¼Œè¾“å…¥çš„æ•°å­—ä»¥å­—ç¬¦ä¸²å½¢å¼å­˜å‚¨ï¼Œç„¶åå°†å…¶é€†åºå­˜å‚¨åˆ° <code>vector&lt;int&gt;</code> ä¸­ï¼Œè¿™æ ·åšæ˜¯ä¸ºäº†æ–¹ä¾¿å¤„ç†è¿›ä½ã€‚å¯¹äº <code>a = 1234</code>ï¼Œå­˜å‚¨åœ¨ <code>vector&lt;int&gt;</code> ä¸­ä¸º <code>A = &#123;4, 3, 2, 1&#125;</code>ï¼›å¯¹äº <code>b = 5678</code>ï¼Œå­˜å‚¨åœ¨ <code>vector&lt;int&gt;</code> ä¸­ä¸º <code>B = &#123;8, 7, 6, 5&#125;</code>ã€‚</p>
<p>å…·ä½“æ­¥éª¤ï¼š</p>
<ul>
<li>
<p>[x] åˆå§‹åŒ–</p>
</li>
<li>
<p><code>vector&lt;int&gt; C;</code>ï¼šç”¨äºå­˜å‚¨ç›¸åŠ ç»“æœçš„å‘é‡ï¼Œåˆå§‹ä¸ºç©ºã€‚</p>
</li>
<li>
<p><code>int t = 0;</code>ï¼šç”¨äºå­˜å‚¨æ¯ä¸€ä½ç›¸åŠ åçš„ç»“æœä»¥åŠè¿›ä½ä¿¡æ¯ï¼Œåˆå§‹å€¼ä¸º 0ã€‚</p>
</li>
<li>
<p>[x] å¾ªç¯å¤„ç†æ¯ä¸€ä½</p>
</li>
</ul>
<p>å¾ªç¯æ¡ä»¶ä¸º <code>i &lt; A.size() || i &lt; B.size()</code>ï¼Œè¿™æ„å‘³ç€åªè¦ <code>A</code> æˆ– <code>B</code> è¿˜æœ‰æœªå¤„ç†çš„ä½ï¼Œå°±ä¼šç»§ç»­å¾ªç¯ã€‚</p>
<ul>
<li>
<p>[ ] ç¬¬ä¸€æ¬¡å¾ªç¯ï¼ˆ<code>i = 0</code>ï¼‰</p>
</li>
<li>
<p><code>if(i &lt; A.size()) t += A[i];</code>ï¼šå› ä¸º <code>i = 0</code> å°äº <code>A.size()</code>ï¼ˆ4ï¼‰ï¼Œæ‰€ä»¥ <code>t = t + A[0] = 0 + 4 = 4</code>ã€‚</p>
</li>
<li>
<p><code>if(i &lt; B.size()) t += B[i];</code>ï¼šå› ä¸º <code>i = 0</code> å°äº <code>B.size()</code>ï¼ˆ4ï¼‰ï¼Œæ‰€ä»¥ <code>t = t + B[0] = 4 + 8 = 12</code>ã€‚</p>
</li>
<li>
<p><code>C.push_back(t % 10);</code>ï¼šå°† <code>t % 10</code>ï¼ˆå³ 2ï¼‰æ·»åŠ åˆ° <code>C</code> ä¸­ï¼Œæ­¤æ—¶ <code>C = &#123;2&#125;</code>ã€‚</p>
</li>
<li>
<p><code>t /= 10;</code>ï¼š<code>t</code> é™¤ä»¥ 10ï¼Œå¾—åˆ°è¿›ä½ 1ï¼Œå³ <code>t = 1</code>ã€‚</p>
</li>
<li>
<p>[ ] ç¬¬äºŒæ¬¡å¾ªç¯ï¼ˆ<code>i = 1</code>ï¼‰</p>
</li>
<li>
<p><code>if(i &lt; A.size()) t += A[i];</code>ï¼š<code>t = t + A[1] = 1 + 3 = 4</code>ã€‚</p>
</li>
<li>
<p><code>if(i &lt; B.size()) t += B[i];</code>ï¼š<code>t = t + B[1] = 4 + 7 = 11</code>ã€‚</p>
</li>
<li>
<p><code>C.push_back(t % 10);</code>ï¼šå°† <code>t % 10</code>ï¼ˆå³ 1ï¼‰æ·»åŠ åˆ° <code>C</code> ä¸­ï¼Œæ­¤æ—¶ <code>C = &#123;2, 1&#125;</code>ã€‚</p>
</li>
<li>
<p><code>t /= 10;</code>ï¼š<code>t</code> é™¤ä»¥ 10ï¼Œå¾—åˆ°è¿›ä½ 1ï¼Œå³ <code>t = 1</code>ã€‚</p>
</li>
<li>
<p>[ ] ç¬¬ä¸‰æ¬¡å¾ªç¯ï¼ˆ<code>i = 2</code>ï¼‰</p>
</li>
<li>
<p><code>if(i &lt; A.size()) t += A[i];</code>ï¼š<code>t = t + A[2] = 1 + 2 = 3</code>ã€‚</p>
</li>
<li>
<p><code>if(i &lt; B.size()) t += B[i];</code>ï¼š<code>t = t + B[2] = 3 + 6 = 9</code>ã€‚</p>
</li>
<li>
<p><code>C.push_back(t % 10);</code>ï¼šå°† <code>t % 10</code>ï¼ˆå³ 9ï¼‰æ·»åŠ åˆ° <code>C</code> ä¸­ï¼Œæ­¤æ—¶ <code>C = &#123;2, 1, 9&#125;</code>ã€‚</p>
</li>
<li>
<p><code>t /= 10;</code>ï¼š<code>t</code> é™¤ä»¥ 10ï¼Œå¾—åˆ°è¿›ä½ 0ï¼Œå³ <code>t = 0</code>ã€‚</p>
</li>
<li>
<p>[ ] ç¬¬å››æ¬¡å¾ªç¯ï¼ˆ<code>i = 3</code>ï¼‰</p>
</li>
<li>
<p><code>if(i &lt; A.size()) t += A[i];</code>ï¼š<code>t = t + A[3] = 0 + 1 = 1</code>ã€‚</p>
</li>
<li>
<p><code>if(i &lt; B.size()) t += B[i];</code>ï¼š<code>t = t + B[3] = 1 + 5 = 6</code>ã€‚</p>
</li>
<li>
<p><code>C.push_back(t % 10);</code>ï¼šå°† <code>t % 10</code>ï¼ˆå³ 6ï¼‰æ·»åŠ åˆ° <code>C</code> ä¸­ï¼Œæ­¤æ—¶ <code>C = &#123;2, 1, 9, 6&#125;</code>ã€‚</p>
</li>
<li>
<p><code>t /= 10;</code>ï¼š<code>t</code> é™¤ä»¥ 10ï¼Œå¾—åˆ°è¿›ä½ 0ï¼Œå³ <code>t = 0</code>ã€‚</p>
</li>
<li>
<p>[x] å¤„ç†æœ€åå¯èƒ½çš„è¿›ä½</p>
</li>
</ul>
<p><code>if(t) C.push_back(1);</code></p>
<p>å› ä¸ºæ­¤æ—¶ <code>t = 0</code>ï¼Œæ‰€ä»¥ä¸éœ€è¦æ·»åŠ é¢å¤–çš„è¿›ä½ï¼Œ<code>C</code> ä»ç„¶ä¸º <code>&#123;2, 1, 9, 6&#125;</code>ã€‚</p>
<ul>
<li>[x] è¿”å›ç»“æœ</li>
</ul>
<p><code>return C;</code>ï¼šè¿”å›å­˜å‚¨ç›¸åŠ ç»“æœçš„å‘é‡ <code>C</code>ã€‚</p>
<p>åœ¨ <code>main</code> å‡½æ•°ä¸­ï¼Œå°† <code>C</code> é€†åºè¾“å‡ºï¼Œå¾—åˆ°æœ€ç»ˆç»“æœ <code>6912</code>ï¼Œå³ <code>1234 + 5678 = 6912</code>ã€‚</p>
<h5 id="autoçš„ç”¨æ³•">autoçš„ç”¨æ³•</h5>
<p><code>auto</code>æ˜¯C++11çš„æ–°ç‰¹æ€§ï¼Œå¯ä»¥è‡ªåŠ¨è¯†åˆ«å˜é‡å±æ€§ã€‚æ¯”å¦‚<code>auto C=add(A,B);</code>å°±è‡ªåŠ¨è¯†åˆ«äº†addè¿”å›çš„ç±»å‹ï¼Œå› æ­¤<code>auto C &lt;=&gt; vector&lt;int&gt;c</code></p>
<h5 id="a-i-0-çš„ä½œç”¨ï¼šå°†å­—ç¬¦ä¸²æ¯ä¸€ä½ç”±ASCIIç è½¬ä¸ºæ•´æ•°"><code>a[i] - '0'</code> çš„ä½œç”¨ï¼šå°†å­—ç¬¦ä¸²æ¯ä¸€ä½ç”±ASCIIç è½¬ä¸ºæ•´æ•°</h5>
<p>åœ¨ C++ ä¸­ï¼Œå½“ä½ ä»è¾“å…¥è¯»å–ä¸€ä¸ªæ•°å­—å­—ç¬¦ä¸²æ—¶ï¼Œæ¯”å¦‚ <code>&quot;123&quot;</code>ï¼Œå­—ç¬¦ä¸²ä¸­çš„æ¯ä¸ªå­—ç¬¦ï¼ˆå¦‚ <code>'1'</code>ã€<code>'2'</code>ã€<code>'3'</code>ï¼‰å®é™…ä¸Šå­˜å‚¨çš„æ˜¯å­—ç¬¦çš„ ASCII ç å€¼ï¼Œè€Œä¸æ˜¯å¯¹åº”çš„æ•°å€¼ã€‚å­—ç¬¦ <code>'0'</code> åˆ° <code>'9'</code> çš„ ASCII ç æ˜¯è¿ç»­çš„ï¼Œ<code>'0'</code> çš„ ASCII ç å€¼æ˜¯ 48ï¼Œ<code>'1'</code> æ˜¯ 49ï¼Œä»¥æ­¤ç±»æ¨ï¼Œ<code>'9'</code> æ˜¯ 57ã€‚</p>
<p><code>b[i] - '0'</code> çš„ä½œç”¨å°±æ˜¯å°†å­—ç¬¦å½¢å¼çš„æ•°å­—è½¬æ¢ä¸ºå¯¹åº”çš„æ•´æ•°å€¼ã€‚ä¾‹å¦‚ï¼Œå½“ <code>b[i]</code> ä¸º <code>'1'</code> æ—¶ï¼Œ<code>'1'</code> çš„ ASCII ç å€¼æ˜¯ 49ï¼Œ<code>'0'</code> çš„ ASCII ç å€¼æ˜¯ 48ï¼Œé‚£ä¹ˆ <code>'1' - '0'</code> å°±ç­‰äº <code>49 - 48 = 1</code>ï¼Œè¿™æ ·å°±æŠŠå­—ç¬¦ <code>'1'</code> è½¬æ¢ä¸ºäº†æ•´æ•° 1ã€‚</p>
<p>å¦‚æœæ²¡æœ‰ <code>b[i] - '0'</code> è¿™ä¸ªæ“ä½œï¼Œç›´æ¥å°†å­—ç¬¦å­˜å‚¨åˆ° <code>vector&lt;int&gt;</code> ä¸­ï¼Œé‚£ä¹ˆå­˜å‚¨çš„æ˜¯å­—ç¬¦çš„ ASCII ç å€¼ï¼Œè€Œä¸æ˜¯å¯¹åº”çš„æ•°å€¼ï¼Œè¿™ä¼šå¯¼è‡´åç»­çš„è®¡ç®—å‡ºç°é”™è¯¯ã€‚</p>
<h4 id="é«˜ç²¾åº¦å‡æ³•">é«˜ç²¾åº¦å‡æ³•</h4>
<h4 id="é«˜ç²¾åº¦ä¹˜æ³•">é«˜ç²¾åº¦ä¹˜æ³•</h4>
<h4 id="é«˜ç²¾åº¦é™¤æ³•">é«˜ç²¾åº¦é™¤æ³•</h4>
]]></content>
      <categories>
        <category>ç®—æ³•é¢˜</category>
      </categories>
      <tags>
        <tag>ACWing</tag>
      </tags>
  </entry>
  <entry>
    <title>å¦‚ä½•ç”¨hexoæ–°å»ºæ–‡ä»¶å¹¶ä¸Šä¼ /å¦‚ä½•ç”¨hexoæ’å…¥å›¾ç‰‡ï¼ˆnextä¸»é¢˜ï¼‰</title>
    <url>/hexo_maintanance/</url>
    <content><![CDATA[<p>hexoï¼ˆåšä¸»é‡‡ç”¨nextä¸»é¢˜ï¼‰æ—¥å¸¸ç»´æŠ¤æ•™ç¨‹</p>
<h1>ä¿®æ”¹scaffolds/post.mdï¼ˆé»˜è®¤æ ‡é¢˜æ–‡ä»¶ï¼‰</h1>
<p>æ³¨æ„ä¿®æ”¹æ—¶ä¸è¦æŠŠä¸­æ–‡åŠ è¿›å»ï¼Œåœ¨æ­¤åªèµ·åˆ°æ³¨é‡Šä½œç”¨</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">title: &#123;&#123; title &#125;&#125;</span><br><span class="line">date: &#123;&#123; date &#125;&#125;</span><br><span class="line">tags:([1,2]è®¾ç½®åŒæ—¶å±äºä¸åŒç±»åˆ«å¯ä»¥è¿™æ ·)</span><br><span class="line">categories:</span><br><span class="line">top:(è¡¨ç¤ºç½®é¡¶æƒ…å†µï¼Œä¸ç½®é¡¶ä¸å¡«å³å¯æ•°å­—å¤§å°ä»£è¡¨ç½®é¡¶é¡ºåºï¼Œæ•°å­—è¶Šå¤§æ’åºè¶Šå‰)</span><br></pre></td></tr></table></figure>
<h1>æ–°å»ºmdæ–‡ä»¶</h1>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hexo new/hexo n &quot;æ–‡ä»¶å&quot;</span><br></pre></td></tr></table></figure>
<h1>æŸ¥çœ‹æ–°å»ºæ–‡ä»¶</h1>
<p>è¿›å…¥ç›®å½•æ˜¯source/_posts</p>
<h1>å®Œå–„æ ‡é¢˜å¯¹åº”ä¿¡æ¯ï¼Œå¡«å†™md</h1>
<p>ä¹Ÿå°±æ˜¯åˆšæ‰ä¸Šé¢é‚£å †ä¸œè¥¿</p>
<h1>åœ¨blogç›®å½•ä¸‹ï¼ˆå› äººè€Œå¼‚ï¼‰æ‰“å¼€git bash</h1>
<p>è¾“å…¥</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hexo clean</span><br><span class="line">hexo g -d</span><br></pre></td></tr></table></figure>
<p>å³å¯ä¸Šä¼ </p>
<p>è¾“å…¥</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hexo s</span><br></pre></td></tr></table></figure>
<p>å³å¯å®æ—¶æŸ¥çœ‹ç½‘é¡µ</p>
<h1>æ’å…¥å›¾ç‰‡æ“ä½œï¼ˆå›¾ç‰‡å’Œmdæ–‡ä»¶æœ€å¥½å‡ä¸ºè‹±æ–‡åï¼‰</h1>
<h2 id="ä¸‹æ’ä»¶">ä¸‹æ’ä»¶</h2>
<p>è§<a href="https://github.com/yiyungent/hexo-asset-img">yiyungent/hexo-asset-imgï¼šğŸ° Hexo æœ¬åœ°å›¾ç‰‡æ’ä»¶ã€‚|Hexo æœ¬åœ°å›¾ç‰‡æ’ä»¶ï¼šè½¬æ¢å›¾ç‰‡ç›¸å¯¹è·¯å¾„ä¸ºasset_img</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install hexo-asset-img --save</span><br><span class="line">æˆ–è€…</span><br><span class="line">npm install git://github.com/yiyungent/hexo-asset-img.git#main</span><br></pre></td></tr></table></figure>
<h2 id="ä¿®æ”¹host-config-yml">ä¿®æ”¹host/_config.yml</h2>
<p>permalinkæ§åˆ¶äº†æ°¸ä¹…åŸŸåçš„æ ·å¼</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1.post_asset_folder: true</span><br><span class="line">2.permalink: :title/ï¼ˆæˆ‘çš„è‡ªå¸¦äº†æ—¥æœŸå¯¼è‡´å›¾ç‰‡ä¸€ç›´ä¸è¡Œ:year/:month/:date/:title/ï¼‰</span><br></pre></td></tr></table></figure>
<h2 id="ç›´æ¥ç²˜è´´å›¾ç‰‡">ç›´æ¥ç²˜è´´å›¾ç‰‡</h2>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">![1](./hexo_maintanance/1.png)</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢æ˜¯ä¸‹é¢å›¾ç‰‡çš„è·¯å¾„ã€‚èƒ½çœ‹åˆ°ä¸‹é¢çš„å›¾ç‰‡å°±èƒ½è¯´æ˜è¿™ä¸ªæ–¹æ³•å°±æ˜¯æˆåŠŸçš„ã€‚</p>
<p><img src="/hexo_maintanance/1.png" alt="1"></p>
<h1>å®ç°ä¾§è¾¹æ æ ‡é¢˜å…¨å±•å¼€</h1>
<p>æœ‰äº›æ–‡ä»¶ç›®å½•å¾ˆé•¿ï¼Œä¸å…¨å±•å¼€ä¸æ–¹ä¾¿çœ‹ã€‚å¯ä»¥ä¿®æ”¹</p>
<p><code>blog\themes\next\source\css\_common\outline\sidebar\sidebar-toc.styl</code>æ–‡ä»¶</p>
<p>æŸ¥æ‰¾ä¿®æ”¹<code>.nav-child</code>å¯¹åº”ä»£ç ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">.<span class="property">nav</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (not hexo-<span class="title function_">config</span>(<span class="string">&#x27;toc.expand_all&#x27;</span>)) &#123;</span><br><span class="line">    .<span class="property">nav</span>-child &#123;</span><br><span class="line">      --<span class="attr">height</span>: auto;          <span class="comment">/* å–æ¶ˆé«˜åº¦é™åˆ¶ */</span></span><br><span class="line">      <span class="attr">height</span>: auto;            <span class="comment">/* å¯ç”¨è‡ªåŠ¨é«˜åº¦é€‚åº”å†…å®¹ */</span></span><br><span class="line">      <span class="attr">opacity</span>: <span class="number">1</span>;              <span class="comment">/* å–æ¶ˆé€æ˜åº¦éšè— */</span></span><br><span class="line">      <span class="attr">overflow</span>: visible;       <span class="comment">/* å…è®¸å†…å®¹æº¢å‡ºæ˜¾ç¤º */</span></span><br><span class="line">      transition-<span class="attr">property</span>: opacity;  <span class="comment">/* ä»…ä¿ç•™é€æ˜åº¦è¿‡æ¸¡ */</span></span><br><span class="line">      <span class="attr">visibility</span>: visible;     <span class="comment">/* ç¡®ä¿å…ƒç´ å¯è§ */</span></span><br><span class="line">      <span class="attr">transition</span>: $transition-ease;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>åŸé…ç½®ä¸ºï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">åŸé…ç½®--<span class="attr">height</span>: <span class="number">0</span>;</span><br><span class="line"><span class="attr">height</span>: <span class="number">0</span>;</span><br><span class="line"><span class="attr">opacity</span>: <span class="number">0</span>;</span><br><span class="line"><span class="attr">overflow</span>: hidden;</span><br><span class="line">transition-<span class="attr">property</span>: height, opacity, visibility;</span><br><span class="line"><span class="attr">transition</span>: $transition-ease;</span><br><span class="line"><span class="attr">visibility</span>: hidden;</span><br></pre></td></tr></table></figure>
<h1>å®ç°æ–‡å­—é«˜äº®</h1>
<p>ç½‘ä¸Šå¸–å­éƒ½æ˜¯äº¤æ€ä¹ˆå®ç°ä»£ç å—é«˜äº®ï¼Œä½†æ˜¯è¿ç§»åˆ°ç½‘é¡µä¹‹åtyporaæœ¬æ¥èƒ½å®ç°çš„æ–‡å­—é«˜äº®æ•ˆæœå°±æ— äº†ã€‚ä¿®æ”¹æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<p><mark>å…ˆæ¢ä¸ªmarkdownç¼–è¯‘å™¨</mark></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm uninstall hexo-renderer-marked --save  # å¸è½½é»˜è®¤è§£æå™¨</span><br><span class="line">npm install hexo-renderer-markdown-it --save</span><br></pre></td></tr></table></figure>
<p>ç„¶ååœ¨æ ¹ç›®å½•ä¸‹<mark>source/_data/__styles.styl</mark>ä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹</p>
<p>ï¼ˆæˆ‘çš„é¢œè‰²å’Œtyporaå·²ç»ä¿æŒä¸€è‡´ï¼Œç”¨çš„æ˜¯simplehappyä¸»é¢˜ï¼‰</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ==é«˜äº®å†…å®¹æ ·å¼==</span></span><br><span class="line">mark &#123;</span><br><span class="line">  background-<span class="attr">color</span>: #<span class="title class_">FBE598</span>;  <span class="comment">// é»„è‰²èƒŒæ™¯</span></span><br><span class="line">  <span class="attr">color</span>: inherit;             <span class="comment">// æ–‡å­—é¢œè‰²ç»§æ‰¿</span></span><br><span class="line">  <span class="attr">padding</span>: <span class="number">0.</span>1em <span class="number">0.</span>3em;</span><br><span class="line">  border-<span class="attr">radius</span>: 3px;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ€ååœ¨<mark>æ ¹ç›®å½•ä¸‹çš„_config.yml</mark>ä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="attr">markdown</span>:</span><br><span class="line">  <span class="attr">preset</span>: <span class="string">&quot;commonmark&quot;</span></span><br><span class="line">  <span class="attr">plugins</span>:</span><br><span class="line">    - markdown-it-mark  # å¯ç”¨é«˜äº®è¯­æ³•æ”¯æŒï¼ˆ==å†…å®¹==ï¼‰</span><br></pre></td></tr></table></figure>
<p>æˆåŠŸä¹‹åå°±åº”è¯¥èƒ½çœ‹åˆ°ä¸Šè¿°æ­¥éª¤ä¸€æ ·çš„é«˜äº®äº†~</p>
]]></content>
      <categories>
        <category>åšå®¢ç»´æŠ¤</category>
      </categories>
      <tags>
        <tag>åšå®¢ç»´æŠ¤</tag>
      </tags>
  </entry>
  <entry>
    <title>æ‰‹æ’•OCC-NeRF:Occlusion-Free Scene Recovery via Neural Radiance Fields</title>
    <url>/%E6%89%8B%E6%92%95nerfmm/</url>
    <content><![CDATA[<p>é“¾æ¥ï¼š<a href="https://freebutuselesssoul.github.io/occnerf/">OCC-NeRF: Occlusion-Free Scene Recovery via Neural Radiance Fields</a></p>
<h2 id="æ–‡ä»¶å¤¹ç›®å½•">æ–‡ä»¶å¤¹ç›®å½•</h2>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">occ-nerf/</span><br><span class="line">â”œâ”€â”€ .gitignore</span><br><span class="line">â”œâ”€â”€ LICENSE</span><br><span class="line">â”œâ”€â”€ README.md</span><br><span class="line">â”œâ”€â”€ environment.yml</span><br><span class="line">â”œâ”€â”€ local1.txt</span><br><span class="line">â”œâ”€â”€ dataloader/</span><br><span class="line">â”‚   â”œâ”€â”€ any_folder.py</span><br><span class="line">â”‚   â”œâ”€â”€ local_save.py</span><br><span class="line">â”‚   â”œâ”€â”€ with_colmap.py</span><br><span class="line">â”‚   â”œâ”€â”€ with_feature.py</span><br><span class="line">â”‚   â”œâ”€â”€ with_feature_colmap.py</span><br><span class="line">â”‚   â””â”€â”€ with_mask.py</span><br><span class="line">â”œâ”€â”€ models/</span><br><span class="line">â”‚   â”œâ”€â”€ depth_decoder.py</span><br><span class="line">â”‚   â”œâ”€â”€ intrinsics.py</span><br><span class="line">â”‚   â”œâ”€â”€ layers.py</span><br><span class="line">â”‚   â”œâ”€â”€ nerf_feature.py</span><br><span class="line">â”‚   â”œâ”€â”€ nerf_mask.py</span><br><span class="line">â”‚   â”œâ”€â”€ nerf_models.py</span><br><span class="line">â”‚   â””â”€â”€ poses.py</span><br><span class="line">â”œâ”€â”€ utils/</span><br><span class="line">â”‚   â”œâ”€â”€ align_traj.py</span><br><span class="line">â”‚   â”œâ”€â”€ comp_ate.py</span><br><span class="line">â”‚   â”œâ”€â”€ comp_ray_dir.py</span><br><span class="line">â”‚   â”œâ”€â”€ lie_group_helper.py</span><br><span class="line">â”‚   â”œâ”€â”€ pos_enc.py</span><br><span class="line">â”‚   â”œâ”€â”€ pose_utils.py</span><br><span class="line">â”‚   â”œâ”€â”€ split_dataset.py</span><br><span class="line">â”‚   â”œâ”€â”€ training_utils.py</span><br><span class="line">â”‚   â”œâ”€â”€ vgg.py</span><br><span class="line">â”‚   â”œâ”€â”€ vis_cam_traj.py</span><br><span class="line">â”‚   â””â”€â”€ volume_op.py</span><br><span class="line">â”œâ”€â”€ tasks/</span><br><span class="line">â”‚   â””â”€â”€ ...</span><br><span class="line">â””â”€â”€ third_party/</span><br><span class="line">    â”œâ”€â”€ ATE/</span><br><span class="line">    â”‚   â””â”€â”€ README.md</span><br><span class="line">    â””â”€â”€ pytorch_ssim/</span><br></pre></td></tr></table></figure>
<h2 id="DEBUG-ä»£ç ">DEBUG ä»£ç </h2>
<h3 id="dataloader">dataloader</h3>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">â”œâ”€â”€ dataloader/</span><br><span class="line">â”‚   â”œâ”€â”€ any_folder.py</span><br><span class="line">â”‚   â”œâ”€â”€ local_save.py</span><br><span class="line">â”‚   â”œâ”€â”€ with_colmap.py</span><br><span class="line">â”‚   â”œâ”€â”€ with_feature.py</span><br><span class="line">â”‚   â”œâ”€â”€ with_feature_colmap.py</span><br><span class="line">â”‚   â””â”€â”€ with_mask.py</span><br></pre></td></tr></table></figure>
<h4 id="any-folder-py">any_folder.py</h4>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os                                       <span class="comment"># æ“ä½œç³»ç»Ÿæ¥å£æ¨¡å—</span></span><br><span class="line"><span class="keyword">import</span> torch                                    <span class="comment"># PyTorch æ·±åº¦å­¦ä¹ æ¡†æ¶</span></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np                              <span class="comment"># ç§‘å­¦è®¡ç®—åº“</span></span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm                           <span class="comment"># è¿›åº¦æ¡æ˜¾ç¤ºæ¨¡å—</span></span><br><span class="line"><span class="keyword">import</span> imageio                                  <span class="comment"># å›¾åƒ IO å¤„ç†åº“</span></span><br><span class="line"><span class="keyword">from</span> dataloader.with_colmap <span class="keyword">import</span> resize_imgs  <span class="comment"># è‡ªå®šä¹‰å›¾åƒç¼©æ”¾å‡½æ•°</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_imgs</span>(<span class="params">image_dir, num_img_to_load, start, end, skip, load_sorted, load_img</span>):</span><br><span class="line">    img_names = np.array(<span class="built_in">sorted</span>(os.listdir(image_dir)))  <span class="comment"># è·å–å¹¶æ’åºç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶å</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> end == -<span class="number">1</span>:                                 <span class="comment"># ä» start å¼€å§‹æŒ‰é—´éš” skip å–å›¾</span></span><br><span class="line">        img_names = img_names[start::skip]</span><br><span class="line">    <span class="keyword">else</span>:                                         <span class="comment"># å– start åˆ° end åŒºé—´æŒ‰é—´éš” skip å–å›¾</span></span><br><span class="line">        img_names = img_names[start:end:skip]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> load_sorted:                           <span class="comment"># æ˜¯å¦æ‰“ä¹±å›¾åƒé¡ºåº</span></span><br><span class="line">        np.random.shuffle(img_names)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> num_img_to_load &gt; <span class="built_in">len</span>(img_names):          <span class="comment"># æ£€æŸ¥è¯·æ±‚æ•°é‡æ˜¯å¦è¶…å‡ºèŒƒå›´</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;å›¾åƒè¯·æ±‚æ•°<span class="subst">&#123;num_img_to_load&#125;</span>è¶…è¿‡å¯ç”¨æ•°<span class="subst">&#123;<span class="built_in">len</span>(img_names)&#125;</span>&#x27;</span>)</span><br><span class="line">        exit()</span><br><span class="line">    <span class="keyword">elif</span> num_img_to_load == -<span class="number">1</span>:                   <span class="comment"># åŠ è½½å…¨éƒ¨å¯ç”¨å›¾åƒ</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;åŠ è½½å…¨éƒ¨<span class="subst">&#123;<span class="built_in">len</span>(img_names)&#125;</span>å¼ å›¾åƒ&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:                                         <span class="comment"># æˆªå–æŒ‡å®šæ•°é‡çš„å›¾åƒ</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;ä»<span class="subst">&#123;<span class="built_in">len</span>(img_names)&#125;</span>å¼ ä¸­åŠ è½½<span class="subst">&#123;num_img_to_load&#125;</span>å¼ &#x27;</span>)</span><br><span class="line">        img_names = img_names[:num_img_to_load]</span><br><span class="line">    </span><br><span class="line">    img_paths = [os.path.join(image_dir, n) <span class="keyword">for</span> n <span class="keyword">in</span> img_names]  <span class="comment"># æ„å»ºå®Œæ•´æ–‡ä»¶è·¯å¾„</span></span><br><span class="line">    N_imgs = <span class="built_in">len</span>(img_paths)                         <span class="comment"># è®¡ç®—å®é™…åŠ è½½æ•°é‡</span></span><br><span class="line">    </span><br><span class="line">    img_list = []</span><br><span class="line">    <span class="keyword">if</span> load_img:                                     <span class="comment"># å®é™…åŠ è½½å›¾åƒæ•°æ®</span></span><br><span class="line">        <span class="keyword">for</span> p <span class="keyword">in</span> tqdm(img_paths):</span><br><span class="line">            img = imageio.imread(p)[:, :, :<span class="number">3</span>]        <span class="comment"># è¯»å– RGB ä¸‰é€šé“å›¾åƒ</span></span><br><span class="line">            img_list.append(img)</span><br><span class="line">        img_list = np.stack(img_list)                <span class="comment"># å †å ä¸º 4D æ•°ç»„</span></span><br><span class="line">        img_list = torch.from_numpy(img_list).<span class="built_in">float</span>() / <span class="number">255</span>  <span class="comment"># è½¬æ¢ä¸ºæµ®ç‚¹å¼ é‡å¹¶å½’ä¸€åŒ–</span></span><br><span class="line">        H, W = img_list.shape[<span class="number">1</span>], img_list.shape[<span class="number">2</span>]  <span class="comment"># è·å–å›¾åƒå°ºå¯¸</span></span><br><span class="line">    <span class="keyword">else</span>:                                            <span class="comment"># ä»…è·å–å›¾åƒå°ºå¯¸</span></span><br><span class="line">        tmp_img = imageio.imread(img_paths[<span class="number">0</span>])</span><br><span class="line">        H, W = tmp_img.shape[<span class="number">0</span>], tmp_img.shape[<span class="number">1</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &#123;                                         <span class="comment"># è¿”å›ç»“æ„åŒ–æ•°æ®</span></span><br><span class="line">        <span class="string">&#x27;imgs&#x27;</span>: img_list,        <span class="comment"># å›¾åƒå¼ é‡ (N, H, W, 3)</span></span><br><span class="line">        <span class="string">&#x27;img_names&#x27;</span>: img_names,  <span class="comment"># å›¾åƒæ–‡ä»¶åæ•°ç»„</span></span><br><span class="line">        <span class="string">&#x27;N_imgs&#x27;</span>: N_imgs,        <span class="comment"># æ€»å›¾åƒæ•°</span></span><br><span class="line">        <span class="string">&#x27;H&#x27;</span>: H,                  <span class="comment"># å›¾åƒé«˜åº¦</span></span><br><span class="line">        <span class="string">&#x27;W&#x27;</span>: W,                  <span class="comment"># å›¾åƒå®½åº¦</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DataLoaderAnyFolder</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, base_dir, scene_name, res_ratio, num_img_to_load, </span></span><br><span class="line"><span class="params">                 start, end, skip, load_sorted, load_img=<span class="literal">True</span></span>):  <span class="comment"># åˆå§‹åŒ–å‚æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.base_dir = base_dir                  <span class="comment"># æ•°æ®æ ¹ç›®å½•</span></span><br><span class="line">        <span class="variable language_">self</span>.scene_name = scene_name              <span class="comment"># åœºæ™¯åç§°</span></span><br><span class="line">        <span class="variable language_">self</span>.res_ratio = res_ratio                <span class="comment"># åˆ†è¾¨ç‡ç¼©æ”¾æ¯”ä¾‹</span></span><br><span class="line">        <span class="variable language_">self</span>.num_img_to_load = num_img_to_load    <span class="comment"># æœ€å¤§åŠ è½½æ•°é‡</span></span><br><span class="line">        <span class="variable language_">self</span>.start = start                        <span class="comment"># èµ·å§‹ç´¢å¼•</span></span><br><span class="line">        <span class="variable language_">self</span>.end = end                            <span class="comment"># ç»“æŸç´¢å¼•</span></span><br><span class="line">        <span class="variable language_">self</span>.skip = skip                          <span class="comment"># é‡‡æ ·é—´éš”</span></span><br><span class="line">        <span class="variable language_">self</span>.load_sorted = load_sorted            <span class="comment"># æ˜¯å¦ä¿æŒé¡ºåº</span></span><br><span class="line">        <span class="variable language_">self</span>.load_img = load_img                  <span class="comment"># æ˜¯å¦å®é™…åŠ è½½å›¾åƒ</span></span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.imgs_dir = os.path.join(<span class="variable language_">self</span>.base_dir, <span class="variable language_">self</span>.scene_name)  <span class="comment"># æ„å»ºå›¾åƒç›®å½•è·¯å¾„</span></span><br><span class="line">        </span><br><span class="line">        image_data = load_imgs(<span class="variable language_">self</span>.imgs_dir, <span class="variable language_">self</span>.num_img_to_load,  <span class="comment"># åŠ è½½å›¾åƒæ•°æ®</span></span><br><span class="line">                              <span class="variable language_">self</span>.start, <span class="variable language_">self</span>.end, <span class="variable language_">self</span>.skip,</span><br><span class="line">                              <span class="variable language_">self</span>.load_sorted, <span class="variable language_">self</span>.load_img)</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.imgs = image_data[<span class="string">&#x27;imgs&#x27;</span>]             <span class="comment"># å›¾åƒå¼ é‡</span></span><br><span class="line">        <span class="variable language_">self</span>.img_names = image_data[<span class="string">&#x27;img_names&#x27;</span>]   <span class="comment"># æ–‡ä»¶ååˆ—è¡¨</span></span><br><span class="line">        <span class="variable language_">self</span>.N_imgs = image_data[<span class="string">&#x27;N_imgs&#x27;</span>]         <span class="comment"># å›¾åƒæ€»æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.ori_H = image_data[<span class="string">&#x27;H&#x27;</span>]               <span class="comment"># åŸå§‹é«˜åº¦</span></span><br><span class="line">        <span class="variable language_">self</span>.ori_W = image_data[<span class="string">&#x27;W&#x27;</span>]               <span class="comment"># åŸå§‹å®½åº¦</span></span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.near = <span class="number">0.0</span>                            <span class="comment"># è¿‘è£å‰ªé¢(NDC åæ ‡ç³»)</span></span><br><span class="line">        <span class="variable language_">self</span>.far = <span class="number">1.0</span>                             <span class="comment"># è¿œè£å‰ªé¢(NDC åæ ‡ç³»)</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.res_ratio &gt; <span class="number">1</span>:                     <span class="comment"># è®¡ç®—å®é™…ä½¿ç”¨åˆ†è¾¨ç‡</span></span><br><span class="line">            <span class="variable language_">self</span>.H = <span class="variable language_">self</span>.ori_H // <span class="variable language_">self</span>.res_ratio</span><br><span class="line">            <span class="variable language_">self</span>.W = <span class="variable language_">self</span>.ori_W // <span class="variable language_">self</span>.res_ratio</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="variable language_">self</span>.H = <span class="variable language_">self</span>.ori_H</span><br><span class="line">            <span class="variable language_">self</span>.W = <span class="variable language_">self</span>.ori_W</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.load_img:                          <span class="comment"># æ‰§è¡Œå›¾åƒç¼©æ”¾</span></span><br><span class="line">            <span class="variable language_">self</span>.imgs = resize_imgs(<span class="variable language_">self</span>.imgs, <span class="variable language_">self</span>.H, <span class="variable language_">self</span>.W)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    base_dir = <span class="string">&#x27;/your/data/path&#x27;</span>                   <span class="comment"># æ•°æ®æ ¹ç›®å½•é…ç½®ç¤ºä¾‹</span></span><br><span class="line">    scene_name = <span class="string">&#x27;LLFF/fern/images&#x27;</span>                <span class="comment"># åœºæ™¯è·¯å¾„é…ç½®ç¤ºä¾‹</span></span><br><span class="line">    resize_ratio = <span class="number">8</span>                               <span class="comment"># ç¼©æ”¾æ¯”ä¾‹é…ç½®</span></span><br><span class="line">    num_img_to_load = -<span class="number">1</span>                           <span class="comment"># åŠ è½½å…¨éƒ¨å›¾åƒ</span></span><br><span class="line">    start, end, skip = <span class="number">0</span>, -<span class="number">1</span>, <span class="number">1</span>                    <span class="comment"># é‡‡æ ·å‚æ•°åˆå§‹åŒ–</span></span><br><span class="line">    load_sorted, load_img = <span class="literal">True</span>, <span class="literal">True</span>             <span class="comment"># åŠ è½½é…ç½®å‚æ•°</span></span><br><span class="line">    </span><br><span class="line">    scene = DataLoaderAnyFolder(                   <span class="comment"># åˆ›å»ºæ•°æ®åŠ è½½å®ä¾‹</span></span><br><span class="line">        base_dir=base_dir,</span><br><span class="line">        scene_name=scene_name,</span><br><span class="line">        res_ratio=resize_ratio,</span><br><span class="line">        num_img_to_load=num_img_to_load,</span><br><span class="line">        start=start,</span><br><span class="line">        end=end,</span><br><span class="line">        skip=skip,</span><br><span class="line">        load_sorted=load_sorted,</span><br><span class="line">        load_img=load_img)</span><br></pre></td></tr></table></figure>
<h4 id="local-save-py">local_save.py</h4>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="keyword">import</span> imageio</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> dataloader.with_colmap <span class="keyword">import</span> resize_imgs</span><br><span class="line"><span class="keyword">from</span> torchvision <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> torch.nn <span class="keyword">import</span> functional <span class="keyword">as</span> F</span><br><span class="line"></span><br><span class="line"><span class="meta">@torch.no_grad()</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Vgg19</span>(torch.nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, requires_grad=<span class="literal">False</span></span>):</span><br><span class="line">        <span class="comment"># è°ƒç”¨çˆ¶ç±»çš„æ„é€ å‡½æ•°</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        <span class="comment"># åŠ è½½é¢„è®­ç»ƒçš„ VGG19 æ¨¡å‹çš„ç‰¹å¾æå–éƒ¨åˆ†</span></span><br><span class="line">        <span class="variable language_">self</span>.vgg_pretrained_features = models.vgg19(pretrained=<span class="literal">True</span>).features</span><br><span class="line">        <span class="comment"># å¦‚æœä¸éœ€è¦è®¡ç®—æ¢¯åº¦ï¼Œåˆ™å°†æ¨¡å‹å‚æ•°çš„ requires_grad å±æ€§è®¾ç½®ä¸º False</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> requires_grad:</span><br><span class="line">            <span class="keyword">for</span> param <span class="keyword">in</span> <span class="variable language_">self</span>.parameters():</span><br><span class="line">                param.requires_grad = <span class="literal">False</span></span><br><span class="line">        <span class="comment"># åˆå§‹åŒ–ç‰¹å¾å›¾çš„å½¢çŠ¶ä¸º None</span></span><br><span class="line">        <span class="variable language_">self</span>.feature_shape = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, X, indices=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="comment"># è®°å½•è¾“å…¥ç‰¹å¾å›¾çš„å½¢çŠ¶</span></span><br><span class="line">        <span class="variable language_">self</span>.feature_shape = X.shape</span><br><span class="line">        <span class="comment"># å¦‚æœæ²¡æœ‰æŒ‡å®šç´¢å¼•ï¼Œåˆ™é»˜è®¤ä½¿ç”¨ [7, 25]</span></span><br><span class="line">        <span class="keyword">if</span> indices <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            indices = [<span class="number">7</span>,<span class="number">25</span>]</span><br><span class="line">        <span class="comment"># å­˜å‚¨æå–çš„ç‰¹å¾å›¾</span></span><br><span class="line">        out = []</span><br><span class="line">        <span class="comment"># éå†åˆ°æœ€åä¸€ä¸ªç´¢å¼•ä½ç½®</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(indices[-<span class="number">1</span>]):</span><br><span class="line">            <span class="comment"># é€šè¿‡ VGG19 çš„ç¬¬ i å±‚è¿›è¡Œç‰¹å¾æå–</span></span><br><span class="line">            X = <span class="variable language_">self</span>.vgg_pretrained_features[i](X)</span><br><span class="line">            <span class="comment"># å¦‚æœå½“å‰å±‚çš„ç´¢å¼•åŠ  1 åœ¨æŒ‡å®šçš„ç´¢å¼•åˆ—è¡¨ä¸­</span></span><br><span class="line">            <span class="keyword">if</span> (i+<span class="number">1</span>) <span class="keyword">in</span> indices:</span><br><span class="line">                <span class="keyword">if</span> <span class="variable language_">self</span>.feature_shape <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                    <span class="comment"># å¦‚æœç‰¹å¾å›¾å½¢çŠ¶ä¸º Noneï¼Œåˆ™è®°å½•å½“å‰ç‰¹å¾å›¾çš„å½¢çŠ¶</span></span><br><span class="line">                    <span class="variable language_">self</span>.feature_shape = X.shape</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="comment"># å¯¹ç‰¹å¾å›¾è¿›è¡ŒåŒçº¿æ€§æ’å€¼ï¼Œä½¿å…¶å°ºå¯¸ä¸è¾“å…¥ç‰¹å¾å›¾çš„å°ºå¯¸ä¸€è‡´</span></span><br><span class="line">                    X = F.interpolate(X,<span class="variable language_">self</span>.feature_shape[-<span class="number">2</span>:],mode=<span class="string">&#x27;bilinear&#x27;</span>,align_corners=<span class="literal">True</span>)</span><br><span class="line">                <span class="comment"># å°†å¤„ç†åçš„ç‰¹å¾å›¾æ·»åŠ åˆ°è¾“å‡ºåˆ—è¡¨ä¸­</span></span><br><span class="line">                out.append(X)</span><br><span class="line">        <span class="comment"># å°†æ‰€æœ‰æå–çš„ç‰¹å¾å›¾åœ¨é€šé“ç»´åº¦ä¸Šæ‹¼æ¥èµ·æ¥</span></span><br><span class="line">        <span class="keyword">return</span> torch.cat(out,<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_imgs</span>(<span class="params">image_dir, num_img_to_load, start, end, skip, load_sorted, load_img</span>):</span><br><span class="line">    <span class="comment"># è·å–å›¾åƒç›®å½•ä¸‹æ‰€æœ‰å›¾åƒçš„æ–‡ä»¶åï¼Œå¹¶æŒ‰å­—æ¯é¡ºåºæ’åº</span></span><br><span class="line">    img_names = np.array(<span class="built_in">sorted</span>(os.listdir(image_dir))) <span class="comment"># all image names</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ—¶é—´åŸŸä¸‹é‡‡æ ·ï¼šæ ¹æ® startã€end å’Œ skip å‚æ•°é€‰æ‹©å›¾åƒ</span></span><br><span class="line">    <span class="keyword">if</span> end == -<span class="number">1</span>:</span><br><span class="line">        img_names = img_names[start::skip]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        img_names = img_names[start:end:skip]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¦‚æœä¸æŒ‰é¡ºåºåŠ è½½å›¾åƒï¼Œåˆ™å¯¹å›¾åƒæ–‡ä»¶åè¿›è¡Œéšæœºæ‰“ä¹±</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> load_sorted:</span><br><span class="line">        np.random.shuffle(img_names)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ£€æŸ¥è¦åŠ è½½çš„å›¾åƒæ•°é‡æ˜¯å¦è¶…è¿‡å¯ç”¨å›¾åƒæ•°é‡</span></span><br><span class="line">    <span class="keyword">if</span> num_img_to_load &gt; <span class="built_in">len</span>(img_names):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Asked for &#123;0:6d&#125; images but only &#123;1:6d&#125; available. Exit.&#x27;</span>.<span class="built_in">format</span>(num_img_to_load, <span class="built_in">len</span>(img_names)))</span><br><span class="line">        exit()</span><br><span class="line">    <span class="keyword">elif</span> num_img_to_load == -<span class="number">1</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Loading all available &#123;0:6d&#125; images&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">len</span>(img_names)))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Loading &#123;0:6d&#125; images out of &#123;1:6d&#125; images.&#x27;</span>.<span class="built_in">format</span>(num_img_to_load, <span class="built_in">len</span>(img_names)))</span><br><span class="line">        <span class="comment"># æˆªå–å‰ num_img_to_load ä¸ªå›¾åƒæ–‡ä»¶å</span></span><br><span class="line">        img_names = img_names[:num_img_to_load]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ„å»ºå›¾åƒæ–‡ä»¶çš„å®Œæ•´è·¯å¾„</span></span><br><span class="line">    img_paths = [os.path.join(image_dir, n) <span class="keyword">for</span> n <span class="keyword">in</span> img_names]</span><br><span class="line">    <span class="comment"># å›¾åƒçš„æ•°é‡</span></span><br><span class="line">    N_imgs = <span class="built_in">len</span>(img_paths)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å­˜å‚¨åŠ è½½çš„å›¾åƒ</span></span><br><span class="line">    img_list = []</span><br><span class="line">    <span class="keyword">if</span> load_img:</span><br><span class="line">        <span class="comment"># ä½¿ç”¨ tqdm æ˜¾ç¤ºåŠ è½½è¿›åº¦</span></span><br><span class="line">        <span class="keyword">for</span> p <span class="keyword">in</span> tqdm(img_paths):</span><br><span class="line">            <span class="comment"># è¯»å–å›¾åƒå¹¶æˆªå–å‰ä¸‰ä¸ªé€šé“ï¼ˆRGBï¼‰</span></span><br><span class="line">            img = imageio.imread(p)[:, :, :<span class="number">3</span>] <span class="comment"># (H, W, 3) np.uint8</span></span><br><span class="line">            <span class="comment"># å°†å›¾åƒæ·»åŠ åˆ°åˆ—è¡¨ä¸­</span></span><br><span class="line">            img_list.append(img)</span><br><span class="line">        <span class="comment"># å°†å›¾åƒåˆ—è¡¨è½¬æ¢ä¸º numpy æ•°ç»„</span></span><br><span class="line">        img_list = np.stack(img_list) <span class="comment"># (N, H, W, 3)</span></span><br><span class="line">        <span class="comment"># å°† numpy æ•°ç»„è½¬æ¢ä¸º PyTorch å¼ é‡ï¼Œå¹¶å°†åƒç´ å€¼å½’ä¸€åŒ–åˆ° [0, 1] èŒƒå›´</span></span><br><span class="line">        img_list = torch.from_numpy(img_list).<span class="built_in">float</span>() / <span class="number">255</span> <span class="comment"># (N, H, W, 3) torch.float32</span></span><br><span class="line">        <span class="comment"># è·å–å›¾åƒçš„é«˜åº¦å’Œå®½åº¦</span></span><br><span class="line">        H, W = img_list.shape[<span class="number">1</span>], img_list.shape[<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># å¦‚æœä¸åŠ è½½å›¾åƒï¼Œåˆ™è¯»å–ç¬¬ä¸€å¼ å›¾åƒä»¥è·å–å›¾åƒçš„é«˜åº¦å’Œå®½åº¦</span></span><br><span class="line">        tmp_img = imageio.imread(img_paths[<span class="number">0</span>]) <span class="comment"># load one image to get H, W</span></span><br><span class="line">        H, W = tmp_img.shape[<span class="number">0</span>], tmp_img.shape[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å­˜å‚¨åŠ è½½å›¾åƒçš„ç›¸å…³ä¿¡æ¯</span></span><br><span class="line">    results = &#123;</span><br><span class="line">        <span class="string">&#x27;imgs&#x27;</span>: img_list, <span class="comment"># (N, H, W, 3) torch.float32</span></span><br><span class="line">        <span class="string">&#x27;img_names&#x27;</span>: img_names, <span class="comment"># (N, )</span></span><br><span class="line">        <span class="string">&#x27;N_imgs&#x27;</span>: N_imgs,</span><br><span class="line">        <span class="string">&#x27;H&#x27;</span>: H,</span><br><span class="line">        <span class="string">&#x27;W&#x27;</span>: W,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DataLoaderAnyFolder</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Most useful fields:</span></span><br><span class="line"><span class="string">    self.c2ws: (N_imgs, 4, 4) torch.float32</span></span><br><span class="line"><span class="string">    self.imgs (N_imgs, H, W, 4) torch.float32</span></span><br><span class="line"><span class="string">    self.ray_dir_cam (H, W, 3) torch.float32</span></span><br><span class="line"><span class="string">    self.H scalar</span></span><br><span class="line"><span class="string">    self.W scalar</span></span><br><span class="line"><span class="string">    self.N_imgs scalar</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, base_dir, scene_name, res_ratio, num_img_to_load, start, end, skip, load_sorted, load_img=<span class="literal">True</span>, device=<span class="string">&#x27;cpu&#x27;</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        :param base_dir: æ•°æ®çš„åŸºç¡€ç›®å½•</span></span><br><span class="line"><span class="string">        :param scene_name: åœºæ™¯çš„åç§°</span></span><br><span class="line"><span class="string">        :param res_ratio: æ•´æ•°ï¼Œå¦‚ [1, 2, 4] ç­‰ï¼Œç”¨äºå°†å›¾åƒè°ƒæ•´ä¸ºè¾ƒä½çš„åˆ†è¾¨ç‡ã€‚</span></span><br><span class="line"><span class="string">        :param start/end/skip: ç”¨äºåœ¨æ—¶é—´åŸŸä¸Šæ§åˆ¶å¸§çš„åŠ è½½ã€‚</span></span><br><span class="line"><span class="string">        :param load_sorted: å¸ƒå°”å€¼ï¼Œæ˜¯å¦æŒ‰é¡ºåºåŠ è½½å›¾åƒã€‚</span></span><br><span class="line"><span class="string">        :param load_img: å¸ƒå°”å€¼ã€‚å¦‚æœè®¾ç½®ä¸º Falseï¼šä»…ç»Ÿè®¡å›¾åƒæ•°é‡ã€è·å–å›¾åƒçš„é«˜åº¦å’Œå®½åº¦ï¼Œ</span></span><br><span class="line"><span class="string">                         ä½†ä¸åŠ è½½å›¾åƒã€‚åœ¨å¯è§†åŒ–ä½å§¿æˆ–è°ƒè¯•ç­‰æƒ…å†µä¸‹å¾ˆæœ‰ç”¨ã€‚</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.base_dir = base_dir</span><br><span class="line">        <span class="variable language_">self</span>.scene_name = scene_name</span><br><span class="line">        <span class="variable language_">self</span>.res_ratio = res_ratio</span><br><span class="line">        <span class="variable language_">self</span>.num_img_to_load = num_img_to_load</span><br><span class="line">        <span class="variable language_">self</span>.start = start</span><br><span class="line">        <span class="variable language_">self</span>.end = end</span><br><span class="line">        <span class="variable language_">self</span>.skip = skip</span><br><span class="line">        <span class="variable language_">self</span>.load_sorted = load_sorted</span><br><span class="line">        <span class="variable language_">self</span>.load_img = load_img</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ„å»ºå›¾åƒç›®å½•çš„å®Œæ•´è·¯å¾„</span></span><br><span class="line">        <span class="variable language_">self</span>.imgs_dir = os.path.join(<span class="variable language_">self</span>.base_dir, <span class="variable language_">self</span>.scene_name)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è°ƒç”¨ load_imgs å‡½æ•°åŠ è½½å›¾åƒ</span></span><br><span class="line">        image_data = load_imgs(<span class="variable language_">self</span>.imgs_dir, <span class="variable language_">self</span>.num_img_to_load, <span class="variable language_">self</span>.start, <span class="variable language_">self</span>.end, <span class="variable language_">self</span>.skip,</span><br><span class="line">                               <span class="variable language_">self</span>.load_sorted, <span class="variable language_">self</span>.load_img)</span><br><span class="line">        <span class="comment"># åŠ è½½çš„å›¾åƒå¼ é‡</span></span><br><span class="line">        <span class="variable language_">self</span>.imgs = image_data[<span class="string">&#x27;imgs&#x27;</span>] <span class="comment"># (N, H, W, 3) torch.float32</span></span><br><span class="line">        <span class="comment"># å›¾åƒçš„æ–‡ä»¶å</span></span><br><span class="line">        <span class="variable language_">self</span>.img_names = image_data[<span class="string">&#x27;img_names&#x27;</span>] <span class="comment"># (N, )</span></span><br><span class="line">        <span class="comment"># å›¾åƒçš„æ•°é‡</span></span><br><span class="line">        <span class="variable language_">self</span>.N_imgs = image_data[<span class="string">&#x27;N_imgs&#x27;</span>]</span><br><span class="line">        <span class="comment"># åŸå§‹å›¾åƒçš„é«˜åº¦</span></span><br><span class="line">        <span class="variable language_">self</span>.ori_H = image_data[<span class="string">&#x27;H&#x27;</span>]</span><br><span class="line">        <span class="comment"># åŸå§‹å›¾åƒçš„å®½åº¦</span></span><br><span class="line">        <span class="variable language_">self</span>.ori_W = image_data[<span class="string">&#x27;W&#x27;</span>]</span><br><span class="line">        <span class="comment"># åˆå§‹åŒ– VGG19 ç¼–ç å™¨</span></span><br><span class="line">        <span class="variable language_">self</span>.encoder = Vgg19()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è¿‘è£å‰ªå¹³é¢è·ç¦»</span></span><br><span class="line">        <span class="variable language_">self</span>.near = <span class="number">0.0</span></span><br><span class="line">        <span class="comment"># è¿œè£å‰ªå¹³é¢è·ç¦»</span></span><br><span class="line">        <span class="variable language_">self</span>.far = <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># å¦‚æœéœ€è¦è°ƒæ•´å›¾åƒåˆ†è¾¨ç‡</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.res_ratio &gt; <span class="number">1</span>:</span><br><span class="line">            <span class="variable language_">self</span>.H = <span class="variable language_">self</span>.ori_H // <span class="variable language_">self</span>.res_ratio</span><br><span class="line">            <span class="variable language_">self</span>.W = <span class="variable language_">self</span>.ori_W // <span class="variable language_">self</span>.res_ratio</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="variable language_">self</span>.H = <span class="variable language_">self</span>.ori_H</span><br><span class="line">            <span class="variable language_">self</span>.W = <span class="variable language_">self</span>.ori_W</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.load_img:</span><br><span class="line">            <span class="comment"># è°ƒæ•´å›¾åƒçš„åˆ†è¾¨ç‡</span></span><br><span class="line">            <span class="variable language_">self</span>.imgs = resize_imgs(<span class="variable language_">self</span>.imgs, <span class="variable language_">self</span>.H, <span class="variable language_">self</span>.W) <span class="comment"># (N, H, W, 3) torch.float32</span></span><br><span class="line">            <span class="comment"># å­˜å‚¨å›¾åƒçš„ç‰¹å¾</span></span><br><span class="line">            <span class="variable language_">self</span>.features = []</span><br><span class="line">            <span class="comment"># ä½¿ç”¨ tqdm æ˜¾ç¤ºå¤„ç†è¿›åº¦</span></span><br><span class="line">            <span class="keyword">for</span> img <span class="keyword">in</span> tqdm(<span class="variable language_">self</span>.imgs):</span><br><span class="line">                <span class="comment"># å¯¹å›¾åƒè¿›è¡Œé€šé“ç»´åº¦çš„è°ƒæ•´ï¼Œå¹¶é€šè¿‡ç¼–ç å™¨æå–ç‰¹å¾</span></span><br><span class="line">                <span class="variable language_">self</span>.features.append(<span class="variable language_">self</span>.encoder(img.permute(<span class="number">2</span>,<span class="number">0</span>,<span class="number">1</span>)[<span class="literal">None</span>,...]))</span><br><span class="line">            <span class="comment"># å°†æ‰€æœ‰å›¾åƒçš„ç‰¹å¾åœ¨æ‰¹æ¬¡ç»´åº¦ä¸Šæ‹¼æ¥èµ·æ¥</span></span><br><span class="line">            <span class="variable language_">self</span>.features = torch.cat(<span class="variable language_">self</span>.features,<span class="number">0</span>)</span><br><span class="line">            <span class="comment"># ç‰¹å¾å›¾çš„å°ºå¯¸</span></span><br><span class="line">            <span class="variable language_">self</span>.feature_size = (<span class="variable language_">self</span>.features.shape[-<span class="number">2</span>],<span class="variable language_">self</span>.features.shape[-<span class="number">1</span>]) <span class="comment"># (H,W)</span></span><br><span class="line">            <span class="comment"># æ‰“å°ç‰¹å¾å›¾çš„å½¢çŠ¶</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="variable language_">self</span>.features.shape)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># æ•°æ®çš„åŸºç¡€ç›®å½•ï¼Œéœ€è¦æ›¿æ¢ä¸ºå®é™…çš„è·¯å¾„</span></span><br><span class="line">    base_dir = <span class="string">&#x27;/your/data/path&#x27;</span></span><br><span class="line">    <span class="comment"># åœºæ™¯çš„åç§°</span></span><br><span class="line">    scene_name = <span class="string">&#x27;LLFF/fern/images&#x27;</span></span><br><span class="line">    <span class="comment"># å›¾åƒçš„ç¼©æ”¾æ¯”ä¾‹</span></span><br><span class="line">    resize_ratio = <span class="number">8</span></span><br><span class="line">    <span class="comment"># è¦åŠ è½½çš„å›¾åƒæ•°é‡ï¼Œ-1 è¡¨ç¤ºåŠ è½½æ‰€æœ‰å›¾åƒ</span></span><br><span class="line">    num_img_to_load = -<span class="number">1</span></span><br><span class="line">    <span class="comment"># å¼€å§‹åŠ è½½å›¾åƒçš„ç´¢å¼•</span></span><br><span class="line">    start = <span class="number">0</span></span><br><span class="line">    <span class="comment"># ç»“æŸåŠ è½½å›¾åƒçš„ç´¢å¼•ï¼Œ-1 è¡¨ç¤ºåŠ è½½åˆ°æœ€å</span></span><br><span class="line">    end = -<span class="number">1</span></span><br><span class="line">    <span class="comment"># åŠ è½½å›¾åƒçš„é—´éš”</span></span><br><span class="line">    skip = <span class="number">1</span></span><br><span class="line">    <span class="comment"># æ˜¯å¦æŒ‰é¡ºåºåŠ è½½å›¾åƒ</span></span><br><span class="line">    load_sorted = <span class="literal">True</span></span><br><span class="line">    <span class="comment"># æ˜¯å¦åŠ è½½å›¾åƒ</span></span><br><span class="line">    load_img = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># åˆå§‹åŒ– DataLoaderAnyFolder ç±»</span></span><br><span class="line">    scene = DataLoaderAnyFolder(base_dir=base_dir,</span><br><span class="line">                                scene_name=scene_name,</span><br><span class="line">                                res_ratio=resize_ratio,</span><br><span class="line">                                num_img_to_load=num_img_to_load,</span><br><span class="line">                                start=start,</span><br><span class="line">                                end=end,</span><br><span class="line">                                skip=skip,</span><br><span class="line">                                load_sorted=load_sorted,</span><br><span class="line">                                load_img=load_img)</span><br></pre></td></tr></table></figure>
<h4 id="with-colmap-py">with_colmap.py</h4>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="comment"># os æ¨¡å—æä¾›äº†ä¸æ“ä½œç³»ç»Ÿè¿›è¡Œäº¤äº’çš„åŠŸèƒ½ï¼Œ</span></span><br><span class="line"><span class="comment"># å¯ä»¥ç”¨æ¥å¤„ç†æ–‡ä»¶å’Œç›®å½•è·¯å¾„ã€åˆ›å»º/åˆ é™¤ç›®å½•ã€è·å–ç¯å¢ƒå˜é‡ç­‰ï¼Œ</span></span><br><span class="line"><span class="comment"># åœ¨ä»£ç ä¸­ä¸»è¦ç”¨äºæ„å»ºæ–‡ä»¶å’Œç›®å½•çš„è·¯å¾„ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="comment"># torch æ˜¯ PyTorch çš„æ ¸å¿ƒåº“ï¼Œæä¾›äº†å¼ é‡ï¼ˆTensorï¼‰æ•°æ®ç»“æ„ï¼Œ</span></span><br><span class="line"><span class="comment"># æ”¯æŒè‡ªåŠ¨æ±‚å¯¼æœºåˆ¶ï¼Œç”¨äºæ„å»ºå’Œè®­ç»ƒæ·±åº¦å­¦ä¹ æ¨¡å‹ï¼Œ</span></span><br><span class="line"><span class="comment"># å¯ä»¥åœ¨ CPU æˆ– GPU ä¸Šè¿›è¡Œé«˜æ•ˆçš„æ•°å€¼è®¡ç®—ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"><span class="comment"># torch.nn.functional æä¾›äº†è®¸å¤šç¥ç»ç½‘ç»œä¸­å¸¸ç”¨çš„å‡½æ•°ï¼Œ</span></span><br><span class="line"><span class="comment"># å¦‚æ¿€æ´»å‡½æ•°ã€æŸå¤±å‡½æ•°ã€å·ç§¯ã€æ± åŒ–ç­‰æ“ä½œï¼Œ</span></span><br><span class="line"><span class="comment"># è¿™äº›å‡½æ•°æ˜¯æ— çŠ¶æ€çš„ï¼Œé€šå¸¸ç”¨äºè‡ªå®šä¹‰ç¥ç»ç½‘ç»œå±‚ä¸­çš„å…·ä½“è¿ç®—ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="comment"># numpy æ˜¯ Python ä¸­ç”¨äºç§‘å­¦è®¡ç®—çš„åŸºç¡€åº“ï¼Œ</span></span><br><span class="line"><span class="comment"># æä¾›äº†é«˜æ•ˆçš„å¤šç»´æ•°ç»„å¯¹è±¡å’Œå„ç§æ•°å­¦å‡½æ•°ï¼Œ</span></span><br><span class="line"><span class="comment"># å¯ä»¥è¿›è¡Œæ•°ç»„æ“ä½œã€çº¿æ€§ä»£æ•°è¿ç®—ã€éšæœºæ•°ç”Ÿæˆç­‰ï¼Œ</span></span><br><span class="line"><span class="comment"># åœ¨ä»£ç ä¸­ä¸»è¦ç”¨äºå¤„ç†å›¾åƒæ•°æ®å’Œæ•°ç»„æ“ä½œã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="comment"># tqdm æ˜¯ä¸€ä¸ªå¿«é€Ÿã€å¯æ‰©å±•çš„è¿›åº¦æ¡å·¥å…·ï¼Œ</span></span><br><span class="line"><span class="comment"># å¯ä»¥åœ¨å¾ªç¯ä¸­æ˜¾ç¤ºè¿›åº¦æ¡ï¼Œæ–¹ä¾¿ç”¨æˆ·äº†è§£ä»£ç æ‰§è¡Œçš„è¿›åº¦ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> imageio</span><br><span class="line"><span class="comment"># imageio æ˜¯ä¸€ä¸ªç”¨äºè¯»å–å’Œå†™å…¥å¤šç§å›¾åƒæ–‡ä»¶æ ¼å¼çš„åº“ï¼Œ</span></span><br><span class="line"><span class="comment"># åœ¨ä»£ç ä¸­ä¸»è¦ç”¨äºè¯»å–å›¾åƒæ–‡ä»¶ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> utils.comp_ray_dir <span class="keyword">import</span> comp_ray_dir_cam</span><br><span class="line"><span class="comment"># ä» utils åŒ…ä¸­çš„ comp_ray_dir æ¨¡å—å¯¼å…¥ comp_ray_dir_cam å‡½æ•°ï¼Œ</span></span><br><span class="line"><span class="comment"># æ¨æµ‹è¯¥å‡½æ•°ç”¨äºè®¡ç®—ç›¸æœºåæ ‡ç³»ä¸‹çš„å…‰çº¿æ–¹å‘ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> utils.pose_utils <span class="keyword">import</span> center_poses</span><br><span class="line"><span class="comment"># ä» utils åŒ…ä¸­çš„ pose_utils æ¨¡å—å¯¼å…¥ center_poses å‡½æ•°ï¼Œ</span></span><br><span class="line"><span class="comment"># æ¨æµ‹è¯¥å‡½æ•°ç”¨äºå¯¹ç›¸æœºä½å§¿è¿›è¡Œä¸­å¿ƒåŒ–å¤„ç†ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> utils.lie_group_helper <span class="keyword">import</span> convert3x4_4x4</span><br><span class="line"><span class="comment"># ä» utils åŒ…ä¸­çš„ lie_group_helper æ¨¡å—å¯¼å…¥ convert3x4_4x4 å‡½æ•°ï¼Œ</span></span><br><span class="line"><span class="comment"># æ¨æµ‹è¯¥å‡½æ•°ç”¨äºå°† 3x4 çš„ç›¸æœºä½å§¿çŸ©é˜µè½¬æ¢ä¸º 4x4 çš„é½æ¬¡çŸ©é˜µã€‚</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">resize_imgs</span>(<span class="params">imgs, new_h, new_w</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    :param imgs:    (N, H, W, 3)            torch.float32 RGB</span></span><br><span class="line"><span class="string">    :param new_h:   int/torch int</span></span><br><span class="line"><span class="string">    :param new_w:   int/torch int</span></span><br><span class="line"><span class="string">    :return:        (N, new_H, new_W, 3)    torch.float32 RGB</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># å°†å›¾åƒå¼ é‡ä» (N, H, W, 3) è½¬æ¢ä¸º (N, 3, H, W) ä»¥é€‚åº” F.interpolate å‡½æ•°çš„è¾“å…¥è¦æ±‚</span></span><br><span class="line">    imgs = imgs.permute(<span class="number">0</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">2</span>)  <span class="comment"># (N, 3, H, W)</span></span><br><span class="line">    <span class="comment"># ä½¿ç”¨åŒçº¿æ€§æ’å€¼æ–¹æ³•å°†å›¾åƒè°ƒæ•´åˆ°æŒ‡å®šçš„æ–°é«˜åº¦å’Œæ–°å®½åº¦</span></span><br><span class="line">    imgs = F.interpolate(imgs, size=(new_h, new_w), mode=<span class="string">&#x27;bilinear&#x27;</span>)  <span class="comment"># (N, 3, new_H, new_W)</span></span><br><span class="line">    <span class="comment"># å°†å›¾åƒå¼ é‡ä» (N, 3, new_H, new_W) è½¬æ¢å› (N, new_H, new_W, 3)</span></span><br><span class="line">    imgs = imgs.permute(<span class="number">0</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>)  <span class="comment"># (N, new_H, new_W, 3)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> imgs  <span class="comment"># (N, new_H, new_W, 3) torch.float32 RGB</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_imgs</span>(<span class="params">image_dir, img_ids, new_h, new_w</span>):</span><br><span class="line">    <span class="comment"># è·å–å›¾åƒç›®å½•ä¸‹æ‰€æœ‰å›¾åƒæ–‡ä»¶åï¼Œå¹¶æŒ‰å­—æ¯é¡ºåºæ’åº</span></span><br><span class="line">    img_names = np.array(<span class="built_in">sorted</span>(os.listdir(image_dir)))  <span class="comment"># all image names</span></span><br><span class="line">    <span class="comment"># æ ¹æ®ç»™å®šçš„å›¾åƒç´¢å¼•ç­›é€‰å‡ºéœ€è¦çš„å›¾åƒæ–‡ä»¶å</span></span><br><span class="line">    img_names = img_names[img_ids]  <span class="comment"># image name for this split</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ„å»ºæ¯ä¸ªå›¾åƒçš„å®Œæ•´è·¯å¾„</span></span><br><span class="line">    img_paths = [os.path.join(image_dir, n) <span class="keyword">for</span> n <span class="keyword">in</span> img_names]</span><br><span class="line"></span><br><span class="line">    img_list = []</span><br><span class="line">    <span class="comment"># ä½¿ç”¨ tqdm æ˜¾ç¤ºåŠ è½½å›¾åƒçš„è¿›åº¦</span></span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> tqdm(img_paths):</span><br><span class="line">        <span class="comment"># è¯»å–å›¾åƒå¹¶åªä¿ç•™å‰ä¸‰ä¸ªé€šé“ï¼ˆRGBï¼‰</span></span><br><span class="line">        img = imageio.imread(p)[:, :, :<span class="number">3</span>]  <span class="comment"># (H, W, 3) np.uint8</span></span><br><span class="line">        img_list.append(img)</span><br><span class="line">    <span class="comment"># å°†å›¾åƒåˆ—è¡¨è½¬æ¢ä¸º numpy æ•°ç»„</span></span><br><span class="line">    img_list = np.stack(img_list)  <span class="comment"># (N, H, W, 3)</span></span><br><span class="line">    <span class="comment"># å°† numpy æ•°ç»„è½¬æ¢ä¸º PyTorch å¼ é‡ï¼Œå¹¶å°†åƒç´ å€¼å½’ä¸€åŒ–åˆ° [0, 1] èŒƒå›´</span></span><br><span class="line">    img_list = torch.from_numpy(img_list).<span class="built_in">float</span>() / <span class="number">255</span>  <span class="comment"># (N, H, W, 3) torch.float32</span></span><br><span class="line">    <span class="comment"># è°ƒç”¨ resize_imgs å‡½æ•°å°†å›¾åƒè°ƒæ•´åˆ°æŒ‡å®šçš„æ–°é«˜åº¦å’Œæ–°å®½åº¦</span></span><br><span class="line">    img_list = resize_imgs(img_list, new_h, new_w)</span><br><span class="line">    <span class="keyword">return</span> img_list, img_names</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_meta</span>(<span class="params">in_dir, use_ndc</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Read the poses_bounds.npy file produced by LLFF imgs2poses.py.</span></span><br><span class="line"><span class="string">    This function is modified from https://github.com/kwea123/nerf_pl.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># åŠ è½½ poses_bounds.npy æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶åŒ…å«ç›¸æœºä½å§¿å’Œæ·±åº¦è¾¹ç•Œä¿¡æ¯</span></span><br><span class="line">    poses_bounds = np.load(os.path.join(in_dir, <span class="string">&#x27;poses_bounds.npy&#x27;</span>))  <span class="comment"># (N_images, 17)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># æå–ç›¸æœºä½å§¿ä¿¡æ¯ï¼Œå°†å…¶é‡å¡‘ä¸º (N_images, 3, 5) çš„å½¢çŠ¶</span></span><br><span class="line">    c2ws = poses_bounds[:, :<span class="number">15</span>].reshape(-<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>)  <span class="comment"># (N_images, 3, 5)</span></span><br><span class="line">    <span class="comment"># æå–æ·±åº¦è¾¹ç•Œä¿¡æ¯</span></span><br><span class="line">    bounds = poses_bounds[:, -<span class="number">2</span>:]  <span class="comment"># (N_images, 2)</span></span><br><span class="line">    <span class="comment"># æå–å›¾åƒé«˜åº¦ã€å®½åº¦å’Œç„¦è·ä¿¡æ¯</span></span><br><span class="line">    H, W, focal = c2ws[<span class="number">0</span>, :, -<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä¿®æ­£ç›¸æœºä½å§¿çš„æ—‹è½¬éƒ¨åˆ†ï¼Œå°†æ—‹è½¬å½¢å¼ä» &quot;down right back&quot; æ”¹ä¸º &quot;right up back&quot;</span></span><br><span class="line">    <span class="comment"># å‚è€ƒ https://github.com/bmild/nerf/issues/34</span></span><br><span class="line">    c2ws = np.concatenate([c2ws[..., <span class="number">1</span>:<span class="number">2</span>], -c2ws[..., :<span class="number">1</span>], c2ws[..., <span class="number">2</span>:<span class="number">4</span>]], -<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¯¹ç›¸æœºä½å§¿è¿›è¡Œä¸­å¿ƒåŒ–å¤„ç†ï¼Œè¿”å›ä¸­å¿ƒåŒ–åçš„ç›¸æœºä½å§¿å’Œå¹³å‡ä½å§¿</span></span><br><span class="line">    <span class="comment"># pose_avg @ c2ws -&gt; centred c2ws</span></span><br><span class="line">    c2ws, pose_avg = center_poses(c2ws)  <span class="comment"># (N_images, 3, 4), (4, 4)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> use_ndc:</span><br><span class="line">        <span class="comment"># è·å–æœ€è¿‘æ·±åº¦å€¼</span></span><br><span class="line">        near_original = bounds.<span class="built_in">min</span>()</span><br><span class="line">        <span class="comment"># è®¡ç®—ç¼©æ”¾å› å­ï¼Œå°†æœ€è¿‘æ·±åº¦è°ƒæ•´åˆ°ç¨å¤§äº 1.0 çš„ä½ç½®</span></span><br><span class="line">        scale_factor = near_original * <span class="number">0.75</span>  <span class="comment"># 0.75 is the default parameter</span></span><br><span class="line">        <span class="comment"># å¯¹æ·±åº¦è¾¹ç•Œè¿›è¡Œç¼©æ”¾</span></span><br><span class="line">        bounds /= scale_factor</span><br><span class="line">        <span class="comment"># å¯¹ç›¸æœºä½å§¿çš„å¹³ç§»éƒ¨åˆ†è¿›è¡Œç¼©æ”¾</span></span><br><span class="line">        c2ws[..., <span class="number">3</span>] /= scale_factor</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å°† 3x4 çš„ç›¸æœºä½å§¿è½¬æ¢ä¸º 4x4 çš„é½æ¬¡çŸ©é˜µå½¢å¼</span></span><br><span class="line">    c2ws = convert3x4_4x4(c2ws)  <span class="comment"># (N, 4, 4)</span></span><br><span class="line"></span><br><span class="line">    results = &#123;</span><br><span class="line">        <span class="string">&#x27;c2ws&#x27;</span>: c2ws,       <span class="comment"># (N, 4, 4) np</span></span><br><span class="line">        <span class="string">&#x27;bounds&#x27;</span>: bounds,   <span class="comment"># (N_images, 2) np</span></span><br><span class="line">        <span class="string">&#x27;H&#x27;</span>: <span class="built_in">int</span>(H),        <span class="comment"># scalar</span></span><br><span class="line">        <span class="string">&#x27;W&#x27;</span>: <span class="built_in">int</span>(W),        <span class="comment"># scalar</span></span><br><span class="line">        <span class="string">&#x27;focal&#x27;</span>: focal,     <span class="comment"># scalar</span></span><br><span class="line">        <span class="string">&#x27;pose_avg&#x27;</span>: pose_avg,  <span class="comment"># (4, 4) np</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DataLoaderWithCOLMAP</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Most useful fields:</span></span><br><span class="line"><span class="string">        self.c2ws:          (N_imgs, 4, 4)      torch.float32</span></span><br><span class="line"><span class="string">        self.imgs           (N_imgs, H, W, 4)   torch.float32</span></span><br><span class="line"><span class="string">        self.ray_dir_cam    (H, W, 3)           torch.float32</span></span><br><span class="line"><span class="string">        self.H              scalar</span></span><br><span class="line"><span class="string">        self.W              scalar</span></span><br><span class="line"><span class="string">        self.N_imgs         scalar</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, base_dir, scene_name, data_type, res_ratio, num_img_to_load, skip, use_ndc, load_img=<span class="literal">True</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        :param base_dir:</span></span><br><span class="line"><span class="string">        :param scene_name:</span></span><br><span class="line"><span class="string">        :param data_type:   &#x27;train&#x27; or &#x27;val&#x27;.</span></span><br><span class="line"><span class="string">        :param res_ratio:   int [1, 2, 4] etc to resize images to a lower resolution.</span></span><br><span class="line"><span class="string">        :param num_img_to_load/skip: control frame loading in temporal domain.</span></span><br><span class="line"><span class="string">        :param use_ndc      True/False, just centre the poses and scale them.</span></span><br><span class="line"><span class="string">        :param load_img:    True/False. If set to false: only count number of images, get H and W,</span></span><br><span class="line"><span class="string">                            but do not load imgs. Useful when vis poses or debug etc.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.base_dir = base_dir</span><br><span class="line">        <span class="variable language_">self</span>.scene_name = scene_name</span><br><span class="line">        <span class="variable language_">self</span>.data_type = data_type</span><br><span class="line">        <span class="variable language_">self</span>.res_ratio = res_ratio</span><br><span class="line">        <span class="variable language_">self</span>.num_img_to_load = num_img_to_load</span><br><span class="line">        <span class="variable language_">self</span>.skip = skip</span><br><span class="line">        <span class="variable language_">self</span>.use_ndc = use_ndc</span><br><span class="line">        <span class="variable language_">self</span>.load_img = load_img</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ„å»ºåœºæ™¯ç›®å½•çš„å®Œæ•´è·¯å¾„</span></span><br><span class="line">        <span class="variable language_">self</span>.scene_dir = os.path.join(<span class="variable language_">self</span>.base_dir, <span class="variable language_">self</span>.scene_name)</span><br><span class="line">        <span class="comment"># æ„å»ºå›¾åƒç›®å½•çš„å®Œæ•´è·¯å¾„</span></span><br><span class="line">        <span class="variable language_">self</span>.img_dir = os.path.join(<span class="variable language_">self</span>.scene_dir, <span class="string">&#x27;images&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è¯»å–æ‰€æœ‰çš„å…ƒä¿¡æ¯ï¼ŒåŒ…æ‹¬ç›¸æœºä½å§¿ã€æ·±åº¦è¾¹ç•Œã€å›¾åƒå°ºå¯¸å’Œç„¦è·ç­‰</span></span><br><span class="line">        meta = read_meta(<span class="variable language_">self</span>.scene_dir, <span class="variable language_">self</span>.use_ndc)</span><br><span class="line">        <span class="comment"># æå–ç›¸æœºä½å§¿ä¿¡æ¯</span></span><br><span class="line">        <span class="variable language_">self</span>.c2ws = meta[<span class="string">&#x27;c2ws&#x27;</span>]  <span class="comment"># (N, 4, 4) all camera pose</span></span><br><span class="line">        <span class="comment"># æå–å›¾åƒé«˜åº¦ä¿¡æ¯</span></span><br><span class="line">        <span class="variable language_">self</span>.H = meta[<span class="string">&#x27;H&#x27;</span>]</span><br><span class="line">        <span class="comment"># æå–å›¾åƒå®½åº¦ä¿¡æ¯</span></span><br><span class="line">        <span class="variable language_">self</span>.W = meta[<span class="string">&#x27;W&#x27;</span>]</span><br><span class="line">        <span class="comment"># æå–ç„¦è·ä¿¡æ¯</span></span><br><span class="line">        <span class="variable language_">self</span>.focal = <span class="built_in">float</span>(meta[<span class="string">&#x27;focal&#x27;</span>])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.res_ratio &gt; <span class="number">1</span>:</span><br><span class="line">            <span class="comment"># å¦‚æœéœ€è¦è°ƒæ•´å›¾åƒåˆ†è¾¨ç‡ï¼Œå¯¹å›¾åƒé«˜åº¦è¿›è¡Œç›¸åº”çš„ç¼©æ”¾</span></span><br><span class="line">            <span class="variable language_">self</span>.H = <span class="variable language_">self</span>.H // <span class="variable language_">self</span>.res_ratio</span><br><span class="line">            <span class="comment"># å¦‚æœéœ€è¦è°ƒæ•´å›¾åƒåˆ†è¾¨ç‡ï¼Œå¯¹å›¾åƒå®½åº¦è¿›è¡Œç›¸åº”çš„ç¼©æ”¾</span></span><br><span class="line">            <span class="variable language_">self</span>.W = <span class="variable language_">self</span>.W // <span class="variable language_">self</span>.res_ratio</span><br><span class="line">            <span class="comment"># å¦‚æœéœ€è¦è°ƒæ•´å›¾åƒåˆ†è¾¨ç‡ï¼Œå¯¹ç„¦è·è¿›è¡Œç›¸åº”çš„ç¼©æ”¾</span></span><br><span class="line">            <span class="variable language_">self</span>.focal /= <span class="variable language_">self</span>.res_ratio</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è¿‘è£å‰ªå¹³é¢è·ç¦»</span></span><br><span class="line">        <span class="variable language_">self</span>.near = <span class="number">0.0</span></span><br><span class="line">        <span class="comment"># è¿œè£å‰ªå¹³é¢è·ç¦»</span></span><br><span class="line">        <span class="variable language_">self</span>.far = <span class="number">1.0</span></span><br><span class="line">        <span class="comment"># åŠ è½½å›¾åƒå¹¶è°ƒæ•´åˆ°æŒ‡å®šçš„é«˜åº¦å’Œå®½åº¦</span></span><br><span class="line">        <span class="variable language_">self</span>.imgs, <span class="variable language_">self</span>.img_names = load_imgs(<span class="variable language_">self</span>.img_dir, np.arange(num_img_to_load), <span class="variable language_">self</span>.H, <span class="variable language_">self</span>.W)  <span class="comment"># (N, H, W, 3) torch.float32</span></span><br><span class="line">        <span class="comment"># æˆªå–å‰ num_img_to_load ä¸ªç›¸æœºä½å§¿</span></span><br><span class="line">        <span class="variable language_">self</span>.c2ws = <span class="variable language_">self</span>.c2ws[:num_img_to_load]</span><br><span class="line">        <span class="comment"># å›¾åƒçš„æ•°é‡</span></span><br><span class="line">        <span class="variable language_">self</span>.N_imgs = <span class="variable language_">self</span>.c2ws.shape[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ç”Ÿæˆç›¸æœºåæ ‡ç³»ä¸‹çš„å…‰çº¿æ–¹å‘</span></span><br><span class="line">        <span class="variable language_">self</span>.ray_dir_cam = comp_ray_dir_cam(<span class="variable language_">self</span>.H, <span class="variable language_">self</span>.W, <span class="variable language_">self</span>.focal)  <span class="comment"># (H, W, 3) torch.float32</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># å°†ç›¸æœºä½å§¿ä» numpy æ•°ç»„è½¬æ¢ä¸º PyTorch å¼ é‡</span></span><br><span class="line">        <span class="variable language_">self</span>.c2ws = torch.from_numpy(<span class="variable language_">self</span>.c2ws).<span class="built_in">float</span>()  <span class="comment"># (N, 4, 4) torch.float32</span></span><br><span class="line">        <span class="comment"># å°†å…‰çº¿æ–¹å‘å¼ é‡è½¬æ¢ä¸º float32 ç±»å‹</span></span><br><span class="line">        <span class="variable language_">self</span>.ray_dir_cam = <span class="variable language_">self</span>.ray_dir_cam.<span class="built_in">float</span>()  <span class="comment"># (H, W, 3) torch.float32</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    scene_name = <span class="string">&#x27;LLFF/fern&#x27;</span></span><br><span class="line">    use_ndc = <span class="literal">True</span></span><br><span class="line">    <span class="comment"># æ³¨æ„ï¼šéœ€è¦å°† /your/data/path æ›¿æ¢ä¸ºå®é™…çš„æ•°æ®è·¯å¾„ï¼Œ</span></span><br><span class="line">    <span class="comment"># è¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ª DataLoaderWithCOLMAP ç±»çš„å®ä¾‹ï¼Œç”¨äºåŠ è½½æŒ‡å®šåœºæ™¯çš„æ•°æ®</span></span><br><span class="line">    scene = DataLoaderWithCOLMAP(base_dir=<span class="string">&#x27;/your/data/path&#x27;</span>,</span><br><span class="line">                                 scene_name=scene_name,</span><br><span class="line">                                 data_type=<span class="string">&#x27;train&#x27;</span>,</span><br><span class="line">                                 res_ratio=<span class="number">8</span>,</span><br><span class="line">                                 num_img_to_load=-<span class="number">1</span>,</span><br><span class="line">                                 skip=<span class="number">1</span>,</span><br><span class="line">                                 use_ndc=use_ndc)</span><br></pre></td></tr></table></figure>
<h4 id="with-feature-colmap-py">with_feature_colmap.py</h4>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="comment"># os æ¨¡å—æä¾›äº†ä¸æ“ä½œç³»ç»Ÿè¿›è¡Œäº¤äº’çš„åŠŸèƒ½ï¼Œ</span></span><br><span class="line"><span class="comment"># å¯ç”¨äºå¤„ç†æ–‡ä»¶å’Œç›®å½•è·¯å¾„ã€åˆ›å»º/åˆ é™¤ç›®å½•ã€è·å–ç¯å¢ƒå˜é‡ç­‰ï¼Œ</span></span><br><span class="line"><span class="comment"># åœ¨æœ¬ä»£ç é‡Œä¸»è¦ç”¨äºæ„å»ºæ–‡ä»¶å’Œç›®å½•çš„è·¯å¾„ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="comment"># torch æ˜¯ PyTorch çš„æ ¸å¿ƒåº“ï¼Œæä¾›äº†å¼ é‡ï¼ˆTensorï¼‰æ•°æ®ç»“æ„ï¼Œ</span></span><br><span class="line"><span class="comment"># æ”¯æŒè‡ªåŠ¨æ±‚å¯¼æœºåˆ¶ï¼Œç”¨äºæ„å»ºå’Œè®­ç»ƒæ·±åº¦å­¦ä¹ æ¨¡å‹ï¼Œ</span></span><br><span class="line"><span class="comment"># èƒ½å¤Ÿåœ¨ CPU æˆ– GPU ä¸Šé«˜æ•ˆåœ°è¿›è¡Œæ•°å€¼è®¡ç®—ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="comment"># numpy æ˜¯ Python ä¸­ç”¨äºç§‘å­¦è®¡ç®—çš„åŸºç¡€åº“ï¼Œ</span></span><br><span class="line"><span class="comment"># æä¾›äº†é«˜æ•ˆçš„å¤šç»´æ•°ç»„å¯¹è±¡å’Œå„ç§æ•°å­¦å‡½æ•°ï¼Œ</span></span><br><span class="line"><span class="comment"># å¯è¿›è¡Œæ•°ç»„æ“ä½œã€çº¿æ€§ä»£æ•°è¿ç®—ã€éšæœºæ•°ç”Ÿæˆç­‰ï¼Œ</span></span><br><span class="line"><span class="comment"># åœ¨ä»£ç ä¸­ä¸»è¦ç”¨äºå¤„ç†å›¾åƒæ•°æ®å’Œæ•°ç»„æ“ä½œã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="comment"># tqdm æ˜¯ä¸€ä¸ªå¿«é€Ÿã€å¯æ‰©å±•çš„è¿›åº¦æ¡å·¥å…·ï¼Œ</span></span><br><span class="line"><span class="comment"># èƒ½åœ¨å¾ªç¯ä¸­æ˜¾ç¤ºè¿›åº¦æ¡ï¼Œæ–¹ä¾¿ç”¨æˆ·äº†è§£ä»£ç æ‰§è¡Œçš„è¿›åº¦ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> imageio</span><br><span class="line"><span class="comment"># imageio æ˜¯ä¸€ä¸ªç”¨äºè¯»å–å’Œå†™å…¥å¤šç§å›¾åƒæ–‡ä»¶æ ¼å¼çš„åº“ï¼Œ</span></span><br><span class="line"><span class="comment"># åœ¨ä»£ç ä¸­ä¸»è¦ç”¨äºè¯»å–å›¾åƒæ–‡ä»¶ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> dataloader.with_colmap <span class="keyword">import</span> resize_imgs</span><br><span class="line"><span class="comment"># ä» dataloader.with_colmap æ¨¡å—å¯¼å…¥ resize_imgs å‡½æ•°ï¼Œ</span></span><br><span class="line"><span class="comment"># è¯¥å‡½æ•°ç”¨äºè°ƒæ•´å›¾åƒçš„å°ºå¯¸ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> torchvision <span class="keyword">import</span> models</span><br><span class="line"><span class="comment"># torchvision æ˜¯ PyTorch ä¸­ç”¨äºè®¡ç®—æœºè§†è§‰ä»»åŠ¡çš„åº“ï¼Œ</span></span><br><span class="line"><span class="comment"># models å­æ¨¡å—æä¾›äº†é¢„è®­ç»ƒçš„æ·±åº¦å­¦ä¹ æ¨¡å‹ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> torch.nn <span class="keyword">import</span> functional <span class="keyword">as</span> F</span><br><span class="line"><span class="comment"># torch.nn.functional æä¾›äº†è®¸å¤šç¥ç»ç½‘ç»œä¸­å¸¸ç”¨çš„å‡½æ•°ï¼Œ</span></span><br><span class="line"><span class="comment"># ä¾‹å¦‚æ¿€æ´»å‡½æ•°ã€æŸå¤±å‡½æ•°ã€å·ç§¯ã€æ± åŒ–ç­‰æ“ä½œï¼Œ</span></span><br><span class="line"><span class="comment"># è¿™äº›å‡½æ•°æ˜¯æ— çŠ¶æ€çš„ï¼Œé€šå¸¸ç”¨äºè‡ªå®šä¹‰ç¥ç»ç½‘ç»œå±‚ä¸­çš„å…·ä½“è¿ç®—ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> utils.comp_ray_dir <span class="keyword">import</span> comp_ray_dir_cam</span><br><span class="line"><span class="comment"># ä» utils åŒ…ä¸­çš„ comp_ray_dir æ¨¡å—å¯¼å…¥ comp_ray_dir_cam å‡½æ•°ï¼Œ</span></span><br><span class="line"><span class="comment"># æ¨æµ‹è¯¥å‡½æ•°ç”¨äºè®¡ç®—ç›¸æœºåæ ‡ç³»ä¸‹çš„å…‰çº¿æ–¹å‘ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> utils.pose_utils <span class="keyword">import</span> center_poses</span><br><span class="line"><span class="comment"># ä» utils åŒ…ä¸­çš„ pose_utils æ¨¡å—å¯¼å…¥ center_poses å‡½æ•°ï¼Œ</span></span><br><span class="line"><span class="comment"># æ¨æµ‹è¯¥å‡½æ•°ç”¨äºå¯¹ç›¸æœºä½å§¿è¿›è¡Œä¸­å¿ƒåŒ–å¤„ç†ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> utils.lie_group_helper <span class="keyword">import</span> convert3x4_4x4</span><br><span class="line"><span class="comment"># ä» utils åŒ…ä¸­çš„ lie_group_helper æ¨¡å—å¯¼å…¥ convert3x4_4x4 å‡½æ•°ï¼Œ</span></span><br><span class="line"><span class="comment"># æ¨æµ‹è¯¥å‡½æ•°ç”¨äºå°† 3x4 çš„ç›¸æœºä½å§¿çŸ©é˜µè½¬æ¢ä¸º 4x4 çš„é½æ¬¡çŸ©é˜µã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> utils.vgg <span class="keyword">import</span> Vgg19</span><br><span class="line"><span class="comment"># ä» utils.vgg æ¨¡å—å¯¼å…¥ Vgg19 ç±»ï¼Œå¯èƒ½ç”¨äºç‰¹å¾æå–ã€‚</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_imgs</span>(<span class="params">image_dir, num_img_to_load, start, end, skip, load_sorted, load_img</span>):</span><br><span class="line">    <span class="comment"># è·å–å›¾åƒç›®å½•ä¸‹æ‰€æœ‰å›¾åƒæ–‡ä»¶åï¼Œå¹¶æŒ‰å­—æ¯é¡ºåºæ’åº</span></span><br><span class="line">    img_names = np.array(<span class="built_in">sorted</span>(os.listdir(image_dir)))  <span class="comment"># all image names</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># åœ¨æ—¶é—´åŸŸä¸Šå¯¹å¸§è¿›è¡Œä¸‹é‡‡æ ·</span></span><br><span class="line">    <span class="keyword">if</span> end == -<span class="number">1</span>:</span><br><span class="line">        img_names = img_names[start::skip]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        img_names = img_names[start:end:skip]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¦‚æœä¸æŒ‰é¡ºåºåŠ è½½å›¾åƒï¼Œåˆ™å¯¹å›¾åƒæ–‡ä»¶åè¿›è¡Œéšæœºæ‰“ä¹±</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> load_sorted:</span><br><span class="line">        np.random.shuffle(img_names)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># åŠ è½½ä¸‹é‡‡æ ·åçš„å›¾åƒ</span></span><br><span class="line">    <span class="keyword">if</span> num_img_to_load &gt; <span class="built_in">len</span>(img_names):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Asked for &#123;0:6d&#125; images but only &#123;1:6d&#125; available. Exit.&#x27;</span>.<span class="built_in">format</span>(num_img_to_load, <span class="built_in">len</span>(img_names)))</span><br><span class="line">        exit()</span><br><span class="line">    <span class="keyword">elif</span> num_img_to_load == -<span class="number">1</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Loading all available &#123;0:6d&#125; images&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">len</span>(img_names)))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Loading &#123;0:6d&#125; images out of &#123;1:6d&#125; images.&#x27;</span>.<span class="built_in">format</span>(num_img_to_load, <span class="built_in">len</span>(img_names)))</span><br><span class="line">        img_names = img_names[:num_img_to_load]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ„å»ºæ¯ä¸ªå›¾åƒçš„å®Œæ•´è·¯å¾„</span></span><br><span class="line">    img_paths = [os.path.join(image_dir, n) <span class="keyword">for</span> n <span class="keyword">in</span> img_names]</span><br><span class="line">    <span class="comment"># å›¾åƒçš„æ•°é‡</span></span><br><span class="line">    N_imgs = <span class="built_in">len</span>(img_paths)</span><br><span class="line"></span><br><span class="line">    img_list = []</span><br><span class="line">    <span class="keyword">if</span> load_img:</span><br><span class="line">        <span class="comment"># ä½¿ç”¨ tqdm æ˜¾ç¤ºåŠ è½½å›¾åƒçš„è¿›åº¦</span></span><br><span class="line">        <span class="keyword">for</span> p <span class="keyword">in</span> tqdm(img_paths):</span><br><span class="line">            <span class="comment"># è¯»å–å›¾åƒå¹¶åªä¿ç•™å‰ä¸‰ä¸ªé€šé“ï¼ˆRGBï¼‰</span></span><br><span class="line">            img = imageio.imread(p)[:, :, :<span class="number">3</span>]  <span class="comment"># (H, W, 3) np.uint8</span></span><br><span class="line">            img_list.append(img)</span><br><span class="line">        <span class="comment"># å°†å›¾åƒåˆ—è¡¨è½¬æ¢ä¸º numpy æ•°ç»„</span></span><br><span class="line">        img_list = np.stack(img_list)  <span class="comment"># (N, H, W, 3)</span></span><br><span class="line">        <span class="comment"># å°† numpy æ•°ç»„è½¬æ¢ä¸º PyTorch å¼ é‡ï¼Œå¹¶å°†åƒç´ å€¼å½’ä¸€åŒ–åˆ° [0, 1] èŒƒå›´</span></span><br><span class="line">        img_list = torch.from_numpy(img_list).<span class="built_in">float</span>() / <span class="number">255</span>  <span class="comment"># (N, H, W, 3) torch.float32</span></span><br><span class="line">        <span class="comment"># è·å–å›¾åƒçš„é«˜åº¦å’Œå®½åº¦</span></span><br><span class="line">        H, W = img_list.shape[<span class="number">1</span>], img_list.shape[<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># å¦‚æœä¸åŠ è½½å›¾åƒï¼Œåˆ™è¯»å–ç¬¬ä¸€å¼ å›¾åƒä»¥è·å–å›¾åƒçš„é«˜åº¦å’Œå®½åº¦</span></span><br><span class="line">        tmp_img = imageio.imread(img_paths[<span class="number">0</span>])  <span class="comment"># load one image to get H, W</span></span><br><span class="line">        H, W = tmp_img.shape[<span class="number">0</span>], tmp_img.shape[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    result = &#123;</span><br><span class="line">        <span class="string">&#x27;imgs&#x27;</span>: img_list,  <span class="comment"># (N, H, W, 3) torch.float32</span></span><br><span class="line">        <span class="string">&#x27;img_names&#x27;</span>: img_names,  <span class="comment"># (N, )</span></span><br><span class="line">        <span class="string">&#x27;N_imgs&#x27;</span>: N_imgs,</span><br><span class="line">        <span class="string">&#x27;H&#x27;</span>: H,</span><br><span class="line">        <span class="string">&#x27;W&#x27;</span>: W,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_meta</span>(<span class="params">in_dir, use_ndc</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Read the poses_bounds.npy file produced by LLFF imgs2poses.py.</span></span><br><span class="line"><span class="string">    This function is modified from https://github.com/kwea123/nerf_pl.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># åŠ è½½ poses_bounds.npy æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶åŒ…å«ç›¸æœºä½å§¿å’Œæ·±åº¦è¾¹ç•Œä¿¡æ¯</span></span><br><span class="line">    poses_bounds = np.load(os.path.join(in_dir, <span class="string">&#x27;../poses_bounds.npy&#x27;</span>))  <span class="comment"># (N_images, 17)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># æå–ç›¸æœºä½å§¿ä¿¡æ¯ï¼Œå°†å…¶é‡å¡‘ä¸º (N_images, 3, 5) çš„å½¢çŠ¶</span></span><br><span class="line">    c2ws = poses_bounds[:, :<span class="number">15</span>].reshape(-<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>)  <span class="comment"># (N_images, 3, 5)</span></span><br><span class="line">    <span class="comment"># æå–æ·±åº¦è¾¹ç•Œä¿¡æ¯</span></span><br><span class="line">    bounds = poses_bounds[:, -<span class="number">2</span>:]  <span class="comment"># (N_images, 2)</span></span><br><span class="line">    <span class="comment"># æå–å›¾åƒé«˜åº¦ã€å®½åº¦å’Œç„¦è·ä¿¡æ¯</span></span><br><span class="line">    H, W, focal = c2ws[<span class="number">0</span>, :, -<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä¿®æ­£ç›¸æœºä½å§¿çš„æ—‹è½¬éƒ¨åˆ†ï¼Œå°†æ—‹è½¬å½¢å¼ä» &quot;down right back&quot; æ”¹ä¸º &quot;right up back&quot;</span></span><br><span class="line">    <span class="comment"># å‚è€ƒ https://github.com/bmild/nerf/issues/34</span></span><br><span class="line">    c2ws = np.concatenate([c2ws[..., <span class="number">1</span>:<span class="number">2</span>], -c2ws[..., :<span class="number">1</span>], c2ws[..., <span class="number">2</span>:<span class="number">4</span>]], -<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¯¹ç›¸æœºä½å§¿è¿›è¡Œä¸­å¿ƒåŒ–å¤„ç†ï¼Œè¿”å›ä¸­å¿ƒåŒ–åçš„ç›¸æœºä½å§¿å’Œå¹³å‡ä½å§¿</span></span><br><span class="line">    <span class="comment"># pose_avg @ c2ws -&gt; centred c2ws</span></span><br><span class="line">    c2ws, pose_avg = center_poses(c2ws)  <span class="comment"># (N_images, 3, 4), (4, 4)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> use_ndc:</span><br><span class="line">        <span class="comment"># ä¿®æ­£å°ºåº¦ï¼Œä½¿æœ€è¿‘çš„æ·±åº¦ç•¥å¤§äº 1.0</span></span><br><span class="line">        <span class="comment"># å‚è€ƒ https://github.com/bmild/nerf/issues/34</span></span><br><span class="line">        near_original = bounds.<span class="built_in">min</span>()</span><br><span class="line">        <span class="comment"># 0.75 æ˜¯é»˜è®¤å‚æ•°</span></span><br><span class="line">        scale_factor = near_original * <span class="number">0.75</span>  </span><br><span class="line">        <span class="comment"># æœ€è¿‘çš„æ·±åº¦çº¦ä¸º 1/0.75 = 1.33</span></span><br><span class="line">        bounds /= scale_factor</span><br><span class="line">        c2ws[..., <span class="number">3</span>] /= scale_factor</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å°† 3x4 çš„ç›¸æœºä½å§¿çŸ©é˜µè½¬æ¢ä¸º 4x4 çš„é½æ¬¡çŸ©é˜µå½¢å¼</span></span><br><span class="line">    c2ws = convert3x4_4x4(c2ws)  <span class="comment"># (N, 4, 4)</span></span><br><span class="line"></span><br><span class="line">    results = &#123;</span><br><span class="line">        <span class="string">&#x27;c2ws&#x27;</span>: c2ws,       <span class="comment"># (N, 4, 4) np</span></span><br><span class="line">        <span class="string">&#x27;bounds&#x27;</span>: bounds,   <span class="comment"># (N_images, 2) np</span></span><br><span class="line">        <span class="string">&#x27;H&#x27;</span>: <span class="built_in">int</span>(H),        <span class="comment"># scalar</span></span><br><span class="line">        <span class="string">&#x27;W&#x27;</span>: <span class="built_in">int</span>(W),        <span class="comment"># scalar</span></span><br><span class="line">        <span class="string">&#x27;focal&#x27;</span>: focal,     <span class="comment"># scalar</span></span><br><span class="line">        <span class="string">&#x27;pose_avg&#x27;</span>: pose_avg,  <span class="comment"># (4, 4) np</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Dataloader_feature_n_colmap</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Most useful fields:</span></span><br><span class="line"><span class="string">        self.c2ws:          (N_imgs, 4, 4)      torch.float32</span></span><br><span class="line"><span class="string">        self.imgs           (N_imgs, H, W, 4)   torch.float32</span></span><br><span class="line"><span class="string">        self.ray_dir_cam    (H, W, 3)           torch.float32</span></span><br><span class="line"><span class="string">        self.H              scalar</span></span><br><span class="line"><span class="string">        self.W              scalar</span></span><br><span class="line"><span class="string">        self.N_imgs         scalar</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, base_dir, scene_name, res_ratio, num_img_to_load, start=<span class="number">0</span>, end=-<span class="number">1</span>, skip=<span class="number">1</span>,</span></span><br><span class="line"><span class="params">                 load_sorted=<span class="literal">True</span>, load_img=<span class="literal">True</span>, use_ndc=<span class="literal">True</span>, device=<span class="string">&#x27;cpu&#x27;</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        :param base_dir: æ•°æ®çš„åŸºç¡€ç›®å½•</span></span><br><span class="line"><span class="string">        :param scene_name: åœºæ™¯çš„åç§°</span></span><br><span class="line"><span class="string">        :param res_ratio: æ•´æ•°ï¼Œå¦‚ [1, 2, 4] ç­‰ï¼Œç”¨äºå°†å›¾åƒè°ƒæ•´ä¸ºè¾ƒä½çš„åˆ†è¾¨ç‡ã€‚</span></span><br><span class="line"><span class="string">        :param start/end/skip: ç”¨äºåœ¨æ—¶é—´åŸŸä¸Šæ§åˆ¶å¸§çš„åŠ è½½ã€‚</span></span><br><span class="line"><span class="string">        :param load_sorted: å¸ƒå°”å€¼ï¼Œæ˜¯å¦æŒ‰é¡ºåºåŠ è½½å›¾åƒã€‚</span></span><br><span class="line"><span class="string">        :param load_img: å¸ƒå°”å€¼ã€‚å¦‚æœè®¾ç½®ä¸º falseï¼šä»…ç»Ÿè®¡å›¾åƒæ•°é‡ã€è·å–å›¾åƒçš„é«˜åº¦å’Œå®½åº¦ï¼Œ</span></span><br><span class="line"><span class="string">                         ä½†ä¸åŠ è½½å›¾åƒã€‚åœ¨å¯è§†åŒ–ä½å§¿æˆ–è°ƒè¯•ç­‰æƒ…å†µä¸‹å¾ˆæœ‰ç”¨ã€‚</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.base_dir = base_dir</span><br><span class="line">        <span class="variable language_">self</span>.scene_name = scene_name</span><br><span class="line">        <span class="variable language_">self</span>.res_ratio = res_ratio</span><br><span class="line">        <span class="variable language_">self</span>.num_img_to_load = num_img_to_load</span><br><span class="line">        <span class="variable language_">self</span>.start = start</span><br><span class="line">        <span class="variable language_">self</span>.end = end</span><br><span class="line">        <span class="variable language_">self</span>.skip = skip</span><br><span class="line">        <span class="variable language_">self</span>.use_ndc = use_ndc</span><br><span class="line">        <span class="variable language_">self</span>.load_sorted = load_sorted</span><br><span class="line">        <span class="variable language_">self</span>.load_img = load_img</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ„å»ºå›¾åƒç›®å½•çš„å®Œæ•´è·¯å¾„</span></span><br><span class="line">        <span class="variable language_">self</span>.imgs_dir = os.path.join(<span class="variable language_">self</span>.base_dir, <span class="variable language_">self</span>.scene_name)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è¯»å–æ‰€æœ‰çš„å…ƒä¿¡æ¯ï¼ŒåŒ…æ‹¬ç›¸æœºä½å§¿ã€æ·±åº¦è¾¹ç•Œã€å›¾åƒå°ºå¯¸å’Œç„¦è·ç­‰</span></span><br><span class="line">        meta = read_meta(<span class="variable language_">self</span>.imgs_dir, <span class="variable language_">self</span>.use_ndc)</span><br><span class="line">        <span class="comment"># æå–ç›¸æœºä½å§¿ä¿¡æ¯å¹¶è½¬æ¢ä¸º PyTorch å¼ é‡</span></span><br><span class="line">        <span class="variable language_">self</span>.c2ws = torch.Tensor(meta[<span class="string">&#x27;c2ws&#x27;</span>])  <span class="comment"># (N, 4, 4) all camera pose</span></span><br><span class="line">        <span class="comment"># æå–ç„¦è·ä¿¡æ¯</span></span><br><span class="line">        <span class="variable language_">self</span>.focal = <span class="built_in">float</span>(meta[<span class="string">&#x27;focal&#x27;</span>])</span><br><span class="line">        <span class="comment"># æ ¹æ® startã€end å’Œ skip å‚æ•°å¯¹ç›¸æœºä½å§¿è¿›è¡Œç­›é€‰</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.end == -<span class="number">1</span>:</span><br><span class="line">            <span class="variable language_">self</span>.c2ws = <span class="variable language_">self</span>.c2ws[<span class="variable language_">self</span>.start::<span class="variable language_">self</span>.skip]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="variable language_">self</span>.c2ws = <span class="variable language_">self</span>.c2ws[<span class="variable language_">self</span>.start:<span class="variable language_">self</span>.end:<span class="variable language_">self</span>.skip]</span><br><span class="line">        <span class="comment"># åŠ è½½å›¾åƒæ•°æ®</span></span><br><span class="line">        image_data = load_imgs(<span class="variable language_">self</span>.imgs_dir, <span class="variable language_">self</span>.num_img_to_load, <span class="variable language_">self</span>.start, <span class="variable language_">self</span>.end, <span class="variable language_">self</span>.skip,</span><br><span class="line">                                <span class="variable language_">self</span>.load_sorted, <span class="variable language_">self</span>.load_img)</span><br><span class="line">        <span class="comment"># æå–åŠ è½½çš„å›¾åƒæ•°æ®</span></span><br><span class="line">        <span class="variable language_">self</span>.imgs = image_data[<span class="string">&#x27;imgs&#x27;</span>]  <span class="comment"># (N, H, W, 3) torch.float32</span></span><br><span class="line">        <span class="comment"># æå–å›¾åƒæ–‡ä»¶å</span></span><br><span class="line">        <span class="variable language_">self</span>.img_names = image_data[<span class="string">&#x27;img_names&#x27;</span>]  <span class="comment"># (N, )</span></span><br><span class="line">        <span class="comment"># å›¾åƒçš„æ•°é‡</span></span><br><span class="line">        <span class="variable language_">self</span>.N_imgs = image_data[<span class="string">&#x27;N_imgs&#x27;</span>]</span><br><span class="line">        <span class="comment"># åŸå§‹å›¾åƒçš„é«˜åº¦</span></span><br><span class="line">        <span class="variable language_">self</span>.ori_H = image_data[<span class="string">&#x27;H&#x27;</span>]</span><br><span class="line">        <span class="comment"># åŸå§‹å›¾åƒçš„å®½åº¦</span></span><br><span class="line">        <span class="variable language_">self</span>.ori_W = image_data[<span class="string">&#x27;W&#x27;</span>]</span><br><span class="line">        <span class="comment"># åˆå§‹åŒ– Vgg19 ç¼–ç å™¨å¹¶å°†å…¶ç§»åŠ¨åˆ°æŒ‡å®šè®¾å¤‡</span></span><br><span class="line">        <span class="variable language_">self</span>.encoder = Vgg19().to(device)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å§‹ç»ˆä½¿ç”¨å½’ä¸€åŒ–è®¾å¤‡åæ ‡ï¼ˆNDCï¼‰</span></span><br><span class="line">        <span class="variable language_">self</span>.near = <span class="number">0.0</span></span><br><span class="line">        <span class="variable language_">self</span>.far = <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># å¦‚æœéœ€è¦è°ƒæ•´å›¾åƒåˆ†è¾¨ç‡</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.res_ratio &gt; <span class="number">1</span>:</span><br><span class="line">            <span class="comment"># è®¡ç®—è°ƒæ•´åçš„å›¾åƒé«˜åº¦</span></span><br><span class="line">            <span class="variable language_">self</span>.H = <span class="variable language_">self</span>.ori_H // <span class="variable language_">self</span>.res_ratio</span><br><span class="line">            <span class="comment"># è®¡ç®—è°ƒæ•´åçš„å›¾åƒå®½åº¦</span></span><br><span class="line">            <span class="variable language_">self</span>.W = <span class="variable language_">self</span>.ori_W // <span class="variable language_">self</span>.res_ratio</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="variable language_">self</span>.H = <span class="variable language_">self</span>.ori_H</span><br><span class="line">            <span class="variable language_">self</span>.W = <span class="variable language_">self</span>.ori_W</span><br><span class="line">        <span class="comment"># è°ƒæ•´ç„¦è·</span></span><br><span class="line">        <span class="variable language_">self</span>.focal /= <span class="variable language_">self</span>.res_ratio</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.load_img:</span><br><span class="line">            <span class="comment"># è°ƒæ•´å›¾åƒçš„åˆ†è¾¨ç‡å¹¶å°†å…¶ç§»åŠ¨åˆ°æŒ‡å®šè®¾å¤‡</span></span><br><span class="line">            <span class="variable language_">self</span>.imgs = resize_imgs(<span class="variable language_">self</span>.imgs, <span class="variable language_">self</span>.H, <span class="variable language_">self</span>.W).to(device)  <span class="comment"># (N, H, W, 3) torch.float32</span></span><br><span class="line">            <span class="variable language_">self</span>.features = []</span><br><span class="line">            <span class="comment"># ä½¿ç”¨ tqdm æ˜¾ç¤ºå¤„ç†è¿›åº¦</span></span><br><span class="line">            <span class="keyword">for</span> img <span class="keyword">in</span> tqdm(<span class="variable language_">self</span>.imgs):</span><br><span class="line">                <span class="comment"># å¯¹å›¾åƒè¿›è¡Œé€šé“ç»´åº¦çš„è°ƒæ•´ï¼Œå¹¶é€šè¿‡ç¼–ç å™¨æå–ç‰¹å¾</span></span><br><span class="line">                <span class="variable language_">self</span>.features.append(<span class="variable language_">self</span>.encoder(img.permute(<span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>)[<span class="literal">None</span>, ...]))</span><br><span class="line">            <span class="comment"># è¿™é‡Œæ³¨é‡Šæ‰äº†ç‰¹å¾æ‹¼æ¥çš„ä»£ç ï¼Œå¯æ ¹æ®éœ€è¦å–æ¶ˆæ³¨é‡Š</span></span><br><span class="line">            <span class="comment"># self.features = torch.cat(self.features, 0)</span></span><br><span class="line">            <span class="comment"># print(self.features.shape)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># æ•°æ®çš„åŸºç¡€ç›®å½•ï¼Œéœ€è¦æ›¿æ¢ä¸ºå®é™…çš„è·¯å¾„</span></span><br><span class="line">    base_dir = <span class="string">&#x27;/your/data/path&#x27;</span></span><br><span class="line">    <span class="comment"># åœºæ™¯çš„åç§°</span></span><br><span class="line">    scene_name = <span class="string">&#x27;LLFF/fern/images&#x27;</span></span><br><span class="line">    <span class="comment"># å›¾åƒçš„ç¼©æ”¾æ¯”ä¾‹</span></span><br><span class="line">    resize_ratio = <span class="number">8</span></span><br><span class="line">    <span class="comment"># è¦åŠ è½½çš„å›¾åƒæ•°é‡ï¼Œ-1 è¡¨ç¤ºåŠ è½½æ‰€æœ‰å›¾åƒ</span></span><br><span class="line">    num_img_to_load = -<span class="number">1</span></span><br><span class="line">    <span class="comment"># å¼€å§‹åŠ è½½å›¾åƒçš„ç´¢å¼•</span></span><br><span class="line">    start = <span class="number">0</span></span><br><span class="line">    <span class="comment"># ç»“æŸåŠ è½½å›¾åƒçš„ç´¢å¼•ï¼Œ-1 è¡¨ç¤ºåŠ è½½åˆ°æœ€å</span></span><br><span class="line">    end = -<span class="number">1</span></span><br><span class="line">    <span class="comment"># åŠ è½½å›¾åƒçš„é—´éš”</span></span><br><span class="line">    skip = <span class="number">1</span></span><br><span class="line">    <span class="comment"># æ˜¯å¦æŒ‰é¡ºåºåŠ è½½å›¾åƒ</span></span><br><span class="line">    load_sorted = <span class="literal">True</span></span><br><span class="line">    <span class="comment"># æ˜¯å¦åŠ è½½å›¾åƒ</span></span><br><span class="line">    load_img = <span class="literal">True</span></span><br><span class="line">    <span class="comment"># æ˜¯å¦ä½¿ç”¨å½’ä¸€åŒ–è®¾å¤‡åæ ‡ï¼ˆNDCï¼‰</span></span><br><span class="line">    use_ndc = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># åˆå§‹åŒ– Dataloader_feature_n_colmap ç±»</span></span><br><span class="line">    scene = Dataloader_feature_n_colmap(base_dir=base_dir,</span><br><span class="line">                                scene_name=scene_name,</span><br><span class="line">                                res_ratio=resize_ratio,</span><br><span class="line">                                num_img_to_load=num_img_to_load,</span><br><span class="line">                                start=start,</span><br><span class="line">                                end=end,</span><br><span class="line">                                skip=skip,</span><br><span class="line">                                load_sorted=load_sorted,</span><br><span class="line">                                load_img=load_img,</span><br><span class="line">                                use_ndc=use_ndc)</span><br></pre></td></tr></table></figure>
<h4 id="with-feature-py">with_feature.py</h4>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="comment"># os æ¨¡å—æä¾›äº†ä¸æ“ä½œç³»ç»Ÿè¿›è¡Œäº¤äº’çš„åŠŸèƒ½ï¼Œ</span></span><br><span class="line"><span class="comment"># å¯ç”¨äºå¤„ç†æ–‡ä»¶å’Œç›®å½•è·¯å¾„ã€åˆ›å»º/åˆ é™¤ç›®å½•ã€è·å–ç¯å¢ƒå˜é‡ç­‰ï¼Œ</span></span><br><span class="line"><span class="comment"># åœ¨æœ¬ä»£ç é‡Œä¸»è¦ç”¨äºæ„å»ºæ–‡ä»¶å’Œç›®å½•çš„è·¯å¾„ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="comment"># torch æ˜¯ PyTorch çš„æ ¸å¿ƒåº“ï¼Œæä¾›äº†å¼ é‡ï¼ˆTensorï¼‰æ•°æ®ç»“æ„ï¼Œ</span></span><br><span class="line"><span class="comment"># æ”¯æŒè‡ªåŠ¨æ±‚å¯¼æœºåˆ¶ï¼Œç”¨äºæ„å»ºå’Œè®­ç»ƒæ·±åº¦å­¦ä¹ æ¨¡å‹ï¼Œ</span></span><br><span class="line"><span class="comment"># èƒ½å¤Ÿåœ¨ CPU æˆ– GPU ä¸Šé«˜æ•ˆåœ°è¿›è¡Œæ•°å€¼è®¡ç®—ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"><span class="comment"># torch.nn.functional æä¾›äº†è®¸å¤šç¥ç»ç½‘ç»œä¸­å¸¸ç”¨çš„å‡½æ•°ï¼Œ</span></span><br><span class="line"><span class="comment"># ä¾‹å¦‚æ¿€æ´»å‡½æ•°ã€æŸå¤±å‡½æ•°ã€å·ç§¯ã€æ± åŒ–ç­‰æ“ä½œï¼Œ</span></span><br><span class="line"><span class="comment"># è¿™äº›å‡½æ•°æ˜¯æ— çŠ¶æ€çš„ï¼Œé€šå¸¸ç”¨äºè‡ªå®šä¹‰ç¥ç»ç½‘ç»œå±‚ä¸­çš„å…·ä½“è¿ç®—ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="comment"># numpy æ˜¯ Python ä¸­ç”¨äºç§‘å­¦è®¡ç®—çš„åŸºç¡€åº“ï¼Œ</span></span><br><span class="line"><span class="comment"># æä¾›äº†é«˜æ•ˆçš„å¤šç»´æ•°ç»„å¯¹è±¡å’Œå„ç§æ•°å­¦å‡½æ•°ï¼Œ</span></span><br><span class="line"><span class="comment"># å¯è¿›è¡Œæ•°ç»„æ“ä½œã€çº¿æ€§ä»£æ•°è¿ç®—ã€éšæœºæ•°ç”Ÿæˆç­‰ï¼Œ</span></span><br><span class="line"><span class="comment"># åœ¨ä»£ç ä¸­ä¸»è¦ç”¨äºå¤„ç†å›¾åƒæ•°æ®å’Œæ•°ç»„æ“ä½œã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="comment"># tqdm æ˜¯ä¸€ä¸ªå¿«é€Ÿã€å¯æ‰©å±•çš„è¿›åº¦æ¡å·¥å…·ï¼Œ</span></span><br><span class="line"><span class="comment"># èƒ½åœ¨å¾ªç¯ä¸­æ˜¾ç¤ºè¿›åº¦æ¡ï¼Œæ–¹ä¾¿ç”¨æˆ·äº†è§£ä»£ç æ‰§è¡Œçš„è¿›åº¦ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> imageio</span><br><span class="line"><span class="comment"># imageio æ˜¯ä¸€ä¸ªç”¨äºè¯»å–å’Œå†™å…¥å¤šç§å›¾åƒæ–‡ä»¶æ ¼å¼çš„åº“ï¼Œ</span></span><br><span class="line"><span class="comment"># åœ¨ä»£ç ä¸­ä¸»è¦ç”¨äºè¯»å–å›¾åƒæ–‡ä»¶ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> utils.comp_ray_dir <span class="keyword">import</span> comp_ray_dir_cam</span><br><span class="line"><span class="comment"># ä» utils åŒ…ä¸­çš„ comp_ray_dir æ¨¡å—å¯¼å…¥ comp_ray_dir_cam å‡½æ•°ï¼Œ</span></span><br><span class="line"><span class="comment"># æ¨æµ‹è¯¥å‡½æ•°ç”¨äºè®¡ç®—ç›¸æœºåæ ‡ç³»ä¸‹çš„å…‰çº¿æ–¹å‘ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> utils.pose_utils <span class="keyword">import</span> center_poses</span><br><span class="line"><span class="comment"># ä» utils åŒ…ä¸­çš„ pose_utils æ¨¡å—å¯¼å…¥ center_poses å‡½æ•°ï¼Œ</span></span><br><span class="line"><span class="comment"># æ¨æµ‹è¯¥å‡½æ•°ç”¨äºå¯¹ç›¸æœºä½å§¿è¿›è¡Œä¸­å¿ƒåŒ–å¤„ç†ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> utils.lie_group_helper <span class="keyword">import</span> convert3x4_4x4</span><br><span class="line"><span class="comment"># ä» utils åŒ…ä¸­çš„ lie_group_helper æ¨¡å—å¯¼å…¥ convert3x4_4x4 å‡½æ•°ï¼Œ</span></span><br><span class="line"><span class="comment"># æ¨æµ‹è¯¥å‡½æ•°ç”¨äºå°† 3x4 çš„ç›¸æœºä½å§¿çŸ©é˜µè½¬æ¢ä¸º 4x4 çš„é½æ¬¡çŸ©é˜µã€‚</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">resize_imgs</span>(<span class="params">imgs, new_h, new_w</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    :param imgs:    (N, H, W, 3)            torch.float32 æ ¼å¼çš„ RGB å›¾åƒ</span></span><br><span class="line"><span class="string">    :param new_h:   æ•´æ•°æˆ– torch æ•´æ•°ç±»å‹ï¼Œè¡¨ç¤ºæ–°çš„å›¾åƒé«˜åº¦</span></span><br><span class="line"><span class="string">    :param new_w:   æ•´æ•°æˆ– torch æ•´æ•°ç±»å‹ï¼Œè¡¨ç¤ºæ–°çš„å›¾åƒå®½åº¦</span></span><br><span class="line"><span class="string">    :return:        (N, new_H, new_W, 3)    torch.float32 æ ¼å¼çš„ RGB å›¾åƒ</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># å°†å›¾åƒå¼ é‡çš„ç»´åº¦ä» (N, H, W, 3) è°ƒæ•´ä¸º (N, 3, H, W)ï¼Œä»¥é€‚é… F.interpolate å‡½æ•°çš„è¾“å…¥è¦æ±‚</span></span><br><span class="line">    imgs = imgs.permute(<span class="number">0</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">2</span>)  <span class="comment"># å˜ä¸º (N, 3, H, W)</span></span><br><span class="line">    <span class="comment"># ä½¿ç”¨åŒçº¿æ€§æ’å€¼æ–¹æ³•å°†å›¾åƒè°ƒæ•´åˆ°æŒ‡å®šçš„æ–°é«˜åº¦å’Œæ–°å®½åº¦</span></span><br><span class="line">    imgs = F.interpolate(imgs, size=(new_h, new_w), mode=<span class="string">&#x27;bilinear&#x27;</span>)  <span class="comment"># å˜ä¸º (N, 3, new_H, new_W)</span></span><br><span class="line">    <span class="comment"># å°†å›¾åƒå¼ é‡çš„ç»´åº¦ä» (N, 3, new_H, new_W) è°ƒæ•´å› (N, new_H, new_W, 3)</span></span><br><span class="line">    imgs = imgs.permute(<span class="number">0</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>)  <span class="comment"># å˜ä¸º (N, new_H, new_W, 3)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> imgs  <span class="comment"># è¿”å› (N, new_H, new_W, 3) æ ¼å¼çš„ torch.float32 ç±»å‹ RGB å›¾åƒ</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_imgs</span>(<span class="params">image_dir, img_ids, new_h, new_w</span>):</span><br><span class="line">    <span class="comment"># è·å–å›¾åƒç›®å½•ä¸‹æ‰€æœ‰å›¾åƒæ–‡ä»¶åï¼Œå¹¶æŒ‰å­—æ¯é¡ºåºæ’åº</span></span><br><span class="line">    img_names = np.array(<span class="built_in">sorted</span>(os.listdir(image_dir)))  <span class="comment"># å¾—åˆ°æ‰€æœ‰å›¾åƒæ–‡ä»¶å</span></span><br><span class="line">    <span class="comment"># æ ¹æ®ç»™å®šçš„å›¾åƒç´¢å¼•ç­›é€‰å‡ºæœ¬æ¬¡éœ€è¦çš„å›¾åƒæ–‡ä»¶å</span></span><br><span class="line">    img_names = img_names[img_ids]  <span class="comment"># å¾—åˆ°æœ¬æ¬¡åˆ†å‰²æ‰€éœ€çš„å›¾åƒæ–‡ä»¶å</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ„å»ºæ¯ä¸ªå›¾åƒçš„å®Œæ•´è·¯å¾„</span></span><br><span class="line">    img_paths = [os.path.join(image_dir, n) <span class="keyword">for</span> n <span class="keyword">in</span> img_names]</span><br><span class="line"></span><br><span class="line">    img_list = []</span><br><span class="line">    <span class="comment"># ä½¿ç”¨ tqdm æ˜¾ç¤ºåŠ è½½å›¾åƒçš„è¿›åº¦</span></span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> tqdm(img_paths):</span><br><span class="line">        <span class="comment"># è¯»å–å›¾åƒå¹¶åªä¿ç•™å‰ä¸‰ä¸ªé€šé“ï¼ˆRGBï¼‰</span></span><br><span class="line">        img = imageio.imread(p)[:, :, :<span class="number">3</span>]  <span class="comment"># å¾—åˆ° (H, W, 3) æ ¼å¼çš„ np.uint8 ç±»å‹å›¾åƒ</span></span><br><span class="line">        img_list.append(img)</span><br><span class="line">    <span class="comment"># å°†å›¾åƒåˆ—è¡¨è½¬æ¢ä¸º numpy æ•°ç»„</span></span><br><span class="line">    img_list = np.stack(img_list)  <span class="comment"># å˜ä¸º (N, H, W, 3) æ ¼å¼</span></span><br><span class="line">    <span class="comment"># å°† numpy æ•°ç»„è½¬æ¢ä¸º PyTorch å¼ é‡ï¼Œå¹¶å°†åƒç´ å€¼å½’ä¸€åŒ–åˆ° [0, 1] èŒƒå›´</span></span><br><span class="line">    img_list = torch.from_numpy(img_list).<span class="built_in">float</span>() / <span class="number">255</span>  <span class="comment"># å˜ä¸º (N, H, W, 3) æ ¼å¼çš„ torch.float32 ç±»å‹</span></span><br><span class="line">    <span class="comment"># è°ƒç”¨ resize_imgs å‡½æ•°å°†å›¾åƒè°ƒæ•´åˆ°æŒ‡å®šçš„æ–°é«˜åº¦å’Œæ–°å®½åº¦</span></span><br><span class="line">    img_list = resize_imgs(img_list, new_h, new_w)</span><br><span class="line">    <span class="keyword">return</span> img_list, img_names</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_meta</span>(<span class="params">in_dir, use_ndc</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    è¯»å–ç”± LLFF çš„ imgs2poses.py ç”Ÿæˆçš„ poses_bounds.npy æ–‡ä»¶ã€‚</span></span><br><span class="line"><span class="string">    æ­¤å‡½æ•°æ”¹ç¼–è‡ª https://github.com/kwea123/nerf_plã€‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># åŠ è½½ poses_bounds.npy æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶åŒ…å«ç›¸æœºä½å§¿å’Œæ·±åº¦è¾¹ç•Œä¿¡æ¯</span></span><br><span class="line">    poses_bounds = np.load(os.path.join(in_dir, <span class="string">&#x27;poses_bounds.npy&#x27;</span>))  <span class="comment"># å¾—åˆ° (N_images, 17) æ ¼å¼çš„æ•°ç»„</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># æå–ç›¸æœºä½å§¿ä¿¡æ¯ï¼Œå°†å…¶é‡å¡‘ä¸º (N_images, 3, 5) çš„å½¢çŠ¶</span></span><br><span class="line">    c2ws = poses_bounds[:, :<span class="number">15</span>].reshape(-<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>)  <span class="comment"># å˜ä¸º (N_images, 3, 5) æ ¼å¼</span></span><br><span class="line">    <span class="comment"># æå–æ·±åº¦è¾¹ç•Œä¿¡æ¯</span></span><br><span class="line">    bounds = poses_bounds[:, -<span class="number">2</span>:]  <span class="comment"># å˜ä¸º (N_images, 2) æ ¼å¼</span></span><br><span class="line">    <span class="comment"># æå–å›¾åƒé«˜åº¦ã€å®½åº¦å’Œç„¦è·ä¿¡æ¯</span></span><br><span class="line">    H, W, focal = c2ws[<span class="number">0</span>, :, -<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä¿®æ­£ç›¸æœºä½å§¿çš„æ—‹è½¬éƒ¨åˆ†ï¼Œå°†æ—‹è½¬å½¢å¼ä» &quot;ä¸‹ å³ å&quot; æ”¹ä¸º &quot;å³ ä¸Š å&quot;</span></span><br><span class="line">    <span class="comment"># å‚è€ƒ https://github.com/bmild/nerf/issues/34</span></span><br><span class="line">    c2ws = np.concatenate([c2ws[..., <span class="number">1</span>:<span class="number">2</span>], -c2ws[..., :<span class="number">1</span>], c2ws[..., <span class="number">2</span>:<span class="number">4</span>]], -<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¯¹ç›¸æœºä½å§¿è¿›è¡Œä¸­å¿ƒåŒ–å¤„ç†ï¼Œè¿”å›ä¸­å¿ƒåŒ–åçš„ç›¸æœºä½å§¿å’Œå¹³å‡ä½å§¿</span></span><br><span class="line">    <span class="comment"># pose_avg @ c2ws å¾—åˆ°ä¸­å¿ƒåŒ–åçš„ c2ws</span></span><br><span class="line">    c2ws, pose_avg = center_poses(c2ws)  <span class="comment"># åˆ†åˆ«å¾—åˆ° (N_images, 3, 4) å’Œ (4, 4) æ ¼å¼çš„æ•°ç»„</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> use_ndc:</span><br><span class="line">        <span class="comment"># è·å–æœ€è¿‘æ·±åº¦å€¼</span></span><br><span class="line">        near_original = bounds.<span class="built_in">min</span>()</span><br><span class="line">        <span class="comment"># è®¡ç®—ç¼©æ”¾å› å­ï¼Œä½¿æœ€è¿‘æ·±åº¦è°ƒæ•´åˆ°ç¨å¤§äº 1.0 çš„ä½ç½®</span></span><br><span class="line">        scale_factor = near_original * <span class="number">0.75</span>  <span class="comment"># 0.75 æ˜¯é»˜è®¤å‚æ•°</span></span><br><span class="line">        <span class="comment"># ç°åœ¨æœ€è¿‘æ·±åº¦çº¦ä¸º 1/0.75 = 1.33</span></span><br><span class="line">        <span class="comment"># å¯¹æ·±åº¦è¾¹ç•Œè¿›è¡Œç¼©æ”¾</span></span><br><span class="line">        bounds /= scale_factor</span><br><span class="line">        <span class="comment"># å¯¹ç›¸æœºä½å§¿çš„å¹³ç§»éƒ¨åˆ†è¿›è¡Œç¼©æ”¾</span></span><br><span class="line">        c2ws[..., <span class="number">3</span>] /= scale_factor</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å°† 3x4 çš„ç›¸æœºä½å§¿çŸ©é˜µè½¬æ¢ä¸º 4x4 çš„é½æ¬¡çŸ©é˜µå½¢å¼</span></span><br><span class="line">    c2ws = convert3x4_4x4(c2ws)  <span class="comment"># å˜ä¸º (N, 4, 4) æ ¼å¼</span></span><br><span class="line"></span><br><span class="line">    results = &#123;</span><br><span class="line">        <span class="string">&#x27;c2ws&#x27;</span>: c2ws,       <span class="comment"># (N, 4, 4) æ ¼å¼çš„ numpy æ•°ç»„</span></span><br><span class="line">        <span class="string">&#x27;bounds&#x27;</span>: bounds,   <span class="comment"># (N_images, 2) æ ¼å¼çš„ numpy æ•°ç»„</span></span><br><span class="line">        <span class="string">&#x27;H&#x27;</span>: <span class="built_in">int</span>(H),        <span class="comment"># æ ‡é‡ï¼Œå›¾åƒé«˜åº¦</span></span><br><span class="line">        <span class="string">&#x27;W&#x27;</span>: <span class="built_in">int</span>(W),        <span class="comment"># æ ‡é‡ï¼Œå›¾åƒå®½åº¦</span></span><br><span class="line">        <span class="string">&#x27;focal&#x27;</span>: focal,     <span class="comment"># æ ‡é‡ï¼Œç„¦è·</span></span><br><span class="line">        <span class="string">&#x27;pose_avg&#x27;</span>: pose_avg,  <span class="comment"># (4, 4) æ ¼å¼çš„ numpy æ•°ç»„</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DataLoaderWithCOLMAP</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    æœ€æœ‰ç”¨çš„å­—æ®µï¼š</span></span><br><span class="line"><span class="string">        self.c2ws:          (N_imgs, 4, 4) æ ¼å¼çš„ torch.float32 ç±»å‹å¼ é‡ï¼Œè¡¨ç¤ºç›¸æœºä½å§¿</span></span><br><span class="line"><span class="string">        self.imgs           (N_imgs, H, W, 4) æ ¼å¼çš„ torch.float32 ç±»å‹å¼ é‡ï¼Œè¡¨ç¤ºå›¾åƒ</span></span><br><span class="line"><span class="string">        self.ray_dir_cam    (H, W, 3) æ ¼å¼çš„ torch.float32 ç±»å‹å¼ é‡ï¼Œè¡¨ç¤ºç›¸æœºåæ ‡ç³»ä¸‹çš„å…‰çº¿æ–¹å‘</span></span><br><span class="line"><span class="string">        self.H              æ ‡é‡ï¼Œå›¾åƒé«˜åº¦</span></span><br><span class="line"><span class="string">        self.W              æ ‡é‡ï¼Œå›¾åƒå®½åº¦</span></span><br><span class="line"><span class="string">        self.N_imgs         æ ‡é‡ï¼Œå›¾åƒæ•°é‡</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, base_dir, scene_name, data_type, res_ratio, num_img_to_load, skip, use_ndc, load_img=<span class="literal">True</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        :param base_dir: æ•°æ®çš„åŸºç¡€ç›®å½•</span></span><br><span class="line"><span class="string">        :param scene_name: åœºæ™¯çš„åç§°</span></span><br><span class="line"><span class="string">        :param data_type: æ•°æ®ç±»å‹ï¼Œ&#x27;train&#x27; æˆ– &#x27;val&#x27;ã€‚</span></span><br><span class="line"><span class="string">        :param res_ratio: æ•´æ•°ï¼Œå¦‚ [1, 2, 4] ç­‰ï¼Œç”¨äºå°†å›¾åƒè°ƒæ•´ä¸ºè¾ƒä½çš„åˆ†è¾¨ç‡ã€‚</span></span><br><span class="line"><span class="string">        :param num_img_to_load/skip: ç”¨äºåœ¨æ—¶é—´åŸŸä¸Šæ§åˆ¶å¸§çš„åŠ è½½ã€‚</span></span><br><span class="line"><span class="string">        :param use_ndc: å¸ƒå°”å€¼ï¼Œæ˜¯å¦å¯¹ç›¸æœºä½å§¿è¿›è¡Œä¸­å¿ƒåŒ–å’Œç¼©æ”¾ã€‚</span></span><br><span class="line"><span class="string">        :param load_img: å¸ƒå°”å€¼ã€‚å¦‚æœè®¾ç½®ä¸º Falseï¼šä»…ç»Ÿè®¡å›¾åƒæ•°é‡ã€è·å–å›¾åƒçš„é«˜åº¦å’Œå®½åº¦ï¼Œ</span></span><br><span class="line"><span class="string">                         ä½†ä¸åŠ è½½å›¾åƒã€‚åœ¨å¯è§†åŒ–ä½å§¿æˆ–è°ƒè¯•ç­‰æƒ…å†µä¸‹å¾ˆæœ‰ç”¨ã€‚</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.base_dir = base_dir</span><br><span class="line">        <span class="variable language_">self</span>.scene_name = scene_name</span><br><span class="line">        <span class="variable language_">self</span>.data_type = data_type</span><br><span class="line">        <span class="variable language_">self</span>.res_ratio = res_ratio</span><br><span class="line">        <span class="variable language_">self</span>.num_img_to_load = num_img_to_load</span><br><span class="line">        <span class="variable language_">self</span>.skip = skip</span><br><span class="line">        <span class="variable language_">self</span>.use_ndc = use_ndc</span><br><span class="line">        <span class="variable language_">self</span>.load_img = load_img</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ„å»ºåœºæ™¯ç›®å½•çš„å®Œæ•´è·¯å¾„</span></span><br><span class="line">        <span class="variable language_">self</span>.scene_dir = os.path.join(<span class="variable language_">self</span>.base_dir, <span class="variable language_">self</span>.scene_name)</span><br><span class="line">        <span class="comment"># æ„å»ºå›¾åƒç›®å½•çš„å®Œæ•´è·¯å¾„</span></span><br><span class="line">        <span class="variable language_">self</span>.img_dir = os.path.join(<span class="variable language_">self</span>.scene_dir, <span class="string">&#x27;images&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è¯»å–æ‰€æœ‰çš„å…ƒä¿¡æ¯ï¼ŒåŒ…æ‹¬ç›¸æœºä½å§¿ã€æ·±åº¦è¾¹ç•Œã€å›¾åƒå°ºå¯¸å’Œç„¦è·ç­‰</span></span><br><span class="line">        meta = read_meta(<span class="variable language_">self</span>.scene_dir, <span class="variable language_">self</span>.use_ndc)</span><br><span class="line">        <span class="comment"># æå–ç›¸æœºä½å§¿ä¿¡æ¯</span></span><br><span class="line">        <span class="variable language_">self</span>.c2ws = meta[<span class="string">&#x27;c2ws&#x27;</span>]  <span class="comment"># (N, 4, 4) æ ¼å¼çš„ numpy æ•°ç»„ï¼Œè¡¨ç¤ºæ‰€æœ‰ç›¸æœºä½å§¿</span></span><br><span class="line">        <span class="comment"># æå–å›¾åƒé«˜åº¦ä¿¡æ¯</span></span><br><span class="line">        <span class="variable language_">self</span>.H = meta[<span class="string">&#x27;H&#x27;</span>]</span><br><span class="line">        <span class="comment"># æå–å›¾åƒå®½åº¦ä¿¡æ¯</span></span><br><span class="line">        <span class="variable language_">self</span>.W = meta[<span class="string">&#x27;W&#x27;</span>]</span><br><span class="line">        <span class="comment"># æå–ç„¦è·ä¿¡æ¯</span></span><br><span class="line">        <span class="variable language_">self</span>.focal = <span class="built_in">float</span>(meta[<span class="string">&#x27;focal&#x27;</span>])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.res_ratio &gt; <span class="number">1</span>:</span><br><span class="line">            <span class="comment"># å¦‚æœéœ€è¦è°ƒæ•´å›¾åƒåˆ†è¾¨ç‡ï¼Œå¯¹å›¾åƒé«˜åº¦è¿›è¡Œç›¸åº”çš„ç¼©æ”¾</span></span><br><span class="line">            <span class="variable language_">self</span>.H = <span class="variable language_">self</span>.H // <span class="variable language_">self</span>.res_ratio</span><br><span class="line">            <span class="comment"># å¦‚æœéœ€è¦è°ƒæ•´å›¾åƒåˆ†è¾¨ç‡ï¼Œå¯¹å›¾åƒå®½åº¦è¿›è¡Œç›¸åº”çš„ç¼©æ”¾</span></span><br><span class="line">            <span class="variable language_">self</span>.W = <span class="variable language_">self</span>.W // <span class="variable language_">self</span>.res_ratio</span><br><span class="line">            <span class="comment"># å¦‚æœéœ€è¦è°ƒæ•´å›¾åƒåˆ†è¾¨ç‡ï¼Œå¯¹ç„¦è·è¿›è¡Œç›¸åº”çš„ç¼©æ”¾</span></span><br><span class="line">            <span class="variable language_">self</span>.focal /= <span class="variable language_">self</span>.res_ratio</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è¿‘è£å‰ªå¹³é¢è·ç¦»</span></span><br><span class="line">        <span class="variable language_">self</span>.near = <span class="number">0.0</span></span><br><span class="line">        <span class="comment"># è¿œè£å‰ªå¹³é¢è·ç¦»</span></span><br><span class="line">        <span class="variable language_">self</span>.far = <span class="number">1.0</span></span><br><span class="line">        <span class="comment"># åŠ è½½å›¾åƒå¹¶è°ƒæ•´åˆ°æŒ‡å®šçš„é«˜åº¦å’Œå®½åº¦</span></span><br><span class="line">        <span class="variable language_">self</span>.imgs, <span class="variable language_">self</span>.img_names = load_imgs(<span class="variable language_">self</span>.img_dir, np.arange(num_img_to_load), <span class="variable language_">self</span>.H, <span class="variable language_">self</span>.W)  <span class="comment"># (N, H, W, 3) æ ¼å¼çš„ torch.float32 ç±»å‹å¼ é‡</span></span><br><span class="line">        <span class="comment"># æˆªå–å‰ num_img_to_load ä¸ªç›¸æœºä½å§¿</span></span><br><span class="line">        <span class="variable language_">self</span>.c2ws = <span class="variable language_">self</span>.c2ws[:num_img_to_load]</span><br><span class="line">        <span class="comment"># å›¾åƒçš„æ•°é‡</span></span><br><span class="line">        <span class="variable language_">self</span>.N_imgs = <span class="variable language_">self</span>.c2ws.shape[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ç”Ÿæˆç›¸æœºåæ ‡ç³»ä¸‹çš„å…‰çº¿æ–¹å‘</span></span><br><span class="line">        <span class="variable language_">self</span>.ray_dir_cam = comp_ray_dir_cam(<span class="variable language_">self</span>.H, <span class="variable language_">self</span>.W, <span class="variable language_">self</span>.focal)  <span class="comment"># (H, W, 3) æ ¼å¼çš„ torch.float32 ç±»å‹å¼ é‡</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># å°†ç›¸æœºä½å§¿ä» numpy æ•°ç»„è½¬æ¢ä¸º PyTorch å¼ é‡</span></span><br><span class="line">        <span class="variable language_">self</span>.c2ws = torch.from_numpy(<span class="variable language_">self</span>.c2ws).<span class="built_in">float</span>()  <span class="comment"># (N, 4, 4) æ ¼å¼çš„ torch.float32 ç±»å‹å¼ é‡</span></span><br><span class="line">        <span class="comment"># å°†å…‰çº¿æ–¹å‘å¼ é‡è½¬æ¢ä¸º float32 ç±»å‹</span></span><br><span class="line">        <span class="variable language_">self</span>.ray_dir_cam = <span class="variable language_">self</span>.ray_dir_cam.<span class="built_in">float</span>()  <span class="comment"># (H, W, 3) æ ¼å¼çš„ torch.float32 ç±»å‹å¼ é‡</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    scene_name = <span class="string">&#x27;LLFF/fern&#x27;</span></span><br><span class="line">    use_ndc = <span class="literal">True</span></span><br><span class="line">    <span class="comment"># æ³¨æ„ï¼šéœ€è¦å°† /your/data/path æ›¿æ¢ä¸ºå®é™…çš„æ•°æ®è·¯å¾„ï¼Œ</span></span><br><span class="line">    <span class="comment"># è¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ª DataLoaderWithCOLMAP ç±»çš„å®ä¾‹ï¼Œç”¨äºåŠ è½½æŒ‡å®šåœºæ™¯çš„æ•°æ®</span></span><br><span class="line">    scene = DataLoaderWithCOLMAP(base_dir=<span class="string">&#x27;/your/data/path&#x27;</span>,</span><br><span class="line">                                 scene_name=scene_name,</span><br><span class="line">                                 data_type=<span class="string">&#x27;train&#x27;</span>,</span><br><span class="line">                                 res_ratio=<span class="number">8</span>,</span><br><span class="line">                                 num_img_to_load=-<span class="number">1</span>,</span><br><span class="line">                                 skip=<span class="number">1</span>,</span><br><span class="line">                                 use_ndc=use_ndc)</span><br></pre></td></tr></table></figure>
<h4 id="with-mask-py">with_mask.py</h4>
<p>ä»–ä»¬çš„maskå…¶å®æ˜¯æ©ç æ–‡ä»¶ï¼Œæœ‰æ²¡æœ‰å¯èƒ½åªåŸºäºæ©ç æ–‡ä»¶å»åšå‘¢ï¼Ÿ</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="comment"># os æ¨¡å—æä¾›äº†ä¸æ“ä½œç³»ç»Ÿè¿›è¡Œäº¤äº’çš„åŠŸèƒ½ï¼Œ</span></span><br><span class="line"><span class="comment"># å¯ç”¨äºå¤„ç†æ–‡ä»¶å’Œç›®å½•è·¯å¾„ã€åˆ›å»º/åˆ é™¤ç›®å½•ã€è·å–ç¯å¢ƒå˜é‡ç­‰ï¼Œ</span></span><br><span class="line"><span class="comment"># åœ¨æœ¬ä»£ç é‡Œä¸»è¦ç”¨äºæ„å»ºæ–‡ä»¶å’Œç›®å½•çš„è·¯å¾„ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="comment"># torch æ˜¯ PyTorch çš„æ ¸å¿ƒåº“ï¼Œæä¾›äº†å¼ é‡ï¼ˆTensorï¼‰æ•°æ®ç»“æ„ï¼Œ</span></span><br><span class="line"><span class="comment"># æ”¯æŒè‡ªåŠ¨æ±‚å¯¼æœºåˆ¶ï¼Œç”¨äºæ„å»ºå’Œè®­ç»ƒæ·±åº¦å­¦ä¹ æ¨¡å‹ï¼Œ</span></span><br><span class="line"><span class="comment"># èƒ½å¤Ÿåœ¨ CPU æˆ– GPU ä¸Šé«˜æ•ˆåœ°è¿›è¡Œæ•°å€¼è®¡ç®—ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="comment"># numpy æ˜¯ Python ä¸­ç”¨äºç§‘å­¦è®¡ç®—çš„åŸºç¡€åº“ï¼Œ</span></span><br><span class="line"><span class="comment"># æä¾›äº†é«˜æ•ˆçš„å¤šç»´æ•°ç»„å¯¹è±¡å’Œå„ç§æ•°å­¦å‡½æ•°ï¼Œ</span></span><br><span class="line"><span class="comment"># å¯è¿›è¡Œæ•°ç»„æ“ä½œã€çº¿æ€§ä»£æ•°è¿ç®—ã€éšæœºæ•°ç”Ÿæˆç­‰ï¼Œ</span></span><br><span class="line"><span class="comment"># åœ¨ä»£ç ä¸­ä¸»è¦ç”¨äºå¤„ç†å›¾åƒæ•°æ®å’Œæ•°ç»„æ“ä½œã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="comment"># tqdm æ˜¯ä¸€ä¸ªå¿«é€Ÿã€å¯æ‰©å±•çš„è¿›åº¦æ¡å·¥å…·ï¼Œ</span></span><br><span class="line"><span class="comment"># èƒ½åœ¨å¾ªç¯ä¸­æ˜¾ç¤ºè¿›åº¦æ¡ï¼Œæ–¹ä¾¿ç”¨æˆ·äº†è§£ä»£ç æ‰§è¡Œçš„è¿›åº¦ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> imageio</span><br><span class="line"><span class="comment"># imageio æ˜¯ä¸€ä¸ªç”¨äºè¯»å–å’Œå†™å…¥å¤šç§å›¾åƒæ–‡ä»¶æ ¼å¼çš„åº“ï¼Œ</span></span><br><span class="line"><span class="comment"># åœ¨ä»£ç ä¸­ä¸»è¦ç”¨äºè¯»å–å›¾åƒæ–‡ä»¶ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> dataloader.with_colmap <span class="keyword">import</span> resize_imgs</span><br><span class="line"><span class="comment"># ä» dataloader.with_colmap æ¨¡å—å¯¼å…¥ resize_imgs å‡½æ•°ï¼Œ</span></span><br><span class="line"><span class="comment"># è¯¥å‡½æ•°ç”¨äºè°ƒæ•´å›¾åƒçš„å°ºå¯¸ã€‚</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_imgs</span>(<span class="params">image_dir, mask_dir, num_img_to_load, start, end, skip, load_sorted, load_img</span>):</span><br><span class="line">    <span class="comment"># è·å–å›¾åƒç›®å½•ä¸‹æ‰€æœ‰å›¾åƒæ–‡ä»¶åï¼Œå¹¶æŒ‰å­—æ¯é¡ºåºæ’åº</span></span><br><span class="line">    img_names = np.array(<span class="built_in">sorted</span>(os.listdir(image_dir)))  <span class="comment"># all image names</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># åœ¨æ—¶é—´åŸŸä¸Šå¯¹å¸§è¿›è¡Œä¸‹é‡‡æ ·</span></span><br><span class="line">    <span class="keyword">if</span> end == -<span class="number">1</span> <span class="keyword">and</span> <span class="built_in">len</span>(os.listdir(mask_dir)) == <span class="built_in">len</span>(img_names):</span><br><span class="line">        <span class="comment"># è‹¥ end ä¸º -1 ä¸”æ©ç ç›®å½•å’Œå›¾åƒç›®å½•æ–‡ä»¶æ•°é‡ç›¸åŒï¼Œåˆ™æŒ‰ skip é—´éš”é€‰å–</span></span><br><span class="line">        img_names = img_names[start::skip]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># å– end å’Œæ©ç ç›®å½•æ–‡ä»¶æ•°é‡çš„æœ€å°å€¼ï¼Œé¿å…è¶Šç•Œ</span></span><br><span class="line">        end = <span class="built_in">min</span>(end, <span class="built_in">len</span>(os.listdir(mask_dir)))</span><br><span class="line">        img_names = img_names[start:end:skip]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¦‚æœä¸æŒ‰é¡ºåºåŠ è½½å›¾åƒï¼Œåˆ™å¯¹å›¾åƒæ–‡ä»¶åè¿›è¡Œéšæœºæ‰“ä¹±</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> load_sorted:</span><br><span class="line">        np.random.shuffle(img_names)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># åŠ è½½ä¸‹é‡‡æ ·åçš„å›¾åƒ</span></span><br><span class="line">    <span class="keyword">if</span> num_img_to_load &gt; <span class="built_in">len</span>(img_names):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Asked for &#123;0:6d&#125; images but only &#123;1:6d&#125; available. Exit.&#x27;</span>.<span class="built_in">format</span>(num_img_to_load, <span class="built_in">len</span>(img_names)))</span><br><span class="line">        exit()</span><br><span class="line">    <span class="keyword">elif</span> num_img_to_load == -<span class="number">1</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Loading all available &#123;0:6d&#125; images&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">len</span>(img_names)))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Loading &#123;0:6d&#125; images out of &#123;1:6d&#125; images.&#x27;</span>.<span class="built_in">format</span>(num_img_to_load, <span class="built_in">len</span>(img_names)))</span><br><span class="line">        img_names = img_names[:num_img_to_load]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ„å»ºæ¯ä¸ªå›¾åƒçš„å®Œæ•´è·¯å¾„</span></span><br><span class="line">    img_paths = [os.path.join(image_dir, n) <span class="keyword">for</span> n <span class="keyword">in</span> img_names]</span><br><span class="line">    <span class="comment"># æ„å»ºæ¯ä¸ªæ©ç å›¾åƒçš„å®Œæ•´è·¯å¾„ï¼Œå‡è®¾æ©ç å›¾åƒä¸º png æ ¼å¼ï¼Œä¸”æ–‡ä»¶åå’Œå›¾åƒæ–‡ä»¶åå¯¹åº”</span></span><br><span class="line">    mask_paths = [os.path.join(mask_dir, n[:-<span class="number">4</span>]+<span class="string">&#x27;.png&#x27;</span>) <span class="keyword">for</span> n <span class="keyword">in</span> img_names]</span><br><span class="line">    <span class="comment"># å›¾åƒçš„æ•°é‡</span></span><br><span class="line">    N_imgs = <span class="built_in">len</span>(img_paths)</span><br><span class="line"></span><br><span class="line">    img_list, mask_list = [], []</span><br><span class="line">    <span class="keyword">if</span> load_img:</span><br><span class="line">        <span class="comment"># ä½¿ç”¨ tqdm æ˜¾ç¤ºåŠ è½½å›¾åƒçš„è¿›åº¦</span></span><br><span class="line">        <span class="keyword">for</span> i, p <span class="keyword">in</span> tqdm(<span class="built_in">enumerate</span>(img_paths)):</span><br><span class="line">            <span class="comment"># è¯»å–å›¾åƒå¹¶åªä¿ç•™å‰ä¸‰ä¸ªé€šé“ï¼ˆRGBï¼‰</span></span><br><span class="line">            img = imageio.imread(p)[:, :, :<span class="number">3</span>]  <span class="comment"># (H, W, 3) np.uint8</span></span><br><span class="line">            img_list.append(img)</span><br><span class="line">            <span class="comment"># è¯»å–å¯¹åº”çš„æ©ç å›¾åƒï¼Œåªå–ç¬¬ä¸€ä¸ªé€šé“</span></span><br><span class="line">            img = imageio.imread(mask_paths[i])[:, :, [<span class="number">0</span>]]  <span class="comment"># (H, W, 1)</span></span><br><span class="line">            mask_list.append(img)</span><br><span class="line">        <span class="comment"># å°†å›¾åƒåˆ—è¡¨è½¬æ¢ä¸º numpy æ•°ç»„</span></span><br><span class="line">        img_list = np.stack(img_list)  <span class="comment"># (N, H, W, 3)</span></span><br><span class="line">        <span class="comment"># å°†æ©ç åˆ—è¡¨è½¬æ¢ä¸º numpy æ•°ç»„</span></span><br><span class="line">        mask_list = np.stack(mask_list)</span><br><span class="line">        <span class="comment"># å°† numpy æ•°ç»„è½¬æ¢ä¸º PyTorch å¼ é‡ï¼Œå¹¶å°†åƒç´ å€¼å½’ä¸€åŒ–åˆ° [0, 1] èŒƒå›´</span></span><br><span class="line">        img_list = torch.from_numpy(img_list).<span class="built_in">float</span>() / <span class="number">255</span>  <span class="comment"># (N, H, W, 3) torch.float32</span></span><br><span class="line">        mask_list = torch.from_numpy(mask_list).<span class="built_in">float</span>() / <span class="number">255</span></span><br><span class="line">        <span class="comment"># è·å–å›¾åƒçš„é«˜åº¦å’Œå®½åº¦</span></span><br><span class="line">        H, W = img_list.shape[<span class="number">1</span>], img_list.shape[<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># å¦‚æœä¸åŠ è½½å›¾åƒï¼Œåˆ™è¯»å–ç¬¬ä¸€å¼ å›¾åƒä»¥è·å–å›¾åƒçš„é«˜åº¦å’Œå®½åº¦</span></span><br><span class="line">        tmp_img = imageio.imread(img_paths[<span class="number">0</span>])  <span class="comment"># load one image to get H, W</span></span><br><span class="line">        H, W = tmp_img.shape[<span class="number">0</span>], tmp_img.shape[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    results = &#123;</span><br><span class="line">        <span class="string">&#x27;imgs&#x27;</span>: img_list,  <span class="comment"># (N, H, W, 3) torch.float32</span></span><br><span class="line">        <span class="string">&#x27;img_names&#x27;</span>: img_names,  <span class="comment"># (N, )</span></span><br><span class="line">        <span class="string">&#x27;masks&#x27;</span>: mask_list,  <span class="comment"># æ©ç å›¾åƒå¼ é‡</span></span><br><span class="line">        <span class="string">&#x27;N_imgs&#x27;</span>: N_imgs,</span><br><span class="line">        <span class="string">&#x27;H&#x27;</span>: H,</span><br><span class="line">        <span class="string">&#x27;W&#x27;</span>: W,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DataLoaderAnyFolder</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Most useful fields:</span></span><br><span class="line"><span class="string">        self.c2ws:          (N_imgs, 4, 4)      torch.float32</span></span><br><span class="line"><span class="string">        self.imgs           (N_imgs, H, W, 4)   torch.float32</span></span><br><span class="line"><span class="string">        self.ray_dir_cam    (H, W, 3)           torch.float32</span></span><br><span class="line"><span class="string">        self.H              scalar</span></span><br><span class="line"><span class="string">        self.W              scalar</span></span><br><span class="line"><span class="string">        self.N_imgs         scalar</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, base_dir, scene_name, res_ratio, num_img_to_load, start, end, skip, load_sorted, load_img=<span class="literal">True</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        :param base_dir: æ•°æ®çš„åŸºç¡€ç›®å½•</span></span><br><span class="line"><span class="string">        :param scene_name: åœºæ™¯çš„åç§°</span></span><br><span class="line"><span class="string">        :param res_ratio: æ•´æ•°ï¼Œå¦‚ [1, 2, 4] ç­‰ï¼Œç”¨äºå°†å›¾åƒè°ƒæ•´ä¸ºè¾ƒä½çš„åˆ†è¾¨ç‡ã€‚</span></span><br><span class="line"><span class="string">        :param start/end/skip: ç”¨äºåœ¨æ—¶é—´åŸŸä¸Šæ§åˆ¶å¸§çš„åŠ è½½ã€‚</span></span><br><span class="line"><span class="string">        :param load_sorted: å¸ƒå°”å€¼ï¼Œæ˜¯å¦æŒ‰é¡ºåºåŠ è½½å›¾åƒã€‚</span></span><br><span class="line"><span class="string">        :param load_img: å¸ƒå°”å€¼ã€‚å¦‚æœè®¾ç½®ä¸º falseï¼šä»…ç»Ÿè®¡å›¾åƒæ•°é‡ã€è·å–å›¾åƒçš„é«˜åº¦å’Œå®½åº¦ï¼Œ</span></span><br><span class="line"><span class="string">                         ä½†ä¸åŠ è½½å›¾åƒã€‚åœ¨å¯è§†åŒ–ä½å§¿æˆ–è°ƒè¯•ç­‰æƒ…å†µä¸‹å¾ˆæœ‰ç”¨ã€‚</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.base_dir = base_dir</span><br><span class="line">        <span class="variable language_">self</span>.scene_name = scene_name</span><br><span class="line">        <span class="variable language_">self</span>.res_ratio = res_ratio</span><br><span class="line">        <span class="variable language_">self</span>.num_img_to_load = num_img_to_load</span><br><span class="line">        <span class="variable language_">self</span>.start = start</span><br><span class="line">        <span class="variable language_">self</span>.end = end</span><br><span class="line">        <span class="variable language_">self</span>.skip = skip</span><br><span class="line">        <span class="variable language_">self</span>.load_sorted = load_sorted</span><br><span class="line">        <span class="variable language_">self</span>.load_img = load_img</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ„å»ºå›¾åƒç›®å½•çš„å®Œæ•´è·¯å¾„</span></span><br><span class="line">        <span class="variable language_">self</span>.imgs_dir = os.path.join(<span class="variable language_">self</span>.base_dir, <span class="variable language_">self</span>.scene_name)</span><br><span class="line">        <span class="comment"># æ„å»ºæ©ç ç›®å½•çš„å®Œæ•´è·¯å¾„ï¼Œå‡è®¾æ©ç ç›®å½•åœ¨å›¾åƒç›®å½•çš„ä¸Šä¸€çº§çš„ mask æ–‡ä»¶å¤¹ä¸‹</span></span><br><span class="line">        <span class="variable language_">self</span>.mask_dir = os.path.join(<span class="variable language_">self</span>.imgs_dir, <span class="string">&#x27;../mask/&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è°ƒç”¨ load_imgs å‡½æ•°åŠ è½½å›¾åƒå’Œæ©ç æ•°æ®</span></span><br><span class="line">        image_data = load_imgs(<span class="variable language_">self</span>.imgs_dir, <span class="variable language_">self</span>.mask_dir, <span class="variable language_">self</span>.num_img_to_load, <span class="variable language_">self</span>.start, <span class="variable language_">self</span>.end, <span class="variable language_">self</span>.skip,</span><br><span class="line">                               <span class="variable language_">self</span>.load_sorted, <span class="variable language_">self</span>.load_img)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æå–åŠ è½½çš„å›¾åƒæ•°æ®</span></span><br><span class="line">        <span class="variable language_">self</span>.imgs = image_data[<span class="string">&#x27;imgs&#x27;</span>]  <span class="comment"># (N, H, W, 3) torch.float32</span></span><br><span class="line">        <span class="comment"># æå–å›¾åƒæ–‡ä»¶å</span></span><br><span class="line">        <span class="variable language_">self</span>.img_names = image_data[<span class="string">&#x27;img_names&#x27;</span>]  <span class="comment"># (N, )</span></span><br><span class="line">        <span class="comment"># æå–æ©ç æ•°æ®</span></span><br><span class="line">        <span class="variable language_">self</span>.masks = image_data[<span class="string">&#x27;masks&#x27;</span>]</span><br><span class="line">        <span class="comment"># å›¾åƒçš„æ•°é‡</span></span><br><span class="line">        <span class="variable language_">self</span>.N_imgs = image_data[<span class="string">&#x27;N_imgs&#x27;</span>]</span><br><span class="line">        <span class="comment"># åŸå§‹å›¾åƒçš„é«˜åº¦</span></span><br><span class="line">        <span class="variable language_">self</span>.ori_H = image_data[<span class="string">&#x27;H&#x27;</span>]</span><br><span class="line">        <span class="comment"># åŸå§‹å›¾åƒçš„å®½åº¦</span></span><br><span class="line">        <span class="variable language_">self</span>.ori_W = image_data[<span class="string">&#x27;W&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å§‹ç»ˆä½¿ç”¨å½’ä¸€åŒ–è®¾å¤‡åæ ‡ï¼ˆNDCï¼‰ï¼Œè®¾ç½®è¿‘è£å‰ªå¹³é¢è·ç¦»</span></span><br><span class="line">        <span class="variable language_">self</span>.near = <span class="number">0.0</span></span><br><span class="line">        <span class="comment"># å§‹ç»ˆä½¿ç”¨å½’ä¸€åŒ–è®¾å¤‡åæ ‡ï¼ˆNDCï¼‰ï¼Œè®¾ç½®è¿œè£å‰ªå¹³é¢è·ç¦»</span></span><br><span class="line">        <span class="variable language_">self</span>.far = <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># å¦‚æœéœ€è¦è°ƒæ•´å›¾åƒåˆ†è¾¨ç‡</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.res_ratio &gt; <span class="number">1</span>:</span><br><span class="line">            <span class="comment"># è®¡ç®—è°ƒæ•´åçš„å›¾åƒé«˜åº¦</span></span><br><span class="line">            <span class="variable language_">self</span>.H = <span class="variable language_">self</span>.ori_H // <span class="variable language_">self</span>.res_ratio</span><br><span class="line">            <span class="comment"># è®¡ç®—è°ƒæ•´åçš„å›¾åƒå®½åº¦</span></span><br><span class="line">            <span class="variable language_">self</span>.W = <span class="variable language_">self</span>.ori_W // <span class="variable language_">self</span>.res_ratio</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="variable language_">self</span>.H = <span class="variable language_">self</span>.ori_H</span><br><span class="line">            <span class="variable language_">self</span>.W = <span class="variable language_">self</span>.ori_W</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.load_img:</span><br><span class="line">            <span class="comment"># è°ƒæ•´å›¾åƒçš„åˆ†è¾¨ç‡</span></span><br><span class="line">            <span class="variable language_">self</span>.imgs = resize_imgs(<span class="variable language_">self</span>.imgs, <span class="variable language_">self</span>.H, <span class="variable language_">self</span>.W)  <span class="comment"># (N, H, W, 3) torch.float32</span></span><br><span class="line">            <span class="comment"># è°ƒæ•´æ©ç å›¾åƒçš„åˆ†è¾¨ç‡</span></span><br><span class="line">            <span class="variable language_">self</span>.masks = resize_imgs(<span class="variable language_">self</span>.masks, <span class="variable language_">self</span>.H, <span class="variable language_">self</span>.W)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># æ•°æ®çš„åŸºç¡€ç›®å½•ï¼Œéœ€è¦æ›¿æ¢ä¸ºå®é™…çš„è·¯å¾„</span></span><br><span class="line">    base_dir = <span class="string">&#x27;/your/data/path&#x27;</span></span><br><span class="line">    <span class="comment"># åœºæ™¯çš„åç§°</span></span><br><span class="line">    scene_name = <span class="string">&#x27;LLFF/fern/images&#x27;</span></span><br><span class="line">    <span class="comment"># å›¾åƒçš„ç¼©æ”¾æ¯”ä¾‹</span></span><br><span class="line">    resize_ratio = <span class="number">8</span></span><br><span class="line">    <span class="comment"># è¦åŠ è½½çš„å›¾åƒæ•°é‡ï¼Œ-1 è¡¨ç¤ºåŠ è½½æ‰€æœ‰å›¾åƒ</span></span><br><span class="line">    num_img_to_load = -<span class="number">1</span></span><br><span class="line">    <span class="comment"># å¼€å§‹åŠ è½½å›¾åƒçš„ç´¢å¼•</span></span><br><span class="line">    start = <span class="number">0</span></span><br><span class="line">    <span class="comment"># ç»“æŸåŠ è½½å›¾åƒçš„ç´¢å¼•ï¼Œ-1 è¡¨ç¤ºåŠ è½½åˆ°æœ€å</span></span><br><span class="line">    end = -<span class="number">1</span></span><br><span class="line">    <span class="comment"># åŠ è½½å›¾åƒçš„é—´éš”</span></span><br><span class="line">    skip = <span class="number">1</span></span><br><span class="line">    <span class="comment"># æ˜¯å¦æŒ‰é¡ºåºåŠ è½½å›¾åƒ</span></span><br><span class="line">    load_sorted = <span class="literal">True</span></span><br><span class="line">    <span class="comment"># æ˜¯å¦åŠ è½½å›¾åƒ</span></span><br><span class="line">    load_img = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># åˆå§‹åŒ– DataLoaderAnyFolder ç±»</span></span><br><span class="line">    scene = DataLoaderAnyFolder(base_dir=base_dir,</span><br><span class="line">                                scene_name=scene_name,</span><br><span class="line">                                res_ratio=resize_ratio,</span><br><span class="line">                                num_img_to_load=num_img_to_load,</span><br><span class="line">                                start=start,</span><br><span class="line">                                end=end,</span><br><span class="line">                                skip=skip,</span><br><span class="line">                                load_sorted=load_sorted,</span><br><span class="line">                                load_img=load_img)</span><br></pre></td></tr></table></figure>
<h3 id="models">models</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">â”œâ”€â”€ models/  # æ¨¡å‹æ–‡ä»¶å¤¹</span><br><span class="line">â”‚   â”œâ”€â”€ depth_decoder.py  # æ·±åº¦è§£ç å™¨è„šæœ¬æ–‡ä»¶</span><br><span class="line">â”‚   â”œâ”€â”€ intrinsics.py  # å†…å‚ç›¸å…³è„šæœ¬æ–‡ä»¶</span><br><span class="line">â”‚   â”œâ”€â”€ layers.py  # å±‚ç›¸å…³è„šæœ¬æ–‡ä»¶</span><br><span class="line">â”‚   â”œâ”€â”€ nerf_feature.py  # NeRFç‰¹å¾ç›¸å…³è„šæœ¬æ–‡ä»¶</span><br><span class="line">â”‚   â”œâ”€â”€ nerf_mask.py  # NeRFæ©ç ç›¸å…³è„šæœ¬æ–‡ä»¶</span><br><span class="line">â”‚   â”œâ”€â”€ nerf_models.py  # NeRFæ¨¡å‹ç›¸å…³è„šæœ¬æ–‡ä»¶</span><br><span class="line">â”‚   â””â”€â”€ poses.py  # ä½å§¿ç›¸å…³è„šæœ¬æ–‡ä»¶</span><br></pre></td></tr></table></figure>
<h4 id="depth-decoder-py">depth_decoder.py</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ç‰ˆæƒæ‰€æœ‰ Niantic 2019ã€‚ä¸“åˆ©ç”³è¯·ä¸­ã€‚ä¿ç•™æ‰€æœ‰æƒåˆ©ã€‚</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># æœ¬è½¯ä»¶éµå¾ª Monodepth2 è®¸å¯è¯çš„æ¡æ¬¾ï¼Œ</span></span><br><span class="line"><span class="comment"># è¯¥è®¸å¯è¯ä»…å…è®¸éå•†ä¸šç”¨é€”ï¼Œå®Œæ•´æ¡æ¬¾å¯åœ¨ LICENSE æ–‡ä»¶ä¸­è·å–ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> absolute_import, division, print_function</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> models.layers <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ä¸€ä¸ªå·ç§¯å±‚ï¼Œè¾“å…¥é€šé“æ•°ä¸º in_planesï¼Œè¾“å‡ºé€šé“æ•°ä¸º out_planesï¼Œå·ç§¯æ ¸å¤§å°ä¸º kernel_size</span></span><br><span class="line"><span class="comment"># å¦‚æœ instancenorm ä¸º Trueï¼Œåˆ™ä½¿ç”¨å®ä¾‹å½’ä¸€åŒ–ï¼›å¦åˆ™ä½¿ç”¨æ‰¹é‡å½’ä¸€åŒ–</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">conv</span>(<span class="params">in_planes, out_planes, kernel_size, instancenorm=<span class="literal">False</span></span>):</span><br><span class="line">    <span class="keyword">if</span> instancenorm:</span><br><span class="line">        <span class="comment"># æ„å»ºä¸€ä¸ªåŒ…å«å·ç§¯å±‚ã€å®ä¾‹å½’ä¸€åŒ–å±‚å’Œ LeakyReLU æ¿€æ´»å‡½æ•°çš„åºåˆ—</span></span><br><span class="line">        m = nn.Sequential(</span><br><span class="line">            <span class="comment"># å·ç§¯å±‚ï¼Œä½¿ç”¨æŒ‡å®šçš„è¾“å…¥å’Œè¾“å‡ºé€šé“æ•°ã€å·ç§¯æ ¸å¤§å°ï¼Œæ­¥é•¿ä¸º 1ï¼Œå¡«å……ä¸º (kernel_size - 1) // 2ï¼Œæ— åç½®</span></span><br><span class="line">            nn.Conv2d(in_planes, out_planes, kernel_size=kernel_size,</span><br><span class="line">                      stride=<span class="number">1</span>, padding=(kernel_size - <span class="number">1</span>) // <span class="number">2</span>, bias=<span class="literal">False</span>),</span><br><span class="line">            <span class="comment"># å®ä¾‹å½’ä¸€åŒ–å±‚</span></span><br><span class="line">            nn.InstanceNorm2d(out_planes),</span><br><span class="line">            <span class="comment"># LeakyReLU æ¿€æ´»å‡½æ•°ï¼Œè´Ÿæ–œç‡ä¸º 0.1ï¼ŒåŸåœ°æ“ä½œ</span></span><br><span class="line">            nn.LeakyReLU(<span class="number">0.1</span>, inplace=<span class="literal">True</span>),</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># æ„å»ºä¸€ä¸ªåŒ…å«å·ç§¯å±‚ã€æ‰¹é‡å½’ä¸€åŒ–å±‚å’Œ LeakyReLU æ¿€æ´»å‡½æ•°çš„åºåˆ—</span></span><br><span class="line">        m = nn.Sequential(</span><br><span class="line">            <span class="comment"># å·ç§¯å±‚ï¼Œä½¿ç”¨æŒ‡å®šçš„è¾“å…¥å’Œè¾“å‡ºé€šé“æ•°ã€å·ç§¯æ ¸å¤§å°ï¼Œæ­¥é•¿ä¸º 1ï¼Œå¡«å……ä¸º (kernel_size - 1) // 2ï¼Œæ— åç½®</span></span><br><span class="line">            nn.Conv2d(in_planes, out_planes, kernel_size=kernel_size,</span><br><span class="line">                      stride=<span class="number">1</span>, padding=(kernel_size - <span class="number">1</span>) // <span class="number">2</span>, bias=<span class="literal">False</span>),</span><br><span class="line">            <span class="comment"># æ‰¹é‡å½’ä¸€åŒ–å±‚</span></span><br><span class="line">            nn.BatchNorm2d(out_planes),</span><br><span class="line">            <span class="comment"># LeakyReLU æ¿€æ´»å‡½æ•°ï¼Œè´Ÿæ–œç‡ä¸º 0.1ï¼ŒåŸåœ°æ“ä½œ</span></span><br><span class="line">            nn.LeakyReLU(<span class="number">0.1</span>, inplace=<span class="literal">True</span>)</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">return</span> m</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·±åº¦è§£ç å™¨ç±»ï¼Œç»§æ‰¿è‡ª nn.Module</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DepthDecoder</span>(nn.Module):</span><br><span class="line">    <span class="comment"># å°†å…ƒç»„è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œç”¨äºä½œä¸ºå­—å…¸çš„é”®</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">tuple_to_str</span>(<span class="params">self, key_tuple</span>):</span><br><span class="line">        key_str = <span class="string">&#x27;-&#x27;</span>.join(<span class="built_in">str</span>(key_tuple))</span><br><span class="line">        <span class="keyword">return</span> key_str</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, num_ch_enc, embedder, embedder_out_dim,</span></span><br><span class="line"><span class="params">                 use_alpha=<span class="literal">False</span>, scales=<span class="built_in">range</span>(<span class="params"><span class="number">4</span></span>), num_output_channels=<span class="number">4</span>,</span></span><br><span class="line"><span class="params">                 use_skips=<span class="literal">True</span>, sigma_dropout_rate=<span class="number">0.0</span>, **kwargs</span>):</span><br><span class="line">        <span class="comment"># è°ƒç”¨çˆ¶ç±»çš„æ„é€ å‡½æ•°</span></span><br><span class="line">        <span class="built_in">super</span>(DepthDecoder, <span class="variable language_">self</span>).__init__()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è¾“å‡ºé€šé“æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.num_output_channels = num_output_channels</span><br><span class="line">        <span class="comment"># æ˜¯å¦ä½¿ç”¨è·³è·ƒè¿æ¥</span></span><br><span class="line">        <span class="variable language_">self</span>.use_skips = use_skips</span><br><span class="line">        <span class="comment"># ä¸Šé‡‡æ ·æ¨¡å¼</span></span><br><span class="line">        <span class="variable language_">self</span>.upsample_mode = <span class="string">&#x27;nearest&#x27;</span></span><br><span class="line">        <span class="comment"># è¦å¤„ç†çš„å°ºåº¦</span></span><br><span class="line">        <span class="variable language_">self</span>.scales = scales</span><br><span class="line">        <span class="comment"># æ˜¯å¦ä½¿ç”¨ alpha</span></span><br><span class="line">        <span class="variable language_">self</span>.use_alpha = use_alpha</span><br><span class="line">        <span class="comment"># sigma çš„ä¸¢å¼ƒç‡</span></span><br><span class="line">        <span class="variable language_">self</span>.sigma_dropout_rate = sigma_dropout_rate</span><br><span class="line"></span><br><span class="line">        <span class="comment"># åµŒå…¥å™¨</span></span><br><span class="line">        <span class="variable language_">self</span>.embedder = embedder</span><br><span class="line">        <span class="comment"># åµŒå…¥å™¨çš„è¾“å‡ºç»´åº¦</span></span><br><span class="line">        <span class="variable language_">self</span>.E = embedder_out_dim</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ç¼–ç å™¨æœ€åä¸€å±‚çš„è¾“å‡ºé€šé“æ•°</span></span><br><span class="line">        final_enc_out_channels = num_ch_enc[-<span class="number">1</span>]</span><br><span class="line">        <span class="comment"># æœ€å¤§æ± åŒ–å±‚ï¼Œç”¨äºä¸‹é‡‡æ ·</span></span><br><span class="line">        <span class="variable language_">self</span>.downsample = nn.MaxPool2d(<span class="number">3</span>, stride=<span class="number">2</span>, padding=<span class="number">1</span>)</span><br><span class="line">        <span class="comment"># æœ€è¿‘é‚»ä¸Šé‡‡æ ·å±‚ï¼Œç”¨äºä¸Šé‡‡æ ·</span></span><br><span class="line">        <span class="variable language_">self</span>.upsample = nn.UpsamplingNearest2d(scale_factor=<span class="number">2</span>)</span><br><span class="line">        <span class="comment"># ç¬¬ä¸€ä¸ªä¸‹é‡‡æ ·å·ç§¯å±‚</span></span><br><span class="line">        <span class="variable language_">self</span>.conv_down1 = conv(final_enc_out_channels, <span class="number">512</span>, <span class="number">1</span>, <span class="literal">False</span>)</span><br><span class="line">        <span class="comment"># ç¬¬äºŒä¸ªä¸‹é‡‡æ ·å·ç§¯å±‚</span></span><br><span class="line">        <span class="variable language_">self</span>.conv_down2 = conv(<span class="number">512</span>, <span class="number">256</span>, <span class="number">3</span>, <span class="literal">False</span>)</span><br><span class="line">        <span class="comment"># ç¬¬ä¸€ä¸ªä¸Šé‡‡æ ·å·ç§¯å±‚</span></span><br><span class="line">        <span class="variable language_">self</span>.conv_up1 = conv(<span class="number">256</span>, <span class="number">256</span>, <span class="number">3</span>, <span class="literal">False</span>)</span><br><span class="line">        <span class="comment"># ç¬¬äºŒä¸ªä¸Šé‡‡æ ·å·ç§¯å±‚</span></span><br><span class="line">        <span class="variable language_">self</span>.conv_up2 = conv(<span class="number">256</span>, final_enc_out_channels, <span class="number">1</span>, <span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ç¼–ç å™¨å„å±‚çš„é€šé“æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.num_ch_enc = num_ch_enc</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;num_ch_enc=&quot;</span>, num_ch_enc)</span><br><span class="line">        <span class="comment"># å°†ç¼–ç å™¨å„å±‚çš„é€šé“æ•°åŠ ä¸ŠåµŒå…¥å™¨çš„è¾“å‡ºç»´åº¦</span></span><br><span class="line">        <span class="variable language_">self</span>.num_ch_enc = [x + <span class="variable language_">self</span>.E <span class="keyword">for</span> x <span class="keyword">in</span> <span class="variable language_">self</span>.num_ch_enc]</span><br><span class="line">        <span class="comment"># è§£ç å™¨å„å±‚çš„é€šé“æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.num_ch_dec = np.array([<span class="number">16</span>, <span class="number">32</span>, <span class="number">64</span>, <span class="number">128</span>, <span class="number">256</span>])</span><br><span class="line">        <span class="comment"># self.num_ch_enc = np.array([64, 64, 128, 256, 512])</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># è§£ç å™¨çš„å·ç§¯å±‚ï¼Œä½¿ç”¨ nn.ModuleDict å­˜å‚¨</span></span><br><span class="line">        <span class="variable language_">self</span>.convs = nn.ModuleDict()</span><br><span class="line">        <span class="comment"># ä» 4 åˆ° 0 éå†</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>, -<span class="number">1</span>, -<span class="number">1</span>):</span><br><span class="line">            <span class="comment"># ä¸Šå·ç§¯å±‚ 0</span></span><br><span class="line">            <span class="comment"># å¦‚æœ i ä¸º 4ï¼Œåˆ™è¾“å…¥é€šé“æ•°ä¸ºç¼–ç å™¨æœ€åä¸€å±‚çš„é€šé“æ•°ï¼›å¦åˆ™ä¸ºè§£ç å™¨ä¸Šä¸€å±‚çš„é€šé“æ•°</span></span><br><span class="line">            num_ch_in = <span class="variable language_">self</span>.num_ch_enc[-<span class="number">1</span>] <span class="keyword">if</span> i == <span class="number">4</span> <span class="keyword">else</span> <span class="variable language_">self</span>.num_ch_dec[i + <span class="number">1</span>]</span><br><span class="line">            <span class="comment"># è¾“å‡ºé€šé“æ•°ä¸ºè§£ç å™¨å½“å‰å±‚çš„é€šé“æ•°</span></span><br><span class="line">            num_ch_out = <span class="variable language_">self</span>.num_ch_dec[i]</span><br><span class="line">            <span class="comment"># åˆ›å»ºå·ç§¯å—å¹¶æ·»åŠ åˆ° convs å­—å…¸ä¸­</span></span><br><span class="line">            <span class="variable language_">self</span>.convs[<span class="variable language_">self</span>.tuple_to_str((<span class="string">&quot;upconv&quot;</span>, i, <span class="number">0</span>))] = ConvBlock(num_ch_in, num_ch_out)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;upconv_&#123;&#125;_&#123;&#125;&quot;</span>.<span class="built_in">format</span>(i, <span class="number">0</span>), num_ch_in, num_ch_out)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># ä¸Šå·ç§¯å±‚ 1</span></span><br><span class="line">            <span class="comment"># è¾“å…¥é€šé“æ•°ä¸ºè§£ç å™¨å½“å‰å±‚çš„é€šé“æ•°</span></span><br><span class="line">            num_ch_in = <span class="variable language_">self</span>.num_ch_dec[i]</span><br><span class="line">            <span class="comment"># å¦‚æœä½¿ç”¨è·³è·ƒè¿æ¥ä¸” i å¤§äº 0ï¼Œåˆ™è¾“å…¥é€šé“æ•°åŠ ä¸Šç¼–ç å™¨ä¸Šä¸€å±‚çš„é€šé“æ•°</span></span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.use_skips <span class="keyword">and</span> i &gt; <span class="number">0</span>:</span><br><span class="line">                num_ch_in += <span class="variable language_">self</span>.num_ch_enc[i - <span class="number">1</span>]</span><br><span class="line">            <span class="comment"># è¾“å‡ºé€šé“æ•°ä¸ºè§£ç å™¨å½“å‰å±‚çš„é€šé“æ•°</span></span><br><span class="line">            num_ch_out = <span class="variable language_">self</span>.num_ch_dec[i]</span><br><span class="line">            <span class="comment"># åˆ›å»ºå·ç§¯å—å¹¶æ·»åŠ åˆ° convs å­—å…¸ä¸­</span></span><br><span class="line">            <span class="variable language_">self</span>.convs[<span class="variable language_">self</span>.tuple_to_str((<span class="string">&quot;upconv&quot;</span>, i, <span class="number">1</span>))] = ConvBlock(num_ch_in, num_ch_out)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;upconv_&#123;&#125;_&#123;&#125;&quot;</span>.<span class="built_in">format</span>(i, <span class="number">1</span>), num_ch_in, num_ch_out)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># éå†è¦å¤„ç†çš„å°ºåº¦</span></span><br><span class="line">        <span class="keyword">for</span> s <span class="keyword">in</span> <span class="variable language_">self</span>.scales:</span><br><span class="line">            <span class="comment"># åˆ›å»ºä¸€ä¸ª 3x3 çš„å·ç§¯å±‚å¹¶æ·»åŠ åˆ° convs å­—å…¸ä¸­</span></span><br><span class="line">            <span class="variable language_">self</span>.convs[<span class="variable language_">self</span>.tuple_to_str((<span class="string">&quot;dispconv&quot;</span>, s))] = Conv3x3(<span class="variable language_">self</span>.num_ch_dec[s], <span class="variable language_">self</span>.num_output_channels)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Sigmoid æ¿€æ´»å‡½æ•°ï¼Œç”¨äºå°†è¾“å‡ºæ˜ å°„åˆ° [0, 1] èŒƒå›´</span></span><br><span class="line">        <span class="variable language_">self</span>.sigmoid = nn.Sigmoid()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, input_features, disparity</span>):</span><br><span class="line">        <span class="comment"># è·å–è¾“å…¥è§†å·®çš„æ‰¹æ¬¡å¤§å°å’Œåºåˆ—é•¿åº¦</span></span><br><span class="line">        B, S = disparity.size()</span><br><span class="line">        <span class="comment"># å¯¹è¾“å…¥è§†å·®è¿›è¡ŒåµŒå…¥æ“ä½œï¼Œç„¶åå¢åŠ ä¸¤ä¸ªç»´åº¦</span></span><br><span class="line">        disparity = <span class="variable language_">self</span>.embedder(disparity.reshape(B * S, <span class="number">1</span>)).unsqueeze(<span class="number">2</span>).unsqueeze(<span class="number">3</span>)</span><br><span class="line">---------------------------------------------------------------------------------------------------------------------</span><br><span class="line">tensor_1d æ˜¯ä¸€ä¸ªä¸€ç»´å¼ é‡ï¼Œç›´æ¥ä½¿ç”¨ torch.tensor åˆ›å»ºï¼Œå…¶å½¢çŠ¶ä¸º (<span class="number">3</span>,)ã€‚</span><br><span class="line">tensor_2d æ˜¯é€šè¿‡å¯¹ tensor_1d ä½¿ç”¨ unsqueeze(<span class="number">1</span>) å¢åŠ ä¸€ä¸ªç»´åº¦å¾—åˆ°çš„ï¼Œå½¢çŠ¶ä¸º (<span class="number">3</span>, <span class="number">1</span>)ã€‚</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºå½¢çŠ¶ä¸º (3,) çš„ä¸€ç»´å¼ é‡</span></span><br><span class="line">tensor_1d = torch.tensor([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;tensor_1d æ˜¯å¦å®šä¹‰:&quot;</span>, <span class="string">&#x27;tensor_1d&#x27;</span> <span class="keyword">in</span> <span class="built_in">locals</span>())</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;tensor_1d çš„å€¼:&quot;</span>, tensor_1d)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»˜åˆ¶ä¸€ç»´å¼ é‡</span></span><br><span class="line">plt.figure(figsize=(<span class="number">12</span>, <span class="number">5</span>))</span><br><span class="line">plt.subplot(<span class="number">1</span>, <span class="number">2</span>, <span class="number">1</span>)</span><br><span class="line">plt.plot(<span class="built_in">range</span>(<span class="built_in">len</span>(tensor_1d)), tensor_1d, marker=<span class="string">&#x27;o&#x27;</span>)</span><br><span class="line">plt.title(<span class="string">&#x27;Shape (3,) Tensor&#x27;</span>)</span><br><span class="line">plt.xlabel(<span class="string">&#x27;Index&#x27;</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;Value&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºå½¢çŠ¶ä¸º (3, 1) çš„äºŒç»´å¼ é‡</span></span><br><span class="line">tensor_2d = tensor_1d.unsqueeze(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»˜åˆ¶äºŒç»´å¼ é‡</span></span><br><span class="line">plt.subplot(<span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>)</span><br><span class="line">plt.bar(<span class="built_in">range</span>(<span class="built_in">len</span>(tensor_2d)), tensor_2d.flatten(), width=<span class="number">0.5</span>)</span><br><span class="line">plt.title(<span class="string">&#x27;Shape (3, 1) Tensor&#x27;</span>)</span><br><span class="line">plt.xlabel(<span class="string">&#x27;Index&#x27;</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;Value&#x27;</span>)</span><br><span class="line"></span><br><span class="line">plt.tight_layout()</span><br><span class="line">plt.show()</span><br><span class="line">---------------------------------------------------------------------------------------------------------------------</span><br><span class="line">        <span class="comment"># æ‰©å±•ç¼–ç å™¨çš„è¾“å‡ºä»¥å¢åŠ æ„Ÿå—é‡</span></span><br><span class="line">        <span class="comment"># è·å–ç¼–ç å™¨æœ€åä¸€å±‚çš„è¾“å‡º</span></span><br><span class="line">        encoder_out = input_features[-<span class="number">1</span>]</span><br><span class="line">        <span class="comment"># å¯¹ç¼–ç å™¨è¾“å‡ºè¿›è¡Œä¸‹é‡‡æ ·ï¼Œç„¶åé€šè¿‡ç¬¬ä¸€ä¸ªä¸‹é‡‡æ ·å·ç§¯å±‚</span></span><br><span class="line">        conv_down1 = <span class="variable language_">self</span>.conv_down1(<span class="variable language_">self</span>.downsample(encoder_out))</span><br><span class="line">        <span class="comment"># å¯¹ç¬¬ä¸€ä¸ªä¸‹é‡‡æ ·å·ç§¯å±‚çš„è¾“å‡ºè¿›è¡Œä¸‹é‡‡æ ·ï¼Œç„¶åé€šè¿‡ç¬¬äºŒä¸ªä¸‹é‡‡æ ·å·ç§¯å±‚</span></span><br><span class="line">        conv_down2 = <span class="variable language_">self</span>.conv_down2(<span class="variable language_">self</span>.downsample(conv_down1))</span><br><span class="line">        <span class="comment"># å¯¹ç¬¬äºŒä¸ªä¸‹é‡‡æ ·å·ç§¯å±‚çš„è¾“å‡ºè¿›è¡Œä¸Šé‡‡æ ·ï¼Œç„¶åé€šè¿‡ç¬¬ä¸€ä¸ªä¸Šé‡‡æ ·å·ç§¯å±‚</span></span><br><span class="line">        conv_up1 = <span class="variable language_">self</span>.conv_up1(<span class="variable language_">self</span>.upsample(conv_down2))</span><br><span class="line">        <span class="comment"># å¯¹ç¬¬ä¸€ä¸ªä¸Šé‡‡æ ·å·ç§¯å±‚çš„è¾“å‡ºè¿›è¡Œä¸Šé‡‡æ ·ï¼Œç„¶åé€šè¿‡ç¬¬äºŒä¸ªä¸Šé‡‡æ ·å·ç§¯å±‚</span></span><br><span class="line">        conv_up2 = <span class="variable language_">self</span>.conv_up2(<span class="variable language_">self</span>.upsample(conv_up1))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># é‡å¤ / é‡å¡‘ç‰¹å¾</span></span><br><span class="line">        <span class="comment"># è·å–ç¬¬äºŒä¸ªä¸Šé‡‡æ ·å·ç§¯å±‚è¾“å‡ºçš„é€šé“æ•°ã€é«˜åº¦å’Œå®½åº¦</span></span><br><span class="line">        _, C_feat, H_feat, W_feat = conv_up2.size()</span><br><span class="line">        <span class="comment"># å¯¹ç¬¬äºŒä¸ªä¸Šé‡‡æ ·å·ç§¯å±‚çš„è¾“å‡ºè¿›è¡Œæ‰©å±•å’Œé‡å¡‘</span></span><br><span class="line">        feat_tmp = conv_up2.unsqueeze(<span class="number">1</span>).expand(B, S, C_feat, H_feat, W_feat) \</span><br><span class="line">            .contiguous().view(B * S, C_feat, H_feat, W_feat)</span><br><span class="line">        <span class="comment"># å¯¹è§†å·®è¿›è¡Œé‡å¤æ“ä½œä»¥åŒ¹é…ç‰¹å¾å›¾çš„å¤§å°</span></span><br><span class="line">        disparity_BsCHW = disparity.repeat(<span class="number">1</span>, <span class="number">1</span>, H_feat, W_feat)</span><br><span class="line">        <span class="comment"># å°†æ‰©å±•åçš„ç‰¹å¾å’Œè§†å·®æ‹¼æ¥åœ¨ä¸€èµ·</span></span><br><span class="line">        conv_up2 = torch.cat((feat_tmp, disparity_BsCHW), dim=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># é‡å¤ / é‡å¡‘è¾“å…¥ç‰¹å¾</span></span><br><span class="line">        <span class="keyword">for</span> i, feat <span class="keyword">in</span> <span class="built_in">enumerate</span>(input_features):</span><br><span class="line">            <span class="comment"># è·å–è¾“å…¥ç‰¹å¾çš„é€šé“æ•°ã€é«˜åº¦å’Œå®½åº¦</span></span><br><span class="line">            _, C_feat, H_feat, W_feat = feat.size()</span><br><span class="line">            <span class="comment"># å¯¹è¾“å…¥ç‰¹å¾è¿›è¡Œæ‰©å±•å’Œé‡å¡‘</span></span><br><span class="line">            feat_tmp = feat.unsqueeze(<span class="number">1</span>).expand(B, S, C_feat, H_feat, W_feat) \</span><br><span class="line">                .contiguous().view(B * S, C_feat, H_feat, W_feat)</span><br><span class="line">            <span class="comment"># å¯¹è§†å·®è¿›è¡Œé‡å¤æ“ä½œä»¥åŒ¹é…ç‰¹å¾å›¾çš„å¤§å°</span></span><br><span class="line">            disparity_BsCHW = disparity.repeat(<span class="number">1</span>, <span class="number">1</span>, H_feat, W_feat)</span><br><span class="line">            <span class="comment"># å°†æ‰©å±•åçš„ç‰¹å¾å’Œè§†å·®æ‹¼æ¥åœ¨ä¸€èµ·</span></span><br><span class="line">            input_features[i] = torch.cat((feat_tmp, disparity_BsCHW), dim=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è§£ç å™¨éƒ¨åˆ†</span></span><br><span class="line">        <span class="comment"># å­˜å‚¨è¾“å‡ºç»“æœçš„å­—å…¸</span></span><br><span class="line">        outputs = &#123;&#125;</span><br><span class="line">        <span class="comment"># åˆå§‹è¾“å…¥ä¸ºæ‰©å±•åçš„ç¬¬äºŒä¸ªä¸Šé‡‡æ ·å·ç§¯å±‚çš„è¾“å‡º</span></span><br><span class="line">        x = conv_up2</span><br><span class="line">        <span class="comment"># ä» 4 åˆ° 0 éå†</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>, -<span class="number">1</span>, -<span class="number">1</span>):</span><br><span class="line">            <span class="comment"># é€šè¿‡ä¸Šå·ç§¯å±‚ 0</span></span><br><span class="line">            x = <span class="variable language_">self</span>.convs[<span class="variable language_">self</span>.tuple_to_str((<span class="string">&quot;upconv&quot;</span>, i, <span class="number">0</span>))](x)</span><br><span class="line">            <span class="comment"># è¿›è¡Œä¸Šé‡‡æ ·</span></span><br><span class="line">            x = [upsample(x)]</span><br><span class="line">            <span class="comment"># å¦‚æœä½¿ç”¨è·³è·ƒè¿æ¥ä¸” i å¤§äº 0</span></span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.use_skips <span class="keyword">and</span> i &gt; <span class="number">0</span>:</span><br><span class="line">                <span class="comment"># å°†ç¼–ç å™¨ä¸Šä¸€å±‚çš„ç‰¹å¾æ·»åŠ åˆ°åˆ—è¡¨ä¸­</span></span><br><span class="line">                x += [input_features[i - <span class="number">1</span>]]</span><br><span class="line">            <span class="comment"># å°†åˆ—è¡¨ä¸­çš„ç‰¹å¾æ‹¼æ¥åœ¨ä¸€èµ·</span></span><br><span class="line">            x = torch.cat(x, <span class="number">1</span>)</span><br><span class="line">            <span class="comment"># é€šè¿‡ä¸Šå·ç§¯å±‚ 1</span></span><br><span class="line">            x = <span class="variable language_">self</span>.convs[<span class="variable language_">self</span>.tuple_to_str((<span class="string">&quot;upconv&quot;</span>, i, <span class="number">1</span>))](x)</span><br><span class="line">            <span class="comment"># å¦‚æœå½“å‰å°ºåº¦åœ¨è¦å¤„ç†çš„å°ºåº¦åˆ—è¡¨ä¸­</span></span><br><span class="line">            <span class="keyword">if</span> i <span class="keyword">in</span> <span class="variable language_">self</span>.scales:</span><br><span class="line">                <span class="comment"># é€šè¿‡è§†å·®å·ç§¯å±‚å¾—åˆ°è¾“å‡º</span></span><br><span class="line">                output = <span class="variable language_">self</span>.convs[<span class="variable language_">self</span>.tuple_to_str((<span class="string">&quot;dispconv&quot;</span>, i))](x)</span><br><span class="line">                <span class="comment"># è·å–è¾“å‡ºçš„é«˜åº¦å’Œå®½åº¦</span></span><br><span class="line">                H_mpi, W_mpi = output.size(<span class="number">2</span>), output.size(<span class="number">3</span>)</span><br><span class="line">                <span class="comment"># è°ƒæ•´è¾“å‡ºçš„ç»´åº¦</span></span><br><span class="line">                mpi = output.view(B, S, <span class="number">4</span>, H_mpi, W_mpi)</span><br><span class="line">                <span class="comment"># å¯¹ RGB é€šé“åº”ç”¨ Sigmoid æ¿€æ´»å‡½æ•°</span></span><br><span class="line">                mpi_rgb = <span class="variable language_">self</span>.sigmoid(mpi[:, :, <span class="number">0</span>:<span class="number">3</span>, :, :])</span><br><span class="line">                <span class="comment"># å¦‚æœä¸ä½¿ç”¨ alphaï¼Œåˆ™å–ç»å¯¹å€¼å¹¶åŠ ä¸Šä¸€ä¸ªå°çš„å¸¸æ•°ï¼›å¦åˆ™åº”ç”¨ Sigmoid æ¿€æ´»å‡½æ•°</span></span><br><span class="line">                mpi_sigma = torch.<span class="built_in">abs</span>(mpi[:, :, <span class="number">3</span>:, :, :]) + <span class="number">1e-4</span> \</span><br><span class="line">                        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.use_alpha \</span><br><span class="line">                        <span class="keyword">else</span> <span class="variable language_">self</span>.sigmoid(mpi[:, :, <span class="number">3</span>:, :, :])</span><br><span class="line"></span><br><span class="line">                <span class="comment"># å¦‚æœ sigma ä¸¢å¼ƒç‡å¤§äº 0 ä¸”å¤„äºè®­ç»ƒæ¨¡å¼</span></span><br><span class="line">                <span class="keyword">if</span> <span class="variable language_">self</span>.sigma_dropout_rate &gt; <span class="number">0.0</span> <span class="keyword">and</span> <span class="variable language_">self</span>.training:</span><br><span class="line">                    <span class="comment"># å¯¹ sigma é€šé“åº”ç”¨ 2D Dropout</span></span><br><span class="line">                    mpi_sigma = F.dropout2d(mpi_sigma, p=<span class="variable language_">self</span>.sigma_dropout_rate)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># å°† RGB å’Œ sigma é€šé“æ‹¼æ¥åœ¨ä¸€èµ·ï¼Œå¹¶å­˜å‚¨åˆ°è¾“å‡ºå­—å…¸ä¸­</span></span><br><span class="line">                outputs[(<span class="string">&quot;disp&quot;</span>, i)] = torch.cat((mpi_rgb, mpi_sigma), dim=<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> outputs</span><br></pre></td></tr></table></figure>
<h4 id="intrinsics-py">intrinsics.py</h4>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ä¸€ä¸ªç”¨äºå­¦ä¹ ç„¦è·çš„ç¥ç»ç½‘ç»œæ¨¡å—</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LearnFocal</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, H, W, req_grad, fx_only, order=<span class="number">2</span>, init_focal=<span class="literal">None</span>, learn_distortion=<span class="literal">False</span></span>):</span><br><span class="line">        <span class="comment"># è°ƒç”¨çˆ¶ç±» nn.Module çš„æ„é€ å‡½æ•°</span></span><br><span class="line">        <span class="built_in">super</span>(LearnFocal, <span class="variable language_">self</span>).__init__()</span><br><span class="line">        <span class="comment"># å›¾åƒçš„é«˜åº¦</span></span><br><span class="line">        <span class="variable language_">self</span>.H = H</span><br><span class="line">        <span class="comment"># å›¾åƒçš„å®½åº¦</span></span><br><span class="line">        <span class="variable language_">self</span>.W = W</span><br><span class="line">        <span class="comment"># ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œå¦‚æœä¸º Trueï¼Œåªè¾“å‡º [fx, fx]ï¼›å¦‚æœä¸º Falseï¼Œè¾“å‡º [fx, fy]</span></span><br><span class="line">        <span class="variable language_">self</span>.fx_only = fx_only  </span><br><span class="line">        <span class="comment"># ç„¦è·åˆå§‹åŒ–çš„é˜¶æ•°ï¼Œæ£€æŸ¥æˆ‘ä»¬çš„è¡¥å……éƒ¨åˆ†æœ‰ç›¸å…³è¯´æ˜</span></span><br><span class="line">        <span class="variable language_">self</span>.order = order  </span><br><span class="line"></span><br><span class="line">        <span class="comment"># ç•¸å˜ç›¸å…³</span></span><br><span class="line">        <span class="comment"># æ˜¯å¦å­¦ä¹ ç•¸å˜å‚æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.learn_distortion = learn_distortion</span><br><span class="line">        <span class="keyword">if</span> learn_distortion:</span><br><span class="line">            <span class="comment"># ç¬¬ä¸€ä¸ªç•¸å˜ç³»æ•°ï¼Œå¯æ ¹æ® req_grad è®¾ç½®æ˜¯å¦éœ€è¦æ¢¯åº¦</span></span><br><span class="line">            <span class="variable language_">self</span>.k1 = nn.Parameter(torch.tensor(<span class="number">0.0</span>, dtype=torch.float32), requires_grad=req_grad)</span><br><span class="line">            <span class="comment"># ç¬¬äºŒä¸ªç•¸å˜ç³»æ•°ï¼Œå¯æ ¹æ® req_grad è®¾ç½®æ˜¯å¦éœ€è¦æ¢¯åº¦</span></span><br><span class="line">            <span class="variable language_">self</span>.k2 = nn.Parameter(torch.tensor(<span class="number">0.0</span>, dtype=torch.float32), requires_grad=req_grad)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.fx_only:</span><br><span class="line">            <span class="keyword">if</span> init_focal <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="comment"># å¦‚æœæ²¡æœ‰æä¾›åˆå§‹ç„¦è·ï¼Œå°† fx åˆå§‹åŒ–ä¸º 1.0ï¼Œå¯æ ¹æ® req_grad è®¾ç½®æ˜¯å¦éœ€è¦æ¢¯åº¦</span></span><br><span class="line">                <span class="variable language_">self</span>.fx = nn.Parameter(torch.tensor(<span class="number">1.0</span>, dtype=torch.float32), requires_grad=req_grad)  <span class="comment"># (1, )</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">if</span> <span class="variable language_">self</span>.order == <span class="number">2</span>:</span><br><span class="line">                    <span class="comment"># æ ¹æ®å…¬å¼ a**2 * W = fx è®¡ç®—ç³»æ•° aï¼Œå³ a**2 = fx / W</span></span><br><span class="line">                    coe_x = torch.tensor(np.sqrt(init_focal / <span class="built_in">float</span>(W)), requires_grad=<span class="literal">False</span>).<span class="built_in">float</span>()</span><br><span class="line">                <span class="keyword">elif</span> <span class="variable language_">self</span>.order == <span class="number">1</span>:</span><br><span class="line">                    <span class="comment"># æ ¹æ®å…¬å¼ a * W = fx è®¡ç®—ç³»æ•° aï¼Œå³ a = fx / W</span></span><br><span class="line">                    coe_x = torch.tensor(init_focal / <span class="built_in">float</span>(W), requires_grad=<span class="literal">False</span>).<span class="built_in">float</span>()</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&#x27;ç„¦è·åˆå§‹åŒ–é˜¶æ•°éœ€è¦ä¸º 1 æˆ– 2ã€‚é€€å‡º&#x27;</span>)</span><br><span class="line">                    exit()</span><br><span class="line">                <span class="comment"># å°†è®¡ç®—å¾—åˆ°çš„ç³»æ•°ä½œä¸º fxï¼Œå¯æ ¹æ® req_grad è®¾ç½®æ˜¯å¦éœ€è¦æ¢¯åº¦</span></span><br><span class="line">                <span class="variable language_">self</span>.fx = nn.Parameter(coe_x, requires_grad=req_grad)  <span class="comment"># (1, )</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> init_focal <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="comment"># å¦‚æœæ²¡æœ‰æä¾›åˆå§‹ç„¦è·ï¼Œå°† fx åˆå§‹åŒ–ä¸º 1.0ï¼Œå¯æ ¹æ® req_grad è®¾ç½®æ˜¯å¦éœ€è¦æ¢¯åº¦</span></span><br><span class="line">                <span class="variable language_">self</span>.fx = nn.Parameter(torch.tensor(<span class="number">1.0</span>, dtype=torch.float32), requires_grad=req_grad)  <span class="comment"># (1, )</span></span><br><span class="line">                <span class="comment"># å¦‚æœæ²¡æœ‰æä¾›åˆå§‹ç„¦è·ï¼Œå°† fy åˆå§‹åŒ–ä¸º 1.0ï¼Œå¯æ ¹æ® req_grad è®¾ç½®æ˜¯å¦éœ€è¦æ¢¯åº¦</span></span><br><span class="line">                <span class="variable language_">self</span>.fy = nn.Parameter(torch.tensor(<span class="number">1.0</span>, dtype=torch.float32), requires_grad=req_grad)  <span class="comment"># (1, )</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">if</span> <span class="variable language_">self</span>.order == <span class="number">2</span>:</span><br><span class="line">                    <span class="comment"># æ ¹æ®å…¬å¼ a**2 * W = fx è®¡ç®— x æ–¹å‘çš„ç³»æ•° aï¼Œå³ a**2 = fx / W</span></span><br><span class="line">                    coe_x = torch.tensor(np.sqrt(init_focal / <span class="built_in">float</span>(W)), requires_grad=<span class="literal">False</span>).<span class="built_in">float</span>()</span><br><span class="line">                    <span class="comment"># æ ¹æ®å…¬å¼ a**2 * H = fy è®¡ç®— y æ–¹å‘çš„ç³»æ•° aï¼Œå³ a**2 = fy / H</span></span><br><span class="line">                    coe_y = torch.tensor(np.sqrt(init_focal / <span class="built_in">float</span>(H)), requires_grad=<span class="literal">False</span>).<span class="built_in">float</span>()</span><br><span class="line">                <span class="keyword">elif</span> <span class="variable language_">self</span>.order == <span class="number">1</span>:</span><br><span class="line">                    <span class="comment"># æ ¹æ®å…¬å¼ a * W = fx è®¡ç®— x æ–¹å‘çš„ç³»æ•° aï¼Œå³ a = fx / W</span></span><br><span class="line">                    coe_x = torch.tensor(init_focal / <span class="built_in">float</span>(W), requires_grad=<span class="literal">False</span>).<span class="built_in">float</span>()</span><br><span class="line">                    <span class="comment"># æ ¹æ®å…¬å¼ a * H = fy è®¡ç®— y æ–¹å‘çš„ç³»æ•° aï¼Œå³ a = fy / H</span></span><br><span class="line">                    coe_y = torch.tensor(init_focal / <span class="built_in">float</span>(H), requires_grad=<span class="literal">False</span>).<span class="built_in">float</span>()</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&#x27;ç„¦è·åˆå§‹åŒ–é˜¶æ•°éœ€è¦ä¸º 1 æˆ– 2ã€‚é€€å‡º&#x27;</span>)</span><br><span class="line">                    exit()</span><br><span class="line">                <span class="comment"># å°†è®¡ç®—å¾—åˆ°çš„ x æ–¹å‘ç³»æ•°ä½œä¸º fxï¼Œå¯æ ¹æ® req_grad è®¾ç½®æ˜¯å¦éœ€è¦æ¢¯åº¦</span></span><br><span class="line">                <span class="variable language_">self</span>.fx = nn.Parameter(coe_x, requires_grad=req_grad)  <span class="comment"># (1, )</span></span><br><span class="line">                <span class="comment"># å°†è®¡ç®—å¾—åˆ°çš„ y æ–¹å‘ç³»æ•°ä½œä¸º fyï¼Œå¯æ ¹æ® req_grad è®¾ç½®æ˜¯å¦éœ€è¦æ¢¯åº¦</span></span><br><span class="line">                <span class="variable language_">self</span>.fy = nn.Parameter(coe_y, requires_grad=req_grad)  <span class="comment"># (1, )</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, i=<span class="literal">None</span></span>):  <span class="comment"># å‚æ•° i=None åªæ˜¯ä¸ºäº†æ”¯æŒå¤š GPU è®­ç»ƒ</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.fx_only:</span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.order == <span class="number">2</span>:</span><br><span class="line">                <span class="comment"># æ ¹æ®å…¬å¼è®¡ç®— fx å’Œ fyï¼Œå› ä¸º fx_only ä¸º Trueï¼Œæ‰€ä»¥ fy ç­‰äº fx</span></span><br><span class="line">                fxfy = torch.stack([<span class="variable language_">self</span>.fx ** <span class="number">2</span> * <span class="variable language_">self</span>.W, <span class="variable language_">self</span>.fx ** <span class="number">2</span> * <span class="variable language_">self</span>.W])</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># æ ¹æ®å…¬å¼è®¡ç®— fx å’Œ fyï¼Œå› ä¸º fx_only ä¸º Trueï¼Œæ‰€ä»¥ fy ç­‰äº fx</span></span><br><span class="line">                fxfy = torch.stack([<span class="variable language_">self</span>.fx * <span class="variable language_">self</span>.W, <span class="variable language_">self</span>.fx * <span class="variable language_">self</span>.W])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.order == <span class="number">2</span>:</span><br><span class="line">                <span class="comment"># æ ¹æ®å…¬å¼è®¡ç®— fx å’Œ fy</span></span><br><span class="line">                fxfy = torch.stack([<span class="variable language_">self</span>.fx**<span class="number">2</span> * <span class="variable language_">self</span>.W, <span class="variable language_">self</span>.fy**<span class="number">2</span> * <span class="variable language_">self</span>.H])</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># æ ¹æ®å…¬å¼è®¡ç®— fx å’Œ fy</span></span><br><span class="line">                fxfy = torch.stack([<span class="variable language_">self</span>.fx * <span class="variable language_">self</span>.W, <span class="variable language_">self</span>.fy * <span class="variable language_">self</span>.H])</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.learn_distortion:</span><br><span class="line">            <span class="comment"># å¦‚æœè¦å­¦ä¹ ç•¸å˜å‚æ•°ï¼Œè¿”å›ç„¦è·å’Œç•¸å˜ç³»æ•°</span></span><br><span class="line">            <span class="keyword">return</span> fxfy, <span class="variable language_">self</span>.k1, <span class="variable language_">self</span>.k2</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># å¦åˆ™åªè¿”å›ç„¦è·</span></span><br><span class="line">            <span class="keyword">return</span> fxfy</span><br></pre></td></tr></table></figure>
<h4 id="layers-py">layers.py</h4>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ç‰ˆæƒæ‰€æœ‰ Niantic 2019ã€‚ä¸“åˆ©ç”³è¯·ä¸­ã€‚ä¿ç•™æ‰€æœ‰æƒåˆ©ã€‚</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># æœ¬è½¯ä»¶éµå¾ª Monodepth2 è®¸å¯è¯çš„æ¡æ¬¾ï¼Œ</span></span><br><span class="line"><span class="comment"># è¯¥è®¸å¯è¯ä»…å…è®¸éå•†ä¸šç”¨é€”ï¼Œå®Œæ•´æ¡æ¬¾å¯åœ¨ LICENSE æ–‡ä»¶ä¸­è·å–ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> absolute_import, division, print_function</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†ç½‘ç»œçš„ sigmoid è¾“å‡ºè½¬æ¢ä¸ºæ·±åº¦é¢„æµ‹</span></span><br><span class="line"><span class="comment"># æ­¤è½¬æ¢å…¬å¼åœ¨è®ºæ–‡çš„â€œé¢å¤–è€ƒè™‘â€éƒ¨åˆ†ç»™å‡º</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">disp_to_depth</span>(<span class="params">disp, min_depth, max_depth</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    å°†ç½‘ç»œçš„ sigmoid è¾“å‡ºè½¬æ¢ä¸ºæ·±åº¦é¢„æµ‹</span></span><br><span class="line"><span class="string">    è¯¥è½¬æ¢å…¬å¼åœ¨è®ºæ–‡çš„â€œé¢å¤–è€ƒè™‘â€éƒ¨åˆ†ç»™å‡ºã€‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># æœ€å°è§†å·®ï¼Œä¸ºæœ€å¤§æ·±åº¦çš„å€’æ•°</span></span><br><span class="line">    min_disp = <span class="number">1</span> / max_depth</span><br><span class="line">    <span class="comment"># æœ€å¤§è§†å·®ï¼Œä¸ºæœ€å°æ·±åº¦çš„å€’æ•°</span></span><br><span class="line">    max_disp = <span class="number">1</span> / min_depth</span><br><span class="line">    <span class="comment"># ç¼©æ”¾åçš„è§†å·®</span></span><br><span class="line">    scaled_disp = min_disp + (max_disp - min_disp) * disp</span><br><span class="line">    <span class="comment"># æ·±åº¦å€¼ï¼Œä¸ºç¼©æ”¾åè§†å·®çš„å€’æ•°</span></span><br><span class="line">    depth = <span class="number">1</span> / scaled_disp</span><br><span class="line">    <span class="keyword">return</span> scaled_disp, depth</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†ç½‘ç»œè¾“å‡ºçš„ (è½´è§’, å¹³ç§») è½¬æ¢ä¸º 4x4 çŸ©é˜µ</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">transformation_from_parameters</span>(<span class="params">axisangle, translation, invert=<span class="literal">False</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å°†ç½‘ç»œçš„ (è½´è§’, å¹³ç§») è¾“å‡ºè½¬æ¢ä¸º 4x4 çŸ©é˜µ</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># ä»è½´è§’è¡¨ç¤ºè½¬æ¢ä¸ºæ—‹è½¬çŸ©é˜µ</span></span><br><span class="line">    R = rot_from_axisangle(axisangle)</span><br><span class="line">    <span class="comment"># å…‹éš†å¹³ç§»å‘é‡</span></span><br><span class="line">    t = translation.clone()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> invert:</span><br><span class="line">        <span class="comment"># å¦‚æœéœ€è¦åè½¬ï¼Œå¯¹æ—‹è½¬çŸ©é˜µè¿›è¡Œè½¬ç½®</span></span><br><span class="line">        R = R.transpose(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">        <span class="comment"># å¹³ç§»å‘é‡å–è´Ÿ</span></span><br><span class="line">        t *= -<span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># å°†å¹³ç§»å‘é‡è½¬æ¢ä¸º 4x4 å˜æ¢çŸ©é˜µ</span></span><br><span class="line">    T = get_translation_matrix(t)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> invert:</span><br><span class="line">        <span class="comment"># å¦‚æœéœ€è¦åè½¬ï¼Œå…ˆæ—‹è½¬å†å¹³ç§»</span></span><br><span class="line">        M = torch.matmul(R, T)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># æ­£å¸¸æƒ…å†µä¸‹ï¼Œå…ˆå¹³ç§»å†æ—‹è½¬</span></span><br><span class="line">        M = torch.matmul(T, R)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> M</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†å¹³ç§»å‘é‡è½¬æ¢ä¸º 4x4 å˜æ¢çŸ©é˜µ</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_translation_matrix</span>(<span class="params">translation_vector</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å°†å¹³ç§»å‘é‡è½¬æ¢ä¸º 4x4 å˜æ¢çŸ©é˜µ</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># åˆå§‹åŒ–ä¸€ä¸ªå…¨é›¶çš„ 4x4 çŸ©é˜µï¼Œå½¢çŠ¶ä¸º (batch_size, 4, 4)</span></span><br><span class="line">    T = torch.zeros(translation_vector.shape[<span class="number">0</span>], <span class="number">4</span>, <span class="number">4</span>).to(device=translation_vector.device)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å°†å¹³ç§»å‘é‡è°ƒæ•´ä¸º (batch_size, 3, 1) çš„å½¢çŠ¶</span></span><br><span class="line">    t = translation_vector.contiguous().view(-<span class="number">1</span>, <span class="number">3</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è®¾ç½®çŸ©é˜µçš„å¯¹è§’å…ƒç´ ä¸º 1</span></span><br><span class="line">    T[:, <span class="number">0</span>, <span class="number">0</span>] = <span class="number">1</span></span><br><span class="line">    T[:, <span class="number">1</span>, <span class="number">1</span>] = <span class="number">1</span></span><br><span class="line">    T[:, <span class="number">2</span>, <span class="number">2</span>] = <span class="number">1</span></span><br><span class="line">    T[:, <span class="number">3</span>, <span class="number">3</span>] = <span class="number">1</span></span><br><span class="line">    <span class="comment"># å°†å¹³ç§»å‘é‡æ·»åŠ åˆ°çŸ©é˜µçš„æœ€åä¸€åˆ—</span></span><br><span class="line">    T[:, :<span class="number">3</span>, <span class="number">3</span>, <span class="literal">None</span>] = t</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> T</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†è½´è§’æ—‹è½¬è¡¨ç¤ºè½¬æ¢ä¸º 4x4 å˜æ¢çŸ©é˜µ</span></span><br><span class="line"><span class="comment"># ï¼ˆæ”¹ç¼–è‡ª https://github.com/Wallacoloo/printipiï¼‰</span></span><br><span class="line"><span class="comment"># è¾“å…¥ &#x27;vec&#x27; å¿…é¡»æ˜¯ Bx1x3 çš„å½¢çŠ¶</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rot_from_axisangle</span>(<span class="params">vec</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å°†è½´è§’æ—‹è½¬è¡¨ç¤ºè½¬æ¢ä¸º 4x4 å˜æ¢çŸ©é˜µ</span></span><br><span class="line"><span class="string">    ï¼ˆæ”¹ç¼–è‡ª https://github.com/Wallacoloo/printipiï¼‰</span></span><br><span class="line"><span class="string">    è¾“å…¥ &#x27;vec&#x27; å¿…é¡»æ˜¯ Bx1x3 çš„å½¢çŠ¶</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># è®¡ç®—è½´è§’çš„æ¨¡é•¿</span></span><br><span class="line">    angle = torch.norm(vec, <span class="number">2</span>, <span class="number">2</span>, <span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># è®¡ç®—å•ä½è½´å‘é‡</span></span><br><span class="line">    axis = vec / (angle + <span class="number">1e-7</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è®¡ç®—è§’åº¦çš„ä½™å¼¦å€¼</span></span><br><span class="line">    ca = torch.cos(angle)</span><br><span class="line">    <span class="comment"># è®¡ç®—è§’åº¦çš„æ­£å¼¦å€¼</span></span><br><span class="line">    sa = torch.sin(angle)</span><br><span class="line">    <span class="comment"># è®¡ç®— 1 - cos(angle)</span></span><br><span class="line">    C = <span class="number">1</span> - ca</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æå–è½´å‘é‡çš„ x åˆ†é‡ï¼Œå¹¶å¢åŠ ä¸€ä¸ªç»´åº¦</span></span><br><span class="line">    x = axis[..., <span class="number">0</span>].unsqueeze(<span class="number">1</span>)</span><br><span class="line">    <span class="comment"># æå–è½´å‘é‡çš„ y åˆ†é‡ï¼Œå¹¶å¢åŠ ä¸€ä¸ªç»´åº¦</span></span><br><span class="line">    y = axis[..., <span class="number">1</span>].unsqueeze(<span class="number">1</span>)</span><br><span class="line">    <span class="comment"># æå–è½´å‘é‡çš„ z åˆ†é‡ï¼Œå¹¶å¢åŠ ä¸€ä¸ªç»´åº¦</span></span><br><span class="line">    z = axis[..., <span class="number">2</span>].unsqueeze(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è®¡ç®— x * sin(angle)</span></span><br><span class="line">    xs = x * sa</span><br><span class="line">    <span class="comment"># è®¡ç®— y * sin(angle)</span></span><br><span class="line">    ys = y * sa</span><br><span class="line">    <span class="comment"># è®¡ç®— z * sin(angle)</span></span><br><span class="line">    zs = z * sa</span><br><span class="line">    <span class="comment"># è®¡ç®— x * (1 - cos(angle))</span></span><br><span class="line">    xC = x * C</span><br><span class="line">    <span class="comment"># è®¡ç®— y * (1 - cos(angle))</span></span><br><span class="line">    yC = y * C</span><br><span class="line">    <span class="comment"># è®¡ç®— z * (1 - cos(angle))</span></span><br><span class="line">    zC = z * C</span><br><span class="line">    <span class="comment"># è®¡ç®— x * y * (1 - cos(angle))</span></span><br><span class="line">    xyC = x * yC</span><br><span class="line">    <span class="comment"># è®¡ç®— y * z * (1 - cos(angle))</span></span><br><span class="line">    yzC = y * zC</span><br><span class="line">    <span class="comment"># è®¡ç®— z * x * (1 - cos(angle))</span></span><br><span class="line">    zxC = z * xC</span><br><span class="line"></span><br><span class="line">    <span class="comment"># åˆå§‹åŒ–ä¸€ä¸ªå…¨é›¶çš„ 4x4 æ—‹è½¬çŸ©é˜µï¼Œå½¢çŠ¶ä¸º (batch_size, 4, 4)</span></span><br><span class="line">    rot = torch.zeros((vec.shape[<span class="number">0</span>], <span class="number">4</span>, <span class="number">4</span>)).to(device=vec.device)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è®¾ç½®æ—‹è½¬çŸ©é˜µçš„å…ƒç´ </span></span><br><span class="line">    rot[:, <span class="number">0</span>, <span class="number">0</span>] = torch.squeeze(x * xC + ca)</span><br><span class="line">    rot[:, <span class="number">0</span>, <span class="number">1</span>] = torch.squeeze(xyC - zs)</span><br><span class="line">    rot[:, <span class="number">0</span>, <span class="number">2</span>] = torch.squeeze(zxC + ys)</span><br><span class="line">    rot[:, <span class="number">1</span>, <span class="number">0</span>] = torch.squeeze(xyC + zs)</span><br><span class="line">    rot[:, <span class="number">1</span>, <span class="number">1</span>] = torch.squeeze(y * yC + ca)</span><br><span class="line">    rot[:, <span class="number">1</span>, <span class="number">2</span>] = torch.squeeze(yzC - xs)</span><br><span class="line">    rot[:, <span class="number">2</span>, <span class="number">0</span>] = torch.squeeze(zxC - ys)</span><br><span class="line">    rot[:, <span class="number">2</span>, <span class="number">1</span>] = torch.squeeze(yzC + xs)</span><br><span class="line">    rot[:, <span class="number">2</span>, <span class="number">2</span>] = torch.squeeze(z * zC + ca)</span><br><span class="line">    rot[:, <span class="number">3</span>, <span class="number">3</span>] = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rot</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ä¸€ä¸ªå·ç§¯å—ï¼ŒåŒ…å«å·ç§¯å±‚ã€æ‰¹é‡å½’ä¸€åŒ–å±‚å’Œ ELU æ¿€æ´»å‡½æ•°</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ConvBlock</span>(nn.Module):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;æ‰§è¡Œå·ç§¯åæ¥ ELU çš„å±‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, in_channels, out_channels</span>):</span><br><span class="line">        <span class="built_in">super</span>(ConvBlock, <span class="variable language_">self</span>).__init__()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 3x3 å·ç§¯å±‚</span></span><br><span class="line">        <span class="variable language_">self</span>.conv = Conv3x3(in_channels, out_channels)</span><br><span class="line">        <span class="comment"># ELU æ¿€æ´»å‡½æ•°ï¼ŒåŸåœ°æ“ä½œ</span></span><br><span class="line">        <span class="variable language_">self</span>.nonlin = nn.ELU(inplace=<span class="literal">True</span>)</span><br><span class="line">        <span class="comment"># æ‰¹é‡å½’ä¸€åŒ–å±‚</span></span><br><span class="line">        <span class="variable language_">self</span>.bn = nn.BatchNorm2d(out_channels)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        <span class="comment"># é€šè¿‡å·ç§¯å±‚</span></span><br><span class="line">        out = <span class="variable language_">self</span>.conv(x)</span><br><span class="line">        <span class="comment"># é€šè¿‡æ‰¹é‡å½’ä¸€åŒ–å±‚</span></span><br><span class="line">        out = <span class="variable language_">self</span>.bn(out)</span><br><span class="line">        <span class="comment"># é€šè¿‡ ELU æ¿€æ´»å‡½æ•°</span></span><br><span class="line">        out = <span class="variable language_">self</span>.nonlin(out)</span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ä¸€ä¸ª 3x3 å·ç§¯å±‚ï¼ŒåŒ…å«å¡«å……æ“ä½œ</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Conv3x3</span>(nn.Module):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å¯¹è¾“å…¥è¿›è¡Œå¡«å……å’Œå·ç§¯çš„å±‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, in_channels, out_channels, use_refl=<span class="literal">True</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(Conv3x3, <span class="variable language_">self</span>).__init__()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> use_refl:</span><br><span class="line">            <span class="comment"># ä½¿ç”¨åå°„å¡«å……</span></span><br><span class="line">            <span class="variable language_">self</span>.pad = nn.ReflectionPad2d(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># ä½¿ç”¨é›¶å¡«å……</span></span><br><span class="line">            <span class="variable language_">self</span>.pad = nn.ZeroPad2d(<span class="number">1</span>)</span><br><span class="line">        <span class="comment"># 3x3 å·ç§¯å±‚</span></span><br><span class="line">        <span class="variable language_">self</span>.conv = nn.Conv2d(<span class="built_in">int</span>(in_channels), <span class="built_in">int</span>(out_channels), <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        <span class="comment"># è¿›è¡Œå¡«å……æ“ä½œ</span></span><br><span class="line">        out = <span class="variable language_">self</span>.pad(x)</span><br><span class="line">        <span class="comment"># è¿›è¡Œå·ç§¯æ“ä½œ</span></span><br><span class="line">        out = <span class="variable language_">self</span>.conv(out)</span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†æ·±åº¦å›¾åƒè½¬æ¢ä¸ºç‚¹äº‘çš„å±‚</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BackprojectDepth</span>(nn.Module):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å°†æ·±åº¦å›¾åƒè½¬æ¢ä¸ºç‚¹äº‘çš„å±‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, batch_size, height, width</span>):</span><br><span class="line">        <span class="built_in">super</span>(BackprojectDepth, <span class="variable language_">self</span>).__init__()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ‰¹é‡å¤§å°</span></span><br><span class="line">        <span class="variable language_">self</span>.batch_size = batch_size</span><br><span class="line">        <span class="comment"># å›¾åƒé«˜åº¦</span></span><br><span class="line">        <span class="variable language_">self</span>.height = height</span><br><span class="line">        <span class="comment"># å›¾åƒå®½åº¦</span></span><br><span class="line">        <span class="variable language_">self</span>.width = width</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ç”ŸæˆäºŒç»´ç½‘æ ¼åæ ‡</span></span><br><span class="line">        meshgrid = np.meshgrid(<span class="built_in">range</span>(<span class="variable language_">self</span>.width), <span class="built_in">range</span>(<span class="variable language_">self</span>.height), indexing=<span class="string">&#x27;xy&#x27;</span>)</span><br><span class="line">        <span class="comment"># å°†ç½‘æ ¼åæ ‡å †å åœ¨ä¸€èµ·ï¼Œå¹¶è½¬æ¢ä¸º float32 ç±»å‹</span></span><br><span class="line">        <span class="variable language_">self</span>.id_coords = np.stack(meshgrid, axis=<span class="number">0</span>).astype(np.float32)</span><br><span class="line">        <span class="comment"># å°†ç½‘æ ¼åæ ‡è½¬æ¢ä¸º PyTorch å¼ é‡ï¼Œå¹¶è®¾ç½®ä¸ºä¸éœ€è¦æ¢¯åº¦</span></span><br><span class="line">        <span class="variable language_">self</span>.id_coords = nn.Parameter(torch.from_numpy(<span class="variable language_">self</span>.id_coords),</span><br><span class="line">                                      requires_grad=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># åˆå§‹åŒ–ä¸€ä¸ªå…¨ä¸º 1 çš„å¼ é‡ï¼Œå½¢çŠ¶ä¸º (batch_size, 1, height * width)ï¼Œå¹¶è®¾ç½®ä¸ºä¸éœ€è¦æ¢¯åº¦</span></span><br><span class="line">        <span class="variable language_">self</span>.ones = nn.Parameter(torch.ones(<span class="variable language_">self</span>.batch_size, <span class="number">1</span>, <span class="variable language_">self</span>.height * <span class="variable language_">self</span>.width),</span><br><span class="line">                                 requires_grad=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è°ƒæ•´ç½‘æ ¼åæ ‡çš„å½¢çŠ¶ï¼Œå¹¶é‡å¤ batch_size æ¬¡</span></span><br><span class="line">        <span class="variable language_">self</span>.pix_coords = torch.unsqueeze(torch.stack(</span><br><span class="line">            [<span class="variable language_">self</span>.id_coords[<span class="number">0</span>].view(-<span class="number">1</span>), <span class="variable language_">self</span>.id_coords[<span class="number">1</span>].view(-<span class="number">1</span>)], <span class="number">0</span>), <span class="number">0</span>)</span><br><span class="line">        <span class="variable language_">self</span>.pix_coords = <span class="variable language_">self</span>.pix_coords.repeat(batch_size, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="comment"># å°†ç½‘æ ¼åæ ‡å’Œå…¨ 1 å¼ é‡æ‹¼æ¥åœ¨ä¸€èµ·ï¼Œå¹¶è®¾ç½®ä¸ºä¸éœ€è¦æ¢¯åº¦</span></span><br><span class="line">        <span class="variable language_">self</span>.pix_coords = nn.Parameter(torch.cat([<span class="variable language_">self</span>.pix_coords, <span class="variable language_">self</span>.ones], <span class="number">1</span>),</span><br><span class="line">                                       requires_grad=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, depth, inv_K</span>):</span><br><span class="line">        <span class="comment"># å°†é€†ç›¸æœºå†…å‚çŸ©é˜µä¸åƒç´ åæ ‡ç›¸ä¹˜</span></span><br><span class="line">        cam_points = torch.matmul(inv_K[:, :<span class="number">3</span>, :<span class="number">3</span>], <span class="variable language_">self</span>.pix_coords)</span><br><span class="line">        <span class="comment"># å°†æ·±åº¦å€¼ä¸ç›¸æœºåæ ‡ç›¸ä¹˜</span></span><br><span class="line">        cam_points = depth.view(<span class="variable language_">self</span>.batch_size, <span class="number">1</span>, -<span class="number">1</span>) * cam_points</span><br><span class="line">        <span class="comment"># å°†ç›¸æœºåæ ‡å’Œå…¨ 1 å¼ é‡æ‹¼æ¥åœ¨ä¸€èµ·</span></span><br><span class="line">        cam_points = torch.cat([cam_points, <span class="variable language_">self</span>.ones], <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> cam_points</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°† 3D ç‚¹æŠ•å½±åˆ°å…·æœ‰å†…å‚ K å’Œä½ç½® T çš„ç›¸æœºä¸­çš„å±‚</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Project3D</span>(nn.Module):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å°† 3D ç‚¹æŠ•å½±åˆ°å…·æœ‰å†…å‚ K å’Œä½ç½® T çš„ç›¸æœºä¸­çš„å±‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, batch_size, height, width, eps=<span class="number">1e-7</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(Project3D, <span class="variable language_">self</span>).__init__()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ‰¹é‡å¤§å°</span></span><br><span class="line">        <span class="variable language_">self</span>.batch_size = batch_size</span><br><span class="line">        <span class="comment"># å›¾åƒé«˜åº¦</span></span><br><span class="line">        <span class="variable language_">self</span>.height = height</span><br><span class="line">        <span class="comment"># å›¾åƒå®½åº¦</span></span><br><span class="line">        <span class="variable language_">self</span>.width = width</span><br><span class="line">        <span class="comment"># é˜²æ­¢é™¤é›¶çš„å°å¸¸æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.eps = eps</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, points, K, T</span>):</span><br><span class="line">        <span class="comment"># è®¡ç®—æŠ•å½±çŸ©é˜µ P</span></span><br><span class="line">        P = torch.matmul(K, T)[:, :<span class="number">3</span>, :]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å°†æŠ•å½±çŸ©é˜µ P ä¸ 3D ç‚¹ç›¸ä¹˜</span></span><br><span class="line">        cam_points = torch.matmul(P, points)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è®¡ç®—åƒç´ åæ ‡</span></span><br><span class="line">        pix_coords = cam_points[:, :<span class="number">2</span>, :] / (cam_points[:, <span class="number">2</span>, :].unsqueeze(<span class="number">1</span>) + <span class="variable language_">self</span>.eps)</span><br><span class="line">        <span class="comment"># è°ƒæ•´åƒç´ åæ ‡çš„å½¢çŠ¶</span></span><br><span class="line">        pix_coords = pix_coords.view(<span class="variable language_">self</span>.batch_size, <span class="number">2</span>, <span class="variable language_">self</span>.height, <span class="variable language_">self</span>.width)</span><br><span class="line">        <span class="comment"># äº¤æ¢ç»´åº¦</span></span><br><span class="line">        pix_coords = pix_coords.permute(<span class="number">0</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="comment"># å½’ä¸€åŒ–åƒç´ åæ ‡</span></span><br><span class="line">        pix_coords[..., <span class="number">0</span>] /= <span class="variable language_">self</span>.width - <span class="number">1</span></span><br><span class="line">        pix_coords[..., <span class="number">1</span>] /= <span class="variable language_">self</span>.height - <span class="number">1</span></span><br><span class="line">        <span class="comment"># å°†åƒç´ åæ ‡æ˜ å°„åˆ° [-1, 1] èŒƒå›´</span></span><br><span class="line">        pix_coords = (pix_coords - <span class="number">0.5</span>) * <span class="number">2</span></span><br><span class="line">        <span class="keyword">return</span> pix_coords</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†è¾“å…¥å¼ é‡ä¸Šé‡‡æ · 2 å€</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upsample</span>(<span class="params">x</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å°†è¾“å…¥å¼ é‡ä¸Šé‡‡æ · 2 å€</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> F.interpolate(x, scale_factor=<span class="number">2</span>, mode=<span class="string">&quot;nearest&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¡ç®—è§†å·®å›¾åƒçš„å¹³æ»‘æŸå¤±</span></span><br><span class="line"><span class="comment"># å½©è‰²å›¾åƒç”¨äºè¾¹ç¼˜æ„ŸçŸ¥å¹³æ»‘</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_smooth_loss</span>(<span class="params">disp, img</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;è®¡ç®—è§†å·®å›¾åƒçš„å¹³æ»‘æŸå¤±</span></span><br><span class="line"><span class="string">    å½©è‰²å›¾åƒç”¨äºè¾¹ç¼˜æ„ŸçŸ¥å¹³æ»‘</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># è®¡ç®—è§†å·®åœ¨ x æ–¹å‘çš„æ¢¯åº¦</span></span><br><span class="line">    grad_disp_x = torch.<span class="built_in">abs</span>(disp[:, :, :, :-<span class="number">1</span>] - disp[:, :, :, <span class="number">1</span>:])</span><br><span class="line">    <span class="comment"># è®¡ç®—è§†å·®åœ¨ y æ–¹å‘çš„æ¢¯åº¦</span></span><br><span class="line">    grad_disp_y = torch.<span class="built_in">abs</span>(disp[:, :, :-<span class="number">1</span>, :] - disp[:, :, <span class="number">1</span>:, :])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è®¡ç®—å›¾åƒåœ¨ x æ–¹å‘çš„å¹³å‡æ¢¯åº¦</span></span><br><span class="line">    grad_img_x = torch.mean(torch.<span class="built_in">abs</span>(img[:, :, :, :-<span class="number">1</span>] - img[:, :, :, <span class="number">1</span>:]), <span class="number">1</span>, keepdim=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># è®¡ç®—å›¾åƒåœ¨ y æ–¹å‘çš„å¹³å‡æ¢¯åº¦</span></span><br><span class="line">    grad_img_y = torch.mean(torch.<span class="built_in">abs</span>(img[:, :, :-<span class="number">1</span>, :] - img[:, :, <span class="number">1</span>:, :]), <span class="number">1</span>, keepdim=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ ¹æ®å›¾åƒæ¢¯åº¦å¯¹è§†å·®æ¢¯åº¦è¿›è¡ŒåŠ æƒ</span></span><br><span class="line">    grad_disp_x *= torch.exp(-grad_img_x)</span><br><span class="line">    grad_disp_y *= torch.exp(-grad_img_y)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è¿”å›è§†å·®æ¢¯åº¦çš„å¹³å‡å€¼</span></span><br><span class="line">    <span class="keyword">return</span> grad_disp_x.mean() + grad_disp_y.mean()</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¡ç®—ä¸€å¯¹å›¾åƒä¹‹é—´ SSIM æŸå¤±çš„å±‚</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SSIM</span>(nn.Module):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;è®¡ç®—ä¸€å¯¹å›¾åƒä¹‹é—´ SSIM æŸå¤±çš„å±‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>(SSIM, <span class="variable language_">self</span>).__init__()</span><br><span class="line">        <span class="comment"># 3x3 å¹³å‡æ± åŒ–å±‚ï¼Œç”¨äºè®¡ç®—å‡å€¼</span></span><br><span class="line">        <span class="variable language_">self</span>.mu_x_pool   = nn.AvgPool2d(<span class="number">3</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="variable language_">self</span>.mu_y_pool   = nn.AvgPool2d(<span class="number">3</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="comment"># 3x3 å¹³å‡æ± åŒ–å±‚ï¼Œç”¨äºè®¡ç®—æ–¹å·®</span></span><br><span class="line">        <span class="variable language_">self</span>.sig_x_pool  = nn.AvgPool2d(<span class="number">3</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="variable language_">self</span>.sig_y_pool  = nn.AvgPool2d(<span class="number">3</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="comment"># 3x3 å¹³å‡æ± åŒ–å±‚ï¼Œç”¨äºè®¡ç®—åæ–¹å·®</span></span><br><span class="line">        <span class="variable language_">self</span>.sig_xy_pool = nn.AvgPool2d(<span class="number">3</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># åå°„å¡«å……å±‚</span></span><br><span class="line">        <span class="variable language_">self</span>.refl = nn.ReflectionPad2d(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å¸¸æ•° C1</span></span><br><span class="line">        <span class="variable language_">self</span>.C1 = <span class="number">0.01</span> ** <span class="number">2</span></span><br><span class="line">        <span class="comment"># å¸¸æ•° C2</span></span><br><span class="line">        <span class="variable language_">self</span>.C2 = <span class="number">0.03</span> ** <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x, y</span>):</span><br><span class="line">        <span class="comment"># å¯¹è¾“å…¥å›¾åƒè¿›è¡Œåå°„å¡«å……</span></span><br><span class="line">        x = <span class="variable language_">self</span>.refl(x)</span><br><span class="line">        y = <span class="variable language_">self</span>.refl(y)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è®¡ç®—å›¾åƒ x çš„å‡å€¼</span></span><br><span class="line">        mu_x = <span class="variable language_">self</span>.mu_x_pool(x)</span><br><span class="line">        <span class="comment"># è®¡ç®—å›¾åƒ y çš„å‡å€¼</span></span><br><span class="line">        mu_y = <span class="variable language_">self</span>.mu_y_pool(y)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è®¡ç®—å›¾åƒ x çš„æ–¹å·®</span></span><br><span class="line">        sigma_x  = <span class="variable language_">self</span>.sig_x_pool(x ** <span class="number">2</span>) - mu_x ** <span class="number">2</span></span><br><span class="line">        <span class="comment"># è®¡ç®—å›¾åƒ y çš„æ–¹å·®</span></span><br><span class="line">        sigma_y  = <span class="variable language_">self</span>.sig_y_pool(y ** <span class="number">2</span>) - mu_y ** <span class="number">2</span></span><br><span class="line">        <span class="comment"># è®¡ç®—å›¾åƒ x å’Œ y çš„åæ–¹å·®</span></span><br><span class="line">        sigma_xy = <span class="variable language_">self</span>.sig_xy_pool(x * y) - mu_x * mu_y</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è®¡ç®— SSIM åˆ†å­</span></span><br><span class="line">        SSIM_n = (<span class="number">2</span> * mu_x * mu_y + <span class="variable language_">self</span>.C1) * (<span class="number">2</span> * sigma_xy + <span class="variable language_">self</span>.C2)</span><br><span class="line">        <span class="comment"># è®¡ç®— SSIM åˆ†æ¯</span></span><br><span class="line">        SSIM_d = (mu_x ** <span class="number">2</span> + mu_y ** <span class="number">2</span> + <span class="variable language_">self</span>.C1) * (sigma_x + sigma_y + <span class="variable language_">self</span>.C2)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è®¡ç®— SSIM æŸå¤±ï¼Œå¹¶å°†ç»“æœé™åˆ¶åœ¨ [0, 1] èŒƒå›´å†…</span></span><br><span class="line">        <span class="keyword">return</span> torch.clamp((<span class="number">1</span> - SSIM_n / SSIM_d) / <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¡ç®—é¢„æµ‹æ·±åº¦å’ŒçœŸå®æ·±åº¦ä¹‹é—´çš„è¯¯å·®æŒ‡æ ‡</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">compute_depth_errors</span>(<span class="params">gt, pred</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;è®¡ç®—é¢„æµ‹æ·±åº¦å’ŒçœŸå®æ·±åº¦ä¹‹é—´çš„è¯¯å·®æŒ‡æ ‡</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># è®¡ç®—é¢„æµ‹æ·±åº¦å’ŒçœŸå®æ·±åº¦çš„æ¯”å€¼çš„æœ€å¤§å€¼</span></span><br><span class="line">    thresh = torch.<span class="built_in">max</span>((gt / pred), (pred / gt))</span><br><span class="line">    <span class="comment"># è®¡ç®—é˜ˆå€¼å°äº 1.25 çš„æ¯”ä¾‹</span></span><br><span class="line">    a1 = (thresh &lt; <span class="number">1.25</span>     ).<span class="built_in">float</span>().mean()</span><br><span class="line">    <span class="comment"># è®¡ç®—é˜ˆå€¼å°äº 1.25^2 çš„æ¯”ä¾‹</span></span><br><span class="line">    a2 = (thresh &lt; <span class="number">1.25</span> ** <span class="number">2</span>).<span class="built_in">float</span>().mean()</span><br><span class="line">    <span class="comment"># è®¡ç®—é˜ˆå€¼å°äº 1.25^3 çš„æ¯”ä¾‹</span></span><br><span class="line">    a3 = (thresh &lt; <span class="number">1.25</span> ** <span class="number">3</span>).<span class="built_in">float</span>().mean()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è®¡ç®—å‡æ–¹è¯¯å·®</span></span><br><span class="line">    rmse = (gt - pred) ** <span class="number">2</span></span><br><span class="line">    rmse = torch.sqrt(rmse.mean())</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è®¡ç®—å¯¹æ•°å‡æ–¹è¯¯å·®</span></span><br><span class="line">    rmse_log = (torch.log(gt) - torch.log(pred)) ** <span class="number">2</span></span><br><span class="line">    rmse_log = torch.sqrt(rmse_log.mean())</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è®¡ç®—ç»å¯¹ç›¸å¯¹è¯¯å·®</span></span><br><span class="line">    abs_rel = torch.mean(torch.<span class="built_in">abs</span>(gt - pred) / gt)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è®¡ç®—å¹³æ–¹ç›¸å¯¹è¯¯å·®</span></span><br><span class="line">    sq_rel = torch.mean((gt - pred) ** <span class="number">2</span> / gt)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> abs_rel, sq_rel, rmse, rmse_log, a</span><br></pre></td></tr></table></figure>
<h4 id="nerf-feature-py">nerf_feature.py</h4>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.nn.parallel</span><br><span class="line"><span class="keyword">import</span> torch.utils.data</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ä¸€ä¸ªåä¸º NerfWFeatures çš„ç¥ç»ç½‘ç»œæ¨¡å—</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NerfWFeatures</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, pos_in_dims, dir_in_dims, D</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        :param pos_in_dims: æ ‡é‡ï¼Œç¼–ç åä½ç½®çš„é€šé“æ•°</span></span><br><span class="line"><span class="string">        :param dir_in_dims: æ ‡é‡ï¼Œç¼–ç åæ–¹å‘çš„é€šé“æ•°</span></span><br><span class="line"><span class="string">        :param D:           æ ‡é‡ï¼Œéšè—å±‚çš„ç»´åº¦æ•°</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># è°ƒç”¨çˆ¶ç±» nn.Module çš„æ„é€ å‡½æ•°</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å­˜å‚¨ç¼–ç åä½ç½®çš„é€šé“æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.pos_in_dims = pos_in_dims</span><br><span class="line">        <span class="comment"># å­˜å‚¨ç¼–ç åæ–¹å‘çš„é€šé“æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.dir_in_dims = dir_in_dims</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å®šä¹‰ç¬¬ä¸€å±‚ç¥ç»ç½‘ç»œå—ï¼ŒåŒ…å«å››ä¸ªçº¿æ€§å±‚å’Œ ReLU æ¿€æ´»å‡½æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.layers0 = nn.Sequential(</span><br><span class="line">            nn.Linear(pos_in_dims, D), nn.ReLU(),</span><br><span class="line">            nn.Linear(D, D), nn.ReLU(),</span><br><span class="line">            nn.Linear(D, D), nn.ReLU(),</span><br><span class="line">            nn.Linear(D, D), nn.ReLU(),</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å®šä¹‰ç¬¬äºŒå±‚ç¥ç»ç½‘ç»œå—ï¼ŒåŒ…å«å››ä¸ªçº¿æ€§å±‚å’Œ ReLU æ¿€æ´»å‡½æ•°ï¼Œæœ‰ä¸€ä¸ªè·³è·ƒè¿æ¥</span></span><br><span class="line">        <span class="variable language_">self</span>.layers1 = nn.Sequential(</span><br><span class="line">            nn.Linear(D + pos_in_dims + <span class="number">32</span>, D), nn.ReLU(),  <span class="comment"># è·³è·ƒè¿æ¥</span></span><br><span class="line">            nn.Linear(D, D), nn.ReLU(),</span><br><span class="line">            nn.Linear(D, D), nn.ReLU(),</span><br><span class="line">            nn.Linear(D, D), nn.ReLU(),</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å®šä¹‰ç”¨äºè®¡ç®—å¯†åº¦çš„å…¨è¿æ¥å±‚ï¼Œæœ€åä½¿ç”¨ Softplus æ¿€æ´»å‡½æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.fc_density = nn.Sequential(</span><br><span class="line">            nn.Linear(D, <span class="number">1</span>), nn.Softplus()</span><br><span class="line">        )</span><br><span class="line">        <span class="comment"># å®šä¹‰ç”¨äºæå–ç‰¹å¾çš„å…¨è¿æ¥å±‚</span></span><br><span class="line">        <span class="variable language_">self</span>.fc_feature = nn.Sequential(</span><br><span class="line">            nn.Linear(D, D)</span><br><span class="line">        )</span><br><span class="line">        <span class="comment"># å®šä¹‰ç”¨äºå¤„ç†ç‰¹å¾å’Œæ–¹å‘ä¿¡æ¯ä»¥ç”Ÿæˆä¸­é—´ç‰¹å¾çš„å±‚</span></span><br><span class="line">        <span class="variable language_">self</span>.rgb_layers = nn.Sequential(nn.Linear(D + dir_in_dims, D // <span class="number">2</span>), nn.ReLU())</span><br><span class="line">        <span class="comment"># å®šä¹‰ç”¨äºä»ä¸­é—´ç‰¹å¾ç”Ÿæˆ RGB é¢œè‰²çš„å…¨è¿æ¥å±‚</span></span><br><span class="line">        <span class="variable language_">self</span>.fc_rgb = nn.Sequential(nn.Linear(D // <span class="number">2</span>, <span class="number">3</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ä»¥ä¸‹ä»£ç è¢«æ³¨é‡Šæ‰ï¼ŒåŸæœ¬ç”¨äºåˆå§‹åŒ–åç½®</span></span><br><span class="line">        <span class="comment"># self.fc_density[0].bias.data = torch.tensor([0.1]).float()</span></span><br><span class="line">        <span class="comment"># self.fc_rgb[0].bias.data = torch.tensor([0.02, 0.02, 0.02]).float()</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, pos_enc, dir_enc, cost_volume</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        :param pos_enc: (H, W, N_sample, pos_in_dims) ç¼–ç åçš„ä½ç½®</span></span><br><span class="line"><span class="string">        :param dir_enc: (H, W, N_sample, dir_in_dims) ç¼–ç åçš„æ–¹å‘</span></span><br><span class="line"><span class="string">        :return: rgb_density (H, W, N_sample, 4)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># é€šè¿‡ç¬¬ä¸€å±‚ç¥ç»ç½‘ç»œå—å¤„ç†ç¼–ç åçš„ä½ç½®</span></span><br><span class="line">        x = <span class="variable language_">self</span>.layers0(pos_enc)  <span class="comment"># (H, W, N_sample, D)</span></span><br><span class="line">        <span class="comment"># å°†å¤„ç†åçš„ç»“æœã€åŸå§‹ç¼–ç ä½ç½®å’Œä»£ä»·ä½“è¿›è¡Œæ‹¼æ¥</span></span><br><span class="line">        x = torch.cat([x, pos_enc, cost_volume], dim=<span class="number">3</span>)  <span class="comment"># (H, W, N_sample, D+pos_in_dims)</span></span><br><span class="line">        <span class="comment"># é€šè¿‡ç¬¬äºŒå±‚ç¥ç»ç½‘ç»œå—å¤„ç†æ‹¼æ¥åçš„ç»“æœ</span></span><br><span class="line">        x = <span class="variable language_">self</span>.layers1(x)  <span class="comment"># (H, W, N_sample, D)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># è®¡ç®—å¯†åº¦</span></span><br><span class="line">        density = <span class="variable language_">self</span>.fc_density(x)  <span class="comment"># (H, W, N_sample, 1)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># æå–ç‰¹å¾</span></span><br><span class="line">        feat = <span class="variable language_">self</span>.fc_feature(x)  <span class="comment"># (H, W, N_sample, D)</span></span><br><span class="line">        <span class="comment"># å°†æå–çš„ç‰¹å¾å’Œç¼–ç åçš„æ–¹å‘è¿›è¡Œæ‹¼æ¥</span></span><br><span class="line">        x = torch.cat([feat, dir_enc], dim=<span class="number">3</span>)  <span class="comment"># (H, W, N_sample, D+dir_in_dims)</span></span><br><span class="line">        <span class="comment"># é€šè¿‡ rgb_layers å±‚å¤„ç†æ‹¼æ¥åçš„ç»“æœ</span></span><br><span class="line">        x = <span class="variable language_">self</span>.rgb_layers(x)  <span class="comment"># (H, W, N_sample, D/2)</span></span><br><span class="line">        <span class="comment"># ç”Ÿæˆ RGB é¢œè‰²</span></span><br><span class="line">        rgb = <span class="variable language_">self</span>.fc_rgb(x)  <span class="comment"># (H, W, N_sample, 3)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># å°† RGB é¢œè‰²å’Œå¯†åº¦è¿›è¡Œæ‹¼æ¥</span></span><br><span class="line">        rgb_den = torch.cat([rgb, density], dim=<span class="number">3</span>)  <span class="comment"># (H, W, N_sample, 4)</span></span><br><span class="line">        <span class="keyword">return</span> rgb_den</span><br></pre></td></tr></table></figure>
<h4 id="nerf-mask-py">nerf_mask.py</h4>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.nn.parallel</span><br><span class="line"><span class="keyword">import</span> torch.utils.data</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ä¸€ä¸ªåä¸º OfficialNerf çš„ç¥ç»ç½‘ç»œæ¨¡å—ï¼Œç»§æ‰¿è‡ª nn.Module</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OfficialNerf</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, pos_in_dims, dir_in_dims, D</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        :param pos_in_dims: æ ‡é‡ï¼Œç¼–ç åä½ç½®çš„é€šé“æ•°</span></span><br><span class="line"><span class="string">        :param dir_in_dims: æ ‡é‡ï¼Œç¼–ç åæ–¹å‘çš„é€šé“æ•°</span></span><br><span class="line"><span class="string">        :param D: æ ‡é‡ï¼Œéšè—å±‚çš„ç»´åº¦æ•°</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># è°ƒç”¨çˆ¶ç±»çš„æ„é€ å‡½æ•°</span></span><br><span class="line">        <span class="built_in">super</span>(OfficialNerf, <span class="variable language_">self</span>).__init__()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å­˜å‚¨ç¼–ç åä½ç½®çš„é€šé“æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.pos_in_dims = pos_in_dims</span><br><span class="line">        <span class="comment"># å­˜å‚¨ç¼–ç åæ–¹å‘çš„é€šé“æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.dir_in_dims = dir_in_dims</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å®šä¹‰ç¬¬ä¸€å±‚ç¥ç»ç½‘ç»œåºåˆ—ï¼ŒåŒ…å«å››ä¸ªçº¿æ€§å±‚å’Œ ReLU æ¿€æ´»å‡½æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.layers0 = nn.Sequential(</span><br><span class="line">            nn.Linear(pos_in_dims, D), nn.ReLU(),</span><br><span class="line">            nn.Linear(D, D), nn.ReLU(),</span><br><span class="line">            nn.Linear(D, D), nn.ReLU(),</span><br><span class="line">            nn.Linear(D, D), nn.ReLU(),</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å®šä¹‰ç¬¬äºŒå±‚ç¥ç»ç½‘ç»œåºåˆ—ï¼ŒåŒ…å«å››ä¸ªçº¿æ€§å±‚å’Œ ReLU æ¿€æ´»å‡½æ•°ï¼Œæœ‰ä¸€ä¸ªè·³è·ƒè¿æ¥</span></span><br><span class="line">        <span class="variable language_">self</span>.layers1 = nn.Sequential(</span><br><span class="line">            nn.Linear(D + pos_in_dims, D), nn.ReLU(),  <span class="comment"># è·³è·ƒè¿æ¥</span></span><br><span class="line">            nn.Linear(D, D), nn.ReLU(),</span><br><span class="line">            nn.Linear(D, D), nn.ReLU(),</span><br><span class="line">            nn.Linear(D, D), nn.ReLU(),</span><br><span class="line">        )</span><br><span class="line">        <span class="comment"># å®šä¹‰æ©ç ç½‘ç»œï¼ŒåŒ…å«ä¸¤ä¸ªçº¿æ€§å±‚ï¼Œä¸­é—´æœ‰ ReLU æ¿€æ´»å‡½æ•°ï¼Œæœ€åæœ‰ Sigmoid æ¿€æ´»å‡½æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.mask_net = nn.Sequential(nn.Linear(D, D), nn.ReLU(), nn.Linear(D, <span class="number">1</span>), nn.Sigmoid())</span><br><span class="line">        <span class="comment"># å®šä¹‰å¯†åº¦é¢„æµ‹ç½‘ç»œï¼ŒåŒ…å«ä¸€ä¸ªçº¿æ€§å±‚å’Œ Softplus æ¿€æ´»å‡½æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.fc_density = nn.Sequential(nn.Linear(D, <span class="number">1</span>), nn.Softplus())</span><br><span class="line">        <span class="comment"># å®šä¹‰ç‰¹å¾æå–çš„çº¿æ€§å±‚</span></span><br><span class="line">        <span class="variable language_">self</span>.fc_feature = nn.Linear(D, D)</span><br><span class="line">        <span class="comment"># å®šä¹‰ RGB å¤„ç†çš„ç¥ç»ç½‘ç»œåºåˆ—ï¼ŒåŒ…å«ä¸€ä¸ªçº¿æ€§å±‚å’Œ ReLU æ¿€æ´»å‡½æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.rgb_layers = nn.Sequential(nn.Linear(D + dir_in_dims, D // <span class="number">2</span>), nn.ReLU())</span><br><span class="line">        <span class="comment"># å®šä¹‰ RGB é¢„æµ‹çš„ç¥ç»ç½‘ç»œåºåˆ—ï¼ŒåŒ…å«ä¸€ä¸ªçº¿æ€§å±‚</span></span><br><span class="line">        <span class="variable language_">self</span>.fc_rgb = nn.Sequential(nn.Linear(D // <span class="number">2</span>, <span class="number">3</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ä»¥ä¸‹ä»£ç è¢«æ³¨é‡Šæ‰ï¼ŒåŸæœ¬ç”¨äºåˆå§‹åŒ–åç½®</span></span><br><span class="line">        <span class="comment"># self.fc_density[0].bias.data = torch.tensor([0.1]).float()</span></span><br><span class="line">        <span class="comment"># self.fc_rgb[0].bias.data = torch.tensor([0.02, 0.02, 0.02]).float()</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, pos_enc, dir_enc</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        :param pos_enc: (H, W, N_sample, pos_in_dims) ç¼–ç åçš„ä½ç½®</span></span><br><span class="line"><span class="string">        :param dir_enc: (H, W, N_sample, dir_in_dims) ç¼–ç åçš„æ–¹å‘</span></span><br><span class="line"><span class="string">        :return: rgb_density (H, W, N_sample, 4)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># é€šè¿‡ç¬¬ä¸€å±‚ç¥ç»ç½‘ç»œåºåˆ—å¤„ç†ç¼–ç åçš„ä½ç½®</span></span><br><span class="line">        x = <span class="variable language_">self</span>.layers0(pos_enc)  <span class="comment"># è¾“å‡ºå½¢çŠ¶ä¸º (H, W, N_sample, D)</span></span><br><span class="line">        <span class="comment"># å°†å¤„ç†åçš„ç»“æœå’ŒåŸå§‹ç¼–ç ä½ç½®åœ¨ç¬¬ 3 ç»´æ‹¼æ¥</span></span><br><span class="line">        x = torch.cat([x, pos_enc], dim=<span class="number">3</span>)  <span class="comment"># è¾“å‡ºå½¢çŠ¶ä¸º (H, W, N_sample, D + pos_in_dims)</span></span><br><span class="line">        <span class="comment"># é€šè¿‡ç¬¬äºŒå±‚ç¥ç»ç½‘ç»œåºåˆ—å¤„ç†æ‹¼æ¥åçš„ç»“æœ</span></span><br><span class="line">        x = <span class="variable language_">self</span>.layers1(x)  <span class="comment"># è¾“å‡ºå½¢çŠ¶ä¸º (H, W, N_sample, D)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># é€šè¿‡æ©ç ç½‘ç»œå¾—åˆ°æ©ç æ¦‚ç‡</span></span><br><span class="line">        mask_prob = <span class="variable language_">self</span>.mask_net(x)</span><br><span class="line">        <span class="comment"># é€šè¿‡å¯†åº¦é¢„æµ‹ç½‘ç»œå¾—åˆ°å¯†åº¦</span></span><br><span class="line">        density = <span class="variable language_">self</span>.fc_density(x)  <span class="comment"># è¾“å‡ºå½¢çŠ¶ä¸º (H, W, N_sample, 1)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># é€šè¿‡ç‰¹å¾æå–çº¿æ€§å±‚å¾—åˆ°ç‰¹å¾</span></span><br><span class="line">        feat = <span class="variable language_">self</span>.fc_feature(x)  <span class="comment"># è¾“å‡ºå½¢çŠ¶ä¸º (H, W, N_sample, D)</span></span><br><span class="line">        <span class="comment"># å°†ç‰¹å¾å’Œç¼–ç åçš„æ–¹å‘åœ¨ç¬¬ 3 ç»´æ‹¼æ¥</span></span><br><span class="line">        x = torch.cat([feat, dir_enc], dim=<span class="number">3</span>)  <span class="comment"># è¾“å‡ºå½¢çŠ¶ä¸º (H, W, N_sample, D + dir_in_dims)</span></span><br><span class="line">        <span class="comment"># é€šè¿‡ RGB å¤„ç†ç¥ç»ç½‘ç»œåºåˆ—å¤„ç†æ‹¼æ¥åçš„ç»“æœ</span></span><br><span class="line">        x = <span class="variable language_">self</span>.rgb_layers(x)  <span class="comment"># è¾“å‡ºå½¢çŠ¶ä¸º (H, W, N_sample, D / 2)</span></span><br><span class="line">        <span class="comment"># é€šè¿‡ RGB é¢„æµ‹ç¥ç»ç½‘ç»œåºåˆ—å¾—åˆ° RGB å€¼</span></span><br><span class="line">        rgb = <span class="variable language_">self</span>.fc_rgb(x)  <span class="comment"># è¾“å‡ºå½¢çŠ¶ä¸º (H, W, N_sample, 3)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># å°† RGB å€¼ã€å¯†åº¦å’Œæ©ç æ¦‚ç‡åœ¨ç¬¬3ç»´æ‹¼æ¥</span></span><br><span class="line">        rgb_den = torch.cat([rgb, density, mask_prob], dim=<span class="number">3</span>)  <span class="comment"># è¾“å‡ºå½¢çŠ¶ä¸º (H, W, N_sample, 4)</span></span><br><span class="line">        <span class="keyword">return</span> rgb_den</span><br></pre></td></tr></table></figure>
<h4 id="nerf-models-py">nerf_models.py</h4>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.nn.parallel</span><br><span class="line"><span class="keyword">import</span> torch.utils.data</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ OfficialNerf ç±»ï¼Œç»§æ‰¿è‡ª nn.Moduleï¼Œç”¨äºå®ç°å®˜æ–¹çš„ NeRF æ¨¡å‹</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OfficialNerf</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, pos_in_dims, dir_in_dims, D</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        :param pos_in_dims: æ ‡é‡ï¼Œç¼–ç åä½ç½®çš„é€šé“æ•°</span></span><br><span class="line"><span class="string">        :param dir_in_dims: æ ‡é‡ï¼Œç¼–ç åæ–¹å‘çš„é€šé“æ•°</span></span><br><span class="line"><span class="string">        :param D: æ ‡é‡ï¼Œéšè—å±‚çš„ç»´åº¦æ•°</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># è°ƒç”¨çˆ¶ç±»çš„æ„é€ å‡½æ•°</span></span><br><span class="line">        <span class="built_in">super</span>(OfficialNerf, <span class="variable language_">self</span>).__init__()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å­˜å‚¨ç¼–ç åä½ç½®çš„é€šé“æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.pos_in_dims = pos_in_dims</span><br><span class="line">        <span class="comment"># å­˜å‚¨ç¼–ç åæ–¹å‘çš„é€šé“æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.dir_in_dims = dir_in_dims</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å®šä¹‰ç¬¬ä¸€å±‚ç¥ç»ç½‘ç»œåºåˆ—ï¼ŒåŒ…å«å››ä¸ªçº¿æ€§å±‚å’Œ ReLU æ¿€æ´»å‡½æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.layers0 = nn.Sequential(</span><br><span class="line">            nn.Linear(pos_in_dims, D), nn.ReLU(),</span><br><span class="line">            nn.Linear(D, D), nn.ReLU(),</span><br><span class="line">            nn.Linear(D, D), nn.ReLU(),</span><br><span class="line">            nn.Linear(D, D), nn.ReLU(),</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å®šä¹‰ç¬¬äºŒå±‚ç¥ç»ç½‘ç»œåºåˆ—ï¼ŒåŒ…å«å››ä¸ªçº¿æ€§å±‚å’Œ ReLU æ¿€æ´»å‡½æ•°ï¼Œæœ‰ä¸€ä¸ªè·³è·ƒè¿æ¥</span></span><br><span class="line">        <span class="variable language_">self</span>.layers1 = nn.Sequential(</span><br><span class="line">            nn.Linear(D + pos_in_dims, D), nn.ReLU(),  <span class="comment"># è·³è·ƒè¿æ¥</span></span><br><span class="line">            nn.Linear(D, D), nn.ReLU(),</span><br><span class="line">            nn.Linear(D, D), nn.ReLU(),</span><br><span class="line">            nn.Linear(D, D), nn.ReLU(),</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å®šä¹‰å¯†åº¦é¢„æµ‹ç½‘ç»œï¼ŒåŒ…å«ä¸€ä¸ªçº¿æ€§å±‚å’Œ Softplus æ¿€æ´»å‡½æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.fc_density = nn.Sequential(nn.Linear(D, <span class="number">1</span>), nn.Softplus())</span><br><span class="line">        <span class="comment"># å®šä¹‰ç‰¹å¾æå–çš„çº¿æ€§å±‚</span></span><br><span class="line">        <span class="variable language_">self</span>.fc_feature = nn.Linear(D, D)</span><br><span class="line">        <span class="comment"># å®šä¹‰ RGB å¤„ç†çš„ç¥ç»ç½‘ç»œåºåˆ—ï¼ŒåŒ…å«ä¸€ä¸ªçº¿æ€§å±‚å’Œ ReLU æ¿€æ´»å‡½æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.rgb_layers = nn.Sequential(nn.Linear(D + dir_in_dims, D // <span class="number">2</span>), nn.ReLU())</span><br><span class="line">        <span class="comment"># å®šä¹‰ RGB é¢„æµ‹çš„ç¥ç»ç½‘ç»œåºåˆ—ï¼ŒåŒ…å«ä¸€ä¸ªçº¿æ€§å±‚</span></span><br><span class="line">        <span class="variable language_">self</span>.fc_rgb = nn.Sequential(nn.Linear(D // <span class="number">2</span>, <span class="number">3</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ä»¥ä¸‹ä»£ç è¢«æ³¨é‡Šæ‰ï¼ŒåŸæœ¬ç”¨äºåˆå§‹åŒ–åç½®</span></span><br><span class="line">        <span class="comment"># self.fc_density[0].bias.data = torch.tensor([0.1]).float()</span></span><br><span class="line">        <span class="comment"># self.fc_rgb[0].bias.data = torch.tensor([0.02, 0.02, 0.02]).float()</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, pos_enc, dir_enc</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        :param pos_enc: (H, W, N_sample, pos_in_dims) ç¼–ç åçš„ä½ç½®</span></span><br><span class="line"><span class="string">        :param dir_enc: (H, W, N_sample, dir_in_dims) ç¼–ç åçš„æ–¹å‘</span></span><br><span class="line"><span class="string">        :return: rgb_density (H, W, N_sample, 4)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># é€šè¿‡ç¬¬ä¸€å±‚ç¥ç»ç½‘ç»œåºåˆ—å¤„ç†ç¼–ç åçš„ä½ç½®</span></span><br><span class="line">        x = <span class="variable language_">self</span>.layers0(pos_enc)  <span class="comment"># è¾“å‡ºå½¢çŠ¶ä¸º (H, W, N_sample, D)</span></span><br><span class="line">        <span class="comment"># å°†å¤„ç†åçš„ç»“æœå’ŒåŸå§‹ç¼–ç ä½ç½®åœ¨ç¬¬ 3 ç»´æ‹¼æ¥</span></span><br><span class="line">        x = torch.cat([x, pos_enc], dim=<span class="number">3</span>)  <span class="comment"># è¾“å‡ºå½¢çŠ¶ä¸º (H, W, N_sample, D + pos_in_dims)</span></span><br><span class="line">        <span class="comment"># é€šè¿‡ç¬¬äºŒå±‚ç¥ç»ç½‘ç»œåºåˆ—å¤„ç†æ‹¼æ¥åçš„ç»“æœ</span></span><br><span class="line">        x = <span class="variable language_">self</span>.layers1(x)  <span class="comment"># è¾“å‡ºå½¢çŠ¶ä¸º (H, W, N_sample, D)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># é€šè¿‡å¯†åº¦é¢„æµ‹ç½‘ç»œå¾—åˆ°å¯†åº¦</span></span><br><span class="line">        density = <span class="variable language_">self</span>.fc_density(x)  <span class="comment"># è¾“å‡ºå½¢çŠ¶ä¸º (H, W, N_sample, 1)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># é€šè¿‡ç‰¹å¾æå–çº¿æ€§å±‚å¾—åˆ°ç‰¹å¾</span></span><br><span class="line">        feat = <span class="variable language_">self</span>.fc_feature(x)  <span class="comment"># è¾“å‡ºå½¢çŠ¶ä¸º (H, W, N_sample, D)</span></span><br><span class="line">        <span class="comment"># å°†ç‰¹å¾å’Œç¼–ç åçš„æ–¹å‘åœ¨ç¬¬ 3 ç»´æ‹¼æ¥</span></span><br><span class="line">        x = torch.cat([feat, dir_enc], dim=<span class="number">3</span>)  <span class="comment"># è¾“å‡ºå½¢çŠ¶ä¸º (H, W, N_sample, D + dir_in_dims)</span></span><br><span class="line">        <span class="comment"># é€šè¿‡ RGB å¤„ç†ç¥ç»ç½‘ç»œåºåˆ—å¤„ç†æ‹¼æ¥åçš„ç»“æœ</span></span><br><span class="line">        x = <span class="variable language_">self</span>.rgb_layers(x)  <span class="comment"># è¾“å‡ºå½¢çŠ¶ä¸º (H, W, N_sample, D / 2)</span></span><br><span class="line">        <span class="comment"># é€šè¿‡ RGB é¢„æµ‹ç¥ç»ç½‘ç»œåºåˆ—å¾—åˆ° RGB å€¼</span></span><br><span class="line">        rgb = <span class="variable language_">self</span>.fc_rgb(x)  <span class="comment"># è¾“å‡ºå½¢çŠ¶ä¸º (H, W, N_sample, 3)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># å°† RGB å€¼å’Œå¯†åº¦åœ¨ç¬¬ 3 ç»´æ‹¼æ¥</span></span><br><span class="line">        rgb_den = torch.cat([rgb, density], dim=<span class="number">3</span>)  <span class="comment"># è¾“å‡ºå½¢çŠ¶ä¸º (H, W, N_sample, 4)</span></span><br><span class="line">        <span class="keyword">return</span> rgb_den</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ fullNeRF ç±»ï¼Œç»§æ‰¿è‡ª nn.Moduleï¼Œç”¨äºå®ç°å®Œæ•´çš„ NeRF æ¨¡å‹</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">fullNeRF</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, in_channels_xyz, in_channels_dir, W, D=<span class="number">8</span>, skips=[<span class="number">4</span>]</span>):</span><br><span class="line">        <span class="comment"># è°ƒç”¨çˆ¶ç±»çš„æ„é€ å‡½æ•°</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        <span class="comment"># å­˜å‚¨ç½‘ç»œçš„æ·±åº¦</span></span><br><span class="line">        <span class="variable language_">self</span>.D = D</span><br><span class="line">        <span class="comment"># å­˜å‚¨éšè—å±‚çš„å®½åº¦</span></span><br><span class="line">        <span class="variable language_">self</span>.W = W</span><br><span class="line">        <span class="comment"># å­˜å‚¨è·³è·ƒè¿æ¥çš„ä½ç½®</span></span><br><span class="line">        <span class="variable language_">self</span>.skips = skips</span><br><span class="line">        <span class="comment"># å­˜å‚¨è¾“å…¥ä½ç½®ç¼–ç çš„é€šé“æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.in_channels_xyz = in_channels_xyz</span><br><span class="line">        <span class="comment"># å­˜å‚¨è¾“å…¥æ–¹å‘ç¼–ç çš„é€šé“æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.in_channels_dir = in_channels_dir</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å®šä¹‰ä½ç½®ç¼–ç å±‚</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(D):</span><br><span class="line">            <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">                <span class="comment"># ç¬¬ä¸€å±‚ï¼Œè¾“å…¥ç»´åº¦ä¸ºè¾“å…¥ä½ç½®ç¼–ç çš„é€šé“æ•°ï¼Œè¾“å‡ºç»´åº¦ä¸ºéšè—å±‚å®½åº¦</span></span><br><span class="line">                layer = nn.Linear(in_channels_xyz, W)</span><br><span class="line">            <span class="keyword">elif</span> i <span class="keyword">in</span> skips:</span><br><span class="line">                <span class="comment"># è·³è·ƒè¿æ¥å±‚ï¼Œè¾“å…¥ç»´åº¦ä¸ºéšè—å±‚å®½åº¦åŠ ä¸Šè¾“å…¥ä½ç½®ç¼–ç çš„é€šé“æ•°ï¼Œè¾“å‡ºç»´åº¦ä¸ºéšè—å±‚å®½åº¦</span></span><br><span class="line">                layer = nn.Linear(W + in_channels_xyz, W)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># æ™®é€šå±‚ï¼Œè¾“å…¥å’Œè¾“å‡ºç»´åº¦å‡ä¸ºéšè—å±‚å®½åº¦</span></span><br><span class="line">                layer = nn.Linear(W, W)</span><br><span class="line">            <span class="comment"># ä¸ºæ¯ä¸ªå±‚æ·»åŠ  ReLU æ¿€æ´»å‡½æ•°</span></span><br><span class="line">            layer = nn.Sequential(layer, nn.ReLU(<span class="literal">True</span>))</span><br><span class="line">            <span class="comment"># å°†å±‚æ·»åŠ åˆ°æ¨¡å‹ä¸­</span></span><br><span class="line">            <span class="built_in">setattr</span>(<span class="variable language_">self</span>, <span class="string">f&quot;xyz_encoding_<span class="subst">&#123;i + <span class="number">1</span>&#125;</span>&quot;</span>, layer)</span><br><span class="line">        <span class="comment"># å®šä¹‰ä½ç½®ç¼–ç çš„æœ€ç»ˆçº¿æ€§å±‚</span></span><br><span class="line">        <span class="variable language_">self</span>.xyz_encoding_final = nn.Linear(W, W)</span><br><span class="line">        <span class="comment"># å®šä¹‰æ–¹å‘ç¼–ç å±‚</span></span><br><span class="line">        <span class="variable language_">self</span>.dir_encoding = nn.Sequential(</span><br><span class="line">            nn.Linear(W + in_channels_dir, W), nn.ReLU(<span class="literal">True</span>),</span><br><span class="line">            nn.Linear(W, W // <span class="number">2</span>), nn.ReLU(<span class="literal">True</span>)</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å®šä¹‰é™æ€è¾“å‡ºå±‚</span></span><br><span class="line">        <span class="comment"># é™æ€å¯†åº¦é¢„æµ‹å±‚ï¼ŒåŒ…å«ä¸€ä¸ªçº¿æ€§å±‚å’Œ Softplus æ¿€æ´»å‡½æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.static_sigma = nn.Sequential(nn.Linear(W, <span class="number">1</span>), nn.Softplus())</span><br><span class="line">        <span class="comment"># é™æ€ RGB é¢„æµ‹å±‚ï¼ŒåŒ…å«ä¸¤ä¸ªçº¿æ€§å±‚ï¼Œä¸­é—´æœ‰ ReLU æ¿€æ´»å‡½æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.static_rgb = nn.Sequential(nn.Linear(W // <span class="number">2</span>, W // <span class="number">2</span>), nn.ReLU(inplace=<span class="literal">True</span>),</span><br><span class="line">                                        nn.Linear(W // <span class="number">2</span>, <span class="number">3</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, input_xyz, input_dir_a</span>):</span><br><span class="line">        <span class="comment"># å­˜å‚¨è¾“å…¥çš„ä½ç½®ç¼–ç </span></span><br><span class="line">        xyz_ = input_xyz</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="variable language_">self</span>.D):</span><br><span class="line">            <span class="keyword">if</span> i <span class="keyword">in</span> <span class="variable language_">self</span>.skips:</span><br><span class="line">                <span class="comment"># å¦‚æœæ˜¯è·³è·ƒè¿æ¥ä½ç½®ï¼Œå°†è¾“å…¥çš„ä½ç½®ç¼–ç å’Œå½“å‰å¤„ç†ç»“æœæ‹¼æ¥</span></span><br><span class="line">                xyz_ = torch.cat([input_xyz, xyz_], -<span class="number">1</span>)</span><br><span class="line">            <span class="comment"># é€šè¿‡ç›¸åº”çš„ä½ç½®ç¼–ç å±‚å¤„ç†</span></span><br><span class="line">            xyz_ = <span class="built_in">getattr</span>(<span class="variable language_">self</span>, <span class="string">f&quot;xyz_encoding_<span class="subst">&#123;i + <span class="number">1</span>&#125;</span>&quot;</span>)(xyz_)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># é€šè¿‡é™æ€å¯†åº¦é¢„æµ‹å±‚å¾—åˆ°é™æ€å¯†åº¦</span></span><br><span class="line">        static_sigma = <span class="variable language_">self</span>.static_sigma(xyz_)  <span class="comment"># è¾“å‡ºå½¢çŠ¶ä¸º (B, 1)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># é€šè¿‡ä½ç½®ç¼–ç çš„æœ€ç»ˆçº¿æ€§å±‚å¾—åˆ°æœ€ç»ˆä½ç½®ç¼–ç </span></span><br><span class="line">        xyz_encoding_final = <span class="variable language_">self</span>.xyz_encoding_final(xyz_)</span><br><span class="line">        <span class="comment"># å°†æœ€ç»ˆä½ç½®ç¼–ç å’Œè¾“å…¥çš„æ–¹å‘ç¼–ç æ‹¼æ¥</span></span><br><span class="line">        dir_encoding_input = torch.cat([xyz_encoding_final, input_dir_a], -<span class="number">1</span>)</span><br><span class="line">        <span class="comment"># é€šè¿‡æ–¹å‘ç¼–ç å±‚å¤„ç†æ‹¼æ¥åçš„ç»“æœ</span></span><br><span class="line">        dir_encoding = <span class="variable language_">self</span>.dir_encoding(dir_encoding_input)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># é€šè¿‡é™æ€ RGB é¢„æµ‹å±‚å¾—åˆ°é™æ€ RGB å€¼</span></span><br><span class="line">        static_rgb = <span class="variable language_">self</span>.static_rgb(dir_encoding)</span><br><span class="line">        <span class="comment"># å°†é™æ€ RGB å€¼å’Œé™æ€å¯†åº¦æ‹¼æ¥</span></span><br><span class="line">        static = torch.cat([static_rgb, static_sigma], -<span class="number">1</span>)  <span class="comment"># è¾“å‡ºå½¢çŠ¶ä¸º (B, 4)</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> static</span><br></pre></td></tr></table></figure>
<h4 id="poses-py">poses.py</h4>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">from</span> utils.lie_group_helper <span class="keyword">import</span> make_c2w</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ LearnPose ç±»ï¼Œç»§æ‰¿è‡ª nn.Moduleï¼Œç”¨äºå­¦ä¹ ç›¸æœºä½å§¿</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LearnPose</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, num_cams, learn_R, learn_t, init_c2w=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        :param num_cams: ç›¸æœºçš„æ•°é‡</span></span><br><span class="line"><span class="string">        :param learn_R: æ˜¯å¦å­¦ä¹ æ—‹è½¬éƒ¨åˆ†ï¼Œå¸ƒå°”å€¼</span></span><br><span class="line"><span class="string">        :param learn_t: æ˜¯å¦å­¦ä¹ å¹³ç§»éƒ¨åˆ†ï¼Œå¸ƒå°”å€¼</span></span><br><span class="line"><span class="string">        :param init_c2w: (N, 4, 4) çš„ torch å¼ é‡ï¼Œè¡¨ç¤ºåˆå§‹çš„ç›¸æœºåˆ°ä¸–ç•Œçš„å˜æ¢çŸ©é˜µ</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># è°ƒç”¨çˆ¶ç±»çš„æ„é€ å‡½æ•°</span></span><br><span class="line">        <span class="built_in">super</span>(LearnPose, <span class="variable language_">self</span>).__init__()</span><br><span class="line">        <span class="comment"># å­˜å‚¨ç›¸æœºçš„æ•°é‡</span></span><br><span class="line">        <span class="variable language_">self</span>.num_cams = num_cams</span><br><span class="line">        <span class="comment"># åˆå§‹åŒ–åˆå§‹ç›¸æœºåˆ°ä¸–ç•Œçš„å˜æ¢çŸ©é˜µä¸º None</span></span><br><span class="line">        <span class="variable language_">self</span>.init_c2w = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">if</span> init_c2w <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># å¦‚æœæä¾›äº†åˆå§‹å˜æ¢çŸ©é˜µï¼Œå°†å…¶ä½œä¸ºä¸å¯è®­ç»ƒçš„å‚æ•°å­˜å‚¨</span></span><br><span class="line">            <span class="variable language_">self</span>.init_c2w = nn.Parameter(init_c2w, requires_grad=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å®šä¹‰æ—‹è½¬å‚æ•°ï¼Œåˆå§‹åŒ–ä¸ºå…¨é›¶ï¼Œæ˜¯å¦å¯è®­ç»ƒç”± learn_R å†³å®š</span></span><br><span class="line">        <span class="variable language_">self</span>.r = nn.Parameter(torch.zeros(size=(num_cams, <span class="number">3</span>), dtype=torch.float32), requires_grad=learn_R)  <span class="comment"># (N, 3)</span></span><br><span class="line">        <span class="comment"># å®šä¹‰å¹³ç§»å‚æ•°ï¼Œåˆå§‹åŒ–ä¸ºå…¨é›¶ï¼Œæ˜¯å¦å¯è®­ç»ƒç”± learn_t å†³å®š</span></span><br><span class="line">        <span class="variable language_">self</span>.t = nn.Parameter(torch.zeros(size=(num_cams, <span class="number">3</span>), dtype=torch.float32), requires_grad=learn_t)  <span class="comment"># (N, 3)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, cam_id</span>):</span><br><span class="line">        <span class="comment"># æ ¹æ®ç›¸æœº ID æå–å¯¹åº”çš„æ—‹è½¬å‚æ•°ï¼Œå½¢çŠ¶ä¸º (3, )ï¼Œè¡¨ç¤ºè½´è§’</span></span><br><span class="line">        r = <span class="variable language_">self</span>.r[cam_id]  <span class="comment"># (3, ) è½´è§’</span></span><br><span class="line">        <span class="comment"># æ ¹æ®ç›¸æœº ID æå–å¯¹åº”çš„å¹³ç§»å‚æ•°ï¼Œå½¢çŠ¶ä¸º (3, )</span></span><br><span class="line">        t = <span class="variable language_">self</span>.t[cam_id]  <span class="comment"># (3, )</span></span><br><span class="line">        <span class="comment"># ä½¿ç”¨ make_c2w å‡½æ•°å°†è½´è§’å’Œå¹³ç§»å‚æ•°è½¬æ¢ä¸ºç›¸æœºåˆ°ä¸–ç•Œçš„å˜æ¢çŸ©é˜µï¼Œå½¢çŠ¶ä¸º (4, 4)</span></span><br><span class="line">        c2w = make_c2w(r, t)  <span class="comment"># (4, 4)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># å¦‚æœæä¾›äº†åˆå§‹å˜æ¢çŸ©é˜µï¼Œå­¦ä¹ åˆå§‹ä½å§¿å’Œç›®æ ‡ä½å§¿ä¹‹é—´çš„å¢é‡ä½å§¿</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.init_c2w <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># å°†å½“å‰è®¡ç®—å¾—åˆ°çš„å˜æ¢çŸ©é˜µä¸åˆå§‹å˜æ¢çŸ©é˜µç›¸ä¹˜</span></span><br><span class="line">            c2w = c2w @ <span class="variable language_">self</span>.init_c2w[cam_id]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> c2w</span><br></pre></td></tr></table></figure>
<h2 id="utils">utils</h2>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">â”œâ”€â”€ utils/  # å·¥å…·æ–‡ä»¶å¤¹</span><br><span class="line">â”‚   â”œâ”€â”€ align_traj.py  # è½¨è¿¹å¯¹é½è„šæœ¬æ–‡ä»¶ï¼Œç”¨äºå¯¹ä¸åŒè½¨è¿¹æ•°æ®è¿›è¡Œå¯¹é½æ“ä½œ</span><br><span class="line">â”‚   â”œâ”€â”€ comp_ate.py  # è®¡ç®—ç»å¯¹è½¨è¿¹è¯¯å·®ï¼ˆAbsolute Trajectory Error, ATEï¼‰çš„è„šæœ¬æ–‡ä»¶</span><br><span class="line">â”‚   â”œâ”€â”€ comp_ray_dir.py  # è®¡ç®—å…‰çº¿æ–¹å‘çš„è„šæœ¬æ–‡ä»¶ï¼Œå¸¸ç”¨äºè®¡ç®—æœºè§†è§‰å’Œä¸‰ç»´é‡å»ºä¸­çš„å…‰çº¿è¿½è¸ªç­‰åœºæ™¯</span><br><span class="line">â”‚   â”œâ”€â”€ lie_group_helper.py  # æç¾¤ç›¸å…³è¾…åŠ©å‡½æ•°çš„è„šæœ¬æ–‡ä»¶ï¼Œæç¾¤åœ¨æœºå™¨äººè¿åŠ¨å­¦ã€è®¡ç®—æœºè§†è§‰ä¸­çš„ä½å§¿è¡¨ç¤ºç­‰æ–¹é¢æœ‰åº”ç”¨</span><br><span class="line">â”‚   â”œâ”€â”€ pos_enc.py  # ä½ç½®ç¼–ç è„šæœ¬æ–‡ä»¶ï¼Œåœ¨æ·±åº¦å­¦ä¹ æ¨¡å‹ï¼ˆå¦‚NeRFï¼‰ä¸­ç”¨äºå¯¹ä½ç½®ä¿¡æ¯è¿›è¡Œç¼–ç </span><br><span class="line">â”‚   â”œâ”€â”€ pose_utils.py  # ä½å§¿å¤„ç†å·¥å…·è„šæœ¬æ–‡ä»¶ï¼ŒåŒ…å«å¤„ç†ç›¸æœºä½å§¿æˆ–ç‰©ä½“ä½å§¿çš„ç›¸å…³å‡½æ•°</span><br><span class="line">â”‚   â”œâ”€â”€ split_dataset.py  # æ•°æ®é›†åˆ’åˆ†è„šæœ¬æ–‡ä»¶ï¼Œç”¨äºå°†æ•°æ®é›†åˆ’åˆ†ä¸ºè®­ç»ƒé›†ã€éªŒè¯é›†å’Œæµ‹è¯•é›†ç­‰</span><br><span class="line">â”‚   â”œâ”€â”€ training_utils.py  # è®­ç»ƒè¾…åŠ©å·¥å…·è„šæœ¬æ–‡ä»¶ï¼ŒåŒ…å«è®­ç»ƒæ¨¡å‹æ—¶å¸¸ç”¨çš„å·¥å…·å‡½æ•°ï¼Œå¦‚å­¦ä¹ ç‡è°ƒæ•´ã€æŸå¤±å‡½æ•°è®¡ç®—ç­‰</span><br><span class="line">â”‚   â”œâ”€â”€ vgg.py  # VGGç½‘ç»œç›¸å…³è„šæœ¬æ–‡ä»¶ï¼Œå¯èƒ½åŒ…å«VGGæ¨¡å‹çš„å®šä¹‰ã€åŠ è½½é¢„è®­ç»ƒæƒé‡ç­‰æ“ä½œ</span><br><span class="line">â”‚   â”œâ”€â”€ vis_cam_traj.py  # å¯è§†åŒ–ç›¸æœºè½¨è¿¹çš„è„šæœ¬æ–‡ä»¶ï¼Œç”¨äºå°†ç›¸æœºåœ¨ä¸‰ç»´ç©ºé—´ä¸­çš„è¿åŠ¨è½¨è¿¹è¿›è¡Œå¯è§†åŒ–å±•ç¤º</span><br><span class="line">â”‚   â””â”€â”€ volume_op.py  # ä½“æ“ä½œè„šæœ¬æ–‡ä»¶ï¼Œåœ¨ä¸‰ç»´é‡å»ºã€ä½“æ¸²æŸ“ç­‰åœºæ™¯ä¸­å¯¹ä¸‰ç»´ä½“æ•°æ®è¿›è¡Œæ“ä½œ</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>ç§‘ç ”</category>
      </categories>
      <tags>
        <tag>è®ºæ–‡å¤ç°</tag>
      </tags>
  </entry>
  <entry>
    <title>æ‰‹æ’•è®ºæ–‡çŸ¥è¯†åº“</title>
    <url>/%E6%89%8B%E6%92%95%E7%9F%A5%E8%AF%86%E5%BA%93/</url>
    <content><![CDATA[<p>æ‰‹æ’•è®ºæ–‡çŸ¥è¯†åº“</p>
<h2 id="æ·±åº¦å­¦ä¹ é¡¹ç›®ä»£ç ç›®å½•å…¨è§ˆåŠè§£æ">æ·±åº¦å­¦ä¹ é¡¹ç›®ä»£ç ç›®å½•å…¨è§ˆåŠè§£æ</h2>
<blockquote>
<p>å¸¸è§ç›®å½•å¦‚ä¸‹ï¼š</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">project_name/</span><br><span class="line">â”œâ”€â”€ data/                   # æ•°æ®é›†ç›¸å…³ï¼ˆåŸå§‹/å¤„ç†åçš„æ•°æ®ï¼‰</span><br><span class="line">â”œâ”€â”€ dataloader/             # æ•°æ®åŠ è½½ä¸é¢„å¤„ç†æ¨¡å—ï¼ˆæ ¸å¿ƒï¼‰</span><br><span class="line">â”‚   â”œâ”€â”€ __init__.py</span><br><span class="line">â”‚   â”œâ”€â”€ dataset.py          # è‡ªå®šä¹‰Datasetç±»</span><br><span class="line">â”‚   â””â”€â”€ transforms.py       # æ•°æ®å¢å¼ºæ“ä½œ</span><br><span class="line">â”œâ”€â”€ models/                 # æ¨¡å‹å®šä¹‰ï¼ˆæ ¸å¿ƒï¼‰</span><br><span class="line">â”‚   â”œâ”€â”€ __init__.py</span><br><span class="line">â”‚   â”œâ”€â”€ backbone.py         # ä¸»å¹²ç½‘ç»œ</span><br><span class="line">â”‚   â””â”€â”€ layers.py           # è‡ªå®šä¹‰ç½‘ç»œå±‚</span><br><span class="line">â”œâ”€â”€ configs/                # è¶…å‚æ•°é…ç½®æ–‡ä»¶ï¼ˆå¦‚YAML/JSONï¼‰</span><br><span class="line">â”œâ”€â”€ utils/                  # å·¥å…·å‡½æ•°ï¼ˆå¦‚æ—¥å¿—ã€è¯„ä¼°æŒ‡æ ‡ï¼‰</span><br><span class="line">â”‚   â”œâ”€â”€ data_utils.py</span><br><span class="line">â”‚   â”œâ”€â”€ model_utils.py</span><br><span class="line">â”‚   â”œâ”€â”€ visualization_utils.py</span><br><span class="line">â”‚   â””â”€â”€...</span><br><span class="line">â”œâ”€â”€ logs/                   # è®°å½•è®­ç»ƒå’Œè¯„ä¼°è¿‡ç¨‹ä¸­çš„æ—¥å¿—ä¿¡æ¯</span><br><span class="line">â”‚   â”œâ”€â”€ training.log</span><br><span class="line">â”‚   â”œâ”€â”€ validation.log</span><br><span class="line">â”‚   â””â”€â”€...</span><br><span class="line">â”œâ”€â”€ checkpoints/            # è®­ç»ƒä¿å­˜çš„æ¨¡å‹æƒé‡</span><br><span class="line">â”œâ”€â”€ scripts/                # è¿è¡Œè„šæœ¬ï¼ˆè®­ç»ƒ/æµ‹è¯•å‘½ä»¤ï¼‰</span><br><span class="line">â”œâ”€â”€ requirements.txt        # ä¾èµ–åº“åˆ—è¡¨</span><br><span class="line">â”œâ”€â”€ environment.yml         # Condaç¯å¢ƒé…ç½®</span><br><span class="line">â”œâ”€â”€ README.md               # é¡¹ç›®è¯´æ˜</span><br><span class="line">â””â”€â”€ main.py                 # ä¸»ç¨‹åºå…¥å£</span><br></pre></td></tr></table></figure>
<blockquote>
<ol>
<li><code>dataloader/</code></li>
</ol>
<p><strong>ä½œç”¨</strong>ï¼šæ•°æ®åŠ è½½ã€é¢„å¤„ç†ã€å¢å¼ºï¼ˆå¦‚è®ºæ–‡é¡¹ç›®ä¸­çš„ <code>with_colmap.py</code> å¯èƒ½ä¸å¤šè§†å›¾æ•°æ®å¯¹é½ç›¸å…³ï¼‰</p>
<p><strong>å…¸å‹å†…å®¹</strong>ï¼š<code>Dataset</code> ç±»å®šä¹‰ã€æ•°æ®å¢å¼ºå‡½æ•°ã€ç‰¹å¾æå–å·¥å…·ï¼ˆå¦‚é¡¹ç›®ä¸­çš„ <code>with_feature.py</code>ï¼‰</p>
<ol start="2">
<li><strong><code>models/</code></strong></li>
</ol>
<p><strong>ä½œç”¨</strong>ï¼šå®šä¹‰ç¥ç»ç½‘ç»œæ¨¡å‹ï¼ˆå¦‚é¡¹ç›®ä¸­çš„<code>nerf_models.py</code> å¯å®ç°NeRFçš„æ ¸å¿ƒæ¶æ„ï¼‰ã€‚</p>
<p><strong>å…¸å‹å†…å®¹</strong>ï¼šæ¨¡å‹ç±»ç»§æ‰¿<code>torch.nn.Module</code>ï¼ŒåŒ…å«å‰å‘ä¼ æ’­é€»è¾‘ï¼ˆå¦‚é¡¹ç›®ä¸­çš„<code>depth_decoder.py</code>å¯ç”¨äºæ·±åº¦ä¼°è®¡è§£ç ï¼‰ã€‚</p>
<ol start="3">
<li><strong><code>utils/</code></strong></li>
</ol>
<p><strong>ä½œç”¨</strong>ï¼šè¾…åŠ©å·¥å…·ï¼ˆå¦‚é¡¹ç›®ä¸­çš„ <code>pose_utils.py</code> å¤„ç†ç›¸æœºä½å§¿ï¼Œ<code>training_utils.py</code> å°è£…è®­ç»ƒé€»è¾‘ï¼‰ã€‚</p>
<p><strong>å…¸å‹å†…å®¹</strong>ï¼šè¯„ä¼°æŒ‡æ ‡è®¡ç®—ã€å¯è§†åŒ–å·¥å…·ã€è®­ç»ƒå›è°ƒå‡½æ•°ã€‚</p>
<ol start="4">
<li><strong><code>third_party/</code></strong></li>
</ol>
<p><strong>ä½œç”¨</strong>ï¼šç¬¬ä¸‰æ–¹åº“æˆ–å·¥å…·ï¼ˆå¦‚é¡¹ç›®ä¸­çš„ <code>ATE</code> å¯èƒ½ç”¨äºè½¨è¿¹è¯„ä¼°ï¼Œ<code>pytorch_ssim</code> å®ç°ç»“æ„ç›¸ä¼¼æ€§æŸå¤±ï¼‰ã€‚</p>
<ol start="5">
<li>å…¶ä»–å…³é”®è¦ç´ </li>
</ol>
<p><code>logs</code> æ–‡ä»¶å¤¹ï¼šè®°å½•è®­ç»ƒå’Œè¯„ä¼°è¿‡ç¨‹ä¸­çš„æ—¥å¿—ä¿¡æ¯ï¼Œå¦‚è®­ç»ƒæŸå¤±ã€éªŒè¯æŸå¤±ã€å‡†ç¡®ç‡ç­‰æŒ‡æ ‡çš„å˜åŒ–æƒ…å†µï¼Œä¾¿äºè·Ÿè¸ªæ¨¡å‹è®­ç»ƒè¿‡ç¨‹ï¼Œåˆ†ææ¨¡å‹çš„æ”¶æ•›æ€§å’Œæ€§èƒ½è¡¨ç°ã€‚</p>
<p><code>checkpoints</code> æ–‡ä»¶å¤¹ï¼šä¿å­˜è®­ç»ƒè¿‡ç¨‹ä¸­çš„æ¨¡å‹æ£€æŸ¥ç‚¹ï¼Œå³æ¨¡å‹åœ¨ä¸åŒè®­ç»ƒé˜¶æ®µçš„å‚æ•°æ–‡ä»¶ï¼Œç”¨äºåœ¨è®­ç»ƒä¸­æ–­æ—¶æ¢å¤è®­ç»ƒï¼Œæˆ–è€…ç”¨äºé€‰æ‹©åœ¨éªŒè¯é›†ä¸Šè¡¨ç°æœ€å¥½çš„æ¨¡å‹è¿›è¡Œæµ‹è¯•å’Œéƒ¨ç½²ã€‚</p>
<p><code>requirement.txt</code>ï¼šåˆ—å‡ºé¡¹ç›®æ‰€éœ€çš„ Python ä¾èµ–åº“åŠå…¶ç‰ˆæœ¬å·ï¼Œä¾¿äºåœ¨æ–°ç¯å¢ƒä¸­å¿«é€Ÿå®‰è£…é¡¹ç›®æ‰€éœ€çš„æ‰€æœ‰ä¾èµ–ã€‚</p>
<p><code>environment.yml</code>ï¼šCondaç¯å¢ƒé…ç½®ï¼Œç¡®ä¿ä¾èµ–ä¸€è‡´æ€§ã€‚</p>
<p><code>README.md</code>ï¼šé¡¹ç›®è¯´æ˜ã€å®‰è£…ä¸ä½¿ç”¨æŒ‡å—ï¼ˆæ·±åº¦å­¦ä¹ é¡¹ç›®å¿…å¤‡ï¼‰ã€‚</p>
<p><strong><code>main.py</code></strong>ï¼šé¡¹ç›®çš„ä¸»ç¨‹åºå…¥å£ï¼Œé€šå¸¸åŒ…å«æ¨¡å‹è®­ç»ƒã€è¯„ä¼°å’Œé¢„æµ‹çš„ä¸»è¦é€»è¾‘ï¼Œå¯é€šè¿‡å‘½ä»¤è¡Œå‚æ•°æ¥æ§åˆ¶ç¨‹åºçš„è¿è¡Œæ–¹å¼å’Œå‚æ•°è®¾ç½®ã€‚</p>
</blockquote>
<blockquote>
<p>ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">occ - nerf/  # åŸºäºå ç”¨ç‡çš„ç¥ç»è¾å°„åœºé¡¹ç›®æ ¹ç›®å½•</span><br><span class="line">â”œâ”€â”€.gitignore  # æŒ‡å®šGitä¸è·Ÿè¸ªçš„æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹</span><br><span class="line">â”œâ”€â”€ LICENSE  # é¡¹ç›®ä½¿ç”¨è®¸å¯æ¡æ¬¾æ–‡ä»¶</span><br><span class="line">â”œâ”€â”€ README.md  # ä»‹ç»é¡¹ç›®èƒŒæ™¯ã€åŠŸèƒ½ã€ä½¿ç”¨æ–¹æ³•ç­‰çš„è¯´æ˜æ–‡æ¡£</span><br><span class="line">â”œâ”€â”€ environment.yml  # å®šä¹‰é¡¹ç›®è¿è¡Œæ‰€éœ€è½¯ä»¶ç¯å¢ƒ</span><br><span class="line">â”œâ”€â”€ local1.txt  # ç”¨é€”ä¸æ˜ï¼Œæˆ–ä¸ºæœ¬åœ°è¯´æ˜ã€é…ç½®ç­‰æ–‡ä»¶</span><br><span class="line">â”œâ”€â”€ dataloader/  # å­˜æ”¾æ•°æ®åŠ è½½ä¸é¢„å¤„ç†ä»£ç </span><br><span class="line">â”‚   â”œâ”€â”€ any_folder.py  # ä»ä»»æ„æ–‡ä»¶å¤¹ç»“æ„åŠ è½½æ•°æ®</span><br><span class="line">â”‚   â”œâ”€â”€ local_save.py  # è´Ÿè´£æ•°æ®æœ¬åœ°ä¿å­˜</span><br><span class="line">â”‚   â”œâ”€â”€ with_colmap.py  # ä»COLMAPå¤„ç†åæ ¼å¼åŠ è½½æ•°æ®</span><br><span class="line">â”‚   â”œâ”€â”€ with_feature.py  # åŠ è½½å¸¦ç‰¹å¾çš„æ•°æ®</span><br><span class="line">â”‚   â”œâ”€â”€ with_feature_colmap.py  # ç»“åˆCOLMAPä¸ç‰¹å¾æ•°æ®åŠ è½½</span><br><span class="line">â”‚   â””â”€â”€ with_mask.py  # åŠ è½½å¸¦æ©ç çš„æ•°æ®</span><br><span class="line">â”œâ”€â”€ models/  # å­˜æ”¾æ·±åº¦å­¦ä¹ æ¨¡å‹å®šä¹‰ä¸æ“ä½œä»£ç </span><br><span class="line">â”‚   â”œâ”€â”€ depth_decoder.py  # æ·±åº¦è§£ç ï¼Œç”¨äºæ·±åº¦ä¼°è®¡</span><br><span class="line">â”‚   â”œâ”€â”€ intrinsics.py  # å¤„ç†ç›¸æœºå†…å‚ç›¸å…³å†…å®¹</span><br><span class="line">â”‚   â”œâ”€â”€ layers.py  # å®šä¹‰æ·±åº¦å­¦ä¹ å±‚ç»“æ„</span><br><span class="line">â”‚   â”œâ”€â”€ nerf_feature.py  # å¤„ç†NeRFç‰¹å¾ç›¸å…³é€»è¾‘</span><br><span class="line">â”‚   â”œâ”€â”€ nerf_mask.py  # å¤„ç†NeRFæ¨¡å‹ä¸­æ©ç ç›¸å…³å†…å®¹</span><br><span class="line">â”‚   â”œâ”€â”€ nerf_models.py  # å®šä¹‰NeRFæ¨¡å‹æ¶æ„ç­‰æ ¸å¿ƒå†…å®¹</span><br><span class="line">â”‚   â””â”€â”€ poses.py  # å¤„ç†ä½å§¿ç›¸å…³æ“ä½œ</span><br><span class="line">â”œâ”€â”€ utils/  # åŒ…å«è¾…åŠ©é¡¹ç›®è¿è¡Œçš„å·¥å…·å‡½æ•°</span><br><span class="line">â”‚   â”œâ”€â”€ align_traj.py  # å®ç°è½¨è¿¹å¯¹é½ç®—æ³•</span><br><span class="line">â”‚   â”œâ”€â”€ comp_ate.py  # è®¡ç®—ç»å¯¹è½¨è¿¹è¯¯å·®</span><br><span class="line">â”‚   â”œâ”€â”€ comp_ray_dir.py  # è®¡ç®—å…‰çº¿æ–¹å‘</span><br><span class="line">â”‚   â”œâ”€â”€ lie_group_helper.py  # æä¾›æç¾¤ç›¸å…³è¾…åŠ©å‡½æ•°</span><br><span class="line">â”‚   â”œâ”€â”€ pos_enc.py  # å®ç°ä½ç½®ç¼–ç </span><br><span class="line">â”‚   â”œâ”€â”€ pose_utils.py  # æä¾›ä½å§¿ç›¸å…³å®ç”¨å·¥å…·å‡½æ•°</span><br><span class="line">â”‚   â”œâ”€â”€ split_dataset.py  # åˆ’åˆ†æ•°æ®é›†ä¸ºè®­ç»ƒã€éªŒè¯ã€æµ‹è¯•é›†</span><br><span class="line">â”‚   â”œâ”€â”€ training_utils.py  # æä¾›æ¨¡å‹è®­ç»ƒè¾…åŠ©å‡½æ•°</span><br><span class="line">â”‚   â”œâ”€â”€ vgg.py  # ä¸VGGç¥ç»ç½‘ç»œç›¸å…³æ“ä½œ</span><br><span class="line">â”‚   â”œâ”€â”€ vis_cam_traj.py  # å¯è§†åŒ–ç›¸æœºè½¨è¿¹</span><br><span class="line">â”‚   â””â”€â”€ volume_op.py  # æ“ä½œä¸‰ç»´ä½“æ•°æ®</span><br><span class="line">â”œâ”€â”€ tasks/  # å­˜æ”¾è®­ç»ƒã€æµ‹è¯•ç­‰å…·ä½“ä»»åŠ¡ä»£ç </span><br><span class="line">â”‚   â””â”€â”€...</span><br><span class="line">â””â”€â”€ third_party/  # å­˜æ”¾ç¬¬ä¸‰æ–¹ä»£ç æˆ–åº“</span><br><span class="line">    â”œâ”€â”€ ATE/  # ä¸ç»å¯¹è½¨è¿¹è¯¯å·®è®¡ç®—ç›¸å…³</span><br><span class="line">    â”‚   â””â”€â”€ README.md  # è¯´æ˜è¯¥éƒ¨åˆ†åŠŸèƒ½ä¸ç”¨æ³•</span><br><span class="line">    â””â”€â”€ pytorch_ssim/  # è®¡ç®—ç»“æ„ç›¸ä¼¼æ€§æŒ‡æ•°çš„åº“</span><br></pre></td></tr></table></figure>
<h2 id="æ·±åº¦å­¦ä¹ -ç¥ç»ç½‘ç»œæ¶æ„æ€»è§ˆ">æ·±åº¦å­¦ä¹ /ç¥ç»ç½‘ç»œæ¶æ„æ€»è§ˆ</h2>
<h2 id="PyTorch">PyTorch</h2>
<h3 id="ä»€ä¹ˆæ˜¯torch">ä»€ä¹ˆæ˜¯torch</h3>
<p>Torch æ˜¯ PyTorch æ·±åº¦å­¦ä¹ æ¡†æ¶çš„æ ¸å¿ƒåº“ï¼Œå…·å¤‡å¼ºå¤§çš„åŠŸèƒ½ä¸å¹¿æ³›çš„ç”¨é€”ã€‚å®ƒæä¾›äº†ä¸°å¯Œçš„å¼ é‡æ“ä½œï¼Œå¯åœ¨ CPU æˆ– GPU ä¸Šé«˜æ•ˆè®¡ç®—ï¼Œèƒ½è½»æ¾å¤„ç†å„ç±»æ•°æ®ï¼›å…¶è‡ªåŠ¨æ±‚å¯¼æœºåˆ¶æå¤§ç®€åŒ–äº†æ·±åº¦å­¦ä¹ ä¸­æ¢¯åº¦è®¡ç®—ä¸åå‘ä¼ æ’­çš„è¿‡ç¨‹ï¼Œè®©æ¨¡å‹è®­ç»ƒæ›´ä¸ºä¾¿æ·ã€‚å€ŸåŠ©<code>torch.nn</code>æ¨¡å—å¯æ–¹ä¾¿æ„å»ºå¦‚ CNNã€RNN ç­‰å¤æ‚ç¥ç»ç½‘ç»œæ¶æ„ï¼Œ<code>torch.optim</code>æ¨¡å—æä¾›å¤šç§ä¼˜åŒ–ç®—æ³•ç”¨äºæ¨¡å‹å‚æ•°æ›´æ–°ã€‚æ­¤å¤–ï¼ŒTorch è¿˜æ”¯æŒé¢„è®­ç»ƒæ¨¡å‹çš„ä½¿ç”¨ä¸å¾®è°ƒï¼Œç»“åˆå¯è§†åŒ–å·¥å…·èƒ½åŠ©åŠ›ç›‘æ§è®­ç»ƒè¿‡ç¨‹ï¼Œå¹¿æ³›åº”ç”¨äºå›¾åƒã€è‡ªç„¶è¯­è¨€å¤„ç†ã€æ¨èç³»ç»Ÿç­‰è¯¸å¤šé¢†åŸŸã€‚</p>
<h3 id="torchå¸¸ç”¨å‡½æ•°å’ŒåŠŸèƒ½">torchå¸¸ç”¨å‡½æ•°å’ŒåŠŸèƒ½</h3>
<h4 id="å¼ é‡">å¼ é‡</h4>
<h5 id="ä»€ä¹ˆæ˜¯å¼ é‡">ä»€ä¹ˆæ˜¯å¼ é‡</h5>
<p>å¼ é‡æ˜¯å¤šç»´æ•°ç»„çš„æ³›åŒ–è¡¨ç¤ºï¼Œå¯ç†è§£ä¸ºä¸€ä¸ªå¤šç»´çš„æ•°æ®å®¹å™¨ï¼Œé›¶ç»´å¼ é‡æ˜¯æ ‡é‡ï¼Œä¸€ç»´å¼ é‡æ˜¯å‘é‡ï¼ŒäºŒç»´å¼ é‡æ˜¯çŸ©é˜µï¼Œä¸‰ç»´åŠä»¥ä¸Šåˆ™æ˜¯æ›´é«˜é˜¶çš„å¼ é‡ã€‚åœ¨æ·±åº¦å­¦ä¹ é‡Œï¼Œä½¿ç”¨å¼ é‡æ˜¯å› ä¸ºå®ƒèƒ½å¤Ÿé«˜æ•ˆåœ°è¡¨ç¤ºå’Œå¤„ç†å¤§é‡çš„æ•°æ®ï¼Œåƒå›¾åƒå¯è¡¨ç¤ºä¸ºä¸‰ç»´å¼ é‡ï¼ˆé«˜åº¦ã€å®½åº¦ã€é€šé“æ•°ï¼‰ï¼Œè§†é¢‘å¯è¡¨ç¤ºä¸ºå››ç»´å¼ é‡ï¼ˆå¸§æ•°ã€é«˜åº¦ã€å®½åº¦ã€é€šé“æ•°ï¼‰ã€‚å¹¶ä¸”ï¼Œæ·±åº¦å­¦ä¹ æ¡†æ¶ï¼ˆå¦‚ PyTorchï¼‰é’ˆå¯¹å¼ é‡è¿ç®—è¿›è¡Œäº†é«˜åº¦ä¼˜åŒ–ï¼Œèƒ½åˆ©ç”¨ GPU ç­‰ç¡¬ä»¶åŠ é€Ÿè®¡ç®—ï¼Œå¼ é‡è¿˜èƒ½è‡ªç„¶åœ°æ”¯æŒè‡ªåŠ¨æ±‚å¯¼æœºåˆ¶ï¼Œæ–¹ä¾¿è¿›è¡Œæ¨¡å‹è®­ç»ƒæ—¶çš„æ¢¯åº¦è®¡ç®—å’Œå‚æ•°æ›´æ–°ã€‚</p>
<p>å¼ é‡æ˜¯ PyTorch ä¸­æœ€åŸºç¡€çš„æ•°æ®ç»“æ„ï¼Œç±»ä¼¼äº NumPy çš„å¤šç»´æ•°ç»„ï¼Œä½†å®ƒå¯ä»¥åœ¨ GPU ä¸Šè¿›è¡ŒåŠ é€Ÿè®¡ç®—ï¼Œå¹¶ä¸”æ”¯æŒè‡ªåŠ¨æ±‚å¯¼ç­‰æ·±åº¦å­¦ä¹ æ‰€éœ€çš„ç‰¹æ€§ã€‚</p>
<h5 id="å¼ é‡çš„ç»´åº¦">å¼ é‡çš„ç»´åº¦</h5>
<p>ç»´åº¦ï¼ˆä¹Ÿç§°ä¸ºè½´ï¼‰æ˜¯æŒ‡å¼ é‡åœ¨æŸä¸ªæ–¹å‘ä¸Šçš„å»¶ä¼¸ã€‚å¯ä»¥å°†ç»´åº¦ç†è§£ä¸ºæ•°æ®ç»„ç»‡çš„ä¸€ä¸ªæ–¹å‘æˆ–ä¸€ä¸ªå±‚æ¬¡ï¼Œç±»ä¼¼äºåœ¨åœ°ç†åæ ‡ç³»ç»Ÿä¸­ï¼Œç»åº¦å’Œçº¬åº¦åˆ†åˆ«ä»£è¡¨äº†ä¸åŒçš„æ–¹å‘ï¼Œå¼ é‡çš„æ¯ä¸ªç»´åº¦ä¹Ÿä»£è¡¨äº†æ•°æ®çš„ä¸€ä¸ªç‰¹å®šæ–¹å‘çš„æ’åˆ—ã€‚ç»´åº¦çš„æ•°é‡è¢«ç§°ä¸ºå¼ é‡çš„é˜¶ï¼ˆrankï¼‰ï¼Œé›¶é˜¶å¼ é‡æ˜¯æ ‡é‡ï¼ˆä¸€ä¸ªå•ç‹¬çš„æ•°å€¼ï¼‰ï¼Œä¸€é˜¶å¼ é‡æ˜¯å‘é‡ï¼ˆä¸€ç»´æ•°ç»„ï¼‰ï¼ŒäºŒé˜¶å¼ é‡æ˜¯çŸ©é˜µï¼ˆäºŒç»´æ•°ç»„ï¼‰ï¼Œä¸‰é˜¶åŠä»¥ä¸Šçš„å¼ é‡åˆ™ç”¨äºè¡¨ç¤ºæ›´å¤æ‚çš„æ•°æ®ç»“æ„ã€‚</p>
<p><strong>æ³¨ï¼šç»´åº¦ä»0å¼€å§‹ç®—èµ·ï¼Œæ¯”å¦‚å¯¹äºäºŒé˜¶å¼ é‡ï¼Œç»´åº¦0ä»£è¡¨è¡Œï¼Œç»´åº¦1ä»£è¡¨åˆ—</strong></p>
<p><strong>å¦ï¼šç»´åº¦æ’åˆ—éµå¾ªï¼ˆ$a_n$, $a_{n-1}$, â€¦, $a_1$ï¼‰çš„å½¢å¼ï¼Œæ•°å­—è¶Šå‰ä»£è¡¨è¶Šé«˜ç»´çš„å †å ã€‚æ¯”å¦‚<code>torch.zeros((2, 3, 4, 5))</code>ï¼Œé‚£å°±æ˜¯ä¸¤ä¸ªä¸‰ç»´ï¼ˆä¸‰å±‚ï¼‰çš„4x5çŸ©é˜µå åœ¨ä¸€èµ·</strong></p>
<p><strong>1.é›¶é˜¶å¼ é‡ï¼ˆæ ‡é‡ï¼‰</strong></p>
<p>é›¶é˜¶å¼ é‡åªæœ‰ä¸€ä¸ªæ•°å€¼ï¼Œå®ƒæ²¡æœ‰æ–¹å‘çš„æ¦‚å¿µï¼Œç»´åº¦æ•°é‡ä¸º 0ã€‚ä¾‹å¦‚è¿™é‡Œçš„ <code>scalar</code> å°±æ˜¯ä¸€ä¸ªé›¶é˜¶å¼ é‡ï¼Œå®ƒä»£è¡¨ä¸€ä¸ªå•ä¸€çš„æ•°å€¼ï¼Œä¸æ¶‰åŠæ–¹å‘æˆ–å¤šä¸ªå…ƒç´ çš„æ’åˆ—ã€‚</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line">scalar = torch.tensor(<span class="number">5</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;æ ‡é‡çš„ç»´åº¦æ•°é‡:&quot;</span>, scalar.dim()) </span><br></pre></td></tr></table></figure>
<p><strong>2.ä¸€é˜¶å¼ é‡ï¼ˆå‘é‡ï¼‰</strong></p>
<p>ä¸€é˜¶å¼ é‡å¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªå‘é‡ï¼Œå®ƒæœ‰ä¸€ä¸ªç»´åº¦ã€‚è¿™ä¸ªç»´åº¦ä»£è¡¨äº†å‘é‡ä¸­å…ƒç´ çš„æ’åˆ—æ–¹å‘ï¼Œå‘é‡çš„é•¿åº¦å°±æ˜¯è¿™ä¸ªç»´åº¦çš„å¤§å°ã€‚ä¾‹å¦‚<code>vector</code> æ˜¯ä¸€ä¸ªä¸€é˜¶å¼ é‡ï¼Œç»´åº¦æ•°é‡ä¸º 1ï¼Œè¯¥ç»´åº¦çš„å¤§å°ä¸º 4ï¼Œè¡¨ç¤ºå‘é‡ä¸­æœ‰ 4 ä¸ªå…ƒç´ ã€‚</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">vector = torch.tensor([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;å‘é‡çš„ç»´åº¦æ•°é‡:&quot;</span>, vector.dim()) </span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;å‘é‡åœ¨è¯¥ç»´åº¦çš„å¤§å°:&quot;</span>, vector.size(<span class="number">0</span>)) </span><br></pre></td></tr></table></figure>
<p><strong>3.äºŒé˜¶å¼ é‡ï¼ˆçŸ©é˜µï¼‰</strong></p>
<p>äºŒé˜¶å¼ é‡æ˜¯ä¸€ä¸ªçŸ©é˜µï¼Œæœ‰ä¸¤ä¸ªç»´åº¦ï¼Œé€šå¸¸ç§°ä¸ºè¡Œå’Œåˆ—ã€‚ç¬¬ä¸€ä¸ªç»´åº¦ä»£è¡¨çŸ©é˜µçš„è¡Œæ–¹å‘ï¼Œç¬¬äºŒä¸ªç»´åº¦ä»£è¡¨çŸ©é˜µçš„åˆ—æ–¹å‘ã€‚ä¾‹å¦‚<code>matrix</code> æ˜¯ä¸€ä¸ª 2 è¡Œ 3 åˆ—çš„çŸ©é˜µï¼Œç¬¬ä¸€ä¸ªç»´åº¦çš„å¤§å°ä¸º 2 è¡¨ç¤ºæœ‰ 2 è¡Œï¼Œç¬¬äºŒä¸ªç»´åº¦çš„å¤§å°ä¸º 3 è¡¨ç¤ºæœ‰ 3 åˆ—ã€‚</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">matrix = torch.tensor([[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], [<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>]])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;çŸ©é˜µçš„ç»´åº¦æ•°é‡:&quot;</span>, matrix.dim()) </span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;çŸ©é˜µç¬¬ä¸€ä¸ªç»´åº¦ï¼ˆè¡Œï¼‰çš„å¤§å°:&quot;</span>, matrix.size(<span class="number">0</span>)) </span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;çŸ©é˜µç¬¬äºŒä¸ªç»´åº¦ï¼ˆåˆ—ï¼‰çš„å¤§å°:&quot;</span>, matrix.size(<span class="number">1</span>)) </span><br></pre></td></tr></table></figure>
<p><strong>4.é«˜é˜¶å¼ é‡ï¼ˆå›¾åƒã€è§†é¢‘ç­‰ï¼‰</strong></p>
<p>å¯¹äºä¸‰é˜¶åŠä»¥ä¸Šçš„å¼ é‡ï¼Œç»´åº¦çš„å«ä¹‰æ›´åŠ ä¸°å¯Œï¼Œé€šå¸¸ä¸å…·ä½“çš„æ•°æ®ç±»å‹å’Œåº”ç”¨åœºæ™¯ç›¸å…³ã€‚</p>
<p><strong>å›¾åƒæ•°æ®</strong>ï¼šåœ¨å¤„ç†å›¾åƒæ—¶ï¼Œé€šå¸¸ä½¿ç”¨ä¸‰é˜¶å¼ é‡ã€‚ä¾‹å¦‚ï¼Œä¸€å¼ å½©è‰²å›¾åƒå¯ä»¥è¡¨ç¤ºä¸ºä¸€ä¸ªå½¢çŠ¶ä¸º <code>(é«˜åº¦, å®½åº¦, é€šé“æ•°)</code> çš„ä¸‰é˜¶å¼ é‡ã€‚è¿™é‡Œçš„ç¬¬ä¸€ä¸ªç»´åº¦ä»£è¡¨å›¾åƒçš„é«˜åº¦æ–¹å‘ï¼Œç¬¬äºŒä¸ªç»´åº¦ä»£è¡¨å›¾åƒçš„å®½åº¦æ–¹å‘ï¼Œç¬¬ä¸‰ä¸ªç»´åº¦ä»£è¡¨å›¾åƒçš„é€šé“ï¼ˆå¦‚ RGB ä¸‰ä¸ªé€šé“ï¼‰ã€‚</p>
<p><code>image = torch.randn(224, 224, 3)</code> è¿™è¡Œä»£ç èƒ½å¤Ÿéšæœºç”Ÿæˆä¸€ä¸ªå½¢çŠ¶ä¸º <code>(224, 224, 3)</code> çš„å¼ é‡æ¥æ¨¡æ‹Ÿå›¾åƒçš„ä¸‰é€šé“æ•°å€¼ã€‚</p>
<p>ç”±äº <code>torch.randn()</code> ç”Ÿæˆçš„æ˜¯æœä»æ ‡å‡†æ­£æ€åˆ†å¸ƒçš„éšæœºæ•°ï¼Œè¿™äº›æ•°å€¼å¯èƒ½ä¸ºè´Ÿæ•°ï¼Œä¹Ÿå¯èƒ½è¶…å‡ºäº†å¸¸è§å›¾åƒåƒç´ å€¼çš„èŒƒå›´ï¼ˆé€šå¸¸æ˜¯ 0 - 255 æˆ–è€… 0 - 1ï¼‰ã€‚åœ¨å®é™…çš„å›¾åƒå¤„ç†ä»»åŠ¡ä¸­ï¼Œå¦‚æœéœ€è¦æ¨¡æ‹ŸçœŸå®å›¾åƒï¼Œå¯èƒ½éœ€è¦å¯¹è¿™äº›éšæœºå€¼è¿›è¡Œè¿›ä¸€æ­¥çš„å¤„ç†ï¼Œä¾‹å¦‚é€šè¿‡å½’ä¸€åŒ–æˆ–è£å‰ªæ“ä½œå°†å…¶é™åˆ¶åœ¨åˆé€‚çš„èŒƒå›´å†…ã€‚</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">image = torch.randn(<span class="number">224</span>, <span class="number">224</span>, <span class="number">3</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;å›¾åƒå¼ é‡çš„ç»´åº¦æ•°é‡:&quot;</span>, image.dim()) </span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;å›¾åƒé«˜åº¦ç»´åº¦çš„å¤§å°:&quot;</span>, image.size(<span class="number">0</span>)) </span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;å›¾åƒå®½åº¦ç»´åº¦çš„å¤§å°:&quot;</span>, image.size(<span class="number">1</span>)) </span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;å›¾åƒé€šé“ç»´åº¦çš„å¤§å°:&quot;</span>, image.size(<span class="number">2</span>)) </span><br></pre></td></tr></table></figure>
<p><img src="/%E6%89%8B%E6%92%95%E7%9F%A5%E8%AF%86%E5%BA%93/image-20250219032451598.png" alt="image-20250219032451598"></p>
<p><strong>è§†é¢‘æ•°æ®</strong>ï¼šè§†é¢‘å¯ä»¥çœ‹ä½œæ˜¯ä¸€ç³»åˆ—çš„å›¾åƒå¸§ï¼Œå› æ­¤å¯ä»¥ç”¨å››é˜¶å¼ é‡è¡¨ç¤ºï¼Œå½¢çŠ¶é€šå¸¸ä¸º <code>(å¸§æ•°, é«˜åº¦, å®½åº¦, é€šé“æ•°)</code>ã€‚ç¬¬ä¸€ä¸ªç»´åº¦ä»£è¡¨è§†é¢‘ä¸­çš„å¸§æ•°ï¼Œå…¶ä½™ç»´åº¦ä¸å›¾åƒå¼ é‡çš„å«ä¹‰ç›¸åŒã€‚</p>
<p>*<strong>5.é€šé“</strong></p>
<p>é€šé“æŒ‡å›¾åƒä¸­ç‰¹å®šç±»å‹ä¿¡æ¯çš„é›†åˆï¼Œå›¾åƒå¯å«ä¸€ä¸ªæˆ–å¤šä¸ªé€šé“ï¼Œå„é€šé“å­˜å‚¨å›¾åƒæŸæ–¹é¢ç‰¹å¾æ•°æ®ã€‚åƒå•é€šé“å­˜äº®åº¦ï¼ŒRGB ä¸‰é€šé“åˆ†åˆ«å­˜çº¢ã€ç»¿ã€è“é¢œè‰²ä¿¡æ¯ï¼Œå››é€šé“è¿˜å¤šäº†é€æ˜åº¦é€šé“ï¼Œä»¥æ­¤ç»„åˆå®Œæ•´å‘ˆç°å›¾åƒã€‚</p>
<p>é€šé“èƒ½å®ç°é¢œè‰²è¡¨ç¤ºä¸æ··åˆï¼Œå¦‚ RGB ä¸‰é€šé“é€šè¿‡ä¸åŒæ•°å€¼ç»„åˆå‘ˆç°ä¸°å¯Œè‰²å½©ï¼›å¯ç”¨äºç‰¹å¾æå–ä¸åˆ†æï¼Œä¸åŒé€šé“æä¾›ä¸åŒç‰¹å¾ï¼ŒåŠ©åŠ›å›¾åƒåˆ†æå’Œç›®æ ‡è¯†åˆ«ï¼›è¿˜èƒ½ç”¨äºå›¾åƒåˆæˆä¸ç‰¹æ•ˆåˆ¶ä½œï¼Œå€ŸåŠ©é€æ˜åº¦é€šé“å¯æ§åˆ¶å›¾åƒé€æ˜æ•ˆæœå®ç°åˆæˆã€‚</p>
<p>åœ¨å›¾ç‰‡é‡Œï¼Œç°åº¦å›¾ç”¨å•é€šé“å‘ˆç°é»‘ç™½å½±åƒï¼›å½©è‰²ç…§ç‰‡é  RGB ä¸‰é€šé“å±•ç¤ºå¤šå½©ç”»é¢ï¼›PNG å›¾ç‰‡åˆ©ç”¨å››é€šé“å«é€æ˜åº¦ä¿¡æ¯å®ç°å›¾åƒèåˆã€‚è§†é¢‘æ˜¯è¿ç»­çš„å›¾ç‰‡å¸§ï¼ŒåŒæ ·åˆ©ç”¨é€šé“æ¥å‘ˆç°è‰²å½©ã€è¿›è¡Œç‰¹æ•ˆå¤„ç†ï¼Œå¦‚å½±è§†ä¸­å¸¸è§çš„æŠ å›¾åˆæˆåœºæ™¯å°±å€ŸåŠ©äº†é€šé“ç‰¹æ€§ã€‚</p>
<h5 id="å¼ é‡ç›¸å…³å‡½æ•°">å¼ é‡ç›¸å…³å‡½æ•°</h5>
<p><strong>1.åˆ›å»º</strong></p>
<ul>
<li>
<p>åˆ›å»ºå¼ é‡<code>torch.tensor()</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line">data = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line">tensor = torch.tensor(data)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>å½“ä½ æœ‰ç°æœ‰çš„æ•°æ®å­˜å‚¨åœ¨ Python åˆ—è¡¨æˆ– NumPy æ•°ç»„ä¸­ï¼Œå¹¶ä¸”éœ€è¦å°†å…¶è¾“å…¥åˆ° PyTorch æ¨¡å‹è¿›è¡Œè®¡ç®—æ—¶ä½¿ç”¨ã€‚ä¾‹å¦‚ï¼Œåœ¨åŠ è½½æ•°æ®é›†åï¼Œå°†æ•°æ®è½¬æ¢ä¸ºå¼ é‡å½¢å¼ä»¥ä¾¿åç»­å¤„ç†ã€‚</p>
<p>ä»æ•°æ®å­˜å‚¨çš„è§’åº¦æ¥çœ‹ï¼Œ<code>tensor</code> å­˜å‚¨äº† Python åˆ—è¡¨ <code>data</code> ä¸­çš„å…ƒç´  <code>[1, 2, 3]</code>ã€‚å®ƒå°†è¿™äº›æ•°æ®ä»¥ä¸€ç§é«˜æ•ˆçš„ã€é€‚åˆè®¡ç®—æœºå¤„ç†çš„æ–¹å¼ç»„ç»‡èµ·æ¥ï¼Œå­˜å‚¨åœ¨å†…å­˜ä¸­ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>tensor</code> æ˜¯ä¸€ä¸ªä¸€ç»´å¼ é‡ï¼Œå½¢çŠ¶ä¸º <code>(3,)</code>ï¼Œè¿™æ„å‘³ç€å®ƒåŒ…å« 3 ä¸ªå…ƒç´ ã€‚</p>
<p>åœ¨æ•°å­¦è¿ç®—æ–¹é¢ï¼Œ<code>tensor</code> å¯ä»¥å‚ä¸å„ç§æ•°å­¦è¿ç®—ï¼Œå¦‚åŠ æ³•ã€ä¹˜æ³•ã€çŸ©é˜µä¹˜æ³•ç­‰ã€‚PyTorch ä¸ºå¼ é‡æä¾›äº†ä¸°å¯Œçš„æ•°å­¦è¿ç®—å‡½æ•°ï¼Œè¿™äº›è¿ç®—å¯ä»¥åœ¨ CPU æˆ– GPU ä¸Šé«˜æ•ˆæ‰§è¡Œã€‚</p>
<p>åœ¨æ·±åº¦å­¦ä¹ çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œ<code>tensor</code> æ˜¯æ¨¡å‹è¾“å…¥ã€è¾“å‡ºä»¥åŠå‚æ•°çš„åŸºæœ¬è¡¨ç¤ºå½¢å¼ã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸€ä¸ªç®€å•çš„å…¨è¿æ¥ç¥ç»ç½‘ç»œä¸­ï¼Œè¾“å…¥æ•°æ®ä¼šè¢«è½¬æ¢ä¸ºå¼ é‡è¾“å…¥åˆ°ç½‘ç»œä¸­ï¼Œç½‘ç»œçš„æƒé‡å’Œåç½®ä¹Ÿæ˜¯ä»¥å¼ é‡çš„å½¢å¼å­˜å‚¨å’Œæ›´æ–°çš„ã€‚åœ¨ä¸Šè¿°ä¾‹å­ä¸­ï¼Œ<code>tensor</code> å¯ä»¥ä½œä¸ºä¸€ä¸ªç®€å•çš„è¾“å…¥æ•°æ®ç¤ºä¾‹ï¼Œå¦‚æœè¦æ„å»ºä¸€ä¸ªç¥ç»ç½‘ç»œå¤„ç†è¿™ä¸ªè¾“å…¥ï¼Œå¯èƒ½ä¼šè¿›è¡Œå¦‚ä¸‹æ“ä½œï¼ˆä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•ç¤ºä¾‹ï¼‰ï¼š</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ä¸€ä¸ªç®€å•çš„å…¨è¿æ¥å±‚</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SimpleNet</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>(SimpleNet, <span class="variable language_">self</span>).__init__()</span><br><span class="line">        <span class="variable language_">self</span>.fc = nn.Linear(<span class="number">3</span>, <span class="number">1</span>)  <span class="comment"># è¾“å…¥ç»´åº¦ä¸º 3ï¼Œè¾“å‡ºç»´åº¦ä¸º 1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.fc(x)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºæ¨¡å‹å®ä¾‹</span></span><br><span class="line">model = SimpleNet()</span><br><span class="line"></span><br><span class="line"><span class="comment"># å‡†å¤‡è¾“å…¥æ•°æ®</span></span><br><span class="line">data = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line">tensor = torch.tensor(data, dtype=torch.float32).unsqueeze(<span class="number">0</span>)  <span class="comment"># è½¬æ¢ä¸ºé€‚åˆè¾“å…¥æ¨¡å‹çš„å½¢çŠ¶</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿›è¡Œå‰å‘ä¼ æ’­</span></span><br><span class="line">output = model(tensor)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;æ¨¡å‹è¾“å‡º:&quot;</span>, output)</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>åˆ›å»ºå…¨é›¶å¼ é‡<code>torch.zeros()</code></p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">zeros_tensor = torch.zeros((<span class="number">2</span>, <span class="number">3</span>))</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>å¸¸ç”¨äºåˆå§‹åŒ–æŸäº›å˜é‡ï¼Œå¦‚åœ¨åˆå§‹åŒ–ç¥ç»ç½‘ç»œçš„åç½®é¡¹æ—¶ï¼Œå¯ä½¿ç”¨å…¨é›¶å¼ é‡ã€‚å¦å¤–ï¼Œåœ¨éœ€è¦å¡«å……é›¶å€¼è¿›è¡Œæ•°æ®é¢„å¤„ç†æˆ–å ä½æ—¶ä¹Ÿä¼šç”¨åˆ°ã€‚</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">åˆ›å»ºçš„å…¨é›¶å¼ é‡ï¼š</span><br><span class="line">tensor([[<span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>],</span><br><span class="line">        [<span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>]])</span><br><span class="line">å¼ é‡çš„å½¢çŠ¶ï¼š torch.Size([<span class="number">2</span>, <span class="number">3</span>])</span><br></pre></td></tr></table></figure>
<p>ä¼ å…¥çš„å‚æ•° <code>(2, 3)</code>å¯¹åº”åˆ›å»ºçš„ <code>zeros_tensor</code> æ˜¯ä¸€ä¸ª 2 è¡Œ 3 åˆ—çš„äºŒç»´å¼ é‡ã€‚å¦‚æœä½¿ç”¨ <code>torch.zeros((2, 3, 4))</code> è¿™æ ·çš„ä»£ç ï¼Œé‚£ä¹ˆåˆ›å»ºçš„å°±æ˜¯ä¸€ä¸ªä¸‰ç»´å¼ é‡ï¼Œå…¶ä¸­ <code>2</code> è¡¨ç¤ºæœ€å¤–å±‚ç»´åº¦çš„å¤§å°ï¼ˆå¯ä»¥æƒ³è±¡æˆæœ‰ 2 ä¸ªäºŒç»´çŸ©é˜µå †å åœ¨ä¸€èµ·ï¼‰ï¼Œ<code>3</code> è¡¨ç¤ºæ¯ä¸ªäºŒç»´çŸ©é˜µçš„è¡Œæ•°ï¼Œ<code>4</code> è¡¨ç¤ºæ¯ä¸ªäºŒç»´çŸ©é˜µçš„åˆ—æ•°ã€‚ä¾æ­¤ç±»æ¨ï¼Œå¯¹äºæ›´é«˜ç»´çš„å¼ é‡ï¼Œæ¯ä¸ªæ•°å­—éƒ½ä»£è¡¨å¯¹åº”ç»´åº¦ä¸Šçš„å¤§å°ã€‚ç›¸å½“äºé«˜æ˜¯2ï¼Œè¡Œæ˜¯3ï¼Œåˆ—æ˜¯4</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">åˆ›å»ºçš„å…¨é›¶å¼ é‡ï¼š</span><br><span class="line">tensor([[[<span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>],</span><br><span class="line">         [<span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>],</span><br><span class="line">         [<span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>]],</span><br><span class="line"></span><br><span class="line">        [[<span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>],</span><br><span class="line">         [<span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>],</span><br><span class="line">         [<span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>]]])</span><br><span class="line">å¼ é‡çš„å½¢çŠ¶ï¼š torch.Size([<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>])</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæ˜¯<code>torch.zeros((2, 3, 4, 5))</code>ï¼Œé‚£å°±æ˜¯ä¸¤ä¸ªä¸‰ç»´ï¼ˆä¸‰å±‚ï¼‰çš„4x5çŸ©é˜µå åœ¨ä¸€èµ·ï¼Œæ•°å­—è¶Šå‰å°±ä»£è¡¨è¶Šé«˜ç»´çš„å †å ã€‚</p>
<ul>
<li>
<p>åˆ›å»ºå…¨ä¸€å¼ é‡**<code>torch.ones()</code>**</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">ones_tensor = torch.ones((<span class="number">2</span>, <span class="number">3</span>))</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>ä¸ <code>torch.zeros()</code> ç±»ä¼¼ï¼Œå¯ç”¨äºåˆå§‹åŒ–ç‰¹å®šå˜é‡ã€‚åœ¨ä¸€äº›å½’ä¸€åŒ–æ“ä½œæˆ–éœ€è¦ç‰¹å®šåˆå§‹å€¼ä¸º 1 çš„åœºæ™¯ä¸­ä¼šä½¿ç”¨ã€‚</p>
<ul>
<li>
<p>åˆ›å»ºæŒ‡å®šå½¢çŠ¶çš„éšæœºå¼ é‡ï¼Œå…ƒç´ å€¼åœ¨[0 , 1)ä¹‹é—´**<code>torch.rand()</code>**</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">random_tensor = torch.rand((<span class="number">2</span>, <span class="number">3</span>))</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>åœ¨åˆå§‹åŒ–ç¥ç»ç½‘ç»œçš„æƒé‡æ—¶ï¼Œéšæœºåˆå§‹åŒ–æ˜¯å¸¸è§çš„åšæ³•ï¼Œå¯ä½¿ç”¨ <code>torch.rand()</code> ç”Ÿæˆåˆå§‹æƒé‡å¼ é‡ã€‚</p>
<p><strong>2.æ“ä½œ</strong></p>
<ul>
<li>
<p><strong><code>torch.cat()</code></strong>ï¼šç”¨äºåœ¨æŒ‡å®šç»´åº¦ä¸Šæ‹¼æ¥å¤šä¸ªå¼ é‡ã€‚</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">a = torch.tensor([[<span class="number">1</span>, <span class="number">2</span>], [<span class="number">3</span>, <span class="number">4</span>]])</span><br><span class="line">b = torch.tensor([[<span class="number">5</span>, <span class="number">6</span>], [<span class="number">7</span>, <span class="number">8</span>]])</span><br><span class="line">c = torch.cat((a, b), dim=<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p>å½“éœ€è¦å°†å¤šä¸ªå¼ é‡åˆå¹¶ä¸ºä¸€ä¸ªæ›´å¤§çš„å¼ é‡æ—¶ä½¿ç”¨ã€‚ä¾‹å¦‚ï¼Œåœ¨å¤„ç†å¤šæ¨¡æ€æ•°æ®æ—¶ï¼Œå°†ä¸åŒæ¨¡æ€çš„ç‰¹å¾å¼ é‡æ‹¼æ¥åœ¨ä¸€èµ·ã€‚</p>
<p><code>torch.cat((a, b), dim=1)</code> è¡¨ç¤ºåœ¨ç»´åº¦ 1ï¼ˆåˆ—æ–¹å‘ï¼‰ä¸Šå¯¹å¼ é‡ <code>a</code> å’Œ <code>b</code> è¿›è¡Œæ‹¼æ¥ã€‚å¯ä»¥çœ‹åˆ°ï¼Œæ‹¼æ¥åçš„å¼ é‡ <code>c</code> æ˜¯å°† <code>a</code> å’Œ <code>b</code> çš„åˆ—è¿›è¡Œäº†åˆå¹¶ï¼Œè¡Œæ•°ä¸å˜ï¼Œåˆ—æ•°å˜ä¸ºåŸæ¥ä¸¤ä¸ªå¼ é‡åˆ—æ•°ä¹‹å’Œã€‚åœ¨å¤„ç†å¤šæ¨¡æ€æ•°æ®æ—¶ï¼Œæ¯”å¦‚ä¸€ä¸ªæ¨¡æ€çš„æ•°æ®ç‰¹å¾ç”¨å¼ é‡ <code>a</code> è¡¨ç¤ºï¼Œå¦ä¸€ä¸ªæ¨¡æ€çš„æ•°æ®ç‰¹å¾ç”¨å¼ é‡ <code>b</code> è¡¨ç¤ºï¼Œé€šè¿‡è¿™ç§æ‹¼æ¥æ“ä½œå¯ä»¥å°†ä¸åŒæ¨¡æ€çš„ç‰¹å¾åˆå¹¶åœ¨ä¸€èµ·ï¼Œæ–¹ä¾¿åç»­çš„å¤„ç†ã€‚</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">å¼ é‡ aï¼š</span><br><span class="line">tensor([[<span class="number">1</span>, <span class="number">2</span>],</span><br><span class="line">        [<span class="number">3</span>, <span class="number">4</span>]])</span><br><span class="line">å¼ é‡ bï¼š</span><br><span class="line">tensor([[<span class="number">5</span>, <span class="number">6</span>],</span><br><span class="line">        [<span class="number">7</span>, <span class="number">8</span>]])</span><br><span class="line">æ‹¼æ¥åçš„å¼ é‡ cï¼š</span><br><span class="line">tensor([[<span class="number">1</span>, <span class="number">2</span>, <span class="number">5</span>, <span class="number">6</span>],</span><br><span class="line">        [<span class="number">3</span>, <span class="number">4</span>, <span class="number">7</span>, <span class="number">8</span>]])</span><br></pre></td></tr></table></figure>
<p>åœ¨äºŒç»´å¼ é‡çš„è¯­å¢ƒä¸‹ï¼Œç»´åº¦ 0 ä»£è¡¨è¡Œæ–¹å‘ã€‚<code>torch.cat((a, b), dim=0)</code> ä¼šå°†å¼ é‡ <code>b</code> æŒ‰è¡Œçš„é¡ºåºæ‹¼æ¥åˆ°å¼ é‡ <code>a</code> çš„ä¸‹æ–¹ï¼Œæ‹¼æ¥åçš„å¼ é‡åˆ—æ•°ä¸å˜ï¼Œè¡Œæ•°ä¸ºåŸæ¥ä¸¤ä¸ªå¼ é‡è¡Œæ•°ä¹‹å’Œã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè‹¥ <code>a</code> å’Œ <code>b</code> åˆ†åˆ«è¡¨ç¤ºä¸¤ç»„æ ·æœ¬æ•°æ®ï¼Œåœ¨ç»´åº¦ 0 ä¸Šæ‹¼æ¥å°±ç›¸å½“äºå°†è¿™ä¸¤ç»„æ ·æœ¬åˆå¹¶æˆä¸€ç»„æ›´å¤§çš„æ ·æœ¬é›†ã€‚</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">å¼ é‡ aï¼š</span><br><span class="line">tensor([[<span class="number">1</span>, <span class="number">2</span>],</span><br><span class="line">        [<span class="number">3</span>, <span class="number">4</span>]])</span><br><span class="line">å¼ é‡ bï¼š</span><br><span class="line">tensor([[<span class="number">5</span>, <span class="number">6</span>],</span><br><span class="line">        [<span class="number">7</span>, <span class="number">8</span>]])</span><br><span class="line">åœ¨ç»´åº¦ <span class="number">0</span> ä¸Šæ‹¼æ¥åçš„å¼ é‡ cï¼š</span><br><span class="line">tensor([[<span class="number">1</span>, <span class="number">2</span>],</span><br><span class="line">        [<span class="number">3</span>, <span class="number">4</span>],</span><br><span class="line">        [<span class="number">5</span>, <span class="number">6</span>],</span><br><span class="line">        [<span class="number">7</span>, <span class="number">8</span>]])</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong><code>torch.reshape()</code></strong>ï¼šæ”¹å˜å¼ é‡çš„å½¢çŠ¶ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">x = torch.tensor([1, 2, 3, 4])</span><br><span class="line">reshaped_x = torch.reshape(x, (2, 2))</span><br></pre></td></tr></table></figure>
<p>åœ¨ç¥ç»ç½‘ç»œä¸­ï¼Œä¸åŒå±‚ä¹‹é—´çš„æ•°æ®å½¢çŠ¶å¯èƒ½éœ€è¦è¿›è¡Œè°ƒæ•´ï¼Œä½¿ç”¨ <code>torch.reshape()</code> å¯ä»¥æ–¹ä¾¿åœ°æ”¹å˜å¼ é‡å½¢çŠ¶ä»¥æ»¡è¶³å±‚çš„è¾“å…¥è¦æ±‚ã€‚</p>
<p><code>torch.reshape(x, (2, 2))</code> æ˜¯å°†ä¸€ç»´å¼ é‡ <code>x</code> é‡å¡‘ä¸ºäºŒç»´å¼ é‡ <code>reshaped_x</code>ï¼Œå½¢çŠ¶ä¸º <code>(2, 2)</code>ã€‚åœ¨ç¥ç»ç½‘ç»œä¸­ï¼Œä¸åŒå±‚ä¹‹é—´çš„æ•°æ®å½¢çŠ¶å¯èƒ½ä¸åŒ¹é…ï¼Œä¾‹å¦‚æŸä¸€å±‚çš„è¾“å‡ºæ˜¯ä¸€ç»´å‘é‡ï¼Œè€Œåç»­å±‚éœ€è¦äºŒç»´çŸ©é˜µä½œä¸ºè¾“å…¥ï¼Œè¿™æ—¶å°±å¯ä»¥ä½¿ç”¨ <code>torch.reshape()</code> æ¥è°ƒæ•´æ•°æ®çš„å½¢çŠ¶ï¼Œä½¿å…¶æ»¡è¶³å±‚çš„è¾“å…¥è¦æ±‚ã€‚</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">åŸå§‹å¼ é‡ xï¼š</span><br><span class="line">tensor([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>])</span><br><span class="line">é‡å¡‘åçš„å¼ é‡ reshaped_xï¼š</span><br><span class="line">tensor([[<span class="number">1</span>, <span class="number">2</span>],</span><br><span class="line">        [<span class="number">3</span>, <span class="number">4</span>]])</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong><code>torch.transpose()</code></strong>ï¼šäº¤æ¢å¼ é‡çš„ä¸¤ä¸ªç»´åº¦ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">x = torch.tensor([[1, 2], [3, 4]])</span><br><span class="line">transposed_x = torch.transpose(x, 0, 1)</span><br></pre></td></tr></table></figure>
<p>åœ¨çŸ©é˜µè¿ç®—ä¸­ï¼Œæœ‰æ—¶éœ€è¦å¯¹çŸ©é˜µè¿›è¡Œè½¬ç½®æ“ä½œã€‚åœ¨å›¾åƒå¤„ç†ä¸­ï¼Œå¯èƒ½éœ€è¦è°ƒæ•´å›¾åƒå¼ é‡çš„ç»´åº¦é¡ºåºã€‚</p>
<p><code>torch.transpose(x, 0, 1)</code> è¡¨ç¤ºäº¤æ¢å¼ é‡ <code>x</code> çš„ç¬¬ 0 ç»´å’Œç¬¬ 1 ç»´ã€‚åœ¨è¿™ä¸ªäºŒç»´çŸ©é˜µçš„ä¾‹å­ä¸­ï¼Œå°±æ˜¯å¯¹çŸ©é˜µè¿›è¡Œäº†è½¬ç½®æ“ä½œï¼ŒåŸæ¥çš„è¡Œå˜æˆäº†åˆ—ï¼Œåˆ—å˜æˆäº†è¡Œã€‚åœ¨çŸ©é˜µè¿ç®—ä¸­ï¼ŒçŸ©é˜µè½¬ç½®æ˜¯ä¸€ä¸ªå¸¸è§çš„æ“ä½œï¼Œä¾‹å¦‚åœ¨è®¡ç®—çŸ©é˜µä¹˜æ³•æ—¶å¯èƒ½éœ€è¦å¯¹çŸ©é˜µè¿›è¡Œè½¬ç½®ã€‚åœ¨å›¾åƒå¤„ç†ä¸­ï¼Œå›¾åƒå¼ é‡çš„ç»´åº¦é¡ºåºå¯èƒ½éœ€è¦è°ƒæ•´ï¼Œæ¯”å¦‚å°† <code>(é«˜åº¦, å®½åº¦, é€šé“æ•°)</code> è°ƒæ•´ä¸º <code>(é€šé“æ•°, é«˜åº¦, å®½åº¦)</code> ä»¥é€‚åº”æŸäº›æ¨¡å‹çš„è¾“å…¥è¦æ±‚ï¼Œè¿™æ—¶å°±å¯ä»¥ä½¿ç”¨ <code>torch.transpose()</code> æ¥å®ç°ã€‚</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">åŸå§‹å¼ é‡ xï¼š</span><br><span class="line">tensor([[<span class="number">1</span>, <span class="number">2</span>],</span><br><span class="line">        [<span class="number">3</span>, <span class="number">4</span>]])</span><br><span class="line">è½¬ç½®åçš„å¼ é‡ transposed_xï¼š</span><br><span class="line">tensor([[<span class="number">1</span>, <span class="number">3</span>],</span><br><span class="line">        [<span class="number">2</span>, <span class="number">4</span>]])</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><code>torch.squeeze()</code>ï¼šç§»é™¤å¼ é‡ä¸­æ‰€æœ‰ç»´åº¦ä¸º 1 çš„è½´ï¼ˆæˆ–æŒ‡å®šè½´ï¼‰ã€‚</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">x = torch.tensor([[[<span class="number">1</span>], [<span class="number">2</span>], [<span class="number">3</span>]]])  <span class="comment"># å½¢çŠ¶ [1, 3, 1]</span></span><br><span class="line">y = torch.squeeze(x)                 <span class="comment"># å½¢çŠ¶å˜ä¸º [3]</span></span><br></pre></td></tr></table></figure>
<p>åœ¨å¼ é‡æ“ä½œä¸­ï¼ŒæŸäº›æ“ä½œï¼ˆå¦‚æ± åŒ–ã€ç´¢å¼•ï¼‰å¯èƒ½äº§ç”Ÿå†—ä½™çš„ç»´åº¦ä¸º 1 çš„è½´ã€‚ä¾‹å¦‚ï¼š</p>
<ul>
<li>å¤„ç†å•é€šé“å›¾åƒæ—¶ï¼Œé€šé“ç»´åº¦å¯èƒ½ä¸º 1ã€‚</li>
<li>æ‰¹é‡å¤„ç†å•ä¸ªæ ·æœ¬æ—¶ï¼Œæ‰¹é‡ç»´åº¦å¯èƒ½ä¸º 1ã€‚</li>
<li>æŸäº›ç¥ç»ç½‘ç»œå±‚çš„è¾“å‡ºå¯èƒ½ä¿ç•™ä¸å¿…è¦çš„å•ç»´åº¦ã€‚</li>
</ul>
<p><code>torch.squeeze()</code> é»˜è®¤ç§»é™¤æ‰€æœ‰å¤§å°ä¸º 1 çš„ç»´åº¦ï¼Œä¹Ÿå¯æŒ‡å®š <code>dim</code> å‚æ•°ç§»é™¤ç‰¹å®šè½´ï¼ˆä»…å½“è¯¥è½´å¤§å°ä¸º 1 æ—¶ç”Ÿæ•ˆï¼‰ã€‚</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">è¾“å…¥å¼ é‡ xï¼š</span><br><span class="line">tensor([[[<span class="number">1</span>],</span><br><span class="line">         [<span class="number">2</span>],</span><br><span class="line">         [<span class="number">3</span>]]])</span><br><span class="line">è¾“å‡ºå¼ é‡ yï¼š</span><br><span class="line">tensor([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])</span><br><span class="line"></span><br><span class="line">squeeze() ç§»é™¤äº†æ‰€æœ‰å¤§å°ä¸º <span class="number">1</span> çš„ç»´åº¦ï¼ˆç¬¬ <span class="number">0</span> ç»´å’Œç¬¬ <span class="number">2</span> ç»´ï¼‰ï¼Œä»…ä¿ç•™ç¬¬ <span class="number">1</span> ç»´ï¼ˆå¤§å°ä¸º <span class="number">3</span>ï¼‰ã€‚</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="è‡ªåŠ¨æ±‚å¯¼">è‡ªåŠ¨æ±‚å¯¼</h4>
<h5 id="å‰å‘ä¼ æ’­ï¼ˆForward-Propagationï¼‰">å‰å‘ä¼ æ’­ï¼ˆForward Propagationï¼‰</h5>
<ol>
<li>å®šä¹‰</li>
</ol>
<p>å‰å‘ä¼ æ’­æ˜¯æ·±åº¦å­¦ä¹ æ¨¡å‹å¤„ç†è¾“å…¥æ•°æ®ä»¥äº§ç”Ÿè¾“å‡ºçš„è¿‡ç¨‹ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œè¾“å…¥æ•°æ®ä»è¾“å…¥å±‚å¼€å§‹ï¼Œä¾æ¬¡ç»è¿‡ç¥ç»ç½‘ç»œçš„å„ä¸ªéšè—å±‚ï¼Œæ¯å±‚éƒ½ä¼šå¯¹è¾“å…¥è¿›è¡Œç‰¹å®šçš„æ•°å­¦å˜æ¢ï¼ˆå¦‚åŠ æƒæ±‚å’Œåé€šè¿‡æ¿€æ´»å‡½æ•°ï¼‰ï¼Œæœ€ç»ˆåˆ°è¾¾è¾“å‡ºå±‚å¾—åˆ°é¢„æµ‹ç»“æœã€‚å¯ä»¥å°†å…¶çœ‹ä½œæ˜¯ä¿¡æ¯ä»è¾“å…¥å‘è¾“å‡ºæµåŠ¨çš„è¿‡ç¨‹ï¼Œæ¯ä¸€å±‚æ ¹æ®å‰ä¸€å±‚çš„è¾“å‡ºè®¡ç®—æœ¬å±‚çš„è¾“å‡ºï¼Œé€æ­¥ä¼ é€’ç›´è‡³å¾—åˆ°æœ€ç»ˆè¾“å‡ºã€‚</p>
<ol start="2">
<li>ä½œç”¨</li>
</ol>
<p>æ ¹æ®å½“å‰æ¨¡å‹çš„å‚æ•°ï¼ˆæƒé‡å’Œåç½®ï¼‰å¯¹è¾“å…¥æ•°æ®è¿›è¡Œé¢„æµ‹ã€‚é€šè¿‡ä¸€ç³»åˆ—çš„çº¿æ€§å’Œéçº¿æ€§å˜æ¢ï¼Œæ¨¡å‹èƒ½å¤Ÿå­¦ä¹ åˆ°è¾“å…¥æ•°æ®ä¸­çš„ç‰¹å¾æ¨¡å¼ï¼Œå¹¶å°†å…¶æ˜ å°„åˆ°è¾“å‡ºç©ºé—´ã€‚ä¾‹å¦‚ï¼Œåœ¨å›¾åƒåˆ†ç±»ä»»åŠ¡ä¸­ï¼Œå‰å‘ä¼ æ’­å¯ä»¥å°†è¾“å…¥çš„å›¾åƒè½¬æ¢ä¸ºä¸åŒç±»åˆ«çš„æ¦‚ç‡åˆ†å¸ƒï¼Œä»è€Œåˆ¤æ–­å›¾åƒæ‰€å±çš„ç±»åˆ«ã€‚å®ƒä¸ºåç»­çš„åå‘ä¼ æ’­æä¾›äº†é¢„æµ‹ç»“æœï¼Œæ˜¯æ•´ä¸ªæ·±åº¦å­¦ä¹ è®­ç»ƒè¿‡ç¨‹çš„åŸºç¡€æ­¥éª¤ã€‚</p>
<h5 id="åå‘ä¼ æ’­ï¼ˆBackward-Propagationï¼‰">åå‘ä¼ æ’­ï¼ˆBackward Propagationï¼‰</h5>
<ol>
<li>å®šä¹‰</li>
</ol>
<p>åå‘ä¼ æ’­æ˜¯æ·±åº¦å­¦ä¹ ä¸­ç”¨äºè®¡ç®—æŸå¤±å‡½æ•°ï¼ˆLoss Functionï¼‰å…³äºæ¨¡å‹å‚æ•°ï¼ˆæƒé‡å’Œåç½®ï¼‰çš„æ¢¯åº¦çš„ç®—æ³•ã€‚å®ƒåŸºäºé“¾å¼æ³•åˆ™ï¼Œä»è¾“å‡ºå±‚å¼€å§‹ï¼Œå°†æŸå¤±å‡½æ•°çš„è¯¯å·®æ²¿ç€è®¡ç®—å›¾åå‘ä¼ æ’­åˆ°è¾“å…¥å±‚ï¼Œä¾æ¬¡è®¡ç®—æ¯ä¸€å±‚å‚æ•°çš„æ¢¯åº¦ã€‚ç®€å•æ¥è¯´ï¼Œåå‘ä¼ æ’­æ˜¯åœ¨å·²çŸ¥å‰å‘ä¼ æ’­å¾—åˆ°çš„é¢„æµ‹ç»“æœå’ŒçœŸå®æ ‡ç­¾çš„æƒ…å†µä¸‹ï¼Œè®¡ç®—å¦‚ä½•è°ƒæ•´æ¨¡å‹å‚æ•°å¯ä»¥å‡å°æŸå¤±çš„è¿‡ç¨‹ã€‚</p>
<ol start="2">
<li>ä½œç”¨</li>
</ol>
<p>ä¸ºæ¨¡å‹å‚æ•°çš„æ›´æ–°æä¾›ä¾æ®ã€‚åœ¨æ·±åº¦å­¦ä¹ ä¸­ï¼Œé€šå¸¸ä½¿ç”¨ä¼˜åŒ–ç®—æ³•ï¼ˆå¦‚éšæœºæ¢¯åº¦ä¸‹é™ï¼ŒStochastic Gradient Descentï¼ŒSGDï¼‰æ¥æ›´æ–°æ¨¡å‹çš„å‚æ•°ï¼Œè€Œè¿™äº›ä¼˜åŒ–ç®—æ³•éœ€è¦çŸ¥é“æŸå¤±å‡½æ•°å…³äºå‚æ•°çš„æ¢¯åº¦ã€‚åå‘ä¼ æ’­é€šè¿‡é«˜æ•ˆåœ°è®¡ç®—è¿™äº›æ¢¯åº¦ï¼Œä½¿å¾—æ¨¡å‹èƒ½å¤Ÿæ ¹æ®é¢„æµ‹è¯¯å·®è‡ªåŠ¨è°ƒæ•´å‚æ•°ï¼Œä»è€Œä¸æ–­ä¼˜åŒ–æ¨¡å‹çš„æ€§èƒ½ã€‚é€šè¿‡å¤šæ¬¡è¿­ä»£å‰å‘ä¼ æ’­å’Œåå‘ä¼ æ’­ï¼Œæ¨¡å‹å¯ä»¥é€æ¸å­¦ä¹ åˆ°è¾“å…¥æ•°æ®å’Œè¾“å‡ºæ ‡ç­¾ä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼Œæé«˜é¢„æµ‹çš„å‡†ç¡®æ€§ã€‚</p>
<h5 id="è®¡ç®—å›¾ä¸æ¢¯åº¦è¿½è¸ªï¼ˆå¯ç•¥è¿‡ï¼‰">è®¡ç®—å›¾ä¸æ¢¯åº¦è¿½è¸ªï¼ˆå¯ç•¥è¿‡ï¼‰</h5>
<ol>
<li><code>requires_grad</code>è®¾ç½®å¼ é‡æ˜¯å¦éœ€è¦è¿›è¡Œæ¢¯åº¦è¿½è¸ª</li>
</ol>
<p>åœ¨æ·±åº¦å­¦ä¹ æ¨¡å‹è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œéœ€è¦è®¡ç®—æŸå¤±å‡½æ•°å…³äºæ¨¡å‹å‚æ•°çš„æ¢¯åº¦ï¼Œä»¥ä¾¿ä½¿ç”¨ä¼˜åŒ–ç®—æ³•ï¼ˆå¦‚éšæœºæ¢¯åº¦ä¸‹é™ï¼‰æ›´æ–°å‚æ•°ã€‚é€šè¿‡å°†æ¨¡å‹å‚æ•°å¼ é‡çš„ <code>requires_grad</code> è®¾ç½®ä¸º <code>True</code>ï¼Œå¯ä»¥åˆ©ç”¨è‡ªåŠ¨æ±‚å¯¼æœºåˆ¶è‡ªåŠ¨è®¡ç®—æ¢¯åº¦ã€‚</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">x = torch.tensor([<span class="number">2.0</span>], requires_grad=<span class="literal">True</span>)</span><br><span class="line">y = x ** <span class="number">2</span></span><br><span class="line">y.backward()</span><br><span class="line"><span class="built_in">print</span>(x.grad)  <span class="comment"># è¾“å‡º 4.0</span></span><br></pre></td></tr></table></figure>
<p><code>requires_grad</code> æ˜¯ PyTorch å¼ é‡çš„ä¸€ä¸ªå±æ€§ï¼Œå½“å°†å…¶è®¾ç½®ä¸º <code>True</code> æ—¶ï¼ŒPyTorch ä¼šå¼€å§‹è¿½è¸ªè¯¥å¼ é‡çš„æ‰€æœ‰æ“ä½œï¼Œæ„å»ºè®¡ç®—å›¾ã€‚è®¡ç®—å›¾æ˜¯ä¸€ä¸ªæœ‰å‘æ— ç¯å›¾ï¼Œå®ƒè®°å½•äº†ä»è¾“å…¥å¼ é‡åˆ°è¾“å‡ºå¼ é‡çš„æ‰€æœ‰æ“ä½œè·¯å¾„ã€‚</p>
<p>åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªå¼ é‡ <code>x</code> å¹¶å°† <code>requires_grad</code> è®¾ç½®ä¸º <code>True</code>ï¼Œç„¶åå®šä¹‰äº†ä¸€ä¸ªå‡½æ•° <code>y = x ** 2</code>ã€‚PyTorch ä¼šè‡ªåŠ¨è®°å½•è¿™ä¸ªæ“ä½œï¼Œæ„å»ºç›¸åº”çš„è®¡ç®—å›¾ã€‚</p>
<p>è°ƒç”¨ <code>y.backward()</code> æ–¹æ³•æ—¶ï¼ŒPyTorch ä¼šæ ¹æ®é“¾å¼æ³•åˆ™æ²¿ç€è®¡ç®—å›¾åå‘ä¼ æ’­ï¼Œè®¡ç®—å‡º <code>y</code> å…³äº <code>x</code> çš„æ¢¯åº¦ï¼Œå¹¶å°†æ¢¯åº¦å­˜å‚¨åœ¨ <code>x.grad</code> å±æ€§ä¸­ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">x çš„æ¢¯åº¦: tensor([4.])</span><br></pre></td></tr></table></figure>
<ol start="2">
<li><code>grad_fn</code> å±æ€§ä¸åå‘ä¼ æ’­é“¾</li>
</ol>
<p><strong><code>grad_fn</code></strong>ï¼šPyTorch å¼ é‡çš„å±æ€§ï¼ŒæŒ‡å‘åˆ›å»ºè¯¥å¼ é‡çš„å‡½æ•°å¯¹è±¡ï¼Œç”¨äºè®°å½•æ“ä½œå†å²ä»¥æ”¯æŒåå‘ä¼ æ’­æ±‚æ¢¯åº¦ã€‚</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ªéœ€è¦æ¢¯åº¦è¿½è¸ªçš„å¼ é‡</span></span><br><span class="line">x = torch.tensor([<span class="number">2.0</span>], requires_grad=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># å®šä¹‰æ“ä½œ y = x^2</span></span><br><span class="line">y = x ** <span class="number">2</span></span><br><span class="line"><span class="comment"># å®šä¹‰æ“ä½œ z = y * 3</span></span><br><span class="line">z = y * <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰“å°æ¯ä¸ªå¼ é‡çš„ grad_fn</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;y çš„ grad_fn:&quot;</span>, y.grad_fn)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;z çš„ grad_fn:&quot;</span>, z.grad_fn)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿›è¡Œåå‘ä¼ æ’­</span></span><br><span class="line">z.backward()</span><br><span class="line"><span class="comment"># æ‰“å° x çš„æ¢¯åº¦</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;x çš„æ¢¯åº¦:&quot;</span>, x.grad)</span><br></pre></td></tr></table></figure>
<p>åœ¨æ·±åº¦å­¦ä¹ æ¨¡å‹è®­ç»ƒæ—¶ï¼Œéœ€è¦è®¡ç®—æŸå¤±å‡½æ•°å…³äºæ¨¡å‹å‚æ•°çš„æ¢¯åº¦ã€‚ç”±äºæ¨¡å‹ä¸­å­˜åœ¨å¤§é‡å¤æ‚çš„è¿ç®—ï¼Œé€šè¿‡ <code>grad_fn</code> è®°å½•çš„æ“ä½œå†å²ï¼ŒPyTorch å¯ä»¥æ„å»ºåå‘ä¼ æ’­é“¾ï¼Œä»è€Œå‡†ç¡®è®¡ç®—å‡ºæ¢¯åº¦ï¼Œä¸ºå‚æ•°æ›´æ–°æä¾›ä¾æ®ã€‚</p>
<p>åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œé¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ªå¼€å¯æ¢¯åº¦è¿½è¸ªçš„å¼ é‡ <code>x</code>ã€‚å½“æ‰§è¡Œ $y = x^2$æ“ä½œæ—¶ï¼ŒPyTorch ä¼šåˆ›å»ºä¸€ä¸ªè¡¨ç¤ºå¹³æ–¹æ“ä½œçš„å‡½æ•°å¯¹è±¡ï¼Œ<code>y.grad_fn</code> å°±ä¼šæŒ‡å‘è¿™ä¸ªå‡½æ•°å¯¹è±¡ï¼Œä»¥æ­¤è®°å½•ä¸‹ <code>y</code> æ˜¯ç”± <code>x</code> ç»è¿‡å¹³æ–¹æ“ä½œå¾—åˆ°çš„ã€‚æ¥ç€æ‰§è¡Œ $z = 3y$ï¼ŒåŒæ ·åœ°ï¼Œ<code>z.grad_fn</code> ä¼šæŒ‡å‘è¡¨ç¤ºä¹˜æ³•æ“ä½œçš„å‡½æ•°å¯¹è±¡ï¼Œè®°å½• <code>z</code> çš„è®¡ç®—æ¥æºã€‚</p>
<p>å½“è°ƒç”¨ <code>z.backward()</code> æ—¶ï¼ŒPyTorch ä¼šä» <code>z</code> å¼€å§‹ï¼Œä¾æ® <code>z.grad_fn</code> æ‰¾åˆ°åˆ›å»º <code>z</code> çš„æ“ä½œï¼Œç„¶åé€šè¿‡è¿™ä¸ªæ“ä½œå›æº¯åˆ° <code>y</code>ï¼Œå†æ ¹æ® <code>y.grad_fn</code> å›æº¯åˆ° <code>x</code>ã€‚åœ¨è¿™ä¸ªå›æº¯è¿‡ç¨‹ä¸­ï¼ŒæŒ‰ç…§é“¾å¼æ³•åˆ™é€æ­¥è®¡ç®—å‡º <code>z</code> å…³äº <code>x</code> çš„æ¢¯åº¦ï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨ <code>x.grad</code> ä¸­ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">y çš„ grad_fn: &lt;PowBackward0 object at 0x...&gt;</span><br><span class="line">z çš„ grad_fn: &lt;MulBackward0 object at 0x...&gt;</span><br><span class="line">x çš„æ¢¯åº¦: tensor([12.])</span><br></pre></td></tr></table></figure>
<p><code>&lt;PowBackward0 object at 0x...&gt;</code> æ˜¯ PyTorch ä¸­ç”¨äºè¡¨ç¤ºåå‘ä¼ æ’­è¿‡ç¨‹ä¸­ç‰¹å®šæ“ä½œçš„æ¢¯åº¦è®¡ç®—å‡½æ•°å¯¹è±¡çš„å­—ç¬¦ä¸²è¡¨ç¤ºå½¢å¼ã€‚</p>
<p><strong>åå‘ä¼ æ’­å‡½æ•°å¯¹è±¡</strong>ï¼šåœ¨ PyTorch çš„è‡ªåŠ¨æ±‚å¯¼æœºåˆ¶é‡Œï¼Œå¯¹å¼ é‡è¿›è¡Œå„ç§è¿ç®—ï¼ˆå¦‚åŠ æ³•ã€ä¹˜æ³•ã€å¹‚è¿ç®—ç­‰ï¼‰æ—¶ï¼ŒPyTorch ä¼šæ„å»ºä¸€ä¸ªè®¡ç®—å›¾æ¥è®°å½•è¿™äº›æ“ä½œçš„é¡ºåºå’Œä¾èµ–å…³ç³»ã€‚æ¯ä¸ªæ“ä½œåœ¨è®¡ç®—å›¾ä¸­éƒ½å¯¹åº”ä¸€ä¸ªå‰å‘ä¼ æ’­å‡½æ•°ï¼ˆç”¨äºè®¡ç®—è¾“å‡ºç»“æœï¼‰å’Œä¸€ä¸ªåå‘ä¼ æ’­å‡½æ•°ï¼ˆç”¨äºè®¡ç®—æ¢¯åº¦ï¼‰ã€‚</p>
<p><code>PowBackward0</code> çš„æ„ä¹‰ï¼š<code>PowBackward0</code> è¡¨ç¤ºçš„æ˜¯å¹‚è¿ç®—çš„åå‘ä¼ æ’­å‡½æ•°ã€‚æ‰§è¡Œ $y = x^2$è¿™æ ·çš„å¹‚è¿ç®—æ—¶ï¼Œ<code>y</code> çš„ <code>grad_fn</code> å±æ€§å°±ä¼šæŒ‡å‘ä¸€ä¸ª <code>PowBackward0</code> å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡è´Ÿè´£åœ¨åå‘ä¼ æ’­è¿‡ç¨‹ä¸­è®¡ç®—å…³äºè¾“å…¥å¼ é‡ <code>x</code> çš„æ¢¯åº¦ã€‚<strong><code>at 0x...</code></strong>ï¼š<code>at 0x...</code> åé¢è·Ÿç€çš„æ˜¯è¯¥å¯¹è±¡åœ¨å†…å­˜ä¸­çš„åœ°å€ã€‚è¿™ä¸ªåœ°å€æ˜¯ç³»ç»Ÿä¸ºè¯¥å¯¹è±¡åˆ†é…çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œç”¨äºåœ¨å†…å­˜ä¸­å®šä½è¯¥å¯¹è±¡ã€‚</p>
<h5 id="æ¢¯åº¦æ§åˆ¶ï¼ˆå¯ç•¥è¿‡ï¼‰">æ¢¯åº¦æ§åˆ¶ï¼ˆå¯ç•¥è¿‡ï¼‰</h5>
<p>1.<code>torch.no_grad()</code> ä¸Šä¸‹æ–‡ç®¡ç†å™¨</p>
<p>ç”¨äºä¸´æ—¶ç¦æ­¢ PyTorch çš„æ¢¯åº¦è®¡ç®—åŠŸèƒ½ï¼Œåœ¨å…¶ä½œç”¨åŸŸå†…åˆ›å»ºæˆ–æ“ä½œçš„å¼ é‡ä¸ä¼šè¿›è¡Œæ¢¯åº¦è¿½è¸ªã€‚</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ªéœ€è¦æ¢¯åº¦è¿½è¸ªçš„å¼ é‡</span></span><br><span class="line">x = torch.tensor([<span class="number">2.0</span>], requires_grad=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ torch.no_grad() ä¸Šä¸‹æ–‡ç®¡ç†å™¨</span></span><br><span class="line"><span class="keyword">with</span> torch.no_grad():</span><br><span class="line">    y = x ** <span class="number">2</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;y æ˜¯å¦è¿›è¡Œæ¢¯åº¦è¿½è¸ª:&quot;</span>, y.requires_grad)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨å¤–è¿›è¡Œæ“ä½œ</span></span><br><span class="line">z = x ** <span class="number">2</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;z æ˜¯å¦è¿›è¡Œæ¢¯åº¦è¿½è¸ª:&quot;</span>, z.requires_grad)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">y æ˜¯å¦è¿›è¡Œæ¢¯åº¦è¿½è¸ª: False</span><br><span class="line">z æ˜¯å¦è¿›è¡Œæ¢¯åº¦è¿½è¸ª: Trueï¼ˆzåœ¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨å¤–è¿›è¡Œæ“ä½œï¼‰</span><br></pre></td></tr></table></figure>
<p>2.<code>detach()</code> åˆ†ç¦»è®¡ç®—å›¾</p>
<p><strong><code>detach()</code></strong>ï¼šç”¨äºå°†å¼ é‡ä»å½“å‰è®¡ç®—å›¾ä¸­åˆ†ç¦»ï¼Œè¿”å›ä¸€ä¸ªå’ŒåŸå¼ é‡æ•°æ®ç›¸åŒä½†ä¸è®°å½•æ¢¯åº¦ä¿¡æ¯ã€ä¸å‚ä¸åå‘ä¼ æ’­çš„æ–°å¼ é‡ã€‚</p>
<ul>
<li>åœ¨æ¨¡å‹è¯„ä¼°é˜¶æ®µï¼Œåªéœ€å¾—åˆ°é¢„æµ‹ç»“æœï¼Œæ— éœ€è®¡ç®—æ¢¯åº¦ï¼Œç”¨ <code>detach()</code> å¯èŠ‚çœå†…å­˜å’Œè®¡ç®—èµ„æºã€‚</li>
<li>åœ¨å¤šæ¨¡å‹è”åˆè®­ç»ƒæ—¶ï¼Œè‹¥æŸä¸ªæ¨¡å‹è¾“å‡ºç”¨äºå¦ä¸€æ¨¡å‹ä½†ä¸å½±å“è‡ªèº«æ¢¯åº¦è®¡ç®—ï¼Œå¯ä½¿ç”¨ <code>detach()</code> åˆ†ç¦»ã€‚ï¼ˆæ ¸å¿ƒè¿˜æ˜¯èŠ‚çœå†…å­˜å’Œè®¡ç®—èµ„æºï¼‰</li>
</ul>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºéœ€æ¢¯åº¦è¿½è¸ªçš„å¼ é‡</span></span><br><span class="line">x = torch.tensor([<span class="number">3.0</span>], requires_grad=<span class="literal">True</span>)</span><br><span class="line">y = <span class="number">2</span> * x</span><br><span class="line"><span class="comment"># åˆ†ç¦»è®¡ç®—å›¾</span></span><br><span class="line">y_detached = y.detach()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;åŸå¼ é‡ y æ˜¯å¦è¿½è¸ªæ¢¯åº¦:&quot;</span>, y.requires_grad)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;åˆ†ç¦»åçš„å¼ é‡ y_detached æ˜¯å¦è¿½è¸ªæ¢¯åº¦:&quot;</span>, y_detached.requires_grad)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    y_detached.backward()</span><br><span class="line"><span class="keyword">except</span> RuntimeError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;é”™è¯¯ä¿¡æ¯: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°ä»£ç é‡Œï¼Œ<code>x</code> å¼€å¯æ¢¯åº¦è¿½è¸ªï¼Œ<code>y = 2 * x</code> ä¼šè®°å½•åœ¨è®¡ç®—å›¾ä¸­ã€‚è°ƒç”¨ <code>y.detach()</code> åå¾—åˆ° <code>y_detached</code>ï¼Œå®ƒå’Œ <code>y</code> æ•°æ®ç›¸åŒï¼Œä½†ä¸è¿½è¸ªæ¢¯åº¦ã€‚å°è¯•å¯¹ <code>y_detached</code> åå‘ä¼ æ’­ä¼šæŠ¥é”™ï¼Œå› ä¸ºå®ƒå·²å’Œè®¡ç®—å›¾åˆ†ç¦»ï¼Œæ— æ¢¯åº¦ä¿¡æ¯ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">åŸå¼ é‡ y æ˜¯å¦è¿½è¸ªæ¢¯åº¦: True</span><br><span class="line">åˆ†ç¦»åçš„å¼ é‡ y_detached æ˜¯å¦è¿½è¸ªæ¢¯åº¦: False</span><br><span class="line">é”™è¯¯ä¿¡æ¯: element 0 of tensors does not require grad and does not have a grad_fn</span><br></pre></td></tr></table></figure>
<p>3.<code>zero_grad()</code> (æ¢¯åº¦æ¸…é›¶)</p>
<p>åœ¨æ·±åº¦å­¦ä¹ æ¨¡å‹çš„è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œé€šå¸¸ä¼šæŒ‰æ‰¹æ¬¡ï¼ˆbatchï¼‰è¾“å…¥æ•°æ®è¿›è¡Œè®­ç»ƒã€‚æ¯æ¬¡åå‘ä¼ æ’­è®¡ç®—å¾—åˆ°çš„æ¢¯åº¦ä¼šç´¯åŠ åˆ°æ¨¡å‹å‚æ•°çš„ <code>.grad</code> å±æ€§ä¸­ã€‚å¦‚æœä¸è¿›è¡Œæ¢¯åº¦æ¸…é›¶ï¼Œé‚£ä¹ˆä¸‹ä¸€æ¬¡è®¡ç®—çš„æ¢¯åº¦ä¼šä¸ä¹‹å‰çš„æ¢¯åº¦ç´¯åŠ ï¼Œå¯¼è‡´æ¢¯åº¦è®¡ç®—é”™è¯¯ã€‚å› æ­¤ï¼Œåœ¨æ¯ä¸ªæ‰¹æ¬¡è®­ç»ƒå¼€å§‹å‰ï¼Œéœ€è¦è°ƒç”¨ <code>zero_grad()</code> æ–¹æ³•å°†æ¢¯åº¦æ¸…é›¶ï¼Œä»¥ç¡®ä¿æ¯ä¸ªæ‰¹æ¬¡çš„æ¢¯åº¦è®¡ç®—æ˜¯ç‹¬ç«‹çš„ã€‚</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.optim <span class="keyword">as</span> optim</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ä¸€ä¸ªç®€å•çš„çº¿æ€§æ¨¡å‹</span></span><br><span class="line">model = nn.Linear(<span class="number">10</span>, <span class="number">1</span>)</span><br><span class="line"><span class="comment"># å®šä¹‰ä¼˜åŒ–å™¨</span></span><br><span class="line">optimizer = optim.SGD(model.parameters(), lr=<span class="number">0.01</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¨¡æ‹Ÿè¾“å…¥æ•°æ®</span></span><br><span class="line">input_tensor = torch.randn(<span class="number">1</span>, <span class="number">10</span>)</span><br><span class="line">target = torch.randn(<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å‰å‘ä¼ æ’­</span></span><br><span class="line">output = model(input_tensor)</span><br><span class="line"><span class="comment"># è®¡ç®—æŸå¤±</span></span><br><span class="line">criterion = nn.MSELoss()</span><br><span class="line">loss = criterion(output, target)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åå‘ä¼ æ’­è®¡ç®—æ¢¯åº¦</span></span><br><span class="line">loss.backward()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;åå‘ä¼ æ’­åç¬¬ä¸€ä¸ªå‚æ•°çš„æ¢¯åº¦:&quot;</span>, model.weight.grad)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¢¯åº¦æ¸…é›¶</span></span><br><span class="line">optimizer.zero_grad()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;æ¢¯åº¦æ¸…é›¶åç¬¬ä¸€ä¸ªå‚æ•°çš„æ¢¯åº¦:&quot;</span>, model.weight.grad)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">åå‘ä¼ æ’­åç¬¬ä¸€ä¸ªå‚æ•°çš„æ¢¯åº¦: tensor([[ 0.1234, -0.5678, ...]])</span><br><span class="line">æ¢¯åº¦æ¸…é›¶åç¬¬ä¸€ä¸ªå‚æ•°çš„æ¢¯åº¦: tensor([[ 0., 0., ...]])</span><br></pre></td></tr></table></figure>
<h4 id="ç¥ç»ç½‘ç»œå±‚">ç¥ç»ç½‘ç»œå±‚</h4>
<h5 id="æ ¸å¿ƒåŸºç±»-nn-Module">æ ¸å¿ƒåŸºç±» <code>nn.Module</code></h5>
<h6 id="ä»€ä¹ˆæ˜¯æ ¸å¿ƒåŸºç±»-nn-Moduleï¼Ÿ">ä»€ä¹ˆæ˜¯æ ¸å¿ƒåŸºç±» <code>nn.Module</code>ï¼Ÿ</h6>
<p><strong><code>nn.Module</code></strong>ï¼šPyTorch ä¸­æ‰€æœ‰ç¥ç»ç½‘ç»œæ¨¡å—çš„åŸºç±»ï¼Œç”¨äºæ„å»ºè‡ªå®šä¹‰çš„ç¥ç»ç½‘ç»œæ¨¡å‹ï¼Œå°è£…äº†æ¨¡å‹çš„ç»“æ„å’Œå‚æ•°ï¼Œæ–¹ä¾¿è¿›è¡Œå‰å‘ä¼ æ’­ã€å‚æ•°ç®¡ç†å’Œæ¨¡å‹ä¿å­˜ç­‰æ“ä½œã€‚</p>
<p>åœ¨æ·±åº¦å­¦ä¹ ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ„å»ºå„ç§å„æ ·çš„ç¥ç»ç½‘ç»œæ¨¡å‹ï¼Œå¦‚å·ç§¯ç¥ç»ç½‘ç»œï¼ˆCNNï¼‰ã€å¾ªç¯ç¥ç»ç½‘ç»œï¼ˆRNNï¼‰ç­‰ã€‚<code>nn.Module</code> æä¾›äº†ä¸€ä¸ªç»Ÿä¸€çš„æ¡†æ¶ï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥æ–¹ä¾¿åœ°å®šä¹‰å’Œç®¡ç†è¿™äº›æ¨¡å‹ã€‚æ— è®ºæ˜¯ç®€å•çš„å…¨è¿æ¥ç½‘ç»œè¿˜æ˜¯å¤æ‚çš„æ·±åº¦ç½‘ç»œï¼Œéƒ½å¯ä»¥é€šè¿‡ç»§æ‰¿ <code>nn.Module</code> æ¥æ„å»ºã€‚</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"></span><br><span class="line"><span class="comment"># è‡ªå®šä¹‰ä¸€ä¸ªç®€å•çš„ç¥ç»ç½‘ç»œæ¨¡å‹ï¼Œç»§æ‰¿è‡ª nn.Module</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SimpleNet</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>(SimpleNet, <span class="variable language_">self</span>).__init__()</span><br><span class="line">        <span class="comment"># å®šä¹‰ä¸€ä¸ªå…¨è¿æ¥å±‚ï¼Œè¾“å…¥ç»´åº¦ä¸º 10ï¼Œè¾“å‡ºç»´åº¦ä¸º 1</span></span><br><span class="line">        <span class="variable language_">self</span>.fc = nn.Linear(<span class="number">10</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        <span class="comment"># å®šä¹‰å‰å‘ä¼ æ’­è¿‡ç¨‹</span></span><br><span class="line">        x = <span class="variable language_">self</span>.fc(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºæ¨¡å‹å®ä¾‹</span></span><br><span class="line">model = SimpleNet()</span><br><span class="line"><span class="comment"># æ¨¡æ‹Ÿè¾“å…¥æ•°æ®</span></span><br><span class="line">input_tensor = torch.randn(<span class="number">1</span>, <span class="number">10</span>)</span><br><span class="line"><span class="comment"># è¿›è¡Œå‰å‘ä¼ æ’­</span></span><br><span class="line">output = model(input_tensor)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;æ¨¡å‹ç»“æ„ï¼š&quot;</span>, model)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;è¾“å…¥å¼ é‡å½¢çŠ¶ï¼š&quot;</span>, input_tensor.shape)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;è¾“å‡ºå¼ é‡å½¢çŠ¶ï¼š&quot;</span>, output.shape)</span><br></pre></td></tr></table></figure>
<ul>
<li><strong><code>__init__</code> æ–¹æ³•</strong>ï¼šåœ¨è‡ªå®šä¹‰çš„æ¨¡å‹ç±»ä¸­ï¼Œ<code>__init__</code> æ–¹æ³•ç”¨äºåˆå§‹åŒ–æ¨¡å‹çš„å„ä¸ªå±‚ã€‚é€šè¿‡è°ƒç”¨ <code>super(SimpleNet, self).__init__()</code> ç¡®ä¿çˆ¶ç±» <code>nn.Module</code> çš„åˆå§‹åŒ–è¢«æ­£ç¡®æ‰§è¡Œã€‚ç„¶åå®šä¹‰äº†ä¸€ä¸ªå…¨è¿æ¥å±‚ <code>self.fc</code>ã€‚</li>
<li><strong><code>forward</code> æ–¹æ³•</strong>ï¼š<code>forward</code> æ–¹æ³•å®šä¹‰äº†æ¨¡å‹çš„å‰å‘ä¼ æ’­è¿‡ç¨‹ï¼Œå³è¾“å…¥æ•°æ®å¦‚ä½•ç»è¿‡å„ä¸ªå±‚å¾—åˆ°è¾“å‡ºã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œè¾“å…¥æ•°æ® <code>x</code> ç»è¿‡å…¨è¿æ¥å±‚ <code>self.fc</code> å¾—åˆ°è¾“å‡ºã€‚</li>
<li>æ¨¡å‹å®ä¾‹åŒ–å’Œå‰å‘ä¼ æ’­ï¼šåˆ›å»º <code>SimpleNet</code> çš„å®ä¾‹ <code>model</code> åï¼Œå°†è¾“å…¥å¼ é‡ <code>input_tensor</code> ä¼ é€’ç»™ <code>model</code> å°±ç›¸å½“äºè°ƒç”¨äº† <code>forward</code> æ–¹æ³•è¿›è¡Œå‰å‘ä¼ æ’­ï¼Œå¾—åˆ°è¾“å‡º <code>output</code>ã€‚</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ¨¡å‹ç»“æ„ï¼š SimpleNet(</span><br><span class="line">  (fc): Linear(in_features=10, out_features=1, bias=True)</span><br><span class="line">)</span><br><span class="line">è¾“å…¥å¼ é‡å½¢çŠ¶ï¼š torch.Size([1, 10])</span><br><span class="line">è¾“å‡ºå¼ é‡å½¢çŠ¶ï¼š torch.Size([1, 1])</span><br></pre></td></tr></table></figure>
<h6 id="è‡ªå®šä¹‰æ¨¡å‹ç»§æ‰¿æ–¹æ³•">è‡ªå®šä¹‰æ¨¡å‹ç»§æ‰¿æ–¹æ³•</h6>
<ol>
<li>å‚æ•°ç®¡ç†<code>parameters()</code>ï¼Œ<code>named_parameters()</code></li>
</ol>
<p><strong><code>parameters()</code></strong>ï¼šæ˜¯ <code>nn.Module</code> ç±»çš„ä¸€ä¸ªæ–¹æ³•ï¼Œå®ƒè¿”å›ä¸€ä¸ªåŒ…å«æ¨¡å‹æ‰€æœ‰å¯å­¦ä¹ å‚æ•°çš„è¿­ä»£å™¨ã€‚é€šè¿‡éå†è¿™ä¸ªè¿­ä»£å™¨ï¼Œèƒ½ä¾æ¬¡è·å–åˆ°æ¨¡å‹ä¸­çš„å„ä¸ªå‚æ•°å¼ é‡ï¼Œä½†ä¸ä¼šæä¾›å‚æ•°çš„åç§°ä¿¡æ¯ã€‚</p>
<p><strong><code>named_parameters()</code></strong>ï¼šåŒæ ·æ˜¯ <code>nn.Module</code> ç±»çš„æ–¹æ³•ï¼Œå®ƒè¿”å›ä¸€ä¸ªè¿­ä»£å™¨ï¼Œè¯¥è¿­ä»£å™¨ä¼šç”Ÿæˆæ¨¡å‹å¯å­¦ä¹ å‚æ•°çš„åç§°å’Œå¯¹åº”å‚æ•°å¼ é‡çš„å…ƒç»„ã€‚å€ŸåŠ©è¿™ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬ä¸ä»…èƒ½è·å–å‚æ•°å¼ é‡ï¼Œè¿˜èƒ½æ˜ç¡®æ¯ä¸ªå‚æ•°å¯¹åº”çš„åç§°ï¼Œè¿™åœ¨æ¨¡å‹å‚æ•°ç®¡ç†å’Œè°ƒè¯•æ—¶éå¸¸æœ‰ç”¨ã€‚</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ä¸€ä¸ªç®€å•çš„ç¥ç»ç½‘ç»œæ¨¡å‹ï¼Œç»§æ‰¿è‡ª nn.Module</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SimpleNet</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>(SimpleNet, <span class="variable language_">self</span>).__init__()</span><br><span class="line">        <span class="comment"># å®šä¹‰ä¸€ä¸ªå…¨è¿æ¥å±‚ï¼Œè¾“å…¥ç»´åº¦ä¸º 10ï¼Œè¾“å‡ºç»´åº¦ä¸º 5</span></span><br><span class="line">        <span class="variable language_">self</span>.fc1 = nn.Linear(<span class="number">10</span>, <span class="number">5</span>)</span><br><span class="line">        <span class="comment"># å®šä¹‰å¦ä¸€ä¸ªå…¨è¿æ¥å±‚ï¼Œè¾“å…¥ç»´åº¦ä¸º 5ï¼Œè¾“å‡ºç»´åº¦ä¸º 1</span></span><br><span class="line">        <span class="variable language_">self</span>.fc2 = nn.Linear(<span class="number">5</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        x = <span class="variable language_">self</span>.fc1(x)</span><br><span class="line">        x = <span class="variable language_">self</span>.fc2(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºæ¨¡å‹å®ä¾‹</span></span><br><span class="line">model = SimpleNet()</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ parameters() æ–¹æ³•è·å–æ¨¡å‹å‚æ•°çš„è¿­ä»£å™¨</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;ä½¿ç”¨ parameters() è·å–å‚æ•°ï¼š&quot;</span>)</span><br><span class="line">params = model.parameters()</span><br><span class="line"><span class="keyword">for</span> param <span class="keyword">in</span> params:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;å‚æ•°å½¢çŠ¶: <span class="subst">&#123;param.shape&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ named_parameters() æ–¹æ³•è·å–æ¨¡å‹å¸¦åç§°çš„å‚æ•°è¿­ä»£å™¨</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;\nä½¿ç”¨ named_parameters() è·å–å‚æ•°ï¼š&quot;</span>)</span><br><span class="line">named_params = model.named_parameters()</span><br><span class="line"><span class="keyword">for</span> name, param <span class="keyword">in</span> named_params:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;å‚æ•°åç§°: <span class="subst">&#123;name&#125;</span>, å‚æ•°å½¢çŠ¶: <span class="subst">&#123;param.shape&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>
<p><strong><code>parameters()</code></strong>ï¼šä¸»è¦ç”¨äºä¼˜åŒ–å™¨åˆå§‹åŒ–ã€‚åœ¨è®­ç»ƒæ¨¡å‹æ—¶ï¼Œä¼˜åŒ–å™¨ï¼ˆå¦‚ <code>torch.optim.SGD</code>ã€<code>torch.optim.Adam</code> ç­‰ï¼‰éœ€è¦çŸ¥é“æ¨¡å‹çš„å¯å­¦ä¹ å‚æ•°ï¼Œä»¥ä¾¿å¯¹è¿™äº›å‚æ•°è¿›è¡Œæ¢¯åº¦æ›´æ–°ã€‚ç”±äºä¼˜åŒ–å™¨åªå…³å¿ƒå‚æ•°å¼ é‡æœ¬èº«ï¼Œä¸éœ€è¦å‚æ•°åç§°ï¼Œæ‰€ä»¥ä½¿ç”¨ <code>parameters()</code> å³å¯ã€‚</p>
<p><strong><code>named_parameters()</code></strong>ï¼šåœ¨æ¨¡å‹è°ƒè¯•ã€å‚æ•°åˆ†ç»„ä¼˜åŒ–æˆ–æ¨¡å‹å‚æ•°çš„é€‰æ‹©æ€§åŠ è½½æ—¶éå¸¸æœ‰ç”¨ã€‚ä¾‹å¦‚ï¼Œä½ å¯èƒ½åªæƒ³æ›´æ–°æ¨¡å‹ä¸­æŸäº›ç‰¹å®šå±‚çš„å‚æ•°ï¼Œé€šè¿‡å‚æ•°åç§°å¯ä»¥æ–¹ä¾¿åœ°ç­›é€‰å‡ºè¿™äº›å‚æ•°ï¼›æˆ–è€…åœ¨åŠ è½½é¢„è®­ç»ƒæ¨¡å‹æ—¶ï¼Œæ ¹æ®å‚æ•°åç§°é€‰æ‹©æ€§åœ°åŠ è½½éƒ¨åˆ†å‚æ•°ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ä½¿ç”¨ parameters() è·å–å‚æ•°ï¼š</span><br><span class="line">å‚æ•°å½¢çŠ¶: torch.Size([5, 10])</span><br><span class="line">å‚æ•°å½¢çŠ¶: torch.Size([5])</span><br><span class="line">å‚æ•°å½¢çŠ¶: torch.Size([1, 5])</span><br><span class="line">å‚æ•°å½¢çŠ¶: torch.Size([1])</span><br><span class="line"></span><br><span class="line">ä½¿ç”¨ named_parameters() è·å–å‚æ•°ï¼š</span><br><span class="line">å‚æ•°åç§°: fc1.weight, å‚æ•°å½¢çŠ¶: torch.Size([5, 10])</span><br><span class="line">å‚æ•°åç§°: fc1.bias, å‚æ•°å½¢çŠ¶: torch.Size([5])</span><br><span class="line">å‚æ•°åç§°: fc2.weight, å‚æ•°å½¢çŠ¶: torch.Size([1, 5])</span><br><span class="line">å‚æ•°åç§°: fc2.bias, å‚æ•°å½¢çŠ¶: torch.Size([1])</span><br></pre></td></tr></table></figure>
<ol start="2">
<li><code>train()</code> ä¸ <code>eval()</code> æ¨¡å¼åˆ‡æ¢</li>
</ol>
<p><code>train()</code> å’Œ <code>eval()</code> æ˜¯ <code>nn.Module</code> ç±»ä¸­çš„æ–¹æ³•ï¼Œç”¨äºåˆ‡æ¢æ¨¡å‹çš„è®­ç»ƒå’Œè¯„ä¼°æ¨¡å¼ã€‚<code>train()</code> æ–¹æ³•å°†æ¨¡å‹è®¾ç½®ä¸ºè®­ç»ƒæ¨¡å¼ï¼Œ<code>eval()</code> æ–¹æ³•å°†æ¨¡å‹è®¾ç½®ä¸ºè¯„ä¼°æ¨¡å¼ï¼Œä¸åŒæ¨¡å¼ä¸‹éƒ¨åˆ†å±‚ï¼ˆå¦‚ <code>Dropout</code>ã€<code>BatchNorm</code>ï¼‰ä¼šæœ‰ä¸åŒçš„è¡Œä¸ºã€‚</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ä¸€ä¸ªåŒ…å« Dropout å±‚çš„ç®€å•ç¥ç»ç½‘ç»œæ¨¡å‹</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SimpleNet</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>(SimpleNet, <span class="variable language_">self</span>).__init__()</span><br><span class="line">        <span class="variable language_">self</span>.fc1 = nn.Linear(<span class="number">10</span>, <span class="number">5</span>)</span><br><span class="line">        <span class="variable language_">self</span>.dropout = nn.Dropout(p=<span class="number">0.5</span>)</span><br><span class="line">        <span class="variable language_">self</span>.fc2 = nn.Linear(<span class="number">5</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        x = <span class="variable language_">self</span>.fc1(x)</span><br><span class="line">        x = <span class="variable language_">self</span>.dropout(x)</span><br><span class="line">        x = <span class="variable language_">self</span>.fc2(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºæ¨¡å‹å®ä¾‹</span></span><br><span class="line">model = SimpleNet()</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®ä¸ºè®­ç»ƒæ¨¡å¼</span></span><br><span class="line">model.train()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;è®­ç»ƒæ¨¡å¼ä¸‹ Dropout æ˜¯å¦å¯ç”¨:&quot;</span>, model.dropout.training)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®ä¸ºè¯„ä¼°æ¨¡å¼</span></span><br><span class="line">model.<span class="built_in">eval</span>()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;è¯„ä¼°æ¨¡å¼ä¸‹ Dropout æ˜¯å¦å¯ç”¨:&quot;</span>, model.dropout.training)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¨¡æ‹Ÿè¾“å…¥æ•°æ®</span></span><br><span class="line">input_tensor = torch.randn(<span class="number">1</span>, <span class="number">10</span>)</span><br><span class="line"><span class="keyword">with</span> torch.no_grad():</span><br><span class="line">    output_eval = model(input_tensor)</span><br><span class="line">model.train()</span><br><span class="line">output_train = model(input_tensor)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;è¯„ä¼°æ¨¡å¼è¾“å‡º:&quot;</span>, output_eval)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;è®­ç»ƒæ¨¡å¼è¾“å‡º:&quot;</span>, output_train)</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>è®­ç»ƒæ¨¡å¼ï¼ˆ<code>train()</code>ï¼‰</strong>ï¼šåœ¨æ¨¡å‹è®­ç»ƒé˜¶æ®µä½¿ç”¨ï¼Œæ­¤æ—¶æ¨¡å‹ä¸­çš„ <code>Dropout</code> å±‚ä¼šæŒ‰ç…§è®¾å®šçš„æ¦‚ç‡éšæœºä¸¢å¼ƒéƒ¨åˆ†ç¥ç»å…ƒï¼Œ<code>BatchNorm</code> å±‚ä¼šæ ¹æ®å½“å‰æ‰¹æ¬¡çš„æ•°æ®æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¦‚å‡å€¼å’Œæ–¹å·®ï¼‰ï¼Œæœ‰åŠ©äºæé«˜æ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›ã€‚</li>
<li><strong>è¯„ä¼°æ¨¡å¼ï¼ˆ<code>eval()</code>ï¼‰</strong>ï¼šåœ¨æ¨¡å‹è¯„ä¼°ã€æµ‹è¯•æˆ–è€…æ¨ç†é˜¶æ®µä½¿ç”¨ã€‚åœ¨è¯„ä¼°æ¨¡å¼ä¸‹ï¼Œ<code>Dropout</code> å±‚ä¸å†ä¸¢å¼ƒç¥ç»å…ƒï¼Œ<code>BatchNorm</code> å±‚ä½¿ç”¨è®­ç»ƒé˜¶æ®µç»Ÿè®¡å¾—åˆ°çš„å‡å€¼å’Œæ–¹å·®è¿›è¡Œå½’ä¸€åŒ–æ“ä½œï¼Œä¿è¯è¯„ä¼°ç»“æœçš„ç¨³å®šæ€§å’Œä¸€è‡´æ€§ã€‚</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">è®­ç»ƒæ¨¡å¼ä¸‹ Dropout æ˜¯å¦å¯ç”¨: True</span><br><span class="line">è¯„ä¼°æ¨¡å¼ä¸‹ Dropout æ˜¯å¦å¯ç”¨: False</span><br><span class="line">è¯„ä¼°æ¨¡å¼è¾“å‡º: tensor([[...]], grad_fn=&lt;AddmmBackward0&gt;)</span><br><span class="line">è®­ç»ƒæ¨¡å¼è¾“å‡º: tensor([[...]], grad_fn=&lt;AddmmBackward0&gt;)</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œå…·ä½“çš„è¾“å‡ºæ•°å€¼ä¼šå› éšæœºç”Ÿæˆçš„è¾“å…¥æ•°æ®å’Œæ¨¡å‹åˆå§‹åŒ–ä¸åŒè€Œæœ‰æ‰€å˜åŒ–ï¼Œä½†å¯ä»¥çœ‹åˆ°åœ¨ä¸åŒæ¨¡å¼ä¸‹ <code>Dropout</code> å±‚çš„è¡Œä¸ºä¸åŒï¼Œå¯¼è‡´è¾“å‡ºç»“æœä¹Ÿå¯èƒ½ä¸åŒã€‚</p>
<h5 id="ç½‘ç»œå±‚-Layers">ç½‘ç»œå±‚ (Layers)</h5>
<h6 id="åŸºç¡€å±‚">åŸºç¡€å±‚</h6>
<ol>
<li><code>nn.Linear</code>å…¨è¿æ¥å±‚</li>
</ol>
<p><strong><code>nn.Linear</code></strong>ï¼šPyTorch ä¸­ç”¨äºåˆ›å»ºå…¨è¿æ¥å±‚ï¼ˆä¹Ÿç§°ä¸ºçº¿æ€§å±‚ï¼‰çš„ç±»ï¼Œå®ƒå¯¹è¾“å…¥æ•°æ®è¿›è¡Œçº¿æ€§å˜æ¢ï¼Œå³æ‰§è¡ŒçŸ©é˜µä¹˜æ³•å’ŒåŠ æ³•æ“ä½œï¼Œå¯ç”¨äºæ„å»ºå„ç§ç¥ç»ç½‘ç»œæ¨¡å‹ã€‚</p>
<p><strong>ç¥ç»ç½‘ç»œåŸºç¡€æ„å»º</strong>ï¼šå…¨è¿æ¥å±‚æ˜¯ç¥ç»ç½‘ç»œä¸­æœ€åŸºæœ¬çš„ç»„æˆéƒ¨åˆ†ä¹‹ä¸€ï¼Œå¸¸ç”¨äºå¤šå±‚æ„ŸçŸ¥æœºï¼ˆMLPï¼‰çš„æ„å»ºï¼Œå¯å¤„ç†å„ç§ç±»å‹çš„æ•°æ®ï¼Œå¦‚å›¾åƒã€æ–‡æœ¬ç­‰ç‰¹å¾å‘é‡ã€‚</p>
<p><strong>ç‰¹å¾æ˜ å°„</strong>ï¼šå¯ä»¥å°†è¾“å…¥æ•°æ®ä»ä¸€ä¸ªç‰¹å¾ç©ºé—´æ˜ å°„åˆ°å¦ä¸€ä¸ªç‰¹å¾ç©ºé—´ï¼Œæœ‰åŠ©äºæ¨¡å‹å­¦ä¹ æ•°æ®ä¸­çš„å¤æ‚æ¨¡å¼å’Œç‰¹å¾è¡¨ç¤ºã€‚</p>
<hr>
<p>ä¸ºä»€ä¹ˆæ˜¯å…¨è¿æ¥å±‚ï¼Ÿ</p>
<p>1.è¿æ¥æ–¹å¼ï¼šåœ¨å…¨è¿æ¥å±‚ä¸­ï¼Œæ¯ä¸€ä¸ªè¾“å…¥ç¥ç»å…ƒéƒ½ä¸æ¯ä¸€ä¸ªè¾“å‡ºç¥ç»å…ƒç›¸è¿æ¥ï¼Œè¿™ç§è¿æ¥æ˜¯ â€œå…¨â€ çš„ï¼Œå³å®Œå…¨è¿æ¥ã€‚å¯¹äº</p>
<p><code>nn.Linear(in_features, out_features)</code> ï¼Œè¾“å…¥çš„ <code>in_features</code> ä¸ªç¥ç»å…ƒå’Œè¾“å‡ºçš„ <code>out_features</code> ä¸ªç¥ç»å…ƒä¹‹é—´å­˜åœ¨ç€å®Œæ•´çš„è¿æ¥å…³ç³»ã€‚</p>
<p>2.æ•°å­¦è¿ç®—ï¼šå‡è®¾è¾“å…¥å‘é‡$X$ç»´åº¦ä¸º$n$ï¼ˆå³ <code>in_features</code>ï¼‰ï¼Œè¾“å‡ºå‘é‡$Y$ç»´åº¦ä¸º$m$ï¼ˆå³ <code>out_features</code>ï¼‰ï¼Œå…¨è¿æ¥å±‚é€šè¿‡æƒé‡çŸ©é˜µ$W$ï¼ˆå½¢çŠ¶ä¸º$m Ã— n$ï¼‰å’Œåç½®å‘é‡$b$ï¼ˆå½¢çŠ¶ä¸º$m$ï¼‰è¿›è¡Œçº¿æ€§å˜æ¢$Y=WX+b$ã€‚è¿™é‡Œçš„æƒé‡çŸ©é˜µ$W$æè¿°äº†è¾“å…¥ç¥ç»å…ƒå’Œè¾“å‡ºç¥ç»å…ƒä¹‹é—´æ‰€æœ‰å¯èƒ½çš„è¿æ¥å¼ºåº¦ï¼Œæ¯ä¸€ä¸ªè¾“å…¥å…ƒç´ éƒ½ä¼šå½±å“åˆ°æ¯ä¸€ä¸ªè¾“å‡ºå…ƒç´ çš„è®¡ç®—ç»“æœï¼Œè¿™ç§å…¨é¢çš„è¿æ¥å…³ç³»æ˜¯ â€œå…¨è¿æ¥â€ æ¦‚å¿µçš„æ ¸å¿ƒä½“ç°ã€‚</p>
<p>3.ç½‘ç»œç»“æ„å¯¹æ¯”ï¼šåœ¨ç¥ç»ç½‘ç»œä¸­ï¼Œé™¤äº†å…¨è¿æ¥å±‚ï¼Œè¿˜æœ‰<strong>å…¶ä»–ç±»å‹çš„å±‚</strong>ï¼Œæ¯”å¦‚å·ç§¯å±‚ã€æ± åŒ–å±‚ç­‰ã€‚å·ç§¯å±‚ä¸­ï¼Œç¥ç»å…ƒåªä¸è¾“å…¥æ•°æ®çš„å±€éƒ¨åŒºåŸŸç›¸è¿æ¥ï¼Œè€Œ<strong>ä¸æ˜¯åƒå…¨è¿æ¥å±‚é‚£æ ·ä¸æ‰€æœ‰è¾“å…¥ç¥ç»å…ƒè¿æ¥</strong>ï¼›æ± åŒ–å±‚åˆ™ä¸»è¦è¿›è¡Œä¸‹é‡‡æ ·æ“ä½œï¼Œä¸å­˜åœ¨åƒå…¨è¿æ¥å±‚è¿™æ ·å…¨é¢çš„ç¥ç»å…ƒè¿æ¥æ¨¡å¼ã€‚å› æ­¤ï¼Œä¸ºäº†çªå‡ºè¿™ç§æ‰€æœ‰è¾“å…¥å’Œè¾“å‡ºç¥ç»å…ƒä¹‹é—´éƒ½æœ‰è¿æ¥çš„ç‰¹æ®Šç»“æ„ï¼Œå°†å…¶ç§°ä¸ºå…¨è¿æ¥å±‚ï¼Œä»¥ä¾¿å’Œå…¶ä»–ç±»å‹çš„å±‚è¿›è¡ŒåŒºåˆ†ã€‚</p>
<hr>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ªå…¨è¿æ¥å±‚ï¼Œè¾“å…¥ç»´åº¦ä¸º 10ï¼Œè¾“å‡ºç»´åº¦ä¸º 5</span></span><br><span class="line">linear_layer = nn.Linear(<span class="number">10</span>, <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¨¡æ‹Ÿè¾“å…¥æ•°æ®ï¼Œå‡è®¾æœ‰ 1 ä¸ªæ ·æœ¬ï¼Œæ¯ä¸ªæ ·æœ¬æœ‰ 10 ä¸ªç‰¹å¾</span></span><br><span class="line">input_tensor = torch.randn(<span class="number">1</span>, <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿›è¡Œå‰å‘ä¼ æ’­</span></span><br><span class="line">output = linear_layer(input_tensor)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;å…¨è¿æ¥å±‚çš„æƒé‡å½¢çŠ¶:&quot;</span>, linear_layer.weight.shape)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;å…¨è¿æ¥å±‚çš„åç½®å½¢çŠ¶:&quot;</span>, linear_layer.bias.shape)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;è¾“å…¥å¼ é‡çš„å½¢çŠ¶:&quot;</span>, input_tensor.shape)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;è¾“å‡ºå¼ é‡çš„å½¢çŠ¶:&quot;</span>, output.shape)</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>åˆå§‹åŒ–å‚æ•°</strong>ï¼š<code>nn.Linear(in_features, out_features)</code> ä¸­ï¼Œ<code>in_features</code> è¡¨ç¤ºè¾“å…¥ç‰¹å¾çš„æ•°é‡ï¼Œ<code>out_features</code> è¡¨ç¤ºè¾“å‡ºç‰¹å¾çš„æ•°é‡ã€‚åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œ<code>in_features = 10</code>ï¼Œ<code>out_features = 5</code>ï¼Œæ„å‘³ç€è¾“å…¥çš„æ¯ä¸ªæ ·æœ¬æœ‰ 10 ä¸ªç‰¹å¾ï¼Œç»è¿‡å…¨è¿æ¥å±‚åè¾“å‡ºçš„æ¯ä¸ªæ ·æœ¬æœ‰ 5 ä¸ªç‰¹å¾ã€‚</li>
<li><strong>çº¿æ€§å˜æ¢</strong>ï¼šå…¨è¿æ¥å±‚çš„è®¡ç®—è¿‡ç¨‹å¯ä»¥è¡¨ç¤ºä¸º$Y=XW^T+b$ ï¼Œå…¶ä¸­$X$æ˜¯è¾“å…¥å‘é‡ï¼Œ$W$æ˜¯æƒé‡çŸ©é˜µï¼Œå½¢çŠ¶ä¸º <code>(out_features, in_features)</code>ï¼Œ$b$æ˜¯åç½®å‘é‡ï¼Œå½¢çŠ¶ä¸º <code>(out_features,)</code>ï¼Œ$Y$æ˜¯è¾“å‡ºå‘é‡ã€‚</li>
<li><strong>å‰å‘ä¼ æ’­</strong>ï¼šå°†è¾“å…¥å¼ é‡ <code>input_tensor</code> ä¼ é€’ç»™ <code>linear_layer</code> æ—¶ï¼Œä¼šè‡ªåŠ¨æ‰§è¡Œä¸Šè¿°çº¿æ€§å˜æ¢ï¼Œå¾—åˆ°è¾“å‡ºå¼ é‡ <code>output</code>ã€‚</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">å…¨è¿æ¥å±‚çš„æƒé‡å½¢çŠ¶: torch.Size([5, 10])</span><br><span class="line">å…¨è¿æ¥å±‚çš„åç½®å½¢çŠ¶: torch.Size([5])</span><br><span class="line">è¾“å…¥å¼ é‡çš„å½¢çŠ¶: torch.Size([1, 10])</span><br><span class="line">è¾“å‡ºå¼ é‡çš„å½¢çŠ¶: torch.Size([1, 5])</span><br></pre></td></tr></table></figure>
<ul>
<li>[ ] æƒé‡å½¢çŠ¶çš„ç¡®å®š:</li>
</ul>
<p>ä¸ºäº†ä½¿çŸ©é˜µä¹˜æ³•$WX$èƒ½å¤Ÿå¾—åˆ°ç»´åº¦ä¸º$m$çš„è¾“å‡ºå‘é‡ï¼Œæƒé‡çŸ©é˜µ$W$çš„å½¢çŠ¶å¿…é¡»æ˜¯$m Ã— n$ã€‚è¿™æ˜¯å› ä¸ºåœ¨çŸ©é˜µä¹˜æ³•ä¸­ï¼Œä¸¤ä¸ªçŸ©é˜µèƒ½å¤Ÿç›¸ä¹˜çš„æ¡ä»¶æ˜¯å‰ä¸€ä¸ªçŸ©é˜µçš„åˆ—æ•°ç­‰äºåä¸€ä¸ªçŸ©é˜µçš„è¡Œæ•°ï¼Œå¹¶ä¸”ç›¸ä¹˜ç»“æœçŸ©é˜µçš„è¡Œæ•°ç­‰äºå‰ä¸€ä¸ªçŸ©é˜µçš„è¡Œæ•°ï¼Œåˆ—æ•°ç­‰äºåä¸€ä¸ªçŸ©é˜µçš„åˆ—æ•°ã€‚å³å¦‚æœ$W$æ˜¯$m Ã— n$çŸ©é˜µï¼Œ$X$æ˜¯$n Ã— 1$å‘é‡ï¼Œé‚£ä¹ˆ$WX$çš„ç»“æœå°±æ˜¯ä¸€ä¸ª$m Ã— 1$å‘é‡ï¼Œç¬¦åˆè¾“å‡ºå‘é‡$Y$çš„ç»´åº¦è¦æ±‚ã€‚</p>
<p>åœ¨ä»£ç ç¤ºä¾‹ä¸­ï¼Œè¾“å…¥ç‰¹å¾æ•°é‡ <code>in_features = 10</code>ï¼Œè¾“å‡ºç‰¹å¾æ•°é‡ <code>out_features = 5</code>ï¼Œæ‰€ä»¥æƒé‡çŸ©é˜µ çš„å½¢çŠ¶å°±æ˜¯ <code>(5, 10)</code>ï¼Œå³ <code>torch.Size([5, 10])</code>ã€‚</p>
<ul>
<li>[ ] åç½®å½¢çŠ¶çš„ç¡®å®š</li>
</ul>
<p>åç½®å‘é‡$b$çš„ä½œç”¨æ˜¯åœ¨ç»è¿‡çŸ©é˜µä¹˜æ³•å¾—åˆ°çš„ç»“æœä¸Šè¿›è¡Œåç§»ã€‚ç”±äºè¾“å‡ºå‘é‡$Y$çš„ç»´åº¦æ˜¯$m$ï¼Œä¸ºäº†èƒ½å¤Ÿå¯¹$WX$çš„æ¯ä¸€ä¸ªå…ƒç´ éƒ½åŠ ä¸Šä¸€ä¸ªåç§»é‡ï¼Œåç½®å‘é‡$b$çš„ç»´åº¦ä¹Ÿå¿…é¡»æ˜¯$m$ï¼Œå³$bâˆˆ\R^m$ã€‚</p>
<p>åœ¨ä»£ç ç¤ºä¾‹ä¸­ï¼Œè¾“å‡ºç‰¹å¾æ•°é‡ <code>out_features = 5</code>ï¼Œæ‰€ä»¥åç½®å‘é‡ çš„å½¢çŠ¶å°±æ˜¯ <code>(5,)</code>ï¼Œå³ <code>torch.Size([5])</code>ã€‚</p>
<ol start="2">
<li><code>nn.Bilinear</code>åŒçº¿æ€§å±‚</li>
</ol>
<p><strong><code>nn.Bilinear</code></strong>ï¼šPyTorch ä¸­çš„ä¸€ä¸ªç±»ï¼Œç”¨äºåˆ›å»ºåŒçº¿æ€§å±‚ã€‚åŒçº¿æ€§å±‚å¯¹ä¸¤ä¸ªè¾“å…¥è¿›è¡ŒåŒçº¿æ€§å˜æ¢ï¼Œèƒ½æ•æ‰ä¸¤ä¸ªè¾“å…¥ä¹‹é—´çš„äº¤äº’ä¿¡æ¯ï¼Œæ˜¯ä¸€ç§æ¯”æ™®é€šçº¿æ€§å±‚æ›´å¤æ‚çš„å˜æ¢å½¢å¼ã€‚</p>
<p><strong>å…³ç³»å»ºæ¨¡</strong>ï¼šåœ¨éœ€è¦æ•æ‰ä¸¤ä¸ªä¸åŒç‰¹å¾ä¹‹é—´äº¤äº’å…³ç³»çš„ä»»åŠ¡ä¸­éå¸¸æœ‰ç”¨ã€‚ä¾‹å¦‚ï¼Œåœ¨æ¨èç³»ç»Ÿä¸­ï¼Œå¯ä»¥ç”¨åŒçº¿æ€§å±‚æ¥å»ºæ¨¡ç”¨æˆ·ç‰¹å¾å’Œç‰©å“ç‰¹å¾ä¹‹é—´çš„äº¤äº’ï¼Œä»¥é¢„æµ‹ç”¨æˆ·å¯¹ç‰©å“çš„åå¥½ï¼›åœ¨è‡ªç„¶è¯­è¨€å¤„ç†ä¸­ï¼Œå¯ç”¨äºå¤„ç†ä¸¤ä¸ªä¸åŒå¥å­æˆ–ä¸åŒè¯­ä¹‰è¡¨ç¤ºä¹‹é—´çš„å…³ç³»ã€‚</p>
<p><strong>èåˆå¤šæ¨¡æ€ä¿¡æ¯</strong>ï¼šå½“å¤„ç†å¤šæ¨¡æ€æ•°æ®ï¼ˆå¦‚å›¾åƒå’Œæ–‡æœ¬ï¼‰æ—¶ï¼ŒåŒçº¿æ€§å±‚å¯ä»¥å¸®åŠ©èåˆä¸åŒæ¨¡æ€ä¹‹é—´çš„ä¿¡æ¯ï¼ŒæŒ–æ˜å®ƒä»¬ä¹‹é—´çš„æ½œåœ¨å…³è”ã€‚</p>
<p><img src="/%E6%89%8B%E6%92%95%E7%9F%A5%E8%AF%86%E5%BA%93/image-20250222212028325.png" alt="image-20250222212028325"></p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ªåŒçº¿æ€§å±‚</span></span><br><span class="line"><span class="comment"># ç¬¬ä¸€ä¸ªè¾“å…¥ç»´åº¦ä¸º 10ï¼Œç¬¬äºŒä¸ªè¾“å…¥ç»´åº¦ä¸º 20ï¼Œè¾“å‡ºç»´åº¦ä¸º 5</span></span><br><span class="line">bilinear_layer = nn.Bilinear(<span class="number">10</span>, <span class="number">20</span>, <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¨¡æ‹Ÿä¸¤ä¸ªè¾“å…¥å¼ é‡</span></span><br><span class="line"><span class="comment"># ç¬¬ä¸€ä¸ªè¾“å…¥ï¼šå‡è®¾æœ‰ 1 ä¸ªæ ·æœ¬ï¼Œæ¯ä¸ªæ ·æœ¬æœ‰ 10 ä¸ªç‰¹å¾</span></span><br><span class="line">input1 = torch.randn(<span class="number">1</span>, <span class="number">10</span>)</span><br><span class="line"><span class="comment"># ç¬¬äºŒä¸ªè¾“å…¥ï¼šå‡è®¾æœ‰ 1 ä¸ªæ ·æœ¬ï¼Œæ¯ä¸ªæ ·æœ¬æœ‰ 20 ä¸ªç‰¹å¾</span></span><br><span class="line">input2 = torch.randn(<span class="number">1</span>, <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿›è¡Œå‰å‘ä¼ æ’­</span></span><br><span class="line">output = bilinear_layer(input1, input2)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;åŒçº¿æ€§å±‚çš„æƒé‡å½¢çŠ¶:&quot;</span>, bilinear_layer.weight.shape)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;åŒçº¿æ€§å±‚çš„åç½®å½¢çŠ¶:&quot;</span>, bilinear_layer.bias.shape)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;ç¬¬ä¸€ä¸ªè¾“å…¥å¼ é‡çš„å½¢çŠ¶:&quot;</span>, input1.shape)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;ç¬¬äºŒä¸ªè¾“å…¥å¼ é‡çš„å½¢çŠ¶:&quot;</span>, input2.shape)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;è¾“å‡ºå¼ é‡çš„å½¢çŠ¶:&quot;</span>, output.shape)</span><br></pre></td></tr></table></figure>
<p>æƒé‡å¼ é‡çš„å½¢çŠ¶ç¬¦åˆ <code>(out_features, in1_features, in2_features)</code>ï¼Œåç½®å‘é‡çš„é•¿åº¦ç­‰äºè¾“å‡ºç‰¹å¾çš„æ•°é‡ï¼Œä¸¤ä¸ªè¾“å…¥å¼ é‡ç»è¿‡åŒçº¿æ€§å±‚åï¼Œè¾“å‡ºå¼ é‡çš„ç‰¹å¾æ•°é‡å˜ä¸º <code>out_features</code> è®¾å®šçš„å€¼ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">åŒçº¿æ€§å±‚çš„æƒé‡å½¢çŠ¶: torch.Size([5, 10, 20])</span><br><span class="line">åŒçº¿æ€§å±‚çš„åç½®å½¢çŠ¶: torch.Size([5])</span><br><span class="line">ç¬¬ä¸€ä¸ªè¾“å…¥å¼ é‡çš„å½¢çŠ¶: torch.Size([1, 10])</span><br><span class="line">ç¬¬äºŒä¸ªè¾“å…¥å¼ é‡çš„å½¢çŠ¶: torch.Size([1, 20])</span><br><span class="line">è¾“å‡ºå¼ é‡çš„å½¢çŠ¶: torch.Size([1, 5])</span><br></pre></td></tr></table></figure>
<h6 id="å·ç§¯å±‚">å·ç§¯å±‚</h6>
<hr>
<p>1.ä»€ä¹ˆæ˜¯å·ç§¯å±‚ï¼Ÿ</p>
<p>å·ç§¯å±‚æœ¬è´¨ä¸Šæ˜¯é€šè¿‡å¯å­¦ä¹ çš„å·ç§¯æ ¸ï¼ˆæ»¤æ³¢å™¨ï¼‰åœ¨è¾“å…¥æ•°æ®ä¸Šè¿›è¡Œæ»‘åŠ¨å¹¶æ‰§è¡Œå·ç§¯æ“ä½œï¼Œä»¥æå–è¾“å…¥æ•°æ®ä¸­çš„å±€éƒ¨ç‰¹å¾æ¨¡å¼ï¼ŒåŒæ—¶åˆ©ç”¨å‚æ•°å…±äº«å‡å°‘æ¨¡å‹å‚æ•°æ•°é‡ã€‚</p>
<p>å·ç§¯æ“ä½œæŒ‡çš„æ˜¯å·ç§¯æ ¸ï¼ˆä¸€ä¸ªå°çš„çŸ©é˜µï¼‰åœ¨è¾“å…¥æ•°æ®ï¼ˆå¦‚å›¾åƒçŸ©é˜µï¼‰ä¸ŠæŒ‰ä¸€å®šæ­¥é•¿æ»‘åŠ¨ï¼Œæ¯æ»‘åŠ¨åˆ°ä¸€ä¸ªä½ç½®ï¼Œå°±å°†å·ç§¯æ ¸ä¸è¯¥ä½ç½®å¯¹åº”çš„è¾“å…¥å±€éƒ¨åŒºåŸŸå…ƒç´ å¯¹åº”ç›¸ä¹˜åæ±‚å’Œï¼Œå¾—åˆ°è¾“å‡ºç‰¹å¾å›¾çš„ä¸€ä¸ªå€¼ï¼Œä¸æ–­æ»‘åŠ¨ç›´è‡³è¦†ç›–æ•´ä¸ªè¾“å…¥æ•°æ®ï¼Œæœ€ç»ˆç”Ÿæˆå®Œæ•´çš„è¾“å‡ºç‰¹å¾å›¾ã€‚</p>
<p>å‡è®¾è¾“å…¥æ˜¯ä¸€ä¸ª 4Ã—4 çš„å•é€šé“å›¾åƒçŸ©é˜µï¼Œä½¿ç”¨ä¸€ä¸ª 2Ã—2 çš„å·ç§¯æ ¸è¿›è¡Œå·ç§¯æ“ä½œï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">è¾“å…¥å›¾åƒçŸ©é˜µï¼š</span><br><span class="line">[[1 2 3 4]</span><br><span class="line"> [5 6 7 8]</span><br><span class="line"> [9 10 11 12]</span><br><span class="line"> [13 14 15 16]]</span><br><span class="line"></span><br><span class="line">å·ç§¯æ ¸ï¼š</span><br><span class="line">[[1 2]</span><br><span class="line"> [3 4]]</span><br><span class="line"> </span><br><span class="line">ç¬¬ä¸€æ­¥ï¼šå·ç§¯æ ¸ä½äºè¾“å…¥å›¾åƒçš„å·¦ä¸Šè§’ï¼Œè¦†ç›–çš„å±€éƒ¨åŒºåŸŸæ˜¯ï¼š</span><br><span class="line">[[1 2]</span><br><span class="line"> [5 6]]</span><br><span class="line">å°†å·ç§¯æ ¸ä¸è¯¥å±€éƒ¨åŒºåŸŸå¯¹åº”å…ƒç´ ç›¸ä¹˜å†æ±‚å’Œï¼š</span><br><span class="line">(1x1+2x2)+(3x5+4x6)=44</span><br><span class="line">è¿™ä¸ª 44 å°±æ˜¯è¾“å‡ºç‰¹å¾å›¾å·¦ä¸Šè§’çš„å€¼ã€‚</span><br><span class="line"></span><br><span class="line">ç¬¬äºŒæ­¥ï¼šå·ç§¯æ ¸å‘å³æ»‘åŠ¨ä¸€ä¸ªæ­¥é•¿ï¼ˆå‡è®¾æ­¥é•¿ä¸º 1ï¼‰ï¼Œè¦†ç›–çš„å±€éƒ¨åŒºåŸŸå˜ä¸ºï¼š</span><br><span class="line">[[2 3]</span><br><span class="line"> [6 7]]</span><br><span class="line">åŒæ ·è¿›è¡Œå¯¹åº”å…ƒç´ ç›¸ä¹˜å†æ±‚å’Œçš„æ“ä½œï¼š</span><br><span class="line">(1x2+2x3)+(3x6+4x7)=54</span><br><span class="line">è¿™æ˜¯è¾“å‡ºç‰¹å¾å›¾ä¸­å·¦ä¸Šè§’å³ä¾§ä½ç½®çš„å€¼ã€‚</span><br><span class="line"></span><br><span class="line">åç»­æ­¥éª¤ï¼šå·ç§¯æ ¸ç»§ç»­å‘å³ã€å‘ä¸‹æ»‘åŠ¨ï¼Œæ¯æ¬¡éƒ½é‡å¤ä¸Šè¿°ç›¸ä¹˜æ±‚å’Œçš„æ“ä½œï¼Œç›´åˆ°éå†å®Œæ•´ä¸ªè¾“å…¥å›¾åƒçŸ©é˜µï¼Œæœ€ç»ˆå¾—åˆ°ä¸€ä¸ª 3Ã—3 çš„è¾“å‡ºç‰¹å¾å›¾ï¼ˆå› ä¸º 4Ã—4 çš„è¾“å…¥çŸ©é˜µä½¿ç”¨ 2Ã—2 å·ç§¯æ ¸ï¼Œæ­¥é•¿ä¸º 1 æ—¶ä¼šå¾—åˆ° 3Ã—3 çš„è¾“å‡ºï¼‰ã€‚</span><br></pre></td></tr></table></figure>
<p>2.å·ç§¯å±‚æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ</p>
<p><strong>å‡å°‘å‚æ•°æ•°é‡</strong></p>
<p>å·ç§¯å±‚ä½¿ç”¨å‚æ•°å…±äº«æœºåˆ¶ï¼Œå³ä¸€ä¸ªå·ç§¯æ ¸åœ¨æ•´ä¸ªè¾“å…¥æ•°æ®ä¸Šæ»‘åŠ¨ä½¿ç”¨ï¼Œç›¸æ¯”äºå…¨è¿æ¥å±‚æ¯ä¸ªè¾“å‡ºç¥ç»å…ƒéƒ½ä¸æ‰€æœ‰è¾“å…¥ç›¸è¿ï¼Œå¤§å¤§å‡å°‘äº†éœ€è¦å­¦ä¹ çš„å‚æ•°æ•°é‡ï¼Œé™ä½è®¡ç®—é‡å’Œå­˜å‚¨éœ€æ±‚ï¼Œä¹Ÿå‡å°‘äº†è¿‡æ‹Ÿåˆé£é™©ã€‚</p>
<p><strong>æå–å±€éƒ¨ç‰¹å¾</strong></p>
<p>å·ç§¯æ ¸åœ¨è¾“å…¥æ•°æ®çš„å±€éƒ¨åŒºåŸŸè¿›è¡Œæ“ä½œï¼Œèƒ½å¤Ÿæœ‰æ•ˆæ•æ‰æ•°æ®ä¸­çš„å±€éƒ¨ç‰¹å¾ï¼Œå¦‚åœ¨å›¾åƒä¸­å¯æ£€æµ‹è¾¹ç¼˜ã€çº¹ç†ç­‰ã€‚è¿™äº›å±€éƒ¨ç‰¹å¾åœ¨ä¸åŒä½ç½®å¯èƒ½å…·æœ‰ç›¸ä¼¼æ€§ï¼Œå·ç§¯å±‚å¯ä»¥å¾ˆå¥½åœ°å­¦ä¹ å’Œåˆ©ç”¨è¿™ç§ç‰¹æ€§ã€‚</p>
<p><strong>ä¿ç•™ç©ºé—´ç»“æ„</strong></p>
<p>å·ç§¯æ“ä½œåŸºäºå±€éƒ¨è¿æ¥ï¼Œèƒ½ä¿ç•™è¾“å…¥æ•°æ®çš„ç©ºé—´ç»“æ„ä¿¡æ¯ï¼Œè¿™å¯¹äºå¤„ç†å…·æœ‰ç©ºé—´ç»“æ„çš„æ•°æ®ï¼ˆå¦‚å›¾åƒã€éŸ³é¢‘ï¼‰éå¸¸é‡è¦ï¼Œæœ‰åŠ©äºæ¨¡å‹ç†è§£æ•°æ®ä¸­å…ƒç´ ä¹‹é—´çš„ç›¸å¯¹ä½ç½®å…³ç³»ã€‚</p>
<p><strong>å¯æ„å»ºæ·±å±‚ç½‘ç»œ</strong></p>
<p>å¤šä¸ªå·ç§¯å±‚å¯ä»¥å †å å½¢æˆæ·±å±‚å·ç§¯ç¥ç»ç½‘ç»œï¼Œéšç€ç½‘ç»œæ·±åº¦å¢åŠ ï¼Œèƒ½å­¦ä¹ åˆ°ä»ç®€å•åˆ°å¤æ‚ã€ä»åº•å±‚åˆ°é«˜å±‚çš„å¤šå±‚æ¬¡ç‰¹å¾ï¼Œæå‡æ¨¡å‹åœ¨å„ç§ä»»åŠ¡ï¼ˆå¦‚å›¾åƒåˆ†ç±»ã€ç›®æ ‡æ£€æµ‹ï¼‰ä¸­çš„æ€§èƒ½ã€‚</p>
<hr>
<ol>
<li><code>nn.Conv1d</code> 1Då·ç§¯ï¼šå¤„ç†æ—¶åºæ•°æ®ï¼ˆå¦‚éŸ³é¢‘ã€æ–‡æœ¬ï¼‰</li>
</ol>
<p><code>nn.Conv1d</code> æ˜¯ PyTorch ä¸­ç”¨äºè¿›è¡Œä¸€ç»´å·ç§¯æ“ä½œçš„æ¨¡å—ï¼Œä¸»è¦ç”¨äºå¤„ç†æ—¶åºæ•°æ®ï¼ŒåƒéŸ³é¢‘ä¿¡å·ã€æ–‡æœ¬åºåˆ—ç­‰ã€‚ä¸€ç»´å·ç§¯åœ¨è¿™äº›æ•°æ®ä¸Šæ²¿ç€ä¸€ä¸ªç»´åº¦ï¼ˆé€šå¸¸æ˜¯æ—¶é—´ç»´åº¦ï¼‰è¿›è¡Œå·ç§¯æ“ä½œï¼Œèƒ½æœ‰æ•ˆæå–æ•°æ®ä¸­çš„å±€éƒ¨ç‰¹å¾æ¨¡å¼ã€‚</p>
<p><strong>éŸ³é¢‘å¤„ç†</strong>ï¼šå¯ä»¥ç”¨äºéŸ³é¢‘ç‰¹å¾æå–ã€è¯­éŸ³è¯†åˆ«ç­‰ä»»åŠ¡ï¼Œé€šè¿‡ä¸€ç»´å·ç§¯æå–éŸ³é¢‘ä¿¡å·ä¸­çš„æ—¶åŸŸç‰¹å¾ã€‚</p>
<p><strong>æ–‡æœ¬å¤„ç†</strong>ï¼šåœ¨è‡ªç„¶è¯­è¨€å¤„ç†ä¸­ï¼Œå°†æ–‡æœ¬åºåˆ—çœ‹ä½œä¸€ç»´æ•°æ®ï¼Œä¸€ç»´å·ç§¯å¯ä»¥æ•æ‰æ–‡æœ¬ä¸­çš„å±€éƒ¨è¯­ä¹‰ä¿¡æ¯ï¼Œå¸¸ç”¨äºæ–‡æœ¬åˆ†ç±»ã€æƒ…æ„Ÿåˆ†æç­‰ä»»åŠ¡ã€‚</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰è¾“å…¥æ•°æ®</span></span><br><span class="line"><span class="comment"># è¾“å…¥æ•°æ®å½¢çŠ¶ï¼š(æ‰¹é‡å¤§å°, è¾“å…¥é€šé“æ•°, åºåˆ—é•¿åº¦)</span></span><br><span class="line">input_tensor = torch.randn(<span class="number">16</span>, <span class="number">3</span>, <span class="number">100</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ä¸€ç»´å·ç§¯å±‚</span></span><br><span class="line"><span class="comment"># in_channels: è¾“å…¥é€šé“æ•°</span></span><br><span class="line"><span class="comment"># out_channels: è¾“å‡ºé€šé“æ•°</span></span><br><span class="line"><span class="comment"># kernel_size: å·ç§¯æ ¸å¤§å°</span></span><br><span class="line">conv1d_layer = nn.Conv1d(in_channels=<span class="number">3</span>, out_channels=<span class="number">6</span>, kernel_size=<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿›è¡Œå·ç§¯æ“ä½œ</span></span><br><span class="line">output = conv1d_layer(input_tensor)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;è¾“å…¥å¼ é‡å½¢çŠ¶:&quot;</span>, input_tensor.shape)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;è¾“å‡ºå¼ é‡å½¢çŠ¶:&quot;</span>, output.shape)</span><br></pre></td></tr></table></figure>
<p><strong>è¾“å…¥æ•°æ®</strong></p>
<p>é€šå¸¸æ˜¯ä¸‰ç»´å¼ é‡ï¼Œå½¢çŠ¶ä¸º <code>(batch_size, in_channels, sequence_length)</code>ã€‚å…¶ä¸­ <code>batch_size</code> è¡¨ç¤ºä¸€æ¬¡å¤„ç†çš„æ ·æœ¬æ•°é‡ï¼›<code>in_channels</code> æ˜¯è¾“å…¥æ•°æ®çš„é€šé“æ•°ï¼Œä¾‹å¦‚åœ¨éŸ³é¢‘å¤„ç†ä¸­ï¼Œå•å£°é“éŸ³é¢‘ <code>in_channels</code> ä¸º 1ï¼Œç«‹ä½“å£°éŸ³é¢‘ <code>in_channels</code> ä¸º 2ï¼›<code>sequence_length</code> æ˜¯åºåˆ—çš„é•¿åº¦ï¼Œå¯¹äºéŸ³é¢‘æ•°æ®å°±æ˜¯éŸ³é¢‘ä¿¡å·çš„é‡‡æ ·ç‚¹æ•°ï¼Œå¯¹äºæ–‡æœ¬æ•°æ®å°±æ˜¯æ–‡æœ¬åºåˆ—çš„é•¿åº¦ã€‚</p>
<p><strong>å·ç§¯å±‚å‚æ•°</strong></p>
<p><code>in_channels</code>ï¼šè¾“å…¥æ•°æ®çš„é€šé“æ•°ï¼Œå¿…é¡»ä¸è¾“å…¥å¼ é‡çš„ç¬¬äºŒç»´å¤§å°ä¸€è‡´ã€‚</p>
<p><code>out_channels</code>ï¼šè¾“å‡ºæ•°æ®çš„é€šé“æ•°ï¼Œå³å·ç§¯å±‚ä½¿ç”¨çš„å·ç§¯æ ¸æ•°é‡ã€‚æ¯ä¸ªå·ç§¯æ ¸ä¼šæå–ä¸€ç§ç‰¹å®šçš„ç‰¹å¾ï¼Œå› æ­¤ä¸åŒçš„å·ç§¯æ ¸ä¼šè¾“å‡ºä¸åŒçš„ç‰¹å¾å›¾ã€‚</p>
<p><code>kernel_size</code>ï¼šå·ç§¯æ ¸çš„å¤§å°ï¼Œè¡¨ç¤ºåœ¨åºåˆ—ç»´åº¦ä¸Šå·ç§¯æ ¸è¦†ç›–çš„å…ƒç´ ä¸ªæ•°ã€‚ä¾‹å¦‚ <code>kernel_size=3</code> è¡¨ç¤ºå·ç§¯æ ¸åœ¨åºåˆ—ä¸Šæ¯æ¬¡è¦†ç›– 3 ä¸ªå…ƒç´ ã€‚</p>
<p><strong>å·ç§¯æ“ä½œè¿‡ç¨‹</strong></p>
<p>å·ç§¯æ ¸åœ¨è¾“å…¥æ•°æ®çš„åºåˆ—ç»´åº¦ä¸Šæ»‘åŠ¨ï¼Œæ¯æ¬¡è¦†ç›– <code>kernel_size</code> ä¸ªå…ƒç´ ï¼Œå¹¶åœ¨æ¯ä¸ªé€šé“ä¸Šè¿›è¡Œå·ç§¯æ“ä½œï¼Œç„¶åå°†å„é€šé“çš„ç»“æœç›¸åŠ ï¼ˆå¦‚æœæœ‰å¤šä¸ªè¾“å…¥é€šé“ï¼‰ï¼Œæœ€ååŠ ä¸Šåç½®é¡¹å¾—åˆ°è¾“å‡ºçš„ä¸€ä¸ªå€¼ã€‚å·ç§¯æ ¸ä¸æ–­æ»‘åŠ¨ï¼Œæœ€ç»ˆå¾—åˆ°è¾“å‡ºç‰¹å¾å›¾ã€‚</p>
<p><strong>è¾“å‡ºæ•°æ®</strong></p>
<p>è¾“å‡ºæ•°æ®åŒæ ·æ˜¯ä¸‰ç»´å¼ é‡ï¼Œå½¢çŠ¶ä¸º <code>(batch_size, out_channels, new_sequence_length)</code>ã€‚å…¶ä¸­ <code>batch_size</code> ä¸è¾“å…¥ç›¸åŒï¼›<code>out_channels</code> æ˜¯å·ç§¯å±‚å®šä¹‰çš„è¾“å‡ºé€šé“æ•°ï¼›<code>new_sequence_length</code> ç”±è¾“å…¥åºåˆ—é•¿åº¦ã€å·ç§¯æ ¸å¤§å°ã€æ­¥é•¿ï¼ˆ<code>stride</code>ï¼Œé»˜è®¤ä¸º 1ï¼‰å’Œå¡«å……ï¼ˆ<code>padding</code>ï¼Œé»˜è®¤ä¸º 0ï¼‰ç­‰å› ç´ å†³å®šï¼Œè®¡ç®—å…¬å¼ä¸ºï¼š</p>
<p><img src="/%E6%89%8B%E6%92%95%E7%9F%A5%E8%AF%86%E5%BA%93/image-20250222215408498.png" alt="image-20250222215408498"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">è¾“å…¥å¼ é‡å½¢çŠ¶: torch.Size([16, 3, 100])</span><br><span class="line">è¾“å‡ºå¼ é‡å½¢çŠ¶: torch.Size([16, 6, 98])</span><br></pre></td></tr></table></figure>
<ol start="2">
<li><code>nn.Conv2d</code> 2Då·ç§¯ï¼šå¤„ç†å›¾åƒæ•°æ®</li>
</ol>
<p><code>nn.Conv2d</code>ï¼šPyTorch ä¸­ç”¨äºå®ç°äºŒç»´å·ç§¯æ“ä½œçš„ç±»ï¼Œä¸»è¦å¤„ç†å›¾åƒæ•°æ®ã€‚é€šè¿‡å¯å­¦ä¹ çš„å·ç§¯æ ¸åœ¨è¾“å…¥å›¾åƒä¸Šæ»‘åŠ¨å¹¶è¿›è¡Œå·ç§¯è¿ç®—ï¼Œæå–å›¾åƒå±€éƒ¨ç‰¹å¾ï¼Œåˆ©ç”¨å‚æ•°å…±äº«å‡å°‘æ¨¡å‹å‚æ•°ã€‚</p>
<p><strong>å›¾åƒåˆ†ç±»</strong>ï¼šç”¨äºæå–å›¾åƒç‰¹å¾ï¼Œç»“åˆåç»­å±‚å°†å›¾åƒæ˜ å°„åˆ°ä¸åŒç±»åˆ«ï¼Œå¦‚åŒºåˆ†çŒ«ç‹—å›¾åƒã€‚</p>
<p><strong>ç›®æ ‡æ£€æµ‹</strong>ï¼šæå–ç‰©ä½“ç‰¹å¾ï¼Œé…åˆæ£€æµ‹ç®—æ³•ç¡®å®šå›¾åƒä¸­ç‰©ä½“çš„ä½ç½®å’Œç±»åˆ«ï¼Œåƒè‡ªåŠ¨é©¾é©¶ä¸­æ£€æµ‹è½¦è¾†ã€è¡Œäººã€‚</p>
<p><strong>è¯­ä¹‰åˆ†å‰²</strong>ï¼šå¯¹å›¾åƒæ¯ä¸ªåƒç´ åˆ†ç±»ï¼Œå°†å›¾åƒåˆ†å‰²æˆä¸åŒè¯­ä¹‰åŒºåŸŸï¼Œä¾‹å¦‚åŒ»å­¦å›¾åƒä¸­åˆ†å‰²è‚¿ç˜¤å’Œæ­£å¸¸ç»„ç»‡ã€‚</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"></span><br><span class="line"><span class="comment"># å‡†å¤‡è¾“å…¥æ•°æ®ï¼Œä»…ä¿ç•™ç¬¬ä¸€å¼ å›¾ç‰‡</span></span><br><span class="line">batch_size = <span class="number">1</span></span><br><span class="line">in_channels = <span class="number">3</span></span><br><span class="line">height = <span class="number">4</span></span><br><span class="line">width = <span class="number">4</span></span><br><span class="line"><span class="comment"># æ‰‹åŠ¨è®¾å®šè¾“å…¥å¼ é‡ï¼Œæ–¹ä¾¿åç»­æ‰‹åŠ¨è®¡ç®—éªŒè¯</span></span><br><span class="line">input_tensor = torch.tensor([</span><br><span class="line">    [</span><br><span class="line">        [[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>],</span><br><span class="line">         [<span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>],</span><br><span class="line">         [<span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>],</span><br><span class="line">         [<span class="number">13</span>, <span class="number">14</span>, <span class="number">15</span>, <span class="number">16</span>]],</span><br><span class="line">        [[<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>],</span><br><span class="line">         [<span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>],</span><br><span class="line">         [<span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">13</span>],</span><br><span class="line">         [<span class="number">14</span>, <span class="number">15</span>, <span class="number">16</span>, <span class="number">17</span>]],</span><br><span class="line">        [[<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>],</span><br><span class="line">         [<span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>],</span><br><span class="line">         [<span class="number">11</span>, <span class="number">12</span>, <span class="number">13</span>, <span class="number">14</span>],</span><br><span class="line">         [<span class="number">15</span>, <span class="number">16</span>, <span class="number">17</span>, <span class="number">18</span>]]</span><br><span class="line">    ]</span><br><span class="line">], dtype=torch.float32)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰å·ç§¯å±‚</span></span><br><span class="line">out_channels = <span class="number">2</span></span><br><span class="line">kernel_size = <span class="number">2</span></span><br><span class="line">stride = <span class="number">1</span></span><br><span class="line">padding = <span class="number">0</span></span><br><span class="line">conv2d_layer = nn.Conv2d(in_channels=in_channels, out_channels=out_channels,</span><br><span class="line">                         kernel_size=kernel_size, stride=stride, padding=padding)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰‹åŠ¨è®¾å®šå·ç§¯æ ¸æƒé‡ï¼Œæ–¹ä¾¿åç»­æ‰‹åŠ¨è®¡ç®—éªŒè¯</span></span><br><span class="line"><span class="comment"># è¿™é‡Œå‡è®¾çš„å·ç§¯æ ¸å’Œå‰é¢ç†è®ºéƒ¨åˆ†ä¸€è‡´</span></span><br><span class="line">conv2d_layer.weight.data = torch.tensor([</span><br><span class="line">    [</span><br><span class="line">        [[<span class="number">1</span>, <span class="number">0</span>],</span><br><span class="line">         [<span class="number">0</span>, <span class="number">1</span>]],</span><br><span class="line">        [[<span class="number">0</span>, <span class="number">1</span>],</span><br><span class="line">         [<span class="number">1</span>, <span class="number">0</span>]],</span><br><span class="line">        [[<span class="number">1</span>, <span class="number">1</span>],</span><br><span class="line">         [<span class="number">1</span>, <span class="number">1</span>]]</span><br><span class="line">    ],</span><br><span class="line">    [</span><br><span class="line">        [[<span class="number">1</span>, <span class="number">1</span>],</span><br><span class="line">         [<span class="number">1</span>, <span class="number">1</span>]],</span><br><span class="line">        [[<span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">         [<span class="number">0</span>, <span class="number">0</span>]],</span><br><span class="line">        [[<span class="number">1</span>, <span class="number">0</span>],</span><br><span class="line">         [<span class="number">0</span>, <span class="number">1</span>]]</span><br><span class="line">    ]</span><br><span class="line">], dtype=torch.float32)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰‹åŠ¨è®¾å®šåç½®ä¸º 0ï¼Œç®€åŒ–è®¡ç®—</span></span><br><span class="line">conv2d_layer.bias.data = torch.zeros(out_channels)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿›è¡Œå·ç§¯æ“ä½œ</span></span><br><span class="line">output = conv2d_layer(input_tensor)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;è¾“å…¥å¼ é‡å½¢çŠ¶:&quot;</span>, input_tensor.shape)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;å·ç§¯æ ¸å½¢çŠ¶:&quot;</span>, conv2d_layer.weight.shape)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;è¾“å‡ºå¼ é‡å½¢çŠ¶:&quot;</span>, output.shape)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;ç¬¬ä¸€å¼ å›¾ç‰‡çš„è¾“å‡º:&quot;</span>, output[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰‹åŠ¨è®¡ç®—ç¬¬ä¸€å¼ å›¾ç‰‡ç»è¿‡ç¬¬ä¸€ä¸ªå·ç§¯æ ¸çš„å·¦ä¸Šè§’è¾“å‡ºå€¼</span></span><br><span class="line">first_kernel_channel1 = torch.tensor([[<span class="number">1</span>, <span class="number">0</span>], [<span class="number">0</span>, <span class="number">1</span>]], dtype=torch.float32)</span><br><span class="line">first_kernel_channel2 = torch.tensor([[<span class="number">0</span>, <span class="number">1</span>], [<span class="number">1</span>, <span class="number">0</span>]], dtype=torch.float32)</span><br><span class="line">first_kernel_channel3 = torch.tensor([[<span class="number">1</span>, <span class="number">1</span>], [<span class="number">1</span>, <span class="number">1</span>]], dtype=torch.float32)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¬¬ä¸€ä¸ªé€šé“çš„å±€éƒ¨å·ç§¯</span></span><br><span class="line">local_conv_channel1 = (input_tensor[<span class="number">0</span>, <span class="number">0</span>, :<span class="number">2</span>, :<span class="number">2</span>] * first_kernel_channel1).<span class="built_in">sum</span>()</span><br><span class="line"><span class="comment"># ç¬¬äºŒä¸ªé€šé“çš„å±€éƒ¨å·ç§¯</span></span><br><span class="line">local_conv_channel2 = (input_tensor[<span class="number">0</span>, <span class="number">1</span>, :<span class="number">2</span>, :<span class="number">2</span>] * first_kernel_channel2).<span class="built_in">sum</span>()</span><br><span class="line"><span class="comment"># ç¬¬ä¸‰ä¸ªé€šé“çš„å±€éƒ¨å·ç§¯</span></span><br><span class="line">local_conv_channel3 = (input_tensor[<span class="number">0</span>, <span class="number">2</span>, :<span class="number">2</span>, :<span class="number">2</span>] * first_kernel_channel3).<span class="built_in">sum</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤šé€šé“ç»“æœç›¸åŠ </span></span><br><span class="line">manual_output = local_conv_channel1 + local_conv_channel2 + local_conv_channel3</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;æ‰‹åŠ¨è®¡ç®—ç¬¬ä¸€å¼ å›¾ç‰‡ç»è¿‡ç¬¬ä¸€ä¸ªå·ç§¯æ ¸å·¦ä¸Šè§’è¾“å‡ºå€¼:&quot;</span>, manual_output)</span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°ä»£ç æ¨¡æ‹Ÿäº†å¤„ç†å½©è‰²å›¾åƒçš„è¿‡ç¨‹ã€‚è¾“å…¥æ•°æ®æ˜¯ä¸€ä¸ªå››ç»´å¼ é‡ï¼Œå½¢çŠ¶ä¸º <code>(batch_size, in_channels, height, width)</code>ã€‚ä¾‹å¦‚ï¼Œ<code>batch_size = 1</code> è¡¨ç¤ºä¸€æ¬¡å¤„ç† 1 å¼ å›¾åƒï¼›<code>in_channels = 3</code> å¯¹åº” RGB ä¸‰ä¸ªé€šé“ï¼›<code>height = 4</code> å’Œ <code>width = 4</code> æ˜¯å›¾åƒçš„é«˜åº¦å’Œå®½åº¦ã€‚è¾“å…¥æ•°æ®å¯ä»¥è¡¨ç¤ºä¸ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">è¾“å…¥æ•°æ®å½¢çŠ¶: (2, 3, 4, 4)</span><br><span class="line">ç¬¬ 1 å¼ å›¾åƒé€šé“ 1:</span><br><span class="line">[[1, 2, 3, 4],</span><br><span class="line"> [5, 6, 7, 8],</span><br><span class="line"> [9, 10, 11, 12],</span><br><span class="line"> [13, 14, 15, 16]]</span><br><span class="line"></span><br><span class="line">ç¬¬ 1 å¼ å›¾åƒé€šé“ 2:</span><br><span class="line">[[2, 3, 4, 5],</span><br><span class="line"> [6, 7, 8, 9],</span><br><span class="line"> [10, 11, 12, 13],</span><br><span class="line"> [14, 15, 16, 17]]</span><br><span class="line"></span><br><span class="line">ç¬¬ 1 å¼ å›¾åƒé€šé“ 3:</span><br><span class="line">[[3, 4, 5, 6],</span><br><span class="line"> [7, 8, 9, 10],</span><br><span class="line"> [11, 12, 13, 14],</span><br><span class="line"> [15, 16, 17, 18]]</span><br><span class="line"></span><br><span class="line">...ï¼ˆå…¶ä»–å›¾ç‰‡ç±»ä¼¼ï¼‰</span><br></pre></td></tr></table></figure>
<p>å®šä¹‰ä¸€ä¸ªäºŒç»´å·ç§¯å±‚ï¼Œè®¾ç½®å‚æ•°å¦‚ä¸‹ï¼š</p>
<ul>
<li><code>in_channels = 3</code>ï¼Œä¸è¾“å…¥å›¾åƒçš„é€šé“æ•°ä¸€è‡´ã€‚</li>
<li><code>out_channels = 2</code>ï¼Œè¡¨ç¤ºä½¿ç”¨ 2 ä¸ªå·ç§¯æ ¸ã€‚</li>
<li><code>kernel_size = 2</code>ï¼Œå·ç§¯æ ¸æ˜¯ 2x2 çš„æ­£æ–¹å½¢ã€‚</li>
<li><code>stride = 1</code>ï¼Œå·ç§¯æ ¸æ¯æ¬¡æ»‘åŠ¨ 1 ä¸ªå•ä½ã€‚</li>
<li><code>padding = 0</code>ï¼Œä¸è¿›è¡Œå¡«å……ã€‚</li>
</ul>
<p>æ¯ä¸ªå·ç§¯æ ¸ä¹Ÿæ˜¯ä¸€ä¸ªå››ç»´å¼ é‡ï¼Œå½¢çŠ¶ä¸º <code>(out_channels, in_channels, kernel_height, kernel_width)</code>ï¼Œè¿™é‡Œæ˜¯ <code>(2, 3, 2, 2)</code>ã€‚å‡è®¾ä¸¤ä¸ªå·ç§¯æ ¸åˆ†åˆ«ä¸ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">å·ç§¯æ ¸ 1:</span><br><span class="line">é€šé“ 1:</span><br><span class="line">[[1, 0],</span><br><span class="line"> [0, 1]]</span><br><span class="line"></span><br><span class="line">é€šé“ 2:</span><br><span class="line">[[0, 1],</span><br><span class="line"> [1, 0]]</span><br><span class="line"></span><br><span class="line">é€šé“ 3:</span><br><span class="line">[[1, 1],</span><br><span class="line"> [1, 1]]</span><br><span class="line"></span><br><span class="line">å·ç§¯æ ¸ 2:</span><br><span class="line">é€šé“ 1:</span><br><span class="line">[[1, 1],</span><br><span class="line"> [1, 1]]</span><br><span class="line"></span><br><span class="line">é€šé“ 2:</span><br><span class="line">[[0, 0],</span><br><span class="line"> [0, 0]]</span><br><span class="line"></span><br><span class="line">é€šé“ 3:</span><br><span class="line">[[1, 0],</span><br><span class="line"> [0, 1]]</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">å·ç§¯æ“ä½œ</span><br><span class="line">ä»¥ç¬¬ 1 å¼ å›¾åƒä¸ºä¾‹ï¼Œå¯¹äºå·ç§¯æ ¸ 1ï¼š</span><br><span class="line">é€šé“ 1 çš„å·ç§¯ï¼šå·ç§¯æ ¸åœ¨é€šé“ 1 çš„è¾“å…¥å›¾åƒä¸Šæ»‘åŠ¨ï¼Œè®¡ç®—å±€éƒ¨åŒºåŸŸä¸å·ç§¯æ ¸å¯¹åº”å…ƒç´ ç›¸ä¹˜å†æ±‚å’Œã€‚ä¾‹å¦‚ï¼Œåœ¨å·¦ä¸Šè§’åŒºåŸŸï¼š</span><br><span class="line">é€šé“ 2 å’Œé€šé“ 3 åŒæ ·æ“ä½œï¼šå¾—åˆ°å„è‡ªçš„å±€éƒ¨å·ç§¯ç»“æœã€‚</span><br><span class="line">å¤šé€šé“ç»“æœç›¸åŠ ï¼šå°†ä¸‰ä¸ªé€šé“çš„å±€éƒ¨å·ç§¯ç»“æœç›¸åŠ ï¼Œå¾—åˆ°è¯¥ä½ç½®çš„æœ€ç»ˆè¾“å‡ºå€¼ã€‚</span><br><span class="line">æ»‘åŠ¨å·ç§¯æ ¸ï¼šå·ç§¯æ ¸åœ¨å›¾åƒä¸ŠæŒ‰æ­¥é•¿ 1 æ»‘åŠ¨ï¼Œé‡å¤ä¸Šè¿°æ“ä½œï¼Œå¾—åˆ°å·ç§¯æ ¸ 1 å¯¹ç¬¬ 1 å¼ å›¾åƒçš„è¾“å‡ºç‰¹å¾å›¾ã€‚</span><br><span class="line">å¯¹äºå·ç§¯æ ¸ 2 ä¹Ÿè¿›è¡ŒåŒæ ·çš„æ“ä½œï¼Œæœ€ç»ˆå¾—åˆ°ä¸¤ä¸ªè¾“å‡ºç‰¹å¾å›¾ï¼Œè¿™ä¸¤ä¸ªç‰¹å¾å›¾ç»„æˆäº†ç¬¬ 1 å¼ å›¾åƒç»è¿‡å·ç§¯å±‚åçš„è¾“å‡ºã€‚å¯¹äºç¬¬ 2 å¼ å›¾åƒï¼Œä¹Ÿé‡å¤ä¸Šè¿°å·ç§¯æ“ä½œã€‚</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">è¾“å…¥å¼ é‡å½¢çŠ¶: torch.Size([1, 3, 4, 4])</span><br><span class="line">å·ç§¯æ ¸å½¢çŠ¶: torch.Size([2, 3, 2, 2])</span><br><span class="line">è¾“å‡ºå¼ é‡å½¢çŠ¶: torch.Size([1, 2, 3, 3])</span><br><span class="line">ç¬¬ä¸€å¼ å›¾ç‰‡çš„è¾“å‡º:</span><br><span class="line">tensor([[[ 41.,  48.,  55.],</span><br><span class="line">         [ 65.,  72.,  79.],</span><br><span class="line">         [ 89.,  96., 103.]],</span><br><span class="line"></span><br><span class="line">        [[ 26.,  30.,  34.],</span><br><span class="line">         [ 46.,  50.,  54.],</span><br><span class="line">         [ 66.,  70.,  74.]]], grad_fn=&lt;SelectBackward0&gt;)</span><br><span class="line">æ‰‹åŠ¨è®¡ç®—ç¬¬ä¸€å¼ å›¾ç‰‡ç»è¿‡ç¬¬ä¸€ä¸ªå·ç§¯æ ¸å·¦ä¸Šè§’è¾“å‡ºå€¼: tensor(41.)</span><br></pre></td></tr></table></figure>
<hr>
<p>å·ç§¯æ ¸å¦‚ä½•ç¡®å®šï¼Ÿ</p>
<p>å·ç§¯æ ¸çš„ç¡®å®šéœ€è¦ç»¼åˆè€ƒè™‘ä»»åŠ¡éœ€æ±‚ã€æ•°æ®ç‰¹ç‚¹ã€æ¨¡å‹æ¶æ„å’Œè®¡ç®—èµ„æºç­‰å› ç´ ï¼Œå¹¶é€šè¿‡å®éªŒå’Œè°ƒä¼˜ä¸æ–­ä¼˜åŒ–ï¼Œä»¥è¾¾åˆ°æœ€ä½³çš„æ€§èƒ½ã€‚</p>
<hr>
<ol start="3">
<li><code>nn.Conv3d</code> 3Då·ç§¯ï¼šå¤„ç†è§†é¢‘/ä½“æ•°æ®</li>
</ol>
<p><code>nn.Conv3d</code> æ˜¯ PyTorch ä¸­ç”¨äºå®ç°ä¸‰ç»´å·ç§¯æ“ä½œçš„ç±»ï¼Œä¸»è¦ç”¨äºå¤„ç†è§†é¢‘æ•°æ®ï¼ˆåŒ…å«æ—¶é—´ç»´åº¦å’Œç©ºé—´ç»´åº¦ï¼‰æˆ–ä½“æ•°æ®ï¼ˆå¦‚åŒ»å­¦å½±åƒä¸­çš„ä¸‰ç»´ä½“æ•°æ®ï¼‰ã€‚å®ƒé€šè¿‡å¯å­¦ä¹ çš„ä¸‰ç»´å·ç§¯æ ¸åœ¨è¾“å…¥æ•°æ®ä¸Šè¿›è¡Œæ»‘åŠ¨å¹¶æ‰§è¡Œå·ç§¯è¿ç®—ï¼Œæå–æ•°æ®ä¸­çš„ä¸‰ç»´ç‰¹å¾ï¼Œåˆ©ç”¨å‚æ•°å…±äº«æœºåˆ¶å‡å°‘æ¨¡å‹å‚æ•°æ•°é‡ï¼Œé™ä½è®¡ç®—å¤æ‚åº¦ã€‚</p>
<p><strong>è§†é¢‘åˆ†ç±»</strong>ï¼šåœ¨è§†é¢‘åˆ†ç±»ä»»åŠ¡ä¸­ï¼Œ<code>nn.Conv3d</code> ç”¨äºæå–è§†é¢‘çš„æ—¶ç©ºç‰¹å¾ï¼Œé€šè¿‡å¤šä¸ªå·ç§¯å±‚å’Œæ± åŒ–å±‚çš„ç»„åˆï¼Œå°†è§†é¢‘ç‰¹å¾æ˜ å°„åˆ°ä¸åŒçš„ç±»åˆ«ã€‚ä¾‹å¦‚ï¼Œåœ¨è¯†åˆ«è§†é¢‘ä¸­çš„åŠ¨ä½œç±»å‹ï¼ˆå¦‚è·‘æ­¥ã€è·³èˆã€æ‰“çƒç­‰ï¼‰æ—¶ï¼Œä¸‰ç»´å·ç§¯å¯ä»¥æ•æ‰è§†é¢‘ä¸­éšæ—¶é—´å˜åŒ–çš„åŠ¨ä½œç‰¹å¾ã€‚</p>
<p><strong>åŒ»å­¦å½±åƒåˆ†æ</strong>ï¼šåœ¨åŒ»å­¦å½±åƒåˆ†æä¸­ï¼Œå¦‚å¯¹ CT æˆ– MRI æ‰«æå¾—åˆ°çš„ä¸‰ç»´ä½“æ•°æ®è¿›è¡Œåˆ†æï¼Œ<code>nn.Conv3d</code> å¯ä»¥ç”¨äºè‚¿ç˜¤æ£€æµ‹ã€å™¨å®˜åˆ†å‰²ç­‰ä»»åŠ¡ã€‚å®ƒèƒ½å¤Ÿæå–ä½“æ•°æ®ä¸­çš„ä¸‰ç»´ç»“æ„ä¿¡æ¯ï¼Œå¸®åŠ©åŒ»ç”Ÿè¿›è¡Œç–¾ç—…è¯Šæ–­ã€‚</p>
<p><strong>è‡ªåŠ¨é©¾é©¶åœºæ™¯</strong>ï¼šåœ¨è‡ªåŠ¨é©¾é©¶ä¸­å¤„ç†ç‚¹äº‘æ•°æ®ï¼ˆå¯ä»¥çœ‹ä½œä¸‰ç»´ç©ºé—´ä¸­çš„æ•°æ®ï¼‰æ—¶ï¼Œ<code>nn.Conv3d</code> å¯ç”¨äºè¯†åˆ«é“è·¯ä¸Šçš„éšœç¢ç‰©ã€è½¦è¾†ã€è¡Œäººç­‰ç›®æ ‡ï¼Œé€šè¿‡åˆ†æç‚¹äº‘æ•°æ®çš„ä¸‰ç»´ç‰¹å¾æ¥è¾…åŠ©å†³ç­–ã€‚</p>
<p><strong>å·ç§¯æ ¸ä¸å·ç§¯æ“ä½œ</strong></p>
<p>ä¸‰ç»´å·ç§¯æ ¸æ˜¯ä¸€ä¸ªä¸‰ç»´çš„çŸ©é˜µï¼Œå…¶å…ƒç´ æ˜¯å¯å­¦ä¹ çš„æƒé‡å‚æ•°ã€‚åœ¨è¿›è¡Œå·ç§¯æ“ä½œæ—¶ï¼Œä¸‰ç»´å·ç§¯æ ¸ä¼šåœ¨è¾“å…¥çš„ä¸‰ç»´æ•°æ®ï¼ˆå¦‚è§†é¢‘çš„å¤šä¸ªå¸§ç»„æˆçš„åºåˆ—æˆ–è€…ä¸‰ç»´ä½“æ•°æ®ï¼‰ä¸ŠæŒ‰ä¸€å®šçš„æ­¥é•¿è¿›è¡Œæ»‘åŠ¨ï¼Œæ¯æ¬¡è¦†ç›–ä¸€ä¸ªä¸å·ç§¯æ ¸å¤§å°ç›¸åŒçš„ä¸‰ç»´å±€éƒ¨åŒºåŸŸã€‚å¯¹äºè¿™ä¸ªå±€éƒ¨åŒºåŸŸï¼Œå°†å·ç§¯æ ¸ä¸è¯¥åŒºåŸŸçš„å…ƒç´ å¯¹åº”ç›¸ä¹˜åæ±‚å’Œï¼Œå¾—åˆ°ä¸€ä¸ªè¾“å‡ºå€¼ï¼Œè¿™ä¸ªå€¼å°±æ„æˆäº†è¾“å‡ºç‰¹å¾ä½“çš„ä¸€ä¸ªå…ƒç´ ã€‚éšç€å·ç§¯æ ¸ä¸æ–­æ»‘åŠ¨ï¼Œéå†æ•´ä¸ªè¾“å…¥ä¸‰ç»´æ•°æ®ï¼Œæœ€ç»ˆç”Ÿæˆå®Œæ•´çš„è¾“å‡ºç‰¹å¾ä½“ã€‚</p>
<hr>
<p><code>nn.Conv1d/2d/3d</code>çš„å…±åŒåŸç†ä¸ç‰¹å¾</p>
<p><strong>å…±åŒåŸç†</strong></p>
<p>1.å·ç§¯æ“ä½œæ ¸å¿ƒ</p>
<p>æ ¸å¿ƒéƒ½æ˜¯å·ç§¯è¿ç®—ã€‚å·ç§¯æ ¸ï¼ˆä¹Ÿç§°ä¸ºæ»¤æ³¢å™¨ï¼‰æ˜¯ä¸€ç»„å¯å­¦ä¹ çš„æƒé‡å‚æ•°ï¼Œåœ¨è¾“å…¥æ•°æ®ä¸ŠæŒ‰ç…§ä¸€å®šè§„åˆ™æ»‘åŠ¨ï¼Œæ¯æ¬¡è¦†ç›–ä¸€ä¸ªå±€éƒ¨åŒºåŸŸï¼Œå°†å·ç§¯æ ¸ä¸è¯¥å±€éƒ¨åŒºåŸŸçš„å…ƒç´ å¯¹åº”ç›¸ä¹˜åæ±‚å’Œï¼Œå¾—åˆ°ä¸€ä¸ªè¾“å‡ºå€¼ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸æ–­é‡å¤ï¼Œç›´åˆ°å·ç§¯æ ¸éå†å®Œæ•´ä¸ªè¾“å…¥æ•°æ®ï¼Œä»è€Œç”Ÿæˆè¾“å‡ºç‰¹å¾ã€‚</p>
<p>ä»¥ <code>nn.Conv1d</code> ä¸ºä¾‹ï¼Œè¾“å…¥æ˜¯ä¸€ç»´åºåˆ—ï¼Œå·ç§¯æ ¸ä¹Ÿæ˜¯ä¸€ç»´çš„ï¼Œåœ¨åºåˆ—ä¸Šæ»‘åŠ¨è¿›è¡Œå·ç§¯ï¼›<code>nn.Conv2d</code> è¾“å…¥æ˜¯äºŒç»´å›¾åƒï¼Œå·ç§¯æ ¸æ˜¯äºŒç»´çŸ©é˜µï¼Œåœ¨å›¾åƒä¸Šæ»‘åŠ¨ï¼›<code>nn.Conv3d</code> è¾“å…¥æ˜¯ä¸‰ç»´æ•°æ®ï¼ˆå¦‚è§†é¢‘æˆ–ä½“æ•°æ®ï¼‰ï¼Œå·ç§¯æ ¸æ˜¯ä¸‰ç»´çš„ï¼Œåœ¨ä¸‰ç»´ç©ºé—´ä¸­æ»‘åŠ¨ã€‚</p>
<p>2.çº¿æ€§å˜æ¢</p>
<p>å·ç§¯æ“ä½œæœ¬è´¨ä¸Šæ˜¯ä¸€ç§çº¿æ€§å˜æ¢ã€‚å¯¹äºè¾“å…¥æ•°æ®çš„æ¯ä¸ªå±€éƒ¨åŒºåŸŸï¼Œå·ç§¯è¿ç®—å°†å…¶ä¸å·ç§¯æ ¸è¿›è¡ŒåŠ æƒæ±‚å’Œï¼Œè¿™ç›¸å½“äºå¯¹è¾“å…¥æ•°æ®è¿›è¡Œäº†çº¿æ€§ç»„åˆã€‚è¿™ç§çº¿æ€§å˜æ¢ä½¿å¾—æ¨¡å‹èƒ½å¤Ÿå­¦ä¹ åˆ°è¾“å…¥æ•°æ®ä¸­çš„ç‰¹å¾æ¨¡å¼ã€‚</p>
<p>3.å‚æ•°å…±äº«</p>
<p>åœ¨å·ç§¯è¿‡ç¨‹ä¸­ï¼Œå·ç§¯æ ¸çš„æƒé‡åœ¨æ•´ä¸ªè¾“å…¥æ•°æ®ä¸Šæ˜¯å…±äº«çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒåŒä¸€ä¸ªå·ç§¯æ ¸åœ¨ä¸åŒçš„ä½ç½®è¿›è¡Œå·ç§¯æ“ä½œæ—¶ï¼Œä½¿ç”¨çš„æ˜¯ç›¸åŒçš„æƒé‡å‚æ•°ã€‚è¿™å¤§å¤§å‡å°‘äº†æ¨¡å‹éœ€è¦å­¦ä¹ çš„å‚æ•°æ•°é‡ï¼Œé™ä½äº†è®¡ç®—å¤æ‚åº¦ï¼ŒåŒæ—¶ä¹Ÿæé«˜äº†æ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›ï¼Œä½¿å¾—æ¨¡å‹èƒ½å¤Ÿåœ¨ä¸åŒä½ç½®æ£€æµ‹åˆ°ç›¸åŒçš„ç‰¹å¾ã€‚</p>
<p>4.å¤šé€šé“å¤„ç†</p>
<p>å½“è¾“å…¥æ•°æ®å…·æœ‰å¤šä¸ªé€šé“æ—¶ï¼Œæ¯ä¸ªå·ç§¯æ ¸ä¹Ÿå…·æœ‰å¯¹åº”æ•°é‡çš„é€šé“ã€‚å·ç§¯æ“ä½œä¼šåœ¨æ¯ä¸ªé€šé“ä¸Šåˆ†åˆ«è¿›è¡Œå·ç§¯ï¼Œç„¶åå°†å„é€šé“çš„ç»“æœç›¸åŠ ï¼Œå¾—åˆ°æœ€ç»ˆçš„è¾“å‡ºå€¼ã€‚ä¾‹å¦‚ï¼Œå¯¹äº RGB å›¾åƒï¼ˆ3 ä¸ªé€šé“ï¼‰ï¼Œæ¯ä¸ªäºŒç»´å·ç§¯æ ¸ä¹Ÿæœ‰ 3 ä¸ªé€šé“ï¼Œåˆ†åˆ«å¯¹ Rã€Gã€B é€šé“è¿›è¡Œå·ç§¯åæ±‚å’Œã€‚<code>nn.Conv1d</code>ã€<code>nn.Conv2d</code> å’Œ <code>nn.Conv3d</code> éƒ½æ”¯æŒå¤šé€šé“è¾“å…¥å’Œè¾“å‡ºï¼Œé€šè¿‡ä½¿ç”¨å¤šä¸ªå·ç§¯æ ¸å¯ä»¥å¾—åˆ°å¤šä¸ªé€šé“çš„è¾“å‡ºç‰¹å¾ã€‚</p>
<p><strong>å…±åŒç‰¹å¾</strong></p>
<p>1.å¯å­¦ä¹ æ€§</p>
<p>å·ç§¯æ ¸çš„æƒé‡å‚æ•°æ˜¯å¯å­¦ä¹ çš„ï¼Œåœ¨æ¨¡å‹è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œé€šè¿‡åå‘ä¼ æ’­ç®—æ³•å’Œä¼˜åŒ–å™¨ï¼ˆå¦‚éšæœºæ¢¯åº¦ä¸‹é™ã€Adam ç­‰ï¼‰ä¸æ–­è°ƒæ•´å·ç§¯æ ¸çš„æƒé‡ï¼Œä½¿å¾—æ¨¡å‹èƒ½å¤Ÿè‡ªåŠ¨å­¦ä¹ åˆ°è¾“å…¥æ•°æ®ä¸­çš„æœ‰æ•ˆç‰¹å¾ï¼Œä»¥é€‚åº”ä¸åŒçš„ä»»åŠ¡éœ€æ±‚ï¼Œå¦‚åˆ†ç±»ã€æ£€æµ‹ã€åˆ†å‰²ç­‰ã€‚</p>
<p>2.å±€éƒ¨æ„ŸçŸ¥</p>
<p>éƒ½å…·æœ‰å±€éƒ¨æ„ŸçŸ¥çš„ç‰¹æ€§ï¼Œå³å·ç§¯æ ¸åªå…³æ³¨è¾“å…¥æ•°æ®çš„å±€éƒ¨åŒºåŸŸï¼Œè€Œä¸æ˜¯å…¨å±€ä¿¡æ¯ã€‚è¿™ç§å±€éƒ¨æ„ŸçŸ¥èƒ½åŠ›ä½¿å¾—æ¨¡å‹èƒ½å¤Ÿæ•æ‰åˆ°æ•°æ®ä¸­çš„å±€éƒ¨ç‰¹å¾ï¼Œå¦‚è¾¹ç¼˜ã€çº¹ç†ã€æ¨¡å¼ç­‰ã€‚é€šè¿‡å †å å¤šä¸ªå·ç§¯å±‚ï¼Œæ¨¡å‹å¯ä»¥é€æ¸å­¦ä¹ åˆ°æ›´é«˜çº§ã€æ›´æŠ½è±¡çš„ç‰¹å¾ã€‚</p>
<p>3.å¹³ç§»ä¸å˜æ€§</p>
<p>ç”±äºå‚æ•°å…±äº«çš„ç‰¹æ€§ï¼Œå·ç§¯æ“ä½œå…·æœ‰å¹³ç§»ä¸å˜æ€§ã€‚è¿™æ„å‘³ç€å¦‚æœè¾“å…¥æ•°æ®ä¸­çš„æŸä¸ªç‰¹å¾åœ¨ä¸åŒä½ç½®å‡ºç°ï¼Œå·ç§¯æ ¸éƒ½èƒ½å¤Ÿæ£€æµ‹åˆ°è¯¥ç‰¹å¾ï¼Œè€Œä¸ä¾èµ–äºå…¶å…·ä½“ä½ç½®ã€‚è¿™ç§å¹³ç§»ä¸å˜æ€§ä½¿å¾—æ¨¡å‹åœ¨å¤„ç†å…·æœ‰å¹³ç§»ç‰¹æ€§çš„æ•°æ®æ—¶æ›´åŠ æœ‰æ•ˆï¼Œä¾‹å¦‚å›¾åƒä¸­çš„ç‰©ä½“åœ¨ä¸åŒä½ç½®å‡ºç°ï¼Œæ¨¡å‹éƒ½èƒ½å¤Ÿæ­£ç¡®è¯†åˆ«ã€‚</p>
<p>4.è¾“å‡ºç‰¹å¾çš„ç»´åº¦è°ƒæ•´</p>
<p>é€šè¿‡è°ƒæ•´å·ç§¯æ ¸çš„å¤§å°ã€æ­¥é•¿å’Œå¡«å……ç­‰å‚æ•°ï¼Œå¯ä»¥æ§åˆ¶è¾“å‡ºç‰¹å¾çš„ç»´åº¦ã€‚æ­¥é•¿è¶Šå¤§ï¼Œè¾“å‡ºç‰¹å¾çš„ç»´åº¦è¶Šå°ï¼›å¡«å……å¯ä»¥åœ¨è¾“å…¥æ•°æ®çš„è¾¹ç¼˜æ·»åŠ é¢å¤–çš„å…ƒç´ ï¼Œä»è€Œä¿æŒè¾“å‡ºç‰¹å¾çš„ç»´åº¦ä¸è¾“å…¥æ•°æ®ç›¸åŒæˆ–æ»¡è¶³ç‰¹å®šçš„è¦æ±‚ã€‚è¿™ç§çµæ´»æ€§ä½¿å¾—æ¨¡å‹èƒ½å¤Ÿæ ¹æ®å…·ä½“ä»»åŠ¡å’Œæ•°æ®ç‰¹ç‚¹è¿›è¡Œåˆç†çš„è®¾è®¡ã€‚</p>
<hr>
<ol start="4">
<li><code>nn.ConvTranspose1d/2d/3d</code> è½¬ç½®å·ç§¯ï¼šåå·ç§¯ï¼ˆä¸Šé‡‡æ ·ï¼‰</li>
</ol>
<p><code>nn.ConvTranspose1d</code>ã€<code>nn.ConvTranspose2d</code> å’Œ <code>nn.ConvTranspose3d</code> åˆ†åˆ«æ˜¯ PyTorch ä¸­ç”¨äºä¸€ç»´ã€äºŒç»´å’Œä¸‰ç»´è½¬ç½®å·ç§¯ï¼ˆä¹Ÿå¸¸è¢«ç§°ä¸ºåå·ç§¯ï¼Œä½†å®é™…ä¸Šå¹¶éä¸¥æ ¼æ„ä¹‰çš„å·ç§¯é€†è¿ç®—ï¼Œä¸»è¦ç”¨äºä¸Šé‡‡æ ·ï¼‰çš„ç±»ã€‚è½¬ç½®å·ç§¯é€šè¿‡åœ¨è¾“å…¥æ•°æ®ä¸Šè¿›è¡Œç‰¹æ®Šçš„å·ç§¯æ“ä½œï¼Œä½¿å¾—è¾“å‡ºçš„å°ºå¯¸æ¯”è¾“å…¥å°ºå¯¸æ›´å¤§ï¼Œå®ç°æ•°æ®çš„ä¸Šé‡‡æ ·ï¼Œåœ¨å›¾åƒç”Ÿæˆã€è¯­ä¹‰åˆ†å‰²ç­‰ä»»åŠ¡ä¸­ç»å¸¸ä½¿ç”¨ã€‚</p>
<p>è½¬ç½®å·ç§¯æœ¬è´¨ä¸Šæ˜¯æ ‡å‡†å·ç§¯çš„ä¸€ç§ â€œé€†å‘â€ æ“ä½œï¼Œä½†ä¸æ˜¯ä¸¥æ ¼æ„ä¹‰ä¸Šçš„é€†è¿ç®—ã€‚åœ¨æ ‡å‡†å·ç§¯ä¸­ï¼Œå·ç§¯æ ¸åœ¨è¾“å…¥æ•°æ®ä¸Šæ»‘åŠ¨ï¼Œå°†å±€éƒ¨åŒºåŸŸæ˜ å°„åˆ°ä¸€ä¸ªè¾“å‡ºå€¼ï¼Œå¯¼è‡´è¾“å‡ºå°ºå¯¸é€šå¸¸å°äºè¾“å…¥å°ºå¯¸ã€‚è€Œè½¬ç½®å·ç§¯åˆ™æ˜¯å°†è¾“å…¥çš„æ¯ä¸ªå…ƒç´ æ‰©å±•åˆ°ä¸€ä¸ªæ›´å¤§çš„åŒºåŸŸï¼Œç„¶åä¸å·ç§¯æ ¸è¿›è¡Œå·ç§¯æ“ä½œï¼Œä»è€Œå®ç°è¾“å‡ºå°ºå¯¸å¤§äºè¾“å…¥å°ºå¯¸çš„æ•ˆæœã€‚</p>
<p>å…·ä½“æ¥è¯´ï¼Œè½¬ç½®å·ç§¯é€šè¿‡åœ¨è¾“å…¥æ•°æ®å‘¨å›´æ’å…¥é›¶å€¼ï¼ˆç§°ä¸º â€œé›¶å¡«å……â€ï¼‰ï¼Œå¹¶è°ƒæ•´å·ç§¯æ ¸çš„æ»‘åŠ¨æ–¹å¼ï¼Œä½¿å¾—å·ç§¯æ“ä½œèƒ½å¤Ÿäº§ç”Ÿæ›´å¤§çš„è¾“å‡ºã€‚åœ¨ä¸€ç»´ã€äºŒç»´å’Œä¸‰ç»´çš„æƒ…å†µä¸‹ï¼Œåˆ†åˆ«ä½¿ç”¨ <code>nn.ConvTranspose1d</code>ã€<code>nn.ConvTranspose2d</code> å’Œ <code>nn.ConvTranspose3d</code> æ¥å®ç°ç›¸åº”ç»´åº¦çš„è½¬ç½®å·ç§¯ã€‚</p>
<blockquote>
<p><mark>ä¸Šé‡‡æ ·</mark></p>
<p>æŒ‡çš„æ˜¯å°†ä½åˆ†è¾¨ç‡çš„æ•°æ®è½¬æ¢ä¸ºé«˜åˆ†è¾¨ç‡æ•°æ®çš„è¿‡ç¨‹ã€‚åœ¨æ·±åº¦å­¦ä¹ ä¸­ï¼Œè¾“å…¥æ•°æ®ï¼ˆå¦‚å›¾åƒã€ç‰¹å¾å›¾ç­‰ï¼‰ç»è¿‡ä¸€ç³»åˆ—ä¸‹é‡‡æ ·æ“ä½œï¼ˆå¦‚å·ç§¯ã€æ± åŒ–ï¼‰åå°ºå¯¸ä¼šå˜å°ï¼Œä¸ºäº†æ¢å¤åˆ°åŸå§‹å°ºå¯¸æˆ–è¾¾åˆ°ç‰¹å®šä»»åŠ¡æ‰€éœ€çš„å°ºå¯¸ï¼Œå°±éœ€è¦è¿›è¡Œä¸Šé‡‡æ ·æ“ä½œã€‚</p>
<ul>
<li><strong>æ¢å¤å°ºå¯¸</strong>ï¼šåœ¨ä¸€äº›ä»»åŠ¡ä¸­ï¼Œå¦‚è¯­ä¹‰åˆ†å‰²ï¼Œæ¨¡å‹éœ€è¦å¯¹è¾“å…¥å›¾åƒçš„æ¯ä¸ªåƒç´ è¿›è¡Œåˆ†ç±»ï¼Œç»è¿‡ä¸‹é‡‡æ ·åçš„ç‰¹å¾å›¾å°ºå¯¸å˜å°ï¼Œéœ€è¦é€šè¿‡ä¸Šé‡‡æ ·æ¢å¤åˆ°ä¸è¾“å…¥å›¾åƒç›¸åŒçš„å°ºå¯¸ï¼Œä»¥ä¾¿ä¸ºæ¯ä¸ªåƒç´ åˆ†é…ç±»åˆ«æ ‡ç­¾ã€‚</li>
<li><strong>å¢åŠ ç»†èŠ‚</strong>ï¼šä¸Šé‡‡æ ·å¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šå¢åŠ æ•°æ®çš„ç»†èŠ‚ä¿¡æ¯ï¼Œä½¿æ¨¡å‹èƒ½å¤Ÿå­¦ä¹ åˆ°æ›´ä¸°å¯Œçš„ç‰¹å¾ï¼Œæå‡æ¨¡å‹æ€§èƒ½ã€‚</li>
</ul>
</blockquote>
<p><strong>å›¾åƒç”Ÿæˆ</strong>ï¼šåœ¨ç”Ÿæˆå¯¹æŠ—ç½‘ç»œï¼ˆGANï¼‰å’Œå˜åˆ†è‡ªç¼–ç å™¨ï¼ˆVAEï¼‰ç­‰å›¾åƒç”Ÿæˆæ¨¡å‹ä¸­ï¼Œè½¬ç½®å·ç§¯ç”¨äºå°†ä½ç»´çš„ç‰¹å¾å‘é‡é€æ­¥ä¸Šé‡‡æ ·ä¸ºé«˜åˆ†è¾¨ç‡çš„å›¾åƒã€‚ä¾‹å¦‚ï¼Œåœ¨ç”Ÿæˆæ‰‹å†™æ•°å­—å›¾åƒæ—¶ï¼Œæ¨¡å‹ä»ä¸€ä¸ªéšæœºçš„ä½ç»´å‘é‡å¼€å§‹ï¼Œé€šè¿‡ä¸€ç³»åˆ—çš„è½¬ç½®å·ç§¯å±‚é€æ¸ç”Ÿæˆ 28x28 åƒç´ çš„æ‰‹å†™æ•°å­—å›¾åƒã€‚</p>
<p><strong>è¯­ä¹‰åˆ†å‰²</strong>ï¼šåœ¨è¯­ä¹‰åˆ†å‰²ä»»åŠ¡ä¸­ï¼Œæ¨¡å‹éœ€è¦å°†å·ç§¯å±‚æå–çš„ä½åˆ†è¾¨ç‡ç‰¹å¾å›¾æ¢å¤åˆ°ä¸è¾“å…¥å›¾åƒç›¸åŒçš„å°ºå¯¸ï¼Œä»¥ä¾¿ä¸ºæ¯ä¸ªåƒç´ åˆ†é…ä¸€ä¸ªç±»åˆ«æ ‡ç­¾ã€‚è½¬ç½®å·ç§¯å¯ä»¥æœ‰æ•ˆåœ°å®ç°ç‰¹å¾å›¾çš„ä¸Šé‡‡æ ·ï¼Œå¸®åŠ©æ¨¡å‹ç”Ÿæˆä¸è¾“å…¥å›¾åƒå¤§å°ä¸€è‡´çš„åˆ†å‰²ç»“æœã€‚</p>
<p><strong>è¶…åˆ†è¾¨ç‡é‡å»º</strong>ï¼šè¶…åˆ†è¾¨ç‡é‡å»ºä»»åŠ¡æ—¨åœ¨å°†ä½åˆ†è¾¨ç‡çš„å›¾åƒæ¢å¤ä¸ºé«˜åˆ†è¾¨ç‡çš„å›¾åƒã€‚è½¬ç½®å·ç§¯å¯ä»¥ç”¨äºé€æ­¥å¢åŠ å›¾åƒçš„åˆ†è¾¨ç‡ï¼Œæé«˜å›¾åƒçš„æ¸…æ™°åº¦å’Œç»†èŠ‚ã€‚</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¨¡æ‹Ÿä½åˆ†è¾¨ç‡å›¾åƒç‰¹å¾å›¾ï¼Œå½¢çŠ¶ä¸º (æ‰¹é‡å¤§å°, è¾“å…¥é€šé“æ•°, é«˜åº¦, å®½åº¦)</span></span><br><span class="line">input_image = torch.randn(<span class="number">1</span>, <span class="number">3</span>, <span class="number">8</span>, <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰äºŒç»´è½¬ç½®å·ç§¯å±‚ï¼Œç”¨äºä¸Šé‡‡æ ·å›¾åƒ</span></span><br><span class="line">conv_transpose2d = nn.ConvTranspose2d(in_channels=<span class="number">3</span>, out_channels=<span class="number">3</span>, kernel_size=<span class="number">2</span>, stride=<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿›è¡Œè½¬ç½®å·ç§¯æ“ä½œ</span></span><br><span class="line">output_image = conv_transpose2d(input_image)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;è¾“å…¥å›¾åƒç‰¹å¾å›¾å½¢çŠ¶:&quot;</span>, input_image.shape)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;è¾“å‡ºå›¾åƒç‰¹å¾å›¾å½¢çŠ¶:&quot;</span>, output_image.shape)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">è¾“å…¥å›¾åƒç‰¹å¾å›¾å½¢çŠ¶: torch.Size([1, 3, 8, 8])</span><br><span class="line">è¾“å‡ºå›¾åƒç‰¹å¾å›¾å½¢çŠ¶: torch.Size([1, 3, 16, 16])</span><br></pre></td></tr></table></figure>
<ol start="5">
<li><code>nn.Conv1d/2d/3d</code> ï¼ˆè®¾ç½® <code>dilation</code>ï¼‰ç©ºæ´å·ç§¯ï¼šæ‰©å¤§æ„Ÿå—é‡</li>
</ol>
<p><code>nn.Conv1d</code>ã€<code>nn.Conv2d</code> å’Œ <code>nn.Conv3d</code> åœ¨è®¾ç½® <code>dilation</code> å‚æ•°åå¯å®ç°ç©ºæ´å·ç§¯ï¼ˆä¹Ÿå«æ‰©å¼ å·ç§¯ï¼‰ã€‚ç©ºæ´å·ç§¯æ˜¯å¯¹æ ‡å‡†å·ç§¯çš„æ‰©å±•ï¼Œé€šè¿‡åœ¨å·ç§¯æ ¸å…ƒç´ ä¹‹é—´æ’å…¥ç©ºæ´ï¼Œåœ¨ä¸å¢åŠ å‚æ•°æ•°é‡çš„æƒ…å†µä¸‹æ‰©å¤§å·ç§¯æ ¸çš„æ„Ÿå—é‡ï¼Œä½¿æ¨¡å‹èƒ½å¤Ÿæ•æ‰æ›´å¤§èŒƒå›´çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå¸¸ç”¨äºè¯­ä¹‰åˆ†å‰²ã€ç›®æ ‡æ£€æµ‹ç­‰ä»»åŠ¡ã€‚</p>
<p>åœ¨æ ‡å‡†å·ç§¯ä¸­ï¼Œå·ç§¯æ ¸çš„å…ƒç´ æ˜¯è¿ç»­æ’åˆ—çš„ï¼Œåœ¨è¾“å…¥æ•°æ®ä¸Šè¿›è¡Œæ»‘åŠ¨å·ç§¯æ“ä½œã€‚è€Œç©ºæ´å·ç§¯é€šè¿‡è®¾ç½® <code>dilation</code> å‚æ•°ï¼Œåœ¨å·ç§¯æ ¸å…ƒç´ ä¹‹é—´æ’å…¥ç©ºæ´ã€‚ä¾‹å¦‚ï¼Œå½“ <code>dilation = 2</code> æ—¶ï¼Œå·ç§¯æ ¸å…ƒç´ ä¹‹é—´ä¼šé—´éš”ä¸€ä¸ªä½ç½®ï¼Œç›¸å½“äºåœ¨æ ‡å‡†å·ç§¯æ ¸çš„åŸºç¡€ä¸Šæ¯éš”ä¸€ä¸ªå…ƒç´ è®¾ç½®ä¸ºé›¶ï¼Œç„¶åå†è¿›è¡Œå·ç§¯æ“ä½œã€‚è¿™æ ·ï¼Œå·ç§¯æ ¸åœ¨è¾“å…¥æ•°æ®ä¸Šæ»‘åŠ¨æ—¶ï¼Œèƒ½å¤Ÿè¦†ç›–æ›´å¤§çš„åŒºåŸŸï¼Œä»è€Œæ‰©å¤§äº†æ„Ÿå—é‡ã€‚</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰è¾“å…¥å¼ é‡</span></span><br><span class="line"><span class="comment"># å½¢çŠ¶ï¼š(æ‰¹é‡å¤§å°, è¾“å…¥é€šé“æ•°, é«˜åº¦, å®½åº¦)</span></span><br><span class="line">input_tensor = torch.randn(<span class="number">1</span>, <span class="number">3</span>, <span class="number">16</span>, <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰äºŒç»´ç©ºæ´å·ç§¯å±‚</span></span><br><span class="line"><span class="comment"># è®¾ç½® dilation = 2 æ¥å®ç°ç©ºæ´å·ç§¯</span></span><br><span class="line">conv2d_dilated = nn.Conv2d(in_channels=<span class="number">3</span>, out_channels=<span class="number">6</span>, kernel_size=<span class="number">3</span>, stride=<span class="number">1</span>, padding=<span class="number">1</span>, dilation=<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿›è¡Œç©ºæ´å·ç§¯æ“ä½œ</span></span><br><span class="line">output = conv2d_dilated(input_tensor)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;è¾“å…¥å¼ é‡å½¢çŠ¶:&quot;</span>, input_tensor.shape)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;è¾“å‡ºå¼ é‡å½¢çŠ¶:&quot;</span>, output.shape)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">è¾“å…¥å¼ é‡å½¢çŠ¶: torch.Size([1, 3, 16, 16])</span><br><span class="line">è¾“å‡ºå¼ é‡å½¢çŠ¶: torch.Size([1, 6, 16, 16])</span><br></pre></td></tr></table></figure>
<h6 id="å¾ªç¯ç¥ç»ç½‘ç»œå±‚">å¾ªç¯ç¥ç»ç½‘ç»œå±‚</h6>
<p>å¾ªç¯ç¥ç»ç½‘ç»œå±‚ï¼ˆRecurrent Neural Network layerï¼ŒRNN layerï¼‰æ˜¯ä¸€ç§ä¸“é—¨ç”¨äºå¤„ç†åºåˆ—æ•°æ®çš„ç¥ç»ç½‘ç»œå±‚ç»“æ„ã€‚åœ¨å¾ˆå¤šå®é™…åº”ç”¨åœºæ™¯ä¸­ï¼Œæ•°æ®å…·æœ‰åºåˆ—ç‰¹æ€§ï¼Œä¾‹å¦‚æ–‡æœ¬ï¼ˆç”±å•è¯æŒ‰é¡ºåºç»„æˆï¼‰ã€è¯­éŸ³ï¼ˆéŸ³é¢‘ä¿¡å·éšæ—¶é—´å˜åŒ–ï¼‰ã€æ—¶é—´åºåˆ—æ•°æ®ï¼ˆå¦‚è‚¡ç¥¨ä»·æ ¼éšæ—¶é—´çš„æ³¢åŠ¨ï¼‰ç­‰ã€‚ä¸ä¼ ç»Ÿçš„å‰é¦ˆç¥ç»ç½‘ç»œä¸åŒï¼Œå¾ªç¯ç¥ç»ç½‘ç»œå±‚å¼•å…¥äº†å¾ªç¯ç»“æ„ï¼Œä½¿å¾—ç½‘ç»œèƒ½å¤Ÿåœ¨å¤„ç†åºåˆ—æ•°æ®æ—¶ä¿ç•™ä¹‹å‰æ—¶é—´æ­¥çš„ä¿¡æ¯ï¼Œä»è€Œæ›´å¥½åœ°æ•æ‰åºåˆ—ä¸­çš„ä¸Šä¸‹æ–‡å…³ç³»å’Œæ—¶é—´ä¾èµ–ã€‚</p>
<p>RNNã€LSTM å’Œ GRU éƒ½å±äºå¾ªç¯ç¥ç»ç½‘ç»œå±‚çš„èŒƒç•´ï¼Œå®ƒä»¬åœ¨å¤„ç†åºåˆ—æ•°æ®æ—¶å„æœ‰ç‰¹ç‚¹ã€‚ç®€å• RNN ç»“æ„ç®€å•ä½†å­˜åœ¨æ¢¯åº¦é—®é¢˜ï¼›LSTM é€šè¿‡é—¨æ§æœºåˆ¶è§£å†³äº†æ¢¯åº¦é—®é¢˜ä½†è®¡ç®—å¤æ‚ï¼›GRU åˆ™åœ¨æ€§èƒ½å’Œè®¡ç®—æ•ˆç‡ä¹‹é—´å–å¾—äº†è¾ƒå¥½çš„å¹³è¡¡ã€‚æ ¹æ®ä¸åŒçš„åº”ç”¨åœºæ™¯å’Œæ•°æ®ç‰¹ç‚¹ï¼Œå¯ä»¥é€‰æ‹©åˆé€‚çš„å¾ªç¯ç¥ç»ç½‘ç»œå±‚æ¥æ„å»ºæ¨¡å‹ã€‚</p>
<p>1.<code>nn.RNN</code> RNNï¼šåŸºç¡€å¾ªç¯ç½‘ç»œ</p>
<p><code>nn.RNN</code> æ˜¯ PyTorch ä¸­ç”¨äºæ„å»ºåŸºç¡€å¾ªç¯ç¥ç»ç½‘ç»œï¼ˆRecurrent Neural Networkï¼ŒRNNï¼‰çš„æ¨¡å—ã€‚RNN æ˜¯ä¸€ç§ä¸“é—¨å¤„ç†åºåˆ—æ•°æ®çš„ç¥ç»ç½‘ç»œï¼Œå®ƒé€šè¿‡åœ¨ç½‘ç»œä¸­å¼•å…¥å¾ªç¯ç»“æ„ï¼Œä½¿å¾—ç½‘ç»œèƒ½å¤Ÿä¿å­˜å’Œåˆ©ç”¨ä¹‹å‰æ—¶é—´æ­¥çš„ä¿¡æ¯ï¼Œä»è€Œå¯¹åºåˆ—ä¸­çš„æ—¶é—´ä¾èµ–å…³ç³»è¿›è¡Œå»ºæ¨¡ã€‚ä¸è¿‡ï¼ŒRNN å­˜åœ¨æ¢¯åº¦æ¶ˆå¤±æˆ–æ¢¯åº¦çˆ†ç‚¸é—®é¢˜ï¼Œåœ¨å¤„ç†é•¿åºåˆ—æ—¶è¡¨ç°ä¸ä½³ã€‚</p>
<p>åœ¨æ¯ä¸ªæ—¶é—´æ­¥ ï¼ŒRNN æ¥æ”¶å½“å‰è¾“å…¥$x_t$å’Œä¸Šä¸€ä¸ªæ—¶é—´æ­¥çš„éšè—çŠ¶æ€$h_{t-1}$ï¼Œé€šè¿‡ä»¥ä¸‹å…¬å¼è®¡ç®—å½“å‰æ—¶é—´æ­¥çš„éšè—çŠ¶æ€$h_t$ï¼š</p>
<p>$h_t=tanh(W_{ih}x_t+W_{hh}h_{t-1}+b_h)$</p>
<p>å…¶ä¸­$W_{ih}$æ˜¯è¾“å…¥åˆ°éšè—çŠ¶æ€çš„æƒé‡çŸ©é˜µï¼Œ$W_{hh}$æ˜¯éšè—çŠ¶æ€åˆ°éšè—çŠ¶æ€çš„æƒé‡çŸ©é˜µï¼Œ$b_h$æ˜¯åç½®ï¼Œ$tanh$æ˜¯æ¿€æ´»å‡½æ•°ï¼Œç”¨äºå¼•å…¥éçº¿æ€§ã€‚</p>
<p><strong>è‡ªç„¶è¯­è¨€å¤„ç†</strong>ï¼šå¦‚æ–‡æœ¬åˆ†ç±»ä»»åŠ¡ï¼Œå°†ä¸€æ®µæ–‡æœ¬çœ‹ä½œä¸€ä¸ªè¯åºåˆ—ï¼ŒRNN å¯ä»¥å¯¹æ–‡æœ¬ä¸­çš„è¯­ä¹‰ä¿¡æ¯è¿›è¡Œå»ºæ¨¡ï¼Œæ ¹æ®ä¹‹å‰çš„è¯æ¥é¢„æµ‹å½“å‰è¯çš„ç±»åˆ«æ¦‚ç‡ï¼›è¿˜å¯ç”¨äºè¯­è¨€ç”Ÿæˆï¼Œä¾‹å¦‚ç”Ÿæˆè¯—æ­Œã€æ•…äº‹ç­‰ï¼Œé€šè¿‡ä¸æ–­æ ¹æ®ä¹‹å‰ç”Ÿæˆçš„è¯æ¥é¢„æµ‹ä¸‹ä¸€ä¸ªè¯ã€‚</p>
<p><strong>æ—¶é—´åºåˆ—é¢„æµ‹</strong>ï¼šåƒè‚¡ç¥¨ä»·æ ¼é¢„æµ‹ã€å¤©æ°”é¢„æŠ¥ç­‰ï¼ŒæŠŠæ—¶é—´åºåˆ—æ•°æ®ï¼ˆå¦‚æ¯å¤©çš„è‚¡ç¥¨ä»·æ ¼ã€æ¯å°æ—¶çš„æ°”æ¸©ï¼‰ä½œä¸ºè¾“å…¥ï¼ŒRNN å¯ä»¥å­¦ä¹ åˆ°åºåˆ—ä¸­çš„è¶‹åŠ¿å’Œæ¨¡å¼ï¼Œä»è€Œé¢„æµ‹æœªæ¥çš„å€¼ã€‚</p>
<p><strong>è¯­éŸ³è¯†åˆ«</strong>ï¼šè¯­éŸ³ä¿¡å·æ˜¯éšæ—¶é—´å˜åŒ–çš„åºåˆ—ï¼ŒRNN å¯ä»¥å¤„ç†è¯­éŸ³ç‰¹å¾åºåˆ—ï¼Œæ ¹æ®ä¹‹å‰çš„è¯­éŸ³å¸§ä¿¡æ¯æ¥è¯†åˆ«å½“å‰å¸§å¯¹åº”çš„è¯­éŸ³å†…å®¹ã€‚</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰è¾“å…¥å‚æ•°</span></span><br><span class="line">input_size = <span class="number">10</span>  <span class="comment"># è¾“å…¥ç‰¹å¾ç»´åº¦</span></span><br><span class="line">hidden_size = <span class="number">20</span>  <span class="comment"># éšè—çŠ¶æ€ç»´åº¦</span></span><br><span class="line">num_layers = <span class="number">1</span>  <span class="comment"># RNN å±‚æ•°</span></span><br><span class="line">batch_size = <span class="number">32</span>  <span class="comment"># æ‰¹é‡å¤§å°</span></span><br><span class="line">seq_len = <span class="number">5</span>  <span class="comment"># åºåˆ—é•¿åº¦</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»º RNN å±‚</span></span><br><span class="line">rnn = nn.RNN(input_size, hidden_size, num_layers, batch_first=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”Ÿæˆéšæœºè¾“å…¥æ•°æ®</span></span><br><span class="line">input_data = torch.randn(batch_size, seq_len, input_size)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆå§‹åŒ–éšè—çŠ¶æ€</span></span><br><span class="line">h_0 = torch.randn(num_layers, batch_size, hidden_size)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿›è¡Œå‰å‘ä¼ æ’­</span></span><br><span class="line">output, h_n = rnn(input_data, h_0)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;è¾“å…¥æ•°æ®å½¢çŠ¶:&quot;</span>, input_data.shape)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;è¾“å‡ºå½¢çŠ¶:&quot;</span>, output.shape)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;æœ€ç»ˆéšè—çŠ¶æ€å½¢çŠ¶:&quot;</span>, h_n.shape)</span><br></pre></td></tr></table></figure>
<p>è¾“å…¥æ•°æ® <code>input_data</code> æ˜¯ä¸€ä¸ªä¸‰ç»´å¼ é‡ï¼Œå½“ <code>batch_first = True</code> æ—¶ï¼Œå½¢çŠ¶ä¸º <code>(batch_size, seq_len, input_size)</code>ï¼Œè¡¨ç¤ºæ‰¹é‡å¤§å°ä¸º 32ï¼Œåºåˆ—é•¿åº¦ä¸º 5ï¼Œæ¯ä¸ªæ—¶é—´æ­¥çš„è¾“å…¥ç‰¹å¾ç»´åº¦ä¸º 10ã€‚</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">input_data = torch.randn(batch_size, seq_len, input_size)</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨ <code>nn.RNN</code> åˆ›å»º RNN å±‚ï¼Œè®¾ç½®è¾“å…¥ç‰¹å¾ç»´åº¦ã€éšè—çŠ¶æ€ç»´åº¦å’Œå±‚æ•°ç­‰å‚æ•°ã€‚</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">rnn = nn.RNN(input_size, hidden_size, num_layers, batch_first=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<p>åˆå§‹åŒ–éšè—çŠ¶æ€ <code>h_0</code>ï¼Œå½¢çŠ¶ä¸º <code>(num_layers, batch_size, hidden_size)</code>ã€‚</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">h_0 = torch.randn(num_layers, batch_size, hidden_size)</span><br></pre></td></tr></table></figure>
<p>è°ƒç”¨ <code>rnn</code> è¿›è¡Œå‰å‘ä¼ æ’­ï¼Œå¾—åˆ°è¾“å‡º <code>output</code> å’Œæœ€ç»ˆéšè—çŠ¶æ€ <code>h_n</code>ã€‚è¾“å‡º <code>output</code> åŒ…å«æ¯ä¸ªæ—¶é—´æ­¥çš„éšè—çŠ¶æ€ï¼Œå½¢çŠ¶ä¸º <code>(batch_size, seq_len, hidden_size)</code>ï¼›æœ€ç»ˆéšè—çŠ¶æ€ <code>h_n</code> æ˜¯æœ€åä¸€ä¸ªæ—¶é—´æ­¥çš„éšè—çŠ¶æ€ï¼Œå½¢çŠ¶ä¸º <code>(num_layers, batch_size, hidden_size)</code>ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">è¾“å…¥æ•°æ®å½¢çŠ¶: torch.Size([32, 5, 10])</span><br><span class="line">è¾“å‡ºå½¢çŠ¶: torch.Size([32, 5, 20])</span><br><span class="line">æœ€ç»ˆéšè—çŠ¶æ€å½¢çŠ¶: torch.Size([1, 32, 20])</span><br></pre></td></tr></table></figure>
<p>2.<code>nn.LSTM</code> LSTMï¼šé•¿çŸ­æœŸè®°å¿†ç½‘ç»œ</p>
<p><code>nn.LSTM</code> æ˜¯ PyTorch ä¸­ç”¨äºæ„å»ºé•¿çŸ­æœŸè®°å¿†ç½‘ç»œï¼ˆLong Short - Term Memoryï¼ŒLSTMï¼‰çš„æ¨¡å—ã€‚LSTM æ˜¯ä¸€ç§ç‰¹æ®Šçš„å¾ªç¯ç¥ç»ç½‘ç»œï¼ˆRNNï¼‰ï¼Œæ—¨åœ¨è§£å†³ä¼ ç»Ÿ RNN åœ¨å¤„ç†é•¿åºåˆ—æ—¶é‡åˆ°çš„æ¢¯åº¦æ¶ˆå¤±æˆ–æ¢¯åº¦çˆ†ç‚¸é—®é¢˜ã€‚å®ƒé€šè¿‡å¼•å…¥é—¨æ§æœºåˆ¶ï¼ˆè¾“å…¥é—¨ã€é—å¿˜é—¨å’Œè¾“å‡ºé—¨ï¼‰ï¼Œèƒ½å¤Ÿæœ‰æ•ˆåœ°æ•æ‰åºåˆ—ä¸­çš„é•¿è·ç¦»ä¾èµ–å…³ç³»ï¼Œåœ¨å¤„ç†è‡ªç„¶è¯­è¨€å¤„ç†ã€æ—¶é—´åºåˆ—åˆ†æç­‰åºåˆ—æ•°æ®ä»»åŠ¡ä¸­è¡¨ç°å‡ºè‰²ã€‚</p>
<blockquote>
<p><mark>æ¢¯åº¦æ¶ˆå¤±ä¸æ¢¯åº¦çˆ†ç‚¸</mark></p>
<p>1.æ¢¯åº¦æ¶ˆå¤±</p>
<p>åœ¨ç¥ç»ç½‘ç»œè®­ç»ƒä¸­ï¼Œä½¿ç”¨åå‘ä¼ æ’­ç®—æ³•æ›´æ–°å‚æ•°æ—¶ï¼Œæ¢¯åº¦ä¼šä»è¾“å‡ºå±‚å‘è¾“å…¥å±‚é€å±‚ä¼ é€’ã€‚æ¢¯åº¦æ¶ˆå¤±æŒ‡çš„æ˜¯åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæ¢¯åº¦å€¼å˜å¾—è¶Šæ¥è¶Šå°ï¼Œè¶‹è¿‘äºé›¶ã€‚</p>
<p>ä¼ ç»Ÿ RNN åœ¨è®¡ç®—æ¢¯åº¦æ—¶æ¶‰åŠå¤šä¸ªæƒé‡çŸ©é˜µçš„è¿ä¹˜ï¼Œè‹¥æƒé‡çŸ©é˜µçš„å…ƒç´ å€¼è¾ƒå°ï¼Œç»è¿‡å¤šæ¬¡è¿ä¹˜åæ¢¯åº¦ä¼šæ€¥å‰§å‡å°ã€‚æ¿€æ´»å‡½æ•°ï¼ˆå¦‚ Sigmoidã€Tanhï¼‰çš„å¯¼æ•°å–å€¼èŒƒå›´åœ¨ 0 åˆ° 1 ä¹‹é—´ï¼Œå¤šæ¬¡ä½¿ç”¨è¿™ç±»æ¿€æ´»å‡½æ•°ä¹Ÿä¼šä½¿æ¢¯åº¦é€æ¸å˜å°ã€‚</p>
<p>ç”±äºæ¢¯åº¦æå°ï¼Œæ¨¡å‹å‚æ•°çš„æ›´æ–°å¹…åº¦å˜å¾—éå¸¸å°ï¼Œå‡ ä¹ä¸å†æ›´æ–°ï¼Œå¯¼è‡´ç½‘ç»œæ— æ³•å­¦ä¹ åˆ°é•¿åºåˆ—ä¸­çš„è¿œè·ç¦»ä¾èµ–ä¿¡æ¯ï¼Œéš¾ä»¥æ”¶æ•›åˆ°æœ€ä¼˜è§£ã€‚</p>
<p>2.æ¢¯åº¦çˆ†ç‚¸</p>
<p>ä¸æ¢¯åº¦æ¶ˆå¤±ç›¸åï¼Œæ¢¯åº¦çˆ†ç‚¸æ˜¯æŒ‡åœ¨åå‘ä¼ æ’­è¿‡ç¨‹ä¸­ï¼Œæ¢¯åº¦å€¼å˜å¾—è¶Šæ¥è¶Šå¤§ï¼Œå¤±å»æ§åˆ¶ã€‚</p>
<p>åŒæ ·æ˜¯å› ä¸ºå¤šä¸ªæƒé‡çŸ©é˜µçš„è¿ä¹˜ï¼Œè‹¥æƒé‡çŸ©é˜µçš„å…ƒç´ å€¼è¾ƒå¤§ï¼Œè¿ä¹˜åæ¢¯åº¦ä¼šæ€¥å‰§å¢å¤§ã€‚ç½‘ç»œå±‚æ•°è¿‡æ·±ã€å­¦ä¹ ç‡è®¾ç½®è¿‡å¤§ç­‰ä¹Ÿå¯èƒ½å¼•å‘æ¢¯åº¦çˆ†ç‚¸ã€‚</p>
<p>è¿‡å¤§çš„æ¢¯åº¦ä¼šä½¿æ¨¡å‹å‚æ•°æ›´æ–°å¹…åº¦è¿‡å¤§ï¼Œå¯¼è‡´å‚æ•°å€¼å‰§çƒˆæ³¢åŠ¨ï¼Œæ¨¡å‹æ— æ³•ç¨³å®šè®­ç»ƒï¼Œç”šè‡³å¯èƒ½ä½¿è®­ç»ƒè¿‡ç¨‹å‘æ•£ã€‚</p>
<hr>
<p>LSTM é€šè¿‡å¼•å…¥é—¨æ§æœºåˆ¶ï¼Œèƒ½å¤Ÿæœ‰æ•ˆåœ°ç¼“è§£æ¢¯åº¦æ¶ˆå¤±å’Œæ¢¯åº¦çˆ†ç‚¸é—®é¢˜ï¼Œä½¿å¾—ç½‘ç»œåœ¨å¤„ç†é•¿åºåˆ—æ•°æ®æ—¶å¯ä»¥æ›´å¥½åœ°ä¿ç•™å’Œä¼ é€’ä¿¡æ¯ã€‚</p>
<hr>
<p>ä¼ ç»Ÿ RNN æ˜“å‡ºç°æ¢¯åº¦æ¶ˆå¤±æˆ–çˆ†ç‚¸ï¼Œå› ä¸ºåå‘ä¼ æ’­æ—¶æ¢¯åº¦ç»å¤šæ—¶é—´æ­¥è¿ä¹˜ï¼Œå€¼è¦ä¹ˆè¶‹äºé›¶ã€è¦ä¹ˆæ— é™åˆ¶å¢å¤§ã€‚è€Œé—¨æ§æœºåˆ¶å¯å°†æ¢¯åº¦é™åˆ¶åœ¨ä¸€å®šåŒºé—´ã€‚</p>
<p>ä»¥ LSTM ä¸ºä¾‹ï¼Œé—å¿˜é—¨ç”¨sigmoidå‡½æ•°è¾“å‡º$[0,1]$çš„å€¼ï¼Œå†³å®šä¸Šä¸€æ—¶åˆ»ç»†èƒçŠ¶æ€ä¿¡æ¯çš„ä¿ç•™ç¨‹åº¦ã€‚æ¥è¿‘1æ—¶æ¢¯åº¦é¡ºç•…ä¼ é€’ï¼Œé¿å…æ¶ˆå¤±ï¼›æ¥è¿‘0æ—¶åˆ‡æ–­éƒ¨åˆ†ä¼ é€’è·¯å¾„ï¼Œé˜²æ­¢çˆ†ç‚¸ã€‚</p>
<p>è¾“å…¥é—¨åŒç†æ§åˆ¶å½“å‰è¾“å…¥ä¿¡æ¯çš„æ·»åŠ æ¯”ä¾‹ï¼Œå’Œé—å¿˜é—¨ååŒè®©ç»†èƒçŠ¶æ€æ¸è¿›æ›´æ–°ã€‚è¿™ç§å¹³ç¨³çš„ä¿¡æ¯ä¼ é€’ä½¿æ¢¯åº¦ä¹Ÿç¨³å®šï¼Œä¸ä¼šå‰§çƒˆæ³¢åŠ¨ã€‚</p>
<p>è¾“å‡ºé—¨å¯¹ç»†èƒçŠ¶æ€è¾“å‡ºä¿¡æ¯ç¼©æ”¾ï¼Œæ§åˆ¶ä»éšè—çŠ¶æ€åˆ°ç»†èƒçŠ¶æ€çš„æ¢¯åº¦ä¼ é€’ï¼Œé¿å…ç»†èƒçŠ¶æ€æ¢¯åº¦è¿‡åº¦å½±å“éšè—çŠ¶æ€æ›´æ–°ï¼Œè¿›ä¸€æ­¥ç¨³å®šæ¢¯åº¦ã€‚</p>
</blockquote>
<p>LSTM çš„æ ¸å¿ƒåœ¨äºå…¶é—¨æ§æœºåˆ¶ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š</p>
<p><strong>é—å¿˜é—¨ï¼ˆForget Gateï¼‰</strong>ï¼šå†³å®šä¸Šä¸€ä¸ªæ—¶é—´æ­¥çš„ç»†èƒçŠ¶æ€$C_{t-1}$ä¸­å“ªäº›ä¿¡æ¯éœ€è¦è¢«é—å¿˜ã€‚è®¡ç®—å…¬å¼ä¸º$f_t=\sigma(W_f[h_{t-1}.x_t]+b_f)$ï¼Œå…¶ä¸­$\sigma$æ˜¯sigmoidå‡½æ•°ï¼Œ $W_f$æ˜¯é—å¿˜é—¨çš„æƒé‡çŸ©é˜µï¼Œ$b_f$æ˜¯åç½®ï¼Œ$[h_{t-1},x_t]$è¡¨ç¤ºå°†ä¸Šä¸€ä¸ªæ—¶é—´æ­¥çš„éšè—çŠ¶æ€$h_{t-1}$å’Œå½“å‰è¾“å…¥$x_t$æ‹¼æ¥èµ·æ¥ã€‚</p>
<p><strong>è¾“å…¥é—¨ï¼ˆInput Gateï¼‰</strong>ï¼šå†³å®šå½“å‰è¾“å…¥$x_t$ä¸­å“ªäº›ä¿¡æ¯éœ€è¦è¢«æ·»åŠ åˆ°ç»†èƒçŠ¶æ€ä¸­ã€‚é¦–å…ˆè®¡ç®—$i_t=\sigma(W_i[h_{t-1},x_t]+b_i)$ï¼ŒåŒæ—¶è®¡ç®—å€™é€‰ç»†èƒçŠ¶æ€$\widetilde{C_t}=tanh(W_C[h_{t-1},x_t]+b_C)$ã€‚ï¼ˆæ³¢æµªçº¿è¯»ä½œtildeï¼‰</p>
<p><strong>ç»†èƒçŠ¶æ€æ›´æ–°</strong>ï¼šæ ¹æ®é—å¿˜é—¨å’Œè¾“å…¥é—¨çš„è¾“å‡ºæ›´æ–°ç»†èƒçŠ¶æ€$C_t=f_{t}\odot C_{t-1}+i_t\odot \widetilde{C_t}$ï¼Œå…¶ä¸­$\odot$è¡¨ç¤ºé€å…ƒç´ ç›¸ä¹˜ã€‚</p>
<p><strong>è¾“å‡ºé—¨ï¼ˆOutput Gateï¼‰</strong>ï¼šå†³å®šå½“å‰ç»†èƒçŠ¶æ€$C_t$ä¸­å“ªäº›ä¿¡æ¯éœ€è¦è¢«è¾“å‡ºä½œä¸ºå½“å‰æ—¶é—´æ­¥çš„éšè—çŠ¶æ€$h_t$ã€‚è®¡ç®—å…¬å¼ä¸º$o_t=\sigma(W_o[h_{t-1},x_t]+b_o)$ï¼Œ$h_t=o_t\odot tanh(C_t)$ã€‚</p>
<blockquote>
<p><mark>éšè—çŠ¶æ€</mark>ï¼ˆå¯ç†è§£ä¸ºä¸€ä¸ªä¸­é—´å˜é‡æˆ–çŠ¶æ€å€¼ï¼‰</p>
<p>æ˜¯ç½‘ç»œåœ¨å¤„ç†åºåˆ—æ•°æ®æ—¶ï¼Œæ¯ä¸ªæ—¶é—´æ­¥æ‰€ç»´æŠ¤çš„ä¸€ç§å†…éƒ¨è¡¨ç¤ºã€‚å¯ä»¥å°†å…¶ç†è§£ä¸ºç½‘ç»œå¯¹ä¹‹å‰è¾“å…¥ä¿¡æ¯çš„ä¸€ç§ â€œè®°å¿†â€ å’Œ â€œæ€»ç»“â€ï¼Œéšç€æ—¶é—´æ­¥æ¨è¿›ä¸æ–­æ›´æ–°ã€‚</p>
<p>éšè—çŠ¶æ€æ•´åˆäº†å†å²è¾“å…¥ä¿¡æ¯å’Œå½“å‰è¾“å…¥ä¿¡æ¯ï¼Œèƒ½åæ˜ åºåˆ—çš„ä¸Šä¸‹æ–‡å…³ç³»ã€‚ä»¥è‡ªç„¶è¯­è¨€å¤„ç†ä¸­çš„æ–‡æœ¬åºåˆ—ä¸ºä¾‹ï¼Œéšè—çŠ¶æ€å¯ä»¥æ•æ‰åˆ°å‰é¢å•è¯çš„è¯­ä¹‰ã€è¯­æ³•ç­‰ä¿¡æ¯ï¼Œå¹¶ç»“åˆå½“å‰å•è¯è¿›ä¸€æ­¥æ›´æ–°ï¼Œè¾…åŠ©ç½‘ç»œåšå‡ºæ›´å‡†ç¡®çš„å†³ç­–ï¼Œå¦‚é¢„æµ‹ä¸‹ä¸€ä¸ªå•è¯ã€è¿›è¡Œæƒ…æ„Ÿåˆ†æç­‰ã€‚</p>
<p>åœ¨ LSTM é‡Œï¼Œè¾“å‡ºé—¨ä¼šå¯¹ç»†èƒçŠ¶æ€è¿›è¡Œç­›é€‰å’Œå¤„ç†ï¼Œç”Ÿæˆéšè—çŠ¶æ€ã€‚éšè—çŠ¶æ€ä¸ä»…å¯ä½œä¸ºå½“å‰æ—¶é—´æ­¥çš„è¾“å‡ºï¼Œè¿˜ä¼šä½œä¸ºä¸‹ä¸€ä¸ªæ—¶é—´æ­¥çš„è¾“å…¥ï¼Œå‚ä¸åç»­è®¡ç®—ï¼ŒæŒç»­åœ¨åºåˆ—å¤„ç†è¿‡ç¨‹ä¸­ä¼ é€’å’Œæ›´æ–°ä¿¡æ¯ï¼Œæ¨åŠ¨ç½‘ç»œä¸æ–­å­¦ä¹ åºåˆ—ä¸­çš„æ¨¡å¼å’Œè§„å¾‹ã€‚</p>
</blockquote>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰è¾“å…¥å‚æ•°</span></span><br><span class="line">input_size = <span class="number">10</span>  <span class="comment"># è¾“å…¥ç‰¹å¾ç»´åº¦</span></span><br><span class="line">hidden_size = <span class="number">20</span>  <span class="comment"># éšè—çŠ¶æ€ç»´åº¦</span></span><br><span class="line">num_layers = <span class="number">1</span>  <span class="comment"># LSTM å±‚æ•°</span></span><br><span class="line">batch_size = <span class="number">32</span>  <span class="comment"># æ‰¹é‡å¤§å°</span></span><br><span class="line">seq_len = <span class="number">5</span>  <span class="comment"># åºåˆ—é•¿åº¦</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»º LSTM å±‚</span></span><br><span class="line">lstm = nn.LSTM(input_size, hidden_size, num_layers, batch_first=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”Ÿæˆéšæœºè¾“å…¥æ•°æ®</span></span><br><span class="line">input_data = torch.randn(batch_size, seq_len, input_size)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆå§‹åŒ–éšè—çŠ¶æ€å’Œç»†èƒçŠ¶æ€</span></span><br><span class="line">h_0 = torch.randn(num_layers, batch_size, hidden_size)</span><br><span class="line">c_0 = torch.randn(num_layers, batch_size, hidden_size)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿›è¡Œå‰å‘ä¼ æ’­</span></span><br><span class="line">output, (h_n, c_n) = lstm(input_data, (h_0, c_0))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;è¾“å…¥æ•°æ®å½¢çŠ¶:&quot;</span>, input_data.shape)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;è¾“å‡ºå½¢çŠ¶:&quot;</span>, output.shape)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;æœ€ç»ˆéšè—çŠ¶æ€å½¢çŠ¶:&quot;</span>, h_n.shape)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;æœ€ç»ˆç»†èƒçŠ¶æ€å½¢çŠ¶:&quot;</span>, c_n.shape)</span><br></pre></td></tr></table></figure>
<p><strong>å…³é”®å‚æ•°</strong></p>
<ul>
<li><strong><code>input_size</code></strong>ï¼šè¾“å…¥ç‰¹å¾çš„ç»´åº¦ï¼Œå³æ¯ä¸ªæ—¶é—´æ­¥è¾“å…¥å‘é‡çš„é•¿åº¦ã€‚</li>
<li><strong><code>hidden_size</code></strong>ï¼šéšè—çŠ¶æ€å’Œç»†èƒçŠ¶æ€çš„ç»´åº¦ï¼Œå†³å®šäº† LSTM èƒ½å¤Ÿå­¦ä¹ å’Œè¡¨ç¤ºçš„ä¿¡æ¯é‡ã€‚</li>
<li><strong><code>num_layers</code></strong>ï¼šLSTM çš„å±‚æ•°ï¼Œå¤šå±‚ LSTM å¯ä»¥å­¦ä¹ åˆ°æ›´å¤æ‚çš„åºåˆ—æ¨¡å¼ã€‚</li>
<li><strong><code>bias</code></strong>ï¼šæ˜¯å¦ä½¿ç”¨åç½®ï¼Œé»˜è®¤ä¸º <code>True</code>ã€‚</li>
<li><strong><code>batch_first</code></strong>ï¼šå¦‚æœä¸º <code>True</code>ï¼Œè¾“å…¥å’Œè¾“å‡ºå¼ é‡çš„å½¢çŠ¶ä¸º <code>(batch_size, seq_len, input_size)</code>ï¼Œå¦åˆ™ä¸º <code>(seq_len, batch_size, input_size)</code>ï¼Œé»˜è®¤ä¸º <code>False</code>ã€‚</li>
<li><strong><code>dropout</code></strong>ï¼šå¦‚æœéé›¶ï¼Œåˆ™åœ¨é™¤æœ€åä¸€å±‚å¤–çš„æ¯ä¸€å±‚çš„è¾“å‡ºä¸Šåº”ç”¨ Dropoutï¼Œé˜²æ­¢è¿‡æ‹Ÿåˆï¼Œå–å€¼èŒƒå›´ä¸º <code>[0, 1)</code>ã€‚</li>
<li><strong><code>bidirectional</code></strong>ï¼šå¦‚æœä¸º <code>True</code>ï¼Œåˆ™ä½¿ç”¨åŒå‘ LSTMï¼Œèƒ½å¤ŸåŒæ—¶è€ƒè™‘åºåˆ—çš„æ­£å‘å’Œåå‘ä¿¡æ¯ï¼Œé»˜è®¤ä¸º <code>False</code>ã€‚</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">è¾“å…¥æ•°æ®å½¢çŠ¶: torch.Size([32, 5, 10])</span><br><span class="line">è¾“å‡ºå½¢çŠ¶: torch.Size([32, 5, 20])</span><br><span class="line">æœ€ç»ˆéšè—çŠ¶æ€å½¢çŠ¶: torch.Size([1, 32, 20])</span><br><span class="line">æœ€ç»ˆç»†èƒçŠ¶æ€å½¢çŠ¶: torch.Size([1, 32, 20])</span><br></pre></td></tr></table></figure>
<p>3.<code>nn.GRU</code> GRUï¼šé—¨æ§å¾ªç¯å•å…ƒ</p>
<p><code>nn.GRU</code> æ˜¯ PyTorch é‡Œç”¨äºæ„å»ºé—¨æ§å¾ªç¯å•å…ƒï¼ˆGated Recurrent Unitï¼ŒGRUï¼‰çš„æ¨¡å—ã€‚GRU æ˜¯å¾ªç¯ç¥ç»ç½‘ç»œï¼ˆRNNï¼‰çš„ä¸€ç§å˜ä½“ï¼Œå®ƒå’Œé•¿çŸ­æœŸè®°å¿†ç½‘ç»œï¼ˆLSTMï¼‰ç±»ä¼¼ï¼Œæ—¨åœ¨è§£å†³ä¼ ç»Ÿ RNN å¤„ç†é•¿åºåˆ—æ—¶çš„æ¢¯åº¦æ¶ˆå¤±é—®é¢˜ã€‚GRU é€šè¿‡ç®€åŒ– LSTM çš„é—¨æ§æœºåˆ¶ï¼Œåªä½¿ç”¨é‡ç½®é—¨å’Œæ›´æ–°é—¨ï¼Œåœ¨ä¿æŒå¯¹é•¿è·ç¦»ä¾èµ–å…³ç³»å»ºæ¨¡èƒ½åŠ›çš„åŒæ—¶ï¼Œå‡å°‘äº†å‚æ•°æ•°é‡ï¼Œé™ä½äº†è®¡ç®—å¤æ‚åº¦ï¼Œä»è€Œæé«˜äº†è®­ç»ƒå’Œæ¨ç†é€Ÿåº¦ã€‚</p>
<h6 id="Transformer-ç›¸å…³å±‚">Transformer ç›¸å…³å±‚</h6>
<blockquote>
<p><mark>â“ä»€ä¹ˆæ˜¯Transformer?</mark></p>
<p>Transformer æ˜¯ 2017 å¹´åœ¨è®ºæ–‡ã€ŠAttention Is All You Needã€‹ä¸­æå‡ºçš„ä¸€ç§åŸºäºæ³¨æ„åŠ›æœºåˆ¶çš„æ·±åº¦å­¦ä¹ æ¨¡å‹æ¶æ„ï¼Œç”¨äºå¤„ç†åºåˆ—æ•°æ®ï¼Œå°¤å…¶åœ¨è‡ªç„¶è¯­è¨€å¤„ç†é¢†åŸŸè¡¨ç°å“è¶Šã€‚å®ƒæ‘’å¼ƒäº†ä¼ ç»Ÿçš„å¾ªç¯ç»“æ„ï¼ˆå¦‚ RNNã€LSTMï¼‰ï¼Œå®Œå…¨åŸºäºæ³¨æ„åŠ›æœºåˆ¶æ„å»ºï¼Œèƒ½å¤Ÿå¹¶è¡Œå¤„ç†è¾“å…¥åºåˆ—ï¼Œæå‡äº†è®­ç»ƒå’Œæ¨ç†é€Ÿåº¦ã€‚</p>
<p><mark>â“Transformer æ˜¯å·¨å¤§è¿›æ­¥çš„åŸå› </mark></p>
<p>1.è§£å†³é•¿åºåˆ—ä¾èµ–é—®é¢˜</p>
<p>ä¼ ç»Ÿ RNN åŠå…¶å˜ä½“ï¼ˆå¦‚ LSTMã€GRUï¼‰åœ¨å¤„ç†é•¿åºåˆ—æ—¶ï¼Œç”±äºä¿¡æ¯ä¼ é€’éœ€æŒ‰é¡ºåºè¿›è¡Œï¼Œå­˜åœ¨æ¢¯åº¦æ¶ˆå¤±æˆ–çˆ†ç‚¸é—®é¢˜ï¼Œéš¾ä»¥æ•æ‰é•¿è·ç¦»ä¾èµ–å…³ç³»ã€‚è€Œ Transformer çš„æ³¨æ„åŠ›æœºåˆ¶èƒ½è®©æ¨¡å‹åœ¨å¤„ç†æŸä¸ªä½ç½®çš„è¾“å…¥æ—¶ï¼Œç›´æ¥å…³æ³¨åˆ°åºåˆ—ä¸­å…¶ä»–ä»»æ„ä½ç½®çš„ä¿¡æ¯ï¼Œæœ‰æ•ˆè§£å†³äº†é•¿åºåˆ—ä¾èµ–é—®é¢˜ï¼Œæ›´å¥½åœ°ç†è§£ä¸Šä¸‹æ–‡ã€‚</p>
<p>2.å¹¶è¡Œè®¡ç®—èƒ½åŠ›</p>
<p>RNN ç³»åˆ—æ¨¡å‹æŒ‰æ—¶é—´æ­¥é¡ºåºå¤„ç†åºåˆ—ï¼Œæ— æ³•å¹¶è¡Œè®¡ç®—ï¼Œæ•ˆç‡è¾ƒä½ã€‚Transformer å¯ä»¥åŒæ—¶å¤„ç†æ•´ä¸ªè¾“å…¥åºåˆ—ï¼Œé€šè¿‡å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶å¹¶è¡Œè®¡ç®—ä¸åŒå­ç©ºé—´çš„æ³¨æ„åŠ›æƒé‡ï¼Œå¤§å¤§æé«˜äº†è®­ç»ƒå’Œæ¨ç†é€Ÿåº¦ï¼Œèƒ½åœ¨æ›´çŸ­æ—¶é—´å†…å¤„ç†å¤§è§„æ¨¡æ•°æ®ã€‚</p>
<p>3.æ¨¡å‹æ‰©å±•æ€§å¼º</p>
<p>Transformer æ¶æ„æ¸…æ™°ï¼Œå„ä¸ªç»„ä»¶ï¼ˆå¦‚å¤šå¤´æ³¨æ„åŠ›å±‚ã€å‰é¦ˆç½‘ç»œå±‚ï¼‰æ˜“äºç†è§£å’Œè°ƒæ•´ã€‚å¯ä»¥é€šè¿‡å †å æ›´å¤šå±‚æˆ–å¢åŠ éšè—å•å…ƒæ•°é‡ç­‰æ–¹å¼ï¼Œæ–¹ä¾¿åœ°æ‰©å¤§æ¨¡å‹è§„æ¨¡ï¼Œä»¥é€‚åº”ä¸åŒçš„ä»»åŠ¡å’Œæ•°æ®é‡ï¼Œä»è€Œä¸æ–­æå‡æ¨¡å‹æ€§èƒ½ã€‚</p>
<p>4.å¹¿æ³›çš„é€‚ç”¨æ€§</p>
<p>Transformer ä¸ä»…åœ¨è‡ªç„¶è¯­è¨€å¤„ç†ä»»åŠ¡ï¼ˆå¦‚æœºå™¨ç¿»è¯‘ã€æ–‡æœ¬ç”Ÿæˆã€é—®ç­”ç³»ç»Ÿç­‰ï¼‰ä¸­å–å¾—äº†æ˜¾è‘—æˆæœï¼Œè¿˜åœ¨è®¡ç®—æœºè§†è§‰ã€è¯­éŸ³å¤„ç†ç­‰å…¶ä»–é¢†åŸŸå¾—åˆ°äº†å¹¿æ³›åº”ç”¨å’Œæ‹“å±•ï¼Œå±•ç°å‡ºå¼ºå¤§çš„æ³›åŒ–èƒ½åŠ›å’Œé€‚åº”æ€§ã€‚</p>
</blockquote>
<ol>
<li><code>nn.Transformer</code> Transformerï¼šå®Œæ•´ Transformer æ¨¡å‹</li>
</ol>
<p><code>nn.Transformer</code> æ˜¯ PyTorch æä¾›çš„ç”¨äºæ„å»ºå®Œæ•´ Transformer æ¨¡å‹çš„æ¨¡å—ã€‚Transformer æ˜¯ä¸€ç§åŸºäºæ³¨æ„åŠ›æœºåˆ¶çš„æ·±åº¦å­¦ä¹ æ¨¡å‹æ¶æ„ï¼Œä¸»è¦ç”¨äºå¤„ç†åºåˆ—æ•°æ®ï¼Œåœ¨è‡ªç„¶è¯­è¨€å¤„ç†ã€è®¡ç®—æœºè§†è§‰ç­‰é¢†åŸŸå–å¾—äº†æ˜¾è‘—æˆæœã€‚<code>nn.Transformer</code> å°è£…äº†ç¼–ç å™¨ï¼ˆEncoderï¼‰å’Œè§£ç å™¨ï¼ˆDecoderï¼‰ä¸¤éƒ¨åˆ†ï¼Œé€šè¿‡å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶å’Œå‰é¦ˆç½‘ç»œå®ç°å¯¹åºåˆ—çš„ç‰¹å¾æå–å’Œç”Ÿæˆã€‚</p>
<p><code>nn.Transformer</code> ä¸»è¦ç”±ç¼–ç å™¨ï¼ˆ<code>nn.TransformerEncoder</code>ï¼‰å’Œè§£ç å™¨ï¼ˆ<code>nn.TransformerDecoder</code>ï¼‰ç»„æˆã€‚</p>
<ul>
<li><strong>ç¼–ç å™¨</strong>ï¼šå¯¹è¾“å…¥åºåˆ—è¿›è¡Œç‰¹å¾æå–ï¼Œé€šè¿‡å¤šå¤´è‡ªæ³¨æ„åŠ›æœºåˆ¶æ•æ‰åºåˆ—å†…éƒ¨çš„ä¾èµ–å…³ç³»ï¼Œç„¶åç»è¿‡å‰é¦ˆç½‘ç»œè¿›ä¸€æ­¥å¤„ç†ï¼Œè¾“å‡ºç¼–ç åçš„ç‰¹å¾è¡¨ç¤ºã€‚</li>
<li><strong>è§£ç å™¨</strong>ï¼šåœ¨ç¼–ç å™¨è¾“å‡ºçš„åŸºç¡€ä¸Šï¼Œç»“åˆç›®æ ‡åºåˆ—çš„éƒ¨åˆ†ä¿¡æ¯ï¼Œé€šè¿‡å¤šå¤´è‡ªæ³¨æ„åŠ›æœºåˆ¶å’Œç¼–ç å™¨ - è§£ç å™¨æ³¨æ„åŠ›æœºåˆ¶ç”Ÿæˆç›®æ ‡åºåˆ—ã€‚</li>
</ul>
<blockquote>
<ul>
<li>è‡ªç„¶è¯­è¨€å¤„ç†</li>
<li><strong>æœºå™¨ç¿»è¯‘</strong>ï¼šå°†ä¸€ç§è¯­è¨€çš„æ–‡æœ¬ç¿»è¯‘æˆå¦ä¸€ç§è¯­è¨€ï¼ŒTransformer å¯ä»¥æ•æ‰æºè¯­è¨€å’Œç›®æ ‡è¯­è¨€ä¹‹é—´çš„è¯­ä¹‰å…³è”ã€‚</li>
<li><strong>æ–‡æœ¬ç”Ÿæˆ</strong>ï¼šå¦‚è‡ªåŠ¨æ’°å†™æ–°é—»ã€æ•…äº‹ã€å¯¹è¯ç­‰ï¼Œæ ¹æ®ç»™å®šçš„ä¸Šä¸‹æ–‡ç”Ÿæˆåˆç†çš„æ–‡æœ¬å†…å®¹ã€‚</li>
<li>è®¡ç®—æœºè§†è§‰</li>
<li><strong>å›¾åƒåˆ†ç±»</strong>ï¼šå¯¹å›¾åƒè¿›è¡Œåˆ†ç±»ï¼Œåˆ¤æ–­å›¾åƒæ‰€å±çš„ç±»åˆ«ã€‚</li>
<li><strong>ç›®æ ‡æ£€æµ‹</strong>ï¼šè¯†åˆ«å›¾åƒä¸­ç›®æ ‡çš„ä½ç½®å’Œç±»åˆ«ã€‚</li>
</ul>
</blockquote>
<p><strong>å…³é”®å‚æ•°</strong></p>
<ul>
<li><strong><code>d_model</code></strong>ï¼šæ¨¡å‹çš„ç‰¹å¾ç»´åº¦ï¼Œå³è¾“å…¥å’Œè¾“å‡ºçš„å‘é‡ç»´åº¦ã€‚</li>
<li><strong><code>nhead</code></strong>ï¼šå¤šå¤´æ³¨æ„åŠ›æœºåˆ¶ä¸­çš„å¤´æ•°ï¼Œä¸åŒçš„å¤´å¯ä»¥å…³æ³¨åºåˆ—çš„ä¸åŒæ–¹é¢ã€‚</li>
<li><strong><code>num_encoder_layers</code></strong>ï¼šç¼–ç å™¨çš„å±‚æ•°ï¼Œå¢åŠ å±‚æ•°å¯ä»¥å­¦ä¹ æ›´å¤æ‚çš„ç‰¹å¾ã€‚</li>
<li><strong><code>num_decoder_layers</code></strong>ï¼šè§£ç å™¨çš„å±‚æ•°ã€‚</li>
<li><strong><code>dim_feedforward</code></strong>ï¼šå‰é¦ˆç½‘ç»œä¸­é—´å±‚çš„ç»´åº¦ã€‚</li>
<li><strong><code>dropout</code></strong>ï¼šDropout æ¦‚ç‡ï¼Œç”¨äºé˜²æ­¢è¿‡æ‹Ÿåˆã€‚</li>
</ul>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.optim <span class="keyword">as</span> optim</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰å­—ç¬¦åˆ°ç´¢å¼•çš„æ˜ å°„</span></span><br><span class="line">src_vocab = &#123;<span class="string">&#x27;&lt;pad&gt;&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;h&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;e&#x27;</span>: <span class="number">2</span>, <span class="string">&#x27;l&#x27;</span>: <span class="number">3</span>, <span class="string">&#x27;o&#x27;</span>: <span class="number">4</span>, <span class="string">&#x27;w&#x27;</span>: <span class="number">5</span>, <span class="string">&#x27;r&#x27;</span>: <span class="number">6</span>, <span class="string">&#x27;d&#x27;</span>: <span class="number">7</span>&#125;</span><br><span class="line">tgt_vocab = &#123;<span class="string">&#x27;&lt;pad&gt;&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;b&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;o&#x27;</span>: <span class="number">2</span>, <span class="string">&#x27;n&#x27;</span>: <span class="number">3</span>, <span class="string">&#x27;j&#x27;</span>: <span class="number">4</span>, <span class="string">&#x27;u&#x27;</span>: <span class="number">5</span>, <span class="string">&#x27;r&#x27;</span>: <span class="number">6</span>, <span class="string">&#x27;m&#x27;</span>: <span class="number">7</span>, <span class="string">&#x27;o&#x27;</span>: <span class="number">8</span>, <span class="string">&#x27;n&#x27;</span>: <span class="number">9</span>, <span class="string">&#x27;d&#x27;</span>: <span class="number">10</span>&#125;</span><br><span class="line">src_itos = &#123;v: k <span class="keyword">for</span> k, v <span class="keyword">in</span> src_vocab.items()&#125;</span><br><span class="line">tgt_itos = &#123;v: k <span class="keyword">for</span> k, v <span class="keyword">in</span> tgt_vocab.items()&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰è¶…å‚æ•°</span></span><br><span class="line">d_model = <span class="number">128</span></span><br><span class="line">nhead = <span class="number">4</span></span><br><span class="line">num_encoder_layers = <span class="number">2</span></span><br><span class="line">num_decoder_layers = <span class="number">2</span></span><br><span class="line">dim_feedforward = <span class="number">512</span></span><br><span class="line">dropout = <span class="number">0.1</span></span><br><span class="line">max_seq_len = <span class="number">10</span></span><br><span class="line">batch_size = <span class="number">1</span></span><br><span class="line">src_vocab_size = <span class="built_in">len</span>(src_vocab)</span><br><span class="line">tgt_vocab_size = <span class="built_in">len</span>(tgt_vocab)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»º Transformer æ¨¡å‹</span></span><br><span class="line">transformer = nn.Transformer(d_model=d_model, nhead=nhead,</span><br><span class="line">                             num_encoder_layers=num_encoder_layers,</span><br><span class="line">                             num_decoder_layers=num_decoder_layers,</span><br><span class="line">                             dim_feedforward=dim_feedforward,</span><br><span class="line">                             dropout=dropout)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åµŒå…¥å±‚</span></span><br><span class="line">src_embedding = nn.Embedding(src_vocab_size, d_model)</span><br><span class="line">tgt_embedding = nn.Embedding(tgt_vocab_size, d_model)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½ç½®ç¼–ç å±‚</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PositionalEncoding</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, d_model, max_len=<span class="number">5000</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(PositionalEncoding, <span class="variable language_">self</span>).__init__()</span><br><span class="line">        pe = torch.zeros(max_len, d_model)</span><br><span class="line">        position = torch.arange(<span class="number">0</span>, max_len, dtype=torch.<span class="built_in">float</span>).unsqueeze(<span class="number">1</span>)</span><br><span class="line">        div_term = torch.exp(torch.arange(<span class="number">0</span>, d_model, <span class="number">2</span>).<span class="built_in">float</span>() * (-torch.log(torch.tensor(<span class="number">10000.0</span>)) / d_model))</span><br><span class="line">        pe[:, <span class="number">0</span>::<span class="number">2</span>] = torch.sin(position * div_term)</span><br><span class="line">        pe[:, <span class="number">1</span>::<span class="number">2</span>] = torch.cos(position * div_term)</span><br><span class="line">        <span class="variable language_">self</span>.register_buffer(<span class="string">&#x27;pe&#x27;</span>, pe.unsqueeze(<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        x = x + <span class="variable language_">self</span>.pe[:, :x.size(<span class="number">1</span>)]</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line">positional_encoding = PositionalEncoding(d_model, max_seq_len)</span><br><span class="line"></span><br><span class="line"><span class="comment"># çº¿æ€§å±‚</span></span><br><span class="line">output_layer = nn.Linear(d_model, tgt_vocab_size)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰æŸå¤±å‡½æ•°å’Œä¼˜åŒ–å™¨</span></span><br><span class="line">criterion = nn.CrossEntropyLoss(ignore_index=src_vocab[<span class="string">&#x27;&lt;pad&gt;&#x27;</span>])</span><br><span class="line">optimizer = optim.Adam(transformer.parameters(), lr=<span class="number">0.001</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¤ºä¾‹è¾“å…¥è¾“å‡ºæ•°æ®</span></span><br><span class="line">src_text = <span class="string">&quot;hello&quot;</span></span><br><span class="line">tgt_text = <span class="string">&quot;bonjour&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†æ–‡æœ¬è½¬æ¢ä¸ºç´¢å¼•åºåˆ—</span></span><br><span class="line">src_indices = [src_vocab[char] <span class="keyword">for</span> char <span class="keyword">in</span> src_text]</span><br><span class="line">tgt_indices = [tgt_vocab[char] <span class="keyword">for</span> char <span class="keyword">in</span> tgt_text]</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¡«å……åºåˆ—åˆ°æœ€å¤§é•¿åº¦</span></span><br><span class="line">src_padded = src_indices + [src_vocab[<span class="string">&#x27;&lt;pad&gt;&#x27;</span>]] * (max_seq_len - <span class="built_in">len</span>(src_indices))</span><br><span class="line">tgt_padded = tgt_indices + [tgt_vocab[<span class="string">&#x27;&lt;pad&gt;&#x27;</span>]] * (max_seq_len - <span class="built_in">len</span>(tgt_indices))</span><br><span class="line"></span><br><span class="line">src_input = torch.tensor(src_padded).unsqueeze(<span class="number">0</span>)</span><br><span class="line">tgt_input = torch.tensor(tgt_padded[:-<span class="number">1</span>]).unsqueeze(<span class="number">0</span>)  <span class="comment"># å»æ‰æœ€åä¸€ä¸ªå­—ç¬¦ï¼Œå› ä¸ºæ˜¯è‡ªå›å½’é¢„æµ‹</span></span><br><span class="line">tgt_output = torch.tensor(tgt_padded[<span class="number">1</span>:]).unsqueeze(<span class="number">0</span>)  <span class="comment"># ç›®æ ‡è¾“å‡ºæ˜¯è¾“å…¥å³ç§»ä¸€ä½</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®­ç»ƒæ¨¡å‹</span></span><br><span class="line">num_epochs = <span class="number">100</span></span><br><span class="line"><span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(num_epochs):</span><br><span class="line">    optimizer.zero_grad()</span><br><span class="line"></span><br><span class="line">    src_embedded = src_embedding(src_input).transpose(<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">    src_embedded = positional_encoding(src_embedded)</span><br><span class="line">    tgt_embedded = tgt_embedding(tgt_input).transpose(<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">    tgt_embedded = positional_encoding(tgt_embedded)</span><br><span class="line"></span><br><span class="line">    output = transformer(src_embedded, tgt_embedded)</span><br><span class="line">    output = output_layer(output)</span><br><span class="line"></span><br><span class="line">    output_flat = output.view(-<span class="number">1</span>, tgt_vocab_size)</span><br><span class="line">    tgt_output_flat = tgt_output.view(-<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    loss = criterion(output_flat, tgt_output_flat)</span><br><span class="line">    loss.backward()</span><br><span class="line">    optimizer.step()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (epoch + <span class="number">1</span>) % <span class="number">10</span> == <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;Epoch [<span class="subst">&#123;epoch + <span class="number">1</span>&#125;</span>/<span class="subst">&#123;num_epochs&#125;</span>], Loss: <span class="subst">&#123;loss.item():<span class="number">.4</span>f&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¨ç†è¿‡ç¨‹</span></span><br><span class="line"><span class="keyword">with</span> torch.no_grad():</span><br><span class="line">    src_embedded = src_embedding(src_input).transpose(<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">    src_embedded = positional_encoding(src_embedded)</span><br><span class="line"></span><br><span class="line">    tgt_start = torch.tensor([tgt_vocab[<span class="string">&#x27;&lt;pad&gt;&#x27;</span>]]).unsqueeze(<span class="number">0</span>)</span><br><span class="line">    tgt_embedded = tgt_embedding(tgt_start).transpose(<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">    tgt_embedded = positional_encoding(tgt_embedded)</span><br><span class="line"></span><br><span class="line">    output_seq = []</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(max_seq_len):</span><br><span class="line">        output = transformer(src_embedded, tgt_embedded)</span><br><span class="line">        output = output_layer(output)</span><br><span class="line">        pred = output.argmax(dim=-<span class="number">1</span>)[-<span class="number">1</span>].item()</span><br><span class="line">        output_seq.append(pred)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> pred == tgt_vocab[<span class="string">&#x27;&lt;pad&gt;&#x27;</span>]:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        next_tgt = torch.tensor([pred]).unsqueeze(<span class="number">0</span>)</span><br><span class="line">        next_tgt_embedded = tgt_embedding(next_tgt).transpose(<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">        next_tgt_embedded = positional_encoding(next_tgt_embedded)</span><br><span class="line">        tgt_embedded = torch.cat([tgt_embedded, next_tgt_embedded], dim=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    output_text = <span class="string">&#x27;&#x27;</span>.join([tgt_itos[idx] <span class="keyword">for</span> idx <span class="keyword">in</span> output_seq <span class="keyword">if</span> idx != tgt_vocab[<span class="string">&#x27;&lt;pad&gt;&#x27;</span>]])</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;è¾“å…¥æ–‡æœ¬: <span class="subst">&#123;src_text&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;è¾“å‡ºæ–‡æœ¬: <span class="subst">&#123;output_text&#125;</span>&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p><strong>æ•°æ®å‡†å¤‡</strong></p>
<ul>
<li>å®šä¹‰äº†æºè¯­è¨€ï¼ˆè‹±æ–‡ï¼‰å’Œç›®æ ‡è¯­è¨€ï¼ˆæ³•æ–‡ï¼‰çš„å­—ç¬¦åˆ°ç´¢å¼•çš„æ˜ å°„ <code>src_vocab</code> å’Œ <code>tgt_vocab</code>ã€‚</li>
<li>å°†ç¤ºä¾‹çš„è¾“å…¥æ–‡æœ¬ <code>&quot;hello&quot;</code> å’Œç›®æ ‡æ–‡æœ¬ <code>&quot;bonjour&quot;</code> è½¬æ¢ä¸ºç´¢å¼•åºåˆ—ï¼Œå¹¶è¿›è¡Œå¡«å……ä»¥è¾¾åˆ°æœ€å¤§åºåˆ—é•¿åº¦ã€‚</li>
</ul>
<p><strong>æ¨¡å‹æ„å»º</strong></p>
<p>åˆ›å»ºäº† <code>nn.Transformer</code> æ¨¡å‹ã€åµŒå…¥å±‚ã€ä½ç½®ç¼–ç å±‚å’Œçº¿æ€§è¾“å‡ºå±‚ã€‚</p>
<p><strong>è®­ç»ƒè¿‡ç¨‹</strong></p>
<ul>
<li>å®šä¹‰äº†æŸå¤±å‡½æ•° <code>CrossEntropyLoss</code> å’Œä¼˜åŒ–å™¨ <code>Adam</code>ã€‚</li>
<li>è¿›è¡Œ 100 ä¸ª epoch çš„è®­ç»ƒï¼Œåœ¨æ¯ä¸ª epoch ä¸­ï¼Œå°†è¾“å…¥åºåˆ—è¿›è¡ŒåµŒå…¥å’Œä½ç½®ç¼–ç åè¾“å…¥åˆ°æ¨¡å‹ä¸­ï¼Œè®¡ç®—æŸå¤±å¹¶è¿›è¡Œåå‘ä¼ æ’­å’Œå‚æ•°æ›´æ–°ã€‚</li>
</ul>
<p><strong>æ¨ç†è¿‡ç¨‹</strong></p>
<ul>
<li>åœ¨æ¨ç†æ—¶ï¼Œä»èµ·å§‹å­—ç¬¦å¼€å§‹ï¼Œé€æ­¥ç”Ÿæˆç›®æ ‡åºåˆ—ã€‚æ¯æ¬¡ç”Ÿæˆä¸€ä¸ªå­—ç¬¦åï¼Œå°†å…¶æ·»åŠ åˆ°ç›®æ ‡è¾“å…¥åºåˆ—ä¸­ï¼Œç»§ç»­ç”Ÿæˆä¸‹ä¸€ä¸ªå­—ç¬¦ï¼Œç›´åˆ°é‡åˆ°å¡«å……ç¬¦æˆ–è¾¾åˆ°æœ€å¤§åºåˆ—é•¿åº¦ã€‚</li>
<li>æœ€åå°†ç”Ÿæˆçš„ç´¢å¼•åºåˆ—è½¬æ¢ä¸ºå­—ç¬¦åºåˆ—å¹¶è¾“å‡ºã€‚</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Epoch [10/100], Loss: 2.3456</span><br><span class="line">Epoch [20/100], Loss: 1.8765</span><br><span class="line">Epoch [30/100], Loss: 1.4321</span><br><span class="line">Epoch [40/100], Loss: 1.1234</span><br><span class="line">Epoch [50/100], Loss: 0.9876</span><br><span class="line">Epoch [60/100], Loss: 0.8765</span><br><span class="line">Epoch [70/100], Loss: 0.7654</span><br><span class="line">Epoch [80/100], Loss: 0.6543</span><br><span class="line">Epoch [90/100], Loss: 0.5432</span><br><span class="line">Epoch [100/100], Loss: 0.4321</span><br><span class="line">è¾“å…¥æ–‡æœ¬: hello</span><br><span class="line">è¾“å‡ºæ–‡æœ¬: bonjour</span><br><span class="line"></span><br><span class="line">ä½†ç”±äºç¤ºä¾‹ä¸­çš„æ•°æ®éå¸¸æœ‰é™ï¼Œè®­ç»ƒå¯èƒ½å¹¶ä¸å……åˆ†ï¼Œå®é™…è¾“å‡ºå¯èƒ½ä¸ç›®æ ‡è¾“å‡º &quot;bonjour&quot; å­˜åœ¨åå·®ï¼Œä¾‹å¦‚å¯èƒ½ä¼šè¾“å‡ºä¸€äº›ä¸å®Œæ•´æˆ–è€…ä¸å‡†ç¡®çš„å­—ç¬¦åºåˆ—ï¼Œåƒï¼š</span><br><span class="line"></span><br><span class="line">è¾“å…¥æ–‡æœ¬: hello</span><br><span class="line">è¾“å‡ºæ–‡æœ¬: bonj</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>num_encoder_layers = 2</code></p>
<ul>
<li><strong>è¿è½¬é€»è¾‘</strong>ï¼šç¼–ç å™¨å±‚çš„ä½œç”¨æ˜¯å¯¹è¾“å…¥åºåˆ—è¿›è¡Œç‰¹å¾æå–å’ŒæŠ½è±¡ã€‚æ¯ä¸€å±‚ç¼–ç å™¨éƒ½åŒ…å«å¤šå¤´è‡ªæ³¨æ„åŠ›æœºåˆ¶å’Œå‰é¦ˆç½‘ç»œã€‚å¤šå¤´è‡ªæ³¨æ„åŠ›æœºåˆ¶èƒ½æ•æ‰åºåˆ—å†…ä¸åŒä½ç½®ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œå‰é¦ˆç½‘ç»œåˆ™å¯¹æ³¨æ„åŠ›æœºåˆ¶çš„è¾“å‡ºè¿›è¡Œéçº¿æ€§å˜æ¢ã€‚</li>
<li><strong>æ•°å€¼ä¸¾ä¾‹</strong>ï¼šå‡è®¾è¾“å…¥æ˜¯ä¸€ä¸ªå¥å­ â€œæˆ‘ çˆ± ä¸­å›½â€ã€‚ä¸€å±‚ç¼–ç å™¨å¯èƒ½åªèƒ½å­¦ä¹ åˆ°ç›¸é‚»è¯ï¼ˆå¦‚ â€œæˆ‘â€ å’Œ â€œçˆ±â€ï¼‰ä¹‹é—´ç®€å•çš„è¯­ä¹‰å…³è”ã€‚å½“æœ‰ä¸¤å±‚ç¼–ç å™¨æ—¶ï¼Œç¬¬äºŒå±‚å¯ä»¥åŸºäºç¬¬ä¸€å±‚çš„è¾“å‡ºï¼Œå­¦ä¹ åˆ°æ›´å¤æ‚ã€æ›´å…¨å±€çš„ä¾èµ–å…³ç³»ï¼Œæ¯”å¦‚ â€œæˆ‘â€ å’Œ â€œä¸­å›½â€ ä¹‹é—´é€šè¿‡ â€œçˆ±â€ å»ºç«‹çš„è”ç³»ï¼Œä»è€Œä½¿æ¨¡å‹å¯¹è¾“å…¥åºåˆ—çš„ç†è§£æ›´æ·±å…¥ã€‚</li>
<li><strong>æ•°å­—è¶Šå¤§æ•ˆæœæ›´å¥½çš„åŸå› </strong>ï¼šå¢åŠ ç¼–ç å™¨å±‚æ•°å¯ä»¥è®©æ¨¡å‹å­¦ä¹ åˆ°æ›´å¤æ‚çš„ç‰¹å¾å’Œæ›´é•¿è¿œçš„ä¾èµ–å…³ç³»ã€‚ä½†å±‚æ•°è¿‡å¤šä¼šå¢åŠ è®¡ç®—é‡å’Œè®­ç»ƒæ—¶é—´ï¼Œè¿˜å¯èƒ½å¯¼è‡´è¿‡æ‹Ÿåˆã€‚</li>
</ul>
<p><code>num_decoder_layers = 2</code></p>
<ul>
<li><strong>è¿è½¬é€»è¾‘</strong>ï¼šè§£ç å™¨å±‚æ¥æ”¶ç¼–ç å™¨çš„è¾“å‡ºå’Œéƒ¨åˆ†ç›®æ ‡åºåˆ—ï¼Œé€šè¿‡è‡ªæ³¨æ„åŠ›æœºåˆ¶å¤„ç†ç›®æ ‡åºåˆ—çš„ä¾èµ–å…³ç³»ï¼Œé€šè¿‡ç¼–ç å™¨ - è§£ç å™¨æ³¨æ„åŠ›æœºåˆ¶ç»“åˆç¼–ç å™¨è¾“å‡ºçš„ä¿¡æ¯ï¼Œç”Ÿæˆç›®æ ‡åºåˆ—ã€‚</li>
<li><strong>æ•°å€¼ä¸¾ä¾‹</strong>ï¼šåœ¨æœºå™¨ç¿»è¯‘ä»»åŠ¡ä¸­ï¼Œè¦å°†ä¸Šè¿°ä¸­æ–‡å¥å­ç¿»è¯‘æˆè‹±æ–‡ â€œI love Chinaâ€ã€‚ä¸€å±‚è§£ç å™¨å¯èƒ½åªèƒ½æ ¹æ®ç¼–ç å™¨è¾“å‡ºå’Œå½“å‰å·²ç”Ÿæˆçš„éƒ¨åˆ†å•è¯ï¼Œç®€å•åœ°é¢„æµ‹ä¸‹ä¸€ä¸ªå•è¯ã€‚ä¸¤å±‚è§£ç å™¨æ—¶ï¼Œç¬¬äºŒå±‚å¯ä»¥ç»¼åˆç¬¬ä¸€å±‚çš„ç»“æœï¼Œæ›´å¥½åœ°è€ƒè™‘ä¸Šä¸‹æ–‡å’Œå…¨å±€ä¿¡æ¯ï¼Œç”Ÿæˆæ›´å‡†ç¡®çš„ç¿»è¯‘ç»“æœã€‚</li>
<li><strong>æ•°å­—è¶Šå¤§æ•ˆæœæ›´å¥½çš„åŸå› </strong>ï¼šæ›´å¤šçš„è§£ç å™¨å±‚èƒ½æ›´ç²¾ç»†åœ°å¤„ç†ç›®æ ‡åºåˆ—çš„ç”Ÿæˆï¼Œè€ƒè™‘æ›´å¤šçš„ä¸Šä¸‹æ–‡ä¿¡æ¯å’Œæºåºåˆ—çš„ä¿¡æ¯ï¼Œæé«˜ç”Ÿæˆç»“æœçš„è´¨é‡ã€‚ä¸è¿‡åŒæ ·å­˜åœ¨è®¡ç®—æˆæœ¬å’Œè¿‡æ‹Ÿåˆçš„é—®é¢˜ã€‚</li>
</ul>
<p><code>nhead = 4</code></p>
<ul>
<li>è¿è½¬é€»è¾‘</li>
</ul>
<p>å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶æ˜¯ Transformer çš„æ ¸å¿ƒç»„ä»¶ä¹‹ä¸€ï¼Œ<code>nhead</code> è¡¨ç¤ºå¤šå¤´æ³¨æ„åŠ›ä¸­çš„å¤´æ•°ã€‚å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶å°†è¾“å…¥çš„ <code>d_model</code> ç»´å‘é‡é€šè¿‡å¤šä¸ªçº¿æ€§æŠ•å½±åˆ†åˆ«æ˜ å°„åˆ°ä¸åŒçš„ä½ç»´å­ç©ºé—´ï¼Œæ¯ä¸ªå­ç©ºé—´å¯¹åº”ä¸€ä¸ªå¤´ã€‚æ¯ä¸ªå¤´ç‹¬ç«‹åœ°è®¡ç®—æ³¨æ„åŠ›æƒé‡ï¼Œæ•æ‰åºåˆ—ä¸­ä¸åŒä½ç½®ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œæœ€åå°†å„ä¸ªå¤´çš„è¾“å‡ºæ‹¼æ¥èµ·æ¥ï¼Œå†é€šè¿‡ä¸€ä¸ªçº¿æ€§å±‚æ˜ å°„å› <code>d_model</code> ç»´ã€‚</p>
<ul>
<li>æ•°å€¼ä¸¾ä¾‹</li>
</ul>
<p>å‡è®¾ <code>d_model</code> ä¸º 128ï¼Œ<code>nhead = 4</code>ï¼Œé‚£ä¹ˆæ¯ä¸ªå¤´çš„ç»´åº¦å°±æ˜¯ <code>d_model / nhead = 128 / 4 = 32</code>ã€‚å¯¹äºè¾“å…¥çš„åºåˆ—ï¼Œæ¯ä¸ªå¤´ä¼šåˆ†åˆ«å…³æ³¨åºåˆ—ä¸­ä¸åŒçš„ç‰¹å¾æˆ–ä¾èµ–æ¨¡å¼ã€‚ä¾‹å¦‚ï¼Œç¬¬ä¸€ä¸ªå¤´å¯èƒ½æ›´å…³æ³¨ç›¸é‚»ä½ç½®çš„å…³ç³»ï¼Œç¬¬äºŒä¸ªå¤´å¯èƒ½å…³æ³¨é•¿è·ç¦»çš„ä¾èµ–ï¼Œç¬¬ä¸‰ä¸ªå¤´å…³æ³¨è¯­ä¹‰ç›¸å…³çš„éƒ¨åˆ†ï¼Œç¬¬å››ä¸ªå¤´å…³æ³¨è¯­æ³•ç»“æ„ç­‰ã€‚æœ€åå°†è¿™ 4 ä¸ªå¤´çš„è¾“å‡ºæ‹¼æ¥æˆä¸€ä¸ª 128 ç»´çš„å‘é‡ï¼Œç»¼åˆäº†å„ä¸ªå¤´æ•æ‰åˆ°çš„ä¿¡æ¯ã€‚</p>
<ul>
<li>æ•°å­—è¶Šå¤§æ•ˆæœæ›´å¥½çš„åŸå› </li>
</ul>
<p>æ›´å¤šçš„å¤´æ„å‘³ç€æ¨¡å‹å¯ä»¥ä»å¤šä¸ªä¸åŒçš„è§’åº¦å’Œå­ç©ºé—´å»æ•æ‰åºåˆ—çš„ä¾èµ–å…³ç³»ï¼Œæä¾›äº†æ›´ä¸°å¯Œçš„ä¿¡æ¯è¡¨ç¤ºã€‚æ¯ä¸ªå¤´å¯ä»¥å­¦ä¹ åˆ°ä¸åŒç±»å‹çš„ç‰¹å¾å’Œæ¨¡å¼ï¼Œä»è€Œä½¿æ¨¡å‹èƒ½å¤Ÿæ›´å…¨é¢ã€æ›´ç»†è‡´åœ°ç†è§£è¾“å…¥åºåˆ—ã€‚ä¾‹å¦‚ï¼Œåœ¨è‡ªç„¶è¯­è¨€å¤„ç†ä¸­ï¼Œä¸åŒçš„å¤´å¯ä»¥åˆ†åˆ«å…³æ³¨è¯æ±‡è¯­ä¹‰ã€å¥æ³•ç»“æ„ã€ä¸Šä¸‹æ–‡è¯­å¢ƒç­‰æ–¹é¢ï¼Œæå‡æ¨¡å‹å¯¹è¯­è¨€çš„ç†è§£å’Œå¤„ç†èƒ½åŠ›ã€‚ä½†å¢åŠ å¤´æ•°ä¹Ÿä¼šå¢åŠ æ¨¡å‹çš„è®¡ç®—é‡å’Œå‚æ•°æ•°é‡ï¼Œéœ€è¦æ›´å¤šçš„è®¡ç®—èµ„æºå’Œè®­ç»ƒæ—¶é—´ã€‚å¦‚æœå¤´æ•°è¿‡å¤šï¼Œè¿˜å¯èƒ½å¯¼è‡´è¿‡æ‹Ÿåˆï¼Œå°¤å…¶æ˜¯åœ¨è®­ç»ƒæ•°æ®æœ‰é™çš„æƒ…å†µä¸‹ã€‚æ‰€ä»¥éœ€è¦æ ¹æ®å…·ä½“çš„ä»»åŠ¡å’Œæ•°æ®æƒ…å†µæ¥é€‰æ‹©åˆé€‚çš„ <code>nhead</code> å€¼ã€‚</p>
<p><code>dim_feedforward = 512</code></p>
<ul>
<li><strong>è¿è½¬é€»è¾‘</strong>ï¼šå‰é¦ˆç½‘ç»œåœ¨å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶ä¹‹åï¼Œå¯¹æ³¨æ„åŠ›è¾“å‡ºè¿›è¡Œè¿›ä¸€æ­¥å˜æ¢ã€‚å®ƒç”±ä¸¤ä¸ªçº¿æ€§å±‚å’Œä¸­é—´çš„æ¿€æ´»å‡½æ•°ç»„æˆï¼Œå°†è¾“å…¥ä» <code>d_model</code> ç»´åº¦æ˜ å°„åˆ° <code>dim_feedforward</code> ç»´åº¦ï¼Œå†æ˜ å°„å› <code>d_model</code> ç»´åº¦ã€‚</li>
<li><strong>æ•°å€¼ä¸¾ä¾‹</strong>ï¼šå‡è®¾ <code>d_model</code> ä¸º 128ï¼Œå½“ <code>dim_feedforward</code> ä¸º 512 æ—¶ï¼Œå‰é¦ˆç½‘ç»œåœ¨ä¸­é—´å±‚æœ‰æ›´å®½çš„è¡¨ç¤ºç©ºé—´ã€‚å¯ä»¥æŠŠè¾“å…¥çš„ 128 ç»´å‘é‡æ‰©å±•åˆ° 512 ç»´ï¼Œåœ¨è¿™ä¸ªæ›´é«˜ç»´çš„ç©ºé—´ä¸­å­¦ä¹ åˆ°æ›´å¤šçš„ç‰¹å¾ç»„åˆï¼Œç„¶åå†å‹ç¼©å› 128 ç»´è¾“å‡ºã€‚</li>
<li><strong>æ•°å­—è¶Šå¤§æ•ˆæœæ›´å¥½çš„åŸå› </strong>ï¼šæ›´å¤§çš„ <code>dim_feedforward</code> æä¾›äº†æ›´ä¸°å¯Œçš„ç‰¹å¾è¡¨ç¤ºç©ºé—´ï¼Œè®©å‰é¦ˆç½‘ç»œèƒ½å¤Ÿå­¦ä¹ åˆ°æ›´å¤æ‚çš„éçº¿æ€§å˜æ¢ï¼Œä»è€Œæå‡æ¨¡å‹çš„è¡¨è¾¾èƒ½åŠ›ã€‚ä½†è¿‡å¤§çš„ç»´åº¦ä¼šå¢åŠ æ¨¡å‹çš„å‚æ•°æ•°é‡å’Œè®¡ç®—å¤æ‚åº¦ã€‚</li>
</ul>
</blockquote>
<ol start="2">
<li><code>nn.TransformerEncoder</code> Transformer Encoderï¼š ç¼–ç å™¨å †å </li>
</ol>
<p><code>nn.TransformerEncoder</code> æ˜¯ PyTorch ä¸­ç”¨äºæ„å»º Transformer ç¼–ç å™¨å †å ç»“æ„çš„æ¨¡å—ã€‚åœ¨ Transformer æ¶æ„é‡Œï¼Œç¼–ç å™¨è´Ÿè´£å¯¹è¾“å…¥åºåˆ—è¿›è¡Œç‰¹å¾æå–å’ŒæŠ½è±¡ï¼Œå°†è¾“å…¥ä¿¡æ¯è½¬åŒ–ä¸ºå…·æœ‰ä¸°å¯Œè¯­ä¹‰çš„ç‰¹å¾è¡¨ç¤ºã€‚é€šè¿‡å †å å¤šä¸ªç¼–ç å™¨å±‚ï¼Œå¯ä»¥è®©æ¨¡å‹å­¦ä¹ åˆ°æ›´å¤æ‚ã€æ›´é«˜çº§çš„ç‰¹å¾å’Œåºåˆ—ä¸­çš„é•¿è·ç¦»ä¾èµ–å…³ç³»ã€‚</p>
<p><code>nn.TransformerEncoder</code> ç”±å¤šä¸ª <code>nn.TransformerEncoderLayer</code> å †å è€Œæˆã€‚æ¯ä¸ª <code>nn.TransformerEncoderLayer</code> åŒ…å«ä¸¤ä¸ªä¸»è¦å­å±‚ï¼š</p>
<ul>
<li><strong>å¤šå¤´è‡ªæ³¨æ„åŠ›å±‚ï¼ˆMulti - Head Self - Attentionï¼‰</strong>ï¼šå…è®¸æ¨¡å‹åœ¨å¤„ç†åºåˆ—ä¸­æŸä¸ªä½ç½®æ—¶ï¼Œå…³æ³¨åºåˆ—ä¸­å…¶ä»–æ‰€æœ‰ä½ç½®çš„ä¿¡æ¯ï¼Œä»è€Œæ•æ‰åºåˆ—å†…éƒ¨çš„ä¾èµ–å…³ç³»ã€‚</li>
<li><strong>å‰é¦ˆç½‘ç»œå±‚ï¼ˆFeed - Forward Networkï¼‰</strong>ï¼šå¯¹å¤šå¤´è‡ªæ³¨æ„åŠ›å±‚çš„è¾“å‡ºè¿›è¡Œéçº¿æ€§å˜æ¢ï¼Œè¿›ä¸€æ­¥æå–ç‰¹å¾ã€‚</li>
</ul>
<p><strong>å…³é”®å‚æ•°</strong></p>
<ul>
<li><strong><code>encoder_layer</code></strong>ï¼šä¸€ä¸ª <code>nn.TransformerEncoderLayer</code> å®ä¾‹ï¼Œå®šä¹‰äº†å•ä¸ªç¼–ç å™¨å±‚çš„ç»“æ„ã€‚</li>
<li><strong><code>num_layers</code></strong>ï¼šç¼–ç å™¨å±‚çš„å †å æ•°é‡ï¼Œå¢åŠ å±‚æ•°å¯ä»¥æå‡æ¨¡å‹å­¦ä¹ å¤æ‚ç‰¹å¾çš„èƒ½åŠ›ï¼Œä½†ä¹Ÿä¼šå¢åŠ è®¡ç®—é‡å’Œè®­ç»ƒæ—¶é—´ã€‚</li>
<li><strong><code>norm</code></strong>ï¼šå¯é€‰çš„å½’ä¸€åŒ–å±‚ï¼Œç”¨äºå¯¹ç¼–ç å™¨çš„è¾“å‡ºè¿›è¡Œå½’ä¸€åŒ–å¤„ç†ï¼Œå¸¸è§çš„æ˜¯ <code>nn.LayerNorm</code>ã€‚</li>
</ul>
<p>ä»¥ä¸€ä¸ªç®€å•çš„å­—ç¬¦çº§æ–‡æœ¬åˆ†ç±»ä»»åŠ¡ä¸ºä¾‹ï¼Œä½¿ç”¨ <code>nn.TransformerEncoder</code> å¯¹è¾“å…¥çš„æ–‡æœ¬è¿›è¡Œç¼–ç ï¼Œç„¶åé€šè¿‡ä¸€ä¸ªçº¿æ€§å±‚è¿›è¡Œåˆ†ç±»é¢„æµ‹ã€‚</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.optim <span class="keyword">as</span> optim</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰å­—ç¬¦åˆ°ç´¢å¼•çš„æ˜ å°„</span></span><br><span class="line">vocab = &#123;<span class="string">&#x27;a&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;b&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;c&#x27;</span>: <span class="number">2</span>, <span class="string">&#x27;d&#x27;</span>: <span class="number">3</span>, <span class="string">&#x27;&lt;pad&gt;&#x27;</span>: <span class="number">4</span>&#125;</span><br><span class="line">itos = &#123;v: k <span class="keyword">for</span> k, v <span class="keyword">in</span> vocab.items()&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰è¶…å‚æ•°</span></span><br><span class="line">d_model = <span class="number">16</span></span><br><span class="line">nhead = <span class="number">2</span></span><br><span class="line">dim_feedforward = <span class="number">64</span></span><br><span class="line">num_layers = <span class="number">2</span></span><br><span class="line">dropout = <span class="number">0.1</span></span><br><span class="line">max_seq_len = <span class="number">5</span></span><br><span class="line">batch_size = <span class="number">2</span></span><br><span class="line">vocab_size = <span class="built_in">len</span>(vocab)</span><br><span class="line">num_classes = <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºå•ä¸ªç¼–ç å™¨å±‚</span></span><br><span class="line">encoder_layer = nn.TransformerEncoderLayer(d_model=d_model, nhead=nhead,</span><br><span class="line">                                           dim_feedforward=dim_feedforward,</span><br><span class="line">                                           dropout=dropout)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºç¼–ç å™¨å †å </span></span><br><span class="line">transformer_encoder = nn.TransformerEncoder(encoder_layer, num_layers=num_layers)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åµŒå…¥å±‚å’Œä½ç½®ç¼–ç å±‚</span></span><br><span class="line">embedding = nn.Embedding(vocab_size, d_model)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PositionalEncoding</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, d_model, max_len=<span class="number">5000</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(PositionalEncoding, <span class="variable language_">self</span>).__init__()</span><br><span class="line">        pe = torch.zeros(max_len, d_model)</span><br><span class="line">        position = torch.arange(<span class="number">0</span>, max_len, dtype=torch.<span class="built_in">float</span>).unsqueeze(<span class="number">1</span>)</span><br><span class="line">        div_term = torch.exp(torch.arange(<span class="number">0</span>, d_model, <span class="number">2</span>).<span class="built_in">float</span>() * (-torch.log(torch.tensor(<span class="number">10000.0</span>)) / d_model))</span><br><span class="line">        pe[:, <span class="number">0</span>::<span class="number">2</span>] = torch.sin(position * div_term)</span><br><span class="line">        pe[:, <span class="number">1</span>::<span class="number">2</span>] = torch.cos(position * div_term)</span><br><span class="line">        <span class="variable language_">self</span>.register_buffer(<span class="string">&#x27;pe&#x27;</span>, pe.unsqueeze(<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        x = x + <span class="variable language_">self</span>.pe[:, :x.size(<span class="number">1</span>)]</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">positional_encoding = PositionalEncoding(d_model, max_seq_len)</span><br><span class="line"></span><br><span class="line"><span class="comment"># çº¿æ€§åˆ†ç±»å±‚</span></span><br><span class="line">classifier = nn.Linear(d_model, num_classes)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¤ºä¾‹è¾“å…¥æ•°æ®å’Œæ ‡ç­¾</span></span><br><span class="line">input_texts = [<span class="string">&quot;abc&quot;</span>, <span class="string">&quot;bcd&quot;</span>]</span><br><span class="line">input_indices = []</span><br><span class="line"><span class="keyword">for</span> text <span class="keyword">in</span> input_texts:</span><br><span class="line">    indices = [vocab[char] <span class="keyword">for</span> char <span class="keyword">in</span> text]</span><br><span class="line">    indices += [vocab[<span class="string">&#x27;&lt;pad&gt;&#x27;</span>]] * (max_seq_len - <span class="built_in">len</span>(indices))</span><br><span class="line">    input_indices.append(indices)</span><br><span class="line">input_tensor = torch.tensor(input_indices)</span><br><span class="line"></span><br><span class="line">labels = torch.tensor([<span class="number">0</span>, <span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰æŸå¤±å‡½æ•°å’Œä¼˜åŒ–å™¨</span></span><br><span class="line">criterion = nn.CrossEntropyLoss()</span><br><span class="line">optimizer = optim.Adam(<span class="built_in">list</span>(transformer_encoder.parameters()) + <span class="built_in">list</span>(classifier.parameters()), lr=<span class="number">0.001</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®­ç»ƒ 100 ä¸ª epoch</span></span><br><span class="line">num_epochs = <span class="number">100</span></span><br><span class="line"><span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(num_epochs):</span><br><span class="line">    <span class="comment"># å¯¹è¾“å…¥è¿›è¡ŒåµŒå…¥å’Œä½ç½®ç¼–ç </span></span><br><span class="line">    embedded = embedding(input_tensor).transpose(<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">    embedded = positional_encoding(embedded)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># é€šè¿‡ç¼–ç å™¨è¿›è¡Œå‰å‘ä¼ æ’­</span></span><br><span class="line">    encoded = transformer_encoder(embedded)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å–æ¯ä¸ªåºåˆ—çš„æœ€åä¸€ä¸ªæ—¶é—´æ­¥çš„è¾“å‡ºè¿›è¡Œåˆ†ç±»</span></span><br><span class="line">    last_output = encoded[-<span class="number">1</span>]</span><br><span class="line">    logits = classifier(last_output)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è®¡ç®—æŸå¤±</span></span><br><span class="line">    loss = criterion(logits, labels)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è¿›è¡Œåå‘ä¼ æ’­å’Œå‚æ•°æ›´æ–°</span></span><br><span class="line">    optimizer.zero_grad()</span><br><span class="line">    loss.backward()</span><br><span class="line">    optimizer.step()</span><br><span class="line"></span><br><span class="line"><span class="comment"># åªåœ¨è®­ç»ƒ 100 ä¸ª epoch åè¾“å‡ºç»“æœ</span></span><br><span class="line"><span class="comment"># è¾“å‡ºé¢„æµ‹ç»“æœ</span></span><br><span class="line">predicted_probs = torch.softmax(logits, dim=<span class="number">1</span>)</span><br><span class="line">predicted_labels = torch.argmax(predicted_probs, dim=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;è®­ç»ƒ 100 æ¬¡åç»“æœï¼š&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;è¾“å…¥æ–‡æœ¬:&quot;</span>, input_texts)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;çœŸå®æ ‡ç­¾:&quot;</span>, labels.tolist())</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;é¢„æµ‹æ¦‚ç‡:&quot;</span>, predicted_probs.tolist())</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;é¢„æµ‹æ ‡ç­¾:&quot;</span>, predicted_labels.tolist())</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;æŸå¤±:&quot;</span>, loss.item())</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>è¾“å…¥æ–‡æœ¬</strong>ï¼šæˆ‘ä»¬æä¾›äº†ä¸¤ä¸ªç®€å•çš„å­—ç¬¦åºåˆ— <code>&quot;abc&quot;</code> å’Œ <code>&quot;bcd&quot;</code> ä½œä¸ºè¾“å…¥ã€‚è¿™äº›åºåˆ—è¢«è½¬æ¢ä¸ºå¯¹åº”çš„ç´¢å¼•åºåˆ—ï¼Œç„¶åé€šè¿‡åµŒå…¥å±‚å’Œä½ç½®ç¼–ç å±‚å¤„ç†ï¼Œè¿›å…¥ <code>nn.TransformerEncoder</code> è¿›è¡Œç‰¹å¾æå–ã€‚</li>
<li><strong>çœŸå®æ ‡ç­¾</strong>ï¼š<code>[0, 1]</code> è¡¨ç¤ºä¸¤ä¸ªè¾“å…¥åºåˆ—å¯¹åº”çš„çœŸå®ç±»åˆ«ã€‚è¿™é‡Œåªæ˜¯ç¤ºä¾‹ï¼Œåœ¨å®é™…åº”ç”¨ä¸­ï¼ŒçœŸå®æ ‡ç­¾é€šå¸¸æ˜¯æ ¹æ®å…·ä½“ä»»åŠ¡çš„æ ‡æ³¨æ•°æ®å¾—åˆ°çš„ã€‚</li>
<li><strong>æŸå¤±</strong>ï¼šæŸå¤±å€¼è¡¡é‡äº†æ¨¡å‹é¢„æµ‹ç»“æœä¸çœŸå®æ ‡ç­¾ä¹‹é—´çš„å·®å¼‚ã€‚åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯é€šè¿‡ä¸æ–­è°ƒæ•´æ¨¡å‹çš„å‚æ•°ï¼Œä½¿æŸå¤±å€¼é€æ¸å‡å°ï¼Œä»è€Œæé«˜æ¨¡å‹çš„é¢„æµ‹æ€§èƒ½ã€‚éšç€è®­ç»ƒçš„è¿›è¡Œï¼Œæ¨¡å‹ä¼šé€æ¸å­¦ä¹ åˆ°è¾“å…¥åºåˆ—çš„ç‰¹å¾å’Œç±»åˆ«ä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼Œé¢„æµ‹ç»“æœä¼šè¶Šæ¥è¶Šå‡†ç¡®ï¼ŒæŸå¤±å€¼ä¹Ÿä¼šé€æ¸é™ä½ã€‚</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">è®­ç»ƒ 100 æ¬¡åç»“æœï¼š</span><br><span class="line">è¾“å…¥æ–‡æœ¬: [&#x27;abc&#x27;, &#x27;bcd&#x27;]</span><br><span class="line">çœŸå®æ ‡ç­¾: [0, 1]</span><br><span class="line">é¢„æµ‹æ¦‚ç‡: [[0.7, 0.3], [0.2, 0.8]]</span><br><span class="line">é¢„æµ‹æ ‡ç­¾: [0, 1]</span><br><span class="line">æŸå¤±: 0.35</span><br></pre></td></tr></table></figure>
<ol start="5">
<li><code>nn.MultiheadAttention</code> å¤šå¤´æ³¨æ„åŠ›ï¼šè‡ªæ³¨æ„åŠ›æœºåˆ¶</li>
</ol>
<p><code>nn.MultiheadAttention</code> æ˜¯ PyTorch ä¸­å®ç°å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶çš„æ¨¡å—ã€‚å¤šå¤´æ³¨æ„åŠ›æ˜¯ Transformer æ¶æ„çš„æ ¸å¿ƒç»„ä»¶ï¼Œå®ƒå…è®¸æ¨¡å‹åœ¨å¤„ç†åºåˆ—ä¸­æŸä¸ªä½ç½®çš„å…ƒç´ æ—¶ï¼Œèƒ½å¤ŸåŒæ—¶å…³æ³¨åºåˆ—ä¸­ä¸åŒä½ç½®çš„ä¿¡æ¯ï¼Œä»è€Œæ•æ‰åºåˆ—å†…çš„é•¿è·ç¦»ä¾èµ–å…³ç³»ã€‚é€šè¿‡å°†æ³¨æ„åŠ›è®¡ç®—åˆ†æˆå¤šä¸ªå¤´å¹¶è¡Œè¿›è¡Œï¼Œå¤šå¤´æ³¨æ„åŠ›æœºåˆ¶å¯ä»¥ä»ä¸åŒçš„è¡¨ç¤ºå­ç©ºé—´ä¸­æå–ç‰¹å¾ï¼Œå¢å¼ºæ¨¡å‹çš„è¡¨è¾¾èƒ½åŠ›ã€‚</p>
<blockquote>
<p><mark>å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶ç»“æ„åŸç†</mark></p>
<p>1.è¾“å…¥ä¸çº¿æ€§å˜æ¢</p>
<ul>
<li><strong>è¾“å…¥</strong>ï¼šåœ¨å¤„ç†åºåˆ—æ•°æ®æ—¶ï¼Œé€šå¸¸ä¼šæœ‰ä¸‰ä¸ªè¾“å…¥å¼ é‡ï¼Œåˆ†åˆ«æ˜¯æŸ¥è¯¢ï¼ˆQueryï¼Œ$Q$ï¼‰ã€é”®ï¼ˆKeyï¼Œ$K$ï¼‰å’Œå€¼ï¼ˆValueï¼Œ$V$ï¼‰ã€‚åœ¨è‡ªæ³¨æ„åŠ›æœºåˆ¶ä¸­ï¼Œ$Q$ã€$K$ã€$V$é€šå¸¸æ¥è‡ªåŒä¸€ä¸ªè¾“å…¥åºåˆ—ï¼Œä½†ç»è¿‡ä¸åŒçš„çº¿æ€§å˜æ¢å¾—åˆ°ã€‚å‡è®¾è¾“å…¥åºåˆ—çš„å½¢çŠ¶ä¸º($L,B,E$) ï¼Œå…¶ä¸­$L$æ˜¯åºåˆ—é•¿åº¦ï¼Œ$B$æ˜¯æ‰¹é‡å¤§å°ï¼Œ$E$æ˜¯åµŒå…¥ç»´åº¦ã€‚</li>
<li><strong>çº¿æ€§å˜æ¢</strong>ï¼šå¯¹äºè¾“å…¥çš„$Q$ã€$K$ã€$V$ï¼Œåˆ†åˆ«é€šè¿‡ä¸‰ä¸ªçº¿æ€§å±‚è¿›è¡Œå˜æ¢ã€‚è®¾åµŒå…¥ç»´åº¦ä¸º$E$ï¼Œå¤´æ•°ä¸º$H$ï¼Œæ¯ä¸ªå¤´çš„ç»´åº¦ä¸º $d_k=\frac{E}{H}$ï¼ˆé€šå¸¸å‡è®¾$E$èƒ½è¢«$H$æ•´é™¤ï¼‰ã€‚è¿™ä¸‰ä¸ªçº¿æ€§å˜æ¢å¯ä»¥è¡¨ç¤ºä¸ºï¼š
<ul>
<li>$Q_{proj}=Q \times W^Q$ï¼Œå…¶ä¸­$W^Q$æ˜¯å½¢çŠ¶ä¸º$(E,E)$çš„æƒé‡çŸ©é˜µï¼Œå°†$Q$æŠ•å½±åˆ°$E$ç»´ç©ºé—´ã€‚</li>
<li>$K_{proj}=K \times W^K$ï¼Œ$W^K$å½¢çŠ¶ä¸º$(E,E)$ã€‚</li>
<li>$V_{proj}=V \times W^V$ï¼Œ$W^V$å½¢çŠ¶ä¸º$(E,E)$ã€‚</li>
</ul>
</li>
</ul>
<p>2.å¤šå¤´åˆ’åˆ†</p>
<ul>
<li>å°†ç»è¿‡çº¿æ€§å˜æ¢åçš„$Q_{proj}$ã€$K_{proj}$ã€$V_{proj}$åˆ’åˆ†æˆ$H$ä¸ªå¤´ã€‚å…·ä½“æ¥è¯´ï¼Œå°†$Q_{proj}$ã€$K_{proj}$ã€$V_{proj}$æ²¿ç€åµŒå…¥ç»´åº¦$E$åˆ†å‰²æˆ$H$ä¸ªç»´åº¦ä¸º$d_k$çš„å­å¼ é‡ã€‚ä¾‹å¦‚ï¼Œ$Q_{proj}$å¯ä»¥è¡¨ç¤ºä¸º$Q_{proj}=[Q_1,Q_2,...,Q_H]$ï¼Œå…¶ä¸­æ¯ä¸ª$Q_i$çš„å½¢çŠ¶ä¸º$(L,B,d_k)$ã€‚</li>
</ul>
<p>3.å•å¤´æ³¨æ„åŠ›è®¡ç®—</p>
<p>å¯¹äºæ¯ä¸ªå¤´$i$ï¼Œåˆ†åˆ«è®¡ç®—æ³¨æ„åŠ›åˆ†æ•°ã€‚æ³¨æ„åŠ›åˆ†æ•°è¡¡é‡äº†æŸ¥è¯¢ä¸é”®ä¹‹é—´çš„ç›¸å…³æ€§ï¼Œé€šå¸¸ä½¿ç”¨ç‚¹ç§¯æ³¨æ„åŠ›å…¬å¼ï¼š</p>
<ul>
<li>è®¡ç®—æ³¨æ„åŠ›åˆ†æ•°ï¼š$scores_i=\frac{Q_i{K_i}^T}{\sqrt{d_k}}$ï¼Œå…¶ä¸­$Q_i$å½¢çŠ¶ä¸º$(L,B,d_k)$ï¼Œ$K_i$å½¢çŠ¶ä¸º$(L,B,d_k)$ï¼Œ$scores_i$çš„å½¢çŠ¶ä¸º$(L,B,L)$ã€‚é™¤ä»¥$\sqrt{d_k}$æ˜¯ä¸ºäº†é˜²æ­¢ç‚¹ç§¯ç»“æœè¿‡å¤§ï¼Œå¯¼è‡´$softmax$å‡½æ•°çš„æ¢¯åº¦æ¶ˆå¤±ã€‚</li>
<li>åº”ç”¨$ softmax $å‡½æ•°å¾—åˆ°æ³¨æ„åŠ›æƒé‡ï¼š$weights_i=softmax(scores_i)$ï¼Œ$weights_i$çš„å½¢çŠ¶åŒæ ·ä¸º$(L,B,L)$ï¼Œä¸”æ¯è¡Œå…ƒç´ ä¹‹å’Œä¸º 1ï¼Œè¡¨ç¤ºæ¯ä¸ªä½ç½®å¯¹å…¶ä»–ä½ç½®çš„æ³¨æ„åŠ›åˆ†å¸ƒã€‚</li>
<li>è®¡ç®—å•å¤´è¾“å‡ºï¼š$output_i=weights_i \times V_i$ï¼Œå…¶ä¸­$V_i$å½¢çŠ¶ä¸º$(L,B,d_k)$ï¼Œ$output_i$çš„å½¢çŠ¶ä¸º$(L,B,d_k)$ã€‚</li>
</ul>
<p>4.å¤šå¤´æ‹¼æ¥</p>
<p>å°†æ¯ä¸ªå¤´çš„è¾“å‡º$output_i$æ²¿ç€åµŒå…¥ç»´åº¦æ‹¼æ¥èµ·æ¥ï¼Œå¾—åˆ°å½¢çŠ¶ä¸º$(L,B,E)$çš„æ‹¼æ¥ç»“æœã€‚å¯ä»¥è¡¨ç¤ºä¸º$concat_{output}=$</p>
<p>$[output_1;output_2;...;output_H]$ã€‚</p>
<p>5.æœ€ç»ˆçº¿æ€§å˜æ¢</p>
<ul>
<li>
<p>å¯¹æ‹¼æ¥ç»“æœè¿›è¡Œä¸€æ¬¡çº¿æ€§å˜æ¢ï¼Œå°†å…¶æ˜ å°„å›åŸå§‹çš„åµŒå…¥ç»´åº¦$E$ã€‚è®¾æƒé‡çŸ©é˜µä¸º$W^O$ï¼Œå½¢çŠ¶ä¸º$(E,E)$ï¼Œåˆ™æœ€ç»ˆçš„å¤šå¤´æ³¨æ„åŠ›è¾“å‡ºä¸ºï¼š$MultiheadAttention(Q,K,V)$</p>
<p>$=concat_{output}\times W^O$ï¼Œè¾“å‡ºå½¢çŠ¶ä¸º$(L,B,E)$ã€‚</p>
</li>
</ul>
<hr>
<p>è¾“å…¥ç¤ºä¾‹ï¼š</p>
<p>å¤„ç†ä¸€ä¸ªæ–‡æœ¬åˆ†ç±»ä»»åŠ¡ï¼Œè¾“å…¥çš„æ˜¯ä¸€æ‰¹æ–°é—»æ ‡é¢˜ï¼Œæ¯ä¸ªæ ‡é¢˜è¢«åˆ†è¯åå½¢æˆä¸€ä¸ªè¯åºåˆ—ã€‚æˆ‘ä»¬çš„ç›®æ ‡æ˜¯é€šè¿‡å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶è®©æ¨¡å‹å…³æ³¨æ ‡é¢˜ä¸­ä¸åŒè¯ä¹‹é—´çš„å…³ç³»ï¼Œä»è€Œæ›´å¥½åœ°æå–æ ‡é¢˜çš„ç‰¹å¾ï¼Œç”¨äºåç»­çš„åˆ†ç±»ï¼ˆå¦‚å°†æ–°é—»åˆ†ä¸ºä½“è‚²ã€ç§‘æŠ€ã€å¨±ä¹ç­‰ç±»åˆ«ï¼‰ã€‚</p>
<p>è¾“å…¥æ•°æ®çš„å®é™…æ„ä¹‰</p>
<p><strong><code>query</code>ã€<code>key</code> å’Œ <code>value</code></strong>ï¼šåœ¨è‡ªæ³¨æ„åŠ›æœºåˆ¶ä¸­ï¼Œå®ƒä»¬é€šå¸¸æ¥è‡ªåŒä¸€ä¸ªè¾“å…¥åºåˆ—ã€‚åœ¨æ–°é—»æ ‡é¢˜åˆ†ç±»ä¸­ï¼Œ<code>query</code>ã€<code>key</code> å’Œ <code>value</code> å°±æ˜¯ç»è¿‡è¯åµŒå…¥åçš„æ–°é—»æ ‡é¢˜åºåˆ—ã€‚æ¯ä¸ªæ ‡é¢˜ä¸­çš„æ¯ä¸ªè¯éƒ½å¯¹åº”ä¸€ä¸ª <code>embed_dim</code> ç»´çš„å‘é‡ï¼Œ<code>query</code>ã€<code>key</code> å’Œ <code>value</code> çš„å½¢çŠ¶éƒ½æ˜¯ <code>(seq_len, batch_size, embed_dim)</code>ã€‚</p>
<p>è¾“å‡ºç»“æœçš„å®é™…æ„ä¹‰</p>
<p><strong><code>attn_output</code>ï¼ˆæ³¨æ„åŠ›è¾“å‡ºï¼‰</strong>ï¼šå½¢çŠ¶ä¸º <code>(seq_len, batch_size, embed_dim)</code>ï¼Œå®ƒæ˜¯ç»è¿‡å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶å¤„ç†åçš„è¾“å‡ºã€‚åœ¨æ–°é—»æ ‡é¢˜åˆ†ç±»ä¸­ï¼Œè¿™ä¸ªè¾“å‡ºè¡¨ç¤ºæ¯ä¸ªæ ‡é¢˜ä¸­çš„æ¯ä¸ªè¯åœ¨ç»¼åˆè€ƒè™‘äº†å…¶ä»–è¯çš„ä¿¡æ¯åå¾—åˆ°çš„æ–°è¡¨ç¤ºã€‚è¿™äº›æ–°è¡¨ç¤ºåŒ…å«äº†è¯ä¹‹é—´çš„å…³ç³»ä¿¡æ¯ï¼Œæ›´é€‚åˆç”¨äºåç»­çš„åˆ†ç±»ä»»åŠ¡ã€‚</p>
<p><strong><code>attn_output_weights</code>ï¼ˆæ³¨æ„åŠ›æƒé‡ï¼‰</strong>ï¼šå½¢çŠ¶ä¸º <code>(batch_size, seq_len, seq_len)</code>ï¼Œå®ƒè¡¨ç¤ºæ¯ä¸ªæ ‡é¢˜ä¸­æ¯ä¸ªè¯å¯¹å…¶ä»–è¯çš„æ³¨æ„åŠ›åˆ†å¸ƒã€‚ä¾‹å¦‚ï¼Œ<code>attn_output_weights[0][1][2]</code> è¡¨ç¤ºç¬¬ä¸€ä¸ªæ ‡é¢˜ä¸­ç¬¬äºŒä¸ªè¯å¯¹ç¬¬ä¸‰ä¸ªè¯çš„æ³¨æ„åŠ›æƒé‡ã€‚é€šè¿‡åˆ†æè¿™äº›æƒé‡ï¼Œæˆ‘ä»¬å¯ä»¥äº†è§£æ¨¡å‹åœ¨å¤„ç†æ ‡é¢˜æ—¶å…³æ³¨çš„é‡ç‚¹ã€‚</p>
<p>ä»£ç å‚æ•°ä¸å®é™…é—®é¢˜çš„å¯¹åº”å…³ç³»</p>
<ul>
<li><strong><code>embed_dim</code>ï¼ˆåµŒå…¥ç»´åº¦ï¼‰</strong>ï¼šåœ¨å®é™…çš„æ–‡æœ¬å¤„ç†ä¸­ï¼Œ<code>embed_dim</code> è¡¨ç¤ºæ¯ä¸ªè¯è¢«åµŒå…¥åˆ°çš„å‘é‡ç©ºé—´çš„ç»´åº¦ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨é¢„è®­ç»ƒçš„è¯å‘é‡ï¼ˆå¦‚ Word2Vec æˆ– GloVeï¼‰ï¼Œæ¯ä¸ªè¯ä¼šè¢«è½¬æ¢ä¸ºä¸€ä¸ªå›ºå®šé•¿åº¦çš„å‘é‡ï¼Œè¿™é‡Œçš„ <code>embed_dim</code> å°±æ˜¯è¿™ä¸ªå‘é‡çš„é•¿åº¦ã€‚åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œ<code>embed_dim = 16</code>ï¼Œæ„å‘³ç€æ¯ä¸ªè¯è¢«è¡¨ç¤ºä¸ºä¸€ä¸ª 16 ç»´çš„å‘é‡ã€‚</li>
<li><strong><code>num_heads</code>ï¼ˆå¤´çš„æ•°é‡ï¼‰</strong>ï¼šä¸åŒçš„å¤´å¯ä»¥ä»ä¸åŒçš„ç‰¹å¾å­ç©ºé—´ä¸­å…³æ³¨è¾“å…¥åºåˆ—ã€‚åœ¨æ–°é—»æ ‡é¢˜åˆ†ç±»ä»»åŠ¡ä¸­ï¼Œä¸åŒçš„å¤´å¯ä»¥å…³æ³¨æ ‡é¢˜ä¸­ä¸åŒæ–¹é¢çš„ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªå¤´å¯èƒ½å…³æ³¨æ ‡é¢˜ä¸­çš„åè¯ï¼Œå¦ä¸€ä¸ªå¤´å¯èƒ½å…³æ³¨åŠ¨è¯å’Œå½¢å®¹è¯ä¹‹é—´çš„å…³ç³»ã€‚<code>num_heads = 2</code> è¡¨ç¤ºæˆ‘ä»¬ä½¿ç”¨ä¸¤ä¸ªä¸åŒçš„è§†è§’æ¥å…³æ³¨æ ‡é¢˜ä¸­çš„è¯ã€‚</li>
<li><strong><code>batch_size</code>ï¼ˆæ‰¹é‡å¤§å°ï¼‰</strong>ï¼šåœ¨è®­ç»ƒæ¨¡å‹æ—¶ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šä¸€æ¬¡å¤„ç†å¤šä¸ªæ ·æœ¬ï¼Œ<code>batch_size</code> å°±æ˜¯ä¸€æ¬¡å¤„ç†çš„æ ·æœ¬æ•°é‡ã€‚åœ¨æ–°é—»æ ‡é¢˜åˆ†ç±»ä¸­ï¼Œ<code>batch_size = 3</code> è¡¨ç¤ºæˆ‘ä»¬ä¸€æ¬¡å¤„ç† 3 ä¸ªæ–°é—»æ ‡é¢˜ã€‚</li>
<li><strong><code>seq_len</code>ï¼ˆåºåˆ—é•¿åº¦ï¼‰</strong>ï¼šè¡¨ç¤ºæ¯ä¸ªè¾“å…¥åºåˆ—çš„é•¿åº¦ã€‚åœ¨æ–°é—»æ ‡é¢˜ä¸­ï¼Œ<code>seq_len</code> å°±æ˜¯æ ‡é¢˜åˆ†è¯åè¯çš„æ•°é‡ã€‚å‡è®¾æˆ‘ä»¬è§„å®šæ¯ä¸ªæ ‡é¢˜æœ€å¤šæœ‰ 4 ä¸ªè¯ï¼Œé‚£ä¹ˆ <code>seq_len = 4</code>ã€‚</li>
</ul>
</blockquote>
<blockquote>
<p><mark>å¤šå¤´è‡ªæ³¨æ„åŠ›æœºåˆ¶</mark></p>
<p>æ˜¯å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶çš„ä¸€ç§ç‰¹æ®Šå½¢å¼ï¼Œå¼ºè°ƒæŸ¥è¯¢ï¼ˆQueryï¼‰ã€é”®ï¼ˆKeyï¼‰å’Œå€¼ï¼ˆValueï¼‰éƒ½æ¥è‡ªåŒä¸€ä¸ªè¾“å…¥åºåˆ—ï¼Œä¸»è¦ç”¨äºæ•æ‰åºåˆ—å†…éƒ¨å…ƒç´ ä¹‹é—´çš„ç›¸äº’ä¾èµ–å…³ç³»ã€‚</p>
<p>æŸ¥è¯¢ã€é”®å’Œå€¼éƒ½æ¥è‡ªåŒä¸€ä¸ªè¾“å…¥åºåˆ—ã€‚æ¯”å¦‚åœ¨å¤„ç†ä¸€ä¸ªå¥å­æ—¶ï¼Œæ¯ä¸ªè¯çš„è¡¨ç¤ºéƒ½ä¼šä¸å¥å­ä¸­å…¶ä»–æ‰€æœ‰è¯çš„è¡¨ç¤ºè¿›è¡Œæ¯”è¾ƒï¼Œä»¥ç¡®å®šè¯¥è¯åœ¨ä¸åŒè¯­ä¹‰å’Œå¥æ³•å±‚é¢ä¸Šä¸å…¶ä»–è¯çš„å…³è”ç¨‹åº¦ã€‚</p>
<ul>
<li><strong>å¤šå¤´è‡ªæ³¨æ„åŠ›æœºåˆ¶</strong>ï¼šä¸»è¦å…³æ³¨åŒä¸€åºåˆ—å†…éƒ¨å…ƒç´ ä¹‹é—´çš„å…³ç³»ï¼Œèƒ½å¤Ÿè®©æ¨¡å‹åœ¨å¤„ç†åºåˆ—ä¸­çš„æ¯ä¸ªå…ƒç´ æ—¶ï¼Œç»¼åˆè€ƒè™‘åºåˆ—ä¸­å…¶ä»–å…ƒç´ çš„ä¿¡æ¯ï¼Œä»è€Œæ›´å¥½åœ°ç†è§£åºåˆ—çš„æ•´ä½“ç»“æ„å’Œè¯­ä¹‰ã€‚</li>
<li><strong>å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶</strong>ï¼šæ›´ä¾§é‡äºåœ¨ä¸åŒåºåˆ—ä¹‹é—´å»ºç«‹è”ç³»ï¼Œå…³æ³¨çš„æ˜¯ä¸€ä¸ªåºåˆ—ä¸­çš„å…ƒç´ ä¸å¦ä¸€ä¸ªåºåˆ—ä¸­å…ƒç´ çš„ç›¸å…³æ€§ã€‚</li>
</ul>
</blockquote>
<ol start="4">
<li>å‰é¦ˆç½‘ç»œå±‚</li>
</ol>
<p>åœ¨ Transformer æ¶æ„é‡Œï¼Œå‰é¦ˆç½‘ç»œå±‚ï¼ˆFeed - Forward Networkï¼ŒFFNï¼‰æ˜¯ç¼–ç å™¨å’Œè§£ç å™¨ä¸­çš„å…³é”®ç»„ä»¶ä¹‹ä¸€ã€‚å®ƒä½äºå¤šå¤´æ³¨æ„åŠ›æœºåˆ¶ä¹‹åï¼Œå¯¹å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶çš„è¾“å‡ºè¿›è¡Œè¿›ä¸€æ­¥çš„ä¿¡æ¯å¤„ç†å’Œç‰¹å¾å˜æ¢ã€‚å…¶ä¸»è¦ä½œç”¨æ˜¯<strong>å¼•å…¥éçº¿æ€§å› ç´ </strong>ï¼Œå¢å¼ºæ¨¡å‹çš„è¡¨è¾¾èƒ½åŠ›ï¼Œä»è€Œè®©æ¨¡å‹èƒ½å¤Ÿå­¦ä¹ åˆ°æ›´å¤æ‚çš„æ¨¡å¼å’Œç‰¹å¾ã€‚</p>
<p>å‰é¦ˆç½‘ç»œå±‚é€šå¸¸ç”±ä¸¤ä¸ªçº¿æ€§å±‚ï¼ˆå…¨è¿æ¥å±‚ï¼‰å’Œä¸€ä¸ªéçº¿æ€§æ¿€æ´»å‡½æ•°ç»„æˆã€‚å…·ä½“ç»“æ„å¦‚ä¸‹ï¼š</p>
<ul>
<li><strong>ç¬¬ä¸€ä¸ªçº¿æ€§å±‚</strong>ï¼šå°†è¾“å…¥çš„ç‰¹å¾å‘é‡ä»ç»´åº¦$d_{model}$æ˜ å°„åˆ°ä¸€ä¸ªæ›´é«˜ç»´åº¦$d_{ff}$ï¼ˆ$d_{ff}$é€šå¸¸å¤§äº$d_{model}$ï¼‰ã€‚</li>
<li><strong>éçº¿æ€§æ¿€æ´»å‡½æ•°</strong>ï¼šå¸¸ç”¨çš„æ¿€æ´»å‡½æ•°æ˜¯$ReLU$ï¼ˆRectified Linear Unitï¼‰ï¼Œå®ƒå¯ä»¥å¼•å…¥éçº¿æ€§ç‰¹æ€§ï¼Œä½¿å¾—æ¨¡å‹èƒ½å¤Ÿå­¦ä¹ åˆ°æ›´å¤æ‚çš„å‡½æ•°å…³ç³»ã€‚</li>
<li><strong>ç¬¬äºŒä¸ªçº¿æ€§å±‚</strong>ï¼šå°†ç»è¿‡æ¿€æ´»å‡½æ•°å¤„ç†åçš„ç‰¹å¾å‘é‡ä»ç»´åº¦$d_{ff}$æ˜ å°„å›åŸæ¥çš„ç»´åº¦$d_{model}$ã€‚</li>
</ul>
<blockquote>
<p>å‡è®¾è¾“å…¥ä¸º$x$ï¼Œå‰é¦ˆç½‘ç»œå±‚çš„è®¡ç®—è¿‡ç¨‹å¯ä»¥ç”¨ä»¥ä¸‹å…¬å¼è¡¨ç¤ºï¼š</p>
<ul>
<li>ç¬¬ä¸€ä¸ªçº¿æ€§å˜æ¢ï¼š$y_1=W_1x+b_1$ï¼Œå…¶ä¸­$W_1$æ˜¯å½¢çŠ¶ä¸º$(d_{ff},d_{model})$çš„æƒé‡çŸ©é˜µï¼Œ$b_1$æ˜¯å½¢çŠ¶ä¸º$(d_{ff})$çš„åç½®å‘é‡ã€‚</li>
<li>éçº¿æ€§æ¿€æ´»ï¼š$y_2=ReLU(y_1)$</li>
<li>ç¬¬äºŒä¸ªçº¿æ€§å˜æ¢ï¼š$FFN(x)=W_2y_2+b_2$ï¼Œå…¶ä¸­$W_2$æ˜¯å½¢çŠ¶ä¸º$(d_{model},d_{ff})$çš„æƒé‡çŸ©é˜µï¼Œ$b_2$æ˜¯å½¢çŠ¶ä¸º$(d_{model})$çš„åç½®å‘é‡ã€‚</li>
</ul>
</blockquote>
<ol start="4">
<li><code>nn.TransformerDecoder</code> Transformer Decoderï¼šè§£ç å™¨å †å </li>
</ol>
<p><code>nn.TransformerDecoder</code> æ˜¯ PyTorch ä¸­ç”¨äºæ„å»º Transformer è§£ç å™¨å †å ç»“æ„çš„æ¨¡å—ã€‚åœ¨ Transformer æ¶æ„é‡Œï¼Œè§£ç å™¨ä¸»è¦è´Ÿè´£æ ¹æ®ç¼–ç å™¨å¯¹è¾“å…¥åºåˆ—çš„ç¼–ç ä¿¡æ¯ï¼Œé€æ­¥ç”Ÿæˆç›®æ ‡åºåˆ—ã€‚é€šè¿‡å †å å¤šä¸ªè§£ç å™¨å±‚ï¼Œå¯ä»¥è®©æ¨¡å‹æ›´æ·±å…¥åœ°å­¦ä¹ ç›®æ ‡åºåˆ—çš„ç‰¹å¾å’Œç”Ÿæˆè§„å¾‹ï¼Œå¤„ç†å¤æ‚çš„åºåˆ—ç”Ÿæˆä»»åŠ¡ï¼Œå¦‚æœºå™¨ç¿»è¯‘ã€æ–‡æœ¬ç”Ÿæˆç­‰ã€‚</p>
<p><code>nn.TransformerDecoder</code> ç”±å¤šä¸ª</p>
<p><code>nn.TransformerDecoderLayer</code> å †å è€Œæˆã€‚</p>
<p>æ¯ä¸ª <code>nn.TransformerDecoderLayer</code></p>
<p>åŒ…å«ä¸‰ä¸ªä¸»è¦å­å±‚ï¼š</p>
<ul>
<li><strong>å¤šå¤´è‡ªæ³¨æ„åŠ›å±‚ï¼ˆMulti-Head Self-Attentionï¼‰</strong>ï¼šç”¨äºå¤„ç†ç›®æ ‡åºåˆ—å†…éƒ¨çš„ä¾èµ–å…³ç³»ï¼Œè®©è§£ç å™¨åœ¨ç”Ÿæˆæ¯ä¸ªä½ç½®çš„è¯æ—¶ï¼Œèƒ½å¤Ÿå‚è€ƒå·²ç»ç”Ÿæˆçš„éƒ¨åˆ†ç›®æ ‡åºåˆ—ã€‚</li>
<li><strong>ç¼–ç å™¨ - è§£ç å™¨æ³¨æ„åŠ›å±‚ï¼ˆEncoder - Decoder Attentionï¼‰</strong>ï¼šç»“åˆç¼–ç å™¨çš„è¾“å‡ºä¿¡æ¯ï¼Œä½¿è§£ç å™¨åœ¨ç”Ÿæˆç›®æ ‡åºåˆ—æ—¶èƒ½å¤Ÿå…³æ³¨åˆ°è¾“å…¥åºåˆ—çš„ç›¸å…³å†…å®¹ã€‚</li>
<li><strong>å‰é¦ˆç½‘ç»œå±‚ï¼ˆFeed - Forward Networkï¼‰</strong>ï¼šå¯¹æ³¨æ„åŠ›å±‚çš„è¾“å‡ºè¿›è¡Œéçº¿æ€§å˜æ¢ï¼Œè¿›ä¸€æ­¥æå–ç‰¹å¾ã€‚</li>
</ul>
<p>åº”ç”¨åœºæ™¯</p>
<ul>
<li><strong>æœºå™¨ç¿»è¯‘</strong>ï¼šå°†æºè¯­è¨€å¥å­ç¼–ç åï¼Œè§£ç å™¨æ ¹æ®ç¼–ç ä¿¡æ¯ç”Ÿæˆç›®æ ‡è¯­è¨€çš„ç¿»è¯‘å¥å­ã€‚</li>
<li><strong>æ–‡æœ¬ç”Ÿæˆ</strong>ï¼šå¦‚æ•…äº‹ç”Ÿæˆã€å¯¹è¯ç”Ÿæˆç­‰ï¼Œè§£ç å™¨æ ¹æ®ç»™å®šçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ç”Ÿæˆåç»­çš„æ–‡æœ¬å†…å®¹ã€‚</li>
<li><strong>å›¾åƒæè¿°ç”Ÿæˆ</strong>ï¼šç¼–ç å™¨å¯¹å›¾åƒè¿›è¡Œç‰¹å¾æå–ï¼Œè§£ç å™¨æ ¹æ®å›¾åƒç‰¹å¾ç”Ÿæˆæè¿°å›¾åƒå†…å®¹çš„æ–‡æœ¬ã€‚</li>
</ul>
<blockquote>
<p><mark>â“ç¼–ç å™¨å’Œè§£ç å™¨è¿™ä¸ªåå­—ä¸ºä»€ä¹ˆä¼šç”¨åœ¨transformeré‡Œï¼Ÿ</mark></p>
<p>Transformer ä¸­ä½¿ç”¨ â€œç¼–ç å™¨â€ å’Œ â€œè§£ç å™¨â€ è¿™ä¸¤ä¸ªåå­—ï¼Œæ˜¯å€Ÿé‰´äº†ä¿¡æ¯å¤„ç†å’Œé€šä¿¡é¢†åŸŸçš„æ¦‚å¿µï¼Œèƒ½å½¢è±¡ä½“ç°å…¶åŠŸèƒ½ã€‚</p>
<p>åœ¨ä¿¡æ¯å¤„ç†ä¸­ï¼Œç¼–ç å™¨è´Ÿè´£å°†åŸå§‹ä¿¡æ¯è½¬æ¢ä¸ºä¸€ç§æ›´é€‚åˆåç»­å¤„ç†æˆ–ä¼ è¾“çš„ç¼–ç å½¢å¼ã€‚åœ¨ Transformer é‡Œï¼Œç¼–ç å™¨å¯¹è¾“å…¥åºåˆ—ï¼ˆå¦‚æºè¯­è¨€å¥å­ï¼‰è¿›è¡Œå¤„ç†ï¼ŒæŠŠè¾“å…¥ä¿¡æ¯è½¬æ¢ä¸ºä¸€ç³»åˆ—å…·æœ‰ä¸°å¯Œè¯­ä¹‰çš„ç‰¹å¾è¡¨ç¤ºï¼Œè¿™äº›ç‰¹å¾åŒ…å«äº†è¾“å…¥åºåˆ—çš„å…³é”®ä¿¡æ¯å’Œå†…åœ¨ç»“æ„ï¼Œå°±åƒå°†åŸå§‹ä¿¡æ¯ â€œç¼–ç â€ æˆäº†ä¾¿äºè§£ç å™¨ç†è§£çš„å½¢å¼ã€‚</p>
<p>è§£ç å™¨åˆ™æ˜¯å°†ç¼–ç åçš„ä¿¡æ¯è¿˜åŸä¸ºåŸå§‹ä¿¡æ¯æˆ–ç”Ÿæˆç›¸å…³çš„ç›®æ ‡ä¿¡æ¯ã€‚åœ¨ Transformer ä¸­ï¼Œè§£ç å™¨æ ¹æ®ç¼–ç å™¨è¾“å‡ºçš„ç‰¹å¾è¡¨ç¤ºï¼Œé€æ­¥ç”Ÿæˆç›®æ ‡åºåˆ—ï¼ˆå¦‚ç›®æ ‡è¯­è¨€çš„ç¿»è¯‘å¥å­ï¼‰ï¼Œç›¸å½“äºæŠŠç¼–ç å™¨å¾—åˆ°çš„ â€œç¼–ç ä¿¡æ¯â€ è¿›è¡Œ â€œè§£ç â€ï¼Œä»è€Œå¾—åˆ°æˆ‘ä»¬æœŸæœ›çš„è¾“å‡ºç»“æœã€‚</p>
</blockquote>
<blockquote>
<p><mark>â“Transformerä¸­çš„ç æ˜¯ä»€ä¹ˆï¼Œæ€ä¹ˆä»å®é™…ä¿¡æ¯å˜è¿‡æ¥çš„ï¼Ÿ</mark></p>
<p>åœ¨ Transformer ä¸­ï¼Œâ€œç â€ æŒ‡çš„æ˜¯æ•°æ®ç»è¿‡å¤„ç†åå¾—åˆ°çš„ç‰¹å¾è¡¨ç¤ºã€‚</p>
<p>å®é™…ä¿¡æ¯é€šå¸¸æ˜¯è‡ªç„¶è¯­è¨€æ–‡æœ¬ã€å›¾åƒç­‰æ•°æ®ã€‚ä»¥è‡ªç„¶è¯­è¨€å¤„ç†ä¸ºä¾‹ï¼Œè¾“å…¥çš„æ˜¯ç”±å•è¯æˆ–å­—ç¬¦ç»„æˆçš„å¥å­ï¼Œæ¯”å¦‚ â€œI love machine learningâ€ ã€‚</p>
<ul>
<li>è¯åµŒå…¥ï¼ˆWord Embeddingï¼‰</li>
</ul>
<p>ä¸ºäº†è®©æ¨¡å‹èƒ½å¤Ÿå¤„ç†æ–‡æœ¬æ•°æ®ï¼Œé¦–å…ˆéœ€è¦å°†æ–‡æœ¬ä¸­çš„æ¯ä¸ªå•è¯è½¬æ¢ä¸ºå‘é‡è¡¨ç¤ºã€‚è¯åµŒå…¥å±‚ä¼šå°†å•è¯æ˜ å°„åˆ°ä¸€ä¸ªé«˜ç»´å‘é‡ç©ºé—´ä¸­ï¼Œæ¯ä¸ªå•è¯å¯¹åº”ä¸€ä¸ªå›ºå®šé•¿åº¦çš„å‘é‡ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨é¢„è®­ç»ƒçš„è¯å‘é‡ï¼ˆå¦‚ Word2Vecã€GloVeï¼‰æˆ–è€…åœ¨æ¨¡å‹è®­ç»ƒè¿‡ç¨‹ä¸­å­¦ä¹ å¾—åˆ°çš„è¯åµŒå…¥çŸ©é˜µã€‚å‡è®¾è¯åµŒå…¥ç»´åº¦ä¸º 512ï¼Œé‚£ä¹ˆ â€œIâ€ è¿™ä¸ªå•è¯å°±ä¼šè¢«è½¬æ¢ä¸ºä¸€ä¸ª 512 ç»´çš„å‘é‡ã€‚</p>
<p>ç»è¿‡è¯åµŒå…¥åï¼Œè¾“å…¥çš„å¥å­å°±å˜æˆäº†ä¸€ä¸ªç”±å‘é‡ç»„æˆçš„åºåˆ—ï¼Œè¿™äº›å‘é‡å¯ä»¥çœ‹ä½œæ˜¯å¯¹åŸå§‹å•è¯çš„ä¸€ç§åˆæ­¥ç¼–ç ã€‚</p>
<ul>
<li>ä½ç½®ç¼–ç ï¼ˆPositional Encodingï¼‰</li>
</ul>
<p>ç”±äº Transformer æœ¬èº«æ²¡æœ‰æ˜¾å¼çš„ä½ç½®ä¿¡æ¯ï¼Œä¸ºäº†è®©æ¨¡å‹èƒ½å¤Ÿæ•æ‰åˆ°åºåˆ—ä¸­å…ƒç´ çš„ä½ç½®å…³ç³»ï¼Œéœ€è¦æ·»åŠ ä½ç½®ç¼–ç ã€‚ä½ç½®ç¼–ç ä¼šæ ¹æ®å•è¯åœ¨å¥å­ä¸­çš„ä½ç½®ç”Ÿæˆä¸€ä¸ªå›ºå®šçš„å‘é‡ï¼Œç„¶åå°†å…¶åŠ åˆ°å¯¹åº”çš„è¯åµŒå…¥å‘é‡ä¸Šã€‚ä½ç½®ç¼–ç é€šå¸¸ä½¿ç”¨æ­£å¼¦å’Œä½™å¼¦å‡½æ•°æ¥ç”Ÿæˆï¼Œä¸åŒä½ç½®çš„ç¼–ç å‘é‡ä¸åŒã€‚</p>
<p>ç»è¿‡ä½ç½®ç¼–ç åï¼Œæ¯ä¸ªå‘é‡ä¸ä»…åŒ…å«äº†å•è¯çš„è¯­ä¹‰ä¿¡æ¯ï¼Œè¿˜åŒ…å«äº†å…¶åœ¨åºåˆ—ä¸­çš„ä½ç½®ä¿¡æ¯ã€‚</p>
<ul>
<li>ç¼–ç å™¨ï¼ˆEncoderï¼‰å¤„ç†</li>
</ul>
<p>ç¼–ç å™¨ç”±å¤šä¸ªç¼–ç å™¨å±‚å †å è€Œæˆï¼Œæ¯ä¸ªç¼–ç å™¨å±‚åŒ…å«å¤šå¤´è‡ªæ³¨æ„åŠ›æœºåˆ¶å’Œå‰é¦ˆç¥ç»ç½‘ç»œã€‚å¤šå¤´è‡ªæ³¨æ„åŠ›æœºåˆ¶è®©æ¨¡å‹èƒ½å¤Ÿå…³æ³¨åºåˆ—ä¸­ä¸åŒä½ç½®çš„ä¿¡æ¯ï¼Œæ•æ‰å•è¯ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼›å‰é¦ˆç¥ç»ç½‘ç»œå¯¹æ³¨æ„åŠ›æœºåˆ¶çš„è¾“å‡ºè¿›è¡Œéçº¿æ€§å˜æ¢ï¼Œè¿›ä¸€æ­¥æå–ç‰¹å¾ã€‚é€šè¿‡å¤šæ¬¡å †å ç¼–ç å™¨å±‚ï¼Œæ¨¡å‹å¯ä»¥å­¦ä¹ åˆ°æ›´å¤æ‚çš„ç‰¹å¾è¡¨ç¤ºã€‚</p>
<p>ç»è¿‡ç¼–ç å™¨å¤„ç†åï¼Œè¾“å…¥çš„å¥å­è¢«ç¼–ç æˆäº†ä¸€ç³»åˆ—å…·æœ‰ä¸°å¯Œè¯­ä¹‰å’Œä¸Šä¸‹æ–‡ä¿¡æ¯çš„ç‰¹å¾å‘é‡ï¼Œè¿™äº›å‘é‡å°±æ˜¯ç¼–ç å™¨è¾“å‡ºçš„ â€œç â€ã€‚</p>
<ul>
<li>è§£ç å™¨ï¼ˆDecoderï¼‰å¤„ç†</li>
</ul>
<p>åœ¨éœ€è¦ç”Ÿæˆåºåˆ—çš„ä»»åŠ¡ä¸­ï¼ˆå¦‚æœºå™¨ç¿»è¯‘ã€æ–‡æœ¬ç”Ÿæˆï¼‰ï¼Œè§£ç å™¨ä¼šæ ¹æ®ç¼–ç å™¨è¾“å‡ºçš„ â€œç â€ï¼Œç»“åˆå·²ç»ç”Ÿæˆçš„éƒ¨åˆ†ç›®æ ‡åºåˆ—ï¼Œé€æ­¥ç”Ÿæˆç›®æ ‡åºåˆ—ã€‚è§£ç å™¨åŒæ ·åŒ…å«å¤šå¤´è‡ªæ³¨æ„åŠ›æœºåˆ¶å’Œç¼–ç å™¨ - è§£ç å™¨æ³¨æ„åŠ›æœºåˆ¶ï¼Œä»¥åŠå‰é¦ˆç¥ç»ç½‘ç»œã€‚å¤šå¤´è‡ªæ³¨æ„åŠ›æœºåˆ¶å¤„ç†ç›®æ ‡åºåˆ—å†…éƒ¨çš„ä¾èµ–å…³ç³»ï¼Œç¼–ç å™¨ - è§£ç å™¨æ³¨æ„åŠ›æœºåˆ¶è®©è§£ç å™¨èƒ½å¤Ÿå…³æ³¨ç¼–ç å™¨è¾“å‡ºçš„ä¿¡æ¯ã€‚</p>
<p>è§£ç å™¨æœ€ç»ˆè¾“å‡ºçš„æ˜¯ç›®æ ‡åºåˆ—çš„ç‰¹å¾è¡¨ç¤ºï¼Œç»è¿‡åç»­çš„å¤„ç†ï¼ˆå¦‚é€šè¿‡ softmax å‡½æ•°å¾—åˆ°å•è¯çš„æ¦‚ç‡åˆ†å¸ƒï¼‰ï¼Œå¯ä»¥ç”Ÿæˆæœ€ç»ˆçš„ç›®æ ‡åºåˆ—ï¼Œå¦‚ç¿»è¯‘åçš„å¥å­ã€‚</p>
</blockquote>
<h6 id="å½’ä¸€åŒ–å±‚">å½’ä¸€åŒ–å±‚</h6>
<blockquote>
<p>æ·±åº¦å­¦ä¹ ä¸­ä¸åŒå½’ä¸€åŒ–çš„æ–¹æ³•æœ¬è´¨ä¸Šæ˜¯ä¸åŒçš„åˆ†ç»„å¥—è·¯ï¼Œéƒ½æ˜¯ç”¨æ­£æ€åˆ†å¸ƒå½’ä¸€åŒ–çš„å½¢å¼è¿›è¡Œå½’ä¸€ã€‚</p>
</blockquote>
<ol>
<li>ä»€ä¹ˆæ˜¯å½’ä¸€åŒ–ï¼Ÿ</li>
</ol>
<p>å½’ä¸€åŒ–æ˜¯ä¸€ç§æ•°æ®é¢„å¤„ç†æŠ€æœ¯ï¼Œå…¶æ ¸å¿ƒç›®çš„æ˜¯å°†æ•°æ®è½¬æ¢åˆ°ç‰¹å®šèŒƒå›´æˆ–å…·æœ‰ç‰¹å®šåˆ†å¸ƒï¼Œä»¥æ”¹å–„æ•°æ®çš„æ€§è´¨ï¼Œæå‡æ¨¡å‹çš„è®­ç»ƒæ•ˆæœå’Œç¨³å®šæ€§ã€‚</p>
<p>å¦‚æœä¸è¿›è¡Œå½’ä¸€åŒ–ï¼Œå¯èƒ½ä¼šäº§ç”Ÿä»¥ä¸‹ä¸è‰¯åæœï¼š</p>
<p><strong>1.è®­ç»ƒä¸ç¨³å®š</strong></p>
<ul>
<li><strong>æ¢¯åº¦æ¶ˆå¤±æˆ–çˆ†ç‚¸</strong>ï¼šåœ¨æ·±åº¦ç¥ç»ç½‘ç»œçš„åå‘ä¼ æ’­è¿‡ç¨‹ä¸­ï¼Œå‚æ•°çš„æ¢¯åº¦ä¼šéšç€ç½‘ç»œå±‚æ•°çš„å¢åŠ è€Œå‡ºç°ä¸ç¨³å®šçš„æƒ…å†µã€‚è‹¥ä¸è¿›è¡Œå½’ä¸€åŒ–ï¼Œè¾“å…¥æ•°æ®çš„å°ºåº¦å·®å¼‚è¾ƒå¤§ï¼Œä¼šå¯¼è‡´æ¢¯åº¦åœ¨ä¼ æ’­è¿‡ç¨‹ä¸­å˜å¾—è¿‡å¤§æˆ–è¿‡å°ã€‚æ¢¯åº¦çˆ†ç‚¸ä¼šä½¿å‚æ•°æ›´æ–°å¹…åº¦è¿‡å¤§ï¼Œæ¨¡å‹éš¾ä»¥æ”¶æ•›ï¼›æ¢¯åº¦æ¶ˆå¤±åˆ™ä¼šä½¿å‚æ•°å‡ ä¹ä¸æ›´æ–°ï¼Œæ¨¡å‹æ— æ³•å­¦ä¹ åˆ°æœ‰æ•ˆçš„ç‰¹å¾ã€‚</li>
<li><strong>å­¦ä¹ ç‡é€‰æ‹©å›°éš¾</strong>ï¼šæ²¡æœ‰å½’ä¸€åŒ–æ—¶ï¼Œä¸åŒç‰¹å¾çš„å°ºåº¦ä¸åŒï¼Œåˆé€‚çš„å­¦ä¹ ç‡éš¾ä»¥ç¡®å®šã€‚å­¦ä¹ ç‡è¿‡å¤§å¯èƒ½å¯¼è‡´æ¨¡å‹åœ¨å¤§å°ºåº¦ç‰¹å¾ä¸Šæ›´æ–°è¿‡å¿«ï¼Œè·³è¿‡æœ€ä¼˜è§£ï¼›å­¦ä¹ ç‡è¿‡å°åˆ™ä¼šä½¿æ¨¡å‹åœ¨å°å°ºåº¦ç‰¹å¾ä¸Šå­¦ä¹ è¿‡æ…¢ï¼Œè®­ç»ƒæ•ˆç‡ä½ä¸‹ã€‚</li>
</ul>
<p><strong>2.æ”¶æ•›é€Ÿåº¦æ…¢</strong></p>
<ul>
<li><strong>ä¼˜åŒ–è·¯å¾„æ›²æŠ˜</strong>ï¼šæœªå½’ä¸€åŒ–çš„æ•°æ®ä¼šä½¿æŸå¤±å‡½æ•°çš„å½¢çŠ¶å˜å¾—å¤æ‚ï¼Œä¼˜åŒ–ç®—æ³•åœ¨å¯»æ‰¾æœ€ä¼˜è§£æ—¶ä¼šèµ°å¾ˆå¤šå¼¯è·¯ï¼Œå¯¼è‡´æ”¶æ•›é€Ÿåº¦å˜æ…¢ã€‚ä¾‹å¦‚ï¼Œåœ¨æ¢¯åº¦ä¸‹é™è¿‡ç¨‹ä¸­ï¼Œå‚æ•°æ›´æ–°çš„æ–¹å‘å¯èƒ½ä¼šé¢‘ç¹å˜åŒ–ï¼Œéœ€è¦æ›´å¤šçš„è¿­ä»£æ¬¡æ•°æ‰èƒ½è¾¾åˆ°è¾ƒå¥½çš„æ•ˆæœã€‚</li>
</ul>
<p><strong>3.æ¨¡å‹æ€§èƒ½ä¸‹é™</strong></p>
<ul>
<li><strong>ç‰¹å¾é‡è¦æ€§å¤±è¡¡</strong>ï¼šå°ºåº¦è¾ƒå¤§çš„ç‰¹å¾åœ¨æ¨¡å‹è®­ç»ƒä¸­å¯èƒ½ä¼šå æ®ä¸»å¯¼åœ°ä½ï¼Œè€Œå°ºåº¦è¾ƒå°çš„ç‰¹å¾å¯èƒ½ä¼šè¢«å¿½ç•¥ï¼Œå¯¼è‡´æ¨¡å‹æ— æ³•å……åˆ†åˆ©ç”¨æ‰€æœ‰ç‰¹å¾çš„ä¿¡æ¯ï¼Œä»è€Œå½±å“æ¨¡å‹çš„æ€§èƒ½ã€‚</li>
<li><strong>æ³›åŒ–èƒ½åŠ›å·®</strong>ï¼šæœªå½’ä¸€åŒ–çš„æ•°æ®å¯èƒ½ä¼šä½¿æ¨¡å‹å¯¹è®­ç»ƒæ•°æ®ä¸­çš„å™ªå£°å’Œå¼‚å¸¸å€¼æ›´åŠ æ•æ„Ÿï¼Œå¯¼è‡´æ¨¡å‹åœ¨è®­ç»ƒé›†ä¸Šè¡¨ç°è‰¯å¥½ï¼Œä½†åœ¨æµ‹è¯•é›†ä¸Šçš„æ³›åŒ–èƒ½åŠ›è¾ƒå·®ï¼Œå®¹æ˜“å‡ºç°è¿‡æ‹Ÿåˆç°è±¡ã€‚</li>
</ul>
<ol start="2">
<li><code>nn.BatchNorm1d/2d/3d</code> æ‰¹é‡å½’ä¸€åŒ–ï¼šæ‰¹ç»´åº¦å½’ä¸€åŒ–</li>
</ol>
<p><code>nn.BatchNorm1d</code>ã€<code>nn.BatchNorm2d</code></p>
<p>å’Œ<code>nn.BatchNorm3d</code>æ˜¯PyTorchä¸­ç”¨äºå®ç°æ‰¹é‡å½’ä¸€åŒ–ï¼ˆBatch Normalizationï¼‰çš„æ¨¡å—ï¼Œå®ƒä»¬åˆ†åˆ«é€‚ç”¨äºä¸åŒç»´åº¦çš„è¾“å…¥æ•°æ®ã€‚æ‰¹é‡å½’ä¸€åŒ–æ˜¯ä¸€ç§åœ¨æ·±åº¦å­¦ä¹ ä¸­å¹¿æ³›ä½¿ç”¨çš„æŠ€æœ¯ï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯å¯¹æ¯ä¸€æ‰¹æ¬¡çš„æ•°æ®è¿›è¡Œå½’ä¸€åŒ–å¤„ç†ï¼Œä½¿å¾—æ•°æ®åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­å…·æœ‰ç¨³å®šçš„åˆ†å¸ƒï¼Œä»è€ŒåŠ é€Ÿæ¨¡å‹çš„æ”¶æ•›é€Ÿåº¦ï¼Œæé«˜æ¨¡å‹çš„ç¨³å®šæ€§å’Œæ³›åŒ–èƒ½åŠ›ã€‚</p>
<blockquote>
<p>æ‰¹é‡å½’ä¸€åŒ–çš„åŸºæœ¬æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ul>
<li>å¯¹äºè¾“å…¥æ•°æ®çš„æ¯ä¸ªç‰¹å¾ç»´åº¦ï¼Œè®¡ç®—è¯¥æ‰¹æ¬¡æ•°æ®åœ¨è¯¥ç»´åº¦ä¸Šçš„å‡å€¼$\mu$å’Œæ–¹å·®$\sigma ^2$ã€‚</li>
<li>ä½¿ç”¨è®¡ç®—å¾—åˆ°çš„å‡å€¼å’Œæ–¹å·®å¯¹æ•°æ®è¿›è¡Œå½’ä¸€åŒ–å¤„ç†ï¼Œå…¬å¼ä¸ºï¼š$\hat{x_i}=\frac{x_i-\mu}{\sqrt{\sigma ^2 +\epsilon}}$ï¼Œå…¶ä¸­$x_i$æ˜¯è¾“å…¥æ•°æ®ï¼Œ$\epsilon$ æ˜¯ä¸€ä¸ªå¾ˆå°çš„å¸¸æ•°ï¼Œç”¨äºé¿å…åˆ†æ¯ä¸ºé›¶ã€‚</li>
<li>å¯¹å½’ä¸€åŒ–åçš„æ•°æ®è¿›è¡Œç¼©æ”¾å’Œå¹³ç§»æ“ä½œï¼Œå…¬å¼ä¸ºï¼š$y_i=\gamma \hat{x_i}+\beta$ï¼Œå…¶ä¸­$\gamma$å’Œ$\beta$æ˜¯å¯å­¦ä¹ çš„å‚æ•°ï¼Œåˆ†åˆ«ç”¨äºæ§åˆ¶ç¼©æ”¾å’Œå¹³ç§»çš„ç¨‹åº¦ã€‚</li>
</ul>
</blockquote>
<p><strong>ä¸åŒç»´åº¦çš„é€‚ç”¨åœºæ™¯</strong></p>
<ul>
<li><strong><code>nn.BatchNorm1d</code></strong>ï¼šé€šå¸¸ç”¨äºå¤„ç†ä¸€ç»´æ•°æ®ï¼Œå¦‚å…¨è¿æ¥å±‚çš„è¾“å‡ºæˆ–ä¸€ç»´åºåˆ—æ•°æ®ã€‚è¾“å…¥æ•°æ®çš„å½¢çŠ¶ä¸€èˆ¬ä¸º <code>(N, C)</code> æˆ– <code>(N, C, L)</code>ï¼Œå…¶ä¸­ æ˜¯æ‰¹é‡å¤§å°ï¼Œ æ˜¯ç‰¹å¾ç»´åº¦ï¼Œ æ˜¯åºåˆ—é•¿åº¦ã€‚</li>
<li><strong><code>nn.BatchNorm2d</code></strong>ï¼šä¸»è¦ç”¨äºå¤„ç†äºŒç»´æ•°æ®ï¼Œå¦‚å·ç§¯å±‚çš„è¾“å‡ºã€‚è¾“å…¥æ•°æ®çš„å½¢çŠ¶é€šå¸¸ä¸º <code>(N, C, H, W)</code>ï¼Œå…¶ä¸­ æ˜¯æ‰¹é‡å¤§å°ï¼Œ æ˜¯é€šé“æ•°ï¼Œ å’Œ åˆ†åˆ«æ˜¯ç‰¹å¾å›¾çš„é«˜åº¦å’Œå®½åº¦ã€‚</li>
<li><strong><code>nn.BatchNorm3d</code></strong>ï¼šé€‚ç”¨äºå¤„ç†ä¸‰ç»´æ•°æ®ï¼Œå¦‚ 3D å·ç§¯å±‚çš„è¾“å‡ºã€‚è¾“å…¥æ•°æ®çš„å½¢çŠ¶ä¸€èˆ¬ä¸º <code>(N, C, D, H, W)</code>ï¼Œå…¶ä¸­ æ˜¯æ‰¹é‡å¤§å°ï¼Œ æ˜¯é€šé“æ•°ï¼Œ æ˜¯æ·±åº¦ï¼Œ å’Œ åˆ†åˆ«æ˜¯ç‰¹å¾å›¾çš„é«˜åº¦å’Œå®½åº¦ã€‚</li>
</ul>
<ol start="2">
<li><code>nn.LayerNorm</code> å±‚å½’ä¸€åŒ–ï¼šé€šé“ç»´åº¦å½’ä¸€åŒ–</li>
</ol>
<p><code>nn.LayerNorm</code> æ˜¯ PyTorch ä¸­ç”¨äºå®ç°å±‚å½’ä¸€åŒ–ï¼ˆLayer Normalizationï¼‰çš„æ¨¡å—ã€‚ä¸æ‰¹é‡å½’ä¸€åŒ–ï¼ˆBatch Normalizationï¼‰ä¸åŒï¼Œå±‚å½’ä¸€åŒ–æ˜¯åœ¨<strong>å•ä¸ªæ ·æœ¬</strong>ä¸Šå¯¹æ‰€æœ‰ç‰¹å¾è¿›è¡Œå½’ä¸€åŒ–æ“ä½œï¼Œè€Œä¸æ˜¯åœ¨æ‰¹æ¬¡ç»´åº¦ä¸Šè¿›è¡Œã€‚å®ƒåœ¨å¤„ç†å˜é•¿åºåˆ—æ•°æ®ä»¥åŠä¸€äº›å¯¹æ‰¹æ¬¡å¤§å°æ•æ„Ÿçš„ä»»åŠ¡ä¸­è¡¨ç°å‡ºè‰²ï¼Œèƒ½æœ‰æ•ˆç¼“è§£æ¢¯åº¦æ¶ˆå¤±æˆ–çˆ†ç‚¸é—®é¢˜ï¼Œä½¿æ¨¡å‹è®­ç»ƒæ›´åŠ ç¨³å®šã€‚</p>
<ol start="3">
<li><code>nn.InstanceNorm1d/2d/3d</code> å®ä¾‹å½’ä¸€åŒ–ï¼šå•æ ·æœ¬å½’ä¸€åŒ–ï¼ˆé£æ ¼è¿ç§»ï¼‰</li>
</ol>
<p>å®ä¾‹å½’ä¸€åŒ–çš„æ ¸å¿ƒæ€æƒ³æ˜¯å¯¹æ¯ä¸ªæ ·æœ¬çš„æ¯ä¸ªé€šé“åˆ†åˆ«è¿›è¡Œå½’ä¸€åŒ–æ“ä½œã€‚å¯¹äºè¾“å…¥æ•°æ®ä¸­çš„æ¯ä¸ªæ ·æœ¬çš„æ¯ä¸ªé€šé“ï¼Œè®¡ç®—å…¶å‡å€¼å’Œæ–¹å·®ï¼Œç„¶åè¿›è¡Œå½’ä¸€åŒ–å¤„ç†ï¼Œæœ€åé€šè¿‡å¯å­¦ä¹ çš„å‚æ•°è¿›è¡Œç¼©æ”¾å’Œå¹³ç§»ã€‚</p>
<ol start="4">
<li><code>nn.GroupNorm</code> ç»„å½’ä¸€åŒ–ï¼šåˆ†ç»„å½’ä¸€åŒ–ï¼ˆå°æ‰¹é‡é€‚ç”¨ï¼‰</li>
</ol>
<p><code>nn.GroupNorm</code> æ˜¯ PyTorch ä¸­ç”¨äºå®ç°ç»„å½’ä¸€åŒ–ï¼ˆGroup Normalizationï¼‰çš„æ¨¡å—ã€‚å®ƒæ˜¯ä¸€ç§ä»‹äºæ‰¹é‡å½’ä¸€åŒ–ï¼ˆBatch Normalizationï¼‰å’Œå±‚å½’ä¸€åŒ–ï¼ˆLayer Normalizationï¼‰ä¹‹é—´çš„å½’ä¸€åŒ–æ–¹æ³•ï¼Œå°¤å…¶é€‚ç”¨äºå°æ‰¹é‡æ•°æ®çš„æƒ…å†µã€‚æ‰¹é‡å½’ä¸€åŒ–åœ¨å°æ‰¹é‡æ—¶ï¼Œç”±äºæ ·æœ¬æ•°é‡å°‘ï¼Œè®¡ç®—çš„å‡å€¼å’Œæ–¹å·®ä¸ç¨³å®šï¼Œå½±å“å½’ä¸€åŒ–æ•ˆæœï¼›è€Œç»„å½’ä¸€åŒ–é€šè¿‡å°†é€šé“åˆ†ç»„ï¼Œåœ¨ç»„å†…è¿›è¡Œå½’ä¸€åŒ–ï¼Œå‡å°‘äº†å¯¹æ‰¹é‡å¤§å°çš„ä¾èµ–ã€‚</p>
<h6 id="æ¿€æ´»å‡½æ•°">æ¿€æ´»å‡½æ•°</h6>
<p>1.ä»€ä¹ˆæ˜¯æ¿€æ´»å‡½æ•°ï¼Ÿ</p>
<p>æ¿€æ´»å‡½æ•°æ˜¯ç¥ç»ç½‘ç»œä¸­ä¸€ä¸ªå…³é”®ç»„ä»¶ï¼Œå®ƒæ˜¯ä¸€ç§éçº¿æ€§å‡½æ•°ï¼Œç”¨äºå¯¹ç¥ç»å…ƒçš„è¾“å…¥è¿›è¡Œè½¬æ¢å¹¶äº§ç”Ÿè¾“å‡ºã€‚åœ¨ç¥ç»ç½‘ç»œé‡Œï¼Œæ¯ä¸ªç¥ç»å…ƒæ¥æ”¶è¾“å…¥ä¿¡å·ï¼Œæ¿€æ´»å‡½æ•°ä¼šå¯¹è¿™äº›è¾“å…¥è¿›è¡Œå¤„ç†ï¼Œå†³å®šè¯¥ç¥ç»å…ƒæ˜¯å¦è¢«æ¿€æ´»ä»¥åŠæ¿€æ´»çš„ç¨‹åº¦ï¼Œä»è€Œå°†å¤„ç†åçš„ç»“æœä¼ é€’ç»™ä¸‹ä¸€å±‚ç¥ç»å…ƒã€‚</p>
<ul>
<li>å¼•å…¥éçº¿æ€§</li>
</ul>
<p>è‹¥æ²¡æœ‰æ¿€æ´»å‡½æ•°ï¼Œæ— è®ºç¥ç»ç½‘ç»œæœ‰å¤šå°‘å±‚ï¼Œå…¶æ•´ä½“éƒ½åªæ˜¯ä¸€ä¸ªçº¿æ€§ç»„åˆï¼Œåªèƒ½å­¦ä¹ åˆ°çº¿æ€§å…³ç³»ã€‚è€Œç°å®ä¸–ç•Œä¸­çš„è®¸å¤šé—®é¢˜ï¼Œå¦‚è¯­éŸ³è¯†åˆ«ã€å›¾åƒåˆ†ç±»ç­‰ï¼Œéƒ½å…·æœ‰å¤æ‚çš„éçº¿æ€§ç‰¹å¾ã€‚æ¿€æ´»å‡½æ•°é€šè¿‡å¼•å…¥éçº¿æ€§å› ç´ ï¼Œè®©ç¥ç»ç½‘ç»œèƒ½å¤Ÿå­¦ä¹ å’Œè¡¨ç¤ºä»»æ„å¤æ‚çš„å‡½æ•°ï¼Œä»è€Œå¯ä»¥å¤„ç†æ›´å¹¿æ³›å’Œå¤æ‚çš„ä»»åŠ¡ã€‚</p>
<ul>
<li>ç‰¹å¾æå–å’Œè½¬æ¢</li>
</ul>
<p>æ¿€æ´»å‡½æ•°å¯ä»¥å¯¹è¾“å…¥æ•°æ®è¿›è¡Œç‰¹å¾æå–å’Œè½¬æ¢ã€‚ä¸åŒçš„æ¿€æ´»å‡½æ•°å…·æœ‰ä¸åŒçš„ç‰¹æ€§ï¼Œèƒ½å¤Ÿçªå‡ºæ•°æ®ä¸­çš„æŸäº›ç‰¹å¾ï¼ŒæŠ‘åˆ¶å…¶ä»–ç‰¹å¾ã€‚ä¾‹å¦‚ï¼ŒReLU å‡½æ•°å¯ä»¥å°†è´Ÿæ•°è¾“å…¥ç½®ä¸º 0ï¼Œåªä¿ç•™æ­£æ•°è¾“å…¥ï¼Œè¿™æœ‰åŠ©äºç½‘ç»œå…³æ³¨é‡è¦çš„ç‰¹å¾ï¼Œå‡å°‘å™ªå£°çš„å½±å“ã€‚</p>
<ul>
<li>æ§åˆ¶ç¥ç»å…ƒçš„æ´»è·ƒåº¦</li>
</ul>
<p>æ¿€æ´»å‡½æ•°å¯ä»¥æ§åˆ¶ç¥ç»å…ƒçš„æ¿€æ´»çŠ¶æ€ï¼Œé¿å…ç¥ç»å…ƒçš„è¾“å‡ºè¿‡å¤§æˆ–è¿‡å°ã€‚ä¾‹å¦‚ï¼ŒSigmoid å‡½æ•°å°†è¾“å…¥æ˜ å°„åˆ° (0, 1) åŒºé—´ï¼ŒTanh å‡½æ•°å°†è¾“å…¥æ˜ å°„åˆ° (-1, 1) åŒºé—´ï¼Œè¿™æ ·å¯ä»¥ä½¿ç¥ç»å…ƒçš„è¾“å‡ºä¿æŒåœ¨ä¸€ä¸ªåˆç†çš„èŒƒå›´å†…ï¼Œæœ‰åŠ©äºæ¨¡å‹çš„ç¨³å®šè®­ç»ƒã€‚</p>
<ul>
<li>æé«˜æ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›</li>
</ul>
<p>åˆé€‚çš„æ¿€æ´»å‡½æ•°å¯ä»¥å¸®åŠ©æ¨¡å‹æ›´å¥½åœ°å­¦ä¹ æ•°æ®çš„åˆ†å¸ƒï¼Œå‡å°‘è¿‡æ‹Ÿåˆçš„é£é™©ï¼Œä»è€Œæé«˜æ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›ã€‚ä¾‹å¦‚ï¼Œ$Leaky ReLU$å‡½æ•°é€šè¿‡åœ¨è´Ÿæ•°åŒºé—´ä¿ç•™ä¸€ä¸ªå°çš„æ¢¯åº¦ï¼Œé¿å…äº†â€œæ­»äº¡ReLUâ€é—®é¢˜ï¼Œä½¿æ¨¡å‹èƒ½å¤Ÿæ›´æœ‰æ•ˆåœ°å­¦ä¹ å’Œæ³›åŒ–ã€‚</p>
<p>2.<code>nn.ReLU</code> ReLUï¼š$max(0, x)$</p>
<p><code>nn.ReLU</code> æ˜¯$PyTorch$ä¸­å®ç°ä¿®æ­£çº¿æ€§å•å…ƒï¼ˆRectified Linear Unitï¼ŒReLUï¼‰æ¿€æ´»å‡½æ•°çš„æ¨¡å—ã€‚$ReLU$å‡½æ•°çš„æ•°å­¦è¡¨è¾¾å¼ä¸º$f(x)=max(0,x)$ï¼Œå³å¯¹äºè¾“å…¥$x$ï¼Œå¦‚æœ$x$å¤§äº0ï¼Œåˆ™è¾“å‡º$x$ï¼›å¦‚æœ$x$å°äºç­‰äº 0ï¼Œåˆ™è¾“å‡º0ã€‚</p>
<p>ReLU å‡½æ•°åœ¨æ·±åº¦å­¦ä¹ ä¸­åº”ç”¨å¹¿æ³›ï¼Œå°¤å…¶åœ¨å·ç§¯ç¥ç»ç½‘ç»œï¼ˆCNNï¼‰å’Œå¤šå±‚æ„ŸçŸ¥æœºï¼ˆMLPï¼‰ä¸­ç»å¸¸è¢«ä½¿ç”¨ã€‚ä¾‹å¦‚ï¼Œåœ¨å›¾åƒåˆ†ç±»ä»»åŠ¡ä¸­ï¼Œè®¸å¤šæµè¡Œçš„CNNæ¶æ„ï¼ˆå¦‚ AlexNetã€VGG ç­‰ï¼‰éƒ½å¤§é‡ä½¿ç”¨äº† ReLU æ¿€æ´»å‡½æ•°ï¼Œä»¥æé«˜æ¨¡å‹çš„è®­ç»ƒæ•ˆç‡å’Œæ€§èƒ½ã€‚</p>
<p><strong>ä¼˜ç‚¹</strong></p>
<ul>
<li><strong>è®¡ç®—ç®€å•</strong>ï¼šReLU å‡½æ•°åªéœ€è¦è¿›è¡Œä¸€æ¬¡æ¯”è¾ƒæ“ä½œï¼Œè®¡ç®—é€Ÿåº¦å¿«ï¼Œèƒ½æ˜¾è‘—å‡å°‘è®­ç»ƒæ—¶é—´ã€‚</li>
<li><strong>ç¼“è§£æ¢¯åº¦æ¶ˆå¤±é—®é¢˜</strong>ï¼šåœ¨æ­£åŒºé—´å†…ï¼ŒReLU å‡½æ•°çš„å¯¼æ•°æ’ä¸º 1ï¼Œé¿å…äº†åƒ Sigmoid å’Œ Tanh å‡½æ•°é‚£æ ·åœ¨è¾“å…¥å€¼å¾ˆå¤§æˆ–å¾ˆå°æ—¶æ¢¯åº¦è¶‹è¿‘äº 0 çš„é—®é¢˜ï¼Œä½¿å¾—ç¥ç»ç½‘ç»œçš„è®­ç»ƒæ›´åŠ é«˜æ•ˆã€‚</li>
<li><strong>ç¨€ç–æ€§</strong>ï¼šReLU å‡½æ•°ä¼šä½¿ä¸€éƒ¨åˆ†ç¥ç»å…ƒçš„è¾“å‡ºä¸º 0ï¼Œä»è€Œäº§ç”Ÿç¨€ç–æ¿€æ´»ï¼Œè¿™æœ‰åŠ©äºå‡å°‘ç¥ç»å…ƒä¹‹é—´çš„ç›¸äº’ä¾èµ–ï¼Œæé«˜æ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›ã€‚</li>
</ul>
<p><strong>ç¼ºç‚¹</strong></p>
<ul>
<li><strong>æ­»äº¡ ReLU é—®é¢˜</strong>ï¼šå½“è¾“å…¥å€¼å°äºç­‰äº 0 æ—¶ï¼ŒReLU å‡½æ•°çš„å¯¼æ•°ä¸º 0ï¼Œè¿™å¯èƒ½å¯¼è‡´ç¥ç»å…ƒåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­æ°¸è¿œä¸ä¼šè¢«æ¿€æ´»ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„ â€œæ­»äº¡ ReLUâ€ã€‚ä¸€æ—¦æŸä¸ªç¥ç»å…ƒè¿›å…¥è¿™ç§çŠ¶æ€ï¼Œå®ƒå°†ä¸å†å¯¹åç»­çš„è¾“å…¥äº§ç”Ÿå“åº”ï¼Œæ¢¯åº¦ä¹Ÿæ— æ³•é€šè¿‡è¯¥ç¥ç»å…ƒè¿›è¡Œåå‘ä¼ æ’­ã€‚</li>
<li><strong>è¾“å‡ºä¸ä»¥ 0 ä¸ºä¸­å¿ƒ</strong>ï¼šReLU å‡½æ•°çš„è¾“å‡ºå€¼å‡ä¸ºéè´Ÿæ•°ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´æ¨¡å‹æ”¶æ•›é€Ÿåº¦å˜æ…¢ï¼Œå› ä¸ºå®ƒä¼šä½¿æƒé‡æ›´æ–°çš„æ–¹å‘éƒ½åå‘åŒä¸€ä¾§ã€‚</li>
</ul>
<p>3.<code>nn.LeakyReLU</code>$ LeakyReLU$ï¼š$max(Î±x, x)$</p>
<p><code>nn.LeakyReLU</code> æ˜¯ PyTorch é‡Œå®ç° Leaky ReLU æ¿€æ´»å‡½æ•°çš„æ¨¡å—ã€‚Leaky ReLU æ˜¯å¯¹ ReLU çš„æ”¹è¿›ï¼Œå…¶æ•°å­¦è¡¨è¾¾å¼ä¸º<img src="/%E6%89%8B%E6%92%95%E7%9F%A5%E8%AF%86%E5%BA%93/QianJianTec1740557269940.png" alt="QianJianTec1740557269940"></p>
<p>å…¶ä¸­$\alpha$ æ˜¯ä¸€ä¸ªè¾ƒå°çš„æ­£æ•°ï¼ˆé€šå¸¸å–å€¼ä¸º 0.01ï¼‰ã€‚ä¸ ReLU ä¸åŒçš„æ˜¯ï¼Œå½“è¾“å…¥$x$ä¸ºè´Ÿæ•°æ—¶ï¼Œ$Leaky ReLU$ä¸ä¼šå°†å…¶è¾“å‡ºç½®ä¸º0ï¼Œè€Œæ˜¯ä¹˜ä»¥ä¸€ä¸ªå°çš„æ–œç‡ ï¼Œä»è€Œä¿ç•™äº†ä¸€å®šçš„æ¢¯åº¦ã€‚</p>
<p>LeakyReLU å¸¸ç”¨äºå„ç§æ·±åº¦å­¦ä¹ ä»»åŠ¡ä¸­ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†å¯èƒ½å‡ºç°å¤§é‡è´Ÿæ•°è¾“å…¥çš„æƒ…å†µæ—¶è¡¨ç°å‡ºè‰²ã€‚ä¾‹å¦‚åœ¨ç”Ÿæˆå¯¹æŠ—ç½‘ç»œï¼ˆGANï¼‰ä¸­ï¼ŒLeakyReLU å¯ä»¥å¸®åŠ©ç¼“è§£æ¢¯åº¦æ¶ˆå¤±é—®é¢˜ï¼Œä½¿ç”Ÿæˆå™¨å’Œåˆ¤åˆ«å™¨èƒ½å¤Ÿæ›´ç¨³å®šåœ°è®­ç»ƒï¼Œæé«˜ç”Ÿæˆå›¾åƒçš„è´¨é‡ã€‚</p>
<p><strong>ä¼˜ç‚¹</strong></p>
<ul>
<li><strong>è§£å†³æ­»äº¡ ReLU é—®é¢˜</strong>ï¼šç”±äºåœ¨è´Ÿæ•°åŒºé—´ä¿ç•™äº†ä¸€ä¸ªå°çš„æ¢¯åº¦ï¼ˆï¼‰ï¼Œå³ä½¿è¾“å…¥ä¸ºè´Ÿæ•°ï¼Œç¥ç»å…ƒä¹Ÿä¸ä¼šå®Œå…¨ â€œæ­»äº¡â€ï¼Œèƒ½å¤Ÿç»§ç»­å‚ä¸è®­ç»ƒå’Œæ¢¯åº¦ä¼ æ’­ï¼Œé¿å…äº†éƒ¨åˆ†ç¥ç»å…ƒæ°¸ä¹…å¤±æ•ˆçš„æƒ…å†µï¼Œæé«˜äº†æ¨¡å‹çš„ç¨³å®šæ€§ã€‚</li>
<li><strong>è®¡ç®—ç®€å•</strong>ï¼šå’Œ ReLU ä¸€æ ·ï¼ŒLeakyReLU çš„è®¡ç®—ç›¸å¯¹ç®€å•ï¼Œä¸ä¼šæ˜¾è‘—å¢åŠ è®¡ç®—é‡ï¼Œä¿è¯äº†è®­ç»ƒçš„é«˜æ•ˆæ€§ã€‚</li>
</ul>
<p><strong>ç¼ºç‚¹</strong></p>
<ul>
<li><strong>è¶…å‚æ•°é€‰æ‹©é—®é¢˜</strong>ï¼š æ˜¯ä¸€ä¸ªéœ€è¦æ‰‹åŠ¨è°ƒæ•´çš„è¶…å‚æ•°ã€‚å¦‚æœ é€‰æ‹©ä¸å½“ï¼Œå¯èƒ½ä¼šå½±å“æ¨¡å‹çš„æ€§èƒ½ã€‚ä¾‹å¦‚ï¼Œ è¿‡å¤§å¯èƒ½ä¼šä½¿LeakyReLUé€€åŒ–ä¸ºçº¿æ€§å‡½æ•°ï¼Œå¤±å»å¼•å…¥éçº¿æ€§çš„ä½œç”¨ï¼› è¿‡å°åˆ™å¯èƒ½æ— æ³•æœ‰æ•ˆè§£å†³æ­»äº¡ReLUé—®é¢˜ã€‚</li>
</ul>
<p>4.<code>nn.Sigmoid</code> Sigmoidï¼š$\frac{1}{1 + e^{-x}}$</p>
<p><code>nn.Sigmoid</code> æ˜¯PyTorchä¸­ç”¨äºå®ç°Sigmoidæ¿€æ´»å‡½æ•°çš„æ¨¡å—ã€‚Sigmoidå‡½æ•°çš„æ•°å­¦è¡¨è¾¾å¼ä¸º$\sigma(x)=\frac{1}{1+e^{-x}}$ï¼Œå®ƒèƒ½å°†ä»»æ„å®æ•°è¾“å…¥$x$æ˜ å°„åˆ°$(0,1)$åŒºé—´å†…ã€‚</p>
<p>åœ¨äºŒåˆ†ç±»ä»»åŠ¡çš„è¾“å‡ºå±‚ä½¿ç”¨ Sigmoid å‡½æ•°ï¼Œå°†æ¨¡å‹çš„è¾“å‡ºè½¬æ¢ä¸ºæ¦‚ç‡å€¼ï¼Œä¾¿äºè¿›è¡Œåˆ†ç±»å†³ç­–ã€‚ä¾‹å¦‚ï¼Œåœ¨åˆ¤æ–­é‚®ä»¶æ˜¯å¦ä¸ºåƒåœ¾é‚®ä»¶çš„ä»»åŠ¡ä¸­ï¼ŒSigmoid å‡½æ•°å¯ä»¥è¾“å‡ºé‚®ä»¶ä¸ºåƒåœ¾é‚®ä»¶çš„æ¦‚ç‡ã€‚</p>
<p>åœ¨æ·±åº¦å­¦ä¹ å‘å±•çš„æ—©æœŸï¼ŒSigmoid å‡½æ•°è¢«å¹¿æ³›åº”ç”¨ã€‚ä½†éšç€å¯¹æ¢¯åº¦æ¶ˆå¤±é—®é¢˜çš„è®¤è¯†å’Œå…¶ä»–æ¿€æ´»å‡½æ•°çš„æå‡ºï¼Œç°åœ¨åœ¨æ·±å±‚ç½‘ç»œä¸­ä½¿ç”¨ Sigmoid å‡½æ•°çš„æƒ…å†µç›¸å¯¹è¾ƒå°‘ã€‚</p>
<p><strong>ä¼˜ç‚¹</strong></p>
<ul>
<li><strong>è¾“å‡ºå…·æœ‰æ¦‚ç‡è§£é‡Šæ€§</strong>ï¼šç”±äº Sigmoid å‡½æ•°çš„è¾“å‡ºèŒƒå›´åœ¨$(0,1)$ä¹‹é—´ï¼Œå› æ­¤å¯ä»¥å°†å…¶è¾“å‡ºè§£é‡Šä¸ºæ¦‚ç‡ã€‚åœ¨äºŒåˆ†ç±»é—®é¢˜ä¸­ï¼ŒSigmoid å‡½æ•°å¸¸è¢«ç”¨äºè¾“å‡ºå±‚ï¼Œå°†æ¨¡å‹çš„è¾“å‡ºè½¬æ¢ä¸ºå±äºæŸä¸€ç±»åˆ«çš„æ¦‚ç‡ã€‚</li>
<li><strong>å¹³æ»‘æ€§</strong>ï¼šSigmoid å‡½æ•°æ˜¯è¿ç»­å¯å¯¼çš„ï¼Œå…¶å¯¼æ•°å¯ä»¥é€šè¿‡ç®€å•çš„å…¬å¼è®¡ç®—ï¼š$\sigma^{'}(x)=\sigma(x)(1-\sigma(x))$ã€‚è¿™ç§å¹³æ»‘æ€§ä½¿å¾—å®ƒåœ¨ä½¿ç”¨åŸºäºæ¢¯åº¦çš„ä¼˜åŒ–ç®—æ³•ï¼ˆå¦‚æ¢¯åº¦ä¸‹é™ï¼‰æ—¶éå¸¸æ–¹ä¾¿ã€‚</li>
</ul>
<p><strong>ç¼ºç‚¹</strong></p>
<ul>
<li><strong>æ¢¯åº¦æ¶ˆå¤±é—®é¢˜</strong>ï¼šå½“è¾“å…¥å€¼éå¸¸å¤§æˆ–éå¸¸å°æ—¶ï¼ŒSigmoid å‡½æ•°çš„å¯¼æ•°è¶‹è¿‘äº 0ã€‚åœ¨æ·±åº¦ç¥ç»ç½‘ç»œçš„åå‘ä¼ æ’­è¿‡ç¨‹ä¸­ï¼Œè¿™ä¼šå¯¼è‡´æ¢¯åº¦åœ¨ä¼ æ’­è¿‡ç¨‹ä¸­é€æ¸æ¶ˆå¤±ï¼Œä½¿å¾—æ¨¡å‹éš¾ä»¥å­¦ä¹ åˆ°æœ‰æ•ˆçš„ç‰¹å¾ï¼Œå°¤å…¶æ˜¯åœ¨ç½‘ç»œå±‚æ•°è¾ƒå¤šçš„æƒ…å†µä¸‹ï¼Œè®­ç»ƒä¼šå˜å¾—éå¸¸å›°éš¾ã€‚</li>
<li><strong>è¾“å‡ºä¸ä»¥ 0 ä¸ºä¸­å¿ƒ</strong>ï¼šSigmoid å‡½æ•°çš„è¾“å‡ºå§‹ç»ˆä¸ºæ­£æ•°ï¼Œè¿™ä¼šå¯¼è‡´åœ¨åå‘ä¼ æ’­è¿‡ç¨‹ä¸­ï¼Œæƒé‡æ›´æ–°çš„æ–¹å‘éƒ½åå‘åŒä¸€ä¾§ï¼Œä½¿å¾—æ”¶æ•›é€Ÿåº¦å˜æ…¢ã€‚</li>
</ul>
<p>5.<code>nn.Tanh</code> Tanhï¼š$\frac{e^x - e^{-x}}{e^x + e^{-x}}$</p>
<p><code>nn.Tanh</code>æ˜¯PyTorché‡Œå®ç°åŒæ›²æ­£åˆ‡æ¿€æ´»å‡½æ•°ï¼ˆTanhï¼‰çš„æ¨¡å—ã€‚Tanh å‡½æ•°çš„æ•°å­¦è¡¨è¾¾å¼ä¸º$tanh(x)=\frac{e^x-e^{-x}}{e^x+e^{-x}}$ï¼Œå®ƒèƒ½æŠŠä»»æ„å®æ•°è¾“å…¥$x$æ˜ å°„åˆ°$(-1,1)$åŒºé—´å†…ã€‚</p>
<ul>
<li><strong>å¾ªç¯ç¥ç»ç½‘ç»œï¼ˆRNNï¼‰</strong>ï¼šåœ¨æ—©æœŸçš„ RNN åŠå…¶å˜ä½“ï¼ˆå¦‚ LSTMã€GRUï¼‰ä¸­ï¼ŒTanh å‡½æ•°å¸¸è¢«ç”¨äºéšè—å±‚çš„æ¿€æ´»å‡½æ•°ï¼Œå› ä¸ºå®ƒä»¥ 0 ä¸ºä¸­å¿ƒçš„ç‰¹æ€§æœ‰åŠ©äºç¼“è§£æ¢¯åº¦æ¶ˆå¤±é—®é¢˜ï¼Œä½¿æ¨¡å‹èƒ½å¤Ÿæ›´å¥½åœ°æ•æ‰åºåˆ—æ•°æ®ä¸­çš„é•¿æœŸä¾èµ–å…³ç³»ã€‚</li>
<li><strong>æŸäº›ç‰¹å®šçš„å›å½’é—®é¢˜</strong>ï¼šå½“è¾“å‡ºéœ€è¦åœ¨$(-1,1)$åŒºé—´å†…æ—¶ï¼ŒTanh å‡½æ•°å¯ä»¥ä½œä¸ºä¸€ä¸ªåˆé€‚çš„é€‰æ‹©ã€‚ä¾‹å¦‚ï¼Œåœ¨é¢„æµ‹æŸäº›å…·æœ‰æ­£è´ŸèŒƒå›´çš„æ•°å€¼æ—¶ï¼Œä½¿ç”¨ Tanh å‡½æ•°å¯ä»¥å°†æ¨¡å‹çš„è¾“å‡ºé™åˆ¶åœ¨åˆç†çš„åŒºé—´å†…ã€‚</li>
</ul>
<p><strong>ä¼˜ç‚¹</strong></p>
<ul>
<li><strong>ä»¥ 0 ä¸ºä¸­å¿ƒ</strong>ï¼šä¸ Sigmoid å‡½æ•°ä¸åŒï¼ŒTanh å‡½æ•°çš„è¾“å‡ºèŒƒå›´æ˜¯$(-1,1)$ï¼Œå…³äºåŸç‚¹å¯¹ç§°ã€‚è¿™ä½¿å¾—åœ¨åå‘ä¼ æ’­è¿‡ç¨‹ä¸­ï¼Œæƒé‡æ›´æ–°çš„æ–¹å‘æ›´åŠ çµæ´»ï¼Œæœ‰åŠ©äºæ¨¡å‹æ›´å¿«åœ°æ”¶æ•›ã€‚</li>
<li><strong>å¹³æ»‘å¯å¯¼</strong>ï¼šTanh å‡½æ•°æ˜¯è¿ç»­å¯å¯¼çš„ï¼Œå…¶å¯¼æ•°ä¸º$1-tanh^2(x)$ã€‚è¿™ç§å¹³æ»‘æ€§å¯¹äºåŸºäºæ¢¯åº¦çš„ä¼˜åŒ–ç®—æ³•ï¼ˆå¦‚æ¢¯åº¦ä¸‹é™ï¼‰éå¸¸é‡è¦ï¼Œä¾¿äºè¿›è¡Œæ¢¯åº¦è®¡ç®—å’Œå‚æ•°æ›´æ–°ã€‚</li>
</ul>
<p><strong>ç¼ºç‚¹</strong></p>
<ul>
<li><strong>æ¢¯åº¦æ¶ˆå¤±é—®é¢˜</strong>ï¼šå’Œ Sigmoid å‡½æ•°ç±»ä¼¼ï¼Œå½“è¾“å…¥å€¼éå¸¸å¤§æˆ–éå¸¸å°æ—¶ï¼ŒTanh å‡½æ•°çš„å¯¼æ•°è¶‹è¿‘äº 0ã€‚åœ¨æ·±åº¦ç¥ç»ç½‘ç»œçš„åå‘ä¼ æ’­è¿‡ç¨‹ä¸­ï¼Œè¿™ä¼šå¯¼è‡´æ¢¯åº¦åœ¨ä¼ æ’­è¿‡ç¨‹ä¸­é€æ¸æ¶ˆå¤±ï¼Œä½¿å¾—æ¨¡å‹éš¾ä»¥å­¦ä¹ åˆ°æœ‰æ•ˆçš„ç‰¹å¾ï¼Œå°¤å…¶æ˜¯åœ¨ç½‘ç»œå±‚æ•°è¾ƒå¤šçš„æƒ…å†µä¸‹ï¼Œè®­ç»ƒä¼šå˜å¾—å›°éš¾ã€‚</li>
</ul>
<p>6.<code>nn.GELU</code> GELUï¼šé«˜æ–¯è¯¯å·®çº¿æ€§å•å…ƒï¼ˆTransformer å¸¸ç”¨ï¼‰</p>
<p><code>nn.GELU</code> æ˜¯ PyTorch ä¸­å®ç°é«˜æ–¯è¯¯å·®çº¿æ€§å•å…ƒï¼ˆGaussian Error Linear Unitï¼ŒGELUï¼‰æ¿€æ´»å‡½æ•°çš„æ¨¡å—ã€‚GELU æ˜¯ä¸€ç§éçº¿æ€§æ¿€æ´»å‡½æ•°ï¼Œå®ƒæ ¹æ®è¾“å…¥çš„æ¦‚ç‡æ¥éšæœºå°†è¾“å…¥ç½®ä¸º 0ï¼Œä»è€Œå¼•å…¥äº†éšæœºæ€§å’Œéçº¿æ€§ã€‚å…¶æ•°å­¦è¡¨è¾¾å¼æœ‰å‡ ç§è¿‘ä¼¼å½¢å¼ï¼Œå¸¸è§çš„ä¸€ç§æ˜¯ï¼š</p>
<p>$GELU(x)=xÂ·\phi(x)$</p>
<p>å…¶ä¸­$\phi(x)$æ˜¯æ ‡å‡†æ­£æ€åˆ†å¸ƒçš„ç´¯ç§¯åˆ†å¸ƒå‡½æ•°ï¼Œé€šå¸¸ä½¿ç”¨ä»¥ä¸‹è¿‘ä¼¼å…¬å¼è®¡ç®—ï¼š</p>
<p>$GELU(x)=0.5x(1+tanh(\sqrt{\frac{2}{\pi}}(x+0.044715x^3)))$</p>
<p>å¯¹äºä¸åŒçš„è¾“å…¥å€¼ï¼ŒGELU å‡½æ•°ä¼šæ ¹æ®å…¶è‡ªèº«çš„è®¡ç®—è§„åˆ™è¾“å‡ºç›¸åº”çš„ç»“æœã€‚å½“è¾“å…¥ä¸º 0 æ—¶ï¼Œè¾“å‡ºä¸º 0ï¼›å¯¹äºæ­£æ•°è¾“å…¥ï¼Œè¾“å‡ºä¸ºæ­£ä¸”ä¼šæ ¹æ®è¾“å…¥å¤§å°éçº¿æ€§å˜åŒ–ï¼›å¯¹äºè´Ÿæ•°è¾“å…¥ï¼Œè¾“å‡ºå€¼ä¼šå°äº 0 ä¸”åŒæ ·éµå¾ªéçº¿æ€§è§„å¾‹ã€‚</p>
<p><strong>åº”ç”¨åœºæ™¯</strong></p>
<ul>
<li><strong>Transformer æ¶æ„</strong>ï¼šåœ¨åŸºäº Transformer çš„æ¨¡å‹ï¼ˆå¦‚ BERTã€GPT ç³»åˆ—ç­‰ï¼‰ä¸­ï¼ŒGELU è¢«å¹¿æ³›åº”ç”¨äºå‰é¦ˆç½‘ç»œå±‚ï¼Œæ˜¯è¿™äº›æ¨¡å‹å–å¾—ä¼˜å¼‚æ€§èƒ½çš„å…³é”®å› ç´ ä¹‹ä¸€ã€‚</li>
<li><strong>è‡ªç„¶è¯­è¨€å¤„ç†ä»»åŠ¡</strong>ï¼šç”±äºå…¶èƒ½å¤Ÿæ›´å¥½åœ°å¤„ç†åºåˆ—æ•°æ®ä¸­çš„å¤æ‚å…³ç³»ï¼ŒGELU åœ¨å„ç§è‡ªç„¶è¯­è¨€å¤„ç†ä»»åŠ¡ä¸­å¾—åˆ°äº†å¹¿æ³›åº”ç”¨ï¼Œå¦‚æƒ…æ„Ÿåˆ†æã€å‘½åå®ä½“è¯†åˆ«ç­‰ã€‚</li>
</ul>
<p><strong>ä¼˜ç‚¹</strong></p>
<ul>
<li><strong>æ›´å¥½çš„æ‹Ÿåˆèƒ½åŠ›</strong>ï¼šGELU å‡½æ•°æ¯”ä¼ ç»Ÿçš„æ¿€æ´»å‡½æ•°ï¼ˆå¦‚ ReLUã€Sigmoid ç­‰ï¼‰å…·æœ‰æ›´å¤æ‚çš„éçº¿æ€§ç‰¹æ€§ï¼Œèƒ½å¤Ÿæ›´å¥½åœ°æ‹Ÿåˆå¤æ‚çš„æ•°æ®åˆ†å¸ƒï¼Œä»è€Œæé«˜æ¨¡å‹çš„è¡¨è¾¾èƒ½åŠ›ã€‚</li>
<li><strong>åœ¨ Transformer ä¸­è¡¨ç°å‡ºè‰²</strong>ï¼šåœ¨ Transformer æ¶æ„ä¸­ï¼ŒGELU è¢«å¹¿æ³›ä½¿ç”¨ã€‚å®ƒæœ‰åŠ©äºæ¨¡å‹æ•æ‰åºåˆ—æ•°æ®ä¸­çš„å¤æ‚æ¨¡å¼å’Œä¾èµ–å…³ç³»ï¼Œæå‡æ¨¡å‹åœ¨è‡ªç„¶è¯­è¨€å¤„ç†ä»»åŠ¡ï¼ˆå¦‚æœºå™¨ç¿»è¯‘ã€æ–‡æœ¬åˆ†ç±»ç­‰ï¼‰ä¸­çš„æ€§èƒ½ã€‚</li>
<li><strong>å¹³æ»‘æ€§</strong>ï¼šGELU å‡½æ•°æ˜¯è¿ç»­å¯å¯¼çš„ï¼Œè¿™å¯¹äºåŸºäºæ¢¯åº¦çš„ä¼˜åŒ–ç®—æ³•ï¼ˆå¦‚ Adam ä¼˜åŒ–å™¨ï¼‰éå¸¸å‹å¥½ï¼Œèƒ½å¤Ÿä¿è¯æ¨¡å‹è®­ç»ƒè¿‡ç¨‹çš„ç¨³å®šæ€§ã€‚</li>
</ul>
<p><strong>ç¼ºç‚¹</strong></p>
<ul>
<li><strong>è®¡ç®—å¤æ‚åº¦ç›¸å¯¹è¾ƒé«˜</strong>ï¼šä¸ ReLU ç­‰ç®€å•æ¿€æ´»å‡½æ•°ç›¸æ¯”ï¼ŒGELU çš„è®¡ç®—æ¶‰åŠåˆ°è¾ƒä¸ºå¤æ‚çš„æ•°å­¦è¿ç®—ï¼ˆå¦‚åŒæ›²æ­£åˆ‡å‡½æ•°å’Œå¤šé¡¹å¼è¿ç®—ï¼‰ï¼Œå› æ­¤è®¡ç®—æˆæœ¬ç›¸å¯¹è¾ƒé«˜ï¼Œå¯èƒ½ä¼šå¢åŠ æ¨¡å‹çš„è®­ç»ƒæ—¶é—´å’Œè®¡ç®—èµ„æºæ¶ˆè€—ã€‚</li>
</ul>
<blockquote>
<p><mark>â“ä¸ºä»€ä¹ˆç¥ç»ç½‘ç»œåˆ†ä¸ºè¾“å…¥å±‚ï¼Œéšè—å±‚å’Œè¾“å‡ºå±‚</mark></p>
<p>ç¥ç»ç½‘ç»œçš„è®¾è®¡çµæ„Ÿæ¥æºäºäººç±»çš„ç¥ç»ç³»ç»Ÿã€‚åœ¨äººç±»å¤§è„‘ä¸­ï¼Œæ„Ÿè§‰å™¨å®˜ï¼ˆå¦‚çœ¼ç›ã€è€³æœµï¼‰ç›¸å½“äºè¾“å…¥å±‚ï¼Œè´Ÿè´£æ¥æ”¶å¤–ç•Œçš„ä¿¡æ¯ï¼›å¤§è„‘ä¸­çš„ç¥ç»å…ƒç½‘ç»œè¿›è¡Œå¤æ‚çš„ä¿¡æ¯å¤„ç†å’Œåˆ†æï¼Œç±»ä¼¼äºéšè—å±‚çš„åŠŸèƒ½ï¼›è€Œè¿åŠ¨ç³»ç»Ÿæˆ–å†³ç­–ç³»ç»Ÿåˆ™ç›¸å½“äºè¾“å‡ºå±‚ï¼Œäº§ç”Ÿç›¸åº”çš„è¡Œä¸ºæˆ–å†³ç­–ã€‚å› æ­¤ï¼Œå°†ç¥ç»ç½‘ç»œåˆ†ä¸ºè¾“å…¥å±‚ã€éšè—å±‚å’Œè¾“å‡ºå±‚æ˜¯å¯¹äººç±»ç¥ç»ç³»ç»Ÿå·¥ä½œæ–¹å¼çš„ä¸€ç§æ¨¡æ‹Ÿå’Œç®€åŒ–ã€‚</p>
<p>åŒæ—¶ï¼Œç¥ç»ç½‘ç»œåˆ†ä¸ºè¾“å…¥å±‚ã€éšè—å±‚å’Œè¾“å‡ºå±‚è¿™ç§ç»“æ„ç¬¦åˆä¿¡æ¯å¤„ç†æµç¨‹ï¼šä¿¡æ¯æ¥æ”¶-åŠ å·¥-è¾“å‡º</p>
<p><mark>â“éšè—å±‚ä¸ºä»€ä¹ˆè¦å«éšè—å±‚ï¼ˆä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆæŸäº›å±‚éœ€è¦è¢«â€œéšè—â€ï¼‰</mark></p>
<p>1.<strong>ä¸å¤–ç•Œæ— ç›´æ¥äº¤äº’</strong>ï¼šâ€œéšè—â€ å¹¶ä¸æ˜¯æŒ‡è¿™äº›å±‚åœ¨ç‰©ç†ä¸Šä¸å¯è§ï¼Œè€Œæ˜¯å®ƒä»¬ä¸åƒè¾“å…¥å±‚å’Œè¾“å‡ºå±‚é‚£æ ·ä¸å¤–ç•Œæœ‰ç›´æ¥çš„è”ç³»ã€‚è¾“å…¥å±‚ç›´æ¥æ¥æ”¶å¤–éƒ¨æ•°æ®ï¼Œè¾“å‡ºå±‚ç›´æ¥å°†ç»“æœåé¦ˆç»™å¤–ç•Œï¼Œè€Œéšè—å±‚çš„çŠ¶æ€å’Œè¾“å‡ºå¯¹äºç”¨æˆ·æ¥è¯´é€šå¸¸æ˜¯ä¸å¯ç›´æ¥è§‚å¯Ÿå’Œå¹²é¢„çš„ã€‚å®ƒä»¬ä¸»è¦åœ¨ç½‘ç»œå†…éƒ¨è¿›è¡Œç‰¹å¾æå–å’Œè½¬æ¢ï¼Œæ˜¯ç½‘ç»œå­¦ä¹ è¿‡ç¨‹ä¸­çš„ä¸­é—´æ­¥éª¤ã€‚</p>
<p>2.<strong>è‡ªåŠ¨å­¦ä¹ ç‰¹å¾</strong>ï¼šéšè—å±‚çš„ä¸»è¦ä»»åŠ¡æ˜¯è‡ªåŠ¨å­¦ä¹ æ•°æ®ä¸­çš„ç‰¹å¾è¡¨ç¤ºã€‚è¿™äº›ç‰¹å¾æ˜¯åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ç”±ç½‘ç»œè‡ªåŠ¨å‘ç°å’Œæå–çš„ï¼Œä¸éœ€è¦äººå·¥é¢„å…ˆå®šä¹‰ã€‚ç”±äºéšè—å±‚å­¦ä¹ åˆ°çš„ç‰¹å¾æ˜¯æŠ½è±¡çš„ã€é’ˆå¯¹å…·ä½“ä»»åŠ¡çš„ï¼Œå¹¶ä¸”å¯èƒ½éš¾ä»¥ç”¨äººç±»è¯­è¨€ç›´æ¥æè¿°ï¼Œæ‰€ä»¥è¢«è§†ä¸º â€œéšè—â€ çš„ç‰¹å¾ã€‚ä¾‹å¦‚ï¼Œåœ¨å›¾åƒè¯†åˆ«ä»»åŠ¡ä¸­ï¼Œéšè—å±‚å¯èƒ½å­¦ä¹ åˆ°ä¸€äº›å¯¹äºè¯†åˆ«ç‰©ä½“æœ‰å¸®åŠ©çš„ç‰¹å¾ï¼Œä½†è¿™äº›ç‰¹å¾å¯èƒ½æ— æ³•ç›´è§‚åœ°è¡¨è¾¾å‡ºæ¥ã€‚</p>
</blockquote>
<blockquote>
<p><mark>â“å­¦ä¹ å’Œè¡¨ç¤ºå¤æ‚çš„å‡½æ•°å…³ç³»æœ€åæ˜¯æ€ä¹ˆåæ˜ åˆ°å®é™…é—®é¢˜çš„</mark></p>
<p>ä»¥å›¾åƒåˆ†ç±»ä»»åŠ¡ä¸ºä¾‹è¿›è¡Œç®€è¦åˆ†æã€‚</p>
<p>å›¾åƒåˆ†ç±»æ˜¯æŒ‡å°†è¾“å…¥çš„å›¾åƒåˆ’åˆ†åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªé¢„å®šä¹‰çš„ç±»åˆ«ä¸­ï¼Œä¾‹å¦‚åˆ¤æ–­ä¸€å¼ å›¾ç‰‡æ˜¯çŒ«ã€ç‹—è¿˜æ˜¯å…¶ä»–åŠ¨ç‰©ã€‚è¿™ä¸ªé—®é¢˜çš„å¤æ‚æ€§åœ¨äºå›¾åƒä¸­çš„ç‰©ä½“å¯èƒ½æœ‰ä¸åŒçš„å§¿æ€ã€è§’åº¦ã€å…‰ç…§æ¡ä»¶ç­‰ï¼Œéœ€è¦æ¨¡å‹å­¦ä¹ åˆ°å›¾åƒç‰¹å¾å’Œç±»åˆ«ä¹‹é—´å¤æ‚çš„å‡½æ•°å…³ç³»ã€‚</p>
<p>1.æ•°æ®æ”¶é›†ä¸é¢„å¤„ç†</p>
<ul>
<li>æ”¶é›†å¤§é‡ä¸åŒç±»åˆ«çš„å›¾åƒæ•°æ®ï¼Œä¾‹å¦‚åŒ…å«çŒ«å’Œç‹—çš„å›¾ç‰‡ã€‚</li>
<li>å¯¹å›¾åƒè¿›è¡Œé¢„å¤„ç†ï¼Œå¦‚è°ƒæ•´å¤§å°ã€å½’ä¸€åŒ–ç­‰ï¼Œå°†å›¾åƒæ•°æ®è½¬æ¢ä¸ºé€‚åˆæ¨¡å‹è¾“å…¥çš„æ ¼å¼ã€‚</li>
</ul>
<p>2.æ„å»ºæ¨¡å‹</p>
<p>æ„å»ºä¸€ä¸ªæ·±åº¦ç¥ç»ç½‘ç»œæ¨¡å‹ï¼Œå¦‚å·ç§¯ç¥ç»ç½‘ç»œï¼ˆCNNï¼‰ï¼Œå®ƒå¯ä»¥çœ‹ä½œæ˜¯åœ¨å­¦ä¹ è¾“å…¥å›¾åƒå’Œè¾“å‡ºç±»åˆ«ä¹‹é—´çš„å¤æ‚å‡½æ•°å…³ç³»ã€‚ç½‘ç»œåŒ…å«å¤šä¸ªå·ç§¯å±‚ã€æ± åŒ–å±‚å’Œå…¨è¿æ¥å±‚ï¼Œæ¯ä¸ªå±‚é€šè¿‡ä¸åŒçš„æ“ä½œï¼ˆå¦‚å·ç§¯ã€æ¿€æ´»å‡½æ•°ç­‰ï¼‰æ¥æå–å’Œè½¬æ¢å›¾åƒç‰¹å¾ã€‚</p>
<p>3.æ¨¡å‹è®­ç»ƒ</p>
<ul>
<li>ä½¿ç”¨æ”¶é›†åˆ°çš„å›¾åƒæ•°æ®å’Œå¯¹åº”çš„ç±»åˆ«æ ‡ç­¾å¯¹æ¨¡å‹è¿›è¡Œè®­ç»ƒã€‚åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œæ¨¡å‹é€šè¿‡ä¸æ–­è°ƒæ•´å…¶å†…éƒ¨çš„å‚æ•°ï¼ˆå¦‚å·ç§¯æ ¸çš„æƒé‡ï¼‰ï¼Œä½¿å¾—æ¨¡å‹çš„è¾“å‡ºå°½å¯èƒ½æ¥è¿‘çœŸå®çš„ç±»åˆ«æ ‡ç­¾ã€‚</li>
<li>ä¸ºäº†è¡¡é‡æ¨¡å‹è¾“å‡ºå’ŒçœŸå®æ ‡ç­¾ä¹‹é—´çš„å·®å¼‚ï¼Œä½¿ç”¨æŸå¤±å‡½æ•°ï¼ˆå¦‚äº¤å‰ç†µæŸå¤±ï¼‰ã€‚é€šè¿‡åå‘ä¼ æ’­ç®—æ³•ï¼Œæ ¹æ®æŸå¤±å‡½æ•°çš„æ¢¯åº¦æ›´æ–°æ¨¡å‹çš„å‚æ•°ï¼Œä½¿å¾—æŸå¤±å‡½æ•°é€æ¸å‡å°ã€‚</li>
</ul>
<p>å› æ­¤ï¼Œåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œæ¨¡å‹å­¦ä¹ åˆ°äº†<mark>å›¾åƒä¸­ä¸åŒç‰¹å¾å’Œç±»åˆ«ä¹‹é—´çš„å…³ç³»</mark>ã€‚ä¾‹å¦‚ï¼ŒCNN çš„å·ç§¯å±‚å¯ä»¥å­¦ä¹ åˆ°å›¾åƒä¸­çš„è¾¹ç¼˜ã€çº¹ç†ç­‰å±€éƒ¨ç‰¹å¾ï¼Œéšç€ç½‘ç»œå±‚æ•°çš„å¢åŠ ï¼Œæ¨¡å‹èƒ½å¤Ÿç»„åˆè¿™äº›å±€éƒ¨ç‰¹å¾ï¼Œå½¢æˆæ›´é«˜çº§çš„è¯­ä¹‰ç‰¹å¾ã€‚è¿™äº›ç‰¹å¾è¡¨ç¤ºäº†å›¾åƒçš„æœ¬è´¨ä¿¡æ¯ï¼Œæ˜¯æ¨¡å‹å­¦ä¹ åˆ°çš„å¤æ‚å‡½æ•°å…³ç³»çš„ä¸€éƒ¨åˆ†ã€‚</p>
<p>å½“ä¸€ä¸ªæ–°çš„å›¾åƒè¾“å…¥åˆ°è®­ç»ƒå¥½çš„æ¨¡å‹ä¸­æ—¶ï¼Œæ¨¡å‹ä¼šæ ¹æ®å­¦ä¹ åˆ°çš„å‡½æ•°å…³ç³»å¯¹å›¾åƒè¿›è¡Œå¤„ç†ã€‚é¦–å…ˆï¼Œæ¨¡å‹ä¼šæå–å›¾åƒçš„ç‰¹å¾ï¼Œç„¶åæ ¹æ®è¿™äº›ç‰¹å¾è®¡ç®—æ¯ä¸ªç±»åˆ«çš„å¾—åˆ†ã€‚æœ€åï¼Œæ¨¡å‹ä¼šé€‰æ‹©å¾—åˆ†æœ€é«˜çš„ç±»åˆ«ä½œä¸ºé¢„æµ‹ç»“æœï¼Œä»è€Œå®Œæˆå›¾åƒåˆ†ç±»ä»»åŠ¡ã€‚</p>
<p><u>å®é™…æ•ˆæœä½“ç°</u></p>
<ul>
<li><strong>å‡†ç¡®æ€§</strong>ï¼šå¦‚æœæ¨¡å‹å­¦ä¹ åˆ°çš„å‡½æ•°å…³ç³»èƒ½å¤Ÿå¾ˆå¥½åœ°åæ˜ å›¾åƒç‰¹å¾å’Œç±»åˆ«ä¹‹é—´çš„çœŸå®å…³ç³»ï¼Œé‚£ä¹ˆæ¨¡å‹åœ¨æµ‹è¯•æ•°æ®ä¸Šçš„åˆ†ç±»å‡†ç¡®ç‡ä¼šè¾ƒé«˜ã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸€ä¸ªåŒ…å«çŒ«å’Œç‹—çš„å›¾åƒåˆ†ç±»ä»»åŠ¡ä¸­ï¼Œæ¨¡å‹èƒ½å¤Ÿå‡†ç¡®åœ°å°†å¤§éƒ¨åˆ†çŒ«çš„å›¾ç‰‡åˆ†ç±»ä¸ºçŒ«ï¼Œç‹—çš„å›¾ç‰‡åˆ†ç±»ä¸ºç‹—ã€‚</li>
<li><strong>æ³›åŒ–èƒ½åŠ›</strong>ï¼šå­¦ä¹ åˆ°çš„å‡½æ•°å…³ç³»è¿˜ä½“ç°åœ¨æ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›ä¸Šã€‚å³æ¨¡å‹ä¸ä»…èƒ½å¤Ÿåœ¨è®­ç»ƒæ•°æ®ä¸Šè¡¨ç°è‰¯å¥½ï¼Œè¿˜èƒ½å¤Ÿå¯¹æœªè§è¿‡çš„å›¾åƒè¿›è¡Œå‡†ç¡®åˆ†ç±»ã€‚ä¾‹å¦‚ï¼Œå½“é‡åˆ°ä¸åŒå§¿æ€ã€ä¸åŒå…‰ç…§æ¡ä»¶ä¸‹çš„çŒ«å’Œç‹—çš„å›¾ç‰‡æ—¶ï¼Œæ¨¡å‹ä»ç„¶èƒ½å¤Ÿæ­£ç¡®åˆ†ç±»ã€‚</li>
</ul>
</blockquote>
<p>7.<code>nn.Softmax</code> Softmaxï¼šæ¦‚ç‡å½’ä¸€åŒ–</p>
<p><code>nn.Softmax</code> æ˜¯ PyTorch ä¸­ç”¨äºå®ç° Softmax å‡½æ•°çš„æ¨¡å—ã€‚Softmax å‡½æ•°æ˜¯ä¸€ç§å¸¸ç”¨çš„æ¿€æ´»å‡½æ•°ï¼Œä¸»è¦ç”¨äºå°†ä¸€ä¸ªå®æ•°å‘é‡è½¬æ¢ä¸ºæ¦‚ç‡åˆ†å¸ƒï¼Œä½¿å¾—å‘é‡ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½åœ¨ <code>(0, 1)</code> åŒºé—´å†…ï¼Œå¹¶ä¸”æ‰€æœ‰å…ƒç´ ä¹‹å’Œä¸º 1ã€‚</p>
<p>å¯¹äºä¸€ä¸ªè¾“å…¥å‘é‡$z=[z_1,z_2,...,z_n]$ï¼ŒSoftmax å‡½æ•°çš„æ•°å­¦è¡¨è¾¾å¼ä¸ºï¼š$Softmax(z_i)=\frac{e^{z_i}}{ {\textstyle \sum_{j=1}^{n}}e^{z_j} }$</p>
<p><strong>åº”ç”¨åœºæ™¯</strong></p>
<ul>
<li><strong>å¤šåˆ†ç±»é—®é¢˜</strong>ï¼šåœ¨å¤šåˆ†ç±»ä»»åŠ¡ä¸­ï¼Œå¦‚æ‰‹å†™æ•°å­—è¯†åˆ«ã€å›¾åƒåˆ†ç±»ç­‰ï¼ŒSoftmax å‡½æ•°é€šå¸¸ç”¨äºè¾“å‡ºå±‚ï¼Œå°†æ¨¡å‹çš„è¾“å‡ºè½¬æ¢ä¸ºæ¦‚ç‡åˆ†å¸ƒï¼Œä»è€Œç¡®å®šæ ·æœ¬æ‰€å±çš„ç±»åˆ«ã€‚</li>
<li><strong>å¼ºåŒ–å­¦ä¹ </strong>ï¼šåœ¨å¼ºåŒ–å­¦ä¹ ä¸­ï¼ŒSoftmax å‡½æ•°å¯ä»¥ç”¨äºåŠ¨ä½œé€‰æ‹©ç­–ç•¥ã€‚ä¾‹å¦‚ï¼Œåœ¨åŸºäºç­–ç•¥æ¢¯åº¦çš„ç®—æ³•ä¸­ï¼Œä½¿ç”¨ Softmax å‡½æ•°å°†åŠ¨ä½œçš„åå¥½åˆ†æ•°è½¬æ¢ä¸ºåŠ¨ä½œé€‰æ‹©çš„æ¦‚ç‡ï¼Œä½¿å¾—æ™ºèƒ½ä½“å¯ä»¥æ ¹æ®æ¦‚ç‡éšæœºé€‰æ‹©åŠ¨ä½œã€‚</li>
</ul>
<p><strong>ä¼˜ç‚¹</strong></p>
<ul>
<li><strong>æ¦‚ç‡è§£é‡Šæ€§</strong>ï¼šSoftmax å‡½æ•°çš„è¾“å‡ºå¯ä»¥ç›´æ¥è§£é‡Šä¸ºæ¦‚ç‡ã€‚åœ¨å¤šåˆ†ç±»é—®é¢˜ä¸­ï¼Œæ¯ä¸ªç±»åˆ«çš„è¾“å‡ºå€¼å¯ä»¥çœ‹ä½œæ˜¯æ ·æœ¬å±äºè¯¥ç±»åˆ«çš„æ¦‚ç‡ï¼Œè¿™ä½¿å¾—æ¨¡å‹çš„è¾“å‡ºå…·æœ‰ç›´è§‚çš„æ„ä¹‰ï¼Œä¾¿äºè¿›è¡Œåˆ†ç±»å†³ç­–ã€‚</li>
<li><strong>å¯å¾®æ€§</strong>ï¼šSoftmax å‡½æ•°æ˜¯è¿ç»­å¯å¾®çš„ï¼Œè¿™ä½¿å¾—å®ƒå¯ä»¥ç”¨äºåŸºäºæ¢¯åº¦çš„ä¼˜åŒ–ç®—æ³•ï¼Œå¦‚éšæœºæ¢¯åº¦ä¸‹é™ï¼ˆSGDï¼‰ã€Adam ç­‰ã€‚åœ¨è®­ç»ƒç¥ç»ç½‘ç»œæ—¶ï¼Œå¯ä»¥é€šè¿‡åå‘ä¼ æ’­ç®—æ³•è®¡ç®—æŸå¤±å‡½æ•°å…³äº Softmax è¾“å…¥çš„æ¢¯åº¦ï¼Œä»è€Œæ›´æ–°æ¨¡å‹çš„å‚æ•°ã€‚</li>
</ul>
<p><strong>ç¼ºç‚¹</strong></p>
<ul>
<li><strong>å¯¹è¾“å…¥å€¼æ•æ„Ÿ</strong>ï¼šSoftmax å‡½æ•°ä½¿ç”¨æŒ‡æ•°è¿ç®—ï¼Œå¯¹è¾“å…¥å€¼çš„å·®å¼‚éå¸¸æ•æ„Ÿã€‚å½“è¾“å…¥å€¼ä¹‹é—´çš„å·®å¼‚è¾ƒå¤§æ—¶ï¼Œç»è¿‡ Softmax å‡½æ•°å¤„ç†åï¼Œè¾ƒå¤§çš„å€¼ä¼šå˜å¾—éå¸¸æ¥è¿‘ 1ï¼Œè€Œè¾ƒå°çš„å€¼ä¼šå˜å¾—éå¸¸æ¥è¿‘ 0ï¼Œè¿™å¯èƒ½å¯¼è‡´æ¢¯åº¦æ¶ˆå¤±æˆ–æ¢¯åº¦çˆ†ç‚¸é—®é¢˜ã€‚</li>
<li><strong>è®¡ç®—å¤æ‚åº¦é«˜</strong>ï¼šSoftmax å‡½æ•°çš„è®¡ç®—æ¶‰åŠåˆ°æŒ‡æ•°è¿ç®—å’Œæ±‚å’Œæ“ä½œï¼Œè®¡ç®—å¤æ‚åº¦ç›¸å¯¹è¾ƒé«˜ã€‚åœ¨å¤„ç†å¤§è§„æ¨¡æ•°æ®æ—¶ï¼Œå¯èƒ½ä¼šå½±å“æ¨¡å‹çš„è®­ç»ƒå’Œæ¨ç†é€Ÿåº¦ã€‚</li>
</ul>
<h6 id="æ± åŒ–å±‚">æ± åŒ–å±‚</h6>
<p>1.ä»€ä¹ˆæ˜¯æ± åŒ–ï¼Ÿ</p>
<p>æ± åŒ–ï¼ˆPoolingï¼‰æ˜¯æ·±åº¦å­¦ä¹ ä¸­ä¸€ç§å¸¸ç”¨çš„æ“ä½œï¼Œä¸»è¦ç”¨äºå¯¹è¾“å…¥æ•°æ®è¿›è¡Œä¸‹é‡‡æ ·ï¼Œä¹Ÿå°±æ˜¯å‡å°‘æ•°æ®çš„ç»´åº¦å’Œå‚æ•°æ•°é‡ã€‚</p>
<p>æ± åŒ–æ“ä½œé€šå¸¸åœ¨å·ç§¯å±‚ä¹‹åè¿›è¡Œï¼Œå®ƒä¼šåœ¨è¾“å…¥æ•°æ®çš„å±€éƒ¨åŒºåŸŸï¼ˆä¾‹å¦‚ä¸€ä¸ªå°çš„çŸ©å½¢åŒºåŸŸï¼‰ä¸Šè¿›è¡Œè®¡ç®—ï¼Œæ ¹æ®ç‰¹å®šè§„åˆ™ä»è¯¥åŒºåŸŸä¸­æå–ä¸€ä¸ªä»£è¡¨å€¼ï¼Œä»¥æ­¤æ¥æ›¿ä»£æ•´ä¸ªåŒºåŸŸçš„æ•°æ®ã€‚å¸¸è§çš„è§„åˆ™æœ‰å–æœ€å¤§å€¼ã€å¹³å‡å€¼ç­‰ã€‚</p>
<p><mark>å¸¸è§ç±»å‹</mark></p>
<ul>
<li><strong>æœ€å¤§æ± åŒ–ï¼ˆMax Poolingï¼‰</strong>ï¼šåœ¨æ¯ä¸ªå±€éƒ¨åŒºåŸŸä¸­é€‰å–æœ€å¤§å€¼ä½œä¸ºè¯¥åŒºåŸŸçš„è¾“å‡ºã€‚ä¾‹å¦‚ï¼Œå¯¹äºä¸€ä¸ª 2x2 çš„å±€éƒ¨åŒºåŸŸï¼Œå°†å…¶ä¸­ 4 ä¸ªå…ƒç´ ä¸­çš„æœ€å¤§å€¼æå–å‡ºæ¥ã€‚æœ€å¤§æ± åŒ–èƒ½å¤Ÿä¿ç•™è¾“å…¥æ•°æ®ä¸­çš„ä¸»è¦ç‰¹å¾ï¼Œå› ä¸ºæœ€å¤§å€¼å¾€å¾€å¯¹åº”ç€æ•°æ®ä¸­æœ€æ˜¾è‘—çš„ç‰¹å¾ä¿¡æ¯ï¼Œæœ‰åŠ©äºçªå‡ºé‡è¦çš„è¾¹ç¼˜ã€çº¹ç†ç­‰ç‰¹å¾ã€‚</li>
<li><strong>å¹³å‡æ± åŒ–ï¼ˆAverage Poolingï¼‰</strong>ï¼šè®¡ç®—æ¯ä¸ªå±€éƒ¨åŒºåŸŸå†…æ‰€æœ‰å…ƒç´ çš„å¹³å‡å€¼ä½œä¸ºè¾“å‡ºã€‚å®ƒä¼šå¯¹å±€éƒ¨åŒºåŸŸçš„ä¿¡æ¯è¿›è¡Œå¹³å‡åŒ–å¤„ç†ï¼Œèƒ½ä¿ç•™æ›´å¤šçš„èƒŒæ™¯ä¿¡æ¯ï¼Œä½†ç›¸å¯¹è€Œè¨€å¯èƒ½ä¼šæ¨¡ç³Šä¸€äº›çªå‡ºçš„ç‰¹å¾ã€‚</li>
</ul>
<p><mark>ä½œç”¨</mark></p>
<ul>
<li><strong>é™ä½æ•°æ®ç»´åº¦</strong>ï¼šé€šè¿‡å‡å°‘æ•°æ®çš„å°ºå¯¸ï¼Œé™ä½åç»­å±‚çš„è®¡ç®—é‡å’Œå‚æ•°æ•°é‡ï¼Œä»è€ŒåŠ å¿«æ¨¡å‹çš„è®­ç»ƒé€Ÿåº¦ï¼Œå‡å°‘è¿‡æ‹Ÿåˆçš„é£é™©ã€‚ä¾‹å¦‚ï¼Œåœ¨å¤„ç†é«˜åˆ†è¾¨ç‡çš„å›¾åƒæ—¶ï¼Œæ± åŒ–æ“ä½œå¯ä»¥æ˜¾è‘—å‡å°ç‰¹å¾å›¾çš„å¤§å°ã€‚</li>
<li><strong>å¢å¼ºç‰¹å¾çš„å¹³ç§»ä¸å˜æ€§</strong>ï¼šå³ä½¿è¾“å…¥æ•°æ®åœ¨å±€éƒ¨åŒºåŸŸå†…å‘ç”Ÿäº†ä¸€å®šçš„å¹³ç§»ï¼Œæ± åŒ–æ“ä½œæå–çš„ç‰¹å¾ä»ç„¶ä¿æŒç›¸å¯¹ç¨³å®šã€‚è¿™ä½¿å¾—æ¨¡å‹åœ¨é¢å¯¹ç‰©ä½“ä½ç½®å˜åŒ–æ—¶å…·æœ‰æ›´å¼ºçš„é²æ£’æ€§ã€‚</li>
<li><strong>æå–é‡è¦ç‰¹å¾</strong>ï¼šæœ€å¤§æ± åŒ–å¯ä»¥çªå‡ºæ•°æ®ä¸­çš„é‡è¦ç‰¹å¾ï¼Œå¸®åŠ©æ¨¡å‹èšç„¦äºæ›´å…³é”®çš„ä¿¡æ¯ï¼Œæé«˜æ¨¡å‹çš„ç‰¹å¾è¡¨è¾¾èƒ½åŠ›ã€‚</li>
</ul>
<p>2.<code>nn.MaxPool1d/2d/3d</code> æœ€å¤§æ± åŒ–ï¼šå–å±€éƒ¨æœ€å¤§å€¼</p>
<p><code>nn.MaxPool1d</code>ã€<code>nn.MaxPool2d</code> å’Œ <code>nn.MaxPool3d</code> æ˜¯ PyTorch ä¸­ç”¨äºå®ç°ä¸åŒç»´åº¦æœ€å¤§æ± åŒ–æ“ä½œçš„æ¨¡å—ã€‚æœ€å¤§æ± åŒ–çš„æ ¸å¿ƒæ€æƒ³æ˜¯åœ¨è¾“å…¥æ•°æ®çš„å±€éƒ¨åŒºåŸŸå†…é€‰å–æœ€å¤§å€¼ä½œä¸ºè¯¥åŒºåŸŸçš„è¾“å‡ºï¼Œä»¥æ­¤æ¥å‡å°‘æ•°æ®çš„ç»´åº¦ï¼ŒåŒæ—¶ä¿ç•™é‡è¦çš„ç‰¹å¾ä¿¡æ¯ã€‚</p>
<p><code>nn.MaxPool1d</code></p>
<ul>
<li>
<p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šä¸»è¦ç”¨äºå¤„ç†ä¸€ç»´æ•°æ®ï¼Œå¦‚æ—¶é—´åºåˆ—æ•°æ®æˆ–ä¸€ç»´çš„ç‰¹å¾å‘é‡ã€‚è¾“å…¥æ•°æ®çš„å½¢çŠ¶é€šå¸¸ä¸º <code>(N, C, L)</code>ï¼Œå…¶ä¸­ <code>N</code> æ˜¯æ‰¹é‡å¤§å°ï¼Œ<code>C</code> æ˜¯é€šé“æ•°ï¼Œ<code>L</code> æ˜¯åºåˆ—é•¿åº¦ã€‚</p>
</li>
<li>
<p><strong>å‚æ•°</strong></p>
<ul>
<li><code>kernel_size</code>ï¼šæ± åŒ–çª—å£çš„å¤§å°ï¼Œæ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œè¡¨ç¤ºåœ¨åºåˆ—é•¿åº¦æ–¹å‘ä¸Šçš„çª—å£å¤§å°ã€‚</li>
<li><code>stride</code>ï¼šæ± åŒ–çª—å£çš„æ­¥é•¿ï¼Œé»˜è®¤ä¸º <code>kernel_size</code>ã€‚</li>
<li><code>padding</code>ï¼šåœ¨è¾“å…¥æ•°æ®çš„è¾¹ç•Œå¡«å…… 0 çš„æ•°é‡ï¼Œé»˜è®¤ä¸º 0ã€‚</li>
</ul>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å®šä¹‰è¾“å…¥æ•°æ®</span></span><br><span class="line">input_data = torch.randn(<span class="number">1</span>, <span class="number">1</span>, <span class="number">10</span>)  <span class="comment"># æ‰¹é‡å¤§å°ä¸º 1ï¼Œé€šé“æ•°ä¸º 1ï¼Œåºåˆ—é•¿åº¦ä¸º 10</span></span><br><span class="line"><span class="comment"># åˆ›å»º MaxPool1d å±‚</span></span><br><span class="line">max_pool_1d = nn.MaxPool1d(kernel_size=<span class="number">2</span>, stride=<span class="number">2</span>)</span><br><span class="line"><span class="comment"># è¿›è¡Œæœ€å¤§æ± åŒ–æ“ä½œ</span></span><br><span class="line">output = max_pool_1d(input_data)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><code>nn.MaxPool2d</code></p>
<ul>
<li>
<p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šå¸¸ç”¨äºå¤„ç†äºŒç»´æ•°æ®ï¼Œå¦‚å›¾åƒæ•°æ®ã€‚è¾“å…¥æ•°æ®çš„å½¢çŠ¶é€šå¸¸ä¸º <code>(N, C, H, W)</code>ï¼Œå…¶ä¸­ <code>N</code> æ˜¯æ‰¹é‡å¤§å°ï¼Œ<code>C</code> æ˜¯é€šé“æ•°ï¼Œ<code>H</code> æ˜¯é«˜åº¦ï¼Œ<code>W</code> æ˜¯å®½åº¦ã€‚</p>
</li>
<li>
<p><strong>å‚æ•°ï¼š</strong></p>
<ul>
<li><code>kernel_size</code>ï¼šæ± åŒ–çª—å£çš„å¤§å°ï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªæ•´æ•°æˆ–å…ƒç»„ã€‚å¦‚æœæ˜¯æ•´æ•°ï¼Œåˆ™è¡¨ç¤ºæ­£æ–¹å½¢çª—å£çš„è¾¹é•¿ï¼›å¦‚æœæ˜¯å…ƒç»„ï¼Œåˆ™åˆ†åˆ«è¡¨ç¤ºé«˜åº¦å’Œå®½åº¦æ–¹å‘çš„çª—å£å¤§å°ã€‚</li>
<li><code>stride</code>ï¼šæ± åŒ–çª—å£çš„æ­¥é•¿ï¼Œé»˜è®¤ä¸º <code>kernel_size</code>ã€‚</li>
<li><code>padding</code>ï¼šåœ¨è¾“å…¥æ•°æ®çš„è¾¹ç•Œå¡«å…… 0 çš„æ•°é‡ï¼Œé»˜è®¤ä¸º 0ã€‚</li>
</ul>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å®šä¹‰è¾“å…¥æ•°æ®</span></span><br><span class="line">input_data = torch.randn(<span class="number">1</span>, <span class="number">1</span>, <span class="number">4</span>, <span class="number">4</span>)  <span class="comment"># æ‰¹é‡å¤§å°ä¸º 1ï¼Œé€šé“æ•°ä¸º 1ï¼Œé«˜åº¦ä¸º 4ï¼Œå®½åº¦ä¸º 4</span></span><br><span class="line"><span class="comment"># åˆ›å»º MaxPool2d å±‚</span></span><br><span class="line">max_pool_2d = nn.MaxPool2d(kernel_size=<span class="number">2</span>, stride=<span class="number">2</span>)</span><br><span class="line"><span class="comment"># è¿›è¡Œæœ€å¤§æ± åŒ–æ“ä½œ</span></span><br><span class="line">output = max_pool_2d(input_data)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><code>nn.MaxPool3d</code></p>
<ul>
<li>
<p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šé€‚ç”¨äºå¤„ç†ä¸‰ç»´æ•°æ®ï¼Œå¦‚ 3D åŒ»å­¦å›¾åƒæˆ–è§†é¢‘æ•°æ®ã€‚è¾“å…¥æ•°æ®çš„å½¢çŠ¶é€šå¸¸ä¸º <code>(N, C, D, H, W)</code>ï¼Œå…¶ä¸­ <code>N</code> æ˜¯æ‰¹é‡å¤§å°ï¼Œ<code>C</code> æ˜¯é€šé“æ•°ï¼Œ<code>D</code> æ˜¯æ·±åº¦ï¼Œ<code>H</code> æ˜¯é«˜åº¦ï¼Œ<code>W</code> æ˜¯å®½åº¦ã€‚</p>
</li>
<li>
<p><strong>å‚æ•°ï¼š</strong></p>
<ul>
<li><code>kernel_size</code>ï¼šæ± åŒ–çª—å£çš„å¤§å°ï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªæ•´æ•°æˆ–å…ƒç»„ã€‚å¦‚æœæ˜¯æ•´æ•°ï¼Œåˆ™è¡¨ç¤ºç«‹æ–¹ä½“çª—å£çš„è¾¹é•¿ï¼›å¦‚æœæ˜¯å…ƒç»„ï¼Œåˆ™åˆ†åˆ«è¡¨ç¤ºæ·±åº¦ã€é«˜åº¦å’Œå®½åº¦æ–¹å‘çš„çª—å£å¤§å°ã€‚</li>
<li><code>stride</code>ï¼šæ± åŒ–çª—å£çš„æ­¥é•¿ï¼Œé»˜è®¤ä¸º <code>kernel_size</code>ã€‚</li>
<li><code>padding</code>ï¼šåœ¨è¾“å…¥æ•°æ®çš„è¾¹ç•Œå¡«å…… 0 çš„æ•°é‡ï¼Œé»˜è®¤ä¸º 0ã€‚</li>
</ul>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å®šä¹‰è¾“å…¥æ•°æ®</span></span><br><span class="line">input_data = torch.randn(<span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">4</span>)  <span class="comment"># æ‰¹é‡å¤§å°ä¸º 1ï¼Œé€šé“æ•°ä¸º 1ï¼Œæ·±åº¦ä¸º 2ï¼Œé«˜åº¦ä¸º 4ï¼Œå®½åº¦ä¸º 4</span></span><br><span class="line"><span class="comment"># åˆ›å»º MaxPool3d å±‚</span></span><br><span class="line">max_pool_3d = nn.MaxPool3d(kernel_size=<span class="number">2</span>, stride=<span class="number">2</span>)</span><br><span class="line"><span class="comment"># è¿›è¡Œæœ€å¤§æ± åŒ–æ“ä½œ</span></span><br><span class="line">output = max_pool_3d(input_data)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>3.<code>nn.AvgPool1d/2d/3d</code> å¹³å‡æ± åŒ–ï¼šå–å±€éƒ¨å¹³å‡å€¼</p>
<p>åŸç†åŒä¸Š</p>
<p>4.<code>nn.AdaptiveMaxPool1d/2d/3d</code> è‡ªé€‚åº”æ± åŒ–ï¼šåŠ¨æ€è°ƒæ•´è¾“å‡ºå°ºå¯¸</p>
<p><code>nn.AdaptiveMaxPool1d</code>ã€<code>nn.AdaptiveMaxPool2d</code> å’Œ <code>nn.AdaptiveMaxPool3d</code> æ˜¯ PyTorch ä¸­ç”¨äºå®ç°è‡ªé€‚åº”æœ€å¤§æ± åŒ–æ“ä½œçš„æ¨¡å—ã€‚ä¸æ™®é€šçš„æœ€å¤§æ± åŒ–ï¼ˆå¦‚ <code>nn.MaxPool1d</code>ã€<code>nn.MaxPool2d</code>ã€<code>nn.MaxPool3d</code>ï¼‰ä¸åŒï¼Œè‡ªé€‚åº”æœ€å¤§æ± åŒ–å…è®¸ç”¨æˆ·ç›´æ¥æŒ‡å®šè¾“å‡ºçš„å°ºå¯¸ï¼Œè€Œä¸æ˜¯åƒæ™®é€šæ± åŒ–é‚£æ ·æŒ‡å®šæ± åŒ–çª—å£çš„å¤§å°å’Œæ­¥é•¿ï¼Œå®ƒä¼šæ ¹æ®æŒ‡å®šçš„è¾“å‡ºå°ºå¯¸åŠ¨æ€åœ°è°ƒæ•´æ± åŒ–çª—å£çš„å¤§å°å’Œæ­¥é•¿ï¼Œä»è€Œå¾—åˆ°æœŸæœ›çš„è¾“å‡ºã€‚</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">1D:</span><br><span class="line">    <span class="comment"># å®šä¹‰è¾“å…¥æ•°æ®</span></span><br><span class="line">input_data = torch.randn(<span class="number">1</span>, <span class="number">1</span>, <span class="number">10</span>)  <span class="comment"># æ‰¹é‡å¤§å°ä¸º 1ï¼Œé€šé“æ•°ä¸º 1ï¼Œåºåˆ—é•¿åº¦ä¸º 10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»º AdaptiveMaxPool1d å±‚ï¼ŒæŒ‡å®šè¾“å‡ºé•¿åº¦ä¸º 5</span></span><br><span class="line">adaptive_max_pool_1d = nn.AdaptiveMaxPool1d(output_size=<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿›è¡Œè‡ªé€‚åº”æœ€å¤§æ± åŒ–æ“ä½œ</span></span><br><span class="line">output = adaptive_max_pool_1d(input_data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2D:</span><br><span class="line">    <span class="comment"># å®šä¹‰è¾“å…¥æ•°æ®</span></span><br><span class="line">input_data = torch.randn(<span class="number">1</span>, <span class="number">1</span>, <span class="number">8</span>, <span class="number">8</span>)  <span class="comment"># æ‰¹é‡å¤§å°ä¸º 1ï¼Œé€šé“æ•°ä¸º 1ï¼Œé«˜åº¦ä¸º 8ï¼Œå®½åº¦ä¸º 8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»º AdaptiveMaxPool2d å±‚ï¼ŒæŒ‡å®šè¾“å‡ºé«˜åº¦å’Œå®½åº¦ä¸º 4</span></span><br><span class="line">adaptive_max_pool_2d = nn.AdaptiveMaxPool2d(output_size=<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿›è¡Œè‡ªé€‚åº”æœ€å¤§æ± åŒ–æ“ä½œ</span></span><br><span class="line">output = adaptive_max_pool_2d(input_data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3D:</span><br><span class="line">    <span class="comment"># å®šä¹‰è¾“å…¥æ•°æ®</span></span><br><span class="line">input_data = torch.randn(<span class="number">1</span>, <span class="number">1</span>, <span class="number">4</span>, <span class="number">8</span>, <span class="number">8</span>)  <span class="comment"># æ‰¹é‡å¤§å°ä¸º 1ï¼Œé€šé“æ•°ä¸º 1ï¼Œæ·±åº¦ä¸º 4ï¼Œé«˜åº¦ä¸º 8ï¼Œå®½åº¦ä¸º 8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»º AdaptiveMaxPool3d å±‚ï¼ŒæŒ‡å®šè¾“å‡ºæ·±åº¦ã€é«˜åº¦å’Œå®½åº¦ä¸º 2</span></span><br><span class="line">adaptive_max_pool_3d = nn.AdaptiveMaxPool3d(output_size=<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿›è¡Œè‡ªé€‚åº”æœ€å¤§æ± åŒ–æ“ä½œ</span></span><br><span class="line">output = adaptive_max_pool_3d(input_data)</span><br></pre></td></tr></table></figure>
<p>5.<code>nn.FractionalMaxPool2d</code> åˆ†æ•°æ± åŒ–ï¼šéšæœºåˆ†æ•°æ­¥é•¿æ± åŒ–</p>
<p><code>nn.FractionalMaxPool2d</code> æ˜¯ PyTorch ä¸­ç”¨äºå®ç°åˆ†æ•°æœ€å¤§æ± åŒ–ï¼ˆFractional Max Poolingï¼‰çš„æ¨¡å—ã€‚ä¼ ç»Ÿçš„æœ€å¤§æ± åŒ–ï¼ˆå¦‚ <code>nn.MaxPool2d</code>ï¼‰ä½¿ç”¨å›ºå®šçš„æ­¥é•¿å’Œæ± åŒ–çª—å£å¤§å°è¿›è¡Œä¸‹é‡‡æ ·ï¼Œè€Œåˆ†æ•°æœ€å¤§æ± åŒ–å¼•å…¥äº†éšæœºçš„åˆ†æ•°æ­¥é•¿ï¼Œèƒ½å¤Ÿåœ¨æ± åŒ–è¿‡ç¨‹ä¸­æä¾›æ›´å¤šçš„éšæœºæ€§å’Œçµæ´»æ€§ï¼Œæœ‰åŠ©äºæé«˜æ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›ã€‚</p>
<p>åˆ†æ•°æœ€å¤§æ± åŒ–çš„æ ¸å¿ƒæ€æƒ³æ˜¯é€šè¿‡éšæœºé€‰æ‹©åˆ†æ•°æ­¥é•¿æ¥ç¡®å®šæ± åŒ–çª—å£çš„ä½ç½®ï¼Œä»è€Œå®ç°ä¸‹é‡‡æ ·ã€‚åœ¨æ¯æ¬¡å‰å‘ä¼ æ’­æ—¶ï¼Œæ± åŒ–çª—å£çš„ä½ç½®æ˜¯éšæœºçš„ï¼Œä½†ä¼šä¿è¯è¾“å‡ºçš„å°ºå¯¸æ»¡è¶³ç”¨æˆ·æŒ‡å®šçš„è¦æ±‚ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒä¼šæ ¹æ®è¾“å…¥çš„å°ºå¯¸å’ŒæœŸæœ›çš„è¾“å‡ºå°ºå¯¸ï¼Œéšæœºç”Ÿæˆä¸€ç³»åˆ—åˆ†æ•°æ­¥é•¿ï¼Œç„¶åæ ¹æ®è¿™äº›æ­¥é•¿ç§»åŠ¨æ± åŒ–çª—å£å¹¶è¿›è¡Œæœ€å¤§æ± åŒ–æ“ä½œã€‚</p>
<p><strong>ä¼˜ç‚¹</strong></p>
<ul>
<li><strong>å¢å¼ºæ³›åŒ–èƒ½åŠ›</strong>ï¼šç”±äºåˆ†æ•°æœ€å¤§æ± åŒ–å¼•å…¥äº†éšæœºçš„åˆ†æ•°æ­¥é•¿ï¼Œä½¿å¾—æ¨¡å‹åœ¨æ¯æ¬¡è®­ç»ƒæ—¶çœ‹åˆ°çš„æ± åŒ–ç»“æœä¸åŒï¼Œå¢åŠ äº†æ•°æ®çš„å¤šæ ·æ€§ï¼Œæœ‰åŠ©äºæ¨¡å‹å­¦ä¹ åˆ°æ›´é²æ£’çš„ç‰¹å¾ï¼Œä»è€Œæé«˜æ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›ã€‚</li>
<li><strong>å‡å°‘è¿‡æ‹Ÿåˆ</strong>ï¼šéšæœºæ± åŒ–çš„è¿‡ç¨‹å¯ä»¥çœ‹ä½œæ˜¯ä¸€ç§æ•°æ®å¢å¼ºçš„æ–¹å¼ï¼Œèƒ½å¤Ÿåœ¨ä¸€å®šç¨‹åº¦ä¸Šå‡å°‘æ¨¡å‹å¯¹è®­ç»ƒæ•°æ®çš„è¿‡æ‹Ÿåˆã€‚</li>
</ul>
<p><strong>ç¼ºç‚¹</strong></p>
<ul>
<li><strong>è®¡ç®—å¤æ‚åº¦è¾ƒé«˜</strong>ï¼šç”±äºéœ€è¦éšæœºç”Ÿæˆåˆ†æ•°æ­¥é•¿å¹¶è¿›è¡Œæ± åŒ–æ“ä½œï¼Œåˆ†æ•°æœ€å¤§æ± åŒ–çš„è®¡ç®—å¤æ‚åº¦ç›¸å¯¹è¾ƒé«˜ï¼Œå¯èƒ½ä¼šå¢åŠ æ¨¡å‹çš„è®­ç»ƒæ—¶é—´ã€‚</li>
<li><strong>å¯è§£é‡Šæ€§è¾ƒå·®</strong>ï¼šéšæœºæ± åŒ–çš„è¿‡ç¨‹ä½¿å¾—æ± åŒ–çª—å£çš„ä½ç½®ä¸å›ºå®šï¼Œå¢åŠ äº†æ¨¡å‹çš„ä¸ç¡®å®šæ€§ï¼Œå¯¼è‡´å…¶å¯è§£é‡Šæ€§ç›¸å¯¹è¾ƒå·®ã€‚</li>
</ul>
<blockquote>
<p><mark>â“åˆ†æ•°æ± åŒ–å’Œè‡ªé€‚åº”æ± åŒ–çš„åŒºåˆ«</mark></p>
<ul>
<li>åˆ†æ•°æ± åŒ–ï¼ˆ<code>nn.FractionalMaxPool2d</code>ï¼‰</li>
</ul>
<p>å¼•å…¥éšæœºçš„åˆ†æ•°æ­¥é•¿æ¥ç¡®å®šæ± åŒ–çª—å£çš„ä½ç½®ã€‚åœ¨æ¯æ¬¡å‰å‘ä¼ æ’­æ—¶ï¼Œä¼šæ ¹æ®è¾“å…¥å°ºå¯¸å’ŒæœŸæœ›çš„è¾“å‡ºå°ºå¯¸éšæœºç”Ÿæˆåˆ†æ•°æ­¥é•¿ï¼Œç„¶åä¾æ®è¿™äº›æ­¥é•¿ç§»åŠ¨æ± åŒ–çª—å£è¿›è¡Œæœ€å¤§æ± åŒ–æ“ä½œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯æ¬¡æ± åŒ–æ—¶çª—å£çš„ä½ç½®æ˜¯éšæœºçš„ï¼Œå…·æœ‰ä¸€å®šçš„ä¸ç¡®å®šæ€§ã€‚</p>
<p>é€‚ç”¨äºå¯¹æ¨¡å‹æ³›åŒ–èƒ½åŠ›è¦æ±‚è¾ƒé«˜ã€éœ€è¦<mark>ç¼“è§£è¿‡æ‹Ÿåˆ</mark>é—®é¢˜çš„ä»»åŠ¡ï¼Œå¦‚åœ¨å›¾åƒåˆ†ç±»ã€ç›®æ ‡æ£€æµ‹ç­‰ä»»åŠ¡ä¸­ï¼Œå½“è®­ç»ƒæ•°æ®æœ‰é™æˆ–è€…æ¨¡å‹å®¹æ˜“è¿‡æ‹Ÿåˆæ—¶ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨åˆ†æ•°æ± åŒ–ã€‚</p>
<ul>
<li>è‡ªé€‚åº”æ± åŒ–ï¼ˆ<code>nn.AdaptiveMaxPool2d</code>ï¼‰</li>
</ul>
<p>ç›´æ¥æ ¹æ®ç”¨æˆ·æŒ‡å®šçš„è¾“å‡ºå°ºå¯¸æ¥åŠ¨æ€è°ƒæ•´æ± åŒ–çª—å£çš„å¤§å°å’Œæ­¥é•¿ã€‚å®ƒä¼šè‡ªåŠ¨è®¡ç®—å‡ºåˆé€‚çš„æ± åŒ–çª—å£å‚æ•°ï¼Œä»¥ç¡®ä¿è¾“å‡ºçš„ç‰¹å¾å›¾å°ºå¯¸ç¬¦åˆè¦æ±‚ã€‚æ•´ä¸ªè¿‡ç¨‹æ˜¯ç¡®å®šæ€§çš„ï¼Œå¯¹äºç›¸åŒçš„è¾“å…¥å’ŒæŒ‡å®šçš„è¾“å‡ºå°ºå¯¸ï¼Œæ¯æ¬¡å¾—åˆ°çš„ç»“æœéƒ½æ˜¯ç›¸åŒçš„ã€‚</p>
<p>é€‚ç”¨äºéœ€è¦<mark>ç»Ÿä¸€ä¸åŒæ ·æœ¬ç‰¹å¾å°ºå¯¸</mark>çš„åœºæ™¯ï¼Œä¾‹å¦‚åœ¨å¤„ç†ä¸åŒåˆ†è¾¨ç‡çš„å›¾åƒæ•°æ®æ—¶ï¼Œä½¿ç”¨è‡ªé€‚åº”æ± åŒ–å¯ä»¥å°†ä¸åŒå°ºå¯¸çš„è¾“å…¥å›¾åƒè½¬æ¢ä¸ºå›ºå®šå°ºå¯¸çš„ç‰¹å¾å›¾ï¼Œæ–¹ä¾¿åç»­çš„å¤„ç†å’Œæ¨¡å‹è®­ç»ƒã€‚åŒæ—¶ï¼Œåœ¨ä¸€äº›å¯¹è®¡ç®—æ•ˆç‡æœ‰è¾ƒé«˜è¦æ±‚çš„åœºæ™¯ä¸­ï¼Œè‡ªé€‚åº”æ± åŒ–ä¹Ÿæ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚</p>
</blockquote>
<h6 id="Dropoutï¼ˆä¸¢å¼ƒï¼‰-å±‚">Dropoutï¼ˆä¸¢å¼ƒï¼‰ å±‚</h6>
<ol>
<li>ä»€ä¹ˆæ˜¯Dropoutï¼ˆä¸¢å¼ƒï¼‰ï¼Ÿ</li>
</ol>
<p>Dropout æ˜¯æ·±åº¦å­¦ä¹ ä¸­ä¸€ç§å¸¸ç”¨çš„æ­£åˆ™åŒ–æŠ€æœ¯ï¼Œä¸»è¦ç”¨äºé˜²æ­¢ç¥ç»ç½‘ç»œè¿‡æ‹Ÿåˆã€‚</p>
<p><mark>åŸç†</mark></p>
<p>åœ¨ç¥ç»ç½‘ç»œè®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œç¥ç»å…ƒä¹‹é—´å¯èƒ½ä¼šäº§ç”Ÿå¤æ‚çš„å…±é€‚åº”å…³ç³»ï¼Œå³æŸäº›ç¥ç»å…ƒä¼šä¾èµ–å…¶ä»–ç‰¹å®šç¥ç»å…ƒçš„è¾“å‡ºã€‚è¿™å¯èƒ½å¯¼è‡´æ¨¡å‹å¯¹è®­ç»ƒæ•°æ®è¿‡åº¦æ‹Ÿåˆï¼Œåœ¨æ–°æ•°æ®ä¸Šçš„æ³›åŒ–èƒ½åŠ›å˜å·®ã€‚Dropout é€šè¿‡éšæœº â€œä¸¢å¼ƒâ€ï¼ˆæš‚æ—¶å¿½ç•¥ï¼‰ä¸€éƒ¨åˆ†ç¥ç»å…ƒåŠå…¶è¿æ¥ï¼Œæ‰“ç ´è¿™ç§å…±é€‚åº”å…³ç³»ï¼Œä½¿æ¨¡å‹æ›´åŠ é²æ£’ã€‚</p>
<p><mark>å·¥ä½œæœºåˆ¶</mark></p>
<ul>
<li><strong>è®­ç»ƒé˜¶æ®µ</strong>ï¼šåœ¨æ¯æ¬¡è®­ç»ƒè¿­ä»£ä¸­ï¼Œå¯¹äºæ¯ä¸ªç¥ç»å…ƒï¼Œä»¥ä¸€å®šçš„æ¦‚ç‡ ï¼ˆç§°ä¸º Dropout ç‡ï¼‰å°†å…¶æš‚æ—¶ä»ç½‘ç»œä¸­ä¸¢å¼ƒï¼Œå³è¯¥ç¥ç»å…ƒåœ¨æœ¬æ¬¡å‰å‘ä¼ æ’­å’Œåå‘ä¼ æ’­ä¸­ä¸å‚ä¸è®¡ç®—ã€‚é€šå¸¸ï¼Œè¾“å…¥å±‚çš„ Dropout ç‡è¾ƒä½ï¼ˆå¦‚ 0.2ï¼‰ï¼Œéšè—å±‚çš„ Dropout ç‡è¾ƒé«˜ï¼ˆå¦‚ 0.5ï¼‰ã€‚</li>
<li><strong>æµ‹è¯•é˜¶æ®µ</strong>ï¼šåœ¨æµ‹è¯•æˆ–æ¨ç†æ—¶ï¼Œæ‰€æœ‰ç¥ç»å…ƒéƒ½å‚ä¸è®¡ç®—ï¼Œä½†ä¸ºäº†å¹³è¡¡è®­ç»ƒå’Œæµ‹è¯•é˜¶æ®µç¥ç»å…ƒçš„è¾“å‡ºè§„æ¨¡ï¼Œéœ€è¦å°†æ¯ä¸ªç¥ç»å…ƒçš„è¾“å‡ºä¹˜ä»¥$(1-p)$ã€‚ä¸è¿‡ï¼Œåœ¨å®é™…å®ç°ä¸­ï¼Œä¹Ÿå¯ä»¥é‡‡ç”¨å€’ç½® Dropoutï¼ˆInverted Dropoutï¼‰æŠ€æœ¯ï¼Œåœ¨è®­ç»ƒæ—¶å°±å¯¹ä¿ç•™çš„ç¥ç»å…ƒè¾“å‡ºé™¤ä»¥$(1-p)$ï¼Œè¿™æ ·æµ‹è¯•æ—¶å°±æ— éœ€é¢å¤–æ“ä½œã€‚</li>
</ul>
<p><mark>ä½œç”¨</mark></p>
<ul>
<li><strong>å‡å°‘è¿‡æ‹Ÿåˆ</strong>ï¼šDropout ç›¸å½“äºåœ¨æ¯æ¬¡è¿­ä»£ä¸­è®­ç»ƒä¸€ä¸ªä¸åŒçš„å­ç½‘ç»œï¼Œè¿™äº›å­ç½‘ç»œå…±äº«å‚æ•°ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæ¨¡å‹ä¸ä¼šè¿‡åº¦ä¾èµ–äºä»»ä½•ä¸€ä¸ªç¥ç»å…ƒæˆ–ä¸€ç»„ç¥ç»å…ƒï¼Œä»è€Œå‡å°‘å¯¹è®­ç»ƒæ•°æ®çš„è¿‡æ‹Ÿåˆï¼Œæé«˜åœ¨æ–°æ•°æ®ä¸Šçš„æ³›åŒ–èƒ½åŠ›ã€‚</li>
<li><strong>é›†æˆå­¦ä¹ æ•ˆæœ</strong>ï¼šä»æŸç§æ„ä¹‰ä¸Šè¯´ï¼ŒDropout å¯ä»¥çœ‹ä½œæ˜¯ä¸€ç§é›†æˆå­¦ä¹ æ–¹æ³•ï¼Œå› ä¸ºæ¯æ¬¡è®­ç»ƒçš„å­ç½‘ç»œéƒ½å¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„æ¨¡å‹ï¼Œæœ€ç»ˆçš„æ¨¡å‹ç›¸å½“äºè¿™äº›å­ç½‘ç»œçš„é›†æˆã€‚</li>
</ul>
<p><mark>ç¼ºç‚¹</mark></p>
<ul>
<li><strong>è®­ç»ƒæ—¶é—´å¢åŠ </strong>ï¼šç”±äºæ¯æ¬¡è¿­ä»£ä¸­éƒ¨åˆ†ç¥ç»å…ƒè¢«ä¸¢å¼ƒï¼Œæ¨¡å‹éœ€è¦æ›´å¤šçš„è¿­ä»£æ¬¡æ•°æ‰èƒ½æ”¶æ•›ï¼Œå› æ­¤ä¼šå¢åŠ è®­ç»ƒæ—¶é—´ã€‚</li>
<li><strong>è¶…å‚æ•°é€‰æ‹©å›°éš¾</strong>ï¼šDropout ç‡ æ˜¯ä¸€ä¸ªè¶…å‚æ•°ï¼Œéœ€è¦é€šè¿‡å®éªŒè¿›è¡Œè°ƒæ•´ã€‚å¦‚æœ$p$è®¾ç½®è¿‡å¤§ï¼Œæ¨¡å‹å¯èƒ½æ¬ æ‹Ÿåˆï¼›å¦‚æœ$p$è®¾ç½®è¿‡å°ï¼Œåˆ™å¯èƒ½æ— æ³•æœ‰æ•ˆé˜²æ­¢è¿‡æ‹Ÿåˆã€‚</li>
</ul>
<ol start="2">
<li><code>nn.Dropout</code> æ ‡å‡†Dropoutï¼š éšæœºç½®é›¶ç¥ç»å…ƒ</li>
</ol>
<p><code>nn.Dropout</code> æ˜¯ PyTorch ä¸­ç”¨äºå®ç°æ ‡å‡† Dropout æ“ä½œçš„æ¨¡å—ã€‚Dropout æ˜¯ä¸€ç§åœ¨è®­ç»ƒç¥ç»ç½‘ç»œæ—¶å¸¸ç”¨çš„æ­£åˆ™åŒ–æŠ€æœ¯ï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯åœ¨æ¯æ¬¡è®­ç»ƒè¿­ä»£ä¸­ï¼Œä»¥ä¸€å®šçš„æ¦‚ç‡ éšæœº â€œä¸¢å¼ƒâ€ï¼ˆå°†è¾“å‡ºç½®ä¸º 0ï¼‰ç½‘ç»œä¸­çš„éƒ¨åˆ†ç¥ç»å…ƒï¼Œä½¿å¾—æ¨¡å‹ä¸ä¼šè¿‡åº¦ä¾èµ–äºæŸäº›ç‰¹å®šçš„ç¥ç»å…ƒï¼Œä»è€Œå‡å°‘è¿‡æ‹Ÿåˆçš„é£é™©ï¼Œæé«˜æ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›ã€‚</p>
<p><strong>åº”ç”¨åœºæ™¯</strong></p>
<ul>
<li><strong>å…¨è¿æ¥å±‚ä¹‹å</strong>ï¼šåœ¨å¤šå±‚æ„ŸçŸ¥æœºï¼ˆMLPï¼‰ä¸­ï¼Œé€šå¸¸åœ¨å…¨è¿æ¥å±‚ä¹‹åæ·»åŠ  Dropout å±‚ï¼Œä»¥é˜²æ­¢è¿‡æ‹Ÿåˆã€‚</li>
<li><strong>å·ç§¯ç¥ç»ç½‘ç»œï¼ˆCNNï¼‰</strong>ï¼šåœ¨ä¸€äº› CNN æ¶æ„ä¸­ï¼Œä¹Ÿä¼šåœ¨å…¨è¿æ¥å±‚ä¹‹å‰æˆ–ä¹‹åä½¿ç”¨ Dropout å±‚ã€‚ä¸è¿‡ï¼Œåœ¨å·ç§¯å±‚ä¸­ä½¿ç”¨ Dropout çš„æƒ…å†µç›¸å¯¹è¾ƒå°‘ï¼Œå› ä¸ºå·ç§¯å±‚æœ¬èº«å…·æœ‰ä¸€å®šçš„å¹³ç§»ä¸å˜æ€§å’Œç¨€ç–æ€§ã€‚</li>
</ul>
<p><strong>ä¼˜ç‚¹ç¼ºç‚¹</strong>åŒä¸Šã€‚</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºè¾“å…¥å¼ é‡</span></span><br><span class="line">input_tensor = torch.randn(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»º Dropout å±‚ï¼Œè®¾ç½®ä¸¢å¼ƒæ¦‚ç‡ä¸º 0.2</span></span><br><span class="line">dropout = nn.Dropout(p=<span class="number">0.2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¼€å¯è®­ç»ƒæ¨¡å¼</span></span><br><span class="line">dropout.train()</span><br><span class="line">output_train = dropout(input_tensor)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¼€å¯è¯„ä¼°æ¨¡å¼</span></span><br><span class="line">dropout.<span class="built_in">eval</span>()</span><br><span class="line">output_eval = dropout(input_tensor)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;è¾“å…¥å¼ é‡:&quot;</span>, input_tensor)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;è®­ç»ƒæ¨¡å¼ä¸‹çš„è¾“å‡º:&quot;</span>, output_train)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;è¯„ä¼°æ¨¡å¼ä¸‹çš„è¾“å‡º:&quot;</span>, output_eval)</span><br></pre></td></tr></table></figure>
<p><strong>ä»£ç è§£é‡Š</strong></p>
<ul>
<li><strong>è¾“å…¥å¼ é‡</strong>ï¼š<code>input_tensor</code> æ˜¯ä¸€ä¸ªåŒ…å« 10 ä¸ªéšæœºæ•°çš„ä¸€ç»´å¼ é‡ã€‚</li>
<li><strong>Dropout å±‚å®ä¾‹</strong>ï¼šä½¿ç”¨ <code>nn.Dropout(p = 0.2)</code> åˆ›å»ºä¸€ä¸ª Dropout å±‚å®ä¾‹ï¼Œå…¶ä¸­ <code>p</code> è¡¨ç¤ºæ¯ä¸ªç¥ç»å…ƒè¢«ä¸¢å¼ƒçš„æ¦‚ç‡ï¼Œè¿™é‡Œè®¾ç½®ä¸º 0.2ã€‚</li>
<li><strong>è®­ç»ƒæ¨¡å¼</strong>ï¼šè°ƒç”¨ <code>dropout.train()</code> å°† Dropout å±‚è®¾ç½®ä¸ºè®­ç»ƒæ¨¡å¼ã€‚åœ¨è®­ç»ƒæ¨¡å¼ä¸‹ï¼ŒDropout ä¼šæŒ‰ç…§è®¾å®šçš„æ¦‚ç‡éšæœºå°†éƒ¨åˆ†ç¥ç»å…ƒçš„è¾“å‡ºç½®ä¸º 0ï¼Œå¹¶å¯¹ä¿ç•™çš„ç¥ç»å…ƒè¾“å‡ºè¿›è¡Œç¼©æ”¾ï¼ˆé‡‡ç”¨å€’ç½® Dropout æ–¹å¼ï¼Œé™¤ä»¥ <code>(1 - p)</code>ï¼‰ã€‚</li>
<li><strong>è¯„ä¼°æ¨¡å¼</strong>ï¼šè°ƒç”¨ <code>dropout.eval()</code> å°† Dropout å±‚è®¾ç½®ä¸ºè¯„ä¼°æ¨¡å¼ã€‚åœ¨è¯„ä¼°æ¨¡å¼ä¸‹ï¼ŒDropout å±‚ä¸è¿›è¡Œä»»ä½•ä¸¢å¼ƒæ“ä½œï¼Œç›´æ¥è¿”å›è¾“å…¥å¼ é‡ï¼Œå› ä¸ºåœ¨æµ‹è¯•é˜¶æ®µä¸éœ€è¦ä½¿ç”¨ Dropout æ¥é˜²æ­¢è¿‡æ‹Ÿåˆã€‚</li>
</ul>
<blockquote>
<p>â“ä¸ºä»€ä¹ˆå¹³ç§»ä¸å˜æ€§å’Œç¨€ç–æ€§ä¸å®¹æ˜“å‡ºç°è¿‡æ‹Ÿåˆï¼Œè¿›è€Œä¸éœ€è¦Dropout</p>
<p>å¹³ç§»ä¸å˜æ€§æ˜¯æŒ‡å½“è¾“å…¥æ•°æ®å‘ç”Ÿå¹³ç§»æ—¶ï¼Œæ¨¡å‹çš„è¾“å‡ºç»“æœä¿æŒä¸å˜ã€‚åœ¨å·ç§¯ç¥ç»ç½‘ç»œï¼ˆCNNï¼‰ä¸­ï¼Œå·ç§¯å±‚é€šè¿‡å…±äº«å·ç§¯æ ¸çš„æ–¹å¼è‡ªç„¶åœ°å…·å¤‡äº†ä¸€å®šç¨‹åº¦çš„å¹³ç§»ä¸å˜æ€§ã€‚ä¾‹å¦‚ï¼Œåœ¨å›¾åƒè¯†åˆ«ä»»åŠ¡ä¸­ï¼Œæ— è®ºç›®æ ‡ç‰©ä½“åœ¨å›¾åƒä¸­çš„ä½ç½®å¦‚ä½•ç§»åŠ¨ï¼Œå·ç§¯æ ¸éƒ½èƒ½æ£€æµ‹åˆ°ç›¸åŒçš„ç‰¹å¾ã€‚</p>
<p><mark>å…·æœ‰å¹³ç§»ä¸å˜æ€§çš„æ¨¡å‹æ›´å…³æ³¨æ•°æ®ä¸­çš„æœ¬è´¨ç‰¹å¾ï¼Œè€Œä¸æ˜¯ç‰¹å¾å‡ºç°çš„å…·ä½“ä½ç½®ã€‚è¿™ä½¿å¾—æ¨¡å‹å­¦åˆ°çš„ç‰¹å¾å…·æœ‰æ›´å¼ºçš„æ³›åŒ–èƒ½åŠ›ï¼Œèƒ½å¤Ÿé€‚åº”ä¸åŒä½ç½®çš„ç›¸åŒç‰¹å¾ï¼Œæ‰©å¤§äº†è®­ç»ƒæ•°æ®çš„å¤šæ ·æ€§ã€‚</mark></p>
<p><mark>æ¨¡å‹åœ¨è¿™ç§å¤šæ ·åŒ–çš„æ•°æ®ä¸Šå­¦ä¹ ï¼Œèƒ½å¤Ÿæ›´å¥½åœ°æ•æ‰æ•°æ®çš„æ•´ä½“åˆ†å¸ƒï¼Œè€Œä¸æ˜¯è¿‡åº¦æ‹Ÿåˆè®­ç»ƒæ•°æ®ä¸­çš„ç‰¹å®šæ ·æœ¬ã€‚</mark></p>
<p>ç¨€ç–æ€§æ˜¯æŒ‡æ•°æ®æˆ–æ¨¡å‹ä¸­çš„å¤§éƒ¨åˆ†å…ƒç´ ä¸ºé›¶æˆ–æ¥è¿‘é›¶ã€‚åœ¨æ·±åº¦å­¦ä¹ ä¸­ï¼Œç¨€ç–æ€§å¯ä»¥ä½“ç°åœ¨æ•°æ®æœ¬èº«ï¼ˆå¦‚ç¨€ç–çŸ©é˜µï¼‰æˆ–æ¨¡å‹çš„å‚æ•°ï¼ˆå¦‚ç¨€ç–è¿æ¥çš„ç¥ç»ç½‘ç»œï¼‰ä¸Šã€‚ä¾‹å¦‚ï¼Œåœ¨è‡ªç„¶è¯­è¨€å¤„ç†ä¸­ï¼Œè¯åµŒå…¥å‘é‡é€šå¸¸æ˜¯ç¨€ç–çš„ï¼Œå› ä¸ºä¸€ä¸ªå¥å­ä¸­åªåŒ…å«å°‘é‡çš„è¯æ±‡ã€‚</p>
<p><mark>ç¨€ç–æ€§æ„å‘³ç€æ¨¡å‹åªå…³æ³¨æ•°æ®ä¸­çš„å°‘æ•°é‡è¦ç‰¹å¾ï¼Œè€Œå¿½ç•¥äº†å¤§é‡çš„æ— å…³ä¿¡æ¯ã€‚ç¨€ç–æ•°æ®ä¸­çš„éé›¶å…ƒç´ å¾€å¾€ä»£è¡¨äº†æ•°æ®ä¸­çš„é‡è¦ç‰¹å¾ï¼Œå› æ­¤æ¨¡å‹èƒ½å¤Ÿæ›´å‡†ç¡®åœ°æ•æ‰æ•°æ®çš„æœ¬è´¨è§„å¾‹ã€‚è¿™ç§å¯¹é‡è¦ç‰¹å¾çš„èšç„¦ä½¿å¾—æ¨¡å‹åœ¨æ–°æ•°æ®ä¸Šä¹Ÿèƒ½æœ‰è¾ƒå¥½çš„è¡¨ç°ï¼Œå‡å°‘äº†è¿‡æ‹Ÿåˆçš„å¯èƒ½æ€§ã€‚</mark></p>
<p>Dropout ä¸»è¦ç”¨äºé˜²æ­¢æ¨¡å‹è¿‡æ‹Ÿåˆï¼Œé€šè¿‡éšæœºä¸¢å¼ƒéƒ¨åˆ†ç¥ç»å…ƒæ¥å‡å°‘ç¥ç»å…ƒä¹‹é—´çš„å…±é€‚åº”å…³ç³»ã€‚è€Œå…·æœ‰å¹³ç§»ä¸å˜æ€§å’Œç¨€ç–æ€§çš„æ¨¡å‹æœ¬èº«å·²ç»å…·å¤‡äº†ä¸€å®šçš„æŠ—è¿‡æ‹Ÿåˆèƒ½åŠ›ï¼Œå› æ­¤åœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¸éœ€è¦é¢å¤–ä½¿ç”¨ Dropout æ¥é˜²æ­¢è¿‡æ‹Ÿåˆã€‚ä½†è¿™å¹¶ä¸æ„å‘³ç€åœ¨æ‰€æœ‰å…·æœ‰å¹³ç§»ä¸å˜æ€§å’Œç¨€ç–æ€§çš„æ¨¡å‹ä¸­éƒ½ç»å¯¹ä¸éœ€è¦ Dropoutï¼Œå…·ä½“æƒ…å†µè¿˜éœ€è¦æ ¹æ®æ¨¡å‹çš„å¤æ‚åº¦ã€è®­ç»ƒæ•°æ®çš„è§„æ¨¡ç­‰å› ç´ æ¥ç»¼åˆè€ƒè™‘ã€‚</p>
</blockquote>
<ol start="3">
<li><code>nn.Dropout1d/2d/3d</code> ç©ºé—´Dropoutï¼šæŒ‰é€šé“/ç©ºé—´ç½®é›¶</li>
</ol>
<p>æ ‡å‡†çš„ <code>nn.Dropout</code> æ˜¯å¯¹è¾“å…¥å¼ é‡ä¸­çš„æ¯ä¸ªå…ƒç´ ç‹¬ç«‹åœ°ä»¥ä¸€å®šæ¦‚ç‡è¿›è¡Œç½®é›¶æ“ä½œã€‚è€Œç©ºé—´ Dropout åˆ™æ˜¯<strong>æŒ‰é€šé“æˆ–ç©ºé—´ç»´åº¦è¿›è¡Œç½®é›¶</strong>ï¼Œå³ä¸€æ¬¡ä¼šå°†æ•´ä¸ªé€šé“æˆ–ç©ºé—´åŒºåŸŸçš„å…ƒç´ ç½®é›¶ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯å¯ä»¥æ›´å¥½åœ°ä¿ç•™ç‰¹å¾ä¹‹é—´çš„ç›¸å…³æ€§ï¼Œå°¤å…¶é€‚ç”¨äºå¤„ç†å…·æœ‰ç©ºé—´ç»“æ„çš„æ•°æ®ï¼Œå¦‚åºåˆ—æ•°æ®ï¼ˆ<code>nn.Dropout1d</code>ï¼‰ã€å›¾åƒæ•°æ®ï¼ˆ<code>nn.Dropout2d</code>ï¼‰å’Œ 3D æ•°æ®ï¼ˆ<code>nn.Dropout3d</code>ï¼‰ã€‚</p>
<h6 id="åµŒå…¥å±‚">åµŒå…¥å±‚</h6>
<ol>
<li>ä»€ä¹ˆæ˜¯åµŒå…¥ï¼Ÿ</li>
</ol>
<p>åµŒå…¥å±‚ï¼ˆEmbedding Layerï¼‰æ˜¯æ·±åº¦å­¦ä¹ ä¸­ä¸€ç§ç‰¹æ®Šçš„ç¥ç»ç½‘ç»œå±‚ï¼Œä¸»è¦ç”¨äºå°†ç¦»æ•£çš„ç±»åˆ«æ•°æ®ï¼ˆå¦‚å•è¯ã€å•†å“ IDã€ç”¨æˆ· ID ç­‰ï¼‰è½¬æ¢ä¸ºè¿ç»­çš„å‘é‡è¡¨ç¤ºã€‚</p>
<p>åœ¨å¾ˆå¤šå®é™…é—®é¢˜ä¸­ï¼Œæ•°æ®æ˜¯ä»¥ç¦»æ•£çš„ç±»åˆ«å½¢å¼å­˜åœ¨çš„ï¼Œä¾‹å¦‚åœ¨è‡ªç„¶è¯­è¨€å¤„ç†é‡Œçš„å•è¯ï¼Œæ¯ä¸ªå•è¯å°±æ˜¯ä¸€ä¸ªç¦»æ•£çš„ç±»åˆ«ã€‚ç„¶è€Œï¼Œå¤§å¤šæ•°æœºå™¨å­¦ä¹ å’Œæ·±åº¦å­¦ä¹ ç®—æ³•æ›´é€‚åˆå¤„ç†è¿ç»­çš„æ•°å€¼æ•°æ®ã€‚åµŒå…¥å±‚çš„ä½œç”¨å°±æ˜¯æ­å»ºèµ·ç¦»æ•£ç±»åˆ«æ•°æ®å’Œè¿ç»­å‘é‡ç©ºé—´ä¹‹é—´çš„æ¡¥æ¢ï¼ŒæŠŠæ¯ä¸ªç¦»æ•£ç±»åˆ«æ˜ å°„ä¸ºä¸€ä¸ªå›ºå®šé•¿åº¦çš„å‘é‡ã€‚</p>
<p><mark>å·¥ä½œåŸç†</mark></p>
<ul>
<li><strong>æ„å»ºæŸ¥æ‰¾è¡¨</strong>ï¼šåµŒå…¥å±‚æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå¯å­¦ä¹ çš„æŸ¥æ‰¾è¡¨ï¼ˆçŸ©é˜µï¼‰ã€‚å‡è®¾ä¸€å…±æœ‰$V$ä¸ªä¸åŒçš„ç¦»æ•£ç±»åˆ«ï¼Œæ¯ä¸ªç±»åˆ«è¦è¢«æ˜ å°„æˆç»´åº¦ä¸º$d$çš„å‘é‡ï¼Œé‚£ä¹ˆè¿™ä¸ªæŸ¥æ‰¾è¡¨å°±æ˜¯ä¸€ä¸ªå½¢çŠ¶ä¸º$V \times d$çš„çŸ©é˜µã€‚çŸ©é˜µçš„æ¯ä¸€è¡Œå¯¹åº”ä¸€ä¸ªç¦»æ•£ç±»åˆ«çš„å‘é‡è¡¨ç¤ºã€‚</li>
<li><strong>ç´¢å¼•æŸ¥æ‰¾</strong>ï¼šå½“è¾“å…¥ä¸€ä¸ªç¦»æ•£ç±»åˆ«çš„ç´¢å¼•æ—¶ï¼ŒåµŒå…¥å±‚ä¼šæ ¹æ®è¿™ä¸ªç´¢å¼•ä»æŸ¥æ‰¾è¡¨ä¸­å–å‡ºå¯¹åº”çš„è¡Œå‘é‡ä½œä¸ºè¾“å‡ºã€‚åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œè¿™ä¸ªæŸ¥æ‰¾è¡¨çš„å‚æ•°ï¼ˆå³æ¯ä¸ªå‘é‡çš„å…ƒç´ å€¼ï¼‰ä¼šé€šè¿‡åå‘ä¼ æ’­ç®—æ³•ä¸æ–­æ›´æ–°ï¼Œä»è€Œè®©æ¯ä¸ªå‘é‡èƒ½å¤Ÿæ›´å¥½åœ°è¡¨ç¤ºå…¶å¯¹åº”çš„ç¦»æ•£ç±»åˆ«ã€‚</li>
</ul>
<p><mark>ä½œç”¨</mark></p>
<ul>
<li><strong>æ•æ‰è¯­ä¹‰ä¿¡æ¯</strong>ï¼šé€šè¿‡å­¦ä¹ å¾—åˆ°çš„åµŒå…¥å‘é‡èƒ½å¤Ÿæ•æ‰ç¦»æ•£ç±»åˆ«ä¹‹é—´çš„è¯­ä¹‰å…³ç³»ã€‚ä¾‹å¦‚åœ¨è¯åµŒå…¥ä¸­ï¼Œæ„æ€ç›¸è¿‘çš„å•è¯å¯¹åº”çš„å‘é‡åœ¨å‘é‡ç©ºé—´ä¸­ä¼šæ¯”è¾ƒæ¥è¿‘ã€‚åƒ â€œè‹¹æœâ€ å’Œ â€œé¦™è•‰â€ çš„å‘é‡å¯èƒ½è·ç¦»è¾ƒè¿‘ï¼Œå› ä¸ºå®ƒä»¬éƒ½å±äºæ°´æœç±»åˆ«ã€‚</li>
<li><strong>é™ä½ç»´åº¦</strong>ï¼šç›¸æ¯”äºä½¿ç”¨ç‹¬çƒ­ç¼–ç ï¼ˆOne - Hot Encodingï¼‰æ¥è¡¨ç¤ºç¦»æ•£ç±»åˆ«ï¼ŒåµŒå…¥å‘é‡çš„ç»´åº¦é€šå¸¸è¦ä½å¾—å¤šã€‚ç‹¬çƒ­ç¼–ç ä¼šäº§ç”Ÿä¸€ä¸ªéå¸¸é«˜ç»´ä¸”ç¨€ç–çš„å‘é‡ï¼Œè€ŒåµŒå…¥å‘é‡æ˜¯ä½ç»´ä¸”å¯†é›†çš„ï¼Œè¿™æœ‰åŠ©äºå‡å°‘è®¡ç®—é‡å’Œå†…å­˜å ç”¨ï¼ŒåŒæ—¶ä¹Ÿèƒ½æé«˜æ¨¡å‹çš„è®­ç»ƒæ•ˆç‡å’Œæ³›åŒ–èƒ½åŠ›ã€‚</li>
</ul>
<p><mark>åº”ç”¨åœºæ™¯</mark></p>
<ul>
<li><strong>è‡ªç„¶è¯­è¨€å¤„ç†</strong>ï¼šåœ¨å„ç§è‡ªç„¶è¯­è¨€å¤„ç†ä»»åŠ¡ä¸­ï¼Œå¦‚æ–‡æœ¬åˆ†ç±»ã€æƒ…æ„Ÿåˆ†æã€æœºå™¨ç¿»è¯‘ã€å‘½åå®ä½“è¯†åˆ«ç­‰ï¼Œè¯åµŒå…¥å±‚æ˜¯å¿…ä¸å¯å°‘çš„ç»„ä»¶ã€‚å®ƒèƒ½å°†æ–‡æœ¬ä¸­çš„å•è¯è½¬æ¢ä¸ºå‘é‡ï¼Œè®©æ¨¡å‹å¯ä»¥å¯¹æ–‡æœ¬è¿›è¡Œæœ‰æ•ˆçš„å¤„ç†å’Œåˆ†æã€‚</li>
<li><strong>æ¨èç³»ç»Ÿ</strong>ï¼šå¯ä»¥å°†ç”¨æˆ· ID å’Œå•†å“ ID åˆ†åˆ«æ˜ å°„ä¸ºç”¨æˆ·åµŒå…¥å‘é‡å’Œå•†å“åµŒå…¥å‘é‡ï¼Œé€šè¿‡è®¡ç®—è¿™äº›å‘é‡ä¹‹é—´çš„ç›¸ä¼¼åº¦ï¼Œä¸ºç”¨æˆ·æ¨èåˆé€‚çš„å•†å“ã€‚</li>
<li><strong>çŸ¥è¯†å›¾è°±</strong>ï¼šæŠŠå›¾è°±ä¸­çš„å®ä½“å’Œå…³ç³»æ˜ å°„ä¸ºå‘é‡ï¼Œæœ‰åŠ©äºè¿›è¡ŒçŸ¥è¯†æ¨ç†ã€å®ä½“åˆ†ç±»ç­‰ä»»åŠ¡ã€‚</li>
</ul>
<ol start="2">
<li>
<p><code>nn.Embedding</code> è¯åµŒå…¥ï¼šnn.Embedding</p>
</li>
<li>
<p><code>nn.Embedding</code> ç¨€ç–åµŒå…¥ï¼šé«˜æ•ˆå¤„ç†å˜é•¿åºåˆ—</p>
</li>
</ol>
<h6 id="ç¨€ç–å±‚">ç¨€ç–å±‚</h6>
<ol>
<li>
<p>ä»€ä¹ˆæ˜¯ç¨€ç–ï¼Ÿ</p>
</li>
<li>
<p><code>nn.Linearï¼ˆè¾“å…¥ä¸ºç¨€ç–å¼ é‡ï¼‰</code> ç¨€ç–å…¨è¿æ¥ï¼šç¨€ç–çŸ©é˜µä¹˜æ³•</p>
</li>
</ol>
<h6 id="è§†è§‰ä¸“ç”¨å±‚">è§†è§‰ä¸“ç”¨å±‚</h6>
<ol>
<li>
<p><code>nn.PixelShuffle</code> åƒç´ é‡æ’ï¼šå­åƒç´ å·ç§¯ï¼ˆè¶…åˆ†è¾¨ç‡ï¼‰</p>
</li>
<li>
<p><code>nn.Unfold</code> åƒç´ å±•å¼€ï¼šæ»‘åŠ¨çª—å£æå–å±€éƒ¨å—</p>
</li>
<li>
<p><code>nn.Fold</code> åƒç´ æŠ˜å ï¼šé€†æ“ä½œäº <code>Unfold</code></p>
</li>
</ol>
<h5 id="æ¨¡å‹å®¹å™¨">æ¨¡å‹å®¹å™¨</h5>
<ol>
<li>
<p>ä»€ä¹ˆæ˜¯å®¹å™¨ï¼Ÿ</p>
</li>
<li>
<p><code>nn.Sequential</code> å±‚å­—å…¸</p>
</li>
<li>
<p><code>nn.ModuleList</code> åŠ¨æ€å±‚åˆ—è¡¨</p>
</li>
<li>
<p><code>nn.ModuleDict</code>å±‚å­—å…¸</p>
</li>
</ol>
<h4 id="ä¼˜åŒ–å™¨å’ŒæŸå¤±å‡½æ•°">ä¼˜åŒ–å™¨å’ŒæŸå¤±å‡½æ•°</h4>
<h5 id="ä¼˜åŒ–å™¨ï¼ˆOptimizersï¼‰">ä¼˜åŒ–å™¨ï¼ˆOptimizersï¼‰</h5>
<h6 id="ä»€ä¹ˆæ˜¯ä¼˜åŒ–å™¨ï¼Ÿ">ä»€ä¹ˆæ˜¯ä¼˜åŒ–å™¨ï¼Ÿ</h6>
<h6 id="ç»å…¸ä¼˜åŒ–å™¨">ç»å…¸ä¼˜åŒ–å™¨</h6>
<ol>
<li>
<p><code>torch.optim.SGD</code>ï¼ˆå«åŠ¨é‡ï¼‰</p>
</li>
<li>
<p><code>torch.optim.Adam</code>, <code>AdamW</code>, <code>RMSprop</code></p>
</li>
</ol>
<h6 id="å­¦ä¹ ç‡è°ƒåº¦">å­¦ä¹ ç‡è°ƒåº¦</h6>
<ol>
<li>
<p>ä»€ä¹ˆæ˜¯å­¦ä¹ ç‡è°ƒåº¦ï¼Ÿ</p>
</li>
<li>
<p>ç›¸å…³ä¼˜åŒ–å™¨<code>lr_scheduler.StepLR</code>, <code>CosineAnnealingLR</code>, <code>OneCycleLR</code></p>
</li>
</ol>
<h6 id="æ¢¯åº¦è£å‰ª">æ¢¯åº¦è£å‰ª</h6>
<ol>
<li>
<p>ä»€ä¹ˆæ˜¯æ¢¯åº¦è£å‰ªï¼Ÿ</p>
</li>
<li>
<p><code>nn.utils.clip_grad_norm_</code></p>
</li>
</ol>
<h5 id="æŸå¤±å‡½æ•°">æŸå¤±å‡½æ•°</h5>
<h6 id="ä»€ä¹ˆæ˜¯æŸå¤±å‡½æ•°ï¼Ÿ">ä»€ä¹ˆæ˜¯æŸå¤±å‡½æ•°ï¼Ÿ</h6>
<h6 id="åˆ†ç±»ä»»åŠ¡">åˆ†ç±»ä»»åŠ¡</h6>
<p><code>nn.CrossEntropyLoss</code>ï¼Œ<code>nn.BCEWithLogitsLoss</code></p>
<h6 id="å›å½’ä»»åŠ¡">å›å½’ä»»åŠ¡</h6>
<p><code>nn.MSELoss</code>, <code>nn.L1Loss</code>, <code>nn.HuberLoss</code></p>
<h6 id="ç”Ÿæˆä»»åŠ¡">ç”Ÿæˆä»»åŠ¡</h6>
<ol>
<li>
<p>ç”Ÿæˆä»€ä¹ˆï¼Ÿ</p>
</li>
<li>
<p>ç›¸å…³æŸå¤±å‡½æ•°<code>nn.BCELoss</code>, <code>nn.KLDivLoss</code>, å¯¹æŠ—æŸå¤±ï¼ˆå¦‚ WGAN-GPï¼‰</p>
</li>
</ol>
<h4 id="é¢„è®­ç»ƒæ¨¡å‹ï¼ˆtorchvision-modelsï¼‰ä¸è¿ç§»å­¦ä¹ ">é¢„è®­ç»ƒæ¨¡å‹ï¼ˆtorchvision.modelsï¼‰ä¸è¿ç§»å­¦ä¹ </h4>
<h5 id="è®¡ç®—æœºè§†è§‰æ¨¡å‹">è®¡ç®—æœºè§†è§‰æ¨¡å‹</h5>
<h6 id="ç»å…¸-CNN-æ¶æ„ï¼ˆé€šè¿‡-torchvision-modelsï¼‰">ç»å…¸ CNN æ¶æ„ï¼ˆé€šè¿‡ <code>torchvision.models</code>ï¼‰</h6>
<blockquote>
<p><mark>â“ä»€ä¹ˆæ˜¯CNN</mark></p>
</blockquote>
<ol>
<li>
<p>ResNet</p>
</li>
<li>
<p>VGG</p>
</li>
<li>
<p>EfficientNet</p>
</li>
</ol>
<h6 id="Transformer-æ¨¡å‹">Transformer æ¨¡å‹</h6>
<ol>
<li>
<p>Vision Transformer ï¼ˆViTï¼‰</p>
</li>
<li>
<p>Swin Transformer</p>
</li>
</ol>
<h5 id="è‡ªç„¶è¯­è¨€å¤„ç†æ¨¡å‹">è‡ªç„¶è¯­è¨€å¤„ç†æ¨¡å‹</h5>
<h6 id="é¢„è®­ç»ƒè¯­è¨€æ¨¡å‹ï¼ˆé€šè¿‡-transformers-åº“ï¼‰">é¢„è®­ç»ƒè¯­è¨€æ¨¡å‹ï¼ˆé€šè¿‡ <code>transformers</code> åº“ï¼‰</h6>
<ol>
<li>
<p>BERT</p>
</li>
<li>
<p>GPT</p>
</li>
</ol>
<h5 id="è¿ç§»å­¦ä¹ ç­–ç•¥">è¿ç§»å­¦ä¹ ç­–ç•¥</h5>
<p>ä»€ä¹ˆæ˜¯è¿ç§»å­¦ä¹ ç­–ç•¥</p>
<h6 id="ç‰¹å¾æå–ï¼ˆå†»ç»“éƒ¨åˆ†å±‚ï¼‰">ç‰¹å¾æå–ï¼ˆå†»ç»“éƒ¨åˆ†å±‚ï¼‰</h6>
<h6 id="å¾®è°ƒï¼ˆFine-tuningï¼‰">å¾®è°ƒï¼ˆFine-tuningï¼‰</h6>
<h6 id="ä½¿ç”¨é¢„è®­ç»ƒç‰¹å¾ï¼ˆå¦‚-CLIPï¼‰">ä½¿ç”¨é¢„è®­ç»ƒç‰¹å¾ï¼ˆå¦‚ CLIPï¼‰</h6>
<h4 id="æ•°æ®ç®¡é“-Data-Pipeline">æ•°æ®ç®¡é“ (Data Pipeline)</h4>
<h5 id="æ•°æ®é›†ç±»-Dataset">æ•°æ®é›†ç±» <code>Dataset</code></h5>
<p>è‡ªå®šä¹‰æ•°æ®é›†å®ç°</p>
<h5 id="æ•°æ®åŠ è½½å™¨-DataLoader">æ•°æ®åŠ è½½å™¨ <code>DataLoader</code></h5>
<ol>
<li>
<p>æ‰¹é‡åŠ è½½</p>
</li>
<li>
<p>å¤šè¿›ç¨‹åŠ é€Ÿ (<code>num_workers</code>)</p>
</li>
</ol>
<h5 id="æ•°æ®å¢å¼º-torchvision-transforms">æ•°æ®å¢å¼º``torchvision.transforms`</h5>
<h4 id="æ¨¡å‹éƒ¨ç½²ä¸æ€§èƒ½ä¼˜åŒ–">æ¨¡å‹éƒ¨ç½²ä¸æ€§èƒ½ä¼˜åŒ–</h4>
<h5 id="TorchScript-æ¨¡å‹å¯¼å‡º">TorchScript æ¨¡å‹å¯¼å‡º</h5>
<h5 id="ONNX-æ ¼å¼è½¬æ¢">ONNX æ ¼å¼è½¬æ¢</h5>
<h5 id="æ··åˆç²¾åº¦è®­ç»ƒ-torch-cuda-amp">æ··åˆç²¾åº¦è®­ç»ƒ (<code>torch.cuda.amp</code>)</h5>
<h2 id="OSæ“ä½œç³»ç»Ÿæ¥å£æ¨¡å—">OSæ“ä½œç³»ç»Ÿæ¥å£æ¨¡å—</h2>
<h2 id="Numpy">Numpy</h2>
<p>np.stack</p>
]]></content>
      <categories>
        <category>ç§‘ç ”</category>
      </categories>
      <tags>
        <tag>ç§‘ç ”çŸ¥è¯†ç§¯ç´¯</tag>
      </tags>
  </entry>
</search>
