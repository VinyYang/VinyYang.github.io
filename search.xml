<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>ç®—æ³•åŸºç¡€è¯¾(æŒç»­æ›´æ–°ä¸­)</title>
    <url>/algorithm_learning/</url>
    <content><![CDATA[<p>ç®—æ³•åŸºç¡€è¯¾</p>
<h2 id="åŸºç¡€ç®—æ³•ï¼ˆä¸€ï¼‰"><a href="#åŸºç¡€ç®—æ³•ï¼ˆä¸€ï¼‰" class="headerlink" title="åŸºç¡€ç®—æ³•ï¼ˆä¸€ï¼‰"></a>åŸºç¡€ç®—æ³•ï¼ˆä¸€ï¼‰</h2><h3 id="å¿«é€Ÿæ’åº"><a href="#å¿«é€Ÿæ’åº" class="headerlink" title="å¿«é€Ÿæ’åº"></a>å¿«é€Ÿæ’åº</h3><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">quick_sort</span><span class="params">(<span class="type">int</span> q[],<span class="type">int</span> l,<span class="type">int</span> r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(l&gt;=r)<span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> i=l<span class="number">-1</span>,j=r<span class="number">+1</span>,x=q[l+r&gt;&gt;<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">while</span>(i&lt;j)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">do</span> i++;<span class="keyword">while</span>(q[i]&lt;x);</span><br><span class="line">        <span class="keyword">do</span> j--;<span class="keyword">while</span>(q[j]&gt;x);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">quick_sort</span>(q,l,j);</span><br><span class="line">    <span class="built_in">quick_sort</span>(q,j<span class="number">+1</span>,r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å½’å¹¶æ’åº"><a href="#å½’å¹¶æ’åº" class="headerlink" title="å½’å¹¶æ’åº"></a>å½’å¹¶æ’åº</h3><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">merge_sort</span><span class="params">(<span class="type">int</span> q[],<span class="type">int</span> l,<span class="type">int</span> r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(l&gt;=r)<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> mid=l+r&gt;&gt;<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">merge_sort</span>(q,l,mid),<span class="built_in">merge_sort</span>(q,mid<span class="number">+1</span>,r)ï¼›</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> k=<span class="number">0</span>,i=l,j=mid<span class="number">+1</span>;</span><br><span class="line">    <span class="keyword">while</span>(i&lt;=mid&amp;&amp;j&lt;=r)</span><br><span class="line">        <span class="keyword">if</span>(q[i]&lt;=q[j])tmp[k++]=q[i++];</span><br><span class="line">    <span class="keyword">else</span> tmp[k++]=q[j++];</span><br><span class="line">    <span class="keyword">while</span>(i&lt;=mid)tmp[k++]=q[i++];</span><br><span class="line">    <span class="keyword">while</span>(j&lt;=r)tmp[k++]=q[j++];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i=l,j=<span class="number">0</span>;i&lt;=r;i++,j++)q[i]=tmp[j];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="äºŒåˆ†"><a href="#äºŒåˆ†" class="headerlink" title="äºŒåˆ†"></a>äºŒåˆ†</h3><h4 id="æ•´æ•°äºŒåˆ†"><a href="#æ•´æ•°äºŒåˆ†" class="headerlink" title="æ•´æ•°äºŒåˆ†"></a>æ•´æ•°äºŒåˆ†</h4><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">check</span><span class="params">(<span class="type">int</span> x)</span> </span>&#123;<span class="comment">/* ... */</span>&#125; <span class="comment">// æ£€æŸ¥xæ˜¯å¦æ»¡è¶³æŸç§æ€§è´¨</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">// åŒºé—´[l, r]è¢«åˆ’åˆ†æˆ[l, mid]å’Œ[mid + 1, r]æ—¶ä½¿ç”¨ï¼š</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">bsearch_1</span><span class="params">(<span class="type">int</span> l, <span class="type">int</span> r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (l &lt; r)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> mid = l + r &gt;&gt; <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">check</span>(mid)) r = mid;    <span class="comment">// check()åˆ¤æ–­midæ˜¯å¦æ»¡è¶³æ€§è´¨</span></span><br><span class="line">        <span class="keyword">else</span> l = mid + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> l;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// åŒºé—´[l, r]è¢«åˆ’åˆ†æˆ[l, mid - 1]å’Œ[mid, r]æ—¶ä½¿ç”¨ï¼š</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">bsearch_2</span><span class="params">(<span class="type">int</span> l, <span class="type">int</span> r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (l &lt; r)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> mid = l + r + <span class="number">1</span> &gt;&gt; <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">check</span>(mid)) l = mid;</span><br><span class="line">        <span class="keyword">else</span> r = mid - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> l;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="æµ®ç‚¹æ•°äºŒåˆ†"><a href="#æµ®ç‚¹æ•°äºŒåˆ†" class="headerlink" title="æµ®ç‚¹æ•°äºŒåˆ†"></a>æµ®ç‚¹æ•°äºŒåˆ†</h4><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">check</span><span class="params">(<span class="type">double</span> x)</span> </span>&#123;<span class="comment">/* ... */</span>&#125; <span class="comment">// æ£€æŸ¥xæ˜¯å¦æ»¡è¶³æŸç§æ€§è´¨</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">double</span> <span class="title">bsearch_3</span><span class="params">(<span class="type">double</span> l, <span class="type">double</span> r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">double</span> eps = <span class="number">1e-6</span>;   <span class="comment">// eps è¡¨ç¤ºç²¾åº¦ï¼Œå–å†³äºé¢˜ç›®å¯¹ç²¾åº¦çš„è¦æ±‚</span></span><br><span class="line">    <span class="keyword">while</span> (r - l &gt; eps)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">double</span> mid = (l + r) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">check</span>(mid)) r = mid;</span><br><span class="line">        <span class="keyword">else</span> l = mid;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> l;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="åŸºç¡€ç®—æ³•ï¼ˆäºŒï¼‰"><a href="#åŸºç¡€ç®—æ³•ï¼ˆäºŒï¼‰" class="headerlink" title="åŸºç¡€ç®—æ³•ï¼ˆäºŒï¼‰"></a>åŸºç¡€ç®—æ³•ï¼ˆäºŒï¼‰</h2><h3 id="é«˜ç²¾åº¦"><a href="#é«˜ç²¾åº¦" class="headerlink" title="é«˜ç²¾åº¦"></a>é«˜ç²¾åº¦</h3><h4 id="é«˜ç²¾åº¦åŠ æ³•"><a href="#é«˜ç²¾åº¦åŠ æ³•" class="headerlink" title="é«˜ç²¾åº¦åŠ æ³•"></a>é«˜ç²¾åº¦åŠ æ³•</h4><p>æœ¬è´¨ä¸Šæ˜¯æ¨¡æ‹Ÿäººè¿›è¡Œåˆ—ç«–å¼åŠ æ³•çš„è¿‡ç¨‹ï¼Œå³$a_1$+â€¦+$a_n$+tï¼Œå…¶ä¸­å½“$a$çš„é€€ä¸€ä½åŠ èµ·æ¥ä¸è¶…è¿‡10åˆ™$t&#x3D;0$å¦åˆ™$t&#x3D;1$ï¼Œä»¥æ­¤ç±»æ¨</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line">vector&lt;<span class="type">int</span>&gt;<span class="built_in">add</span>(vector&lt;<span class="type">int</span>&gt;&amp;A,vector&lt;<span class="type">int</span>&gt;&amp;B)</span><br><span class="line">&#123;</span><br><span class="line">    vector&lt;<span class="type">int</span>&gt;C;</span><br><span class="line">    <span class="type">int</span> t=<span class="number">0</span>;<span class="comment">//å­˜å‚¨æ¯ä¸€ä½ç›¸åŠ åçš„æ•°ï¼ŒåŒæ—¶å®Œæˆæ˜¯å¦éœ€è¦è¿›ä½çš„è€ƒé‡</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;A.<span class="built_in">size</span>()||i&lt;B.<span class="built_in">size</span>();i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(i&lt;A.<span class="built_in">size</span>())t+=A[i];</span><br><span class="line">        <span class="keyword">if</span>(i&lt;B.<span class="built_in">size</span>())t+=B[i];</span><br><span class="line">        C.<span class="built_in">push_back</span>(t%<span class="number">10</span>);</span><br><span class="line">        t/=<span class="number">10</span>;</span><br><span class="line">	&#125;    </span><br><span class="line">    <span class="keyword">if</span>(t)C.<span class="built_in">push_back</span>(<span class="number">1</span>);<span class="comment">//æœ€åä¸€ä¸ªtä»£è¡¨æœ€é«˜ä½ï¼Œå› æ­¤ç­‰forå¾ªç¯è¿è¡Œå®Œåå†ç”¨åˆ¤æ–­çœ‹çœ‹è¿›ä½æƒ…å†µï¼Œæ˜¯çš„è¯å°±åœ¨vectoråé¢å†åŠ ä¸€ä¸ª1</span></span><br><span class="line">    <span class="keyword">return</span> C;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string a,b;</span><br><span class="line">    vector&lt;<span class="type">int</span>&gt;A,B;</span><br><span class="line">    cin&gt;&gt;a&gt;&gt;b;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=a.<span class="built_in">size</span>()<span class="number">-1</span>;i&gt;=<span class="number">0</span>;i--)A.<span class="built_in">push_back</span>(a[i]-<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=b.<span class="built_in">size</span>()<span class="number">-1</span>;i&gt;=<span class="number">0</span>;i--)B.<span class="built_in">push_back</span>(b[i]-<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line"><span class="comment">//Aã€Bå…ƒç´ è¿›æ ˆéƒ½æ˜¯é€†åºè¿›æ ˆï¼Œæ¯”å¦‚a=&#x27;123456&#x27;,é‚£A=[6.5,4,3,2,1],ç›®çš„æ˜¯æ–¹ä¾¿è¿›ä½å¤šäº†1çš„æ—¶å€™æ•´ä½“æ•°ç»„æŒªåŠ¨ç©ºé—´ä¸å¤§ï¼Œå¦åˆ™è¦æ˜¯æœ€é«˜ä½åœ¨å‰è¾¹taè¿›ä½åé¢æ•°ç»„æ‰€æœ‰æ•°å­—éƒ½è¦å¾€åæŒª</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">auto</span> C=<span class="built_in">add</span>(A,B);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=C.<span class="built_in">size</span>()<span class="number">-1</span>;i&gt;=<span class="number">0</span>;i--)cout&lt;&lt;C[i];</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="vectorç›¸å…³çŸ¥è¯†ç‚¹"><a href="#vectorç›¸å…³çŸ¥è¯†ç‚¹" class="headerlink" title="vectorç›¸å…³çŸ¥è¯†ç‚¹"></a>vectorç›¸å…³çŸ¥è¯†ç‚¹</h5><ul>
<li><p><strong>vectorå®šä¹‰</strong> <code>vector</code> æ˜¯ C++ æ ‡å‡†æ¨¡æ¿åº“ï¼ˆSTLï¼‰ä¸­çš„ä¸€ä¸ªå®¹å™¨ï¼Œå®ƒå¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªåŠ¨æ€æ•°ç»„ã€‚å®ƒèƒ½å­˜å‚¨ä¸€ç³»åˆ—ç›¸åŒç±»å‹çš„å…ƒç´ ï¼Œå¹¶ä¸”å¯ä»¥æ ¹æ®éœ€è¦è‡ªåŠ¨è°ƒæ•´å¤§å°ã€‚ä½¿ç”¨ <code>vector</code> éœ€è¦åŒ…å« <code>&lt;vector&gt;</code> å¤´æ–‡ä»¶ã€‚</p>
</li>
<li><p><strong>vectoræ•°ç»„ç›¸å…³æ“ä½œ</strong>ï¼ˆæœ€åé¢ï¼‰å¢åŠ ç”¨<code>.push_back(ä¸€ä¸ªæ•°)</code>ï¼Œï¼ˆæœ€åé¢ï¼‰åˆ é™¤<code>.pop_back(ä¸€ä¸ªæ•°)</code>ï¼ŒæŒ‡å®šä½ç½®æ’å…¥<code>.insert(å‘é‡,æŒ‡å®šä½ç½®)</code>ï¼ŒæŒ‡å®šä½ç½®åˆ é™¤<code>.erase(å‘é‡ï¼ŒæŒ‡å®šä½ç½®)</code>ï¼Œæ¸…ç©º<code>.clear()</code>ï¼ŒæŸ¥çœ‹å¤§å°<code>.size()</code></p>
</li>
<li><p><strong>vectorå…ƒç´ çš„ç´¢å¼•å’Œæ•°ç»„ä¸€æ ·ï¼Œä¹Ÿæ˜¯ä» 0 å¼€å§‹å­˜å‚¨çš„</strong></p>
</li>
<li><p><strong>vectorå’Œæ™®é€šæ•°ç»„åŒºåˆ«</strong></p>
<p>1.å¤§å°çµæ´»æ€§</p>
<ul>
<li><strong>æ™®é€šæ•°ç»„</strong>ï¼šå¤§å°åœ¨å®šä¹‰æ—¶å°±å¿…é¡»ç¡®å®šï¼Œä¸”åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ä¸èƒ½æ”¹å˜ã€‚ä¾‹å¦‚ <code>int arr[10];</code> å®šä¹‰äº†ä¸€ä¸ªå¤§å°ä¸º 10 çš„æ•´æ•°æ•°ç»„ï¼Œä¹‹åæ— æ³•å†æ”¹å˜å…¶å¤§å°ã€‚</li>
<li><strong>vector</strong>ï¼šå¯ä»¥åŠ¨æ€è°ƒæ•´å¤§å°ã€‚å¯ä»¥ä½¿ç”¨ <code>push_back()</code> æ–¹æ³•åœ¨æœ«å°¾æ·»åŠ å…ƒç´ ï¼Œå½“ç©ºé—´ä¸è¶³æ—¶ï¼Œ<code>vector</code> ä¼šè‡ªåŠ¨åˆ†é…æ›´å¤§çš„å†…å­˜ç©ºé—´æ¥å­˜å‚¨å…ƒç´ ã€‚</li>
</ul>
<p>2.å†…å­˜ç®¡ç†</p>
<ul>
<li><strong>æ™®é€šæ•°ç»„</strong>ï¼šç”±ç¨‹åºå‘˜æ‰‹åŠ¨ç®¡ç†å†…å­˜ã€‚å¦‚æœæ•°ç»„åœ¨æ ˆä¸Šåˆ†é…ï¼Œå…¶ç”Ÿå‘½å‘¨æœŸå—é™äºæ‰€åœ¨çš„ä»£ç å—ï¼›å¦‚æœåœ¨å †ä¸Šåˆ†é…ï¼ˆä½¿ç”¨ <code>new</code>ï¼‰ï¼Œåˆ™éœ€è¦æ‰‹åŠ¨ä½¿ç”¨ <code>delete</code> é‡Šæ”¾å†…å­˜ï¼Œå¦åˆ™ä¼šé€ æˆå†…å­˜æ³„æ¼ã€‚</li>
<li><strong>vector</strong>ï¼šè‡ªåŠ¨ç®¡ç†å†…å­˜ã€‚å½“ <code>vector</code> ä¸å†ä½¿ç”¨æ—¶ï¼Œå…¶å ç”¨çš„å†…å­˜ä¼šè‡ªåŠ¨é‡Šæ”¾ï¼Œæ— éœ€ç¨‹åºå‘˜æ‰‹åŠ¨å¹²é¢„ã€‚</li>
</ul>
<p>3.åŠŸèƒ½ä¸°å¯Œåº¦</p>
<ul>
<li><strong>æ™®é€šæ•°ç»„</strong>ï¼šåªæä¾›åŸºæœ¬çš„å…ƒç´ è®¿é—®åŠŸèƒ½ï¼Œæ“ä½œç›¸å¯¹æœ‰é™ã€‚</li>
<li><strong>vector</strong>ï¼šæä¾›äº†ä¸°å¯Œçš„æˆå‘˜å‡½æ•°ï¼Œå¦‚ <code>size()</code> è·å–å…ƒç´ æ•°é‡ã€<code>empty()</code> åˆ¤æ–­æ˜¯å¦ä¸ºç©ºã€<code>clear()</code> æ¸…ç©ºå…ƒç´ ç­‰ï¼Œä½¿ç”¨èµ·æ¥æ›´åŠ æ–¹ä¾¿ã€‚</li>
</ul>
</li>
<li><p><strong>ä½¿ç”¨ vector è€Œä¸ç”¨æ•°ç»„çš„åŸå› </strong></p>
<p>åœ¨å¤§æ•´æ•°ç›¸åŠ çš„åœºæ™¯ä¸­ï¼Œè¾“å…¥çš„æ•°å­—é•¿åº¦æ˜¯ä¸ç¡®å®šçš„ã€‚å¦‚æœä½¿ç”¨æ™®é€šæ•°ç»„ï¼Œéœ€è¦é¢„å…ˆå®šä¹‰ä¸€ä¸ªè¶³å¤Ÿå¤§çš„æ•°ç»„æ¥å­˜å‚¨æ•°å­—çš„æ¯ä¸€ä½ï¼Œä½†è¿™æ ·å¯èƒ½ä¼šæµªè´¹å¤§é‡çš„å†…å­˜ç©ºé—´ã€‚è€Œ <code>vector</code> å¯ä»¥æ ¹æ®è¾“å…¥æ•°å­—çš„å®é™…é•¿åº¦åŠ¨æ€è°ƒæ•´å¤§å°ï¼Œé¿å…äº†å†…å­˜çš„æµªè´¹ï¼Œå¹¶ä¸”å…¶æä¾›çš„ <code>push_back()</code> æ–¹æ³•å¯ä»¥æ–¹ä¾¿åœ°å°†æ•°å­—çš„æ¯ä¸€ä½æ·»åŠ åˆ°å®¹å™¨ä¸­ï¼ŒåŒæ—¶åœ¨å¤„ç†è¿›ä½æ—¶ä¹Ÿæ›´åŠ æ–¹ä¾¿ã€‚å› æ­¤ï¼Œä½¿ç”¨ <code>vector</code> èƒ½æ›´å¥½åœ°é€‚åº”è¿™ç§åŠ¨æ€é•¿åº¦çš„éœ€æ±‚ã€‚</p>
</li>
</ul>
<h5 id="addå‡½æ•°è¿è¡Œç¤ºä¾‹"><a href="#addå‡½æ•°è¿è¡Œç¤ºä¾‹" class="headerlink" title="addå‡½æ•°è¿è¡Œç¤ºä¾‹"></a>addå‡½æ•°è¿è¡Œç¤ºä¾‹</h5><p>å‡è®¾æˆ‘ä»¬è¦è®¡ç®—ä¸¤ä¸ªå››ä½æ•° <code>a = 1234</code> å’Œ <code>b = 5678</code> çš„å’Œã€‚</p>
<p>åœ¨ä»£ç ä¸­ï¼Œè¾“å…¥çš„æ•°å­—ä»¥å­—ç¬¦ä¸²å½¢å¼å­˜å‚¨ï¼Œç„¶åå°†å…¶é€†åºå­˜å‚¨åˆ° <code>vector&lt;int&gt;</code> ä¸­ï¼Œè¿™æ ·åšæ˜¯ä¸ºäº†æ–¹ä¾¿å¤„ç†è¿›ä½ã€‚å¯¹äº <code>a = 1234</code>ï¼Œå­˜å‚¨åœ¨ <code>vector&lt;int&gt;</code> ä¸­ä¸º <code>A = &#123;4, 3, 2, 1&#125;</code>ï¼›å¯¹äº <code>b = 5678</code>ï¼Œå­˜å‚¨åœ¨ <code>vector&lt;int&gt;</code> ä¸­ä¸º <code>B = &#123;8, 7, 6, 5&#125;</code>ã€‚</p>
<p>å…·ä½“æ­¥éª¤ï¼š</p>
<ul>
<li><p><input checked="" disabled="" type="checkbox"> 
åˆå§‹åŒ–</p>
</li>
<li><p><code>vector&lt;int&gt; C;</code>ï¼šç”¨äºå­˜å‚¨ç›¸åŠ ç»“æœçš„å‘é‡ï¼Œåˆå§‹ä¸ºç©ºã€‚</p>
</li>
<li><p><code>int t = 0;</code>ï¼šç”¨äºå­˜å‚¨æ¯ä¸€ä½ç›¸åŠ åçš„ç»“æœä»¥åŠè¿›ä½ä¿¡æ¯ï¼Œåˆå§‹å€¼ä¸º 0ã€‚</p>
</li>
<li><p><input checked="" disabled="" type="checkbox"> 
å¾ªç¯å¤„ç†æ¯ä¸€ä½</p>
</li>
</ul>
<p>å¾ªç¯æ¡ä»¶ä¸º <code>i &lt; A.size() || i &lt; B.size()</code>ï¼Œè¿™æ„å‘³ç€åªè¦ <code>A</code> æˆ– <code>B</code> è¿˜æœ‰æœªå¤„ç†çš„ä½ï¼Œå°±ä¼šç»§ç»­å¾ªç¯ã€‚</p>
<ul>
<li><p><input disabled="" type="checkbox"> 
ç¬¬ä¸€æ¬¡å¾ªç¯ï¼ˆ<code>i = 0</code>ï¼‰</p>
</li>
<li><p><code>if(i &lt; A.size()) t += A[i];</code>ï¼šå› ä¸º <code>i = 0</code> å°äº <code>A.size()</code>ï¼ˆ4ï¼‰ï¼Œæ‰€ä»¥ <code>t = t + A[0] = 0 + 4 = 4</code>ã€‚</p>
</li>
<li><p><code>if(i &lt; B.size()) t += B[i];</code>ï¼šå› ä¸º <code>i = 0</code> å°äº <code>B.size()</code>ï¼ˆ4ï¼‰ï¼Œæ‰€ä»¥ <code>t = t + B[0] = 4 + 8 = 12</code>ã€‚</p>
</li>
<li><p><code>C.push_back(t % 10);</code>ï¼šå°† <code>t % 10</code>ï¼ˆå³ 2ï¼‰æ·»åŠ åˆ° <code>C</code> ä¸­ï¼Œæ­¤æ—¶ <code>C = &#123;2&#125;</code>ã€‚</p>
</li>
<li><p><code>t /= 10;</code>ï¼š<code>t</code> é™¤ä»¥ 10ï¼Œå¾—åˆ°è¿›ä½ 1ï¼Œå³ <code>t = 1</code>ã€‚</p>
</li>
<li><p><input disabled="" type="checkbox"> 
ç¬¬äºŒæ¬¡å¾ªç¯ï¼ˆ<code>i = 1</code>ï¼‰</p>
</li>
<li><p><code>if(i &lt; A.size()) t += A[i];</code>ï¼š<code>t = t + A[1] = 1 + 3 = 4</code>ã€‚</p>
</li>
<li><p><code>if(i &lt; B.size()) t += B[i];</code>ï¼š<code>t = t + B[1] = 4 + 7 = 11</code>ã€‚</p>
</li>
<li><p><code>C.push_back(t % 10);</code>ï¼šå°† <code>t % 10</code>ï¼ˆå³ 1ï¼‰æ·»åŠ åˆ° <code>C</code> ä¸­ï¼Œæ­¤æ—¶ <code>C = &#123;2, 1&#125;</code>ã€‚</p>
</li>
<li><p><code>t /= 10;</code>ï¼š<code>t</code> é™¤ä»¥ 10ï¼Œå¾—åˆ°è¿›ä½ 1ï¼Œå³ <code>t = 1</code>ã€‚</p>
</li>
<li><p><input disabled="" type="checkbox"> 
ç¬¬ä¸‰æ¬¡å¾ªç¯ï¼ˆ<code>i = 2</code>ï¼‰</p>
</li>
<li><p><code>if(i &lt; A.size()) t += A[i];</code>ï¼š<code>t = t + A[2] = 1 + 2 = 3</code>ã€‚</p>
</li>
<li><p><code>if(i &lt; B.size()) t += B[i];</code>ï¼š<code>t = t + B[2] = 3 + 6 = 9</code>ã€‚</p>
</li>
<li><p><code>C.push_back(t % 10);</code>ï¼šå°† <code>t % 10</code>ï¼ˆå³ 9ï¼‰æ·»åŠ åˆ° <code>C</code> ä¸­ï¼Œæ­¤æ—¶ <code>C = &#123;2, 1, 9&#125;</code>ã€‚</p>
</li>
<li><p><code>t /= 10;</code>ï¼š<code>t</code> é™¤ä»¥ 10ï¼Œå¾—åˆ°è¿›ä½ 0ï¼Œå³ <code>t = 0</code>ã€‚</p>
</li>
<li><p><input disabled="" type="checkbox"> 
ç¬¬å››æ¬¡å¾ªç¯ï¼ˆ<code>i = 3</code>ï¼‰</p>
</li>
<li><p><code>if(i &lt; A.size()) t += A[i];</code>ï¼š<code>t = t + A[3] = 0 + 1 = 1</code>ã€‚</p>
</li>
<li><p><code>if(i &lt; B.size()) t += B[i];</code>ï¼š<code>t = t + B[3] = 1 + 5 = 6</code>ã€‚</p>
</li>
<li><p><code>C.push_back(t % 10);</code>ï¼šå°† <code>t % 10</code>ï¼ˆå³ 6ï¼‰æ·»åŠ åˆ° <code>C</code> ä¸­ï¼Œæ­¤æ—¶ <code>C = &#123;2, 1, 9, 6&#125;</code>ã€‚</p>
</li>
<li><p><code>t /= 10;</code>ï¼š<code>t</code> é™¤ä»¥ 10ï¼Œå¾—åˆ°è¿›ä½ 0ï¼Œå³ <code>t = 0</code>ã€‚</p>
</li>
<li><p><input checked="" disabled="" type="checkbox"> 
å¤„ç†æœ€åå¯èƒ½çš„è¿›ä½</p>
</li>
</ul>
<p><code>if(t) C.push_back(1);</code></p>
<p>å› ä¸ºæ­¤æ—¶ <code>t = 0</code>ï¼Œæ‰€ä»¥ä¸éœ€è¦æ·»åŠ é¢å¤–çš„è¿›ä½ï¼Œ<code>C</code> ä»ç„¶ä¸º <code>&#123;2, 1, 9, 6&#125;</code>ã€‚</p>
<ul>
<li><input checked="" disabled="" type="checkbox"> è¿”å›ç»“æœ</li>
</ul>
<p><code>return C;</code>ï¼šè¿”å›å­˜å‚¨ç›¸åŠ ç»“æœçš„å‘é‡ <code>C</code>ã€‚</p>
<p>åœ¨ <code>main</code> å‡½æ•°ä¸­ï¼Œå°† <code>C</code> é€†åºè¾“å‡ºï¼Œå¾—åˆ°æœ€ç»ˆç»“æœ <code>6912</code>ï¼Œå³ <code>1234 + 5678 = 6912</code>ã€‚</p>
<h5 id="autoçš„ç”¨æ³•"><a href="#autoçš„ç”¨æ³•" class="headerlink" title="autoçš„ç”¨æ³•"></a>autoçš„ç”¨æ³•</h5><p><code>auto</code>æ˜¯C++11çš„æ–°ç‰¹æ€§ï¼Œå¯ä»¥è‡ªåŠ¨è¯†åˆ«å˜é‡å±æ€§ã€‚æ¯”å¦‚<code>auto C=add(A,B);</code>å°±è‡ªåŠ¨è¯†åˆ«äº†addè¿”å›çš„ç±»å‹ï¼Œå› æ­¤<code>auto C &lt;=&gt; vector&lt;int&gt;c</code></p>
<h5 id="a-i-0-çš„ä½œç”¨ï¼šå°†å­—ç¬¦ä¸²æ¯ä¸€ä½ç”±ASCIIç è½¬ä¸ºæ•´æ•°"><a href="#a-i-0-çš„ä½œç”¨ï¼šå°†å­—ç¬¦ä¸²æ¯ä¸€ä½ç”±ASCIIç è½¬ä¸ºæ•´æ•°" class="headerlink" title="a[i] - &#39;0&#39; çš„ä½œç”¨ï¼šå°†å­—ç¬¦ä¸²æ¯ä¸€ä½ç”±ASCIIç è½¬ä¸ºæ•´æ•°"></a><code>a[i] - &#39;0&#39;</code> çš„ä½œç”¨ï¼šå°†å­—ç¬¦ä¸²æ¯ä¸€ä½ç”±ASCIIç è½¬ä¸ºæ•´æ•°</h5><p>åœ¨ C++ ä¸­ï¼Œå½“ä½ ä»è¾“å…¥è¯»å–ä¸€ä¸ªæ•°å­—å­—ç¬¦ä¸²æ—¶ï¼Œæ¯”å¦‚ <code>&quot;123&quot;</code>ï¼Œå­—ç¬¦ä¸²ä¸­çš„æ¯ä¸ªå­—ç¬¦ï¼ˆå¦‚ <code>&#39;1&#39;</code>ã€<code>&#39;2&#39;</code>ã€<code>&#39;3&#39;</code>ï¼‰å®é™…ä¸Šå­˜å‚¨çš„æ˜¯å­—ç¬¦çš„ ASCII ç å€¼ï¼Œè€Œä¸æ˜¯å¯¹åº”çš„æ•°å€¼ã€‚å­—ç¬¦ <code>&#39;0&#39;</code> åˆ° <code>&#39;9&#39;</code> çš„ ASCII ç æ˜¯è¿ç»­çš„ï¼Œ<code>&#39;0&#39;</code> çš„ ASCII ç å€¼æ˜¯ 48ï¼Œ<code>&#39;1&#39;</code> æ˜¯ 49ï¼Œä»¥æ­¤ç±»æ¨ï¼Œ<code>&#39;9&#39;</code> æ˜¯ 57ã€‚</p>
<p><code>b[i] - &#39;0&#39;</code> çš„ä½œç”¨å°±æ˜¯å°†å­—ç¬¦å½¢å¼çš„æ•°å­—è½¬æ¢ä¸ºå¯¹åº”çš„æ•´æ•°å€¼ã€‚ä¾‹å¦‚ï¼Œå½“ <code>b[i]</code> ä¸º <code>&#39;1&#39;</code> æ—¶ï¼Œ<code>&#39;1&#39;</code> çš„ ASCII ç å€¼æ˜¯ 49ï¼Œ<code>&#39;0&#39;</code> çš„ ASCII ç å€¼æ˜¯ 48ï¼Œé‚£ä¹ˆ <code>&#39;1&#39; - &#39;0&#39;</code> å°±ç­‰äº <code>49 - 48 = 1</code>ï¼Œè¿™æ ·å°±æŠŠå­—ç¬¦ <code>&#39;1&#39;</code> è½¬æ¢ä¸ºäº†æ•´æ•° 1ã€‚</p>
<p>å¦‚æœæ²¡æœ‰ <code>b[i] - &#39;0&#39;</code> è¿™ä¸ªæ“ä½œï¼Œç›´æ¥å°†å­—ç¬¦å­˜å‚¨åˆ° <code>vector&lt;int&gt;</code> ä¸­ï¼Œé‚£ä¹ˆå­˜å‚¨çš„æ˜¯å­—ç¬¦çš„ ASCII ç å€¼ï¼Œè€Œä¸æ˜¯å¯¹åº”çš„æ•°å€¼ï¼Œè¿™ä¼šå¯¼è‡´åç»­çš„è®¡ç®—å‡ºç°é”™è¯¯ã€‚</p>
<h4 id="é«˜ç²¾åº¦å‡æ³•"><a href="#é«˜ç²¾åº¦å‡æ³•" class="headerlink" title="é«˜ç²¾åº¦å‡æ³•"></a>é«˜ç²¾åº¦å‡æ³•</h4><h4 id="é«˜ç²¾åº¦ä¹˜æ³•"><a href="#é«˜ç²¾åº¦ä¹˜æ³•" class="headerlink" title="é«˜ç²¾åº¦ä¹˜æ³•"></a>é«˜ç²¾åº¦ä¹˜æ³•</h4><h4 id="é«˜ç²¾åº¦é™¤æ³•"><a href="#é«˜ç²¾åº¦é™¤æ³•" class="headerlink" title="é«˜ç²¾åº¦é™¤æ³•"></a>é«˜ç²¾åº¦é™¤æ³•</h4>]]></content>
      <categories>
        <category>ç®—æ³•é¢˜</category>
      </categories>
      <tags>
        <tag>ACWing</tag>
      </tags>
  </entry>
  <entry>
    <title>å¦‚ä½•ç”¨hexoæ–°å»ºæ–‡ä»¶å¹¶ä¸Šä¼ /å¦‚ä½•ç”¨hexoæ’å…¥å›¾ç‰‡ï¼ˆnextä¸»é¢˜ï¼‰</title>
    <url>/hexo_maintanance/</url>
    <content><![CDATA[<p>hexoï¼ˆåšä¸»é‡‡ç”¨nextä¸»é¢˜ï¼‰æ—¥å¸¸ç»´æŠ¤æ•™ç¨‹</p>
<h1 id="ä¿®æ”¹scaffolds-post-mdï¼ˆé»˜è®¤æ ‡é¢˜æ–‡ä»¶ï¼‰"><a href="#ä¿®æ”¹scaffolds-post-mdï¼ˆé»˜è®¤æ ‡é¢˜æ–‡ä»¶ï¼‰" class="headerlink" title="ä¿®æ”¹scaffolds&#x2F;post.mdï¼ˆé»˜è®¤æ ‡é¢˜æ–‡ä»¶ï¼‰"></a>ä¿®æ”¹scaffolds&#x2F;post.mdï¼ˆé»˜è®¤æ ‡é¢˜æ–‡ä»¶ï¼‰</h1><p>æ³¨æ„ä¿®æ”¹æ—¶ä¸è¦æŠŠä¸­æ–‡åŠ è¿›å»ï¼Œåœ¨æ­¤åªèµ·åˆ°æ³¨é‡Šä½œç”¨</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">title: &#123;&#123; title &#125;&#125;</span><br><span class="line">date: &#123;&#123; date &#125;&#125;</span><br><span class="line">tags:([1,2]è®¾ç½®åŒæ—¶å±äºä¸åŒç±»åˆ«å¯ä»¥è¿™æ ·)</span><br><span class="line">categories:</span><br><span class="line">top:(è¡¨ç¤ºç½®é¡¶æƒ…å†µï¼Œä¸ç½®é¡¶ä¸å¡«å³å¯æ•°å­—å¤§å°ä»£è¡¨ç½®é¡¶é¡ºåºï¼Œæ•°å­—è¶Šå¤§æ’åºè¶Šå‰)</span><br></pre></td></tr></table></figure>



<h1 id="æ–°å»ºmdæ–‡ä»¶"><a href="#æ–°å»ºmdæ–‡ä»¶" class="headerlink" title="æ–°å»ºmdæ–‡ä»¶"></a>æ–°å»ºmdæ–‡ä»¶</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hexo new/hexo n &quot;æ–‡ä»¶å&quot;</span><br></pre></td></tr></table></figure>

<h1 id="æŸ¥çœ‹æ–°å»ºæ–‡ä»¶"><a href="#æŸ¥çœ‹æ–°å»ºæ–‡ä»¶" class="headerlink" title="æŸ¥çœ‹æ–°å»ºæ–‡ä»¶"></a>æŸ¥çœ‹æ–°å»ºæ–‡ä»¶</h1><p>è¿›å…¥ç›®å½•æ˜¯source&#x2F;_posts</p>
<h1 id="å®Œå–„æ ‡é¢˜å¯¹åº”ä¿¡æ¯ï¼Œå¡«å†™md"><a href="#å®Œå–„æ ‡é¢˜å¯¹åº”ä¿¡æ¯ï¼Œå¡«å†™md" class="headerlink" title="å®Œå–„æ ‡é¢˜å¯¹åº”ä¿¡æ¯ï¼Œå¡«å†™md"></a>å®Œå–„æ ‡é¢˜å¯¹åº”ä¿¡æ¯ï¼Œå¡«å†™md</h1><p>ä¹Ÿå°±æ˜¯åˆšæ‰ä¸Šé¢é‚£å †ä¸œè¥¿</p>
<h1 id="åœ¨blogç›®å½•ä¸‹ï¼ˆå› äººè€Œå¼‚ï¼‰æ‰“å¼€git-bash"><a href="#åœ¨blogç›®å½•ä¸‹ï¼ˆå› äººè€Œå¼‚ï¼‰æ‰“å¼€git-bash" class="headerlink" title="åœ¨blogç›®å½•ä¸‹ï¼ˆå› äººè€Œå¼‚ï¼‰æ‰“å¼€git bash"></a>åœ¨blogç›®å½•ä¸‹ï¼ˆå› äººè€Œå¼‚ï¼‰æ‰“å¼€git bash</h1><p>è¾“å…¥</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hexo clean</span><br><span class="line">hexo g -d</span><br></pre></td></tr></table></figure>

<p>å³å¯ä¸Šä¼ </p>
<p>è¾“å…¥</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hexo s</span><br></pre></td></tr></table></figure>

<p>å³å¯å®æ—¶æŸ¥çœ‹ç½‘é¡µ</p>
<h1 id="æ’å…¥å›¾ç‰‡æ“ä½œï¼ˆå›¾ç‰‡å’Œmdæ–‡ä»¶æœ€å¥½å‡ä¸ºè‹±æ–‡åï¼‰"><a href="#æ’å…¥å›¾ç‰‡æ“ä½œï¼ˆå›¾ç‰‡å’Œmdæ–‡ä»¶æœ€å¥½å‡ä¸ºè‹±æ–‡åï¼‰" class="headerlink" title="æ’å…¥å›¾ç‰‡æ“ä½œï¼ˆå›¾ç‰‡å’Œmdæ–‡ä»¶æœ€å¥½å‡ä¸ºè‹±æ–‡åï¼‰"></a>æ’å…¥å›¾ç‰‡æ“ä½œï¼ˆå›¾ç‰‡å’Œmdæ–‡ä»¶æœ€å¥½å‡ä¸ºè‹±æ–‡åï¼‰</h1><h2 id="ä¸‹æ’ä»¶"><a href="#ä¸‹æ’ä»¶" class="headerlink" title="ä¸‹æ’ä»¶"></a>ä¸‹æ’ä»¶</h2><p>è§<a href="https://github.com/yiyungent/hexo-asset-img">yiyungent&#x2F;hexo-asset-imgï¼šğŸ° Hexo æœ¬åœ°å›¾ç‰‡æ’ä»¶ã€‚|Hexo æœ¬åœ°å›¾ç‰‡æ’ä»¶ï¼šè½¬æ¢å›¾ç‰‡ç›¸å¯¹è·¯å¾„ä¸ºasset_img</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install hexo-asset-img --save</span><br><span class="line">æˆ–è€…</span><br><span class="line">npm install git://github.com/yiyungent/hexo-asset-img.git#main</span><br></pre></td></tr></table></figure>

<h2 id="ä¿®æ”¹host-config-yml"><a href="#ä¿®æ”¹host-config-yml" class="headerlink" title="ä¿®æ”¹host&#x2F;_config.yml"></a>ä¿®æ”¹host&#x2F;_config.yml</h2><p>permalinkæ§åˆ¶äº†æ°¸ä¹…åŸŸåçš„æ ·å¼</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1.post_asset_folder: true</span><br><span class="line">2.permalink: :title/ï¼ˆæˆ‘çš„è‡ªå¸¦äº†æ—¥æœŸå¯¼è‡´å›¾ç‰‡ä¸€ç›´ä¸è¡Œ:year/:month/:date/:title/ï¼‰</span><br></pre></td></tr></table></figure>

<h2 id="ç›´æ¥ç²˜è´´å›¾ç‰‡"><a href="#ç›´æ¥ç²˜è´´å›¾ç‰‡" class="headerlink" title="ç›´æ¥ç²˜è´´å›¾ç‰‡"></a>ç›´æ¥ç²˜è´´å›¾ç‰‡</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">![1](./hexo_maintanance/1.png)</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢æ˜¯ä¸‹é¢å›¾ç‰‡çš„è·¯å¾„ã€‚èƒ½çœ‹åˆ°ä¸‹é¢çš„å›¾ç‰‡å°±èƒ½è¯´æ˜è¿™ä¸ªæ–¹æ³•å°±æ˜¯æˆåŠŸçš„ã€‚</p>
<p><img src="/./hexo_maintanance/1.png" alt="1"></p>
<h1 id="å®ç°ä¾§è¾¹æ æ ‡é¢˜å…¨å±•å¼€"><a href="#å®ç°ä¾§è¾¹æ æ ‡é¢˜å…¨å±•å¼€" class="headerlink" title="å®ç°ä¾§è¾¹æ æ ‡é¢˜å…¨å±•å¼€"></a>å®ç°ä¾§è¾¹æ æ ‡é¢˜å…¨å±•å¼€</h1><p>æœ‰äº›æ–‡ä»¶ç›®å½•å¾ˆé•¿ï¼Œä¸å…¨å±•å¼€ä¸æ–¹ä¾¿çœ‹ã€‚å¯ä»¥ä¿®æ”¹</p>
<p><code>blog\themes\next\source\css\_common\outline\sidebar\sidebar-toc.styl</code>æ–‡ä»¶</p>
<p>æŸ¥æ‰¾ä¿®æ”¹<code>.nav-child</code>å¯¹åº”ä»£ç ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">.<span class="property">nav</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (not hexo-<span class="title function_">config</span>(<span class="string">&#x27;toc.expand_all&#x27;</span>)) &#123;</span><br><span class="line">    .<span class="property">nav</span>-child &#123;</span><br><span class="line">      --<span class="attr">height</span>: auto;          <span class="comment">/* å–æ¶ˆé«˜åº¦é™åˆ¶ */</span></span><br><span class="line">      <span class="attr">height</span>: auto;            <span class="comment">/* å¯ç”¨è‡ªåŠ¨é«˜åº¦é€‚åº”å†…å®¹ */</span></span><br><span class="line">      <span class="attr">opacity</span>: <span class="number">1</span>;              <span class="comment">/* å–æ¶ˆé€æ˜åº¦éšè— */</span></span><br><span class="line">      <span class="attr">overflow</span>: visible;       <span class="comment">/* å…è®¸å†…å®¹æº¢å‡ºæ˜¾ç¤º */</span></span><br><span class="line">      transition-<span class="attr">property</span>: opacity;  <span class="comment">/* ä»…ä¿ç•™é€æ˜åº¦è¿‡æ¸¡ */</span></span><br><span class="line">      <span class="attr">visibility</span>: visible;     <span class="comment">/* ç¡®ä¿å…ƒç´ å¯è§ */</span></span><br><span class="line">      <span class="attr">transition</span>: $transition-ease;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>åŸé…ç½®ä¸ºï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">åŸé…ç½®--<span class="attr">height</span>: <span class="number">0</span>;</span><br><span class="line"><span class="attr">height</span>: <span class="number">0</span>;</span><br><span class="line"><span class="attr">opacity</span>: <span class="number">0</span>;</span><br><span class="line"><span class="attr">overflow</span>: hidden;</span><br><span class="line">transition-<span class="attr">property</span>: height, opacity, visibility;</span><br><span class="line"><span class="attr">transition</span>: $transition-ease;</span><br><span class="line"><span class="attr">visibility</span>: hidden;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>åšå®¢ç»´æŠ¤</category>
      </categories>
      <tags>
        <tag>åšå®¢ç»´æŠ¤</tag>
      </tags>
  </entry>
  <entry>
    <title>æ‰‹æ’•OCC-NeRF:Occlusion-Free Scene Recovery via Neural Radiance Fields</title>
    <url>/%E6%89%8B%E6%92%95nerfmm/</url>
    <content><![CDATA[<p>é“¾æ¥ï¼š<a href="https://freebutuselesssoul.github.io/occnerf/">OCC-NeRF: Occlusion-Free Scene Recovery via Neural Radiance Fields</a></p>
<h2 id="æ–‡ä»¶å¤¹ç›®å½•"><a href="#æ–‡ä»¶å¤¹ç›®å½•" class="headerlink" title="æ–‡ä»¶å¤¹ç›®å½•"></a>æ–‡ä»¶å¤¹ç›®å½•</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">occ-nerf/</span><br><span class="line">â”œâ”€â”€ .gitignore</span><br><span class="line">â”œâ”€â”€ LICENSE</span><br><span class="line">â”œâ”€â”€ README.md</span><br><span class="line">â”œâ”€â”€ environment.yml</span><br><span class="line">â”œâ”€â”€ local1.txt</span><br><span class="line">â”œâ”€â”€ dataloader/</span><br><span class="line">â”‚   â”œâ”€â”€ any_folder.py</span><br><span class="line">â”‚   â”œâ”€â”€ local_save.py</span><br><span class="line">â”‚   â”œâ”€â”€ with_colmap.py</span><br><span class="line">â”‚   â”œâ”€â”€ with_feature.py</span><br><span class="line">â”‚   â”œâ”€â”€ with_feature_colmap.py</span><br><span class="line">â”‚   â””â”€â”€ with_mask.py</span><br><span class="line">â”œâ”€â”€ models/</span><br><span class="line">â”‚   â”œâ”€â”€ depth_decoder.py</span><br><span class="line">â”‚   â”œâ”€â”€ intrinsics.py</span><br><span class="line">â”‚   â”œâ”€â”€ layers.py</span><br><span class="line">â”‚   â”œâ”€â”€ nerf_feature.py</span><br><span class="line">â”‚   â”œâ”€â”€ nerf_mask.py</span><br><span class="line">â”‚   â”œâ”€â”€ nerf_models.py</span><br><span class="line">â”‚   â””â”€â”€ poses.py</span><br><span class="line">â”œâ”€â”€ utils/</span><br><span class="line">â”‚   â”œâ”€â”€ align_traj.py</span><br><span class="line">â”‚   â”œâ”€â”€ comp_ate.py</span><br><span class="line">â”‚   â”œâ”€â”€ comp_ray_dir.py</span><br><span class="line">â”‚   â”œâ”€â”€ lie_group_helper.py</span><br><span class="line">â”‚   â”œâ”€â”€ pos_enc.py</span><br><span class="line">â”‚   â”œâ”€â”€ pose_utils.py</span><br><span class="line">â”‚   â”œâ”€â”€ split_dataset.py</span><br><span class="line">â”‚   â”œâ”€â”€ training_utils.py</span><br><span class="line">â”‚   â”œâ”€â”€ vgg.py</span><br><span class="line">â”‚   â”œâ”€â”€ vis_cam_traj.py</span><br><span class="line">â”‚   â””â”€â”€ volume_op.py</span><br><span class="line">â”œâ”€â”€ tasks/</span><br><span class="line">â”‚   â””â”€â”€ ...</span><br><span class="line">â””â”€â”€ third_party/</span><br><span class="line">    â”œâ”€â”€ ATE/</span><br><span class="line">    â”‚   â””â”€â”€ README.md</span><br><span class="line">    â””â”€â”€ pytorch_ssim/</span><br></pre></td></tr></table></figure>

<h2 id="DEBUG-ä»£ç "><a href="#DEBUG-ä»£ç " class="headerlink" title="DEBUG ä»£ç "></a>DEBUG ä»£ç </h2><h3 id="dataloader"><a href="#dataloader" class="headerlink" title="dataloader"></a>dataloader</h3><figure class="highlight py"><table><tr><td class="code"><pre><span class="line">â”œâ”€â”€ dataloader/</span><br><span class="line">â”‚   â”œâ”€â”€ any_folder.py</span><br><span class="line">â”‚   â”œâ”€â”€ local_save.py</span><br><span class="line">â”‚   â”œâ”€â”€ with_colmap.py</span><br><span class="line">â”‚   â”œâ”€â”€ with_feature.py</span><br><span class="line">â”‚   â”œâ”€â”€ with_feature_colmap.py</span><br><span class="line">â”‚   â””â”€â”€ with_mask.py</span><br></pre></td></tr></table></figure>

<h4 id="any-folder-py"><a href="#any-folder-py" class="headerlink" title="any_folder.py"></a>any_folder.py</h4><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os                                       <span class="comment"># æ“ä½œç³»ç»Ÿæ¥å£æ¨¡å—</span></span><br><span class="line"><span class="keyword">import</span> torch                                    <span class="comment"># PyTorch æ·±åº¦å­¦ä¹ æ¡†æ¶</span></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np                              <span class="comment"># ç§‘å­¦è®¡ç®—åº“</span></span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm                           <span class="comment"># è¿›åº¦æ¡æ˜¾ç¤ºæ¨¡å—</span></span><br><span class="line"><span class="keyword">import</span> imageio                                  <span class="comment"># å›¾åƒ IO å¤„ç†åº“</span></span><br><span class="line"><span class="keyword">from</span> dataloader.with_colmap <span class="keyword">import</span> resize_imgs  <span class="comment"># è‡ªå®šä¹‰å›¾åƒç¼©æ”¾å‡½æ•°</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_imgs</span>(<span class="params">image_dir, num_img_to_load, start, end, skip, load_sorted, load_img</span>):</span><br><span class="line">    img_names = np.array(<span class="built_in">sorted</span>(os.listdir(image_dir)))  <span class="comment"># è·å–å¹¶æ’åºç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶å</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> end == -<span class="number">1</span>:                                 <span class="comment"># ä» start å¼€å§‹æŒ‰é—´éš” skip å–å›¾</span></span><br><span class="line">        img_names = img_names[start::skip]</span><br><span class="line">    <span class="keyword">else</span>:                                         <span class="comment"># å– start åˆ° end åŒºé—´æŒ‰é—´éš” skip å–å›¾</span></span><br><span class="line">        img_names = img_names[start:end:skip]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> load_sorted:                           <span class="comment"># æ˜¯å¦æ‰“ä¹±å›¾åƒé¡ºåº</span></span><br><span class="line">        np.random.shuffle(img_names)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> num_img_to_load &gt; <span class="built_in">len</span>(img_names):          <span class="comment"># æ£€æŸ¥è¯·æ±‚æ•°é‡æ˜¯å¦è¶…å‡ºèŒƒå›´</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;å›¾åƒè¯·æ±‚æ•°<span class="subst">&#123;num_img_to_load&#125;</span>è¶…è¿‡å¯ç”¨æ•°<span class="subst">&#123;<span class="built_in">len</span>(img_names)&#125;</span>&#x27;</span>)</span><br><span class="line">        exit()</span><br><span class="line">    <span class="keyword">elif</span> num_img_to_load == -<span class="number">1</span>:                   <span class="comment"># åŠ è½½å…¨éƒ¨å¯ç”¨å›¾åƒ</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;åŠ è½½å…¨éƒ¨<span class="subst">&#123;<span class="built_in">len</span>(img_names)&#125;</span>å¼ å›¾åƒ&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:                                         <span class="comment"># æˆªå–æŒ‡å®šæ•°é‡çš„å›¾åƒ</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;ä»<span class="subst">&#123;<span class="built_in">len</span>(img_names)&#125;</span>å¼ ä¸­åŠ è½½<span class="subst">&#123;num_img_to_load&#125;</span>å¼ &#x27;</span>)</span><br><span class="line">        img_names = img_names[:num_img_to_load]</span><br><span class="line">    </span><br><span class="line">    img_paths = [os.path.join(image_dir, n) <span class="keyword">for</span> n <span class="keyword">in</span> img_names]  <span class="comment"># æ„å»ºå®Œæ•´æ–‡ä»¶è·¯å¾„</span></span><br><span class="line">    N_imgs = <span class="built_in">len</span>(img_paths)                         <span class="comment"># è®¡ç®—å®é™…åŠ è½½æ•°é‡</span></span><br><span class="line">    </span><br><span class="line">    img_list = []</span><br><span class="line">    <span class="keyword">if</span> load_img:                                     <span class="comment"># å®é™…åŠ è½½å›¾åƒæ•°æ®</span></span><br><span class="line">        <span class="keyword">for</span> p <span class="keyword">in</span> tqdm(img_paths):</span><br><span class="line">            img = imageio.imread(p)[:, :, :<span class="number">3</span>]        <span class="comment"># è¯»å– RGB ä¸‰é€šé“å›¾åƒ</span></span><br><span class="line">            img_list.append(img)</span><br><span class="line">        img_list = np.stack(img_list)                <span class="comment"># å †å ä¸º 4D æ•°ç»„</span></span><br><span class="line">        img_list = torch.from_numpy(img_list).<span class="built_in">float</span>() / <span class="number">255</span>  <span class="comment"># è½¬æ¢ä¸ºæµ®ç‚¹å¼ é‡å¹¶å½’ä¸€åŒ–</span></span><br><span class="line">        H, W = img_list.shape[<span class="number">1</span>], img_list.shape[<span class="number">2</span>]  <span class="comment"># è·å–å›¾åƒå°ºå¯¸</span></span><br><span class="line">    <span class="keyword">else</span>:                                            <span class="comment"># ä»…è·å–å›¾åƒå°ºå¯¸</span></span><br><span class="line">        tmp_img = imageio.imread(img_paths[<span class="number">0</span>])</span><br><span class="line">        H, W = tmp_img.shape[<span class="number">0</span>], tmp_img.shape[<span class="number">1</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &#123;                                         <span class="comment"># è¿”å›ç»“æ„åŒ–æ•°æ®</span></span><br><span class="line">        <span class="string">&#x27;imgs&#x27;</span>: img_list,        <span class="comment"># å›¾åƒå¼ é‡ (N, H, W, 3)</span></span><br><span class="line">        <span class="string">&#x27;img_names&#x27;</span>: img_names,  <span class="comment"># å›¾åƒæ–‡ä»¶åæ•°ç»„</span></span><br><span class="line">        <span class="string">&#x27;N_imgs&#x27;</span>: N_imgs,        <span class="comment"># æ€»å›¾åƒæ•°</span></span><br><span class="line">        <span class="string">&#x27;H&#x27;</span>: H,                  <span class="comment"># å›¾åƒé«˜åº¦</span></span><br><span class="line">        <span class="string">&#x27;W&#x27;</span>: W,                  <span class="comment"># å›¾åƒå®½åº¦</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DataLoaderAnyFolder</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, base_dir, scene_name, res_ratio, num_img_to_load, </span></span><br><span class="line"><span class="params">                 start, end, skip, load_sorted, load_img=<span class="literal">True</span></span>):  <span class="comment"># åˆå§‹åŒ–å‚æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.base_dir = base_dir                  <span class="comment"># æ•°æ®æ ¹ç›®å½•</span></span><br><span class="line">        <span class="variable language_">self</span>.scene_name = scene_name              <span class="comment"># åœºæ™¯åç§°</span></span><br><span class="line">        <span class="variable language_">self</span>.res_ratio = res_ratio                <span class="comment"># åˆ†è¾¨ç‡ç¼©æ”¾æ¯”ä¾‹</span></span><br><span class="line">        <span class="variable language_">self</span>.num_img_to_load = num_img_to_load    <span class="comment"># æœ€å¤§åŠ è½½æ•°é‡</span></span><br><span class="line">        <span class="variable language_">self</span>.start = start                        <span class="comment"># èµ·å§‹ç´¢å¼•</span></span><br><span class="line">        <span class="variable language_">self</span>.end = end                            <span class="comment"># ç»“æŸç´¢å¼•</span></span><br><span class="line">        <span class="variable language_">self</span>.skip = skip                          <span class="comment"># é‡‡æ ·é—´éš”</span></span><br><span class="line">        <span class="variable language_">self</span>.load_sorted = load_sorted            <span class="comment"># æ˜¯å¦ä¿æŒé¡ºåº</span></span><br><span class="line">        <span class="variable language_">self</span>.load_img = load_img                  <span class="comment"># æ˜¯å¦å®é™…åŠ è½½å›¾åƒ</span></span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.imgs_dir = os.path.join(<span class="variable language_">self</span>.base_dir, <span class="variable language_">self</span>.scene_name)  <span class="comment"># æ„å»ºå›¾åƒç›®å½•è·¯å¾„</span></span><br><span class="line">        </span><br><span class="line">        image_data = load_imgs(<span class="variable language_">self</span>.imgs_dir, <span class="variable language_">self</span>.num_img_to_load,  <span class="comment"># åŠ è½½å›¾åƒæ•°æ®</span></span><br><span class="line">                              <span class="variable language_">self</span>.start, <span class="variable language_">self</span>.end, <span class="variable language_">self</span>.skip,</span><br><span class="line">                              <span class="variable language_">self</span>.load_sorted, <span class="variable language_">self</span>.load_img)</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.imgs = image_data[<span class="string">&#x27;imgs&#x27;</span>]             <span class="comment"># å›¾åƒå¼ é‡</span></span><br><span class="line">        <span class="variable language_">self</span>.img_names = image_data[<span class="string">&#x27;img_names&#x27;</span>]   <span class="comment"># æ–‡ä»¶ååˆ—è¡¨</span></span><br><span class="line">        <span class="variable language_">self</span>.N_imgs = image_data[<span class="string">&#x27;N_imgs&#x27;</span>]         <span class="comment"># å›¾åƒæ€»æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.ori_H = image_data[<span class="string">&#x27;H&#x27;</span>]               <span class="comment"># åŸå§‹é«˜åº¦</span></span><br><span class="line">        <span class="variable language_">self</span>.ori_W = image_data[<span class="string">&#x27;W&#x27;</span>]               <span class="comment"># åŸå§‹å®½åº¦</span></span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.near = <span class="number">0.0</span>                            <span class="comment"># è¿‘è£å‰ªé¢(NDC åæ ‡ç³»)</span></span><br><span class="line">        <span class="variable language_">self</span>.far = <span class="number">1.0</span>                             <span class="comment"># è¿œè£å‰ªé¢(NDC åæ ‡ç³»)</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.res_ratio &gt; <span class="number">1</span>:                     <span class="comment"># è®¡ç®—å®é™…ä½¿ç”¨åˆ†è¾¨ç‡</span></span><br><span class="line">            <span class="variable language_">self</span>.H = <span class="variable language_">self</span>.ori_H // <span class="variable language_">self</span>.res_ratio</span><br><span class="line">            <span class="variable language_">self</span>.W = <span class="variable language_">self</span>.ori_W // <span class="variable language_">self</span>.res_ratio</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="variable language_">self</span>.H = <span class="variable language_">self</span>.ori_H</span><br><span class="line">            <span class="variable language_">self</span>.W = <span class="variable language_">self</span>.ori_W</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.load_img:                          <span class="comment"># æ‰§è¡Œå›¾åƒç¼©æ”¾</span></span><br><span class="line">            <span class="variable language_">self</span>.imgs = resize_imgs(<span class="variable language_">self</span>.imgs, <span class="variable language_">self</span>.H, <span class="variable language_">self</span>.W)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    base_dir = <span class="string">&#x27;/your/data/path&#x27;</span>                   <span class="comment"># æ•°æ®æ ¹ç›®å½•é…ç½®ç¤ºä¾‹</span></span><br><span class="line">    scene_name = <span class="string">&#x27;LLFF/fern/images&#x27;</span>                <span class="comment"># åœºæ™¯è·¯å¾„é…ç½®ç¤ºä¾‹</span></span><br><span class="line">    resize_ratio = <span class="number">8</span>                               <span class="comment"># ç¼©æ”¾æ¯”ä¾‹é…ç½®</span></span><br><span class="line">    num_img_to_load = -<span class="number">1</span>                           <span class="comment"># åŠ è½½å…¨éƒ¨å›¾åƒ</span></span><br><span class="line">    start, end, skip = <span class="number">0</span>, -<span class="number">1</span>, <span class="number">1</span>                    <span class="comment"># é‡‡æ ·å‚æ•°åˆå§‹åŒ–</span></span><br><span class="line">    load_sorted, load_img = <span class="literal">True</span>, <span class="literal">True</span>             <span class="comment"># åŠ è½½é…ç½®å‚æ•°</span></span><br><span class="line">    </span><br><span class="line">    scene = DataLoaderAnyFolder(                   <span class="comment"># åˆ›å»ºæ•°æ®åŠ è½½å®ä¾‹</span></span><br><span class="line">        base_dir=base_dir,</span><br><span class="line">        scene_name=scene_name,</span><br><span class="line">        res_ratio=resize_ratio,</span><br><span class="line">        num_img_to_load=num_img_to_load,</span><br><span class="line">        start=start,</span><br><span class="line">        end=end,</span><br><span class="line">        skip=skip,</span><br><span class="line">        load_sorted=load_sorted,</span><br><span class="line">        load_img=load_img)</span><br></pre></td></tr></table></figure>

<h4 id="local-save-py"><a href="#local-save-py" class="headerlink" title="local_save.py"></a>local_save.py</h4><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="keyword">import</span> imageio</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> dataloader.with_colmap <span class="keyword">import</span> resize_imgs</span><br><span class="line"><span class="keyword">from</span> torchvision <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> torch.nn <span class="keyword">import</span> functional <span class="keyword">as</span> F</span><br><span class="line"></span><br><span class="line"><span class="meta">@torch.no_grad()</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Vgg19</span>(torch.nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, requires_grad=<span class="literal">False</span></span>):</span><br><span class="line">        <span class="comment"># è°ƒç”¨çˆ¶ç±»çš„æ„é€ å‡½æ•°</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        <span class="comment"># åŠ è½½é¢„è®­ç»ƒçš„ VGG19 æ¨¡å‹çš„ç‰¹å¾æå–éƒ¨åˆ†</span></span><br><span class="line">        <span class="variable language_">self</span>.vgg_pretrained_features = models.vgg19(pretrained=<span class="literal">True</span>).features</span><br><span class="line">        <span class="comment"># å¦‚æœä¸éœ€è¦è®¡ç®—æ¢¯åº¦ï¼Œåˆ™å°†æ¨¡å‹å‚æ•°çš„ requires_grad å±æ€§è®¾ç½®ä¸º False</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> requires_grad:</span><br><span class="line">            <span class="keyword">for</span> param <span class="keyword">in</span> <span class="variable language_">self</span>.parameters():</span><br><span class="line">                param.requires_grad = <span class="literal">False</span></span><br><span class="line">        <span class="comment"># åˆå§‹åŒ–ç‰¹å¾å›¾çš„å½¢çŠ¶ä¸º None</span></span><br><span class="line">        <span class="variable language_">self</span>.feature_shape = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, X, indices=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="comment"># è®°å½•è¾“å…¥ç‰¹å¾å›¾çš„å½¢çŠ¶</span></span><br><span class="line">        <span class="variable language_">self</span>.feature_shape = X.shape</span><br><span class="line">        <span class="comment"># å¦‚æœæ²¡æœ‰æŒ‡å®šç´¢å¼•ï¼Œåˆ™é»˜è®¤ä½¿ç”¨ [7, 25]</span></span><br><span class="line">        <span class="keyword">if</span> indices <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            indices = [<span class="number">7</span>,<span class="number">25</span>]</span><br><span class="line">        <span class="comment"># å­˜å‚¨æå–çš„ç‰¹å¾å›¾</span></span><br><span class="line">        out = []</span><br><span class="line">        <span class="comment"># éå†åˆ°æœ€åä¸€ä¸ªç´¢å¼•ä½ç½®</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(indices[-<span class="number">1</span>]):</span><br><span class="line">            <span class="comment"># é€šè¿‡ VGG19 çš„ç¬¬ i å±‚è¿›è¡Œç‰¹å¾æå–</span></span><br><span class="line">            X = <span class="variable language_">self</span>.vgg_pretrained_features[i](X)</span><br><span class="line">            <span class="comment"># å¦‚æœå½“å‰å±‚çš„ç´¢å¼•åŠ  1 åœ¨æŒ‡å®šçš„ç´¢å¼•åˆ—è¡¨ä¸­</span></span><br><span class="line">            <span class="keyword">if</span> (i+<span class="number">1</span>) <span class="keyword">in</span> indices:</span><br><span class="line">                <span class="keyword">if</span> <span class="variable language_">self</span>.feature_shape <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                    <span class="comment"># å¦‚æœç‰¹å¾å›¾å½¢çŠ¶ä¸º Noneï¼Œåˆ™è®°å½•å½“å‰ç‰¹å¾å›¾çš„å½¢çŠ¶</span></span><br><span class="line">                    <span class="variable language_">self</span>.feature_shape = X.shape</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="comment"># å¯¹ç‰¹å¾å›¾è¿›è¡ŒåŒçº¿æ€§æ’å€¼ï¼Œä½¿å…¶å°ºå¯¸ä¸è¾“å…¥ç‰¹å¾å›¾çš„å°ºå¯¸ä¸€è‡´</span></span><br><span class="line">                    X = F.interpolate(X,<span class="variable language_">self</span>.feature_shape[-<span class="number">2</span>:],mode=<span class="string">&#x27;bilinear&#x27;</span>,align_corners=<span class="literal">True</span>)</span><br><span class="line">                <span class="comment"># å°†å¤„ç†åçš„ç‰¹å¾å›¾æ·»åŠ åˆ°è¾“å‡ºåˆ—è¡¨ä¸­</span></span><br><span class="line">                out.append(X)</span><br><span class="line">        <span class="comment"># å°†æ‰€æœ‰æå–çš„ç‰¹å¾å›¾åœ¨é€šé“ç»´åº¦ä¸Šæ‹¼æ¥èµ·æ¥</span></span><br><span class="line">        <span class="keyword">return</span> torch.cat(out,<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_imgs</span>(<span class="params">image_dir, num_img_to_load, start, end, skip, load_sorted, load_img</span>):</span><br><span class="line">    <span class="comment"># è·å–å›¾åƒç›®å½•ä¸‹æ‰€æœ‰å›¾åƒçš„æ–‡ä»¶åï¼Œå¹¶æŒ‰å­—æ¯é¡ºåºæ’åº</span></span><br><span class="line">    img_names = np.array(<span class="built_in">sorted</span>(os.listdir(image_dir))) <span class="comment"># all image names</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ—¶é—´åŸŸä¸‹é‡‡æ ·ï¼šæ ¹æ® startã€end å’Œ skip å‚æ•°é€‰æ‹©å›¾åƒ</span></span><br><span class="line">    <span class="keyword">if</span> end == -<span class="number">1</span>:</span><br><span class="line">        img_names = img_names[start::skip]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        img_names = img_names[start:end:skip]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¦‚æœä¸æŒ‰é¡ºåºåŠ è½½å›¾åƒï¼Œåˆ™å¯¹å›¾åƒæ–‡ä»¶åè¿›è¡Œéšæœºæ‰“ä¹±</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> load_sorted:</span><br><span class="line">        np.random.shuffle(img_names)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ£€æŸ¥è¦åŠ è½½çš„å›¾åƒæ•°é‡æ˜¯å¦è¶…è¿‡å¯ç”¨å›¾åƒæ•°é‡</span></span><br><span class="line">    <span class="keyword">if</span> num_img_to_load &gt; <span class="built_in">len</span>(img_names):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Asked for &#123;0:6d&#125; images but only &#123;1:6d&#125; available. Exit.&#x27;</span>.<span class="built_in">format</span>(num_img_to_load, <span class="built_in">len</span>(img_names)))</span><br><span class="line">        exit()</span><br><span class="line">    <span class="keyword">elif</span> num_img_to_load == -<span class="number">1</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Loading all available &#123;0:6d&#125; images&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">len</span>(img_names)))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Loading &#123;0:6d&#125; images out of &#123;1:6d&#125; images.&#x27;</span>.<span class="built_in">format</span>(num_img_to_load, <span class="built_in">len</span>(img_names)))</span><br><span class="line">        <span class="comment"># æˆªå–å‰ num_img_to_load ä¸ªå›¾åƒæ–‡ä»¶å</span></span><br><span class="line">        img_names = img_names[:num_img_to_load]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ„å»ºå›¾åƒæ–‡ä»¶çš„å®Œæ•´è·¯å¾„</span></span><br><span class="line">    img_paths = [os.path.join(image_dir, n) <span class="keyword">for</span> n <span class="keyword">in</span> img_names]</span><br><span class="line">    <span class="comment"># å›¾åƒçš„æ•°é‡</span></span><br><span class="line">    N_imgs = <span class="built_in">len</span>(img_paths)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å­˜å‚¨åŠ è½½çš„å›¾åƒ</span></span><br><span class="line">    img_list = []</span><br><span class="line">    <span class="keyword">if</span> load_img:</span><br><span class="line">        <span class="comment"># ä½¿ç”¨ tqdm æ˜¾ç¤ºåŠ è½½è¿›åº¦</span></span><br><span class="line">        <span class="keyword">for</span> p <span class="keyword">in</span> tqdm(img_paths):</span><br><span class="line">            <span class="comment"># è¯»å–å›¾åƒå¹¶æˆªå–å‰ä¸‰ä¸ªé€šé“ï¼ˆRGBï¼‰</span></span><br><span class="line">            img = imageio.imread(p)[:, :, :<span class="number">3</span>] <span class="comment"># (H, W, 3) np.uint8</span></span><br><span class="line">            <span class="comment"># å°†å›¾åƒæ·»åŠ åˆ°åˆ—è¡¨ä¸­</span></span><br><span class="line">            img_list.append(img)</span><br><span class="line">        <span class="comment"># å°†å›¾åƒåˆ—è¡¨è½¬æ¢ä¸º numpy æ•°ç»„</span></span><br><span class="line">        img_list = np.stack(img_list) <span class="comment"># (N, H, W, 3)</span></span><br><span class="line">        <span class="comment"># å°† numpy æ•°ç»„è½¬æ¢ä¸º PyTorch å¼ é‡ï¼Œå¹¶å°†åƒç´ å€¼å½’ä¸€åŒ–åˆ° [0, 1] èŒƒå›´</span></span><br><span class="line">        img_list = torch.from_numpy(img_list).<span class="built_in">float</span>() / <span class="number">255</span> <span class="comment"># (N, H, W, 3) torch.float32</span></span><br><span class="line">        <span class="comment"># è·å–å›¾åƒçš„é«˜åº¦å’Œå®½åº¦</span></span><br><span class="line">        H, W = img_list.shape[<span class="number">1</span>], img_list.shape[<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># å¦‚æœä¸åŠ è½½å›¾åƒï¼Œåˆ™è¯»å–ç¬¬ä¸€å¼ å›¾åƒä»¥è·å–å›¾åƒçš„é«˜åº¦å’Œå®½åº¦</span></span><br><span class="line">        tmp_img = imageio.imread(img_paths[<span class="number">0</span>]) <span class="comment"># load one image to get H, W</span></span><br><span class="line">        H, W = tmp_img.shape[<span class="number">0</span>], tmp_img.shape[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å­˜å‚¨åŠ è½½å›¾åƒçš„ç›¸å…³ä¿¡æ¯</span></span><br><span class="line">    results = &#123;</span><br><span class="line">        <span class="string">&#x27;imgs&#x27;</span>: img_list, <span class="comment"># (N, H, W, 3) torch.float32</span></span><br><span class="line">        <span class="string">&#x27;img_names&#x27;</span>: img_names, <span class="comment"># (N, )</span></span><br><span class="line">        <span class="string">&#x27;N_imgs&#x27;</span>: N_imgs,</span><br><span class="line">        <span class="string">&#x27;H&#x27;</span>: H,</span><br><span class="line">        <span class="string">&#x27;W&#x27;</span>: W,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DataLoaderAnyFolder</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Most useful fields:</span></span><br><span class="line"><span class="string">    self.c2ws: (N_imgs, 4, 4) torch.float32</span></span><br><span class="line"><span class="string">    self.imgs (N_imgs, H, W, 4) torch.float32</span></span><br><span class="line"><span class="string">    self.ray_dir_cam (H, W, 3) torch.float32</span></span><br><span class="line"><span class="string">    self.H scalar</span></span><br><span class="line"><span class="string">    self.W scalar</span></span><br><span class="line"><span class="string">    self.N_imgs scalar</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, base_dir, scene_name, res_ratio, num_img_to_load, start, end, skip, load_sorted, load_img=<span class="literal">True</span>, device=<span class="string">&#x27;cpu&#x27;</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        :param base_dir: æ•°æ®çš„åŸºç¡€ç›®å½•</span></span><br><span class="line"><span class="string">        :param scene_name: åœºæ™¯çš„åç§°</span></span><br><span class="line"><span class="string">        :param res_ratio: æ•´æ•°ï¼Œå¦‚ [1, 2, 4] ç­‰ï¼Œç”¨äºå°†å›¾åƒè°ƒæ•´ä¸ºè¾ƒä½çš„åˆ†è¾¨ç‡ã€‚</span></span><br><span class="line"><span class="string">        :param start/end/skip: ç”¨äºåœ¨æ—¶é—´åŸŸä¸Šæ§åˆ¶å¸§çš„åŠ è½½ã€‚</span></span><br><span class="line"><span class="string">        :param load_sorted: å¸ƒå°”å€¼ï¼Œæ˜¯å¦æŒ‰é¡ºåºåŠ è½½å›¾åƒã€‚</span></span><br><span class="line"><span class="string">        :param load_img: å¸ƒå°”å€¼ã€‚å¦‚æœè®¾ç½®ä¸º Falseï¼šä»…ç»Ÿè®¡å›¾åƒæ•°é‡ã€è·å–å›¾åƒçš„é«˜åº¦å’Œå®½åº¦ï¼Œ</span></span><br><span class="line"><span class="string">                         ä½†ä¸åŠ è½½å›¾åƒã€‚åœ¨å¯è§†åŒ–ä½å§¿æˆ–è°ƒè¯•ç­‰æƒ…å†µä¸‹å¾ˆæœ‰ç”¨ã€‚</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.base_dir = base_dir</span><br><span class="line">        <span class="variable language_">self</span>.scene_name = scene_name</span><br><span class="line">        <span class="variable language_">self</span>.res_ratio = res_ratio</span><br><span class="line">        <span class="variable language_">self</span>.num_img_to_load = num_img_to_load</span><br><span class="line">        <span class="variable language_">self</span>.start = start</span><br><span class="line">        <span class="variable language_">self</span>.end = end</span><br><span class="line">        <span class="variable language_">self</span>.skip = skip</span><br><span class="line">        <span class="variable language_">self</span>.load_sorted = load_sorted</span><br><span class="line">        <span class="variable language_">self</span>.load_img = load_img</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ„å»ºå›¾åƒç›®å½•çš„å®Œæ•´è·¯å¾„</span></span><br><span class="line">        <span class="variable language_">self</span>.imgs_dir = os.path.join(<span class="variable language_">self</span>.base_dir, <span class="variable language_">self</span>.scene_name)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è°ƒç”¨ load_imgs å‡½æ•°åŠ è½½å›¾åƒ</span></span><br><span class="line">        image_data = load_imgs(<span class="variable language_">self</span>.imgs_dir, <span class="variable language_">self</span>.num_img_to_load, <span class="variable language_">self</span>.start, <span class="variable language_">self</span>.end, <span class="variable language_">self</span>.skip,</span><br><span class="line">                               <span class="variable language_">self</span>.load_sorted, <span class="variable language_">self</span>.load_img)</span><br><span class="line">        <span class="comment"># åŠ è½½çš„å›¾åƒå¼ é‡</span></span><br><span class="line">        <span class="variable language_">self</span>.imgs = image_data[<span class="string">&#x27;imgs&#x27;</span>] <span class="comment"># (N, H, W, 3) torch.float32</span></span><br><span class="line">        <span class="comment"># å›¾åƒçš„æ–‡ä»¶å</span></span><br><span class="line">        <span class="variable language_">self</span>.img_names = image_data[<span class="string">&#x27;img_names&#x27;</span>] <span class="comment"># (N, )</span></span><br><span class="line">        <span class="comment"># å›¾åƒçš„æ•°é‡</span></span><br><span class="line">        <span class="variable language_">self</span>.N_imgs = image_data[<span class="string">&#x27;N_imgs&#x27;</span>]</span><br><span class="line">        <span class="comment"># åŸå§‹å›¾åƒçš„é«˜åº¦</span></span><br><span class="line">        <span class="variable language_">self</span>.ori_H = image_data[<span class="string">&#x27;H&#x27;</span>]</span><br><span class="line">        <span class="comment"># åŸå§‹å›¾åƒçš„å®½åº¦</span></span><br><span class="line">        <span class="variable language_">self</span>.ori_W = image_data[<span class="string">&#x27;W&#x27;</span>]</span><br><span class="line">        <span class="comment"># åˆå§‹åŒ– VGG19 ç¼–ç å™¨</span></span><br><span class="line">        <span class="variable language_">self</span>.encoder = Vgg19()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è¿‘è£å‰ªå¹³é¢è·ç¦»</span></span><br><span class="line">        <span class="variable language_">self</span>.near = <span class="number">0.0</span></span><br><span class="line">        <span class="comment"># è¿œè£å‰ªå¹³é¢è·ç¦»</span></span><br><span class="line">        <span class="variable language_">self</span>.far = <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># å¦‚æœéœ€è¦è°ƒæ•´å›¾åƒåˆ†è¾¨ç‡</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.res_ratio &gt; <span class="number">1</span>:</span><br><span class="line">            <span class="variable language_">self</span>.H = <span class="variable language_">self</span>.ori_H // <span class="variable language_">self</span>.res_ratio</span><br><span class="line">            <span class="variable language_">self</span>.W = <span class="variable language_">self</span>.ori_W // <span class="variable language_">self</span>.res_ratio</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="variable language_">self</span>.H = <span class="variable language_">self</span>.ori_H</span><br><span class="line">            <span class="variable language_">self</span>.W = <span class="variable language_">self</span>.ori_W</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.load_img:</span><br><span class="line">            <span class="comment"># è°ƒæ•´å›¾åƒçš„åˆ†è¾¨ç‡</span></span><br><span class="line">            <span class="variable language_">self</span>.imgs = resize_imgs(<span class="variable language_">self</span>.imgs, <span class="variable language_">self</span>.H, <span class="variable language_">self</span>.W) <span class="comment"># (N, H, W, 3) torch.float32</span></span><br><span class="line">            <span class="comment"># å­˜å‚¨å›¾åƒçš„ç‰¹å¾</span></span><br><span class="line">            <span class="variable language_">self</span>.features = []</span><br><span class="line">            <span class="comment"># ä½¿ç”¨ tqdm æ˜¾ç¤ºå¤„ç†è¿›åº¦</span></span><br><span class="line">            <span class="keyword">for</span> img <span class="keyword">in</span> tqdm(<span class="variable language_">self</span>.imgs):</span><br><span class="line">                <span class="comment"># å¯¹å›¾åƒè¿›è¡Œé€šé“ç»´åº¦çš„è°ƒæ•´ï¼Œå¹¶é€šè¿‡ç¼–ç å™¨æå–ç‰¹å¾</span></span><br><span class="line">                <span class="variable language_">self</span>.features.append(<span class="variable language_">self</span>.encoder(img.permute(<span class="number">2</span>,<span class="number">0</span>,<span class="number">1</span>)[<span class="literal">None</span>,...]))</span><br><span class="line">            <span class="comment"># å°†æ‰€æœ‰å›¾åƒçš„ç‰¹å¾åœ¨æ‰¹æ¬¡ç»´åº¦ä¸Šæ‹¼æ¥èµ·æ¥</span></span><br><span class="line">            <span class="variable language_">self</span>.features = torch.cat(<span class="variable language_">self</span>.features,<span class="number">0</span>)</span><br><span class="line">            <span class="comment"># ç‰¹å¾å›¾çš„å°ºå¯¸</span></span><br><span class="line">            <span class="variable language_">self</span>.feature_size = (<span class="variable language_">self</span>.features.shape[-<span class="number">2</span>],<span class="variable language_">self</span>.features.shape[-<span class="number">1</span>]) <span class="comment"># (H,W)</span></span><br><span class="line">            <span class="comment"># æ‰“å°ç‰¹å¾å›¾çš„å½¢çŠ¶</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="variable language_">self</span>.features.shape)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># æ•°æ®çš„åŸºç¡€ç›®å½•ï¼Œéœ€è¦æ›¿æ¢ä¸ºå®é™…çš„è·¯å¾„</span></span><br><span class="line">    base_dir = <span class="string">&#x27;/your/data/path&#x27;</span></span><br><span class="line">    <span class="comment"># åœºæ™¯çš„åç§°</span></span><br><span class="line">    scene_name = <span class="string">&#x27;LLFF/fern/images&#x27;</span></span><br><span class="line">    <span class="comment"># å›¾åƒçš„ç¼©æ”¾æ¯”ä¾‹</span></span><br><span class="line">    resize_ratio = <span class="number">8</span></span><br><span class="line">    <span class="comment"># è¦åŠ è½½çš„å›¾åƒæ•°é‡ï¼Œ-1 è¡¨ç¤ºåŠ è½½æ‰€æœ‰å›¾åƒ</span></span><br><span class="line">    num_img_to_load = -<span class="number">1</span></span><br><span class="line">    <span class="comment"># å¼€å§‹åŠ è½½å›¾åƒçš„ç´¢å¼•</span></span><br><span class="line">    start = <span class="number">0</span></span><br><span class="line">    <span class="comment"># ç»“æŸåŠ è½½å›¾åƒçš„ç´¢å¼•ï¼Œ-1 è¡¨ç¤ºåŠ è½½åˆ°æœ€å</span></span><br><span class="line">    end = -<span class="number">1</span></span><br><span class="line">    <span class="comment"># åŠ è½½å›¾åƒçš„é—´éš”</span></span><br><span class="line">    skip = <span class="number">1</span></span><br><span class="line">    <span class="comment"># æ˜¯å¦æŒ‰é¡ºåºåŠ è½½å›¾åƒ</span></span><br><span class="line">    load_sorted = <span class="literal">True</span></span><br><span class="line">    <span class="comment"># æ˜¯å¦åŠ è½½å›¾åƒ</span></span><br><span class="line">    load_img = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># åˆå§‹åŒ– DataLoaderAnyFolder ç±»</span></span><br><span class="line">    scene = DataLoaderAnyFolder(base_dir=base_dir,</span><br><span class="line">                                scene_name=scene_name,</span><br><span class="line">                                res_ratio=resize_ratio,</span><br><span class="line">                                num_img_to_load=num_img_to_load,</span><br><span class="line">                                start=start,</span><br><span class="line">                                end=end,</span><br><span class="line">                                skip=skip,</span><br><span class="line">                                load_sorted=load_sorted,</span><br><span class="line">                                load_img=load_img)</span><br></pre></td></tr></table></figure>



<h4 id="with-colmap-py"><a href="#with-colmap-py" class="headerlink" title="with_colmap.py"></a>with_colmap.py</h4><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="comment"># os æ¨¡å—æä¾›äº†ä¸æ“ä½œç³»ç»Ÿè¿›è¡Œäº¤äº’çš„åŠŸèƒ½ï¼Œ</span></span><br><span class="line"><span class="comment"># å¯ä»¥ç”¨æ¥å¤„ç†æ–‡ä»¶å’Œç›®å½•è·¯å¾„ã€åˆ›å»º/åˆ é™¤ç›®å½•ã€è·å–ç¯å¢ƒå˜é‡ç­‰ï¼Œ</span></span><br><span class="line"><span class="comment"># åœ¨ä»£ç ä¸­ä¸»è¦ç”¨äºæ„å»ºæ–‡ä»¶å’Œç›®å½•çš„è·¯å¾„ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="comment"># torch æ˜¯ PyTorch çš„æ ¸å¿ƒåº“ï¼Œæä¾›äº†å¼ é‡ï¼ˆTensorï¼‰æ•°æ®ç»“æ„ï¼Œ</span></span><br><span class="line"><span class="comment"># æ”¯æŒè‡ªåŠ¨æ±‚å¯¼æœºåˆ¶ï¼Œç”¨äºæ„å»ºå’Œè®­ç»ƒæ·±åº¦å­¦ä¹ æ¨¡å‹ï¼Œ</span></span><br><span class="line"><span class="comment"># å¯ä»¥åœ¨ CPU æˆ– GPU ä¸Šè¿›è¡Œé«˜æ•ˆçš„æ•°å€¼è®¡ç®—ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"><span class="comment"># torch.nn.functional æä¾›äº†è®¸å¤šç¥ç»ç½‘ç»œä¸­å¸¸ç”¨çš„å‡½æ•°ï¼Œ</span></span><br><span class="line"><span class="comment"># å¦‚æ¿€æ´»å‡½æ•°ã€æŸå¤±å‡½æ•°ã€å·ç§¯ã€æ± åŒ–ç­‰æ“ä½œï¼Œ</span></span><br><span class="line"><span class="comment"># è¿™äº›å‡½æ•°æ˜¯æ— çŠ¶æ€çš„ï¼Œé€šå¸¸ç”¨äºè‡ªå®šä¹‰ç¥ç»ç½‘ç»œå±‚ä¸­çš„å…·ä½“è¿ç®—ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="comment"># numpy æ˜¯ Python ä¸­ç”¨äºç§‘å­¦è®¡ç®—çš„åŸºç¡€åº“ï¼Œ</span></span><br><span class="line"><span class="comment"># æä¾›äº†é«˜æ•ˆçš„å¤šç»´æ•°ç»„å¯¹è±¡å’Œå„ç§æ•°å­¦å‡½æ•°ï¼Œ</span></span><br><span class="line"><span class="comment"># å¯ä»¥è¿›è¡Œæ•°ç»„æ“ä½œã€çº¿æ€§ä»£æ•°è¿ç®—ã€éšæœºæ•°ç”Ÿæˆç­‰ï¼Œ</span></span><br><span class="line"><span class="comment"># åœ¨ä»£ç ä¸­ä¸»è¦ç”¨äºå¤„ç†å›¾åƒæ•°æ®å’Œæ•°ç»„æ“ä½œã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="comment"># tqdm æ˜¯ä¸€ä¸ªå¿«é€Ÿã€å¯æ‰©å±•çš„è¿›åº¦æ¡å·¥å…·ï¼Œ</span></span><br><span class="line"><span class="comment"># å¯ä»¥åœ¨å¾ªç¯ä¸­æ˜¾ç¤ºè¿›åº¦æ¡ï¼Œæ–¹ä¾¿ç”¨æˆ·äº†è§£ä»£ç æ‰§è¡Œçš„è¿›åº¦ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> imageio</span><br><span class="line"><span class="comment"># imageio æ˜¯ä¸€ä¸ªç”¨äºè¯»å–å’Œå†™å…¥å¤šç§å›¾åƒæ–‡ä»¶æ ¼å¼çš„åº“ï¼Œ</span></span><br><span class="line"><span class="comment"># åœ¨ä»£ç ä¸­ä¸»è¦ç”¨äºè¯»å–å›¾åƒæ–‡ä»¶ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> utils.comp_ray_dir <span class="keyword">import</span> comp_ray_dir_cam</span><br><span class="line"><span class="comment"># ä» utils åŒ…ä¸­çš„ comp_ray_dir æ¨¡å—å¯¼å…¥ comp_ray_dir_cam å‡½æ•°ï¼Œ</span></span><br><span class="line"><span class="comment"># æ¨æµ‹è¯¥å‡½æ•°ç”¨äºè®¡ç®—ç›¸æœºåæ ‡ç³»ä¸‹çš„å…‰çº¿æ–¹å‘ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> utils.pose_utils <span class="keyword">import</span> center_poses</span><br><span class="line"><span class="comment"># ä» utils åŒ…ä¸­çš„ pose_utils æ¨¡å—å¯¼å…¥ center_poses å‡½æ•°ï¼Œ</span></span><br><span class="line"><span class="comment"># æ¨æµ‹è¯¥å‡½æ•°ç”¨äºå¯¹ç›¸æœºä½å§¿è¿›è¡Œä¸­å¿ƒåŒ–å¤„ç†ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> utils.lie_group_helper <span class="keyword">import</span> convert3x4_4x4</span><br><span class="line"><span class="comment"># ä» utils åŒ…ä¸­çš„ lie_group_helper æ¨¡å—å¯¼å…¥ convert3x4_4x4 å‡½æ•°ï¼Œ</span></span><br><span class="line"><span class="comment"># æ¨æµ‹è¯¥å‡½æ•°ç”¨äºå°† 3x4 çš„ç›¸æœºä½å§¿çŸ©é˜µè½¬æ¢ä¸º 4x4 çš„é½æ¬¡çŸ©é˜µã€‚</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">resize_imgs</span>(<span class="params">imgs, new_h, new_w</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    :param imgs:    (N, H, W, 3)            torch.float32 RGB</span></span><br><span class="line"><span class="string">    :param new_h:   int/torch int</span></span><br><span class="line"><span class="string">    :param new_w:   int/torch int</span></span><br><span class="line"><span class="string">    :return:        (N, new_H, new_W, 3)    torch.float32 RGB</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># å°†å›¾åƒå¼ é‡ä» (N, H, W, 3) è½¬æ¢ä¸º (N, 3, H, W) ä»¥é€‚åº” F.interpolate å‡½æ•°çš„è¾“å…¥è¦æ±‚</span></span><br><span class="line">    imgs = imgs.permute(<span class="number">0</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">2</span>)  <span class="comment"># (N, 3, H, W)</span></span><br><span class="line">    <span class="comment"># ä½¿ç”¨åŒçº¿æ€§æ’å€¼æ–¹æ³•å°†å›¾åƒè°ƒæ•´åˆ°æŒ‡å®šçš„æ–°é«˜åº¦å’Œæ–°å®½åº¦</span></span><br><span class="line">    imgs = F.interpolate(imgs, size=(new_h, new_w), mode=<span class="string">&#x27;bilinear&#x27;</span>)  <span class="comment"># (N, 3, new_H, new_W)</span></span><br><span class="line">    <span class="comment"># å°†å›¾åƒå¼ é‡ä» (N, 3, new_H, new_W) è½¬æ¢å› (N, new_H, new_W, 3)</span></span><br><span class="line">    imgs = imgs.permute(<span class="number">0</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>)  <span class="comment"># (N, new_H, new_W, 3)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> imgs  <span class="comment"># (N, new_H, new_W, 3) torch.float32 RGB</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_imgs</span>(<span class="params">image_dir, img_ids, new_h, new_w</span>):</span><br><span class="line">    <span class="comment"># è·å–å›¾åƒç›®å½•ä¸‹æ‰€æœ‰å›¾åƒæ–‡ä»¶åï¼Œå¹¶æŒ‰å­—æ¯é¡ºåºæ’åº</span></span><br><span class="line">    img_names = np.array(<span class="built_in">sorted</span>(os.listdir(image_dir)))  <span class="comment"># all image names</span></span><br><span class="line">    <span class="comment"># æ ¹æ®ç»™å®šçš„å›¾åƒç´¢å¼•ç­›é€‰å‡ºéœ€è¦çš„å›¾åƒæ–‡ä»¶å</span></span><br><span class="line">    img_names = img_names[img_ids]  <span class="comment"># image name for this split</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ„å»ºæ¯ä¸ªå›¾åƒçš„å®Œæ•´è·¯å¾„</span></span><br><span class="line">    img_paths = [os.path.join(image_dir, n) <span class="keyword">for</span> n <span class="keyword">in</span> img_names]</span><br><span class="line"></span><br><span class="line">    img_list = []</span><br><span class="line">    <span class="comment"># ä½¿ç”¨ tqdm æ˜¾ç¤ºåŠ è½½å›¾åƒçš„è¿›åº¦</span></span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> tqdm(img_paths):</span><br><span class="line">        <span class="comment"># è¯»å–å›¾åƒå¹¶åªä¿ç•™å‰ä¸‰ä¸ªé€šé“ï¼ˆRGBï¼‰</span></span><br><span class="line">        img = imageio.imread(p)[:, :, :<span class="number">3</span>]  <span class="comment"># (H, W, 3) np.uint8</span></span><br><span class="line">        img_list.append(img)</span><br><span class="line">    <span class="comment"># å°†å›¾åƒåˆ—è¡¨è½¬æ¢ä¸º numpy æ•°ç»„</span></span><br><span class="line">    img_list = np.stack(img_list)  <span class="comment"># (N, H, W, 3)</span></span><br><span class="line">    <span class="comment"># å°† numpy æ•°ç»„è½¬æ¢ä¸º PyTorch å¼ é‡ï¼Œå¹¶å°†åƒç´ å€¼å½’ä¸€åŒ–åˆ° [0, 1] èŒƒå›´</span></span><br><span class="line">    img_list = torch.from_numpy(img_list).<span class="built_in">float</span>() / <span class="number">255</span>  <span class="comment"># (N, H, W, 3) torch.float32</span></span><br><span class="line">    <span class="comment"># è°ƒç”¨ resize_imgs å‡½æ•°å°†å›¾åƒè°ƒæ•´åˆ°æŒ‡å®šçš„æ–°é«˜åº¦å’Œæ–°å®½åº¦</span></span><br><span class="line">    img_list = resize_imgs(img_list, new_h, new_w)</span><br><span class="line">    <span class="keyword">return</span> img_list, img_names</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_meta</span>(<span class="params">in_dir, use_ndc</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Read the poses_bounds.npy file produced by LLFF imgs2poses.py.</span></span><br><span class="line"><span class="string">    This function is modified from https://github.com/kwea123/nerf_pl.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># åŠ è½½ poses_bounds.npy æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶åŒ…å«ç›¸æœºä½å§¿å’Œæ·±åº¦è¾¹ç•Œä¿¡æ¯</span></span><br><span class="line">    poses_bounds = np.load(os.path.join(in_dir, <span class="string">&#x27;poses_bounds.npy&#x27;</span>))  <span class="comment"># (N_images, 17)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># æå–ç›¸æœºä½å§¿ä¿¡æ¯ï¼Œå°†å…¶é‡å¡‘ä¸º (N_images, 3, 5) çš„å½¢çŠ¶</span></span><br><span class="line">    c2ws = poses_bounds[:, :<span class="number">15</span>].reshape(-<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>)  <span class="comment"># (N_images, 3, 5)</span></span><br><span class="line">    <span class="comment"># æå–æ·±åº¦è¾¹ç•Œä¿¡æ¯</span></span><br><span class="line">    bounds = poses_bounds[:, -<span class="number">2</span>:]  <span class="comment"># (N_images, 2)</span></span><br><span class="line">    <span class="comment"># æå–å›¾åƒé«˜åº¦ã€å®½åº¦å’Œç„¦è·ä¿¡æ¯</span></span><br><span class="line">    H, W, focal = c2ws[<span class="number">0</span>, :, -<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä¿®æ­£ç›¸æœºä½å§¿çš„æ—‹è½¬éƒ¨åˆ†ï¼Œå°†æ—‹è½¬å½¢å¼ä» &quot;down right back&quot; æ”¹ä¸º &quot;right up back&quot;</span></span><br><span class="line">    <span class="comment"># å‚è€ƒ https://github.com/bmild/nerf/issues/34</span></span><br><span class="line">    c2ws = np.concatenate([c2ws[..., <span class="number">1</span>:<span class="number">2</span>], -c2ws[..., :<span class="number">1</span>], c2ws[..., <span class="number">2</span>:<span class="number">4</span>]], -<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¯¹ç›¸æœºä½å§¿è¿›è¡Œä¸­å¿ƒåŒ–å¤„ç†ï¼Œè¿”å›ä¸­å¿ƒåŒ–åçš„ç›¸æœºä½å§¿å’Œå¹³å‡ä½å§¿</span></span><br><span class="line">    <span class="comment"># pose_avg @ c2ws -&gt; centred c2ws</span></span><br><span class="line">    c2ws, pose_avg = center_poses(c2ws)  <span class="comment"># (N_images, 3, 4), (4, 4)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> use_ndc:</span><br><span class="line">        <span class="comment"># è·å–æœ€è¿‘æ·±åº¦å€¼</span></span><br><span class="line">        near_original = bounds.<span class="built_in">min</span>()</span><br><span class="line">        <span class="comment"># è®¡ç®—ç¼©æ”¾å› å­ï¼Œå°†æœ€è¿‘æ·±åº¦è°ƒæ•´åˆ°ç¨å¤§äº 1.0 çš„ä½ç½®</span></span><br><span class="line">        scale_factor = near_original * <span class="number">0.75</span>  <span class="comment"># 0.75 is the default parameter</span></span><br><span class="line">        <span class="comment"># å¯¹æ·±åº¦è¾¹ç•Œè¿›è¡Œç¼©æ”¾</span></span><br><span class="line">        bounds /= scale_factor</span><br><span class="line">        <span class="comment"># å¯¹ç›¸æœºä½å§¿çš„å¹³ç§»éƒ¨åˆ†è¿›è¡Œç¼©æ”¾</span></span><br><span class="line">        c2ws[..., <span class="number">3</span>] /= scale_factor</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å°† 3x4 çš„ç›¸æœºä½å§¿è½¬æ¢ä¸º 4x4 çš„é½æ¬¡çŸ©é˜µå½¢å¼</span></span><br><span class="line">    c2ws = convert3x4_4x4(c2ws)  <span class="comment"># (N, 4, 4)</span></span><br><span class="line"></span><br><span class="line">    results = &#123;</span><br><span class="line">        <span class="string">&#x27;c2ws&#x27;</span>: c2ws,       <span class="comment"># (N, 4, 4) np</span></span><br><span class="line">        <span class="string">&#x27;bounds&#x27;</span>: bounds,   <span class="comment"># (N_images, 2) np</span></span><br><span class="line">        <span class="string">&#x27;H&#x27;</span>: <span class="built_in">int</span>(H),        <span class="comment"># scalar</span></span><br><span class="line">        <span class="string">&#x27;W&#x27;</span>: <span class="built_in">int</span>(W),        <span class="comment"># scalar</span></span><br><span class="line">        <span class="string">&#x27;focal&#x27;</span>: focal,     <span class="comment"># scalar</span></span><br><span class="line">        <span class="string">&#x27;pose_avg&#x27;</span>: pose_avg,  <span class="comment"># (4, 4) np</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DataLoaderWithCOLMAP</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Most useful fields:</span></span><br><span class="line"><span class="string">        self.c2ws:          (N_imgs, 4, 4)      torch.float32</span></span><br><span class="line"><span class="string">        self.imgs           (N_imgs, H, W, 4)   torch.float32</span></span><br><span class="line"><span class="string">        self.ray_dir_cam    (H, W, 3)           torch.float32</span></span><br><span class="line"><span class="string">        self.H              scalar</span></span><br><span class="line"><span class="string">        self.W              scalar</span></span><br><span class="line"><span class="string">        self.N_imgs         scalar</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, base_dir, scene_name, data_type, res_ratio, num_img_to_load, skip, use_ndc, load_img=<span class="literal">True</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        :param base_dir:</span></span><br><span class="line"><span class="string">        :param scene_name:</span></span><br><span class="line"><span class="string">        :param data_type:   &#x27;train&#x27; or &#x27;val&#x27;.</span></span><br><span class="line"><span class="string">        :param res_ratio:   int [1, 2, 4] etc to resize images to a lower resolution.</span></span><br><span class="line"><span class="string">        :param num_img_to_load/skip: control frame loading in temporal domain.</span></span><br><span class="line"><span class="string">        :param use_ndc      True/False, just centre the poses and scale them.</span></span><br><span class="line"><span class="string">        :param load_img:    True/False. If set to false: only count number of images, get H and W,</span></span><br><span class="line"><span class="string">                            but do not load imgs. Useful when vis poses or debug etc.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.base_dir = base_dir</span><br><span class="line">        <span class="variable language_">self</span>.scene_name = scene_name</span><br><span class="line">        <span class="variable language_">self</span>.data_type = data_type</span><br><span class="line">        <span class="variable language_">self</span>.res_ratio = res_ratio</span><br><span class="line">        <span class="variable language_">self</span>.num_img_to_load = num_img_to_load</span><br><span class="line">        <span class="variable language_">self</span>.skip = skip</span><br><span class="line">        <span class="variable language_">self</span>.use_ndc = use_ndc</span><br><span class="line">        <span class="variable language_">self</span>.load_img = load_img</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ„å»ºåœºæ™¯ç›®å½•çš„å®Œæ•´è·¯å¾„</span></span><br><span class="line">        <span class="variable language_">self</span>.scene_dir = os.path.join(<span class="variable language_">self</span>.base_dir, <span class="variable language_">self</span>.scene_name)</span><br><span class="line">        <span class="comment"># æ„å»ºå›¾åƒç›®å½•çš„å®Œæ•´è·¯å¾„</span></span><br><span class="line">        <span class="variable language_">self</span>.img_dir = os.path.join(<span class="variable language_">self</span>.scene_dir, <span class="string">&#x27;images&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è¯»å–æ‰€æœ‰çš„å…ƒä¿¡æ¯ï¼ŒåŒ…æ‹¬ç›¸æœºä½å§¿ã€æ·±åº¦è¾¹ç•Œã€å›¾åƒå°ºå¯¸å’Œç„¦è·ç­‰</span></span><br><span class="line">        meta = read_meta(<span class="variable language_">self</span>.scene_dir, <span class="variable language_">self</span>.use_ndc)</span><br><span class="line">        <span class="comment"># æå–ç›¸æœºä½å§¿ä¿¡æ¯</span></span><br><span class="line">        <span class="variable language_">self</span>.c2ws = meta[<span class="string">&#x27;c2ws&#x27;</span>]  <span class="comment"># (N, 4, 4) all camera pose</span></span><br><span class="line">        <span class="comment"># æå–å›¾åƒé«˜åº¦ä¿¡æ¯</span></span><br><span class="line">        <span class="variable language_">self</span>.H = meta[<span class="string">&#x27;H&#x27;</span>]</span><br><span class="line">        <span class="comment"># æå–å›¾åƒå®½åº¦ä¿¡æ¯</span></span><br><span class="line">        <span class="variable language_">self</span>.W = meta[<span class="string">&#x27;W&#x27;</span>]</span><br><span class="line">        <span class="comment"># æå–ç„¦è·ä¿¡æ¯</span></span><br><span class="line">        <span class="variable language_">self</span>.focal = <span class="built_in">float</span>(meta[<span class="string">&#x27;focal&#x27;</span>])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.res_ratio &gt; <span class="number">1</span>:</span><br><span class="line">            <span class="comment"># å¦‚æœéœ€è¦è°ƒæ•´å›¾åƒåˆ†è¾¨ç‡ï¼Œå¯¹å›¾åƒé«˜åº¦è¿›è¡Œç›¸åº”çš„ç¼©æ”¾</span></span><br><span class="line">            <span class="variable language_">self</span>.H = <span class="variable language_">self</span>.H // <span class="variable language_">self</span>.res_ratio</span><br><span class="line">            <span class="comment"># å¦‚æœéœ€è¦è°ƒæ•´å›¾åƒåˆ†è¾¨ç‡ï¼Œå¯¹å›¾åƒå®½åº¦è¿›è¡Œç›¸åº”çš„ç¼©æ”¾</span></span><br><span class="line">            <span class="variable language_">self</span>.W = <span class="variable language_">self</span>.W // <span class="variable language_">self</span>.res_ratio</span><br><span class="line">            <span class="comment"># å¦‚æœéœ€è¦è°ƒæ•´å›¾åƒåˆ†è¾¨ç‡ï¼Œå¯¹ç„¦è·è¿›è¡Œç›¸åº”çš„ç¼©æ”¾</span></span><br><span class="line">            <span class="variable language_">self</span>.focal /= <span class="variable language_">self</span>.res_ratio</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è¿‘è£å‰ªå¹³é¢è·ç¦»</span></span><br><span class="line">        <span class="variable language_">self</span>.near = <span class="number">0.0</span></span><br><span class="line">        <span class="comment"># è¿œè£å‰ªå¹³é¢è·ç¦»</span></span><br><span class="line">        <span class="variable language_">self</span>.far = <span class="number">1.0</span></span><br><span class="line">        <span class="comment"># åŠ è½½å›¾åƒå¹¶è°ƒæ•´åˆ°æŒ‡å®šçš„é«˜åº¦å’Œå®½åº¦</span></span><br><span class="line">        <span class="variable language_">self</span>.imgs, <span class="variable language_">self</span>.img_names = load_imgs(<span class="variable language_">self</span>.img_dir, np.arange(num_img_to_load), <span class="variable language_">self</span>.H, <span class="variable language_">self</span>.W)  <span class="comment"># (N, H, W, 3) torch.float32</span></span><br><span class="line">        <span class="comment"># æˆªå–å‰ num_img_to_load ä¸ªç›¸æœºä½å§¿</span></span><br><span class="line">        <span class="variable language_">self</span>.c2ws = <span class="variable language_">self</span>.c2ws[:num_img_to_load]</span><br><span class="line">        <span class="comment"># å›¾åƒçš„æ•°é‡</span></span><br><span class="line">        <span class="variable language_">self</span>.N_imgs = <span class="variable language_">self</span>.c2ws.shape[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ç”Ÿæˆç›¸æœºåæ ‡ç³»ä¸‹çš„å…‰çº¿æ–¹å‘</span></span><br><span class="line">        <span class="variable language_">self</span>.ray_dir_cam = comp_ray_dir_cam(<span class="variable language_">self</span>.H, <span class="variable language_">self</span>.W, <span class="variable language_">self</span>.focal)  <span class="comment"># (H, W, 3) torch.float32</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># å°†ç›¸æœºä½å§¿ä» numpy æ•°ç»„è½¬æ¢ä¸º PyTorch å¼ é‡</span></span><br><span class="line">        <span class="variable language_">self</span>.c2ws = torch.from_numpy(<span class="variable language_">self</span>.c2ws).<span class="built_in">float</span>()  <span class="comment"># (N, 4, 4) torch.float32</span></span><br><span class="line">        <span class="comment"># å°†å…‰çº¿æ–¹å‘å¼ é‡è½¬æ¢ä¸º float32 ç±»å‹</span></span><br><span class="line">        <span class="variable language_">self</span>.ray_dir_cam = <span class="variable language_">self</span>.ray_dir_cam.<span class="built_in">float</span>()  <span class="comment"># (H, W, 3) torch.float32</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    scene_name = <span class="string">&#x27;LLFF/fern&#x27;</span></span><br><span class="line">    use_ndc = <span class="literal">True</span></span><br><span class="line">    <span class="comment"># æ³¨æ„ï¼šéœ€è¦å°† /your/data/path æ›¿æ¢ä¸ºå®é™…çš„æ•°æ®è·¯å¾„ï¼Œ</span></span><br><span class="line">    <span class="comment"># è¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ª DataLoaderWithCOLMAP ç±»çš„å®ä¾‹ï¼Œç”¨äºåŠ è½½æŒ‡å®šåœºæ™¯çš„æ•°æ®</span></span><br><span class="line">    scene = DataLoaderWithCOLMAP(base_dir=<span class="string">&#x27;/your/data/path&#x27;</span>,</span><br><span class="line">                                 scene_name=scene_name,</span><br><span class="line">                                 data_type=<span class="string">&#x27;train&#x27;</span>,</span><br><span class="line">                                 res_ratio=<span class="number">8</span>,</span><br><span class="line">                                 num_img_to_load=-<span class="number">1</span>,</span><br><span class="line">                                 skip=<span class="number">1</span>,</span><br><span class="line">                                 use_ndc=use_ndc)</span><br></pre></td></tr></table></figure>



<h4 id="with-feature-colmap-py"><a href="#with-feature-colmap-py" class="headerlink" title="with_feature_colmap.py"></a>with_feature_colmap.py</h4><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="comment"># os æ¨¡å—æä¾›äº†ä¸æ“ä½œç³»ç»Ÿè¿›è¡Œäº¤äº’çš„åŠŸèƒ½ï¼Œ</span></span><br><span class="line"><span class="comment"># å¯ç”¨äºå¤„ç†æ–‡ä»¶å’Œç›®å½•è·¯å¾„ã€åˆ›å»º/åˆ é™¤ç›®å½•ã€è·å–ç¯å¢ƒå˜é‡ç­‰ï¼Œ</span></span><br><span class="line"><span class="comment"># åœ¨æœ¬ä»£ç é‡Œä¸»è¦ç”¨äºæ„å»ºæ–‡ä»¶å’Œç›®å½•çš„è·¯å¾„ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="comment"># torch æ˜¯ PyTorch çš„æ ¸å¿ƒåº“ï¼Œæä¾›äº†å¼ é‡ï¼ˆTensorï¼‰æ•°æ®ç»“æ„ï¼Œ</span></span><br><span class="line"><span class="comment"># æ”¯æŒè‡ªåŠ¨æ±‚å¯¼æœºåˆ¶ï¼Œç”¨äºæ„å»ºå’Œè®­ç»ƒæ·±åº¦å­¦ä¹ æ¨¡å‹ï¼Œ</span></span><br><span class="line"><span class="comment"># èƒ½å¤Ÿåœ¨ CPU æˆ– GPU ä¸Šé«˜æ•ˆåœ°è¿›è¡Œæ•°å€¼è®¡ç®—ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="comment"># numpy æ˜¯ Python ä¸­ç”¨äºç§‘å­¦è®¡ç®—çš„åŸºç¡€åº“ï¼Œ</span></span><br><span class="line"><span class="comment"># æä¾›äº†é«˜æ•ˆçš„å¤šç»´æ•°ç»„å¯¹è±¡å’Œå„ç§æ•°å­¦å‡½æ•°ï¼Œ</span></span><br><span class="line"><span class="comment"># å¯è¿›è¡Œæ•°ç»„æ“ä½œã€çº¿æ€§ä»£æ•°è¿ç®—ã€éšæœºæ•°ç”Ÿæˆç­‰ï¼Œ</span></span><br><span class="line"><span class="comment"># åœ¨ä»£ç ä¸­ä¸»è¦ç”¨äºå¤„ç†å›¾åƒæ•°æ®å’Œæ•°ç»„æ“ä½œã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="comment"># tqdm æ˜¯ä¸€ä¸ªå¿«é€Ÿã€å¯æ‰©å±•çš„è¿›åº¦æ¡å·¥å…·ï¼Œ</span></span><br><span class="line"><span class="comment"># èƒ½åœ¨å¾ªç¯ä¸­æ˜¾ç¤ºè¿›åº¦æ¡ï¼Œæ–¹ä¾¿ç”¨æˆ·äº†è§£ä»£ç æ‰§è¡Œçš„è¿›åº¦ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> imageio</span><br><span class="line"><span class="comment"># imageio æ˜¯ä¸€ä¸ªç”¨äºè¯»å–å’Œå†™å…¥å¤šç§å›¾åƒæ–‡ä»¶æ ¼å¼çš„åº“ï¼Œ</span></span><br><span class="line"><span class="comment"># åœ¨ä»£ç ä¸­ä¸»è¦ç”¨äºè¯»å–å›¾åƒæ–‡ä»¶ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> dataloader.with_colmap <span class="keyword">import</span> resize_imgs</span><br><span class="line"><span class="comment"># ä» dataloader.with_colmap æ¨¡å—å¯¼å…¥ resize_imgs å‡½æ•°ï¼Œ</span></span><br><span class="line"><span class="comment"># è¯¥å‡½æ•°ç”¨äºè°ƒæ•´å›¾åƒçš„å°ºå¯¸ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> torchvision <span class="keyword">import</span> models</span><br><span class="line"><span class="comment"># torchvision æ˜¯ PyTorch ä¸­ç”¨äºè®¡ç®—æœºè§†è§‰ä»»åŠ¡çš„åº“ï¼Œ</span></span><br><span class="line"><span class="comment"># models å­æ¨¡å—æä¾›äº†é¢„è®­ç»ƒçš„æ·±åº¦å­¦ä¹ æ¨¡å‹ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> torch.nn <span class="keyword">import</span> functional <span class="keyword">as</span> F</span><br><span class="line"><span class="comment"># torch.nn.functional æä¾›äº†è®¸å¤šç¥ç»ç½‘ç»œä¸­å¸¸ç”¨çš„å‡½æ•°ï¼Œ</span></span><br><span class="line"><span class="comment"># ä¾‹å¦‚æ¿€æ´»å‡½æ•°ã€æŸå¤±å‡½æ•°ã€å·ç§¯ã€æ± åŒ–ç­‰æ“ä½œï¼Œ</span></span><br><span class="line"><span class="comment"># è¿™äº›å‡½æ•°æ˜¯æ— çŠ¶æ€çš„ï¼Œé€šå¸¸ç”¨äºè‡ªå®šä¹‰ç¥ç»ç½‘ç»œå±‚ä¸­çš„å…·ä½“è¿ç®—ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> utils.comp_ray_dir <span class="keyword">import</span> comp_ray_dir_cam</span><br><span class="line"><span class="comment"># ä» utils åŒ…ä¸­çš„ comp_ray_dir æ¨¡å—å¯¼å…¥ comp_ray_dir_cam å‡½æ•°ï¼Œ</span></span><br><span class="line"><span class="comment"># æ¨æµ‹è¯¥å‡½æ•°ç”¨äºè®¡ç®—ç›¸æœºåæ ‡ç³»ä¸‹çš„å…‰çº¿æ–¹å‘ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> utils.pose_utils <span class="keyword">import</span> center_poses</span><br><span class="line"><span class="comment"># ä» utils åŒ…ä¸­çš„ pose_utils æ¨¡å—å¯¼å…¥ center_poses å‡½æ•°ï¼Œ</span></span><br><span class="line"><span class="comment"># æ¨æµ‹è¯¥å‡½æ•°ç”¨äºå¯¹ç›¸æœºä½å§¿è¿›è¡Œä¸­å¿ƒåŒ–å¤„ç†ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> utils.lie_group_helper <span class="keyword">import</span> convert3x4_4x4</span><br><span class="line"><span class="comment"># ä» utils åŒ…ä¸­çš„ lie_group_helper æ¨¡å—å¯¼å…¥ convert3x4_4x4 å‡½æ•°ï¼Œ</span></span><br><span class="line"><span class="comment"># æ¨æµ‹è¯¥å‡½æ•°ç”¨äºå°† 3x4 çš„ç›¸æœºä½å§¿çŸ©é˜µè½¬æ¢ä¸º 4x4 çš„é½æ¬¡çŸ©é˜µã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> utils.vgg <span class="keyword">import</span> Vgg19</span><br><span class="line"><span class="comment"># ä» utils.vgg æ¨¡å—å¯¼å…¥ Vgg19 ç±»ï¼Œå¯èƒ½ç”¨äºç‰¹å¾æå–ã€‚</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_imgs</span>(<span class="params">image_dir, num_img_to_load, start, end, skip, load_sorted, load_img</span>):</span><br><span class="line">    <span class="comment"># è·å–å›¾åƒç›®å½•ä¸‹æ‰€æœ‰å›¾åƒæ–‡ä»¶åï¼Œå¹¶æŒ‰å­—æ¯é¡ºåºæ’åº</span></span><br><span class="line">    img_names = np.array(<span class="built_in">sorted</span>(os.listdir(image_dir)))  <span class="comment"># all image names</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># åœ¨æ—¶é—´åŸŸä¸Šå¯¹å¸§è¿›è¡Œä¸‹é‡‡æ ·</span></span><br><span class="line">    <span class="keyword">if</span> end == -<span class="number">1</span>:</span><br><span class="line">        img_names = img_names[start::skip]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        img_names = img_names[start:end:skip]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¦‚æœä¸æŒ‰é¡ºåºåŠ è½½å›¾åƒï¼Œåˆ™å¯¹å›¾åƒæ–‡ä»¶åè¿›è¡Œéšæœºæ‰“ä¹±</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> load_sorted:</span><br><span class="line">        np.random.shuffle(img_names)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># åŠ è½½ä¸‹é‡‡æ ·åçš„å›¾åƒ</span></span><br><span class="line">    <span class="keyword">if</span> num_img_to_load &gt; <span class="built_in">len</span>(img_names):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Asked for &#123;0:6d&#125; images but only &#123;1:6d&#125; available. Exit.&#x27;</span>.<span class="built_in">format</span>(num_img_to_load, <span class="built_in">len</span>(img_names)))</span><br><span class="line">        exit()</span><br><span class="line">    <span class="keyword">elif</span> num_img_to_load == -<span class="number">1</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Loading all available &#123;0:6d&#125; images&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">len</span>(img_names)))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Loading &#123;0:6d&#125; images out of &#123;1:6d&#125; images.&#x27;</span>.<span class="built_in">format</span>(num_img_to_load, <span class="built_in">len</span>(img_names)))</span><br><span class="line">        img_names = img_names[:num_img_to_load]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ„å»ºæ¯ä¸ªå›¾åƒçš„å®Œæ•´è·¯å¾„</span></span><br><span class="line">    img_paths = [os.path.join(image_dir, n) <span class="keyword">for</span> n <span class="keyword">in</span> img_names]</span><br><span class="line">    <span class="comment"># å›¾åƒçš„æ•°é‡</span></span><br><span class="line">    N_imgs = <span class="built_in">len</span>(img_paths)</span><br><span class="line"></span><br><span class="line">    img_list = []</span><br><span class="line">    <span class="keyword">if</span> load_img:</span><br><span class="line">        <span class="comment"># ä½¿ç”¨ tqdm æ˜¾ç¤ºåŠ è½½å›¾åƒçš„è¿›åº¦</span></span><br><span class="line">        <span class="keyword">for</span> p <span class="keyword">in</span> tqdm(img_paths):</span><br><span class="line">            <span class="comment"># è¯»å–å›¾åƒå¹¶åªä¿ç•™å‰ä¸‰ä¸ªé€šé“ï¼ˆRGBï¼‰</span></span><br><span class="line">            img = imageio.imread(p)[:, :, :<span class="number">3</span>]  <span class="comment"># (H, W, 3) np.uint8</span></span><br><span class="line">            img_list.append(img)</span><br><span class="line">        <span class="comment"># å°†å›¾åƒåˆ—è¡¨è½¬æ¢ä¸º numpy æ•°ç»„</span></span><br><span class="line">        img_list = np.stack(img_list)  <span class="comment"># (N, H, W, 3)</span></span><br><span class="line">        <span class="comment"># å°† numpy æ•°ç»„è½¬æ¢ä¸º PyTorch å¼ é‡ï¼Œå¹¶å°†åƒç´ å€¼å½’ä¸€åŒ–åˆ° [0, 1] èŒƒå›´</span></span><br><span class="line">        img_list = torch.from_numpy(img_list).<span class="built_in">float</span>() / <span class="number">255</span>  <span class="comment"># (N, H, W, 3) torch.float32</span></span><br><span class="line">        <span class="comment"># è·å–å›¾åƒçš„é«˜åº¦å’Œå®½åº¦</span></span><br><span class="line">        H, W = img_list.shape[<span class="number">1</span>], img_list.shape[<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># å¦‚æœä¸åŠ è½½å›¾åƒï¼Œåˆ™è¯»å–ç¬¬ä¸€å¼ å›¾åƒä»¥è·å–å›¾åƒçš„é«˜åº¦å’Œå®½åº¦</span></span><br><span class="line">        tmp_img = imageio.imread(img_paths[<span class="number">0</span>])  <span class="comment"># load one image to get H, W</span></span><br><span class="line">        H, W = tmp_img.shape[<span class="number">0</span>], tmp_img.shape[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    result = &#123;</span><br><span class="line">        <span class="string">&#x27;imgs&#x27;</span>: img_list,  <span class="comment"># (N, H, W, 3) torch.float32</span></span><br><span class="line">        <span class="string">&#x27;img_names&#x27;</span>: img_names,  <span class="comment"># (N, )</span></span><br><span class="line">        <span class="string">&#x27;N_imgs&#x27;</span>: N_imgs,</span><br><span class="line">        <span class="string">&#x27;H&#x27;</span>: H,</span><br><span class="line">        <span class="string">&#x27;W&#x27;</span>: W,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_meta</span>(<span class="params">in_dir, use_ndc</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Read the poses_bounds.npy file produced by LLFF imgs2poses.py.</span></span><br><span class="line"><span class="string">    This function is modified from https://github.com/kwea123/nerf_pl.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># åŠ è½½ poses_bounds.npy æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶åŒ…å«ç›¸æœºä½å§¿å’Œæ·±åº¦è¾¹ç•Œä¿¡æ¯</span></span><br><span class="line">    poses_bounds = np.load(os.path.join(in_dir, <span class="string">&#x27;../poses_bounds.npy&#x27;</span>))  <span class="comment"># (N_images, 17)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># æå–ç›¸æœºä½å§¿ä¿¡æ¯ï¼Œå°†å…¶é‡å¡‘ä¸º (N_images, 3, 5) çš„å½¢çŠ¶</span></span><br><span class="line">    c2ws = poses_bounds[:, :<span class="number">15</span>].reshape(-<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>)  <span class="comment"># (N_images, 3, 5)</span></span><br><span class="line">    <span class="comment"># æå–æ·±åº¦è¾¹ç•Œä¿¡æ¯</span></span><br><span class="line">    bounds = poses_bounds[:, -<span class="number">2</span>:]  <span class="comment"># (N_images, 2)</span></span><br><span class="line">    <span class="comment"># æå–å›¾åƒé«˜åº¦ã€å®½åº¦å’Œç„¦è·ä¿¡æ¯</span></span><br><span class="line">    H, W, focal = c2ws[<span class="number">0</span>, :, -<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä¿®æ­£ç›¸æœºä½å§¿çš„æ—‹è½¬éƒ¨åˆ†ï¼Œå°†æ—‹è½¬å½¢å¼ä» &quot;down right back&quot; æ”¹ä¸º &quot;right up back&quot;</span></span><br><span class="line">    <span class="comment"># å‚è€ƒ https://github.com/bmild/nerf/issues/34</span></span><br><span class="line">    c2ws = np.concatenate([c2ws[..., <span class="number">1</span>:<span class="number">2</span>], -c2ws[..., :<span class="number">1</span>], c2ws[..., <span class="number">2</span>:<span class="number">4</span>]], -<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¯¹ç›¸æœºä½å§¿è¿›è¡Œä¸­å¿ƒåŒ–å¤„ç†ï¼Œè¿”å›ä¸­å¿ƒåŒ–åçš„ç›¸æœºä½å§¿å’Œå¹³å‡ä½å§¿</span></span><br><span class="line">    <span class="comment"># pose_avg @ c2ws -&gt; centred c2ws</span></span><br><span class="line">    c2ws, pose_avg = center_poses(c2ws)  <span class="comment"># (N_images, 3, 4), (4, 4)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> use_ndc:</span><br><span class="line">        <span class="comment"># ä¿®æ­£å°ºåº¦ï¼Œä½¿æœ€è¿‘çš„æ·±åº¦ç•¥å¤§äº 1.0</span></span><br><span class="line">        <span class="comment"># å‚è€ƒ https://github.com/bmild/nerf/issues/34</span></span><br><span class="line">        near_original = bounds.<span class="built_in">min</span>()</span><br><span class="line">        <span class="comment"># 0.75 æ˜¯é»˜è®¤å‚æ•°</span></span><br><span class="line">        scale_factor = near_original * <span class="number">0.75</span>  </span><br><span class="line">        <span class="comment"># æœ€è¿‘çš„æ·±åº¦çº¦ä¸º 1/0.75 = 1.33</span></span><br><span class="line">        bounds /= scale_factor</span><br><span class="line">        c2ws[..., <span class="number">3</span>] /= scale_factor</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å°† 3x4 çš„ç›¸æœºä½å§¿çŸ©é˜µè½¬æ¢ä¸º 4x4 çš„é½æ¬¡çŸ©é˜µå½¢å¼</span></span><br><span class="line">    c2ws = convert3x4_4x4(c2ws)  <span class="comment"># (N, 4, 4)</span></span><br><span class="line"></span><br><span class="line">    results = &#123;</span><br><span class="line">        <span class="string">&#x27;c2ws&#x27;</span>: c2ws,       <span class="comment"># (N, 4, 4) np</span></span><br><span class="line">        <span class="string">&#x27;bounds&#x27;</span>: bounds,   <span class="comment"># (N_images, 2) np</span></span><br><span class="line">        <span class="string">&#x27;H&#x27;</span>: <span class="built_in">int</span>(H),        <span class="comment"># scalar</span></span><br><span class="line">        <span class="string">&#x27;W&#x27;</span>: <span class="built_in">int</span>(W),        <span class="comment"># scalar</span></span><br><span class="line">        <span class="string">&#x27;focal&#x27;</span>: focal,     <span class="comment"># scalar</span></span><br><span class="line">        <span class="string">&#x27;pose_avg&#x27;</span>: pose_avg,  <span class="comment"># (4, 4) np</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Dataloader_feature_n_colmap</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Most useful fields:</span></span><br><span class="line"><span class="string">        self.c2ws:          (N_imgs, 4, 4)      torch.float32</span></span><br><span class="line"><span class="string">        self.imgs           (N_imgs, H, W, 4)   torch.float32</span></span><br><span class="line"><span class="string">        self.ray_dir_cam    (H, W, 3)           torch.float32</span></span><br><span class="line"><span class="string">        self.H              scalar</span></span><br><span class="line"><span class="string">        self.W              scalar</span></span><br><span class="line"><span class="string">        self.N_imgs         scalar</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, base_dir, scene_name, res_ratio, num_img_to_load, start=<span class="number">0</span>, end=-<span class="number">1</span>, skip=<span class="number">1</span>,</span></span><br><span class="line"><span class="params">                 load_sorted=<span class="literal">True</span>, load_img=<span class="literal">True</span>, use_ndc=<span class="literal">True</span>, device=<span class="string">&#x27;cpu&#x27;</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        :param base_dir: æ•°æ®çš„åŸºç¡€ç›®å½•</span></span><br><span class="line"><span class="string">        :param scene_name: åœºæ™¯çš„åç§°</span></span><br><span class="line"><span class="string">        :param res_ratio: æ•´æ•°ï¼Œå¦‚ [1, 2, 4] ç­‰ï¼Œç”¨äºå°†å›¾åƒè°ƒæ•´ä¸ºè¾ƒä½çš„åˆ†è¾¨ç‡ã€‚</span></span><br><span class="line"><span class="string">        :param start/end/skip: ç”¨äºåœ¨æ—¶é—´åŸŸä¸Šæ§åˆ¶å¸§çš„åŠ è½½ã€‚</span></span><br><span class="line"><span class="string">        :param load_sorted: å¸ƒå°”å€¼ï¼Œæ˜¯å¦æŒ‰é¡ºåºåŠ è½½å›¾åƒã€‚</span></span><br><span class="line"><span class="string">        :param load_img: å¸ƒå°”å€¼ã€‚å¦‚æœè®¾ç½®ä¸º falseï¼šä»…ç»Ÿè®¡å›¾åƒæ•°é‡ã€è·å–å›¾åƒçš„é«˜åº¦å’Œå®½åº¦ï¼Œ</span></span><br><span class="line"><span class="string">                         ä½†ä¸åŠ è½½å›¾åƒã€‚åœ¨å¯è§†åŒ–ä½å§¿æˆ–è°ƒè¯•ç­‰æƒ…å†µä¸‹å¾ˆæœ‰ç”¨ã€‚</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.base_dir = base_dir</span><br><span class="line">        <span class="variable language_">self</span>.scene_name = scene_name</span><br><span class="line">        <span class="variable language_">self</span>.res_ratio = res_ratio</span><br><span class="line">        <span class="variable language_">self</span>.num_img_to_load = num_img_to_load</span><br><span class="line">        <span class="variable language_">self</span>.start = start</span><br><span class="line">        <span class="variable language_">self</span>.end = end</span><br><span class="line">        <span class="variable language_">self</span>.skip = skip</span><br><span class="line">        <span class="variable language_">self</span>.use_ndc = use_ndc</span><br><span class="line">        <span class="variable language_">self</span>.load_sorted = load_sorted</span><br><span class="line">        <span class="variable language_">self</span>.load_img = load_img</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ„å»ºå›¾åƒç›®å½•çš„å®Œæ•´è·¯å¾„</span></span><br><span class="line">        <span class="variable language_">self</span>.imgs_dir = os.path.join(<span class="variable language_">self</span>.base_dir, <span class="variable language_">self</span>.scene_name)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è¯»å–æ‰€æœ‰çš„å…ƒä¿¡æ¯ï¼ŒåŒ…æ‹¬ç›¸æœºä½å§¿ã€æ·±åº¦è¾¹ç•Œã€å›¾åƒå°ºå¯¸å’Œç„¦è·ç­‰</span></span><br><span class="line">        meta = read_meta(<span class="variable language_">self</span>.imgs_dir, <span class="variable language_">self</span>.use_ndc)</span><br><span class="line">        <span class="comment"># æå–ç›¸æœºä½å§¿ä¿¡æ¯å¹¶è½¬æ¢ä¸º PyTorch å¼ é‡</span></span><br><span class="line">        <span class="variable language_">self</span>.c2ws = torch.Tensor(meta[<span class="string">&#x27;c2ws&#x27;</span>])  <span class="comment"># (N, 4, 4) all camera pose</span></span><br><span class="line">        <span class="comment"># æå–ç„¦è·ä¿¡æ¯</span></span><br><span class="line">        <span class="variable language_">self</span>.focal = <span class="built_in">float</span>(meta[<span class="string">&#x27;focal&#x27;</span>])</span><br><span class="line">        <span class="comment"># æ ¹æ® startã€end å’Œ skip å‚æ•°å¯¹ç›¸æœºä½å§¿è¿›è¡Œç­›é€‰</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.end == -<span class="number">1</span>:</span><br><span class="line">            <span class="variable language_">self</span>.c2ws = <span class="variable language_">self</span>.c2ws[<span class="variable language_">self</span>.start::<span class="variable language_">self</span>.skip]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="variable language_">self</span>.c2ws = <span class="variable language_">self</span>.c2ws[<span class="variable language_">self</span>.start:<span class="variable language_">self</span>.end:<span class="variable language_">self</span>.skip]</span><br><span class="line">        <span class="comment"># åŠ è½½å›¾åƒæ•°æ®</span></span><br><span class="line">        image_data = load_imgs(<span class="variable language_">self</span>.imgs_dir, <span class="variable language_">self</span>.num_img_to_load, <span class="variable language_">self</span>.start, <span class="variable language_">self</span>.end, <span class="variable language_">self</span>.skip,</span><br><span class="line">                                <span class="variable language_">self</span>.load_sorted, <span class="variable language_">self</span>.load_img)</span><br><span class="line">        <span class="comment"># æå–åŠ è½½çš„å›¾åƒæ•°æ®</span></span><br><span class="line">        <span class="variable language_">self</span>.imgs = image_data[<span class="string">&#x27;imgs&#x27;</span>]  <span class="comment"># (N, H, W, 3) torch.float32</span></span><br><span class="line">        <span class="comment"># æå–å›¾åƒæ–‡ä»¶å</span></span><br><span class="line">        <span class="variable language_">self</span>.img_names = image_data[<span class="string">&#x27;img_names&#x27;</span>]  <span class="comment"># (N, )</span></span><br><span class="line">        <span class="comment"># å›¾åƒçš„æ•°é‡</span></span><br><span class="line">        <span class="variable language_">self</span>.N_imgs = image_data[<span class="string">&#x27;N_imgs&#x27;</span>]</span><br><span class="line">        <span class="comment"># åŸå§‹å›¾åƒçš„é«˜åº¦</span></span><br><span class="line">        <span class="variable language_">self</span>.ori_H = image_data[<span class="string">&#x27;H&#x27;</span>]</span><br><span class="line">        <span class="comment"># åŸå§‹å›¾åƒçš„å®½åº¦</span></span><br><span class="line">        <span class="variable language_">self</span>.ori_W = image_data[<span class="string">&#x27;W&#x27;</span>]</span><br><span class="line">        <span class="comment"># åˆå§‹åŒ– Vgg19 ç¼–ç å™¨å¹¶å°†å…¶ç§»åŠ¨åˆ°æŒ‡å®šè®¾å¤‡</span></span><br><span class="line">        <span class="variable language_">self</span>.encoder = Vgg19().to(device)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å§‹ç»ˆä½¿ç”¨å½’ä¸€åŒ–è®¾å¤‡åæ ‡ï¼ˆNDCï¼‰</span></span><br><span class="line">        <span class="variable language_">self</span>.near = <span class="number">0.0</span></span><br><span class="line">        <span class="variable language_">self</span>.far = <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># å¦‚æœéœ€è¦è°ƒæ•´å›¾åƒåˆ†è¾¨ç‡</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.res_ratio &gt; <span class="number">1</span>:</span><br><span class="line">            <span class="comment"># è®¡ç®—è°ƒæ•´åçš„å›¾åƒé«˜åº¦</span></span><br><span class="line">            <span class="variable language_">self</span>.H = <span class="variable language_">self</span>.ori_H // <span class="variable language_">self</span>.res_ratio</span><br><span class="line">            <span class="comment"># è®¡ç®—è°ƒæ•´åçš„å›¾åƒå®½åº¦</span></span><br><span class="line">            <span class="variable language_">self</span>.W = <span class="variable language_">self</span>.ori_W // <span class="variable language_">self</span>.res_ratio</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="variable language_">self</span>.H = <span class="variable language_">self</span>.ori_H</span><br><span class="line">            <span class="variable language_">self</span>.W = <span class="variable language_">self</span>.ori_W</span><br><span class="line">        <span class="comment"># è°ƒæ•´ç„¦è·</span></span><br><span class="line">        <span class="variable language_">self</span>.focal /= <span class="variable language_">self</span>.res_ratio</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.load_img:</span><br><span class="line">            <span class="comment"># è°ƒæ•´å›¾åƒçš„åˆ†è¾¨ç‡å¹¶å°†å…¶ç§»åŠ¨åˆ°æŒ‡å®šè®¾å¤‡</span></span><br><span class="line">            <span class="variable language_">self</span>.imgs = resize_imgs(<span class="variable language_">self</span>.imgs, <span class="variable language_">self</span>.H, <span class="variable language_">self</span>.W).to(device)  <span class="comment"># (N, H, W, 3) torch.float32</span></span><br><span class="line">            <span class="variable language_">self</span>.features = []</span><br><span class="line">            <span class="comment"># ä½¿ç”¨ tqdm æ˜¾ç¤ºå¤„ç†è¿›åº¦</span></span><br><span class="line">            <span class="keyword">for</span> img <span class="keyword">in</span> tqdm(<span class="variable language_">self</span>.imgs):</span><br><span class="line">                <span class="comment"># å¯¹å›¾åƒè¿›è¡Œé€šé“ç»´åº¦çš„è°ƒæ•´ï¼Œå¹¶é€šè¿‡ç¼–ç å™¨æå–ç‰¹å¾</span></span><br><span class="line">                <span class="variable language_">self</span>.features.append(<span class="variable language_">self</span>.encoder(img.permute(<span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>)[<span class="literal">None</span>, ...]))</span><br><span class="line">            <span class="comment"># è¿™é‡Œæ³¨é‡Šæ‰äº†ç‰¹å¾æ‹¼æ¥çš„ä»£ç ï¼Œå¯æ ¹æ®éœ€è¦å–æ¶ˆæ³¨é‡Š</span></span><br><span class="line">            <span class="comment"># self.features = torch.cat(self.features, 0)</span></span><br><span class="line">            <span class="comment"># print(self.features.shape)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># æ•°æ®çš„åŸºç¡€ç›®å½•ï¼Œéœ€è¦æ›¿æ¢ä¸ºå®é™…çš„è·¯å¾„</span></span><br><span class="line">    base_dir = <span class="string">&#x27;/your/data/path&#x27;</span></span><br><span class="line">    <span class="comment"># åœºæ™¯çš„åç§°</span></span><br><span class="line">    scene_name = <span class="string">&#x27;LLFF/fern/images&#x27;</span></span><br><span class="line">    <span class="comment"># å›¾åƒçš„ç¼©æ”¾æ¯”ä¾‹</span></span><br><span class="line">    resize_ratio = <span class="number">8</span></span><br><span class="line">    <span class="comment"># è¦åŠ è½½çš„å›¾åƒæ•°é‡ï¼Œ-1 è¡¨ç¤ºåŠ è½½æ‰€æœ‰å›¾åƒ</span></span><br><span class="line">    num_img_to_load = -<span class="number">1</span></span><br><span class="line">    <span class="comment"># å¼€å§‹åŠ è½½å›¾åƒçš„ç´¢å¼•</span></span><br><span class="line">    start = <span class="number">0</span></span><br><span class="line">    <span class="comment"># ç»“æŸåŠ è½½å›¾åƒçš„ç´¢å¼•ï¼Œ-1 è¡¨ç¤ºåŠ è½½åˆ°æœ€å</span></span><br><span class="line">    end = -<span class="number">1</span></span><br><span class="line">    <span class="comment"># åŠ è½½å›¾åƒçš„é—´éš”</span></span><br><span class="line">    skip = <span class="number">1</span></span><br><span class="line">    <span class="comment"># æ˜¯å¦æŒ‰é¡ºåºåŠ è½½å›¾åƒ</span></span><br><span class="line">    load_sorted = <span class="literal">True</span></span><br><span class="line">    <span class="comment"># æ˜¯å¦åŠ è½½å›¾åƒ</span></span><br><span class="line">    load_img = <span class="literal">True</span></span><br><span class="line">    <span class="comment"># æ˜¯å¦ä½¿ç”¨å½’ä¸€åŒ–è®¾å¤‡åæ ‡ï¼ˆNDCï¼‰</span></span><br><span class="line">    use_ndc = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># åˆå§‹åŒ– Dataloader_feature_n_colmap ç±»</span></span><br><span class="line">    scene = Dataloader_feature_n_colmap(base_dir=base_dir,</span><br><span class="line">                                scene_name=scene_name,</span><br><span class="line">                                res_ratio=resize_ratio,</span><br><span class="line">                                num_img_to_load=num_img_to_load,</span><br><span class="line">                                start=start,</span><br><span class="line">                                end=end,</span><br><span class="line">                                skip=skip,</span><br><span class="line">                                load_sorted=load_sorted,</span><br><span class="line">                                load_img=load_img,</span><br><span class="line">                                use_ndc=use_ndc)</span><br></pre></td></tr></table></figure>



<h4 id="with-feature-py"><a href="#with-feature-py" class="headerlink" title="with_feature.py"></a>with_feature.py</h4><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="comment"># os æ¨¡å—æä¾›äº†ä¸æ“ä½œç³»ç»Ÿè¿›è¡Œäº¤äº’çš„åŠŸèƒ½ï¼Œ</span></span><br><span class="line"><span class="comment"># å¯ç”¨äºå¤„ç†æ–‡ä»¶å’Œç›®å½•è·¯å¾„ã€åˆ›å»º/åˆ é™¤ç›®å½•ã€è·å–ç¯å¢ƒå˜é‡ç­‰ï¼Œ</span></span><br><span class="line"><span class="comment"># åœ¨æœ¬ä»£ç é‡Œä¸»è¦ç”¨äºæ„å»ºæ–‡ä»¶å’Œç›®å½•çš„è·¯å¾„ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="comment"># torch æ˜¯ PyTorch çš„æ ¸å¿ƒåº“ï¼Œæä¾›äº†å¼ é‡ï¼ˆTensorï¼‰æ•°æ®ç»“æ„ï¼Œ</span></span><br><span class="line"><span class="comment"># æ”¯æŒè‡ªåŠ¨æ±‚å¯¼æœºåˆ¶ï¼Œç”¨äºæ„å»ºå’Œè®­ç»ƒæ·±åº¦å­¦ä¹ æ¨¡å‹ï¼Œ</span></span><br><span class="line"><span class="comment"># èƒ½å¤Ÿåœ¨ CPU æˆ– GPU ä¸Šé«˜æ•ˆåœ°è¿›è¡Œæ•°å€¼è®¡ç®—ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"><span class="comment"># torch.nn.functional æä¾›äº†è®¸å¤šç¥ç»ç½‘ç»œä¸­å¸¸ç”¨çš„å‡½æ•°ï¼Œ</span></span><br><span class="line"><span class="comment"># ä¾‹å¦‚æ¿€æ´»å‡½æ•°ã€æŸå¤±å‡½æ•°ã€å·ç§¯ã€æ± åŒ–ç­‰æ“ä½œï¼Œ</span></span><br><span class="line"><span class="comment"># è¿™äº›å‡½æ•°æ˜¯æ— çŠ¶æ€çš„ï¼Œé€šå¸¸ç”¨äºè‡ªå®šä¹‰ç¥ç»ç½‘ç»œå±‚ä¸­çš„å…·ä½“è¿ç®—ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="comment"># numpy æ˜¯ Python ä¸­ç”¨äºç§‘å­¦è®¡ç®—çš„åŸºç¡€åº“ï¼Œ</span></span><br><span class="line"><span class="comment"># æä¾›äº†é«˜æ•ˆçš„å¤šç»´æ•°ç»„å¯¹è±¡å’Œå„ç§æ•°å­¦å‡½æ•°ï¼Œ</span></span><br><span class="line"><span class="comment"># å¯è¿›è¡Œæ•°ç»„æ“ä½œã€çº¿æ€§ä»£æ•°è¿ç®—ã€éšæœºæ•°ç”Ÿæˆç­‰ï¼Œ</span></span><br><span class="line"><span class="comment"># åœ¨ä»£ç ä¸­ä¸»è¦ç”¨äºå¤„ç†å›¾åƒæ•°æ®å’Œæ•°ç»„æ“ä½œã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="comment"># tqdm æ˜¯ä¸€ä¸ªå¿«é€Ÿã€å¯æ‰©å±•çš„è¿›åº¦æ¡å·¥å…·ï¼Œ</span></span><br><span class="line"><span class="comment"># èƒ½åœ¨å¾ªç¯ä¸­æ˜¾ç¤ºè¿›åº¦æ¡ï¼Œæ–¹ä¾¿ç”¨æˆ·äº†è§£ä»£ç æ‰§è¡Œçš„è¿›åº¦ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> imageio</span><br><span class="line"><span class="comment"># imageio æ˜¯ä¸€ä¸ªç”¨äºè¯»å–å’Œå†™å…¥å¤šç§å›¾åƒæ–‡ä»¶æ ¼å¼çš„åº“ï¼Œ</span></span><br><span class="line"><span class="comment"># åœ¨ä»£ç ä¸­ä¸»è¦ç”¨äºè¯»å–å›¾åƒæ–‡ä»¶ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> utils.comp_ray_dir <span class="keyword">import</span> comp_ray_dir_cam</span><br><span class="line"><span class="comment"># ä» utils åŒ…ä¸­çš„ comp_ray_dir æ¨¡å—å¯¼å…¥ comp_ray_dir_cam å‡½æ•°ï¼Œ</span></span><br><span class="line"><span class="comment"># æ¨æµ‹è¯¥å‡½æ•°ç”¨äºè®¡ç®—ç›¸æœºåæ ‡ç³»ä¸‹çš„å…‰çº¿æ–¹å‘ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> utils.pose_utils <span class="keyword">import</span> center_poses</span><br><span class="line"><span class="comment"># ä» utils åŒ…ä¸­çš„ pose_utils æ¨¡å—å¯¼å…¥ center_poses å‡½æ•°ï¼Œ</span></span><br><span class="line"><span class="comment"># æ¨æµ‹è¯¥å‡½æ•°ç”¨äºå¯¹ç›¸æœºä½å§¿è¿›è¡Œä¸­å¿ƒåŒ–å¤„ç†ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> utils.lie_group_helper <span class="keyword">import</span> convert3x4_4x4</span><br><span class="line"><span class="comment"># ä» utils åŒ…ä¸­çš„ lie_group_helper æ¨¡å—å¯¼å…¥ convert3x4_4x4 å‡½æ•°ï¼Œ</span></span><br><span class="line"><span class="comment"># æ¨æµ‹è¯¥å‡½æ•°ç”¨äºå°† 3x4 çš„ç›¸æœºä½å§¿çŸ©é˜µè½¬æ¢ä¸º 4x4 çš„é½æ¬¡çŸ©é˜µã€‚</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">resize_imgs</span>(<span class="params">imgs, new_h, new_w</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    :param imgs:    (N, H, W, 3)            torch.float32 æ ¼å¼çš„ RGB å›¾åƒ</span></span><br><span class="line"><span class="string">    :param new_h:   æ•´æ•°æˆ– torch æ•´æ•°ç±»å‹ï¼Œè¡¨ç¤ºæ–°çš„å›¾åƒé«˜åº¦</span></span><br><span class="line"><span class="string">    :param new_w:   æ•´æ•°æˆ– torch æ•´æ•°ç±»å‹ï¼Œè¡¨ç¤ºæ–°çš„å›¾åƒå®½åº¦</span></span><br><span class="line"><span class="string">    :return:        (N, new_H, new_W, 3)    torch.float32 æ ¼å¼çš„ RGB å›¾åƒ</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># å°†å›¾åƒå¼ é‡çš„ç»´åº¦ä» (N, H, W, 3) è°ƒæ•´ä¸º (N, 3, H, W)ï¼Œä»¥é€‚é… F.interpolate å‡½æ•°çš„è¾“å…¥è¦æ±‚</span></span><br><span class="line">    imgs = imgs.permute(<span class="number">0</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">2</span>)  <span class="comment"># å˜ä¸º (N, 3, H, W)</span></span><br><span class="line">    <span class="comment"># ä½¿ç”¨åŒçº¿æ€§æ’å€¼æ–¹æ³•å°†å›¾åƒè°ƒæ•´åˆ°æŒ‡å®šçš„æ–°é«˜åº¦å’Œæ–°å®½åº¦</span></span><br><span class="line">    imgs = F.interpolate(imgs, size=(new_h, new_w), mode=<span class="string">&#x27;bilinear&#x27;</span>)  <span class="comment"># å˜ä¸º (N, 3, new_H, new_W)</span></span><br><span class="line">    <span class="comment"># å°†å›¾åƒå¼ é‡çš„ç»´åº¦ä» (N, 3, new_H, new_W) è°ƒæ•´å› (N, new_H, new_W, 3)</span></span><br><span class="line">    imgs = imgs.permute(<span class="number">0</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>)  <span class="comment"># å˜ä¸º (N, new_H, new_W, 3)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> imgs  <span class="comment"># è¿”å› (N, new_H, new_W, 3) æ ¼å¼çš„ torch.float32 ç±»å‹ RGB å›¾åƒ</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_imgs</span>(<span class="params">image_dir, img_ids, new_h, new_w</span>):</span><br><span class="line">    <span class="comment"># è·å–å›¾åƒç›®å½•ä¸‹æ‰€æœ‰å›¾åƒæ–‡ä»¶åï¼Œå¹¶æŒ‰å­—æ¯é¡ºåºæ’åº</span></span><br><span class="line">    img_names = np.array(<span class="built_in">sorted</span>(os.listdir(image_dir)))  <span class="comment"># å¾—åˆ°æ‰€æœ‰å›¾åƒæ–‡ä»¶å</span></span><br><span class="line">    <span class="comment"># æ ¹æ®ç»™å®šçš„å›¾åƒç´¢å¼•ç­›é€‰å‡ºæœ¬æ¬¡éœ€è¦çš„å›¾åƒæ–‡ä»¶å</span></span><br><span class="line">    img_names = img_names[img_ids]  <span class="comment"># å¾—åˆ°æœ¬æ¬¡åˆ†å‰²æ‰€éœ€çš„å›¾åƒæ–‡ä»¶å</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ„å»ºæ¯ä¸ªå›¾åƒçš„å®Œæ•´è·¯å¾„</span></span><br><span class="line">    img_paths = [os.path.join(image_dir, n) <span class="keyword">for</span> n <span class="keyword">in</span> img_names]</span><br><span class="line"></span><br><span class="line">    img_list = []</span><br><span class="line">    <span class="comment"># ä½¿ç”¨ tqdm æ˜¾ç¤ºåŠ è½½å›¾åƒçš„è¿›åº¦</span></span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> tqdm(img_paths):</span><br><span class="line">        <span class="comment"># è¯»å–å›¾åƒå¹¶åªä¿ç•™å‰ä¸‰ä¸ªé€šé“ï¼ˆRGBï¼‰</span></span><br><span class="line">        img = imageio.imread(p)[:, :, :<span class="number">3</span>]  <span class="comment"># å¾—åˆ° (H, W, 3) æ ¼å¼çš„ np.uint8 ç±»å‹å›¾åƒ</span></span><br><span class="line">        img_list.append(img)</span><br><span class="line">    <span class="comment"># å°†å›¾åƒåˆ—è¡¨è½¬æ¢ä¸º numpy æ•°ç»„</span></span><br><span class="line">    img_list = np.stack(img_list)  <span class="comment"># å˜ä¸º (N, H, W, 3) æ ¼å¼</span></span><br><span class="line">    <span class="comment"># å°† numpy æ•°ç»„è½¬æ¢ä¸º PyTorch å¼ é‡ï¼Œå¹¶å°†åƒç´ å€¼å½’ä¸€åŒ–åˆ° [0, 1] èŒƒå›´</span></span><br><span class="line">    img_list = torch.from_numpy(img_list).<span class="built_in">float</span>() / <span class="number">255</span>  <span class="comment"># å˜ä¸º (N, H, W, 3) æ ¼å¼çš„ torch.float32 ç±»å‹</span></span><br><span class="line">    <span class="comment"># è°ƒç”¨ resize_imgs å‡½æ•°å°†å›¾åƒè°ƒæ•´åˆ°æŒ‡å®šçš„æ–°é«˜åº¦å’Œæ–°å®½åº¦</span></span><br><span class="line">    img_list = resize_imgs(img_list, new_h, new_w)</span><br><span class="line">    <span class="keyword">return</span> img_list, img_names</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_meta</span>(<span class="params">in_dir, use_ndc</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    è¯»å–ç”± LLFF çš„ imgs2poses.py ç”Ÿæˆçš„ poses_bounds.npy æ–‡ä»¶ã€‚</span></span><br><span class="line"><span class="string">    æ­¤å‡½æ•°æ”¹ç¼–è‡ª https://github.com/kwea123/nerf_plã€‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># åŠ è½½ poses_bounds.npy æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶åŒ…å«ç›¸æœºä½å§¿å’Œæ·±åº¦è¾¹ç•Œä¿¡æ¯</span></span><br><span class="line">    poses_bounds = np.load(os.path.join(in_dir, <span class="string">&#x27;poses_bounds.npy&#x27;</span>))  <span class="comment"># å¾—åˆ° (N_images, 17) æ ¼å¼çš„æ•°ç»„</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># æå–ç›¸æœºä½å§¿ä¿¡æ¯ï¼Œå°†å…¶é‡å¡‘ä¸º (N_images, 3, 5) çš„å½¢çŠ¶</span></span><br><span class="line">    c2ws = poses_bounds[:, :<span class="number">15</span>].reshape(-<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>)  <span class="comment"># å˜ä¸º (N_images, 3, 5) æ ¼å¼</span></span><br><span class="line">    <span class="comment"># æå–æ·±åº¦è¾¹ç•Œä¿¡æ¯</span></span><br><span class="line">    bounds = poses_bounds[:, -<span class="number">2</span>:]  <span class="comment"># å˜ä¸º (N_images, 2) æ ¼å¼</span></span><br><span class="line">    <span class="comment"># æå–å›¾åƒé«˜åº¦ã€å®½åº¦å’Œç„¦è·ä¿¡æ¯</span></span><br><span class="line">    H, W, focal = c2ws[<span class="number">0</span>, :, -<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä¿®æ­£ç›¸æœºä½å§¿çš„æ—‹è½¬éƒ¨åˆ†ï¼Œå°†æ—‹è½¬å½¢å¼ä» &quot;ä¸‹ å³ å&quot; æ”¹ä¸º &quot;å³ ä¸Š å&quot;</span></span><br><span class="line">    <span class="comment"># å‚è€ƒ https://github.com/bmild/nerf/issues/34</span></span><br><span class="line">    c2ws = np.concatenate([c2ws[..., <span class="number">1</span>:<span class="number">2</span>], -c2ws[..., :<span class="number">1</span>], c2ws[..., <span class="number">2</span>:<span class="number">4</span>]], -<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¯¹ç›¸æœºä½å§¿è¿›è¡Œä¸­å¿ƒåŒ–å¤„ç†ï¼Œè¿”å›ä¸­å¿ƒåŒ–åçš„ç›¸æœºä½å§¿å’Œå¹³å‡ä½å§¿</span></span><br><span class="line">    <span class="comment"># pose_avg @ c2ws å¾—åˆ°ä¸­å¿ƒåŒ–åçš„ c2ws</span></span><br><span class="line">    c2ws, pose_avg = center_poses(c2ws)  <span class="comment"># åˆ†åˆ«å¾—åˆ° (N_images, 3, 4) å’Œ (4, 4) æ ¼å¼çš„æ•°ç»„</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> use_ndc:</span><br><span class="line">        <span class="comment"># è·å–æœ€è¿‘æ·±åº¦å€¼</span></span><br><span class="line">        near_original = bounds.<span class="built_in">min</span>()</span><br><span class="line">        <span class="comment"># è®¡ç®—ç¼©æ”¾å› å­ï¼Œä½¿æœ€è¿‘æ·±åº¦è°ƒæ•´åˆ°ç¨å¤§äº 1.0 çš„ä½ç½®</span></span><br><span class="line">        scale_factor = near_original * <span class="number">0.75</span>  <span class="comment"># 0.75 æ˜¯é»˜è®¤å‚æ•°</span></span><br><span class="line">        <span class="comment"># ç°åœ¨æœ€è¿‘æ·±åº¦çº¦ä¸º 1/0.75 = 1.33</span></span><br><span class="line">        <span class="comment"># å¯¹æ·±åº¦è¾¹ç•Œè¿›è¡Œç¼©æ”¾</span></span><br><span class="line">        bounds /= scale_factor</span><br><span class="line">        <span class="comment"># å¯¹ç›¸æœºä½å§¿çš„å¹³ç§»éƒ¨åˆ†è¿›è¡Œç¼©æ”¾</span></span><br><span class="line">        c2ws[..., <span class="number">3</span>] /= scale_factor</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å°† 3x4 çš„ç›¸æœºä½å§¿çŸ©é˜µè½¬æ¢ä¸º 4x4 çš„é½æ¬¡çŸ©é˜µå½¢å¼</span></span><br><span class="line">    c2ws = convert3x4_4x4(c2ws)  <span class="comment"># å˜ä¸º (N, 4, 4) æ ¼å¼</span></span><br><span class="line"></span><br><span class="line">    results = &#123;</span><br><span class="line">        <span class="string">&#x27;c2ws&#x27;</span>: c2ws,       <span class="comment"># (N, 4, 4) æ ¼å¼çš„ numpy æ•°ç»„</span></span><br><span class="line">        <span class="string">&#x27;bounds&#x27;</span>: bounds,   <span class="comment"># (N_images, 2) æ ¼å¼çš„ numpy æ•°ç»„</span></span><br><span class="line">        <span class="string">&#x27;H&#x27;</span>: <span class="built_in">int</span>(H),        <span class="comment"># æ ‡é‡ï¼Œå›¾åƒé«˜åº¦</span></span><br><span class="line">        <span class="string">&#x27;W&#x27;</span>: <span class="built_in">int</span>(W),        <span class="comment"># æ ‡é‡ï¼Œå›¾åƒå®½åº¦</span></span><br><span class="line">        <span class="string">&#x27;focal&#x27;</span>: focal,     <span class="comment"># æ ‡é‡ï¼Œç„¦è·</span></span><br><span class="line">        <span class="string">&#x27;pose_avg&#x27;</span>: pose_avg,  <span class="comment"># (4, 4) æ ¼å¼çš„ numpy æ•°ç»„</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DataLoaderWithCOLMAP</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    æœ€æœ‰ç”¨çš„å­—æ®µï¼š</span></span><br><span class="line"><span class="string">        self.c2ws:          (N_imgs, 4, 4) æ ¼å¼çš„ torch.float32 ç±»å‹å¼ é‡ï¼Œè¡¨ç¤ºç›¸æœºä½å§¿</span></span><br><span class="line"><span class="string">        self.imgs           (N_imgs, H, W, 4) æ ¼å¼çš„ torch.float32 ç±»å‹å¼ é‡ï¼Œè¡¨ç¤ºå›¾åƒ</span></span><br><span class="line"><span class="string">        self.ray_dir_cam    (H, W, 3) æ ¼å¼çš„ torch.float32 ç±»å‹å¼ é‡ï¼Œè¡¨ç¤ºç›¸æœºåæ ‡ç³»ä¸‹çš„å…‰çº¿æ–¹å‘</span></span><br><span class="line"><span class="string">        self.H              æ ‡é‡ï¼Œå›¾åƒé«˜åº¦</span></span><br><span class="line"><span class="string">        self.W              æ ‡é‡ï¼Œå›¾åƒå®½åº¦</span></span><br><span class="line"><span class="string">        self.N_imgs         æ ‡é‡ï¼Œå›¾åƒæ•°é‡</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, base_dir, scene_name, data_type, res_ratio, num_img_to_load, skip, use_ndc, load_img=<span class="literal">True</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        :param base_dir: æ•°æ®çš„åŸºç¡€ç›®å½•</span></span><br><span class="line"><span class="string">        :param scene_name: åœºæ™¯çš„åç§°</span></span><br><span class="line"><span class="string">        :param data_type: æ•°æ®ç±»å‹ï¼Œ&#x27;train&#x27; æˆ– &#x27;val&#x27;ã€‚</span></span><br><span class="line"><span class="string">        :param res_ratio: æ•´æ•°ï¼Œå¦‚ [1, 2, 4] ç­‰ï¼Œç”¨äºå°†å›¾åƒè°ƒæ•´ä¸ºè¾ƒä½çš„åˆ†è¾¨ç‡ã€‚</span></span><br><span class="line"><span class="string">        :param num_img_to_load/skip: ç”¨äºåœ¨æ—¶é—´åŸŸä¸Šæ§åˆ¶å¸§çš„åŠ è½½ã€‚</span></span><br><span class="line"><span class="string">        :param use_ndc: å¸ƒå°”å€¼ï¼Œæ˜¯å¦å¯¹ç›¸æœºä½å§¿è¿›è¡Œä¸­å¿ƒåŒ–å’Œç¼©æ”¾ã€‚</span></span><br><span class="line"><span class="string">        :param load_img: å¸ƒå°”å€¼ã€‚å¦‚æœè®¾ç½®ä¸º Falseï¼šä»…ç»Ÿè®¡å›¾åƒæ•°é‡ã€è·å–å›¾åƒçš„é«˜åº¦å’Œå®½åº¦ï¼Œ</span></span><br><span class="line"><span class="string">                         ä½†ä¸åŠ è½½å›¾åƒã€‚åœ¨å¯è§†åŒ–ä½å§¿æˆ–è°ƒè¯•ç­‰æƒ…å†µä¸‹å¾ˆæœ‰ç”¨ã€‚</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.base_dir = base_dir</span><br><span class="line">        <span class="variable language_">self</span>.scene_name = scene_name</span><br><span class="line">        <span class="variable language_">self</span>.data_type = data_type</span><br><span class="line">        <span class="variable language_">self</span>.res_ratio = res_ratio</span><br><span class="line">        <span class="variable language_">self</span>.num_img_to_load = num_img_to_load</span><br><span class="line">        <span class="variable language_">self</span>.skip = skip</span><br><span class="line">        <span class="variable language_">self</span>.use_ndc = use_ndc</span><br><span class="line">        <span class="variable language_">self</span>.load_img = load_img</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ„å»ºåœºæ™¯ç›®å½•çš„å®Œæ•´è·¯å¾„</span></span><br><span class="line">        <span class="variable language_">self</span>.scene_dir = os.path.join(<span class="variable language_">self</span>.base_dir, <span class="variable language_">self</span>.scene_name)</span><br><span class="line">        <span class="comment"># æ„å»ºå›¾åƒç›®å½•çš„å®Œæ•´è·¯å¾„</span></span><br><span class="line">        <span class="variable language_">self</span>.img_dir = os.path.join(<span class="variable language_">self</span>.scene_dir, <span class="string">&#x27;images&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è¯»å–æ‰€æœ‰çš„å…ƒä¿¡æ¯ï¼ŒåŒ…æ‹¬ç›¸æœºä½å§¿ã€æ·±åº¦è¾¹ç•Œã€å›¾åƒå°ºå¯¸å’Œç„¦è·ç­‰</span></span><br><span class="line">        meta = read_meta(<span class="variable language_">self</span>.scene_dir, <span class="variable language_">self</span>.use_ndc)</span><br><span class="line">        <span class="comment"># æå–ç›¸æœºä½å§¿ä¿¡æ¯</span></span><br><span class="line">        <span class="variable language_">self</span>.c2ws = meta[<span class="string">&#x27;c2ws&#x27;</span>]  <span class="comment"># (N, 4, 4) æ ¼å¼çš„ numpy æ•°ç»„ï¼Œè¡¨ç¤ºæ‰€æœ‰ç›¸æœºä½å§¿</span></span><br><span class="line">        <span class="comment"># æå–å›¾åƒé«˜åº¦ä¿¡æ¯</span></span><br><span class="line">        <span class="variable language_">self</span>.H = meta[<span class="string">&#x27;H&#x27;</span>]</span><br><span class="line">        <span class="comment"># æå–å›¾åƒå®½åº¦ä¿¡æ¯</span></span><br><span class="line">        <span class="variable language_">self</span>.W = meta[<span class="string">&#x27;W&#x27;</span>]</span><br><span class="line">        <span class="comment"># æå–ç„¦è·ä¿¡æ¯</span></span><br><span class="line">        <span class="variable language_">self</span>.focal = <span class="built_in">float</span>(meta[<span class="string">&#x27;focal&#x27;</span>])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.res_ratio &gt; <span class="number">1</span>:</span><br><span class="line">            <span class="comment"># å¦‚æœéœ€è¦è°ƒæ•´å›¾åƒåˆ†è¾¨ç‡ï¼Œå¯¹å›¾åƒé«˜åº¦è¿›è¡Œç›¸åº”çš„ç¼©æ”¾</span></span><br><span class="line">            <span class="variable language_">self</span>.H = <span class="variable language_">self</span>.H // <span class="variable language_">self</span>.res_ratio</span><br><span class="line">            <span class="comment"># å¦‚æœéœ€è¦è°ƒæ•´å›¾åƒåˆ†è¾¨ç‡ï¼Œå¯¹å›¾åƒå®½åº¦è¿›è¡Œç›¸åº”çš„ç¼©æ”¾</span></span><br><span class="line">            <span class="variable language_">self</span>.W = <span class="variable language_">self</span>.W // <span class="variable language_">self</span>.res_ratio</span><br><span class="line">            <span class="comment"># å¦‚æœéœ€è¦è°ƒæ•´å›¾åƒåˆ†è¾¨ç‡ï¼Œå¯¹ç„¦è·è¿›è¡Œç›¸åº”çš„ç¼©æ”¾</span></span><br><span class="line">            <span class="variable language_">self</span>.focal /= <span class="variable language_">self</span>.res_ratio</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è¿‘è£å‰ªå¹³é¢è·ç¦»</span></span><br><span class="line">        <span class="variable language_">self</span>.near = <span class="number">0.0</span></span><br><span class="line">        <span class="comment"># è¿œè£å‰ªå¹³é¢è·ç¦»</span></span><br><span class="line">        <span class="variable language_">self</span>.far = <span class="number">1.0</span></span><br><span class="line">        <span class="comment"># åŠ è½½å›¾åƒå¹¶è°ƒæ•´åˆ°æŒ‡å®šçš„é«˜åº¦å’Œå®½åº¦</span></span><br><span class="line">        <span class="variable language_">self</span>.imgs, <span class="variable language_">self</span>.img_names = load_imgs(<span class="variable language_">self</span>.img_dir, np.arange(num_img_to_load), <span class="variable language_">self</span>.H, <span class="variable language_">self</span>.W)  <span class="comment"># (N, H, W, 3) æ ¼å¼çš„ torch.float32 ç±»å‹å¼ é‡</span></span><br><span class="line">        <span class="comment"># æˆªå–å‰ num_img_to_load ä¸ªç›¸æœºä½å§¿</span></span><br><span class="line">        <span class="variable language_">self</span>.c2ws = <span class="variable language_">self</span>.c2ws[:num_img_to_load]</span><br><span class="line">        <span class="comment"># å›¾åƒçš„æ•°é‡</span></span><br><span class="line">        <span class="variable language_">self</span>.N_imgs = <span class="variable language_">self</span>.c2ws.shape[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ç”Ÿæˆç›¸æœºåæ ‡ç³»ä¸‹çš„å…‰çº¿æ–¹å‘</span></span><br><span class="line">        <span class="variable language_">self</span>.ray_dir_cam = comp_ray_dir_cam(<span class="variable language_">self</span>.H, <span class="variable language_">self</span>.W, <span class="variable language_">self</span>.focal)  <span class="comment"># (H, W, 3) æ ¼å¼çš„ torch.float32 ç±»å‹å¼ é‡</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># å°†ç›¸æœºä½å§¿ä» numpy æ•°ç»„è½¬æ¢ä¸º PyTorch å¼ é‡</span></span><br><span class="line">        <span class="variable language_">self</span>.c2ws = torch.from_numpy(<span class="variable language_">self</span>.c2ws).<span class="built_in">float</span>()  <span class="comment"># (N, 4, 4) æ ¼å¼çš„ torch.float32 ç±»å‹å¼ é‡</span></span><br><span class="line">        <span class="comment"># å°†å…‰çº¿æ–¹å‘å¼ é‡è½¬æ¢ä¸º float32 ç±»å‹</span></span><br><span class="line">        <span class="variable language_">self</span>.ray_dir_cam = <span class="variable language_">self</span>.ray_dir_cam.<span class="built_in">float</span>()  <span class="comment"># (H, W, 3) æ ¼å¼çš„ torch.float32 ç±»å‹å¼ é‡</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    scene_name = <span class="string">&#x27;LLFF/fern&#x27;</span></span><br><span class="line">    use_ndc = <span class="literal">True</span></span><br><span class="line">    <span class="comment"># æ³¨æ„ï¼šéœ€è¦å°† /your/data/path æ›¿æ¢ä¸ºå®é™…çš„æ•°æ®è·¯å¾„ï¼Œ</span></span><br><span class="line">    <span class="comment"># è¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ª DataLoaderWithCOLMAP ç±»çš„å®ä¾‹ï¼Œç”¨äºåŠ è½½æŒ‡å®šåœºæ™¯çš„æ•°æ®</span></span><br><span class="line">    scene = DataLoaderWithCOLMAP(base_dir=<span class="string">&#x27;/your/data/path&#x27;</span>,</span><br><span class="line">                                 scene_name=scene_name,</span><br><span class="line">                                 data_type=<span class="string">&#x27;train&#x27;</span>,</span><br><span class="line">                                 res_ratio=<span class="number">8</span>,</span><br><span class="line">                                 num_img_to_load=-<span class="number">1</span>,</span><br><span class="line">                                 skip=<span class="number">1</span>,</span><br><span class="line">                                 use_ndc=use_ndc)</span><br></pre></td></tr></table></figure>



<h4 id="with-mask-py"><a href="#with-mask-py" class="headerlink" title="with_mask.py"></a>with_mask.py</h4><p>ä»–ä»¬çš„maskå…¶å®æ˜¯æ©ç æ–‡ä»¶ï¼Œæœ‰æ²¡æœ‰å¯èƒ½åªåŸºäºæ©ç æ–‡ä»¶å»åšå‘¢ï¼Ÿ</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="comment"># os æ¨¡å—æä¾›äº†ä¸æ“ä½œç³»ç»Ÿè¿›è¡Œäº¤äº’çš„åŠŸèƒ½ï¼Œ</span></span><br><span class="line"><span class="comment"># å¯ç”¨äºå¤„ç†æ–‡ä»¶å’Œç›®å½•è·¯å¾„ã€åˆ›å»º/åˆ é™¤ç›®å½•ã€è·å–ç¯å¢ƒå˜é‡ç­‰ï¼Œ</span></span><br><span class="line"><span class="comment"># åœ¨æœ¬ä»£ç é‡Œä¸»è¦ç”¨äºæ„å»ºæ–‡ä»¶å’Œç›®å½•çš„è·¯å¾„ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="comment"># torch æ˜¯ PyTorch çš„æ ¸å¿ƒåº“ï¼Œæä¾›äº†å¼ é‡ï¼ˆTensorï¼‰æ•°æ®ç»“æ„ï¼Œ</span></span><br><span class="line"><span class="comment"># æ”¯æŒè‡ªåŠ¨æ±‚å¯¼æœºåˆ¶ï¼Œç”¨äºæ„å»ºå’Œè®­ç»ƒæ·±åº¦å­¦ä¹ æ¨¡å‹ï¼Œ</span></span><br><span class="line"><span class="comment"># èƒ½å¤Ÿåœ¨ CPU æˆ– GPU ä¸Šé«˜æ•ˆåœ°è¿›è¡Œæ•°å€¼è®¡ç®—ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="comment"># numpy æ˜¯ Python ä¸­ç”¨äºç§‘å­¦è®¡ç®—çš„åŸºç¡€åº“ï¼Œ</span></span><br><span class="line"><span class="comment"># æä¾›äº†é«˜æ•ˆçš„å¤šç»´æ•°ç»„å¯¹è±¡å’Œå„ç§æ•°å­¦å‡½æ•°ï¼Œ</span></span><br><span class="line"><span class="comment"># å¯è¿›è¡Œæ•°ç»„æ“ä½œã€çº¿æ€§ä»£æ•°è¿ç®—ã€éšæœºæ•°ç”Ÿæˆç­‰ï¼Œ</span></span><br><span class="line"><span class="comment"># åœ¨ä»£ç ä¸­ä¸»è¦ç”¨äºå¤„ç†å›¾åƒæ•°æ®å’Œæ•°ç»„æ“ä½œã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="comment"># tqdm æ˜¯ä¸€ä¸ªå¿«é€Ÿã€å¯æ‰©å±•çš„è¿›åº¦æ¡å·¥å…·ï¼Œ</span></span><br><span class="line"><span class="comment"># èƒ½åœ¨å¾ªç¯ä¸­æ˜¾ç¤ºè¿›åº¦æ¡ï¼Œæ–¹ä¾¿ç”¨æˆ·äº†è§£ä»£ç æ‰§è¡Œçš„è¿›åº¦ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> imageio</span><br><span class="line"><span class="comment"># imageio æ˜¯ä¸€ä¸ªç”¨äºè¯»å–å’Œå†™å…¥å¤šç§å›¾åƒæ–‡ä»¶æ ¼å¼çš„åº“ï¼Œ</span></span><br><span class="line"><span class="comment"># åœ¨ä»£ç ä¸­ä¸»è¦ç”¨äºè¯»å–å›¾åƒæ–‡ä»¶ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> dataloader.with_colmap <span class="keyword">import</span> resize_imgs</span><br><span class="line"><span class="comment"># ä» dataloader.with_colmap æ¨¡å—å¯¼å…¥ resize_imgs å‡½æ•°ï¼Œ</span></span><br><span class="line"><span class="comment"># è¯¥å‡½æ•°ç”¨äºè°ƒæ•´å›¾åƒçš„å°ºå¯¸ã€‚</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_imgs</span>(<span class="params">image_dir, mask_dir, num_img_to_load, start, end, skip, load_sorted, load_img</span>):</span><br><span class="line">    <span class="comment"># è·å–å›¾åƒç›®å½•ä¸‹æ‰€æœ‰å›¾åƒæ–‡ä»¶åï¼Œå¹¶æŒ‰å­—æ¯é¡ºåºæ’åº</span></span><br><span class="line">    img_names = np.array(<span class="built_in">sorted</span>(os.listdir(image_dir)))  <span class="comment"># all image names</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># åœ¨æ—¶é—´åŸŸä¸Šå¯¹å¸§è¿›è¡Œä¸‹é‡‡æ ·</span></span><br><span class="line">    <span class="keyword">if</span> end == -<span class="number">1</span> <span class="keyword">and</span> <span class="built_in">len</span>(os.listdir(mask_dir)) == <span class="built_in">len</span>(img_names):</span><br><span class="line">        <span class="comment"># è‹¥ end ä¸º -1 ä¸”æ©ç ç›®å½•å’Œå›¾åƒç›®å½•æ–‡ä»¶æ•°é‡ç›¸åŒï¼Œåˆ™æŒ‰ skip é—´éš”é€‰å–</span></span><br><span class="line">        img_names = img_names[start::skip]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># å– end å’Œæ©ç ç›®å½•æ–‡ä»¶æ•°é‡çš„æœ€å°å€¼ï¼Œé¿å…è¶Šç•Œ</span></span><br><span class="line">        end = <span class="built_in">min</span>(end, <span class="built_in">len</span>(os.listdir(mask_dir)))</span><br><span class="line">        img_names = img_names[start:end:skip]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¦‚æœä¸æŒ‰é¡ºåºåŠ è½½å›¾åƒï¼Œåˆ™å¯¹å›¾åƒæ–‡ä»¶åè¿›è¡Œéšæœºæ‰“ä¹±</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> load_sorted:</span><br><span class="line">        np.random.shuffle(img_names)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># åŠ è½½ä¸‹é‡‡æ ·åçš„å›¾åƒ</span></span><br><span class="line">    <span class="keyword">if</span> num_img_to_load &gt; <span class="built_in">len</span>(img_names):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Asked for &#123;0:6d&#125; images but only &#123;1:6d&#125; available. Exit.&#x27;</span>.<span class="built_in">format</span>(num_img_to_load, <span class="built_in">len</span>(img_names)))</span><br><span class="line">        exit()</span><br><span class="line">    <span class="keyword">elif</span> num_img_to_load == -<span class="number">1</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Loading all available &#123;0:6d&#125; images&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">len</span>(img_names)))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Loading &#123;0:6d&#125; images out of &#123;1:6d&#125; images.&#x27;</span>.<span class="built_in">format</span>(num_img_to_load, <span class="built_in">len</span>(img_names)))</span><br><span class="line">        img_names = img_names[:num_img_to_load]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ„å»ºæ¯ä¸ªå›¾åƒçš„å®Œæ•´è·¯å¾„</span></span><br><span class="line">    img_paths = [os.path.join(image_dir, n) <span class="keyword">for</span> n <span class="keyword">in</span> img_names]</span><br><span class="line">    <span class="comment"># æ„å»ºæ¯ä¸ªæ©ç å›¾åƒçš„å®Œæ•´è·¯å¾„ï¼Œå‡è®¾æ©ç å›¾åƒä¸º png æ ¼å¼ï¼Œä¸”æ–‡ä»¶åå’Œå›¾åƒæ–‡ä»¶åå¯¹åº”</span></span><br><span class="line">    mask_paths = [os.path.join(mask_dir, n[:-<span class="number">4</span>]+<span class="string">&#x27;.png&#x27;</span>) <span class="keyword">for</span> n <span class="keyword">in</span> img_names]</span><br><span class="line">    <span class="comment"># å›¾åƒçš„æ•°é‡</span></span><br><span class="line">    N_imgs = <span class="built_in">len</span>(img_paths)</span><br><span class="line"></span><br><span class="line">    img_list, mask_list = [], []</span><br><span class="line">    <span class="keyword">if</span> load_img:</span><br><span class="line">        <span class="comment"># ä½¿ç”¨ tqdm æ˜¾ç¤ºåŠ è½½å›¾åƒçš„è¿›åº¦</span></span><br><span class="line">        <span class="keyword">for</span> i, p <span class="keyword">in</span> tqdm(<span class="built_in">enumerate</span>(img_paths)):</span><br><span class="line">            <span class="comment"># è¯»å–å›¾åƒå¹¶åªä¿ç•™å‰ä¸‰ä¸ªé€šé“ï¼ˆRGBï¼‰</span></span><br><span class="line">            img = imageio.imread(p)[:, :, :<span class="number">3</span>]  <span class="comment"># (H, W, 3) np.uint8</span></span><br><span class="line">            img_list.append(img)</span><br><span class="line">            <span class="comment"># è¯»å–å¯¹åº”çš„æ©ç å›¾åƒï¼Œåªå–ç¬¬ä¸€ä¸ªé€šé“</span></span><br><span class="line">            img = imageio.imread(mask_paths[i])[:, :, [<span class="number">0</span>]]  <span class="comment"># (H, W, 1)</span></span><br><span class="line">            mask_list.append(img)</span><br><span class="line">        <span class="comment"># å°†å›¾åƒåˆ—è¡¨è½¬æ¢ä¸º numpy æ•°ç»„</span></span><br><span class="line">        img_list = np.stack(img_list)  <span class="comment"># (N, H, W, 3)</span></span><br><span class="line">        <span class="comment"># å°†æ©ç åˆ—è¡¨è½¬æ¢ä¸º numpy æ•°ç»„</span></span><br><span class="line">        mask_list = np.stack(mask_list)</span><br><span class="line">        <span class="comment"># å°† numpy æ•°ç»„è½¬æ¢ä¸º PyTorch å¼ é‡ï¼Œå¹¶å°†åƒç´ å€¼å½’ä¸€åŒ–åˆ° [0, 1] èŒƒå›´</span></span><br><span class="line">        img_list = torch.from_numpy(img_list).<span class="built_in">float</span>() / <span class="number">255</span>  <span class="comment"># (N, H, W, 3) torch.float32</span></span><br><span class="line">        mask_list = torch.from_numpy(mask_list).<span class="built_in">float</span>() / <span class="number">255</span></span><br><span class="line">        <span class="comment"># è·å–å›¾åƒçš„é«˜åº¦å’Œå®½åº¦</span></span><br><span class="line">        H, W = img_list.shape[<span class="number">1</span>], img_list.shape[<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># å¦‚æœä¸åŠ è½½å›¾åƒï¼Œåˆ™è¯»å–ç¬¬ä¸€å¼ å›¾åƒä»¥è·å–å›¾åƒçš„é«˜åº¦å’Œå®½åº¦</span></span><br><span class="line">        tmp_img = imageio.imread(img_paths[<span class="number">0</span>])  <span class="comment"># load one image to get H, W</span></span><br><span class="line">        H, W = tmp_img.shape[<span class="number">0</span>], tmp_img.shape[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    results = &#123;</span><br><span class="line">        <span class="string">&#x27;imgs&#x27;</span>: img_list,  <span class="comment"># (N, H, W, 3) torch.float32</span></span><br><span class="line">        <span class="string">&#x27;img_names&#x27;</span>: img_names,  <span class="comment"># (N, )</span></span><br><span class="line">        <span class="string">&#x27;masks&#x27;</span>: mask_list,  <span class="comment"># æ©ç å›¾åƒå¼ é‡</span></span><br><span class="line">        <span class="string">&#x27;N_imgs&#x27;</span>: N_imgs,</span><br><span class="line">        <span class="string">&#x27;H&#x27;</span>: H,</span><br><span class="line">        <span class="string">&#x27;W&#x27;</span>: W,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DataLoaderAnyFolder</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Most useful fields:</span></span><br><span class="line"><span class="string">        self.c2ws:          (N_imgs, 4, 4)      torch.float32</span></span><br><span class="line"><span class="string">        self.imgs           (N_imgs, H, W, 4)   torch.float32</span></span><br><span class="line"><span class="string">        self.ray_dir_cam    (H, W, 3)           torch.float32</span></span><br><span class="line"><span class="string">        self.H              scalar</span></span><br><span class="line"><span class="string">        self.W              scalar</span></span><br><span class="line"><span class="string">        self.N_imgs         scalar</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, base_dir, scene_name, res_ratio, num_img_to_load, start, end, skip, load_sorted, load_img=<span class="literal">True</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        :param base_dir: æ•°æ®çš„åŸºç¡€ç›®å½•</span></span><br><span class="line"><span class="string">        :param scene_name: åœºæ™¯çš„åç§°</span></span><br><span class="line"><span class="string">        :param res_ratio: æ•´æ•°ï¼Œå¦‚ [1, 2, 4] ç­‰ï¼Œç”¨äºå°†å›¾åƒè°ƒæ•´ä¸ºè¾ƒä½çš„åˆ†è¾¨ç‡ã€‚</span></span><br><span class="line"><span class="string">        :param start/end/skip: ç”¨äºåœ¨æ—¶é—´åŸŸä¸Šæ§åˆ¶å¸§çš„åŠ è½½ã€‚</span></span><br><span class="line"><span class="string">        :param load_sorted: å¸ƒå°”å€¼ï¼Œæ˜¯å¦æŒ‰é¡ºåºåŠ è½½å›¾åƒã€‚</span></span><br><span class="line"><span class="string">        :param load_img: å¸ƒå°”å€¼ã€‚å¦‚æœè®¾ç½®ä¸º falseï¼šä»…ç»Ÿè®¡å›¾åƒæ•°é‡ã€è·å–å›¾åƒçš„é«˜åº¦å’Œå®½åº¦ï¼Œ</span></span><br><span class="line"><span class="string">                         ä½†ä¸åŠ è½½å›¾åƒã€‚åœ¨å¯è§†åŒ–ä½å§¿æˆ–è°ƒè¯•ç­‰æƒ…å†µä¸‹å¾ˆæœ‰ç”¨ã€‚</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.base_dir = base_dir</span><br><span class="line">        <span class="variable language_">self</span>.scene_name = scene_name</span><br><span class="line">        <span class="variable language_">self</span>.res_ratio = res_ratio</span><br><span class="line">        <span class="variable language_">self</span>.num_img_to_load = num_img_to_load</span><br><span class="line">        <span class="variable language_">self</span>.start = start</span><br><span class="line">        <span class="variable language_">self</span>.end = end</span><br><span class="line">        <span class="variable language_">self</span>.skip = skip</span><br><span class="line">        <span class="variable language_">self</span>.load_sorted = load_sorted</span><br><span class="line">        <span class="variable language_">self</span>.load_img = load_img</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ„å»ºå›¾åƒç›®å½•çš„å®Œæ•´è·¯å¾„</span></span><br><span class="line">        <span class="variable language_">self</span>.imgs_dir = os.path.join(<span class="variable language_">self</span>.base_dir, <span class="variable language_">self</span>.scene_name)</span><br><span class="line">        <span class="comment"># æ„å»ºæ©ç ç›®å½•çš„å®Œæ•´è·¯å¾„ï¼Œå‡è®¾æ©ç ç›®å½•åœ¨å›¾åƒç›®å½•çš„ä¸Šä¸€çº§çš„ mask æ–‡ä»¶å¤¹ä¸‹</span></span><br><span class="line">        <span class="variable language_">self</span>.mask_dir = os.path.join(<span class="variable language_">self</span>.imgs_dir, <span class="string">&#x27;../mask/&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è°ƒç”¨ load_imgs å‡½æ•°åŠ è½½å›¾åƒå’Œæ©ç æ•°æ®</span></span><br><span class="line">        image_data = load_imgs(<span class="variable language_">self</span>.imgs_dir, <span class="variable language_">self</span>.mask_dir, <span class="variable language_">self</span>.num_img_to_load, <span class="variable language_">self</span>.start, <span class="variable language_">self</span>.end, <span class="variable language_">self</span>.skip,</span><br><span class="line">                               <span class="variable language_">self</span>.load_sorted, <span class="variable language_">self</span>.load_img)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æå–åŠ è½½çš„å›¾åƒæ•°æ®</span></span><br><span class="line">        <span class="variable language_">self</span>.imgs = image_data[<span class="string">&#x27;imgs&#x27;</span>]  <span class="comment"># (N, H, W, 3) torch.float32</span></span><br><span class="line">        <span class="comment"># æå–å›¾åƒæ–‡ä»¶å</span></span><br><span class="line">        <span class="variable language_">self</span>.img_names = image_data[<span class="string">&#x27;img_names&#x27;</span>]  <span class="comment"># (N, )</span></span><br><span class="line">        <span class="comment"># æå–æ©ç æ•°æ®</span></span><br><span class="line">        <span class="variable language_">self</span>.masks = image_data[<span class="string">&#x27;masks&#x27;</span>]</span><br><span class="line">        <span class="comment"># å›¾åƒçš„æ•°é‡</span></span><br><span class="line">        <span class="variable language_">self</span>.N_imgs = image_data[<span class="string">&#x27;N_imgs&#x27;</span>]</span><br><span class="line">        <span class="comment"># åŸå§‹å›¾åƒçš„é«˜åº¦</span></span><br><span class="line">        <span class="variable language_">self</span>.ori_H = image_data[<span class="string">&#x27;H&#x27;</span>]</span><br><span class="line">        <span class="comment"># åŸå§‹å›¾åƒçš„å®½åº¦</span></span><br><span class="line">        <span class="variable language_">self</span>.ori_W = image_data[<span class="string">&#x27;W&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å§‹ç»ˆä½¿ç”¨å½’ä¸€åŒ–è®¾å¤‡åæ ‡ï¼ˆNDCï¼‰ï¼Œè®¾ç½®è¿‘è£å‰ªå¹³é¢è·ç¦»</span></span><br><span class="line">        <span class="variable language_">self</span>.near = <span class="number">0.0</span></span><br><span class="line">        <span class="comment"># å§‹ç»ˆä½¿ç”¨å½’ä¸€åŒ–è®¾å¤‡åæ ‡ï¼ˆNDCï¼‰ï¼Œè®¾ç½®è¿œè£å‰ªå¹³é¢è·ç¦»</span></span><br><span class="line">        <span class="variable language_">self</span>.far = <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># å¦‚æœéœ€è¦è°ƒæ•´å›¾åƒåˆ†è¾¨ç‡</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.res_ratio &gt; <span class="number">1</span>:</span><br><span class="line">            <span class="comment"># è®¡ç®—è°ƒæ•´åçš„å›¾åƒé«˜åº¦</span></span><br><span class="line">            <span class="variable language_">self</span>.H = <span class="variable language_">self</span>.ori_H // <span class="variable language_">self</span>.res_ratio</span><br><span class="line">            <span class="comment"># è®¡ç®—è°ƒæ•´åçš„å›¾åƒå®½åº¦</span></span><br><span class="line">            <span class="variable language_">self</span>.W = <span class="variable language_">self</span>.ori_W // <span class="variable language_">self</span>.res_ratio</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="variable language_">self</span>.H = <span class="variable language_">self</span>.ori_H</span><br><span class="line">            <span class="variable language_">self</span>.W = <span class="variable language_">self</span>.ori_W</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.load_img:</span><br><span class="line">            <span class="comment"># è°ƒæ•´å›¾åƒçš„åˆ†è¾¨ç‡</span></span><br><span class="line">            <span class="variable language_">self</span>.imgs = resize_imgs(<span class="variable language_">self</span>.imgs, <span class="variable language_">self</span>.H, <span class="variable language_">self</span>.W)  <span class="comment"># (N, H, W, 3) torch.float32</span></span><br><span class="line">            <span class="comment"># è°ƒæ•´æ©ç å›¾åƒçš„åˆ†è¾¨ç‡</span></span><br><span class="line">            <span class="variable language_">self</span>.masks = resize_imgs(<span class="variable language_">self</span>.masks, <span class="variable language_">self</span>.H, <span class="variable language_">self</span>.W)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># æ•°æ®çš„åŸºç¡€ç›®å½•ï¼Œéœ€è¦æ›¿æ¢ä¸ºå®é™…çš„è·¯å¾„</span></span><br><span class="line">    base_dir = <span class="string">&#x27;/your/data/path&#x27;</span></span><br><span class="line">    <span class="comment"># åœºæ™¯çš„åç§°</span></span><br><span class="line">    scene_name = <span class="string">&#x27;LLFF/fern/images&#x27;</span></span><br><span class="line">    <span class="comment"># å›¾åƒçš„ç¼©æ”¾æ¯”ä¾‹</span></span><br><span class="line">    resize_ratio = <span class="number">8</span></span><br><span class="line">    <span class="comment"># è¦åŠ è½½çš„å›¾åƒæ•°é‡ï¼Œ-1 è¡¨ç¤ºåŠ è½½æ‰€æœ‰å›¾åƒ</span></span><br><span class="line">    num_img_to_load = -<span class="number">1</span></span><br><span class="line">    <span class="comment"># å¼€å§‹åŠ è½½å›¾åƒçš„ç´¢å¼•</span></span><br><span class="line">    start = <span class="number">0</span></span><br><span class="line">    <span class="comment"># ç»“æŸåŠ è½½å›¾åƒçš„ç´¢å¼•ï¼Œ-1 è¡¨ç¤ºåŠ è½½åˆ°æœ€å</span></span><br><span class="line">    end = -<span class="number">1</span></span><br><span class="line">    <span class="comment"># åŠ è½½å›¾åƒçš„é—´éš”</span></span><br><span class="line">    skip = <span class="number">1</span></span><br><span class="line">    <span class="comment"># æ˜¯å¦æŒ‰é¡ºåºåŠ è½½å›¾åƒ</span></span><br><span class="line">    load_sorted = <span class="literal">True</span></span><br><span class="line">    <span class="comment"># æ˜¯å¦åŠ è½½å›¾åƒ</span></span><br><span class="line">    load_img = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># åˆå§‹åŒ– DataLoaderAnyFolder ç±»</span></span><br><span class="line">    scene = DataLoaderAnyFolder(base_dir=base_dir,</span><br><span class="line">                                scene_name=scene_name,</span><br><span class="line">                                res_ratio=resize_ratio,</span><br><span class="line">                                num_img_to_load=num_img_to_load,</span><br><span class="line">                                start=start,</span><br><span class="line">                                end=end,</span><br><span class="line">                                skip=skip,</span><br><span class="line">                                load_sorted=load_sorted,</span><br><span class="line">                                load_img=load_img)</span><br></pre></td></tr></table></figure>

<h3 id="models"><a href="#models" class="headerlink" title="models"></a>models</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">â”œâ”€â”€ models/  # æ¨¡å‹æ–‡ä»¶å¤¹</span><br><span class="line">â”‚   â”œâ”€â”€ depth_decoder.py  # æ·±åº¦è§£ç å™¨è„šæœ¬æ–‡ä»¶</span><br><span class="line">â”‚   â”œâ”€â”€ intrinsics.py  # å†…å‚ç›¸å…³è„šæœ¬æ–‡ä»¶</span><br><span class="line">â”‚   â”œâ”€â”€ layers.py  # å±‚ç›¸å…³è„šæœ¬æ–‡ä»¶</span><br><span class="line">â”‚   â”œâ”€â”€ nerf_feature.py  # NeRFç‰¹å¾ç›¸å…³è„šæœ¬æ–‡ä»¶</span><br><span class="line">â”‚   â”œâ”€â”€ nerf_mask.py  # NeRFæ©ç ç›¸å…³è„šæœ¬æ–‡ä»¶</span><br><span class="line">â”‚   â”œâ”€â”€ nerf_models.py  # NeRFæ¨¡å‹ç›¸å…³è„šæœ¬æ–‡ä»¶</span><br><span class="line">â”‚   â””â”€â”€ poses.py  # ä½å§¿ç›¸å…³è„šæœ¬æ–‡ä»¶</span><br></pre></td></tr></table></figure>

<h4 id="depth-decoder-py"><a href="#depth-decoder-py" class="headerlink" title="depth_decoder.py"></a>depth_decoder.py</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ç‰ˆæƒæ‰€æœ‰ Niantic 2019ã€‚ä¸“åˆ©ç”³è¯·ä¸­ã€‚ä¿ç•™æ‰€æœ‰æƒåˆ©ã€‚</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># æœ¬è½¯ä»¶éµå¾ª Monodepth2 è®¸å¯è¯çš„æ¡æ¬¾ï¼Œ</span></span><br><span class="line"><span class="comment"># è¯¥è®¸å¯è¯ä»…å…è®¸éå•†ä¸šç”¨é€”ï¼Œå®Œæ•´æ¡æ¬¾å¯åœ¨ LICENSE æ–‡ä»¶ä¸­è·å–ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> absolute_import, division, print_function</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> models.layers <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ä¸€ä¸ªå·ç§¯å±‚ï¼Œè¾“å…¥é€šé“æ•°ä¸º in_planesï¼Œè¾“å‡ºé€šé“æ•°ä¸º out_planesï¼Œå·ç§¯æ ¸å¤§å°ä¸º kernel_size</span></span><br><span class="line"><span class="comment"># å¦‚æœ instancenorm ä¸º Trueï¼Œåˆ™ä½¿ç”¨å®ä¾‹å½’ä¸€åŒ–ï¼›å¦åˆ™ä½¿ç”¨æ‰¹é‡å½’ä¸€åŒ–</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">conv</span>(<span class="params">in_planes, out_planes, kernel_size, instancenorm=<span class="literal">False</span></span>):</span><br><span class="line">    <span class="keyword">if</span> instancenorm:</span><br><span class="line">        <span class="comment"># æ„å»ºä¸€ä¸ªåŒ…å«å·ç§¯å±‚ã€å®ä¾‹å½’ä¸€åŒ–å±‚å’Œ LeakyReLU æ¿€æ´»å‡½æ•°çš„åºåˆ—</span></span><br><span class="line">        m = nn.Sequential(</span><br><span class="line">            <span class="comment"># å·ç§¯å±‚ï¼Œä½¿ç”¨æŒ‡å®šçš„è¾“å…¥å’Œè¾“å‡ºé€šé“æ•°ã€å·ç§¯æ ¸å¤§å°ï¼Œæ­¥é•¿ä¸º 1ï¼Œå¡«å……ä¸º (kernel_size - 1) // 2ï¼Œæ— åç½®</span></span><br><span class="line">            nn.Conv2d(in_planes, out_planes, kernel_size=kernel_size,</span><br><span class="line">                      stride=<span class="number">1</span>, padding=(kernel_size - <span class="number">1</span>) // <span class="number">2</span>, bias=<span class="literal">False</span>),</span><br><span class="line">            <span class="comment"># å®ä¾‹å½’ä¸€åŒ–å±‚</span></span><br><span class="line">            nn.InstanceNorm2d(out_planes),</span><br><span class="line">            <span class="comment"># LeakyReLU æ¿€æ´»å‡½æ•°ï¼Œè´Ÿæ–œç‡ä¸º 0.1ï¼ŒåŸåœ°æ“ä½œ</span></span><br><span class="line">            nn.LeakyReLU(<span class="number">0.1</span>, inplace=<span class="literal">True</span>),</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># æ„å»ºä¸€ä¸ªåŒ…å«å·ç§¯å±‚ã€æ‰¹é‡å½’ä¸€åŒ–å±‚å’Œ LeakyReLU æ¿€æ´»å‡½æ•°çš„åºåˆ—</span></span><br><span class="line">        m = nn.Sequential(</span><br><span class="line">            <span class="comment"># å·ç§¯å±‚ï¼Œä½¿ç”¨æŒ‡å®šçš„è¾“å…¥å’Œè¾“å‡ºé€šé“æ•°ã€å·ç§¯æ ¸å¤§å°ï¼Œæ­¥é•¿ä¸º 1ï¼Œå¡«å……ä¸º (kernel_size - 1) // 2ï¼Œæ— åç½®</span></span><br><span class="line">            nn.Conv2d(in_planes, out_planes, kernel_size=kernel_size,</span><br><span class="line">                      stride=<span class="number">1</span>, padding=(kernel_size - <span class="number">1</span>) // <span class="number">2</span>, bias=<span class="literal">False</span>),</span><br><span class="line">            <span class="comment"># æ‰¹é‡å½’ä¸€åŒ–å±‚</span></span><br><span class="line">            nn.BatchNorm2d(out_planes),</span><br><span class="line">            <span class="comment"># LeakyReLU æ¿€æ´»å‡½æ•°ï¼Œè´Ÿæ–œç‡ä¸º 0.1ï¼ŒåŸåœ°æ“ä½œ</span></span><br><span class="line">            nn.LeakyReLU(<span class="number">0.1</span>, inplace=<span class="literal">True</span>)</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">return</span> m</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·±åº¦è§£ç å™¨ç±»ï¼Œç»§æ‰¿è‡ª nn.Module</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DepthDecoder</span>(nn.Module):</span><br><span class="line">    <span class="comment"># å°†å…ƒç»„è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œç”¨äºä½œä¸ºå­—å…¸çš„é”®</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">tuple_to_str</span>(<span class="params">self, key_tuple</span>):</span><br><span class="line">        key_str = <span class="string">&#x27;-&#x27;</span>.join(<span class="built_in">str</span>(key_tuple))</span><br><span class="line">        <span class="keyword">return</span> key_str</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, num_ch_enc, embedder, embedder_out_dim,</span></span><br><span class="line"><span class="params">                 use_alpha=<span class="literal">False</span>, scales=<span class="built_in">range</span>(<span class="params"><span class="number">4</span></span>), num_output_channels=<span class="number">4</span>,</span></span><br><span class="line"><span class="params">                 use_skips=<span class="literal">True</span>, sigma_dropout_rate=<span class="number">0.0</span>, **kwargs</span>):</span><br><span class="line">        <span class="comment"># è°ƒç”¨çˆ¶ç±»çš„æ„é€ å‡½æ•°</span></span><br><span class="line">        <span class="built_in">super</span>(DepthDecoder, <span class="variable language_">self</span>).__init__()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è¾“å‡ºé€šé“æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.num_output_channels = num_output_channels</span><br><span class="line">        <span class="comment"># æ˜¯å¦ä½¿ç”¨è·³è·ƒè¿æ¥</span></span><br><span class="line">        <span class="variable language_">self</span>.use_skips = use_skips</span><br><span class="line">        <span class="comment"># ä¸Šé‡‡æ ·æ¨¡å¼</span></span><br><span class="line">        <span class="variable language_">self</span>.upsample_mode = <span class="string">&#x27;nearest&#x27;</span></span><br><span class="line">        <span class="comment"># è¦å¤„ç†çš„å°ºåº¦</span></span><br><span class="line">        <span class="variable language_">self</span>.scales = scales</span><br><span class="line">        <span class="comment"># æ˜¯å¦ä½¿ç”¨ alpha</span></span><br><span class="line">        <span class="variable language_">self</span>.use_alpha = use_alpha</span><br><span class="line">        <span class="comment"># sigma çš„ä¸¢å¼ƒç‡</span></span><br><span class="line">        <span class="variable language_">self</span>.sigma_dropout_rate = sigma_dropout_rate</span><br><span class="line"></span><br><span class="line">        <span class="comment"># åµŒå…¥å™¨</span></span><br><span class="line">        <span class="variable language_">self</span>.embedder = embedder</span><br><span class="line">        <span class="comment"># åµŒå…¥å™¨çš„è¾“å‡ºç»´åº¦</span></span><br><span class="line">        <span class="variable language_">self</span>.E = embedder_out_dim</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ç¼–ç å™¨æœ€åä¸€å±‚çš„è¾“å‡ºé€šé“æ•°</span></span><br><span class="line">        final_enc_out_channels = num_ch_enc[-<span class="number">1</span>]</span><br><span class="line">        <span class="comment"># æœ€å¤§æ± åŒ–å±‚ï¼Œç”¨äºä¸‹é‡‡æ ·</span></span><br><span class="line">        <span class="variable language_">self</span>.downsample = nn.MaxPool2d(<span class="number">3</span>, stride=<span class="number">2</span>, padding=<span class="number">1</span>)</span><br><span class="line">        <span class="comment"># æœ€è¿‘é‚»ä¸Šé‡‡æ ·å±‚ï¼Œç”¨äºä¸Šé‡‡æ ·</span></span><br><span class="line">        <span class="variable language_">self</span>.upsample = nn.UpsamplingNearest2d(scale_factor=<span class="number">2</span>)</span><br><span class="line">        <span class="comment"># ç¬¬ä¸€ä¸ªä¸‹é‡‡æ ·å·ç§¯å±‚</span></span><br><span class="line">        <span class="variable language_">self</span>.conv_down1 = conv(final_enc_out_channels, <span class="number">512</span>, <span class="number">1</span>, <span class="literal">False</span>)</span><br><span class="line">        <span class="comment"># ç¬¬äºŒä¸ªä¸‹é‡‡æ ·å·ç§¯å±‚</span></span><br><span class="line">        <span class="variable language_">self</span>.conv_down2 = conv(<span class="number">512</span>, <span class="number">256</span>, <span class="number">3</span>, <span class="literal">False</span>)</span><br><span class="line">        <span class="comment"># ç¬¬ä¸€ä¸ªä¸Šé‡‡æ ·å·ç§¯å±‚</span></span><br><span class="line">        <span class="variable language_">self</span>.conv_up1 = conv(<span class="number">256</span>, <span class="number">256</span>, <span class="number">3</span>, <span class="literal">False</span>)</span><br><span class="line">        <span class="comment"># ç¬¬äºŒä¸ªä¸Šé‡‡æ ·å·ç§¯å±‚</span></span><br><span class="line">        <span class="variable language_">self</span>.conv_up2 = conv(<span class="number">256</span>, final_enc_out_channels, <span class="number">1</span>, <span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ç¼–ç å™¨å„å±‚çš„é€šé“æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.num_ch_enc = num_ch_enc</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;num_ch_enc=&quot;</span>, num_ch_enc)</span><br><span class="line">        <span class="comment"># å°†ç¼–ç å™¨å„å±‚çš„é€šé“æ•°åŠ ä¸ŠåµŒå…¥å™¨çš„è¾“å‡ºç»´åº¦</span></span><br><span class="line">        <span class="variable language_">self</span>.num_ch_enc = [x + <span class="variable language_">self</span>.E <span class="keyword">for</span> x <span class="keyword">in</span> <span class="variable language_">self</span>.num_ch_enc]</span><br><span class="line">        <span class="comment"># è§£ç å™¨å„å±‚çš„é€šé“æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.num_ch_dec = np.array([<span class="number">16</span>, <span class="number">32</span>, <span class="number">64</span>, <span class="number">128</span>, <span class="number">256</span>])</span><br><span class="line">        <span class="comment"># self.num_ch_enc = np.array([64, 64, 128, 256, 512])</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># è§£ç å™¨çš„å·ç§¯å±‚ï¼Œä½¿ç”¨ nn.ModuleDict å­˜å‚¨</span></span><br><span class="line">        <span class="variable language_">self</span>.convs = nn.ModuleDict()</span><br><span class="line">        <span class="comment"># ä» 4 åˆ° 0 éå†</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>, -<span class="number">1</span>, -<span class="number">1</span>):</span><br><span class="line">            <span class="comment"># ä¸Šå·ç§¯å±‚ 0</span></span><br><span class="line">            <span class="comment"># å¦‚æœ i ä¸º 4ï¼Œåˆ™è¾“å…¥é€šé“æ•°ä¸ºç¼–ç å™¨æœ€åä¸€å±‚çš„é€šé“æ•°ï¼›å¦åˆ™ä¸ºè§£ç å™¨ä¸Šä¸€å±‚çš„é€šé“æ•°</span></span><br><span class="line">            num_ch_in = <span class="variable language_">self</span>.num_ch_enc[-<span class="number">1</span>] <span class="keyword">if</span> i == <span class="number">4</span> <span class="keyword">else</span> <span class="variable language_">self</span>.num_ch_dec[i + <span class="number">1</span>]</span><br><span class="line">            <span class="comment"># è¾“å‡ºé€šé“æ•°ä¸ºè§£ç å™¨å½“å‰å±‚çš„é€šé“æ•°</span></span><br><span class="line">            num_ch_out = <span class="variable language_">self</span>.num_ch_dec[i]</span><br><span class="line">            <span class="comment"># åˆ›å»ºå·ç§¯å—å¹¶æ·»åŠ åˆ° convs å­—å…¸ä¸­</span></span><br><span class="line">            <span class="variable language_">self</span>.convs[<span class="variable language_">self</span>.tuple_to_str((<span class="string">&quot;upconv&quot;</span>, i, <span class="number">0</span>))] = ConvBlock(num_ch_in, num_ch_out)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;upconv_&#123;&#125;_&#123;&#125;&quot;</span>.<span class="built_in">format</span>(i, <span class="number">0</span>), num_ch_in, num_ch_out)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># ä¸Šå·ç§¯å±‚ 1</span></span><br><span class="line">            <span class="comment"># è¾“å…¥é€šé“æ•°ä¸ºè§£ç å™¨å½“å‰å±‚çš„é€šé“æ•°</span></span><br><span class="line">            num_ch_in = <span class="variable language_">self</span>.num_ch_dec[i]</span><br><span class="line">            <span class="comment"># å¦‚æœä½¿ç”¨è·³è·ƒè¿æ¥ä¸” i å¤§äº 0ï¼Œåˆ™è¾“å…¥é€šé“æ•°åŠ ä¸Šç¼–ç å™¨ä¸Šä¸€å±‚çš„é€šé“æ•°</span></span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.use_skips <span class="keyword">and</span> i &gt; <span class="number">0</span>:</span><br><span class="line">                num_ch_in += <span class="variable language_">self</span>.num_ch_enc[i - <span class="number">1</span>]</span><br><span class="line">            <span class="comment"># è¾“å‡ºé€šé“æ•°ä¸ºè§£ç å™¨å½“å‰å±‚çš„é€šé“æ•°</span></span><br><span class="line">            num_ch_out = <span class="variable language_">self</span>.num_ch_dec[i]</span><br><span class="line">            <span class="comment"># åˆ›å»ºå·ç§¯å—å¹¶æ·»åŠ åˆ° convs å­—å…¸ä¸­</span></span><br><span class="line">            <span class="variable language_">self</span>.convs[<span class="variable language_">self</span>.tuple_to_str((<span class="string">&quot;upconv&quot;</span>, i, <span class="number">1</span>))] = ConvBlock(num_ch_in, num_ch_out)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;upconv_&#123;&#125;_&#123;&#125;&quot;</span>.<span class="built_in">format</span>(i, <span class="number">1</span>), num_ch_in, num_ch_out)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># éå†è¦å¤„ç†çš„å°ºåº¦</span></span><br><span class="line">        <span class="keyword">for</span> s <span class="keyword">in</span> <span class="variable language_">self</span>.scales:</span><br><span class="line">            <span class="comment"># åˆ›å»ºä¸€ä¸ª 3x3 çš„å·ç§¯å±‚å¹¶æ·»åŠ åˆ° convs å­—å…¸ä¸­</span></span><br><span class="line">            <span class="variable language_">self</span>.convs[<span class="variable language_">self</span>.tuple_to_str((<span class="string">&quot;dispconv&quot;</span>, s))] = Conv3x3(<span class="variable language_">self</span>.num_ch_dec[s], <span class="variable language_">self</span>.num_output_channels)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Sigmoid æ¿€æ´»å‡½æ•°ï¼Œç”¨äºå°†è¾“å‡ºæ˜ å°„åˆ° [0, 1] èŒƒå›´</span></span><br><span class="line">        <span class="variable language_">self</span>.sigmoid = nn.Sigmoid()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, input_features, disparity</span>):</span><br><span class="line">        <span class="comment"># è·å–è¾“å…¥è§†å·®çš„æ‰¹æ¬¡å¤§å°å’Œåºåˆ—é•¿åº¦</span></span><br><span class="line">        B, S = disparity.size()</span><br><span class="line">        <span class="comment"># å¯¹è¾“å…¥è§†å·®è¿›è¡ŒåµŒå…¥æ“ä½œï¼Œç„¶åå¢åŠ ä¸¤ä¸ªç»´åº¦</span></span><br><span class="line">        disparity = <span class="variable language_">self</span>.embedder(disparity.reshape(B * S, <span class="number">1</span>)).unsqueeze(<span class="number">2</span>).unsqueeze(<span class="number">3</span>)</span><br><span class="line">---------------------------------------------------------------------------------------------------------------------</span><br><span class="line">tensor_1d æ˜¯ä¸€ä¸ªä¸€ç»´å¼ é‡ï¼Œç›´æ¥ä½¿ç”¨ torch.tensor åˆ›å»ºï¼Œå…¶å½¢çŠ¶ä¸º (<span class="number">3</span>,)ã€‚</span><br><span class="line">tensor_2d æ˜¯é€šè¿‡å¯¹ tensor_1d ä½¿ç”¨ unsqueeze(<span class="number">1</span>) å¢åŠ ä¸€ä¸ªç»´åº¦å¾—åˆ°çš„ï¼Œå½¢çŠ¶ä¸º (<span class="number">3</span>, <span class="number">1</span>)ã€‚</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºå½¢çŠ¶ä¸º (3,) çš„ä¸€ç»´å¼ é‡</span></span><br><span class="line">tensor_1d = torch.tensor([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;tensor_1d æ˜¯å¦å®šä¹‰:&quot;</span>, <span class="string">&#x27;tensor_1d&#x27;</span> <span class="keyword">in</span> <span class="built_in">locals</span>())</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;tensor_1d çš„å€¼:&quot;</span>, tensor_1d)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»˜åˆ¶ä¸€ç»´å¼ é‡</span></span><br><span class="line">plt.figure(figsize=(<span class="number">12</span>, <span class="number">5</span>))</span><br><span class="line">plt.subplot(<span class="number">1</span>, <span class="number">2</span>, <span class="number">1</span>)</span><br><span class="line">plt.plot(<span class="built_in">range</span>(<span class="built_in">len</span>(tensor_1d)), tensor_1d, marker=<span class="string">&#x27;o&#x27;</span>)</span><br><span class="line">plt.title(<span class="string">&#x27;Shape (3,) Tensor&#x27;</span>)</span><br><span class="line">plt.xlabel(<span class="string">&#x27;Index&#x27;</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;Value&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºå½¢çŠ¶ä¸º (3, 1) çš„äºŒç»´å¼ é‡</span></span><br><span class="line">tensor_2d = tensor_1d.unsqueeze(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»˜åˆ¶äºŒç»´å¼ é‡</span></span><br><span class="line">plt.subplot(<span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>)</span><br><span class="line">plt.bar(<span class="built_in">range</span>(<span class="built_in">len</span>(tensor_2d)), tensor_2d.flatten(), width=<span class="number">0.5</span>)</span><br><span class="line">plt.title(<span class="string">&#x27;Shape (3, 1) Tensor&#x27;</span>)</span><br><span class="line">plt.xlabel(<span class="string">&#x27;Index&#x27;</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;Value&#x27;</span>)</span><br><span class="line"></span><br><span class="line">plt.tight_layout()</span><br><span class="line">plt.show()</span><br><span class="line">---------------------------------------------------------------------------------------------------------------------</span><br><span class="line">        <span class="comment"># æ‰©å±•ç¼–ç å™¨çš„è¾“å‡ºä»¥å¢åŠ æ„Ÿå—é‡</span></span><br><span class="line">        <span class="comment"># è·å–ç¼–ç å™¨æœ€åä¸€å±‚çš„è¾“å‡º</span></span><br><span class="line">        encoder_out = input_features[-<span class="number">1</span>]</span><br><span class="line">        <span class="comment"># å¯¹ç¼–ç å™¨è¾“å‡ºè¿›è¡Œä¸‹é‡‡æ ·ï¼Œç„¶åé€šè¿‡ç¬¬ä¸€ä¸ªä¸‹é‡‡æ ·å·ç§¯å±‚</span></span><br><span class="line">        conv_down1 = <span class="variable language_">self</span>.conv_down1(<span class="variable language_">self</span>.downsample(encoder_out))</span><br><span class="line">        <span class="comment"># å¯¹ç¬¬ä¸€ä¸ªä¸‹é‡‡æ ·å·ç§¯å±‚çš„è¾“å‡ºè¿›è¡Œä¸‹é‡‡æ ·ï¼Œç„¶åé€šè¿‡ç¬¬äºŒä¸ªä¸‹é‡‡æ ·å·ç§¯å±‚</span></span><br><span class="line">        conv_down2 = <span class="variable language_">self</span>.conv_down2(<span class="variable language_">self</span>.downsample(conv_down1))</span><br><span class="line">        <span class="comment"># å¯¹ç¬¬äºŒä¸ªä¸‹é‡‡æ ·å·ç§¯å±‚çš„è¾“å‡ºè¿›è¡Œä¸Šé‡‡æ ·ï¼Œç„¶åé€šè¿‡ç¬¬ä¸€ä¸ªä¸Šé‡‡æ ·å·ç§¯å±‚</span></span><br><span class="line">        conv_up1 = <span class="variable language_">self</span>.conv_up1(<span class="variable language_">self</span>.upsample(conv_down2))</span><br><span class="line">        <span class="comment"># å¯¹ç¬¬ä¸€ä¸ªä¸Šé‡‡æ ·å·ç§¯å±‚çš„è¾“å‡ºè¿›è¡Œä¸Šé‡‡æ ·ï¼Œç„¶åé€šè¿‡ç¬¬äºŒä¸ªä¸Šé‡‡æ ·å·ç§¯å±‚</span></span><br><span class="line">        conv_up2 = <span class="variable language_">self</span>.conv_up2(<span class="variable language_">self</span>.upsample(conv_up1))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># é‡å¤ / é‡å¡‘ç‰¹å¾</span></span><br><span class="line">        <span class="comment"># è·å–ç¬¬äºŒä¸ªä¸Šé‡‡æ ·å·ç§¯å±‚è¾“å‡ºçš„é€šé“æ•°ã€é«˜åº¦å’Œå®½åº¦</span></span><br><span class="line">        _, C_feat, H_feat, W_feat = conv_up2.size()</span><br><span class="line">        <span class="comment"># å¯¹ç¬¬äºŒä¸ªä¸Šé‡‡æ ·å·ç§¯å±‚çš„è¾“å‡ºè¿›è¡Œæ‰©å±•å’Œé‡å¡‘</span></span><br><span class="line">        feat_tmp = conv_up2.unsqueeze(<span class="number">1</span>).expand(B, S, C_feat, H_feat, W_feat) \</span><br><span class="line">            .contiguous().view(B * S, C_feat, H_feat, W_feat)</span><br><span class="line">        <span class="comment"># å¯¹è§†å·®è¿›è¡Œé‡å¤æ“ä½œä»¥åŒ¹é…ç‰¹å¾å›¾çš„å¤§å°</span></span><br><span class="line">        disparity_BsCHW = disparity.repeat(<span class="number">1</span>, <span class="number">1</span>, H_feat, W_feat)</span><br><span class="line">        <span class="comment"># å°†æ‰©å±•åçš„ç‰¹å¾å’Œè§†å·®æ‹¼æ¥åœ¨ä¸€èµ·</span></span><br><span class="line">        conv_up2 = torch.cat((feat_tmp, disparity_BsCHW), dim=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># é‡å¤ / é‡å¡‘è¾“å…¥ç‰¹å¾</span></span><br><span class="line">        <span class="keyword">for</span> i, feat <span class="keyword">in</span> <span class="built_in">enumerate</span>(input_features):</span><br><span class="line">            <span class="comment"># è·å–è¾“å…¥ç‰¹å¾çš„é€šé“æ•°ã€é«˜åº¦å’Œå®½åº¦</span></span><br><span class="line">            _, C_feat, H_feat, W_feat = feat.size()</span><br><span class="line">            <span class="comment"># å¯¹è¾“å…¥ç‰¹å¾è¿›è¡Œæ‰©å±•å’Œé‡å¡‘</span></span><br><span class="line">            feat_tmp = feat.unsqueeze(<span class="number">1</span>).expand(B, S, C_feat, H_feat, W_feat) \</span><br><span class="line">                .contiguous().view(B * S, C_feat, H_feat, W_feat)</span><br><span class="line">            <span class="comment"># å¯¹è§†å·®è¿›è¡Œé‡å¤æ“ä½œä»¥åŒ¹é…ç‰¹å¾å›¾çš„å¤§å°</span></span><br><span class="line">            disparity_BsCHW = disparity.repeat(<span class="number">1</span>, <span class="number">1</span>, H_feat, W_feat)</span><br><span class="line">            <span class="comment"># å°†æ‰©å±•åçš„ç‰¹å¾å’Œè§†å·®æ‹¼æ¥åœ¨ä¸€èµ·</span></span><br><span class="line">            input_features[i] = torch.cat((feat_tmp, disparity_BsCHW), dim=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è§£ç å™¨éƒ¨åˆ†</span></span><br><span class="line">        <span class="comment"># å­˜å‚¨è¾“å‡ºç»“æœçš„å­—å…¸</span></span><br><span class="line">        outputs = &#123;&#125;</span><br><span class="line">        <span class="comment"># åˆå§‹è¾“å…¥ä¸ºæ‰©å±•åçš„ç¬¬äºŒä¸ªä¸Šé‡‡æ ·å·ç§¯å±‚çš„è¾“å‡º</span></span><br><span class="line">        x = conv_up2</span><br><span class="line">        <span class="comment"># ä» 4 åˆ° 0 éå†</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>, -<span class="number">1</span>, -<span class="number">1</span>):</span><br><span class="line">            <span class="comment"># é€šè¿‡ä¸Šå·ç§¯å±‚ 0</span></span><br><span class="line">            x = <span class="variable language_">self</span>.convs[<span class="variable language_">self</span>.tuple_to_str((<span class="string">&quot;upconv&quot;</span>, i, <span class="number">0</span>))](x)</span><br><span class="line">            <span class="comment"># è¿›è¡Œä¸Šé‡‡æ ·</span></span><br><span class="line">            x = [upsample(x)]</span><br><span class="line">            <span class="comment"># å¦‚æœä½¿ç”¨è·³è·ƒè¿æ¥ä¸” i å¤§äº 0</span></span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.use_skips <span class="keyword">and</span> i &gt; <span class="number">0</span>:</span><br><span class="line">                <span class="comment"># å°†ç¼–ç å™¨ä¸Šä¸€å±‚çš„ç‰¹å¾æ·»åŠ åˆ°åˆ—è¡¨ä¸­</span></span><br><span class="line">                x += [input_features[i - <span class="number">1</span>]]</span><br><span class="line">            <span class="comment"># å°†åˆ—è¡¨ä¸­çš„ç‰¹å¾æ‹¼æ¥åœ¨ä¸€èµ·</span></span><br><span class="line">            x = torch.cat(x, <span class="number">1</span>)</span><br><span class="line">            <span class="comment"># é€šè¿‡ä¸Šå·ç§¯å±‚ 1</span></span><br><span class="line">            x = <span class="variable language_">self</span>.convs[<span class="variable language_">self</span>.tuple_to_str((<span class="string">&quot;upconv&quot;</span>, i, <span class="number">1</span>))](x)</span><br><span class="line">            <span class="comment"># å¦‚æœå½“å‰å°ºåº¦åœ¨è¦å¤„ç†çš„å°ºåº¦åˆ—è¡¨ä¸­</span></span><br><span class="line">            <span class="keyword">if</span> i <span class="keyword">in</span> <span class="variable language_">self</span>.scales:</span><br><span class="line">                <span class="comment"># é€šè¿‡è§†å·®å·ç§¯å±‚å¾—åˆ°è¾“å‡º</span></span><br><span class="line">                output = <span class="variable language_">self</span>.convs[<span class="variable language_">self</span>.tuple_to_str((<span class="string">&quot;dispconv&quot;</span>, i))](x)</span><br><span class="line">                <span class="comment"># è·å–è¾“å‡ºçš„é«˜åº¦å’Œå®½åº¦</span></span><br><span class="line">                H_mpi, W_mpi = output.size(<span class="number">2</span>), output.size(<span class="number">3</span>)</span><br><span class="line">                <span class="comment"># è°ƒæ•´è¾“å‡ºçš„ç»´åº¦</span></span><br><span class="line">                mpi = output.view(B, S, <span class="number">4</span>, H_mpi, W_mpi)</span><br><span class="line">                <span class="comment"># å¯¹ RGB é€šé“åº”ç”¨ Sigmoid æ¿€æ´»å‡½æ•°</span></span><br><span class="line">                mpi_rgb = <span class="variable language_">self</span>.sigmoid(mpi[:, :, <span class="number">0</span>:<span class="number">3</span>, :, :])</span><br><span class="line">                <span class="comment"># å¦‚æœä¸ä½¿ç”¨ alphaï¼Œåˆ™å–ç»å¯¹å€¼å¹¶åŠ ä¸Šä¸€ä¸ªå°çš„å¸¸æ•°ï¼›å¦åˆ™åº”ç”¨ Sigmoid æ¿€æ´»å‡½æ•°</span></span><br><span class="line">                mpi_sigma = torch.<span class="built_in">abs</span>(mpi[:, :, <span class="number">3</span>:, :, :]) + <span class="number">1e-4</span> \</span><br><span class="line">                        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.use_alpha \</span><br><span class="line">                        <span class="keyword">else</span> <span class="variable language_">self</span>.sigmoid(mpi[:, :, <span class="number">3</span>:, :, :])</span><br><span class="line"></span><br><span class="line">                <span class="comment"># å¦‚æœ sigma ä¸¢å¼ƒç‡å¤§äº 0 ä¸”å¤„äºè®­ç»ƒæ¨¡å¼</span></span><br><span class="line">                <span class="keyword">if</span> <span class="variable language_">self</span>.sigma_dropout_rate &gt; <span class="number">0.0</span> <span class="keyword">and</span> <span class="variable language_">self</span>.training:</span><br><span class="line">                    <span class="comment"># å¯¹ sigma é€šé“åº”ç”¨ 2D Dropout</span></span><br><span class="line">                    mpi_sigma = F.dropout2d(mpi_sigma, p=<span class="variable language_">self</span>.sigma_dropout_rate)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># å°† RGB å’Œ sigma é€šé“æ‹¼æ¥åœ¨ä¸€èµ·ï¼Œå¹¶å­˜å‚¨åˆ°è¾“å‡ºå­—å…¸ä¸­</span></span><br><span class="line">                outputs[(<span class="string">&quot;disp&quot;</span>, i)] = torch.cat((mpi_rgb, mpi_sigma), dim=<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> outputs</span><br></pre></td></tr></table></figure>

<h4 id="intrinsics-py"><a href="#intrinsics-py" class="headerlink" title="intrinsics.py"></a>intrinsics.py</h4><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ä¸€ä¸ªç”¨äºå­¦ä¹ ç„¦è·çš„ç¥ç»ç½‘ç»œæ¨¡å—</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LearnFocal</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, H, W, req_grad, fx_only, order=<span class="number">2</span>, init_focal=<span class="literal">None</span>, learn_distortion=<span class="literal">False</span></span>):</span><br><span class="line">        <span class="comment"># è°ƒç”¨çˆ¶ç±» nn.Module çš„æ„é€ å‡½æ•°</span></span><br><span class="line">        <span class="built_in">super</span>(LearnFocal, <span class="variable language_">self</span>).__init__()</span><br><span class="line">        <span class="comment"># å›¾åƒçš„é«˜åº¦</span></span><br><span class="line">        <span class="variable language_">self</span>.H = H</span><br><span class="line">        <span class="comment"># å›¾åƒçš„å®½åº¦</span></span><br><span class="line">        <span class="variable language_">self</span>.W = W</span><br><span class="line">        <span class="comment"># ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œå¦‚æœä¸º Trueï¼Œåªè¾“å‡º [fx, fx]ï¼›å¦‚æœä¸º Falseï¼Œè¾“å‡º [fx, fy]</span></span><br><span class="line">        <span class="variable language_">self</span>.fx_only = fx_only  </span><br><span class="line">        <span class="comment"># ç„¦è·åˆå§‹åŒ–çš„é˜¶æ•°ï¼Œæ£€æŸ¥æˆ‘ä»¬çš„è¡¥å……éƒ¨åˆ†æœ‰ç›¸å…³è¯´æ˜</span></span><br><span class="line">        <span class="variable language_">self</span>.order = order  </span><br><span class="line"></span><br><span class="line">        <span class="comment"># ç•¸å˜ç›¸å…³</span></span><br><span class="line">        <span class="comment"># æ˜¯å¦å­¦ä¹ ç•¸å˜å‚æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.learn_distortion = learn_distortion</span><br><span class="line">        <span class="keyword">if</span> learn_distortion:</span><br><span class="line">            <span class="comment"># ç¬¬ä¸€ä¸ªç•¸å˜ç³»æ•°ï¼Œå¯æ ¹æ® req_grad è®¾ç½®æ˜¯å¦éœ€è¦æ¢¯åº¦</span></span><br><span class="line">            <span class="variable language_">self</span>.k1 = nn.Parameter(torch.tensor(<span class="number">0.0</span>, dtype=torch.float32), requires_grad=req_grad)</span><br><span class="line">            <span class="comment"># ç¬¬äºŒä¸ªç•¸å˜ç³»æ•°ï¼Œå¯æ ¹æ® req_grad è®¾ç½®æ˜¯å¦éœ€è¦æ¢¯åº¦</span></span><br><span class="line">            <span class="variable language_">self</span>.k2 = nn.Parameter(torch.tensor(<span class="number">0.0</span>, dtype=torch.float32), requires_grad=req_grad)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.fx_only:</span><br><span class="line">            <span class="keyword">if</span> init_focal <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="comment"># å¦‚æœæ²¡æœ‰æä¾›åˆå§‹ç„¦è·ï¼Œå°† fx åˆå§‹åŒ–ä¸º 1.0ï¼Œå¯æ ¹æ® req_grad è®¾ç½®æ˜¯å¦éœ€è¦æ¢¯åº¦</span></span><br><span class="line">                <span class="variable language_">self</span>.fx = nn.Parameter(torch.tensor(<span class="number">1.0</span>, dtype=torch.float32), requires_grad=req_grad)  <span class="comment"># (1, )</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">if</span> <span class="variable language_">self</span>.order == <span class="number">2</span>:</span><br><span class="line">                    <span class="comment"># æ ¹æ®å…¬å¼ a**2 * W = fx è®¡ç®—ç³»æ•° aï¼Œå³ a**2 = fx / W</span></span><br><span class="line">                    coe_x = torch.tensor(np.sqrt(init_focal / <span class="built_in">float</span>(W)), requires_grad=<span class="literal">False</span>).<span class="built_in">float</span>()</span><br><span class="line">                <span class="keyword">elif</span> <span class="variable language_">self</span>.order == <span class="number">1</span>:</span><br><span class="line">                    <span class="comment"># æ ¹æ®å…¬å¼ a * W = fx è®¡ç®—ç³»æ•° aï¼Œå³ a = fx / W</span></span><br><span class="line">                    coe_x = torch.tensor(init_focal / <span class="built_in">float</span>(W), requires_grad=<span class="literal">False</span>).<span class="built_in">float</span>()</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&#x27;ç„¦è·åˆå§‹åŒ–é˜¶æ•°éœ€è¦ä¸º 1 æˆ– 2ã€‚é€€å‡º&#x27;</span>)</span><br><span class="line">                    exit()</span><br><span class="line">                <span class="comment"># å°†è®¡ç®—å¾—åˆ°çš„ç³»æ•°ä½œä¸º fxï¼Œå¯æ ¹æ® req_grad è®¾ç½®æ˜¯å¦éœ€è¦æ¢¯åº¦</span></span><br><span class="line">                <span class="variable language_">self</span>.fx = nn.Parameter(coe_x, requires_grad=req_grad)  <span class="comment"># (1, )</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> init_focal <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="comment"># å¦‚æœæ²¡æœ‰æä¾›åˆå§‹ç„¦è·ï¼Œå°† fx åˆå§‹åŒ–ä¸º 1.0ï¼Œå¯æ ¹æ® req_grad è®¾ç½®æ˜¯å¦éœ€è¦æ¢¯åº¦</span></span><br><span class="line">                <span class="variable language_">self</span>.fx = nn.Parameter(torch.tensor(<span class="number">1.0</span>, dtype=torch.float32), requires_grad=req_grad)  <span class="comment"># (1, )</span></span><br><span class="line">                <span class="comment"># å¦‚æœæ²¡æœ‰æä¾›åˆå§‹ç„¦è·ï¼Œå°† fy åˆå§‹åŒ–ä¸º 1.0ï¼Œå¯æ ¹æ® req_grad è®¾ç½®æ˜¯å¦éœ€è¦æ¢¯åº¦</span></span><br><span class="line">                <span class="variable language_">self</span>.fy = nn.Parameter(torch.tensor(<span class="number">1.0</span>, dtype=torch.float32), requires_grad=req_grad)  <span class="comment"># (1, )</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">if</span> <span class="variable language_">self</span>.order == <span class="number">2</span>:</span><br><span class="line">                    <span class="comment"># æ ¹æ®å…¬å¼ a**2 * W = fx è®¡ç®— x æ–¹å‘çš„ç³»æ•° aï¼Œå³ a**2 = fx / W</span></span><br><span class="line">                    coe_x = torch.tensor(np.sqrt(init_focal / <span class="built_in">float</span>(W)), requires_grad=<span class="literal">False</span>).<span class="built_in">float</span>()</span><br><span class="line">                    <span class="comment"># æ ¹æ®å…¬å¼ a**2 * H = fy è®¡ç®— y æ–¹å‘çš„ç³»æ•° aï¼Œå³ a**2 = fy / H</span></span><br><span class="line">                    coe_y = torch.tensor(np.sqrt(init_focal / <span class="built_in">float</span>(H)), requires_grad=<span class="literal">False</span>).<span class="built_in">float</span>()</span><br><span class="line">                <span class="keyword">elif</span> <span class="variable language_">self</span>.order == <span class="number">1</span>:</span><br><span class="line">                    <span class="comment"># æ ¹æ®å…¬å¼ a * W = fx è®¡ç®— x æ–¹å‘çš„ç³»æ•° aï¼Œå³ a = fx / W</span></span><br><span class="line">                    coe_x = torch.tensor(init_focal / <span class="built_in">float</span>(W), requires_grad=<span class="literal">False</span>).<span class="built_in">float</span>()</span><br><span class="line">                    <span class="comment"># æ ¹æ®å…¬å¼ a * H = fy è®¡ç®— y æ–¹å‘çš„ç³»æ•° aï¼Œå³ a = fy / H</span></span><br><span class="line">                    coe_y = torch.tensor(init_focal / <span class="built_in">float</span>(H), requires_grad=<span class="literal">False</span>).<span class="built_in">float</span>()</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&#x27;ç„¦è·åˆå§‹åŒ–é˜¶æ•°éœ€è¦ä¸º 1 æˆ– 2ã€‚é€€å‡º&#x27;</span>)</span><br><span class="line">                    exit()</span><br><span class="line">                <span class="comment"># å°†è®¡ç®—å¾—åˆ°çš„ x æ–¹å‘ç³»æ•°ä½œä¸º fxï¼Œå¯æ ¹æ® req_grad è®¾ç½®æ˜¯å¦éœ€è¦æ¢¯åº¦</span></span><br><span class="line">                <span class="variable language_">self</span>.fx = nn.Parameter(coe_x, requires_grad=req_grad)  <span class="comment"># (1, )</span></span><br><span class="line">                <span class="comment"># å°†è®¡ç®—å¾—åˆ°çš„ y æ–¹å‘ç³»æ•°ä½œä¸º fyï¼Œå¯æ ¹æ® req_grad è®¾ç½®æ˜¯å¦éœ€è¦æ¢¯åº¦</span></span><br><span class="line">                <span class="variable language_">self</span>.fy = nn.Parameter(coe_y, requires_grad=req_grad)  <span class="comment"># (1, )</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, i=<span class="literal">None</span></span>):  <span class="comment"># å‚æ•° i=None åªæ˜¯ä¸ºäº†æ”¯æŒå¤š GPU è®­ç»ƒ</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.fx_only:</span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.order == <span class="number">2</span>:</span><br><span class="line">                <span class="comment"># æ ¹æ®å…¬å¼è®¡ç®— fx å’Œ fyï¼Œå› ä¸º fx_only ä¸º Trueï¼Œæ‰€ä»¥ fy ç­‰äº fx</span></span><br><span class="line">                fxfy = torch.stack([<span class="variable language_">self</span>.fx ** <span class="number">2</span> * <span class="variable language_">self</span>.W, <span class="variable language_">self</span>.fx ** <span class="number">2</span> * <span class="variable language_">self</span>.W])</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># æ ¹æ®å…¬å¼è®¡ç®— fx å’Œ fyï¼Œå› ä¸º fx_only ä¸º Trueï¼Œæ‰€ä»¥ fy ç­‰äº fx</span></span><br><span class="line">                fxfy = torch.stack([<span class="variable language_">self</span>.fx * <span class="variable language_">self</span>.W, <span class="variable language_">self</span>.fx * <span class="variable language_">self</span>.W])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.order == <span class="number">2</span>:</span><br><span class="line">                <span class="comment"># æ ¹æ®å…¬å¼è®¡ç®— fx å’Œ fy</span></span><br><span class="line">                fxfy = torch.stack([<span class="variable language_">self</span>.fx**<span class="number">2</span> * <span class="variable language_">self</span>.W, <span class="variable language_">self</span>.fy**<span class="number">2</span> * <span class="variable language_">self</span>.H])</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># æ ¹æ®å…¬å¼è®¡ç®— fx å’Œ fy</span></span><br><span class="line">                fxfy = torch.stack([<span class="variable language_">self</span>.fx * <span class="variable language_">self</span>.W, <span class="variable language_">self</span>.fy * <span class="variable language_">self</span>.H])</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.learn_distortion:</span><br><span class="line">            <span class="comment"># å¦‚æœè¦å­¦ä¹ ç•¸å˜å‚æ•°ï¼Œè¿”å›ç„¦è·å’Œç•¸å˜ç³»æ•°</span></span><br><span class="line">            <span class="keyword">return</span> fxfy, <span class="variable language_">self</span>.k1, <span class="variable language_">self</span>.k2</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># å¦åˆ™åªè¿”å›ç„¦è·</span></span><br><span class="line">            <span class="keyword">return</span> fxfy</span><br></pre></td></tr></table></figure>

<h4 id="layers-py"><a href="#layers-py" class="headerlink" title="layers.py"></a>layers.py</h4><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ç‰ˆæƒæ‰€æœ‰ Niantic 2019ã€‚ä¸“åˆ©ç”³è¯·ä¸­ã€‚ä¿ç•™æ‰€æœ‰æƒåˆ©ã€‚</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># æœ¬è½¯ä»¶éµå¾ª Monodepth2 è®¸å¯è¯çš„æ¡æ¬¾ï¼Œ</span></span><br><span class="line"><span class="comment"># è¯¥è®¸å¯è¯ä»…å…è®¸éå•†ä¸šç”¨é€”ï¼Œå®Œæ•´æ¡æ¬¾å¯åœ¨ LICENSE æ–‡ä»¶ä¸­è·å–ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> absolute_import, division, print_function</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†ç½‘ç»œçš„ sigmoid è¾“å‡ºè½¬æ¢ä¸ºæ·±åº¦é¢„æµ‹</span></span><br><span class="line"><span class="comment"># æ­¤è½¬æ¢å…¬å¼åœ¨è®ºæ–‡çš„â€œé¢å¤–è€ƒè™‘â€éƒ¨åˆ†ç»™å‡º</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">disp_to_depth</span>(<span class="params">disp, min_depth, max_depth</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    å°†ç½‘ç»œçš„ sigmoid è¾“å‡ºè½¬æ¢ä¸ºæ·±åº¦é¢„æµ‹</span></span><br><span class="line"><span class="string">    è¯¥è½¬æ¢å…¬å¼åœ¨è®ºæ–‡çš„â€œé¢å¤–è€ƒè™‘â€éƒ¨åˆ†ç»™å‡ºã€‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># æœ€å°è§†å·®ï¼Œä¸ºæœ€å¤§æ·±åº¦çš„å€’æ•°</span></span><br><span class="line">    min_disp = <span class="number">1</span> / max_depth</span><br><span class="line">    <span class="comment"># æœ€å¤§è§†å·®ï¼Œä¸ºæœ€å°æ·±åº¦çš„å€’æ•°</span></span><br><span class="line">    max_disp = <span class="number">1</span> / min_depth</span><br><span class="line">    <span class="comment"># ç¼©æ”¾åçš„è§†å·®</span></span><br><span class="line">    scaled_disp = min_disp + (max_disp - min_disp) * disp</span><br><span class="line">    <span class="comment"># æ·±åº¦å€¼ï¼Œä¸ºç¼©æ”¾åè§†å·®çš„å€’æ•°</span></span><br><span class="line">    depth = <span class="number">1</span> / scaled_disp</span><br><span class="line">    <span class="keyword">return</span> scaled_disp, depth</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†ç½‘ç»œè¾“å‡ºçš„ (è½´è§’, å¹³ç§») è½¬æ¢ä¸º 4x4 çŸ©é˜µ</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">transformation_from_parameters</span>(<span class="params">axisangle, translation, invert=<span class="literal">False</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å°†ç½‘ç»œçš„ (è½´è§’, å¹³ç§») è¾“å‡ºè½¬æ¢ä¸º 4x4 çŸ©é˜µ</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># ä»è½´è§’è¡¨ç¤ºè½¬æ¢ä¸ºæ—‹è½¬çŸ©é˜µ</span></span><br><span class="line">    R = rot_from_axisangle(axisangle)</span><br><span class="line">    <span class="comment"># å…‹éš†å¹³ç§»å‘é‡</span></span><br><span class="line">    t = translation.clone()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> invert:</span><br><span class="line">        <span class="comment"># å¦‚æœéœ€è¦åè½¬ï¼Œå¯¹æ—‹è½¬çŸ©é˜µè¿›è¡Œè½¬ç½®</span></span><br><span class="line">        R = R.transpose(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">        <span class="comment"># å¹³ç§»å‘é‡å–è´Ÿ</span></span><br><span class="line">        t *= -<span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># å°†å¹³ç§»å‘é‡è½¬æ¢ä¸º 4x4 å˜æ¢çŸ©é˜µ</span></span><br><span class="line">    T = get_translation_matrix(t)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> invert:</span><br><span class="line">        <span class="comment"># å¦‚æœéœ€è¦åè½¬ï¼Œå…ˆæ—‹è½¬å†å¹³ç§»</span></span><br><span class="line">        M = torch.matmul(R, T)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># æ­£å¸¸æƒ…å†µä¸‹ï¼Œå…ˆå¹³ç§»å†æ—‹è½¬</span></span><br><span class="line">        M = torch.matmul(T, R)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> M</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†å¹³ç§»å‘é‡è½¬æ¢ä¸º 4x4 å˜æ¢çŸ©é˜µ</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_translation_matrix</span>(<span class="params">translation_vector</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å°†å¹³ç§»å‘é‡è½¬æ¢ä¸º 4x4 å˜æ¢çŸ©é˜µ</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># åˆå§‹åŒ–ä¸€ä¸ªå…¨é›¶çš„ 4x4 çŸ©é˜µï¼Œå½¢çŠ¶ä¸º (batch_size, 4, 4)</span></span><br><span class="line">    T = torch.zeros(translation_vector.shape[<span class="number">0</span>], <span class="number">4</span>, <span class="number">4</span>).to(device=translation_vector.device)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å°†å¹³ç§»å‘é‡è°ƒæ•´ä¸º (batch_size, 3, 1) çš„å½¢çŠ¶</span></span><br><span class="line">    t = translation_vector.contiguous().view(-<span class="number">1</span>, <span class="number">3</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è®¾ç½®çŸ©é˜µçš„å¯¹è§’å…ƒç´ ä¸º 1</span></span><br><span class="line">    T[:, <span class="number">0</span>, <span class="number">0</span>] = <span class="number">1</span></span><br><span class="line">    T[:, <span class="number">1</span>, <span class="number">1</span>] = <span class="number">1</span></span><br><span class="line">    T[:, <span class="number">2</span>, <span class="number">2</span>] = <span class="number">1</span></span><br><span class="line">    T[:, <span class="number">3</span>, <span class="number">3</span>] = <span class="number">1</span></span><br><span class="line">    <span class="comment"># å°†å¹³ç§»å‘é‡æ·»åŠ åˆ°çŸ©é˜µçš„æœ€åä¸€åˆ—</span></span><br><span class="line">    T[:, :<span class="number">3</span>, <span class="number">3</span>, <span class="literal">None</span>] = t</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> T</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†è½´è§’æ—‹è½¬è¡¨ç¤ºè½¬æ¢ä¸º 4x4 å˜æ¢çŸ©é˜µ</span></span><br><span class="line"><span class="comment"># ï¼ˆæ”¹ç¼–è‡ª https://github.com/Wallacoloo/printipiï¼‰</span></span><br><span class="line"><span class="comment"># è¾“å…¥ &#x27;vec&#x27; å¿…é¡»æ˜¯ Bx1x3 çš„å½¢çŠ¶</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rot_from_axisangle</span>(<span class="params">vec</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å°†è½´è§’æ—‹è½¬è¡¨ç¤ºè½¬æ¢ä¸º 4x4 å˜æ¢çŸ©é˜µ</span></span><br><span class="line"><span class="string">    ï¼ˆæ”¹ç¼–è‡ª https://github.com/Wallacoloo/printipiï¼‰</span></span><br><span class="line"><span class="string">    è¾“å…¥ &#x27;vec&#x27; å¿…é¡»æ˜¯ Bx1x3 çš„å½¢çŠ¶</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># è®¡ç®—è½´è§’çš„æ¨¡é•¿</span></span><br><span class="line">    angle = torch.norm(vec, <span class="number">2</span>, <span class="number">2</span>, <span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># è®¡ç®—å•ä½è½´å‘é‡</span></span><br><span class="line">    axis = vec / (angle + <span class="number">1e-7</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è®¡ç®—è§’åº¦çš„ä½™å¼¦å€¼</span></span><br><span class="line">    ca = torch.cos(angle)</span><br><span class="line">    <span class="comment"># è®¡ç®—è§’åº¦çš„æ­£å¼¦å€¼</span></span><br><span class="line">    sa = torch.sin(angle)</span><br><span class="line">    <span class="comment"># è®¡ç®— 1 - cos(angle)</span></span><br><span class="line">    C = <span class="number">1</span> - ca</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æå–è½´å‘é‡çš„ x åˆ†é‡ï¼Œå¹¶å¢åŠ ä¸€ä¸ªç»´åº¦</span></span><br><span class="line">    x = axis[..., <span class="number">0</span>].unsqueeze(<span class="number">1</span>)</span><br><span class="line">    <span class="comment"># æå–è½´å‘é‡çš„ y åˆ†é‡ï¼Œå¹¶å¢åŠ ä¸€ä¸ªç»´åº¦</span></span><br><span class="line">    y = axis[..., <span class="number">1</span>].unsqueeze(<span class="number">1</span>)</span><br><span class="line">    <span class="comment"># æå–è½´å‘é‡çš„ z åˆ†é‡ï¼Œå¹¶å¢åŠ ä¸€ä¸ªç»´åº¦</span></span><br><span class="line">    z = axis[..., <span class="number">2</span>].unsqueeze(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è®¡ç®— x * sin(angle)</span></span><br><span class="line">    xs = x * sa</span><br><span class="line">    <span class="comment"># è®¡ç®— y * sin(angle)</span></span><br><span class="line">    ys = y * sa</span><br><span class="line">    <span class="comment"># è®¡ç®— z * sin(angle)</span></span><br><span class="line">    zs = z * sa</span><br><span class="line">    <span class="comment"># è®¡ç®— x * (1 - cos(angle))</span></span><br><span class="line">    xC = x * C</span><br><span class="line">    <span class="comment"># è®¡ç®— y * (1 - cos(angle))</span></span><br><span class="line">    yC = y * C</span><br><span class="line">    <span class="comment"># è®¡ç®— z * (1 - cos(angle))</span></span><br><span class="line">    zC = z * C</span><br><span class="line">    <span class="comment"># è®¡ç®— x * y * (1 - cos(angle))</span></span><br><span class="line">    xyC = x * yC</span><br><span class="line">    <span class="comment"># è®¡ç®— y * z * (1 - cos(angle))</span></span><br><span class="line">    yzC = y * zC</span><br><span class="line">    <span class="comment"># è®¡ç®— z * x * (1 - cos(angle))</span></span><br><span class="line">    zxC = z * xC</span><br><span class="line"></span><br><span class="line">    <span class="comment"># åˆå§‹åŒ–ä¸€ä¸ªå…¨é›¶çš„ 4x4 æ—‹è½¬çŸ©é˜µï¼Œå½¢çŠ¶ä¸º (batch_size, 4, 4)</span></span><br><span class="line">    rot = torch.zeros((vec.shape[<span class="number">0</span>], <span class="number">4</span>, <span class="number">4</span>)).to(device=vec.device)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è®¾ç½®æ—‹è½¬çŸ©é˜µçš„å…ƒç´ </span></span><br><span class="line">    rot[:, <span class="number">0</span>, <span class="number">0</span>] = torch.squeeze(x * xC + ca)</span><br><span class="line">    rot[:, <span class="number">0</span>, <span class="number">1</span>] = torch.squeeze(xyC - zs)</span><br><span class="line">    rot[:, <span class="number">0</span>, <span class="number">2</span>] = torch.squeeze(zxC + ys)</span><br><span class="line">    rot[:, <span class="number">1</span>, <span class="number">0</span>] = torch.squeeze(xyC + zs)</span><br><span class="line">    rot[:, <span class="number">1</span>, <span class="number">1</span>] = torch.squeeze(y * yC + ca)</span><br><span class="line">    rot[:, <span class="number">1</span>, <span class="number">2</span>] = torch.squeeze(yzC - xs)</span><br><span class="line">    rot[:, <span class="number">2</span>, <span class="number">0</span>] = torch.squeeze(zxC - ys)</span><br><span class="line">    rot[:, <span class="number">2</span>, <span class="number">1</span>] = torch.squeeze(yzC + xs)</span><br><span class="line">    rot[:, <span class="number">2</span>, <span class="number">2</span>] = torch.squeeze(z * zC + ca)</span><br><span class="line">    rot[:, <span class="number">3</span>, <span class="number">3</span>] = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rot</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ä¸€ä¸ªå·ç§¯å—ï¼ŒåŒ…å«å·ç§¯å±‚ã€æ‰¹é‡å½’ä¸€åŒ–å±‚å’Œ ELU æ¿€æ´»å‡½æ•°</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ConvBlock</span>(nn.Module):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;æ‰§è¡Œå·ç§¯åæ¥ ELU çš„å±‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, in_channels, out_channels</span>):</span><br><span class="line">        <span class="built_in">super</span>(ConvBlock, <span class="variable language_">self</span>).__init__()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 3x3 å·ç§¯å±‚</span></span><br><span class="line">        <span class="variable language_">self</span>.conv = Conv3x3(in_channels, out_channels)</span><br><span class="line">        <span class="comment"># ELU æ¿€æ´»å‡½æ•°ï¼ŒåŸåœ°æ“ä½œ</span></span><br><span class="line">        <span class="variable language_">self</span>.nonlin = nn.ELU(inplace=<span class="literal">True</span>)</span><br><span class="line">        <span class="comment"># æ‰¹é‡å½’ä¸€åŒ–å±‚</span></span><br><span class="line">        <span class="variable language_">self</span>.bn = nn.BatchNorm2d(out_channels)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        <span class="comment"># é€šè¿‡å·ç§¯å±‚</span></span><br><span class="line">        out = <span class="variable language_">self</span>.conv(x)</span><br><span class="line">        <span class="comment"># é€šè¿‡æ‰¹é‡å½’ä¸€åŒ–å±‚</span></span><br><span class="line">        out = <span class="variable language_">self</span>.bn(out)</span><br><span class="line">        <span class="comment"># é€šè¿‡ ELU æ¿€æ´»å‡½æ•°</span></span><br><span class="line">        out = <span class="variable language_">self</span>.nonlin(out)</span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ä¸€ä¸ª 3x3 å·ç§¯å±‚ï¼ŒåŒ…å«å¡«å……æ“ä½œ</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Conv3x3</span>(nn.Module):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å¯¹è¾“å…¥è¿›è¡Œå¡«å……å’Œå·ç§¯çš„å±‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, in_channels, out_channels, use_refl=<span class="literal">True</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(Conv3x3, <span class="variable language_">self</span>).__init__()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> use_refl:</span><br><span class="line">            <span class="comment"># ä½¿ç”¨åå°„å¡«å……</span></span><br><span class="line">            <span class="variable language_">self</span>.pad = nn.ReflectionPad2d(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># ä½¿ç”¨é›¶å¡«å……</span></span><br><span class="line">            <span class="variable language_">self</span>.pad = nn.ZeroPad2d(<span class="number">1</span>)</span><br><span class="line">        <span class="comment"># 3x3 å·ç§¯å±‚</span></span><br><span class="line">        <span class="variable language_">self</span>.conv = nn.Conv2d(<span class="built_in">int</span>(in_channels), <span class="built_in">int</span>(out_channels), <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        <span class="comment"># è¿›è¡Œå¡«å……æ“ä½œ</span></span><br><span class="line">        out = <span class="variable language_">self</span>.pad(x)</span><br><span class="line">        <span class="comment"># è¿›è¡Œå·ç§¯æ“ä½œ</span></span><br><span class="line">        out = <span class="variable language_">self</span>.conv(out)</span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†æ·±åº¦å›¾åƒè½¬æ¢ä¸ºç‚¹äº‘çš„å±‚</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BackprojectDepth</span>(nn.Module):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å°†æ·±åº¦å›¾åƒè½¬æ¢ä¸ºç‚¹äº‘çš„å±‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, batch_size, height, width</span>):</span><br><span class="line">        <span class="built_in">super</span>(BackprojectDepth, <span class="variable language_">self</span>).__init__()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ‰¹é‡å¤§å°</span></span><br><span class="line">        <span class="variable language_">self</span>.batch_size = batch_size</span><br><span class="line">        <span class="comment"># å›¾åƒé«˜åº¦</span></span><br><span class="line">        <span class="variable language_">self</span>.height = height</span><br><span class="line">        <span class="comment"># å›¾åƒå®½åº¦</span></span><br><span class="line">        <span class="variable language_">self</span>.width = width</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ç”ŸæˆäºŒç»´ç½‘æ ¼åæ ‡</span></span><br><span class="line">        meshgrid = np.meshgrid(<span class="built_in">range</span>(<span class="variable language_">self</span>.width), <span class="built_in">range</span>(<span class="variable language_">self</span>.height), indexing=<span class="string">&#x27;xy&#x27;</span>)</span><br><span class="line">        <span class="comment"># å°†ç½‘æ ¼åæ ‡å †å åœ¨ä¸€èµ·ï¼Œå¹¶è½¬æ¢ä¸º float32 ç±»å‹</span></span><br><span class="line">        <span class="variable language_">self</span>.id_coords = np.stack(meshgrid, axis=<span class="number">0</span>).astype(np.float32)</span><br><span class="line">        <span class="comment"># å°†ç½‘æ ¼åæ ‡è½¬æ¢ä¸º PyTorch å¼ é‡ï¼Œå¹¶è®¾ç½®ä¸ºä¸éœ€è¦æ¢¯åº¦</span></span><br><span class="line">        <span class="variable language_">self</span>.id_coords = nn.Parameter(torch.from_numpy(<span class="variable language_">self</span>.id_coords),</span><br><span class="line">                                      requires_grad=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># åˆå§‹åŒ–ä¸€ä¸ªå…¨ä¸º 1 çš„å¼ é‡ï¼Œå½¢çŠ¶ä¸º (batch_size, 1, height * width)ï¼Œå¹¶è®¾ç½®ä¸ºä¸éœ€è¦æ¢¯åº¦</span></span><br><span class="line">        <span class="variable language_">self</span>.ones = nn.Parameter(torch.ones(<span class="variable language_">self</span>.batch_size, <span class="number">1</span>, <span class="variable language_">self</span>.height * <span class="variable language_">self</span>.width),</span><br><span class="line">                                 requires_grad=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è°ƒæ•´ç½‘æ ¼åæ ‡çš„å½¢çŠ¶ï¼Œå¹¶é‡å¤ batch_size æ¬¡</span></span><br><span class="line">        <span class="variable language_">self</span>.pix_coords = torch.unsqueeze(torch.stack(</span><br><span class="line">            [<span class="variable language_">self</span>.id_coords[<span class="number">0</span>].view(-<span class="number">1</span>), <span class="variable language_">self</span>.id_coords[<span class="number">1</span>].view(-<span class="number">1</span>)], <span class="number">0</span>), <span class="number">0</span>)</span><br><span class="line">        <span class="variable language_">self</span>.pix_coords = <span class="variable language_">self</span>.pix_coords.repeat(batch_size, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="comment"># å°†ç½‘æ ¼åæ ‡å’Œå…¨ 1 å¼ é‡æ‹¼æ¥åœ¨ä¸€èµ·ï¼Œå¹¶è®¾ç½®ä¸ºä¸éœ€è¦æ¢¯åº¦</span></span><br><span class="line">        <span class="variable language_">self</span>.pix_coords = nn.Parameter(torch.cat([<span class="variable language_">self</span>.pix_coords, <span class="variable language_">self</span>.ones], <span class="number">1</span>),</span><br><span class="line">                                       requires_grad=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, depth, inv_K</span>):</span><br><span class="line">        <span class="comment"># å°†é€†ç›¸æœºå†…å‚çŸ©é˜µä¸åƒç´ åæ ‡ç›¸ä¹˜</span></span><br><span class="line">        cam_points = torch.matmul(inv_K[:, :<span class="number">3</span>, :<span class="number">3</span>], <span class="variable language_">self</span>.pix_coords)</span><br><span class="line">        <span class="comment"># å°†æ·±åº¦å€¼ä¸ç›¸æœºåæ ‡ç›¸ä¹˜</span></span><br><span class="line">        cam_points = depth.view(<span class="variable language_">self</span>.batch_size, <span class="number">1</span>, -<span class="number">1</span>) * cam_points</span><br><span class="line">        <span class="comment"># å°†ç›¸æœºåæ ‡å’Œå…¨ 1 å¼ é‡æ‹¼æ¥åœ¨ä¸€èµ·</span></span><br><span class="line">        cam_points = torch.cat([cam_points, <span class="variable language_">self</span>.ones], <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> cam_points</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°† 3D ç‚¹æŠ•å½±åˆ°å…·æœ‰å†…å‚ K å’Œä½ç½® T çš„ç›¸æœºä¸­çš„å±‚</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Project3D</span>(nn.Module):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å°† 3D ç‚¹æŠ•å½±åˆ°å…·æœ‰å†…å‚ K å’Œä½ç½® T çš„ç›¸æœºä¸­çš„å±‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, batch_size, height, width, eps=<span class="number">1e-7</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(Project3D, <span class="variable language_">self</span>).__init__()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ‰¹é‡å¤§å°</span></span><br><span class="line">        <span class="variable language_">self</span>.batch_size = batch_size</span><br><span class="line">        <span class="comment"># å›¾åƒé«˜åº¦</span></span><br><span class="line">        <span class="variable language_">self</span>.height = height</span><br><span class="line">        <span class="comment"># å›¾åƒå®½åº¦</span></span><br><span class="line">        <span class="variable language_">self</span>.width = width</span><br><span class="line">        <span class="comment"># é˜²æ­¢é™¤é›¶çš„å°å¸¸æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.eps = eps</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, points, K, T</span>):</span><br><span class="line">        <span class="comment"># è®¡ç®—æŠ•å½±çŸ©é˜µ P</span></span><br><span class="line">        P = torch.matmul(K, T)[:, :<span class="number">3</span>, :]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å°†æŠ•å½±çŸ©é˜µ P ä¸ 3D ç‚¹ç›¸ä¹˜</span></span><br><span class="line">        cam_points = torch.matmul(P, points)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è®¡ç®—åƒç´ åæ ‡</span></span><br><span class="line">        pix_coords = cam_points[:, :<span class="number">2</span>, :] / (cam_points[:, <span class="number">2</span>, :].unsqueeze(<span class="number">1</span>) + <span class="variable language_">self</span>.eps)</span><br><span class="line">        <span class="comment"># è°ƒæ•´åƒç´ åæ ‡çš„å½¢çŠ¶</span></span><br><span class="line">        pix_coords = pix_coords.view(<span class="variable language_">self</span>.batch_size, <span class="number">2</span>, <span class="variable language_">self</span>.height, <span class="variable language_">self</span>.width)</span><br><span class="line">        <span class="comment"># äº¤æ¢ç»´åº¦</span></span><br><span class="line">        pix_coords = pix_coords.permute(<span class="number">0</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="comment"># å½’ä¸€åŒ–åƒç´ åæ ‡</span></span><br><span class="line">        pix_coords[..., <span class="number">0</span>] /= <span class="variable language_">self</span>.width - <span class="number">1</span></span><br><span class="line">        pix_coords[..., <span class="number">1</span>] /= <span class="variable language_">self</span>.height - <span class="number">1</span></span><br><span class="line">        <span class="comment"># å°†åƒç´ åæ ‡æ˜ å°„åˆ° [-1, 1] èŒƒå›´</span></span><br><span class="line">        pix_coords = (pix_coords - <span class="number">0.5</span>) * <span class="number">2</span></span><br><span class="line">        <span class="keyword">return</span> pix_coords</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†è¾“å…¥å¼ é‡ä¸Šé‡‡æ · 2 å€</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upsample</span>(<span class="params">x</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å°†è¾“å…¥å¼ é‡ä¸Šé‡‡æ · 2 å€</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> F.interpolate(x, scale_factor=<span class="number">2</span>, mode=<span class="string">&quot;nearest&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¡ç®—è§†å·®å›¾åƒçš„å¹³æ»‘æŸå¤±</span></span><br><span class="line"><span class="comment"># å½©è‰²å›¾åƒç”¨äºè¾¹ç¼˜æ„ŸçŸ¥å¹³æ»‘</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_smooth_loss</span>(<span class="params">disp, img</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;è®¡ç®—è§†å·®å›¾åƒçš„å¹³æ»‘æŸå¤±</span></span><br><span class="line"><span class="string">    å½©è‰²å›¾åƒç”¨äºè¾¹ç¼˜æ„ŸçŸ¥å¹³æ»‘</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># è®¡ç®—è§†å·®åœ¨ x æ–¹å‘çš„æ¢¯åº¦</span></span><br><span class="line">    grad_disp_x = torch.<span class="built_in">abs</span>(disp[:, :, :, :-<span class="number">1</span>] - disp[:, :, :, <span class="number">1</span>:])</span><br><span class="line">    <span class="comment"># è®¡ç®—è§†å·®åœ¨ y æ–¹å‘çš„æ¢¯åº¦</span></span><br><span class="line">    grad_disp_y = torch.<span class="built_in">abs</span>(disp[:, :, :-<span class="number">1</span>, :] - disp[:, :, <span class="number">1</span>:, :])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è®¡ç®—å›¾åƒåœ¨ x æ–¹å‘çš„å¹³å‡æ¢¯åº¦</span></span><br><span class="line">    grad_img_x = torch.mean(torch.<span class="built_in">abs</span>(img[:, :, :, :-<span class="number">1</span>] - img[:, :, :, <span class="number">1</span>:]), <span class="number">1</span>, keepdim=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># è®¡ç®—å›¾åƒåœ¨ y æ–¹å‘çš„å¹³å‡æ¢¯åº¦</span></span><br><span class="line">    grad_img_y = torch.mean(torch.<span class="built_in">abs</span>(img[:, :, :-<span class="number">1</span>, :] - img[:, :, <span class="number">1</span>:, :]), <span class="number">1</span>, keepdim=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ ¹æ®å›¾åƒæ¢¯åº¦å¯¹è§†å·®æ¢¯åº¦è¿›è¡ŒåŠ æƒ</span></span><br><span class="line">    grad_disp_x *= torch.exp(-grad_img_x)</span><br><span class="line">    grad_disp_y *= torch.exp(-grad_img_y)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è¿”å›è§†å·®æ¢¯åº¦çš„å¹³å‡å€¼</span></span><br><span class="line">    <span class="keyword">return</span> grad_disp_x.mean() + grad_disp_y.mean()</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¡ç®—ä¸€å¯¹å›¾åƒä¹‹é—´ SSIM æŸå¤±çš„å±‚</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SSIM</span>(nn.Module):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;è®¡ç®—ä¸€å¯¹å›¾åƒä¹‹é—´ SSIM æŸå¤±çš„å±‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>(SSIM, <span class="variable language_">self</span>).__init__()</span><br><span class="line">        <span class="comment"># 3x3 å¹³å‡æ± åŒ–å±‚ï¼Œç”¨äºè®¡ç®—å‡å€¼</span></span><br><span class="line">        <span class="variable language_">self</span>.mu_x_pool   = nn.AvgPool2d(<span class="number">3</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="variable language_">self</span>.mu_y_pool   = nn.AvgPool2d(<span class="number">3</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="comment"># 3x3 å¹³å‡æ± åŒ–å±‚ï¼Œç”¨äºè®¡ç®—æ–¹å·®</span></span><br><span class="line">        <span class="variable language_">self</span>.sig_x_pool  = nn.AvgPool2d(<span class="number">3</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="variable language_">self</span>.sig_y_pool  = nn.AvgPool2d(<span class="number">3</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="comment"># 3x3 å¹³å‡æ± åŒ–å±‚ï¼Œç”¨äºè®¡ç®—åæ–¹å·®</span></span><br><span class="line">        <span class="variable language_">self</span>.sig_xy_pool = nn.AvgPool2d(<span class="number">3</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># åå°„å¡«å……å±‚</span></span><br><span class="line">        <span class="variable language_">self</span>.refl = nn.ReflectionPad2d(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å¸¸æ•° C1</span></span><br><span class="line">        <span class="variable language_">self</span>.C1 = <span class="number">0.01</span> ** <span class="number">2</span></span><br><span class="line">        <span class="comment"># å¸¸æ•° C2</span></span><br><span class="line">        <span class="variable language_">self</span>.C2 = <span class="number">0.03</span> ** <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x, y</span>):</span><br><span class="line">        <span class="comment"># å¯¹è¾“å…¥å›¾åƒè¿›è¡Œåå°„å¡«å……</span></span><br><span class="line">        x = <span class="variable language_">self</span>.refl(x)</span><br><span class="line">        y = <span class="variable language_">self</span>.refl(y)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è®¡ç®—å›¾åƒ x çš„å‡å€¼</span></span><br><span class="line">        mu_x = <span class="variable language_">self</span>.mu_x_pool(x)</span><br><span class="line">        <span class="comment"># è®¡ç®—å›¾åƒ y çš„å‡å€¼</span></span><br><span class="line">        mu_y = <span class="variable language_">self</span>.mu_y_pool(y)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è®¡ç®—å›¾åƒ x çš„æ–¹å·®</span></span><br><span class="line">        sigma_x  = <span class="variable language_">self</span>.sig_x_pool(x ** <span class="number">2</span>) - mu_x ** <span class="number">2</span></span><br><span class="line">        <span class="comment"># è®¡ç®—å›¾åƒ y çš„æ–¹å·®</span></span><br><span class="line">        sigma_y  = <span class="variable language_">self</span>.sig_y_pool(y ** <span class="number">2</span>) - mu_y ** <span class="number">2</span></span><br><span class="line">        <span class="comment"># è®¡ç®—å›¾åƒ x å’Œ y çš„åæ–¹å·®</span></span><br><span class="line">        sigma_xy = <span class="variable language_">self</span>.sig_xy_pool(x * y) - mu_x * mu_y</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è®¡ç®— SSIM åˆ†å­</span></span><br><span class="line">        SSIM_n = (<span class="number">2</span> * mu_x * mu_y + <span class="variable language_">self</span>.C1) * (<span class="number">2</span> * sigma_xy + <span class="variable language_">self</span>.C2)</span><br><span class="line">        <span class="comment"># è®¡ç®— SSIM åˆ†æ¯</span></span><br><span class="line">        SSIM_d = (mu_x ** <span class="number">2</span> + mu_y ** <span class="number">2</span> + <span class="variable language_">self</span>.C1) * (sigma_x + sigma_y + <span class="variable language_">self</span>.C2)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è®¡ç®— SSIM æŸå¤±ï¼Œå¹¶å°†ç»“æœé™åˆ¶åœ¨ [0, 1] èŒƒå›´å†…</span></span><br><span class="line">        <span class="keyword">return</span> torch.clamp((<span class="number">1</span> - SSIM_n / SSIM_d) / <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¡ç®—é¢„æµ‹æ·±åº¦å’ŒçœŸå®æ·±åº¦ä¹‹é—´çš„è¯¯å·®æŒ‡æ ‡</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">compute_depth_errors</span>(<span class="params">gt, pred</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;è®¡ç®—é¢„æµ‹æ·±åº¦å’ŒçœŸå®æ·±åº¦ä¹‹é—´çš„è¯¯å·®æŒ‡æ ‡</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># è®¡ç®—é¢„æµ‹æ·±åº¦å’ŒçœŸå®æ·±åº¦çš„æ¯”å€¼çš„æœ€å¤§å€¼</span></span><br><span class="line">    thresh = torch.<span class="built_in">max</span>((gt / pred), (pred / gt))</span><br><span class="line">    <span class="comment"># è®¡ç®—é˜ˆå€¼å°äº 1.25 çš„æ¯”ä¾‹</span></span><br><span class="line">    a1 = (thresh &lt; <span class="number">1.25</span>     ).<span class="built_in">float</span>().mean()</span><br><span class="line">    <span class="comment"># è®¡ç®—é˜ˆå€¼å°äº 1.25^2 çš„æ¯”ä¾‹</span></span><br><span class="line">    a2 = (thresh &lt; <span class="number">1.25</span> ** <span class="number">2</span>).<span class="built_in">float</span>().mean()</span><br><span class="line">    <span class="comment"># è®¡ç®—é˜ˆå€¼å°äº 1.25^3 çš„æ¯”ä¾‹</span></span><br><span class="line">    a3 = (thresh &lt; <span class="number">1.25</span> ** <span class="number">3</span>).<span class="built_in">float</span>().mean()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è®¡ç®—å‡æ–¹è¯¯å·®</span></span><br><span class="line">    rmse = (gt - pred) ** <span class="number">2</span></span><br><span class="line">    rmse = torch.sqrt(rmse.mean())</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è®¡ç®—å¯¹æ•°å‡æ–¹è¯¯å·®</span></span><br><span class="line">    rmse_log = (torch.log(gt) - torch.log(pred)) ** <span class="number">2</span></span><br><span class="line">    rmse_log = torch.sqrt(rmse_log.mean())</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è®¡ç®—ç»å¯¹ç›¸å¯¹è¯¯å·®</span></span><br><span class="line">    abs_rel = torch.mean(torch.<span class="built_in">abs</span>(gt - pred) / gt)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è®¡ç®—å¹³æ–¹ç›¸å¯¹è¯¯å·®</span></span><br><span class="line">    sq_rel = torch.mean((gt - pred) ** <span class="number">2</span> / gt)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> abs_rel, sq_rel, rmse, rmse_log, a</span><br></pre></td></tr></table></figure>

<h4 id="nerf-feature-py"><a href="#nerf-feature-py" class="headerlink" title="nerf_feature.py"></a>nerf_feature.py</h4><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.nn.parallel</span><br><span class="line"><span class="keyword">import</span> torch.utils.data</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ä¸€ä¸ªåä¸º NerfWFeatures çš„ç¥ç»ç½‘ç»œæ¨¡å—</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NerfWFeatures</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, pos_in_dims, dir_in_dims, D</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        :param pos_in_dims: æ ‡é‡ï¼Œç¼–ç åä½ç½®çš„é€šé“æ•°</span></span><br><span class="line"><span class="string">        :param dir_in_dims: æ ‡é‡ï¼Œç¼–ç åæ–¹å‘çš„é€šé“æ•°</span></span><br><span class="line"><span class="string">        :param D:           æ ‡é‡ï¼Œéšè—å±‚çš„ç»´åº¦æ•°</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># è°ƒç”¨çˆ¶ç±» nn.Module çš„æ„é€ å‡½æ•°</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å­˜å‚¨ç¼–ç åä½ç½®çš„é€šé“æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.pos_in_dims = pos_in_dims</span><br><span class="line">        <span class="comment"># å­˜å‚¨ç¼–ç åæ–¹å‘çš„é€šé“æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.dir_in_dims = dir_in_dims</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å®šä¹‰ç¬¬ä¸€å±‚ç¥ç»ç½‘ç»œå—ï¼ŒåŒ…å«å››ä¸ªçº¿æ€§å±‚å’Œ ReLU æ¿€æ´»å‡½æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.layers0 = nn.Sequential(</span><br><span class="line">            nn.Linear(pos_in_dims, D), nn.ReLU(),</span><br><span class="line">            nn.Linear(D, D), nn.ReLU(),</span><br><span class="line">            nn.Linear(D, D), nn.ReLU(),</span><br><span class="line">            nn.Linear(D, D), nn.ReLU(),</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å®šä¹‰ç¬¬äºŒå±‚ç¥ç»ç½‘ç»œå—ï¼ŒåŒ…å«å››ä¸ªçº¿æ€§å±‚å’Œ ReLU æ¿€æ´»å‡½æ•°ï¼Œæœ‰ä¸€ä¸ªè·³è·ƒè¿æ¥</span></span><br><span class="line">        <span class="variable language_">self</span>.layers1 = nn.Sequential(</span><br><span class="line">            nn.Linear(D + pos_in_dims + <span class="number">32</span>, D), nn.ReLU(),  <span class="comment"># è·³è·ƒè¿æ¥</span></span><br><span class="line">            nn.Linear(D, D), nn.ReLU(),</span><br><span class="line">            nn.Linear(D, D), nn.ReLU(),</span><br><span class="line">            nn.Linear(D, D), nn.ReLU(),</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å®šä¹‰ç”¨äºè®¡ç®—å¯†åº¦çš„å…¨è¿æ¥å±‚ï¼Œæœ€åä½¿ç”¨ Softplus æ¿€æ´»å‡½æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.fc_density = nn.Sequential(</span><br><span class="line">            nn.Linear(D, <span class="number">1</span>), nn.Softplus()</span><br><span class="line">        )</span><br><span class="line">        <span class="comment"># å®šä¹‰ç”¨äºæå–ç‰¹å¾çš„å…¨è¿æ¥å±‚</span></span><br><span class="line">        <span class="variable language_">self</span>.fc_feature = nn.Sequential(</span><br><span class="line">            nn.Linear(D, D)</span><br><span class="line">        )</span><br><span class="line">        <span class="comment"># å®šä¹‰ç”¨äºå¤„ç†ç‰¹å¾å’Œæ–¹å‘ä¿¡æ¯ä»¥ç”Ÿæˆä¸­é—´ç‰¹å¾çš„å±‚</span></span><br><span class="line">        <span class="variable language_">self</span>.rgb_layers = nn.Sequential(nn.Linear(D + dir_in_dims, D // <span class="number">2</span>), nn.ReLU())</span><br><span class="line">        <span class="comment"># å®šä¹‰ç”¨äºä»ä¸­é—´ç‰¹å¾ç”Ÿæˆ RGB é¢œè‰²çš„å…¨è¿æ¥å±‚</span></span><br><span class="line">        <span class="variable language_">self</span>.fc_rgb = nn.Sequential(nn.Linear(D // <span class="number">2</span>, <span class="number">3</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ä»¥ä¸‹ä»£ç è¢«æ³¨é‡Šæ‰ï¼ŒåŸæœ¬ç”¨äºåˆå§‹åŒ–åç½®</span></span><br><span class="line">        <span class="comment"># self.fc_density[0].bias.data = torch.tensor([0.1]).float()</span></span><br><span class="line">        <span class="comment"># self.fc_rgb[0].bias.data = torch.tensor([0.02, 0.02, 0.02]).float()</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, pos_enc, dir_enc, cost_volume</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        :param pos_enc: (H, W, N_sample, pos_in_dims) ç¼–ç åçš„ä½ç½®</span></span><br><span class="line"><span class="string">        :param dir_enc: (H, W, N_sample, dir_in_dims) ç¼–ç åçš„æ–¹å‘</span></span><br><span class="line"><span class="string">        :return: rgb_density (H, W, N_sample, 4)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># é€šè¿‡ç¬¬ä¸€å±‚ç¥ç»ç½‘ç»œå—å¤„ç†ç¼–ç åçš„ä½ç½®</span></span><br><span class="line">        x = <span class="variable language_">self</span>.layers0(pos_enc)  <span class="comment"># (H, W, N_sample, D)</span></span><br><span class="line">        <span class="comment"># å°†å¤„ç†åçš„ç»“æœã€åŸå§‹ç¼–ç ä½ç½®å’Œä»£ä»·ä½“è¿›è¡Œæ‹¼æ¥</span></span><br><span class="line">        x = torch.cat([x, pos_enc, cost_volume], dim=<span class="number">3</span>)  <span class="comment"># (H, W, N_sample, D+pos_in_dims)</span></span><br><span class="line">        <span class="comment"># é€šè¿‡ç¬¬äºŒå±‚ç¥ç»ç½‘ç»œå—å¤„ç†æ‹¼æ¥åçš„ç»“æœ</span></span><br><span class="line">        x = <span class="variable language_">self</span>.layers1(x)  <span class="comment"># (H, W, N_sample, D)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># è®¡ç®—å¯†åº¦</span></span><br><span class="line">        density = <span class="variable language_">self</span>.fc_density(x)  <span class="comment"># (H, W, N_sample, 1)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># æå–ç‰¹å¾</span></span><br><span class="line">        feat = <span class="variable language_">self</span>.fc_feature(x)  <span class="comment"># (H, W, N_sample, D)</span></span><br><span class="line">        <span class="comment"># å°†æå–çš„ç‰¹å¾å’Œç¼–ç åçš„æ–¹å‘è¿›è¡Œæ‹¼æ¥</span></span><br><span class="line">        x = torch.cat([feat, dir_enc], dim=<span class="number">3</span>)  <span class="comment"># (H, W, N_sample, D+dir_in_dims)</span></span><br><span class="line">        <span class="comment"># é€šè¿‡ rgb_layers å±‚å¤„ç†æ‹¼æ¥åçš„ç»“æœ</span></span><br><span class="line">        x = <span class="variable language_">self</span>.rgb_layers(x)  <span class="comment"># (H, W, N_sample, D/2)</span></span><br><span class="line">        <span class="comment"># ç”Ÿæˆ RGB é¢œè‰²</span></span><br><span class="line">        rgb = <span class="variable language_">self</span>.fc_rgb(x)  <span class="comment"># (H, W, N_sample, 3)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># å°† RGB é¢œè‰²å’Œå¯†åº¦è¿›è¡Œæ‹¼æ¥</span></span><br><span class="line">        rgb_den = torch.cat([rgb, density], dim=<span class="number">3</span>)  <span class="comment"># (H, W, N_sample, 4)</span></span><br><span class="line">        <span class="keyword">return</span> rgb_den</span><br></pre></td></tr></table></figure>

<h4 id="nerf-mask-py"><a href="#nerf-mask-py" class="headerlink" title="nerf_mask.py"></a>nerf_mask.py</h4><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.nn.parallel</span><br><span class="line"><span class="keyword">import</span> torch.utils.data</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ä¸€ä¸ªåä¸º OfficialNerf çš„ç¥ç»ç½‘ç»œæ¨¡å—ï¼Œç»§æ‰¿è‡ª nn.Module</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OfficialNerf</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, pos_in_dims, dir_in_dims, D</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        :param pos_in_dims: æ ‡é‡ï¼Œç¼–ç åä½ç½®çš„é€šé“æ•°</span></span><br><span class="line"><span class="string">        :param dir_in_dims: æ ‡é‡ï¼Œç¼–ç åæ–¹å‘çš„é€šé“æ•°</span></span><br><span class="line"><span class="string">        :param D: æ ‡é‡ï¼Œéšè—å±‚çš„ç»´åº¦æ•°</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># è°ƒç”¨çˆ¶ç±»çš„æ„é€ å‡½æ•°</span></span><br><span class="line">        <span class="built_in">super</span>(OfficialNerf, <span class="variable language_">self</span>).__init__()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å­˜å‚¨ç¼–ç åä½ç½®çš„é€šé“æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.pos_in_dims = pos_in_dims</span><br><span class="line">        <span class="comment"># å­˜å‚¨ç¼–ç åæ–¹å‘çš„é€šé“æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.dir_in_dims = dir_in_dims</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å®šä¹‰ç¬¬ä¸€å±‚ç¥ç»ç½‘ç»œåºåˆ—ï¼ŒåŒ…å«å››ä¸ªçº¿æ€§å±‚å’Œ ReLU æ¿€æ´»å‡½æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.layers0 = nn.Sequential(</span><br><span class="line">            nn.Linear(pos_in_dims, D), nn.ReLU(),</span><br><span class="line">            nn.Linear(D, D), nn.ReLU(),</span><br><span class="line">            nn.Linear(D, D), nn.ReLU(),</span><br><span class="line">            nn.Linear(D, D), nn.ReLU(),</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å®šä¹‰ç¬¬äºŒå±‚ç¥ç»ç½‘ç»œåºåˆ—ï¼ŒåŒ…å«å››ä¸ªçº¿æ€§å±‚å’Œ ReLU æ¿€æ´»å‡½æ•°ï¼Œæœ‰ä¸€ä¸ªè·³è·ƒè¿æ¥</span></span><br><span class="line">        <span class="variable language_">self</span>.layers1 = nn.Sequential(</span><br><span class="line">            nn.Linear(D + pos_in_dims, D), nn.ReLU(),  <span class="comment"># è·³è·ƒè¿æ¥</span></span><br><span class="line">            nn.Linear(D, D), nn.ReLU(),</span><br><span class="line">            nn.Linear(D, D), nn.ReLU(),</span><br><span class="line">            nn.Linear(D, D), nn.ReLU(),</span><br><span class="line">        )</span><br><span class="line">        <span class="comment"># å®šä¹‰æ©ç ç½‘ç»œï¼ŒåŒ…å«ä¸¤ä¸ªçº¿æ€§å±‚ï¼Œä¸­é—´æœ‰ ReLU æ¿€æ´»å‡½æ•°ï¼Œæœ€åæœ‰ Sigmoid æ¿€æ´»å‡½æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.mask_net = nn.Sequential(nn.Linear(D, D), nn.ReLU(), nn.Linear(D, <span class="number">1</span>), nn.Sigmoid())</span><br><span class="line">        <span class="comment"># å®šä¹‰å¯†åº¦é¢„æµ‹ç½‘ç»œï¼ŒåŒ…å«ä¸€ä¸ªçº¿æ€§å±‚å’Œ Softplus æ¿€æ´»å‡½æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.fc_density = nn.Sequential(nn.Linear(D, <span class="number">1</span>), nn.Softplus())</span><br><span class="line">        <span class="comment"># å®šä¹‰ç‰¹å¾æå–çš„çº¿æ€§å±‚</span></span><br><span class="line">        <span class="variable language_">self</span>.fc_feature = nn.Linear(D, D)</span><br><span class="line">        <span class="comment"># å®šä¹‰ RGB å¤„ç†çš„ç¥ç»ç½‘ç»œåºåˆ—ï¼ŒåŒ…å«ä¸€ä¸ªçº¿æ€§å±‚å’Œ ReLU æ¿€æ´»å‡½æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.rgb_layers = nn.Sequential(nn.Linear(D + dir_in_dims, D // <span class="number">2</span>), nn.ReLU())</span><br><span class="line">        <span class="comment"># å®šä¹‰ RGB é¢„æµ‹çš„ç¥ç»ç½‘ç»œåºåˆ—ï¼ŒåŒ…å«ä¸€ä¸ªçº¿æ€§å±‚</span></span><br><span class="line">        <span class="variable language_">self</span>.fc_rgb = nn.Sequential(nn.Linear(D // <span class="number">2</span>, <span class="number">3</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ä»¥ä¸‹ä»£ç è¢«æ³¨é‡Šæ‰ï¼ŒåŸæœ¬ç”¨äºåˆå§‹åŒ–åç½®</span></span><br><span class="line">        <span class="comment"># self.fc_density[0].bias.data = torch.tensor([0.1]).float()</span></span><br><span class="line">        <span class="comment"># self.fc_rgb[0].bias.data = torch.tensor([0.02, 0.02, 0.02]).float()</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, pos_enc, dir_enc</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        :param pos_enc: (H, W, N_sample, pos_in_dims) ç¼–ç åçš„ä½ç½®</span></span><br><span class="line"><span class="string">        :param dir_enc: (H, W, N_sample, dir_in_dims) ç¼–ç åçš„æ–¹å‘</span></span><br><span class="line"><span class="string">        :return: rgb_density (H, W, N_sample, 4)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># é€šè¿‡ç¬¬ä¸€å±‚ç¥ç»ç½‘ç»œåºåˆ—å¤„ç†ç¼–ç åçš„ä½ç½®</span></span><br><span class="line">        x = <span class="variable language_">self</span>.layers0(pos_enc)  <span class="comment"># è¾“å‡ºå½¢çŠ¶ä¸º (H, W, N_sample, D)</span></span><br><span class="line">        <span class="comment"># å°†å¤„ç†åçš„ç»“æœå’ŒåŸå§‹ç¼–ç ä½ç½®åœ¨ç¬¬ 3 ç»´æ‹¼æ¥</span></span><br><span class="line">        x = torch.cat([x, pos_enc], dim=<span class="number">3</span>)  <span class="comment"># è¾“å‡ºå½¢çŠ¶ä¸º (H, W, N_sample, D + pos_in_dims)</span></span><br><span class="line">        <span class="comment"># é€šè¿‡ç¬¬äºŒå±‚ç¥ç»ç½‘ç»œåºåˆ—å¤„ç†æ‹¼æ¥åçš„ç»“æœ</span></span><br><span class="line">        x = <span class="variable language_">self</span>.layers1(x)  <span class="comment"># è¾“å‡ºå½¢çŠ¶ä¸º (H, W, N_sample, D)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># é€šè¿‡æ©ç ç½‘ç»œå¾—åˆ°æ©ç æ¦‚ç‡</span></span><br><span class="line">        mask_prob = <span class="variable language_">self</span>.mask_net(x)</span><br><span class="line">        <span class="comment"># é€šè¿‡å¯†åº¦é¢„æµ‹ç½‘ç»œå¾—åˆ°å¯†åº¦</span></span><br><span class="line">        density = <span class="variable language_">self</span>.fc_density(x)  <span class="comment"># è¾“å‡ºå½¢çŠ¶ä¸º (H, W, N_sample, 1)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># é€šè¿‡ç‰¹å¾æå–çº¿æ€§å±‚å¾—åˆ°ç‰¹å¾</span></span><br><span class="line">        feat = <span class="variable language_">self</span>.fc_feature(x)  <span class="comment"># è¾“å‡ºå½¢çŠ¶ä¸º (H, W, N_sample, D)</span></span><br><span class="line">        <span class="comment"># å°†ç‰¹å¾å’Œç¼–ç åçš„æ–¹å‘åœ¨ç¬¬ 3 ç»´æ‹¼æ¥</span></span><br><span class="line">        x = torch.cat([feat, dir_enc], dim=<span class="number">3</span>)  <span class="comment"># è¾“å‡ºå½¢çŠ¶ä¸º (H, W, N_sample, D + dir_in_dims)</span></span><br><span class="line">        <span class="comment"># é€šè¿‡ RGB å¤„ç†ç¥ç»ç½‘ç»œåºåˆ—å¤„ç†æ‹¼æ¥åçš„ç»“æœ</span></span><br><span class="line">        x = <span class="variable language_">self</span>.rgb_layers(x)  <span class="comment"># è¾“å‡ºå½¢çŠ¶ä¸º (H, W, N_sample, D / 2)</span></span><br><span class="line">        <span class="comment"># é€šè¿‡ RGB é¢„æµ‹ç¥ç»ç½‘ç»œåºåˆ—å¾—åˆ° RGB å€¼</span></span><br><span class="line">        rgb = <span class="variable language_">self</span>.fc_rgb(x)  <span class="comment"># è¾“å‡ºå½¢çŠ¶ä¸º (H, W, N_sample, 3)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># å°† RGB å€¼ã€å¯†åº¦å’Œæ©ç æ¦‚ç‡åœ¨ç¬¬3ç»´æ‹¼æ¥</span></span><br><span class="line">        rgb_den = torch.cat([rgb, density, mask_prob], dim=<span class="number">3</span>)  <span class="comment"># è¾“å‡ºå½¢çŠ¶ä¸º (H, W, N_sample, 4)</span></span><br><span class="line">        <span class="keyword">return</span> rgb_den</span><br></pre></td></tr></table></figure>

<h4 id="nerf-models-py"><a href="#nerf-models-py" class="headerlink" title="nerf_models.py"></a>nerf_models.py</h4><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.nn.parallel</span><br><span class="line"><span class="keyword">import</span> torch.utils.data</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ OfficialNerf ç±»ï¼Œç»§æ‰¿è‡ª nn.Moduleï¼Œç”¨äºå®ç°å®˜æ–¹çš„ NeRF æ¨¡å‹</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OfficialNerf</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, pos_in_dims, dir_in_dims, D</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        :param pos_in_dims: æ ‡é‡ï¼Œç¼–ç åä½ç½®çš„é€šé“æ•°</span></span><br><span class="line"><span class="string">        :param dir_in_dims: æ ‡é‡ï¼Œç¼–ç åæ–¹å‘çš„é€šé“æ•°</span></span><br><span class="line"><span class="string">        :param D: æ ‡é‡ï¼Œéšè—å±‚çš„ç»´åº¦æ•°</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># è°ƒç”¨çˆ¶ç±»çš„æ„é€ å‡½æ•°</span></span><br><span class="line">        <span class="built_in">super</span>(OfficialNerf, <span class="variable language_">self</span>).__init__()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å­˜å‚¨ç¼–ç åä½ç½®çš„é€šé“æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.pos_in_dims = pos_in_dims</span><br><span class="line">        <span class="comment"># å­˜å‚¨ç¼–ç åæ–¹å‘çš„é€šé“æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.dir_in_dims = dir_in_dims</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å®šä¹‰ç¬¬ä¸€å±‚ç¥ç»ç½‘ç»œåºåˆ—ï¼ŒåŒ…å«å››ä¸ªçº¿æ€§å±‚å’Œ ReLU æ¿€æ´»å‡½æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.layers0 = nn.Sequential(</span><br><span class="line">            nn.Linear(pos_in_dims, D), nn.ReLU(),</span><br><span class="line">            nn.Linear(D, D), nn.ReLU(),</span><br><span class="line">            nn.Linear(D, D), nn.ReLU(),</span><br><span class="line">            nn.Linear(D, D), nn.ReLU(),</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å®šä¹‰ç¬¬äºŒå±‚ç¥ç»ç½‘ç»œåºåˆ—ï¼ŒåŒ…å«å››ä¸ªçº¿æ€§å±‚å’Œ ReLU æ¿€æ´»å‡½æ•°ï¼Œæœ‰ä¸€ä¸ªè·³è·ƒè¿æ¥</span></span><br><span class="line">        <span class="variable language_">self</span>.layers1 = nn.Sequential(</span><br><span class="line">            nn.Linear(D + pos_in_dims, D), nn.ReLU(),  <span class="comment"># è·³è·ƒè¿æ¥</span></span><br><span class="line">            nn.Linear(D, D), nn.ReLU(),</span><br><span class="line">            nn.Linear(D, D), nn.ReLU(),</span><br><span class="line">            nn.Linear(D, D), nn.ReLU(),</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å®šä¹‰å¯†åº¦é¢„æµ‹ç½‘ç»œï¼ŒåŒ…å«ä¸€ä¸ªçº¿æ€§å±‚å’Œ Softplus æ¿€æ´»å‡½æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.fc_density = nn.Sequential(nn.Linear(D, <span class="number">1</span>), nn.Softplus())</span><br><span class="line">        <span class="comment"># å®šä¹‰ç‰¹å¾æå–çš„çº¿æ€§å±‚</span></span><br><span class="line">        <span class="variable language_">self</span>.fc_feature = nn.Linear(D, D)</span><br><span class="line">        <span class="comment"># å®šä¹‰ RGB å¤„ç†çš„ç¥ç»ç½‘ç»œåºåˆ—ï¼ŒåŒ…å«ä¸€ä¸ªçº¿æ€§å±‚å’Œ ReLU æ¿€æ´»å‡½æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.rgb_layers = nn.Sequential(nn.Linear(D + dir_in_dims, D // <span class="number">2</span>), nn.ReLU())</span><br><span class="line">        <span class="comment"># å®šä¹‰ RGB é¢„æµ‹çš„ç¥ç»ç½‘ç»œåºåˆ—ï¼ŒåŒ…å«ä¸€ä¸ªçº¿æ€§å±‚</span></span><br><span class="line">        <span class="variable language_">self</span>.fc_rgb = nn.Sequential(nn.Linear(D // <span class="number">2</span>, <span class="number">3</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ä»¥ä¸‹ä»£ç è¢«æ³¨é‡Šæ‰ï¼ŒåŸæœ¬ç”¨äºåˆå§‹åŒ–åç½®</span></span><br><span class="line">        <span class="comment"># self.fc_density[0].bias.data = torch.tensor([0.1]).float()</span></span><br><span class="line">        <span class="comment"># self.fc_rgb[0].bias.data = torch.tensor([0.02, 0.02, 0.02]).float()</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, pos_enc, dir_enc</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        :param pos_enc: (H, W, N_sample, pos_in_dims) ç¼–ç åçš„ä½ç½®</span></span><br><span class="line"><span class="string">        :param dir_enc: (H, W, N_sample, dir_in_dims) ç¼–ç åçš„æ–¹å‘</span></span><br><span class="line"><span class="string">        :return: rgb_density (H, W, N_sample, 4)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># é€šè¿‡ç¬¬ä¸€å±‚ç¥ç»ç½‘ç»œåºåˆ—å¤„ç†ç¼–ç åçš„ä½ç½®</span></span><br><span class="line">        x = <span class="variable language_">self</span>.layers0(pos_enc)  <span class="comment"># è¾“å‡ºå½¢çŠ¶ä¸º (H, W, N_sample, D)</span></span><br><span class="line">        <span class="comment"># å°†å¤„ç†åçš„ç»“æœå’ŒåŸå§‹ç¼–ç ä½ç½®åœ¨ç¬¬ 3 ç»´æ‹¼æ¥</span></span><br><span class="line">        x = torch.cat([x, pos_enc], dim=<span class="number">3</span>)  <span class="comment"># è¾“å‡ºå½¢çŠ¶ä¸º (H, W, N_sample, D + pos_in_dims)</span></span><br><span class="line">        <span class="comment"># é€šè¿‡ç¬¬äºŒå±‚ç¥ç»ç½‘ç»œåºåˆ—å¤„ç†æ‹¼æ¥åçš„ç»“æœ</span></span><br><span class="line">        x = <span class="variable language_">self</span>.layers1(x)  <span class="comment"># è¾“å‡ºå½¢çŠ¶ä¸º (H, W, N_sample, D)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># é€šè¿‡å¯†åº¦é¢„æµ‹ç½‘ç»œå¾—åˆ°å¯†åº¦</span></span><br><span class="line">        density = <span class="variable language_">self</span>.fc_density(x)  <span class="comment"># è¾“å‡ºå½¢çŠ¶ä¸º (H, W, N_sample, 1)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># é€šè¿‡ç‰¹å¾æå–çº¿æ€§å±‚å¾—åˆ°ç‰¹å¾</span></span><br><span class="line">        feat = <span class="variable language_">self</span>.fc_feature(x)  <span class="comment"># è¾“å‡ºå½¢çŠ¶ä¸º (H, W, N_sample, D)</span></span><br><span class="line">        <span class="comment"># å°†ç‰¹å¾å’Œç¼–ç åçš„æ–¹å‘åœ¨ç¬¬ 3 ç»´æ‹¼æ¥</span></span><br><span class="line">        x = torch.cat([feat, dir_enc], dim=<span class="number">3</span>)  <span class="comment"># è¾“å‡ºå½¢çŠ¶ä¸º (H, W, N_sample, D + dir_in_dims)</span></span><br><span class="line">        <span class="comment"># é€šè¿‡ RGB å¤„ç†ç¥ç»ç½‘ç»œåºåˆ—å¤„ç†æ‹¼æ¥åçš„ç»“æœ</span></span><br><span class="line">        x = <span class="variable language_">self</span>.rgb_layers(x)  <span class="comment"># è¾“å‡ºå½¢çŠ¶ä¸º (H, W, N_sample, D / 2)</span></span><br><span class="line">        <span class="comment"># é€šè¿‡ RGB é¢„æµ‹ç¥ç»ç½‘ç»œåºåˆ—å¾—åˆ° RGB å€¼</span></span><br><span class="line">        rgb = <span class="variable language_">self</span>.fc_rgb(x)  <span class="comment"># è¾“å‡ºå½¢çŠ¶ä¸º (H, W, N_sample, 3)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># å°† RGB å€¼å’Œå¯†åº¦åœ¨ç¬¬ 3 ç»´æ‹¼æ¥</span></span><br><span class="line">        rgb_den = torch.cat([rgb, density], dim=<span class="number">3</span>)  <span class="comment"># è¾“å‡ºå½¢çŠ¶ä¸º (H, W, N_sample, 4)</span></span><br><span class="line">        <span class="keyword">return</span> rgb_den</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ fullNeRF ç±»ï¼Œç»§æ‰¿è‡ª nn.Moduleï¼Œç”¨äºå®ç°å®Œæ•´çš„ NeRF æ¨¡å‹</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">fullNeRF</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, in_channels_xyz, in_channels_dir, W, D=<span class="number">8</span>, skips=[<span class="number">4</span>]</span>):</span><br><span class="line">        <span class="comment"># è°ƒç”¨çˆ¶ç±»çš„æ„é€ å‡½æ•°</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        <span class="comment"># å­˜å‚¨ç½‘ç»œçš„æ·±åº¦</span></span><br><span class="line">        <span class="variable language_">self</span>.D = D</span><br><span class="line">        <span class="comment"># å­˜å‚¨éšè—å±‚çš„å®½åº¦</span></span><br><span class="line">        <span class="variable language_">self</span>.W = W</span><br><span class="line">        <span class="comment"># å­˜å‚¨è·³è·ƒè¿æ¥çš„ä½ç½®</span></span><br><span class="line">        <span class="variable language_">self</span>.skips = skips</span><br><span class="line">        <span class="comment"># å­˜å‚¨è¾“å…¥ä½ç½®ç¼–ç çš„é€šé“æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.in_channels_xyz = in_channels_xyz</span><br><span class="line">        <span class="comment"># å­˜å‚¨è¾“å…¥æ–¹å‘ç¼–ç çš„é€šé“æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.in_channels_dir = in_channels_dir</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å®šä¹‰ä½ç½®ç¼–ç å±‚</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(D):</span><br><span class="line">            <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">                <span class="comment"># ç¬¬ä¸€å±‚ï¼Œè¾“å…¥ç»´åº¦ä¸ºè¾“å…¥ä½ç½®ç¼–ç çš„é€šé“æ•°ï¼Œè¾“å‡ºç»´åº¦ä¸ºéšè—å±‚å®½åº¦</span></span><br><span class="line">                layer = nn.Linear(in_channels_xyz, W)</span><br><span class="line">            <span class="keyword">elif</span> i <span class="keyword">in</span> skips:</span><br><span class="line">                <span class="comment"># è·³è·ƒè¿æ¥å±‚ï¼Œè¾“å…¥ç»´åº¦ä¸ºéšè—å±‚å®½åº¦åŠ ä¸Šè¾“å…¥ä½ç½®ç¼–ç çš„é€šé“æ•°ï¼Œè¾“å‡ºç»´åº¦ä¸ºéšè—å±‚å®½åº¦</span></span><br><span class="line">                layer = nn.Linear(W + in_channels_xyz, W)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># æ™®é€šå±‚ï¼Œè¾“å…¥å’Œè¾“å‡ºç»´åº¦å‡ä¸ºéšè—å±‚å®½åº¦</span></span><br><span class="line">                layer = nn.Linear(W, W)</span><br><span class="line">            <span class="comment"># ä¸ºæ¯ä¸ªå±‚æ·»åŠ  ReLU æ¿€æ´»å‡½æ•°</span></span><br><span class="line">            layer = nn.Sequential(layer, nn.ReLU(<span class="literal">True</span>))</span><br><span class="line">            <span class="comment"># å°†å±‚æ·»åŠ åˆ°æ¨¡å‹ä¸­</span></span><br><span class="line">            <span class="built_in">setattr</span>(<span class="variable language_">self</span>, <span class="string">f&quot;xyz_encoding_<span class="subst">&#123;i + <span class="number">1</span>&#125;</span>&quot;</span>, layer)</span><br><span class="line">        <span class="comment"># å®šä¹‰ä½ç½®ç¼–ç çš„æœ€ç»ˆçº¿æ€§å±‚</span></span><br><span class="line">        <span class="variable language_">self</span>.xyz_encoding_final = nn.Linear(W, W)</span><br><span class="line">        <span class="comment"># å®šä¹‰æ–¹å‘ç¼–ç å±‚</span></span><br><span class="line">        <span class="variable language_">self</span>.dir_encoding = nn.Sequential(</span><br><span class="line">            nn.Linear(W + in_channels_dir, W), nn.ReLU(<span class="literal">True</span>),</span><br><span class="line">            nn.Linear(W, W // <span class="number">2</span>), nn.ReLU(<span class="literal">True</span>)</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å®šä¹‰é™æ€è¾“å‡ºå±‚</span></span><br><span class="line">        <span class="comment"># é™æ€å¯†åº¦é¢„æµ‹å±‚ï¼ŒåŒ…å«ä¸€ä¸ªçº¿æ€§å±‚å’Œ Softplus æ¿€æ´»å‡½æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.static_sigma = nn.Sequential(nn.Linear(W, <span class="number">1</span>), nn.Softplus())</span><br><span class="line">        <span class="comment"># é™æ€ RGB é¢„æµ‹å±‚ï¼ŒåŒ…å«ä¸¤ä¸ªçº¿æ€§å±‚ï¼Œä¸­é—´æœ‰ ReLU æ¿€æ´»å‡½æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.static_rgb = nn.Sequential(nn.Linear(W // <span class="number">2</span>, W // <span class="number">2</span>), nn.ReLU(inplace=<span class="literal">True</span>),</span><br><span class="line">                                        nn.Linear(W // <span class="number">2</span>, <span class="number">3</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, input_xyz, input_dir_a</span>):</span><br><span class="line">        <span class="comment"># å­˜å‚¨è¾“å…¥çš„ä½ç½®ç¼–ç </span></span><br><span class="line">        xyz_ = input_xyz</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="variable language_">self</span>.D):</span><br><span class="line">            <span class="keyword">if</span> i <span class="keyword">in</span> <span class="variable language_">self</span>.skips:</span><br><span class="line">                <span class="comment"># å¦‚æœæ˜¯è·³è·ƒè¿æ¥ä½ç½®ï¼Œå°†è¾“å…¥çš„ä½ç½®ç¼–ç å’Œå½“å‰å¤„ç†ç»“æœæ‹¼æ¥</span></span><br><span class="line">                xyz_ = torch.cat([input_xyz, xyz_], -<span class="number">1</span>)</span><br><span class="line">            <span class="comment"># é€šè¿‡ç›¸åº”çš„ä½ç½®ç¼–ç å±‚å¤„ç†</span></span><br><span class="line">            xyz_ = <span class="built_in">getattr</span>(<span class="variable language_">self</span>, <span class="string">f&quot;xyz_encoding_<span class="subst">&#123;i + <span class="number">1</span>&#125;</span>&quot;</span>)(xyz_)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># é€šè¿‡é™æ€å¯†åº¦é¢„æµ‹å±‚å¾—åˆ°é™æ€å¯†åº¦</span></span><br><span class="line">        static_sigma = <span class="variable language_">self</span>.static_sigma(xyz_)  <span class="comment"># è¾“å‡ºå½¢çŠ¶ä¸º (B, 1)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># é€šè¿‡ä½ç½®ç¼–ç çš„æœ€ç»ˆçº¿æ€§å±‚å¾—åˆ°æœ€ç»ˆä½ç½®ç¼–ç </span></span><br><span class="line">        xyz_encoding_final = <span class="variable language_">self</span>.xyz_encoding_final(xyz_)</span><br><span class="line">        <span class="comment"># å°†æœ€ç»ˆä½ç½®ç¼–ç å’Œè¾“å…¥çš„æ–¹å‘ç¼–ç æ‹¼æ¥</span></span><br><span class="line">        dir_encoding_input = torch.cat([xyz_encoding_final, input_dir_a], -<span class="number">1</span>)</span><br><span class="line">        <span class="comment"># é€šè¿‡æ–¹å‘ç¼–ç å±‚å¤„ç†æ‹¼æ¥åçš„ç»“æœ</span></span><br><span class="line">        dir_encoding = <span class="variable language_">self</span>.dir_encoding(dir_encoding_input)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># é€šè¿‡é™æ€ RGB é¢„æµ‹å±‚å¾—åˆ°é™æ€ RGB å€¼</span></span><br><span class="line">        static_rgb = <span class="variable language_">self</span>.static_rgb(dir_encoding)</span><br><span class="line">        <span class="comment"># å°†é™æ€ RGB å€¼å’Œé™æ€å¯†åº¦æ‹¼æ¥</span></span><br><span class="line">        static = torch.cat([static_rgb, static_sigma], -<span class="number">1</span>)  <span class="comment"># è¾“å‡ºå½¢çŠ¶ä¸º (B, 4)</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> static</span><br></pre></td></tr></table></figure>

<h4 id="poses-py"><a href="#poses-py" class="headerlink" title="poses.py"></a>poses.py</h4><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">from</span> utils.lie_group_helper <span class="keyword">import</span> make_c2w</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ LearnPose ç±»ï¼Œç»§æ‰¿è‡ª nn.Moduleï¼Œç”¨äºå­¦ä¹ ç›¸æœºä½å§¿</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LearnPose</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, num_cams, learn_R, learn_t, init_c2w=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        :param num_cams: ç›¸æœºçš„æ•°é‡</span></span><br><span class="line"><span class="string">        :param learn_R: æ˜¯å¦å­¦ä¹ æ—‹è½¬éƒ¨åˆ†ï¼Œå¸ƒå°”å€¼</span></span><br><span class="line"><span class="string">        :param learn_t: æ˜¯å¦å­¦ä¹ å¹³ç§»éƒ¨åˆ†ï¼Œå¸ƒå°”å€¼</span></span><br><span class="line"><span class="string">        :param init_c2w: (N, 4, 4) çš„ torch å¼ é‡ï¼Œè¡¨ç¤ºåˆå§‹çš„ç›¸æœºåˆ°ä¸–ç•Œçš„å˜æ¢çŸ©é˜µ</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># è°ƒç”¨çˆ¶ç±»çš„æ„é€ å‡½æ•°</span></span><br><span class="line">        <span class="built_in">super</span>(LearnPose, <span class="variable language_">self</span>).__init__()</span><br><span class="line">        <span class="comment"># å­˜å‚¨ç›¸æœºçš„æ•°é‡</span></span><br><span class="line">        <span class="variable language_">self</span>.num_cams = num_cams</span><br><span class="line">        <span class="comment"># åˆå§‹åŒ–åˆå§‹ç›¸æœºåˆ°ä¸–ç•Œçš„å˜æ¢çŸ©é˜µä¸º None</span></span><br><span class="line">        <span class="variable language_">self</span>.init_c2w = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">if</span> init_c2w <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># å¦‚æœæä¾›äº†åˆå§‹å˜æ¢çŸ©é˜µï¼Œå°†å…¶ä½œä¸ºä¸å¯è®­ç»ƒçš„å‚æ•°å­˜å‚¨</span></span><br><span class="line">            <span class="variable language_">self</span>.init_c2w = nn.Parameter(init_c2w, requires_grad=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å®šä¹‰æ—‹è½¬å‚æ•°ï¼Œåˆå§‹åŒ–ä¸ºå…¨é›¶ï¼Œæ˜¯å¦å¯è®­ç»ƒç”± learn_R å†³å®š</span></span><br><span class="line">        <span class="variable language_">self</span>.r = nn.Parameter(torch.zeros(size=(num_cams, <span class="number">3</span>), dtype=torch.float32), requires_grad=learn_R)  <span class="comment"># (N, 3)</span></span><br><span class="line">        <span class="comment"># å®šä¹‰å¹³ç§»å‚æ•°ï¼Œåˆå§‹åŒ–ä¸ºå…¨é›¶ï¼Œæ˜¯å¦å¯è®­ç»ƒç”± learn_t å†³å®š</span></span><br><span class="line">        <span class="variable language_">self</span>.t = nn.Parameter(torch.zeros(size=(num_cams, <span class="number">3</span>), dtype=torch.float32), requires_grad=learn_t)  <span class="comment"># (N, 3)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, cam_id</span>):</span><br><span class="line">        <span class="comment"># æ ¹æ®ç›¸æœº ID æå–å¯¹åº”çš„æ—‹è½¬å‚æ•°ï¼Œå½¢çŠ¶ä¸º (3, )ï¼Œè¡¨ç¤ºè½´è§’</span></span><br><span class="line">        r = <span class="variable language_">self</span>.r[cam_id]  <span class="comment"># (3, ) è½´è§’</span></span><br><span class="line">        <span class="comment"># æ ¹æ®ç›¸æœº ID æå–å¯¹åº”çš„å¹³ç§»å‚æ•°ï¼Œå½¢çŠ¶ä¸º (3, )</span></span><br><span class="line">        t = <span class="variable language_">self</span>.t[cam_id]  <span class="comment"># (3, )</span></span><br><span class="line">        <span class="comment"># ä½¿ç”¨ make_c2w å‡½æ•°å°†è½´è§’å’Œå¹³ç§»å‚æ•°è½¬æ¢ä¸ºç›¸æœºåˆ°ä¸–ç•Œçš„å˜æ¢çŸ©é˜µï¼Œå½¢çŠ¶ä¸º (4, 4)</span></span><br><span class="line">        c2w = make_c2w(r, t)  <span class="comment"># (4, 4)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># å¦‚æœæä¾›äº†åˆå§‹å˜æ¢çŸ©é˜µï¼Œå­¦ä¹ åˆå§‹ä½å§¿å’Œç›®æ ‡ä½å§¿ä¹‹é—´çš„å¢é‡ä½å§¿</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.init_c2w <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># å°†å½“å‰è®¡ç®—å¾—åˆ°çš„å˜æ¢çŸ©é˜µä¸åˆå§‹å˜æ¢çŸ©é˜µç›¸ä¹˜</span></span><br><span class="line">            c2w = c2w @ <span class="variable language_">self</span>.init_c2w[cam_id]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> c2w</span><br></pre></td></tr></table></figure>



<h2 id="utils"><a href="#utils" class="headerlink" title="utils"></a>utils</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">â”œâ”€â”€ utils/  # å·¥å…·æ–‡ä»¶å¤¹</span><br><span class="line">â”‚   â”œâ”€â”€ align_traj.py  # è½¨è¿¹å¯¹é½è„šæœ¬æ–‡ä»¶ï¼Œç”¨äºå¯¹ä¸åŒè½¨è¿¹æ•°æ®è¿›è¡Œå¯¹é½æ“ä½œ</span><br><span class="line">â”‚   â”œâ”€â”€ comp_ate.py  # è®¡ç®—ç»å¯¹è½¨è¿¹è¯¯å·®ï¼ˆAbsolute Trajectory Error, ATEï¼‰çš„è„šæœ¬æ–‡ä»¶</span><br><span class="line">â”‚   â”œâ”€â”€ comp_ray_dir.py  # è®¡ç®—å…‰çº¿æ–¹å‘çš„è„šæœ¬æ–‡ä»¶ï¼Œå¸¸ç”¨äºè®¡ç®—æœºè§†è§‰å’Œä¸‰ç»´é‡å»ºä¸­çš„å…‰çº¿è¿½è¸ªç­‰åœºæ™¯</span><br><span class="line">â”‚   â”œâ”€â”€ lie_group_helper.py  # æç¾¤ç›¸å…³è¾…åŠ©å‡½æ•°çš„è„šæœ¬æ–‡ä»¶ï¼Œæç¾¤åœ¨æœºå™¨äººè¿åŠ¨å­¦ã€è®¡ç®—æœºè§†è§‰ä¸­çš„ä½å§¿è¡¨ç¤ºç­‰æ–¹é¢æœ‰åº”ç”¨</span><br><span class="line">â”‚   â”œâ”€â”€ pos_enc.py  # ä½ç½®ç¼–ç è„šæœ¬æ–‡ä»¶ï¼Œåœ¨æ·±åº¦å­¦ä¹ æ¨¡å‹ï¼ˆå¦‚NeRFï¼‰ä¸­ç”¨äºå¯¹ä½ç½®ä¿¡æ¯è¿›è¡Œç¼–ç </span><br><span class="line">â”‚   â”œâ”€â”€ pose_utils.py  # ä½å§¿å¤„ç†å·¥å…·è„šæœ¬æ–‡ä»¶ï¼ŒåŒ…å«å¤„ç†ç›¸æœºä½å§¿æˆ–ç‰©ä½“ä½å§¿çš„ç›¸å…³å‡½æ•°</span><br><span class="line">â”‚   â”œâ”€â”€ split_dataset.py  # æ•°æ®é›†åˆ’åˆ†è„šæœ¬æ–‡ä»¶ï¼Œç”¨äºå°†æ•°æ®é›†åˆ’åˆ†ä¸ºè®­ç»ƒé›†ã€éªŒè¯é›†å’Œæµ‹è¯•é›†ç­‰</span><br><span class="line">â”‚   â”œâ”€â”€ training_utils.py  # è®­ç»ƒè¾…åŠ©å·¥å…·è„šæœ¬æ–‡ä»¶ï¼ŒåŒ…å«è®­ç»ƒæ¨¡å‹æ—¶å¸¸ç”¨çš„å·¥å…·å‡½æ•°ï¼Œå¦‚å­¦ä¹ ç‡è°ƒæ•´ã€æŸå¤±å‡½æ•°è®¡ç®—ç­‰</span><br><span class="line">â”‚   â”œâ”€â”€ vgg.py  # VGGç½‘ç»œç›¸å…³è„šæœ¬æ–‡ä»¶ï¼Œå¯èƒ½åŒ…å«VGGæ¨¡å‹çš„å®šä¹‰ã€åŠ è½½é¢„è®­ç»ƒæƒé‡ç­‰æ“ä½œ</span><br><span class="line">â”‚   â”œâ”€â”€ vis_cam_traj.py  # å¯è§†åŒ–ç›¸æœºè½¨è¿¹çš„è„šæœ¬æ–‡ä»¶ï¼Œç”¨äºå°†ç›¸æœºåœ¨ä¸‰ç»´ç©ºé—´ä¸­çš„è¿åŠ¨è½¨è¿¹è¿›è¡Œå¯è§†åŒ–å±•ç¤º</span><br><span class="line">â”‚   â””â”€â”€ volume_op.py  # ä½“æ“ä½œè„šæœ¬æ–‡ä»¶ï¼Œåœ¨ä¸‰ç»´é‡å»ºã€ä½“æ¸²æŸ“ç­‰åœºæ™¯ä¸­å¯¹ä¸‰ç»´ä½“æ•°æ®è¿›è¡Œæ“ä½œ</span><br></pre></td></tr></table></figure>



]]></content>
      <categories>
        <category>ç§‘ç ”</category>
      </categories>
      <tags>
        <tag>è®ºæ–‡å¤ç°</tag>
      </tags>
  </entry>
  <entry>
    <title>æ‰‹æ’•è®ºæ–‡çŸ¥è¯†åº“</title>
    <url>/%E6%89%8B%E6%92%95%E7%9F%A5%E8%AF%86%E5%BA%93/</url>
    <content><![CDATA[<p>æ‰‹æ’•è®ºæ–‡çŸ¥è¯†åº“</p>
<h2 id="æ·±åº¦å­¦ä¹ é¡¹ç›®ä»£ç ç›®å½•å…¨è§ˆåŠè§£æ"><a href="#æ·±åº¦å­¦ä¹ é¡¹ç›®ä»£ç ç›®å½•å…¨è§ˆåŠè§£æ" class="headerlink" title="æ·±åº¦å­¦ä¹ é¡¹ç›®ä»£ç ç›®å½•å…¨è§ˆåŠè§£æ"></a>æ·±åº¦å­¦ä¹ é¡¹ç›®ä»£ç ç›®å½•å…¨è§ˆåŠè§£æ</h2><blockquote>
<p>å¸¸è§ç›®å½•å¦‚ä¸‹ï¼š</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">project_name/</span><br><span class="line">â”œâ”€â”€ data/                   # æ•°æ®é›†ç›¸å…³ï¼ˆåŸå§‹/å¤„ç†åçš„æ•°æ®ï¼‰</span><br><span class="line">â”œâ”€â”€ dataloader/             # æ•°æ®åŠ è½½ä¸é¢„å¤„ç†æ¨¡å—ï¼ˆæ ¸å¿ƒï¼‰</span><br><span class="line">â”‚   â”œâ”€â”€ __init__.py</span><br><span class="line">â”‚   â”œâ”€â”€ dataset.py          # è‡ªå®šä¹‰Datasetç±»</span><br><span class="line">â”‚   â””â”€â”€ transforms.py       # æ•°æ®å¢å¼ºæ“ä½œ</span><br><span class="line">â”œâ”€â”€ models/                 # æ¨¡å‹å®šä¹‰ï¼ˆæ ¸å¿ƒï¼‰</span><br><span class="line">â”‚   â”œâ”€â”€ __init__.py</span><br><span class="line">â”‚   â”œâ”€â”€ backbone.py         # ä¸»å¹²ç½‘ç»œ</span><br><span class="line">â”‚   â””â”€â”€ layers.py           # è‡ªå®šä¹‰ç½‘ç»œå±‚</span><br><span class="line">â”œâ”€â”€ configs/                # è¶…å‚æ•°é…ç½®æ–‡ä»¶ï¼ˆå¦‚YAML/JSONï¼‰</span><br><span class="line">â”œâ”€â”€ utils/                  # å·¥å…·å‡½æ•°ï¼ˆå¦‚æ—¥å¿—ã€è¯„ä¼°æŒ‡æ ‡ï¼‰</span><br><span class="line">â”‚   â”œâ”€â”€ data_utils.py</span><br><span class="line">â”‚   â”œâ”€â”€ model_utils.py</span><br><span class="line">â”‚   â”œâ”€â”€ visualization_utils.py</span><br><span class="line">â”‚   â””â”€â”€...</span><br><span class="line">â”œâ”€â”€ logs/                   # è®°å½•è®­ç»ƒå’Œè¯„ä¼°è¿‡ç¨‹ä¸­çš„æ—¥å¿—ä¿¡æ¯</span><br><span class="line">â”‚   â”œâ”€â”€ training.log</span><br><span class="line">â”‚   â”œâ”€â”€ validation.log</span><br><span class="line">â”‚   â””â”€â”€...</span><br><span class="line">â”œâ”€â”€ checkpoints/            # è®­ç»ƒä¿å­˜çš„æ¨¡å‹æƒé‡</span><br><span class="line">â”œâ”€â”€ scripts/                # è¿è¡Œè„šæœ¬ï¼ˆè®­ç»ƒ/æµ‹è¯•å‘½ä»¤ï¼‰</span><br><span class="line">â”œâ”€â”€ requirements.txt        # ä¾èµ–åº“åˆ—è¡¨</span><br><span class="line">â”œâ”€â”€ environment.yml         # Condaç¯å¢ƒé…ç½®</span><br><span class="line">â”œâ”€â”€ README.md               # é¡¹ç›®è¯´æ˜</span><br><span class="line">â””â”€â”€ main.py                 # ä¸»ç¨‹åºå…¥å£</span><br></pre></td></tr></table></figure>

<blockquote>
<ol>
<li><code>dataloader/</code></li>
</ol>
<p>  <strong>ä½œç”¨</strong>ï¼šæ•°æ®åŠ è½½ã€é¢„å¤„ç†ã€å¢å¼ºï¼ˆå¦‚è®ºæ–‡é¡¹ç›®ä¸­çš„ <code>with_colmap.py</code> å¯èƒ½ä¸å¤šè§†å›¾æ•°æ®å¯¹é½ç›¸å…³ï¼‰</p>
<p>  <strong>å…¸å‹å†…å®¹</strong>ï¼š<code>Dataset</code> ç±»å®šä¹‰ã€æ•°æ®å¢å¼ºå‡½æ•°ã€ç‰¹å¾æå–å·¥å…·ï¼ˆå¦‚é¡¹ç›®ä¸­çš„ <code>with_feature.py</code>ï¼‰</p>
<ol start="2">
<li><strong><code>models/</code></strong></li>
</ol>
<p>  <strong>ä½œç”¨</strong>ï¼šå®šä¹‰ç¥ç»ç½‘ç»œæ¨¡å‹ï¼ˆå¦‚é¡¹ç›®ä¸­çš„<code>nerf_models.py</code> å¯å®ç°NeRFçš„æ ¸å¿ƒæ¶æ„ï¼‰ã€‚</p>
<p>  <strong>å…¸å‹å†…å®¹</strong>ï¼šæ¨¡å‹ç±»ç»§æ‰¿<code>torch.nn.Module</code>ï¼ŒåŒ…å«å‰å‘ä¼ æ’­é€»è¾‘ï¼ˆå¦‚é¡¹ç›®ä¸­çš„<code>depth_decoder.py</code>å¯ç”¨äºæ·±åº¦ä¼°è®¡è§£ç ï¼‰ã€‚</p>
<ol start="3">
<li><strong><code>utils/</code></strong></li>
</ol>
<p>  <strong>ä½œç”¨</strong>ï¼šè¾…åŠ©å·¥å…·ï¼ˆå¦‚é¡¹ç›®ä¸­çš„ <code>pose_utils.py</code> å¤„ç†ç›¸æœºä½å§¿ï¼Œ<code>training_utils.py</code> å°è£…è®­ç»ƒé€»è¾‘ï¼‰ã€‚</p>
<p>  <strong>å…¸å‹å†…å®¹</strong>ï¼šè¯„ä¼°æŒ‡æ ‡è®¡ç®—ã€å¯è§†åŒ–å·¥å…·ã€è®­ç»ƒå›è°ƒå‡½æ•°ã€‚</p>
<ol start="4">
<li><strong><code>third_party/</code></strong></li>
</ol>
<p>  <strong>ä½œç”¨</strong>ï¼šç¬¬ä¸‰æ–¹åº“æˆ–å·¥å…·ï¼ˆå¦‚é¡¹ç›®ä¸­çš„ <code>ATE</code> å¯èƒ½ç”¨äºè½¨è¿¹è¯„ä¼°ï¼Œ<code>pytorch_ssim</code> å®ç°ç»“æ„ç›¸ä¼¼æ€§æŸå¤±ï¼‰ã€‚</p>
<ol start="5">
<li>å…¶ä»–å…³é”®è¦ç´ </li>
</ol>
<p>  <code>logs</code> æ–‡ä»¶å¤¹ï¼šè®°å½•è®­ç»ƒå’Œè¯„ä¼°è¿‡ç¨‹ä¸­çš„æ—¥å¿—ä¿¡æ¯ï¼Œå¦‚è®­ç»ƒæŸå¤±ã€éªŒè¯æŸå¤±ã€å‡†ç¡®ç‡ç­‰æŒ‡æ ‡çš„å˜åŒ–æƒ…å†µï¼Œä¾¿äºè·Ÿè¸ªæ¨¡å‹è®­ç»ƒè¿‡ç¨‹ï¼Œåˆ†ææ¨¡å‹çš„æ”¶æ•›æ€§å’Œæ€§èƒ½è¡¨ç°ã€‚</p>
<p>  <code>checkpoints</code> æ–‡ä»¶å¤¹ï¼šä¿å­˜è®­ç»ƒè¿‡ç¨‹ä¸­çš„æ¨¡å‹æ£€æŸ¥ç‚¹ï¼Œå³æ¨¡å‹åœ¨ä¸åŒè®­ç»ƒé˜¶æ®µçš„å‚æ•°æ–‡ä»¶ï¼Œç”¨äºåœ¨è®­ç»ƒä¸­æ–­æ—¶æ¢å¤è®­ç»ƒï¼Œæˆ–è€…ç”¨äºé€‰æ‹©åœ¨éªŒè¯é›†ä¸Šè¡¨ç°æœ€å¥½çš„æ¨¡å‹è¿›è¡Œæµ‹è¯•å’Œéƒ¨ç½²ã€‚</p>
<p>  <code>requirement.txt</code>ï¼šåˆ—å‡ºé¡¹ç›®æ‰€éœ€çš„ Python ä¾èµ–åº“åŠå…¶ç‰ˆæœ¬å·ï¼Œä¾¿äºåœ¨æ–°ç¯å¢ƒä¸­å¿«é€Ÿå®‰è£…é¡¹ç›®æ‰€éœ€çš„æ‰€æœ‰ä¾èµ–ã€‚</p>
<p>  <code>environment.yml</code>ï¼šCondaç¯å¢ƒé…ç½®ï¼Œç¡®ä¿ä¾èµ–ä¸€è‡´æ€§ã€‚</p>
<p>  <code>README.md</code>ï¼šé¡¹ç›®è¯´æ˜ã€å®‰è£…ä¸ä½¿ç”¨æŒ‡å—ï¼ˆæ·±åº¦å­¦ä¹ é¡¹ç›®å¿…å¤‡ï¼‰ã€‚</p>
<p>  <strong><code>main.py</code></strong>ï¼šé¡¹ç›®çš„ä¸»ç¨‹åºå…¥å£ï¼Œé€šå¸¸åŒ…å«æ¨¡å‹è®­ç»ƒã€è¯„ä¼°å’Œé¢„æµ‹çš„ä¸»è¦é€»è¾‘ï¼Œå¯é€šè¿‡å‘½ä»¤è¡Œå‚æ•°æ¥æ§åˆ¶ç¨‹åºçš„è¿è¡Œæ–¹å¼å’Œå‚æ•°è®¾ç½®ã€‚</p>
</blockquote>
<blockquote>
<p>ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">occ - nerf/  # åŸºäºå ç”¨ç‡çš„ç¥ç»è¾å°„åœºé¡¹ç›®æ ¹ç›®å½•</span><br><span class="line">â”œâ”€â”€.gitignore  # æŒ‡å®šGitä¸è·Ÿè¸ªçš„æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹</span><br><span class="line">â”œâ”€â”€ LICENSE  # é¡¹ç›®ä½¿ç”¨è®¸å¯æ¡æ¬¾æ–‡ä»¶</span><br><span class="line">â”œâ”€â”€ README.md  # ä»‹ç»é¡¹ç›®èƒŒæ™¯ã€åŠŸèƒ½ã€ä½¿ç”¨æ–¹æ³•ç­‰çš„è¯´æ˜æ–‡æ¡£</span><br><span class="line">â”œâ”€â”€ environment.yml  # å®šä¹‰é¡¹ç›®è¿è¡Œæ‰€éœ€è½¯ä»¶ç¯å¢ƒ</span><br><span class="line">â”œâ”€â”€ local1.txt  # ç”¨é€”ä¸æ˜ï¼Œæˆ–ä¸ºæœ¬åœ°è¯´æ˜ã€é…ç½®ç­‰æ–‡ä»¶</span><br><span class="line">â”œâ”€â”€ dataloader/  # å­˜æ”¾æ•°æ®åŠ è½½ä¸é¢„å¤„ç†ä»£ç </span><br><span class="line">â”‚   â”œâ”€â”€ any_folder.py  # ä»ä»»æ„æ–‡ä»¶å¤¹ç»“æ„åŠ è½½æ•°æ®</span><br><span class="line">â”‚   â”œâ”€â”€ local_save.py  # è´Ÿè´£æ•°æ®æœ¬åœ°ä¿å­˜</span><br><span class="line">â”‚   â”œâ”€â”€ with_colmap.py  # ä»COLMAPå¤„ç†åæ ¼å¼åŠ è½½æ•°æ®</span><br><span class="line">â”‚   â”œâ”€â”€ with_feature.py  # åŠ è½½å¸¦ç‰¹å¾çš„æ•°æ®</span><br><span class="line">â”‚   â”œâ”€â”€ with_feature_colmap.py  # ç»“åˆCOLMAPä¸ç‰¹å¾æ•°æ®åŠ è½½</span><br><span class="line">â”‚   â””â”€â”€ with_mask.py  # åŠ è½½å¸¦æ©ç çš„æ•°æ®</span><br><span class="line">â”œâ”€â”€ models/  # å­˜æ”¾æ·±åº¦å­¦ä¹ æ¨¡å‹å®šä¹‰ä¸æ“ä½œä»£ç </span><br><span class="line">â”‚   â”œâ”€â”€ depth_decoder.py  # æ·±åº¦è§£ç ï¼Œç”¨äºæ·±åº¦ä¼°è®¡</span><br><span class="line">â”‚   â”œâ”€â”€ intrinsics.py  # å¤„ç†ç›¸æœºå†…å‚ç›¸å…³å†…å®¹</span><br><span class="line">â”‚   â”œâ”€â”€ layers.py  # å®šä¹‰æ·±åº¦å­¦ä¹ å±‚ç»“æ„</span><br><span class="line">â”‚   â”œâ”€â”€ nerf_feature.py  # å¤„ç†NeRFç‰¹å¾ç›¸å…³é€»è¾‘</span><br><span class="line">â”‚   â”œâ”€â”€ nerf_mask.py  # å¤„ç†NeRFæ¨¡å‹ä¸­æ©ç ç›¸å…³å†…å®¹</span><br><span class="line">â”‚   â”œâ”€â”€ nerf_models.py  # å®šä¹‰NeRFæ¨¡å‹æ¶æ„ç­‰æ ¸å¿ƒå†…å®¹</span><br><span class="line">â”‚   â””â”€â”€ poses.py  # å¤„ç†ä½å§¿ç›¸å…³æ“ä½œ</span><br><span class="line">â”œâ”€â”€ utils/  # åŒ…å«è¾…åŠ©é¡¹ç›®è¿è¡Œçš„å·¥å…·å‡½æ•°</span><br><span class="line">â”‚   â”œâ”€â”€ align_traj.py  # å®ç°è½¨è¿¹å¯¹é½ç®—æ³•</span><br><span class="line">â”‚   â”œâ”€â”€ comp_ate.py  # è®¡ç®—ç»å¯¹è½¨è¿¹è¯¯å·®</span><br><span class="line">â”‚   â”œâ”€â”€ comp_ray_dir.py  # è®¡ç®—å…‰çº¿æ–¹å‘</span><br><span class="line">â”‚   â”œâ”€â”€ lie_group_helper.py  # æä¾›æç¾¤ç›¸å…³è¾…åŠ©å‡½æ•°</span><br><span class="line">â”‚   â”œâ”€â”€ pos_enc.py  # å®ç°ä½ç½®ç¼–ç </span><br><span class="line">â”‚   â”œâ”€â”€ pose_utils.py  # æä¾›ä½å§¿ç›¸å…³å®ç”¨å·¥å…·å‡½æ•°</span><br><span class="line">â”‚   â”œâ”€â”€ split_dataset.py  # åˆ’åˆ†æ•°æ®é›†ä¸ºè®­ç»ƒã€éªŒè¯ã€æµ‹è¯•é›†</span><br><span class="line">â”‚   â”œâ”€â”€ training_utils.py  # æä¾›æ¨¡å‹è®­ç»ƒè¾…åŠ©å‡½æ•°</span><br><span class="line">â”‚   â”œâ”€â”€ vgg.py  # ä¸VGGç¥ç»ç½‘ç»œç›¸å…³æ“ä½œ</span><br><span class="line">â”‚   â”œâ”€â”€ vis_cam_traj.py  # å¯è§†åŒ–ç›¸æœºè½¨è¿¹</span><br><span class="line">â”‚   â””â”€â”€ volume_op.py  # æ“ä½œä¸‰ç»´ä½“æ•°æ®</span><br><span class="line">â”œâ”€â”€ tasks/  # å­˜æ”¾è®­ç»ƒã€æµ‹è¯•ç­‰å…·ä½“ä»»åŠ¡ä»£ç </span><br><span class="line">â”‚   â””â”€â”€...</span><br><span class="line">â””â”€â”€ third_party/  # å­˜æ”¾ç¬¬ä¸‰æ–¹ä»£ç æˆ–åº“</span><br><span class="line">    â”œâ”€â”€ ATE/  # ä¸ç»å¯¹è½¨è¿¹è¯¯å·®è®¡ç®—ç›¸å…³</span><br><span class="line">    â”‚   â””â”€â”€ README.md  # è¯´æ˜è¯¥éƒ¨åˆ†åŠŸèƒ½ä¸ç”¨æ³•</span><br><span class="line">    â””â”€â”€ pytorch_ssim/  # è®¡ç®—ç»“æ„ç›¸ä¼¼æ€§æŒ‡æ•°çš„åº“</span><br></pre></td></tr></table></figure>

<h2 id="PyTorch"><a href="#PyTorch" class="headerlink" title="PyTorch"></a>PyTorch</h2><h3 id="ä»€ä¹ˆæ˜¯torch"><a href="#ä»€ä¹ˆæ˜¯torch" class="headerlink" title="ä»€ä¹ˆæ˜¯torch"></a>ä»€ä¹ˆæ˜¯torch</h3><p>Torch æ˜¯ PyTorch æ·±åº¦å­¦ä¹ æ¡†æ¶çš„æ ¸å¿ƒåº“ï¼Œå…·å¤‡å¼ºå¤§çš„åŠŸèƒ½ä¸å¹¿æ³›çš„ç”¨é€”ã€‚å®ƒæä¾›äº†ä¸°å¯Œçš„å¼ é‡æ“ä½œï¼Œå¯åœ¨ CPU æˆ– GPU ä¸Šé«˜æ•ˆè®¡ç®—ï¼Œèƒ½è½»æ¾å¤„ç†å„ç±»æ•°æ®ï¼›å…¶è‡ªåŠ¨æ±‚å¯¼æœºåˆ¶æå¤§ç®€åŒ–äº†æ·±åº¦å­¦ä¹ ä¸­æ¢¯åº¦è®¡ç®—ä¸åå‘ä¼ æ’­çš„è¿‡ç¨‹ï¼Œè®©æ¨¡å‹è®­ç»ƒæ›´ä¸ºä¾¿æ·ã€‚å€ŸåŠ©<code>torch.nn</code>æ¨¡å—å¯æ–¹ä¾¿æ„å»ºå¦‚ CNNã€RNN ç­‰å¤æ‚ç¥ç»ç½‘ç»œæ¶æ„ï¼Œ<code>torch.optim</code>æ¨¡å—æä¾›å¤šç§ä¼˜åŒ–ç®—æ³•ç”¨äºæ¨¡å‹å‚æ•°æ›´æ–°ã€‚æ­¤å¤–ï¼ŒTorch è¿˜æ”¯æŒé¢„è®­ç»ƒæ¨¡å‹çš„ä½¿ç”¨ä¸å¾®è°ƒï¼Œç»“åˆå¯è§†åŒ–å·¥å…·èƒ½åŠ©åŠ›ç›‘æ§è®­ç»ƒè¿‡ç¨‹ï¼Œå¹¿æ³›åº”ç”¨äºå›¾åƒã€è‡ªç„¶è¯­è¨€å¤„ç†ã€æ¨èç³»ç»Ÿç­‰è¯¸å¤šé¢†åŸŸã€‚</p>
<h3 id="torchå¸¸ç”¨å‡½æ•°å’ŒåŠŸèƒ½"><a href="#torchå¸¸ç”¨å‡½æ•°å’ŒåŠŸèƒ½" class="headerlink" title="torchå¸¸ç”¨å‡½æ•°å’ŒåŠŸèƒ½"></a>torchå¸¸ç”¨å‡½æ•°å’ŒåŠŸèƒ½</h3><h4 id="å¼ é‡"><a href="#å¼ é‡" class="headerlink" title="å¼ é‡"></a>å¼ é‡</h4><h5 id="ä»€ä¹ˆæ˜¯å¼ é‡"><a href="#ä»€ä¹ˆæ˜¯å¼ é‡" class="headerlink" title="ä»€ä¹ˆæ˜¯å¼ é‡"></a>ä»€ä¹ˆæ˜¯å¼ é‡</h5><p>å¼ é‡æ˜¯å¤šç»´æ•°ç»„çš„æ³›åŒ–è¡¨ç¤ºï¼Œå¯ç†è§£ä¸ºä¸€ä¸ªå¤šç»´çš„æ•°æ®å®¹å™¨ï¼Œé›¶ç»´å¼ é‡æ˜¯æ ‡é‡ï¼Œä¸€ç»´å¼ é‡æ˜¯å‘é‡ï¼ŒäºŒç»´å¼ é‡æ˜¯çŸ©é˜µï¼Œä¸‰ç»´åŠä»¥ä¸Šåˆ™æ˜¯æ›´é«˜é˜¶çš„å¼ é‡ã€‚åœ¨æ·±åº¦å­¦ä¹ é‡Œï¼Œä½¿ç”¨å¼ é‡æ˜¯å› ä¸ºå®ƒèƒ½å¤Ÿé«˜æ•ˆåœ°è¡¨ç¤ºå’Œå¤„ç†å¤§é‡çš„æ•°æ®ï¼Œåƒå›¾åƒå¯è¡¨ç¤ºä¸ºä¸‰ç»´å¼ é‡ï¼ˆé«˜åº¦ã€å®½åº¦ã€é€šé“æ•°ï¼‰ï¼Œè§†é¢‘å¯è¡¨ç¤ºä¸ºå››ç»´å¼ é‡ï¼ˆå¸§æ•°ã€é«˜åº¦ã€å®½åº¦ã€é€šé“æ•°ï¼‰ã€‚å¹¶ä¸”ï¼Œæ·±åº¦å­¦ä¹ æ¡†æ¶ï¼ˆå¦‚ PyTorchï¼‰é’ˆå¯¹å¼ é‡è¿ç®—è¿›è¡Œäº†é«˜åº¦ä¼˜åŒ–ï¼Œèƒ½åˆ©ç”¨ GPU ç­‰ç¡¬ä»¶åŠ é€Ÿè®¡ç®—ï¼Œå¼ é‡è¿˜èƒ½è‡ªç„¶åœ°æ”¯æŒè‡ªåŠ¨æ±‚å¯¼æœºåˆ¶ï¼Œæ–¹ä¾¿è¿›è¡Œæ¨¡å‹è®­ç»ƒæ—¶çš„æ¢¯åº¦è®¡ç®—å’Œå‚æ•°æ›´æ–°ã€‚</p>
<p>å¼ é‡æ˜¯ PyTorch ä¸­æœ€åŸºç¡€çš„æ•°æ®ç»“æ„ï¼Œç±»ä¼¼äº NumPy çš„å¤šç»´æ•°ç»„ï¼Œä½†å®ƒå¯ä»¥åœ¨ GPU ä¸Šè¿›è¡ŒåŠ é€Ÿè®¡ç®—ï¼Œå¹¶ä¸”æ”¯æŒè‡ªåŠ¨æ±‚å¯¼ç­‰æ·±åº¦å­¦ä¹ æ‰€éœ€çš„ç‰¹æ€§ã€‚</p>
<h5 id="å¼ é‡çš„ç»´åº¦"><a href="#å¼ é‡çš„ç»´åº¦" class="headerlink" title="å¼ é‡çš„ç»´åº¦"></a>å¼ é‡çš„ç»´åº¦</h5><p>ç»´åº¦ï¼ˆä¹Ÿç§°ä¸ºè½´ï¼‰æ˜¯æŒ‡å¼ é‡åœ¨æŸä¸ªæ–¹å‘ä¸Šçš„å»¶ä¼¸ã€‚å¯ä»¥å°†ç»´åº¦ç†è§£ä¸ºæ•°æ®ç»„ç»‡çš„ä¸€ä¸ªæ–¹å‘æˆ–ä¸€ä¸ªå±‚æ¬¡ï¼Œç±»ä¼¼äºåœ¨åœ°ç†åæ ‡ç³»ç»Ÿä¸­ï¼Œç»åº¦å’Œçº¬åº¦åˆ†åˆ«ä»£è¡¨äº†ä¸åŒçš„æ–¹å‘ï¼Œå¼ é‡çš„æ¯ä¸ªç»´åº¦ä¹Ÿä»£è¡¨äº†æ•°æ®çš„ä¸€ä¸ªç‰¹å®šæ–¹å‘çš„æ’åˆ—ã€‚ç»´åº¦çš„æ•°é‡è¢«ç§°ä¸ºå¼ é‡çš„é˜¶ï¼ˆrankï¼‰ï¼Œé›¶é˜¶å¼ é‡æ˜¯æ ‡é‡ï¼ˆä¸€ä¸ªå•ç‹¬çš„æ•°å€¼ï¼‰ï¼Œä¸€é˜¶å¼ é‡æ˜¯å‘é‡ï¼ˆä¸€ç»´æ•°ç»„ï¼‰ï¼ŒäºŒé˜¶å¼ é‡æ˜¯çŸ©é˜µï¼ˆäºŒç»´æ•°ç»„ï¼‰ï¼Œä¸‰é˜¶åŠä»¥ä¸Šçš„å¼ é‡åˆ™ç”¨äºè¡¨ç¤ºæ›´å¤æ‚çš„æ•°æ®ç»“æ„ã€‚</p>
<p><strong>æ³¨ï¼šç»´åº¦ä»0å¼€å§‹ç®—èµ·ï¼Œæ¯”å¦‚å¯¹äºäºŒé˜¶å¼ é‡ï¼Œç»´åº¦0ä»£è¡¨è¡Œï¼Œç»´åº¦1ä»£è¡¨åˆ—</strong></p>
<p><strong>å¦ï¼šç»´åº¦æ’åˆ—éµå¾ªï¼ˆ$a_n$, $a_{n-1}$, â€¦, $a_1$ï¼‰çš„å½¢å¼ï¼Œæ•°å­—è¶Šå‰ä»£è¡¨è¶Šé«˜ç»´çš„å †å ã€‚æ¯”å¦‚<code>torch.zeros((2, 3, 4, 5))</code>ï¼Œé‚£å°±æ˜¯ä¸¤ä¸ªä¸‰ç»´ï¼ˆä¸‰å±‚ï¼‰çš„4x5çŸ©é˜µå åœ¨ä¸€èµ·</strong></p>
<p><strong>1.é›¶é˜¶å¼ é‡ï¼ˆæ ‡é‡ï¼‰</strong></p>
<p>é›¶é˜¶å¼ é‡åªæœ‰ä¸€ä¸ªæ•°å€¼ï¼Œå®ƒæ²¡æœ‰æ–¹å‘çš„æ¦‚å¿µï¼Œç»´åº¦æ•°é‡ä¸º 0ã€‚ä¾‹å¦‚è¿™é‡Œçš„ <code>scalar</code> å°±æ˜¯ä¸€ä¸ªé›¶é˜¶å¼ é‡ï¼Œå®ƒä»£è¡¨ä¸€ä¸ªå•ä¸€çš„æ•°å€¼ï¼Œä¸æ¶‰åŠæ–¹å‘æˆ–å¤šä¸ªå…ƒç´ çš„æ’åˆ—ã€‚</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line">scalar = torch.tensor(<span class="number">5</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;æ ‡é‡çš„ç»´åº¦æ•°é‡:&quot;</span>, scalar.dim()) </span><br></pre></td></tr></table></figure>

<p><strong>2.ä¸€é˜¶å¼ é‡ï¼ˆå‘é‡ï¼‰</strong></p>
<p>ä¸€é˜¶å¼ é‡å¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªå‘é‡ï¼Œå®ƒæœ‰ä¸€ä¸ªç»´åº¦ã€‚è¿™ä¸ªç»´åº¦ä»£è¡¨äº†å‘é‡ä¸­å…ƒç´ çš„æ’åˆ—æ–¹å‘ï¼Œå‘é‡çš„é•¿åº¦å°±æ˜¯è¿™ä¸ªç»´åº¦çš„å¤§å°ã€‚ä¾‹å¦‚<code>vector</code> æ˜¯ä¸€ä¸ªä¸€é˜¶å¼ é‡ï¼Œç»´åº¦æ•°é‡ä¸º 1ï¼Œè¯¥ç»´åº¦çš„å¤§å°ä¸º 4ï¼Œè¡¨ç¤ºå‘é‡ä¸­æœ‰ 4 ä¸ªå…ƒç´ ã€‚</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">vector = torch.tensor([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;å‘é‡çš„ç»´åº¦æ•°é‡:&quot;</span>, vector.dim()) </span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;å‘é‡åœ¨è¯¥ç»´åº¦çš„å¤§å°:&quot;</span>, vector.size(<span class="number">0</span>)) </span><br></pre></td></tr></table></figure>

<p><strong>3.äºŒé˜¶å¼ é‡ï¼ˆçŸ©é˜µï¼‰</strong></p>
<p>äºŒé˜¶å¼ é‡æ˜¯ä¸€ä¸ªçŸ©é˜µï¼Œæœ‰ä¸¤ä¸ªç»´åº¦ï¼Œé€šå¸¸ç§°ä¸ºè¡Œå’Œåˆ—ã€‚ç¬¬ä¸€ä¸ªç»´åº¦ä»£è¡¨çŸ©é˜µçš„è¡Œæ–¹å‘ï¼Œç¬¬äºŒä¸ªç»´åº¦ä»£è¡¨çŸ©é˜µçš„åˆ—æ–¹å‘ã€‚ä¾‹å¦‚<code>matrix</code> æ˜¯ä¸€ä¸ª 2 è¡Œ 3 åˆ—çš„çŸ©é˜µï¼Œç¬¬ä¸€ä¸ªç»´åº¦çš„å¤§å°ä¸º 2 è¡¨ç¤ºæœ‰ 2 è¡Œï¼Œç¬¬äºŒä¸ªç»´åº¦çš„å¤§å°ä¸º 3 è¡¨ç¤ºæœ‰ 3 åˆ—ã€‚</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">matrix = torch.tensor([[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], [<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>]])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;çŸ©é˜µçš„ç»´åº¦æ•°é‡:&quot;</span>, matrix.dim()) </span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;çŸ©é˜µç¬¬ä¸€ä¸ªç»´åº¦ï¼ˆè¡Œï¼‰çš„å¤§å°:&quot;</span>, matrix.size(<span class="number">0</span>)) </span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;çŸ©é˜µç¬¬äºŒä¸ªç»´åº¦ï¼ˆåˆ—ï¼‰çš„å¤§å°:&quot;</span>, matrix.size(<span class="number">1</span>)) </span><br></pre></td></tr></table></figure>

<p><strong>4.é«˜é˜¶å¼ é‡ï¼ˆå›¾åƒã€è§†é¢‘ç­‰ï¼‰</strong></p>
<p>å¯¹äºä¸‰é˜¶åŠä»¥ä¸Šçš„å¼ é‡ï¼Œç»´åº¦çš„å«ä¹‰æ›´åŠ ä¸°å¯Œï¼Œé€šå¸¸ä¸å…·ä½“çš„æ•°æ®ç±»å‹å’Œåº”ç”¨åœºæ™¯ç›¸å…³ã€‚</p>
<p><strong>å›¾åƒæ•°æ®</strong>ï¼šåœ¨å¤„ç†å›¾åƒæ—¶ï¼Œé€šå¸¸ä½¿ç”¨ä¸‰é˜¶å¼ é‡ã€‚ä¾‹å¦‚ï¼Œä¸€å¼ å½©è‰²å›¾åƒå¯ä»¥è¡¨ç¤ºä¸ºä¸€ä¸ªå½¢çŠ¶ä¸º <code>(é«˜åº¦, å®½åº¦, é€šé“æ•°)</code> çš„ä¸‰é˜¶å¼ é‡ã€‚è¿™é‡Œçš„ç¬¬ä¸€ä¸ªç»´åº¦ä»£è¡¨å›¾åƒçš„é«˜åº¦æ–¹å‘ï¼Œç¬¬äºŒä¸ªç»´åº¦ä»£è¡¨å›¾åƒçš„å®½åº¦æ–¹å‘ï¼Œç¬¬ä¸‰ä¸ªç»´åº¦ä»£è¡¨å›¾åƒçš„é€šé“ï¼ˆå¦‚ RGB ä¸‰ä¸ªé€šé“ï¼‰ã€‚</p>
<p><code>image = torch.randn(224, 224, 3)</code> è¿™è¡Œä»£ç èƒ½å¤Ÿéšæœºç”Ÿæˆä¸€ä¸ªå½¢çŠ¶ä¸º <code>(224, 224, 3)</code> çš„å¼ é‡æ¥æ¨¡æ‹Ÿå›¾åƒçš„ä¸‰é€šé“æ•°å€¼ã€‚</p>
<p>ç”±äº <code>torch.randn()</code> ç”Ÿæˆçš„æ˜¯æœä»æ ‡å‡†æ­£æ€åˆ†å¸ƒçš„éšæœºæ•°ï¼Œè¿™äº›æ•°å€¼å¯èƒ½ä¸ºè´Ÿæ•°ï¼Œä¹Ÿå¯èƒ½è¶…å‡ºäº†å¸¸è§å›¾åƒåƒç´ å€¼çš„èŒƒå›´ï¼ˆé€šå¸¸æ˜¯ 0 - 255 æˆ–è€… 0 - 1ï¼‰ã€‚åœ¨å®é™…çš„å›¾åƒå¤„ç†ä»»åŠ¡ä¸­ï¼Œå¦‚æœéœ€è¦æ¨¡æ‹ŸçœŸå®å›¾åƒï¼Œå¯èƒ½éœ€è¦å¯¹è¿™äº›éšæœºå€¼è¿›è¡Œè¿›ä¸€æ­¥çš„å¤„ç†ï¼Œä¾‹å¦‚é€šè¿‡å½’ä¸€åŒ–æˆ–è£å‰ªæ“ä½œå°†å…¶é™åˆ¶åœ¨åˆé€‚çš„èŒƒå›´å†…ã€‚</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">image = torch.randn(<span class="number">224</span>, <span class="number">224</span>, <span class="number">3</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;å›¾åƒå¼ é‡çš„ç»´åº¦æ•°é‡:&quot;</span>, image.dim()) </span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;å›¾åƒé«˜åº¦ç»´åº¦çš„å¤§å°:&quot;</span>, image.size(<span class="number">0</span>)) </span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;å›¾åƒå®½åº¦ç»´åº¦çš„å¤§å°:&quot;</span>, image.size(<span class="number">1</span>)) </span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;å›¾åƒé€šé“ç»´åº¦çš„å¤§å°:&quot;</span>, image.size(<span class="number">2</span>)) </span><br></pre></td></tr></table></figure>

<p><img src="/./%E6%89%8B%E6%92%95%E7%9F%A5%E8%AF%86%E5%BA%93/image-20250219032451598.png" alt="image-20250219032451598"></p>
<p><strong>è§†é¢‘æ•°æ®</strong>ï¼šè§†é¢‘å¯ä»¥çœ‹ä½œæ˜¯ä¸€ç³»åˆ—çš„å›¾åƒå¸§ï¼Œå› æ­¤å¯ä»¥ç”¨å››é˜¶å¼ é‡è¡¨ç¤ºï¼Œå½¢çŠ¶é€šå¸¸ä¸º <code>(å¸§æ•°, é«˜åº¦, å®½åº¦, é€šé“æ•°)</code>ã€‚ç¬¬ä¸€ä¸ªç»´åº¦ä»£è¡¨è§†é¢‘ä¸­çš„å¸§æ•°ï¼Œå…¶ä½™ç»´åº¦ä¸å›¾åƒå¼ é‡çš„å«ä¹‰ç›¸åŒã€‚</p>
<p>*<strong>5.é€šé“</strong></p>
<p>é€šé“æŒ‡å›¾åƒä¸­ç‰¹å®šç±»å‹ä¿¡æ¯çš„é›†åˆï¼Œå›¾åƒå¯å«ä¸€ä¸ªæˆ–å¤šä¸ªé€šé“ï¼Œå„é€šé“å­˜å‚¨å›¾åƒæŸæ–¹é¢ç‰¹å¾æ•°æ®ã€‚åƒå•é€šé“å­˜äº®åº¦ï¼ŒRGB ä¸‰é€šé“åˆ†åˆ«å­˜çº¢ã€ç»¿ã€è“é¢œè‰²ä¿¡æ¯ï¼Œå››é€šé“è¿˜å¤šäº†é€æ˜åº¦é€šé“ï¼Œä»¥æ­¤ç»„åˆå®Œæ•´å‘ˆç°å›¾åƒã€‚</p>
<p>é€šé“èƒ½å®ç°é¢œè‰²è¡¨ç¤ºä¸æ··åˆï¼Œå¦‚ RGB ä¸‰é€šé“é€šè¿‡ä¸åŒæ•°å€¼ç»„åˆå‘ˆç°ä¸°å¯Œè‰²å½©ï¼›å¯ç”¨äºç‰¹å¾æå–ä¸åˆ†æï¼Œä¸åŒé€šé“æä¾›ä¸åŒç‰¹å¾ï¼ŒåŠ©åŠ›å›¾åƒåˆ†æå’Œç›®æ ‡è¯†åˆ«ï¼›è¿˜èƒ½ç”¨äºå›¾åƒåˆæˆä¸ç‰¹æ•ˆåˆ¶ä½œï¼Œå€ŸåŠ©é€æ˜åº¦é€šé“å¯æ§åˆ¶å›¾åƒé€æ˜æ•ˆæœå®ç°åˆæˆã€‚</p>
<p>åœ¨å›¾ç‰‡é‡Œï¼Œç°åº¦å›¾ç”¨å•é€šé“å‘ˆç°é»‘ç™½å½±åƒï¼›å½©è‰²ç…§ç‰‡é  RGB ä¸‰é€šé“å±•ç¤ºå¤šå½©ç”»é¢ï¼›PNG å›¾ç‰‡åˆ©ç”¨å››é€šé“å«é€æ˜åº¦ä¿¡æ¯å®ç°å›¾åƒèåˆã€‚è§†é¢‘æ˜¯è¿ç»­çš„å›¾ç‰‡å¸§ï¼ŒåŒæ ·åˆ©ç”¨é€šé“æ¥å‘ˆç°è‰²å½©ã€è¿›è¡Œç‰¹æ•ˆå¤„ç†ï¼Œå¦‚å½±è§†ä¸­å¸¸è§çš„æŠ å›¾åˆæˆåœºæ™¯å°±å€ŸåŠ©äº†é€šé“ç‰¹æ€§ã€‚</p>
<h5 id="å¼ é‡ç›¸å…³å‡½æ•°"><a href="#å¼ é‡ç›¸å…³å‡½æ•°" class="headerlink" title="å¼ é‡ç›¸å…³å‡½æ•°"></a>å¼ é‡ç›¸å…³å‡½æ•°</h5><p><strong>1.åˆ›å»º</strong></p>
<ul>
<li><p>åˆ›å»ºå¼ é‡<code>torch.tensor()</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line">data = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line">tensor = torch.tensor(data)</span><br></pre></td></tr></table></figure></li>
</ul>
<p>å½“ä½ æœ‰ç°æœ‰çš„æ•°æ®å­˜å‚¨åœ¨ Python åˆ—è¡¨æˆ– NumPy æ•°ç»„ä¸­ï¼Œå¹¶ä¸”éœ€è¦å°†å…¶è¾“å…¥åˆ° PyTorch æ¨¡å‹è¿›è¡Œè®¡ç®—æ—¶ä½¿ç”¨ã€‚ä¾‹å¦‚ï¼Œåœ¨åŠ è½½æ•°æ®é›†åï¼Œå°†æ•°æ®è½¬æ¢ä¸ºå¼ é‡å½¢å¼ä»¥ä¾¿åç»­å¤„ç†ã€‚</p>
<p>ä»æ•°æ®å­˜å‚¨çš„è§’åº¦æ¥çœ‹ï¼Œ<code>tensor</code> å­˜å‚¨äº† Python åˆ—è¡¨ <code>data</code> ä¸­çš„å…ƒç´  <code>[1, 2, 3]</code>ã€‚å®ƒå°†è¿™äº›æ•°æ®ä»¥ä¸€ç§é«˜æ•ˆçš„ã€é€‚åˆè®¡ç®—æœºå¤„ç†çš„æ–¹å¼ç»„ç»‡èµ·æ¥ï¼Œå­˜å‚¨åœ¨å†…å­˜ä¸­ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>tensor</code> æ˜¯ä¸€ä¸ªä¸€ç»´å¼ é‡ï¼Œå½¢çŠ¶ä¸º <code>(3,)</code>ï¼Œè¿™æ„å‘³ç€å®ƒåŒ…å« 3 ä¸ªå…ƒç´ ã€‚</p>
<p>åœ¨æ•°å­¦è¿ç®—æ–¹é¢ï¼Œ<code>tensor</code> å¯ä»¥å‚ä¸å„ç§æ•°å­¦è¿ç®—ï¼Œå¦‚åŠ æ³•ã€ä¹˜æ³•ã€çŸ©é˜µä¹˜æ³•ç­‰ã€‚PyTorch ä¸ºå¼ é‡æä¾›äº†ä¸°å¯Œçš„æ•°å­¦è¿ç®—å‡½æ•°ï¼Œè¿™äº›è¿ç®—å¯ä»¥åœ¨ CPU æˆ– GPU ä¸Šé«˜æ•ˆæ‰§è¡Œã€‚</p>
<p>åœ¨æ·±åº¦å­¦ä¹ çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œ<code>tensor</code> æ˜¯æ¨¡å‹è¾“å…¥ã€è¾“å‡ºä»¥åŠå‚æ•°çš„åŸºæœ¬è¡¨ç¤ºå½¢å¼ã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸€ä¸ªç®€å•çš„å…¨è¿æ¥ç¥ç»ç½‘ç»œä¸­ï¼Œè¾“å…¥æ•°æ®ä¼šè¢«è½¬æ¢ä¸ºå¼ é‡è¾“å…¥åˆ°ç½‘ç»œä¸­ï¼Œç½‘ç»œçš„æƒé‡å’Œåç½®ä¹Ÿæ˜¯ä»¥å¼ é‡çš„å½¢å¼å­˜å‚¨å’Œæ›´æ–°çš„ã€‚åœ¨ä¸Šè¿°ä¾‹å­ä¸­ï¼Œ<code>tensor</code> å¯ä»¥ä½œä¸ºä¸€ä¸ªç®€å•çš„è¾“å…¥æ•°æ®ç¤ºä¾‹ï¼Œå¦‚æœè¦æ„å»ºä¸€ä¸ªç¥ç»ç½‘ç»œå¤„ç†è¿™ä¸ªè¾“å…¥ï¼Œå¯èƒ½ä¼šè¿›è¡Œå¦‚ä¸‹æ“ä½œï¼ˆä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•ç¤ºä¾‹ï¼‰ï¼š</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ä¸€ä¸ªç®€å•çš„å…¨è¿æ¥å±‚</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SimpleNet</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>(SimpleNet, <span class="variable language_">self</span>).__init__()</span><br><span class="line">        <span class="variable language_">self</span>.fc = nn.Linear(<span class="number">3</span>, <span class="number">1</span>)  <span class="comment"># è¾“å…¥ç»´åº¦ä¸º 3ï¼Œè¾“å‡ºç»´åº¦ä¸º 1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.fc(x)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºæ¨¡å‹å®ä¾‹</span></span><br><span class="line">model = SimpleNet()</span><br><span class="line"></span><br><span class="line"><span class="comment"># å‡†å¤‡è¾“å…¥æ•°æ®</span></span><br><span class="line">data = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line">tensor = torch.tensor(data, dtype=torch.float32).unsqueeze(<span class="number">0</span>)  <span class="comment"># è½¬æ¢ä¸ºé€‚åˆè¾“å…¥æ¨¡å‹çš„å½¢çŠ¶</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿›è¡Œå‰å‘ä¼ æ’­</span></span><br><span class="line">output = model(tensor)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;æ¨¡å‹è¾“å‡º:&quot;</span>, output)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>åˆ›å»ºå…¨é›¶å¼ é‡<code>torch.zeros()</code></p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">zeros_tensor = torch.zeros((<span class="number">2</span>, <span class="number">3</span>))</span><br></pre></td></tr></table></figure></li>
</ul>
<p>å¸¸ç”¨äºåˆå§‹åŒ–æŸäº›å˜é‡ï¼Œå¦‚åœ¨åˆå§‹åŒ–ç¥ç»ç½‘ç»œçš„åç½®é¡¹æ—¶ï¼Œå¯ä½¿ç”¨å…¨é›¶å¼ é‡ã€‚å¦å¤–ï¼Œåœ¨éœ€è¦å¡«å……é›¶å€¼è¿›è¡Œæ•°æ®é¢„å¤„ç†æˆ–å ä½æ—¶ä¹Ÿä¼šç”¨åˆ°ã€‚</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">åˆ›å»ºçš„å…¨é›¶å¼ é‡ï¼š</span><br><span class="line">tensor([[<span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>],</span><br><span class="line">        [<span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>]])</span><br><span class="line">å¼ é‡çš„å½¢çŠ¶ï¼š torch.Size([<span class="number">2</span>, <span class="number">3</span>])</span><br></pre></td></tr></table></figure>

<p>ä¼ å…¥çš„å‚æ•° <code>(2, 3)</code>å¯¹åº”åˆ›å»ºçš„ <code>zeros_tensor</code> æ˜¯ä¸€ä¸ª 2 è¡Œ 3 åˆ—çš„äºŒç»´å¼ é‡ã€‚å¦‚æœä½¿ç”¨ <code>torch.zeros((2, 3, 4))</code> è¿™æ ·çš„ä»£ç ï¼Œé‚£ä¹ˆåˆ›å»ºçš„å°±æ˜¯ä¸€ä¸ªä¸‰ç»´å¼ é‡ï¼Œå…¶ä¸­ <code>2</code> è¡¨ç¤ºæœ€å¤–å±‚ç»´åº¦çš„å¤§å°ï¼ˆå¯ä»¥æƒ³è±¡æˆæœ‰ 2 ä¸ªäºŒç»´çŸ©é˜µå †å åœ¨ä¸€èµ·ï¼‰ï¼Œ<code>3</code> è¡¨ç¤ºæ¯ä¸ªäºŒç»´çŸ©é˜µçš„è¡Œæ•°ï¼Œ<code>4</code> è¡¨ç¤ºæ¯ä¸ªäºŒç»´çŸ©é˜µçš„åˆ—æ•°ã€‚ä¾æ­¤ç±»æ¨ï¼Œå¯¹äºæ›´é«˜ç»´çš„å¼ é‡ï¼Œæ¯ä¸ªæ•°å­—éƒ½ä»£è¡¨å¯¹åº”ç»´åº¦ä¸Šçš„å¤§å°ã€‚ç›¸å½“äºé«˜æ˜¯2ï¼Œè¡Œæ˜¯3ï¼Œåˆ—æ˜¯4</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">åˆ›å»ºçš„å…¨é›¶å¼ é‡ï¼š</span><br><span class="line">tensor([[[<span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>],</span><br><span class="line">         [<span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>],</span><br><span class="line">         [<span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>]],</span><br><span class="line"></span><br><span class="line">        [[<span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>],</span><br><span class="line">         [<span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>],</span><br><span class="line">         [<span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>]]])</span><br><span class="line">å¼ é‡çš„å½¢çŠ¶ï¼š torch.Size([<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>])</span><br></pre></td></tr></table></figure>

<p>å¦‚æœæ˜¯<code>torch.zeros((2, 3, 4, 5))</code>ï¼Œé‚£å°±æ˜¯ä¸¤ä¸ªä¸‰ç»´ï¼ˆä¸‰å±‚ï¼‰çš„4x5çŸ©é˜µå åœ¨ä¸€èµ·ï¼Œæ•°å­—è¶Šå‰å°±ä»£è¡¨è¶Šé«˜ç»´çš„å †å ã€‚</p>
<ul>
<li><p>åˆ›å»ºå…¨ä¸€å¼ é‡**<code>torch.ones()</code>**</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">ones_tensor = torch.ones((<span class="number">2</span>, <span class="number">3</span>))</span><br></pre></td></tr></table></figure></li>
</ul>
<p>ä¸ <code>torch.zeros()</code> ç±»ä¼¼ï¼Œå¯ç”¨äºåˆå§‹åŒ–ç‰¹å®šå˜é‡ã€‚åœ¨ä¸€äº›å½’ä¸€åŒ–æ“ä½œæˆ–éœ€è¦ç‰¹å®šåˆå§‹å€¼ä¸º 1 çš„åœºæ™¯ä¸­ä¼šä½¿ç”¨ã€‚</p>
<ul>
<li><p>åˆ›å»ºæŒ‡å®šå½¢çŠ¶çš„éšæœºå¼ é‡ï¼Œå…ƒç´ å€¼åœ¨[0 , 1)ä¹‹é—´**<code>torch.rand()</code>**</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">random_tensor = torch.rand((<span class="number">2</span>, <span class="number">3</span>))</span><br></pre></td></tr></table></figure></li>
</ul>
<p>åœ¨åˆå§‹åŒ–ç¥ç»ç½‘ç»œçš„æƒé‡æ—¶ï¼Œéšæœºåˆå§‹åŒ–æ˜¯å¸¸è§çš„åšæ³•ï¼Œå¯ä½¿ç”¨ <code>torch.rand()</code> ç”Ÿæˆåˆå§‹æƒé‡å¼ é‡ã€‚</p>
<p><strong>2.æ“ä½œ</strong></p>
<ul>
<li><p><strong><code>torch.cat()</code></strong>ï¼šç”¨äºåœ¨æŒ‡å®šç»´åº¦ä¸Šæ‹¼æ¥å¤šä¸ªå¼ é‡ã€‚</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">a = torch.tensor([[<span class="number">1</span>, <span class="number">2</span>], [<span class="number">3</span>, <span class="number">4</span>]])</span><br><span class="line">b = torch.tensor([[<span class="number">5</span>, <span class="number">6</span>], [<span class="number">7</span>, <span class="number">8</span>]])</span><br><span class="line">c = torch.cat((a, b), dim=<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>å½“éœ€è¦å°†å¤šä¸ªå¼ é‡åˆå¹¶ä¸ºä¸€ä¸ªæ›´å¤§çš„å¼ é‡æ—¶ä½¿ç”¨ã€‚ä¾‹å¦‚ï¼Œåœ¨å¤„ç†å¤šæ¨¡æ€æ•°æ®æ—¶ï¼Œå°†ä¸åŒæ¨¡æ€çš„ç‰¹å¾å¼ é‡æ‹¼æ¥åœ¨ä¸€èµ·ã€‚</p>
<p><code>torch.cat((a, b), dim=1)</code> è¡¨ç¤ºåœ¨ç»´åº¦ 1ï¼ˆåˆ—æ–¹å‘ï¼‰ä¸Šå¯¹å¼ é‡ <code>a</code> å’Œ <code>b</code> è¿›è¡Œæ‹¼æ¥ã€‚å¯ä»¥çœ‹åˆ°ï¼Œæ‹¼æ¥åçš„å¼ é‡ <code>c</code> æ˜¯å°† <code>a</code> å’Œ <code>b</code> çš„åˆ—è¿›è¡Œäº†åˆå¹¶ï¼Œè¡Œæ•°ä¸å˜ï¼Œåˆ—æ•°å˜ä¸ºåŸæ¥ä¸¤ä¸ªå¼ é‡åˆ—æ•°ä¹‹å’Œã€‚åœ¨å¤„ç†å¤šæ¨¡æ€æ•°æ®æ—¶ï¼Œæ¯”å¦‚ä¸€ä¸ªæ¨¡æ€çš„æ•°æ®ç‰¹å¾ç”¨å¼ é‡ <code>a</code> è¡¨ç¤ºï¼Œå¦ä¸€ä¸ªæ¨¡æ€çš„æ•°æ®ç‰¹å¾ç”¨å¼ é‡ <code>b</code> è¡¨ç¤ºï¼Œé€šè¿‡è¿™ç§æ‹¼æ¥æ“ä½œå¯ä»¥å°†ä¸åŒæ¨¡æ€çš„ç‰¹å¾åˆå¹¶åœ¨ä¸€èµ·ï¼Œæ–¹ä¾¿åç»­çš„å¤„ç†ã€‚</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">å¼ é‡ aï¼š</span><br><span class="line">tensor([[<span class="number">1</span>, <span class="number">2</span>],</span><br><span class="line">        [<span class="number">3</span>, <span class="number">4</span>]])</span><br><span class="line">å¼ é‡ bï¼š</span><br><span class="line">tensor([[<span class="number">5</span>, <span class="number">6</span>],</span><br><span class="line">        [<span class="number">7</span>, <span class="number">8</span>]])</span><br><span class="line">æ‹¼æ¥åçš„å¼ é‡ cï¼š</span><br><span class="line">tensor([[<span class="number">1</span>, <span class="number">2</span>, <span class="number">5</span>, <span class="number">6</span>],</span><br><span class="line">        [<span class="number">3</span>, <span class="number">4</span>, <span class="number">7</span>, <span class="number">8</span>]])</span><br></pre></td></tr></table></figure>

<p>åœ¨äºŒç»´å¼ é‡çš„è¯­å¢ƒä¸‹ï¼Œç»´åº¦ 0 ä»£è¡¨è¡Œæ–¹å‘ã€‚<code>torch.cat((a, b), dim=0)</code> ä¼šå°†å¼ é‡ <code>b</code> æŒ‰è¡Œçš„é¡ºåºæ‹¼æ¥åˆ°å¼ é‡ <code>a</code> çš„ä¸‹æ–¹ï¼Œæ‹¼æ¥åçš„å¼ é‡åˆ—æ•°ä¸å˜ï¼Œè¡Œæ•°ä¸ºåŸæ¥ä¸¤ä¸ªå¼ é‡è¡Œæ•°ä¹‹å’Œã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè‹¥ <code>a</code> å’Œ <code>b</code> åˆ†åˆ«è¡¨ç¤ºä¸¤ç»„æ ·æœ¬æ•°æ®ï¼Œåœ¨ç»´åº¦ 0 ä¸Šæ‹¼æ¥å°±ç›¸å½“äºå°†è¿™ä¸¤ç»„æ ·æœ¬åˆå¹¶æˆä¸€ç»„æ›´å¤§çš„æ ·æœ¬é›†ã€‚</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">å¼ é‡ aï¼š</span><br><span class="line">tensor([[<span class="number">1</span>, <span class="number">2</span>],</span><br><span class="line">        [<span class="number">3</span>, <span class="number">4</span>]])</span><br><span class="line">å¼ é‡ bï¼š</span><br><span class="line">tensor([[<span class="number">5</span>, <span class="number">6</span>],</span><br><span class="line">        [<span class="number">7</span>, <span class="number">8</span>]])</span><br><span class="line">åœ¨ç»´åº¦ <span class="number">0</span> ä¸Šæ‹¼æ¥åçš„å¼ é‡ cï¼š</span><br><span class="line">tensor([[<span class="number">1</span>, <span class="number">2</span>],</span><br><span class="line">        [<span class="number">3</span>, <span class="number">4</span>],</span><br><span class="line">        [<span class="number">5</span>, <span class="number">6</span>],</span><br><span class="line">        [<span class="number">7</span>, <span class="number">8</span>]])</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong><code>torch.reshape()</code></strong>ï¼šæ”¹å˜å¼ é‡çš„å½¢çŠ¶ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">x = torch.tensor([1, 2, 3, 4])</span><br><span class="line">reshaped_x = torch.reshape(x, (2, 2))</span><br></pre></td></tr></table></figure>

<p>åœ¨ç¥ç»ç½‘ç»œä¸­ï¼Œä¸åŒå±‚ä¹‹é—´çš„æ•°æ®å½¢çŠ¶å¯èƒ½éœ€è¦è¿›è¡Œè°ƒæ•´ï¼Œä½¿ç”¨ <code>torch.reshape()</code> å¯ä»¥æ–¹ä¾¿åœ°æ”¹å˜å¼ é‡å½¢çŠ¶ä»¥æ»¡è¶³å±‚çš„è¾“å…¥è¦æ±‚ã€‚</p>
<p><code>torch.reshape(x, (2, 2))</code> æ˜¯å°†ä¸€ç»´å¼ é‡ <code>x</code> é‡å¡‘ä¸ºäºŒç»´å¼ é‡ <code>reshaped_x</code>ï¼Œå½¢çŠ¶ä¸º <code>(2, 2)</code>ã€‚åœ¨ç¥ç»ç½‘ç»œä¸­ï¼Œä¸åŒå±‚ä¹‹é—´çš„æ•°æ®å½¢çŠ¶å¯èƒ½ä¸åŒ¹é…ï¼Œä¾‹å¦‚æŸä¸€å±‚çš„è¾“å‡ºæ˜¯ä¸€ç»´å‘é‡ï¼Œè€Œåç»­å±‚éœ€è¦äºŒç»´çŸ©é˜µä½œä¸ºè¾“å…¥ï¼Œè¿™æ—¶å°±å¯ä»¥ä½¿ç”¨ <code>torch.reshape()</code> æ¥è°ƒæ•´æ•°æ®çš„å½¢çŠ¶ï¼Œä½¿å…¶æ»¡è¶³å±‚çš„è¾“å…¥è¦æ±‚ã€‚</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">åŸå§‹å¼ é‡ xï¼š</span><br><span class="line">tensor([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>])</span><br><span class="line">é‡å¡‘åçš„å¼ é‡ reshaped_xï¼š</span><br><span class="line">tensor([[<span class="number">1</span>, <span class="number">2</span>],</span><br><span class="line">        [<span class="number">3</span>, <span class="number">4</span>]])</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong><code>torch.transpose()</code></strong>ï¼šäº¤æ¢å¼ é‡çš„ä¸¤ä¸ªç»´åº¦ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">x = torch.tensor([[1, 2], [3, 4]])</span><br><span class="line">transposed_x = torch.transpose(x, 0, 1)</span><br></pre></td></tr></table></figure>

<p>åœ¨çŸ©é˜µè¿ç®—ä¸­ï¼Œæœ‰æ—¶éœ€è¦å¯¹çŸ©é˜µè¿›è¡Œè½¬ç½®æ“ä½œã€‚åœ¨å›¾åƒå¤„ç†ä¸­ï¼Œå¯èƒ½éœ€è¦è°ƒæ•´å›¾åƒå¼ é‡çš„ç»´åº¦é¡ºåºã€‚</p>
<p><code>torch.transpose(x, 0, 1)</code> è¡¨ç¤ºäº¤æ¢å¼ é‡ <code>x</code> çš„ç¬¬ 0 ç»´å’Œç¬¬ 1 ç»´ã€‚åœ¨è¿™ä¸ªäºŒç»´çŸ©é˜µçš„ä¾‹å­ä¸­ï¼Œå°±æ˜¯å¯¹çŸ©é˜µè¿›è¡Œäº†è½¬ç½®æ“ä½œï¼ŒåŸæ¥çš„è¡Œå˜æˆäº†åˆ—ï¼Œåˆ—å˜æˆäº†è¡Œã€‚åœ¨çŸ©é˜µè¿ç®—ä¸­ï¼ŒçŸ©é˜µè½¬ç½®æ˜¯ä¸€ä¸ªå¸¸è§çš„æ“ä½œï¼Œä¾‹å¦‚åœ¨è®¡ç®—çŸ©é˜µä¹˜æ³•æ—¶å¯èƒ½éœ€è¦å¯¹çŸ©é˜µè¿›è¡Œè½¬ç½®ã€‚åœ¨å›¾åƒå¤„ç†ä¸­ï¼Œå›¾åƒå¼ é‡çš„ç»´åº¦é¡ºåºå¯èƒ½éœ€è¦è°ƒæ•´ï¼Œæ¯”å¦‚å°† <code>(é«˜åº¦, å®½åº¦, é€šé“æ•°)</code> è°ƒæ•´ä¸º <code>(é€šé“æ•°, é«˜åº¦, å®½åº¦)</code> ä»¥é€‚åº”æŸäº›æ¨¡å‹çš„è¾“å…¥è¦æ±‚ï¼Œè¿™æ—¶å°±å¯ä»¥ä½¿ç”¨ <code>torch.transpose()</code> æ¥å®ç°ã€‚</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">åŸå§‹å¼ é‡ xï¼š</span><br><span class="line">tensor([[<span class="number">1</span>, <span class="number">2</span>],</span><br><span class="line">        [<span class="number">3</span>, <span class="number">4</span>]])</span><br><span class="line">è½¬ç½®åçš„å¼ é‡ transposed_xï¼š</span><br><span class="line">tensor([[<span class="number">1</span>, <span class="number">3</span>],</span><br><span class="line">        [<span class="number">2</span>, <span class="number">4</span>]])</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="è‡ªåŠ¨æ±‚å¯¼"><a href="#è‡ªåŠ¨æ±‚å¯¼" class="headerlink" title="è‡ªåŠ¨æ±‚å¯¼"></a>è‡ªåŠ¨æ±‚å¯¼</h4><p><code>requires_grad</code> å’Œ <code>backward()</code></p>
<p>è®¾ç½®å¼ é‡çš„ <code>requires_grad=True</code> æ¥è·Ÿè¸ªå…¶æ“ä½œï¼Œä½¿ç”¨ <code>backward()</code> è®¡ç®—æ¢¯åº¦ã€‚</p>
<p>åœ¨æ·±åº¦å­¦ä¹ æ¨¡å‹è®­ç»ƒä¸­ï¼Œéœ€è¦è®¡ç®—æŸå¤±å‡½æ•°å…³äºæ¨¡å‹å‚æ•°çš„æ¢¯åº¦ï¼Œä»¥ä¾¿ä½¿ç”¨ä¼˜åŒ–ç®—æ³•æ›´æ–°å‚æ•°ã€‚é€šè¿‡è®¾ç½®å‚æ•°å¼ é‡çš„ <code>requires_grad=True</code>ï¼Œå¯ä»¥åˆ©ç”¨è‡ªåŠ¨æ±‚å¯¼æœºåˆ¶è‡ªåŠ¨è®¡ç®—æ¢¯åº¦ã€‚</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">x = torch.tensor([<span class="number">2.0</span>], requires_grad=<span class="literal">True</span>)</span><br><span class="line">y = x ** <span class="number">2</span></span><br><span class="line">y.backward()</span><br><span class="line"><span class="built_in">print</span>(x.grad)  <span class="comment"># è¾“å‡º 4.0</span></span><br></pre></td></tr></table></figure>



<h4 id="ç¥ç»ç½‘ç»œï¼ˆéœ€è¦æ›´å…·ä½“ï¼Œæœ‰å¾ˆå¤šä¸ªï¼‰nn-module"><a href="#ç¥ç»ç½‘ç»œï¼ˆéœ€è¦æ›´å…·ä½“ï¼Œæœ‰å¾ˆå¤šä¸ªï¼‰nn-module" class="headerlink" title="ç¥ç»ç½‘ç»œï¼ˆéœ€è¦æ›´å…·ä½“ï¼Œæœ‰å¾ˆå¤šä¸ªï¼‰nn.module"></a>ç¥ç»ç½‘ç»œï¼ˆéœ€è¦æ›´å…·ä½“ï¼Œæœ‰å¾ˆå¤šä¸ªï¼‰nn.module</h4><p>1.<code>torch.nn.Linear</code>å®šä¹‰å…¨è¿æ¥å±‚ã€‚å…¨è¿æ¥å±‚å¸¸ç”¨äºå¤šå±‚æ„ŸçŸ¥æœºï¼ˆMLPï¼‰ä¸­ï¼Œç”¨äºå°†è¾“å…¥ç‰¹å¾æ˜ å°„åˆ°è¾“å‡ºç‰¹å¾ã€‚</p>
<p>è¾“å…¥å¼ é‡ <code>input_tensor = torch.randn(1, 10)</code> ï¼Œå½¢çŠ¶ä¸º <code>(1, 10)</code>ï¼Œè¿™é‡Œçš„ <code>1</code> è¡¨ç¤ºæ ·æœ¬æ•°é‡ä¸º 1ï¼Œ<code>10</code> è¡¨ç¤ºæ¯ä¸ªæ ·æœ¬å…·æœ‰ 10 ä¸ªç‰¹å¾ï¼Œè¿™ä¸å…¨è¿æ¥å±‚å®šä¹‰çš„è¾“å…¥ç»´åº¦ <code>in_features = 10</code> ç›¸åŒ¹é…ã€‚å¯ä»¥æŠŠç»´åº¦ç†è§£ä¸º10ä¸ªç‰¹å¾ï¼Œå› æ­¤<code>torch.randn(1, 10)</code>å°±æ˜¯ä¸€ä¸ª10ç»´å‘é‡ï¼ˆæœ‰10ä¸ªæ•°å¯¹åº”10ä¸ªç‰¹å¾ï¼‰</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"></span><br><span class="line">linear_layer = nn.Linear(<span class="number">10</span>, <span class="number">5</span>)  <span class="comment"># è¾“å…¥ç»´åº¦ä¸º 10ï¼Œè¾“å‡ºç»´åº¦ä¸º 5</span></span><br><span class="line">input_tensor = torch.randn(<span class="number">1</span>, <span class="number">10</span>)</span><br><span class="line">output = linear_layer(input_tensor)</span><br></pre></td></tr></table></figure>



<p>2.<code>torch.nn.Conv2d</code>å®šä¹‰äºŒç»´å·ç§¯å±‚ã€‚åœ¨è®¡ç®—æœºè§†è§‰é¢†åŸŸï¼Œå·ç§¯å±‚å¹¿æ³›åº”ç”¨äºå›¾åƒåˆ†ç±»ã€ç›®æ ‡æ£€æµ‹ã€è¯­ä¹‰åˆ†å‰²ç­‰ä»»åŠ¡ä¸­ï¼Œç”¨äºæå–å›¾åƒçš„ç‰¹å¾ã€‚</p>
<p>â‘ <code>out_channels = 16</code> çš„å«ä¹‰</p>
<ul>
<li><strong>è¾“å‡ºé€šé“çš„æ•°é‡</strong>ï¼š<code>out_channels</code> è¡¨ç¤ºå·ç§¯å±‚è¾“å‡ºç‰¹å¾å›¾çš„é€šé“æ•°é‡ã€‚åœ¨å·ç§¯ç¥ç»ç½‘ç»œï¼ˆCNNï¼‰ä¸­ï¼Œå·ç§¯å±‚é€šè¿‡ä¸€ç³»åˆ—å·ç§¯æ ¸åœ¨è¾“å…¥ç‰¹å¾å›¾ä¸Šæ»‘åŠ¨è¿›è¡Œå·ç§¯æ“ä½œï¼Œæ¯ä¸ªå·ç§¯æ ¸ä¼šç”Ÿæˆä¸€ä¸ªå¯¹åº”çš„è¾“å‡ºç‰¹å¾å›¾ã€‚è¿™é‡Œ <code>out_channels = 16</code> æ„å‘³ç€è¯¥å·ç§¯å±‚ä½¿ç”¨äº† 16 ä¸ªä¸åŒçš„å·ç§¯æ ¸ï¼Œæ¯ä¸ªå·ç§¯æ ¸ä¼šå¯¹è¾“å…¥ç‰¹å¾å›¾è¿›è¡Œå·ç§¯è®¡ç®—ï¼Œæœ€ç»ˆä¼šè¾“å‡º 16 ä¸ªç‰¹å¾å›¾ï¼Œè¿™äº›ç‰¹å¾å›¾å…±åŒæ„æˆäº†å·ç§¯å±‚çš„è¾“å‡ºï¼Œä¸”è¾“å‡ºçš„é€šé“æ•°ä¸º 16ã€‚</li>
<li><strong>ç‰¹å¾æå–çš„å¤šæ ·æ€§</strong>ï¼šä¸åŒçš„å·ç§¯æ ¸å¯ä»¥å­¦ä¹ åˆ°è¾“å…¥å›¾åƒçš„ä¸åŒç‰¹å¾ï¼Œä¾‹å¦‚è¾¹ç¼˜ã€çº¹ç†ã€é¢œè‰²ç­‰ã€‚é€šè¿‡è®¾ç½®å¤šä¸ªè¾“å‡ºé€šé“ï¼Œå·ç§¯å±‚èƒ½å¤Ÿä»è¾“å…¥å›¾åƒä¸­æå–å¤šç§ä¸åŒç±»å‹çš„ç‰¹å¾ï¼Œä»è€Œä¸°å¯Œäº†æ¨¡å‹å¯¹å›¾åƒç‰¹å¾çš„è¡¨è¾¾èƒ½åŠ›ã€‚åœ¨åç»­çš„ç½‘ç»œå±‚ä¸­ï¼Œè¿™äº›æå–åˆ°çš„ç‰¹å¾ä¼šè¢«è¿›ä¸€æ­¥å¤„ç†å’Œç»„åˆï¼Œç”¨äºå®Œæˆå›¾åƒåˆ†ç±»ã€ç›®æ ‡æ£€æµ‹ç­‰ä»»åŠ¡ã€‚</li>
</ul>
<p>â‘¡<code>kernel_size = 3</code> çš„å«ä¹‰</p>
<ul>
<li><strong>å·ç§¯æ ¸çš„å¤§å°</strong>ï¼š<code>kernel_size</code> å®šä¹‰äº†å·ç§¯æ ¸çš„å°ºå¯¸ã€‚<code>kernel_size = 3</code> è¡¨ç¤ºä½¿ç”¨çš„æ˜¯ä¸€ä¸ª 3x3 çš„å·ç§¯æ ¸ã€‚å·ç§¯æ ¸æ˜¯ä¸€ä¸ªå°çš„äºŒç»´çŸ©é˜µï¼Œåœ¨å·ç§¯æ“ä½œä¸­ï¼Œå®ƒä¼šåœ¨è¾“å…¥ç‰¹å¾å›¾ä¸Šé€è¡Œé€åˆ—åœ°æ»‘åŠ¨ï¼Œä¸è¾“å…¥ç‰¹å¾å›¾çš„å¯¹åº”åŒºåŸŸè¿›è¡Œå…ƒç´ ç›¸ä¹˜å¹¶æ±‚å’Œï¼Œä»è€Œå¾—åˆ°è¾“å‡ºç‰¹å¾å›¾çš„ä¸€ä¸ªå…ƒç´ ã€‚</li>
<li><strong>ç‰¹å¾æ„Ÿå—é‡</strong>ï¼šå·ç§¯æ ¸çš„å¤§å°å†³å®šäº†å·ç§¯å±‚çš„æ„Ÿå—é‡ï¼Œå³è¾“å‡ºç‰¹å¾å›¾ä¸Šçš„ä¸€ä¸ªå…ƒç´ å—åˆ°è¾“å…¥ç‰¹å¾å›¾ä¸Šå¤šå¤§åŒºåŸŸçš„å½±å“ã€‚ä¸€ä¸ª 3x3 çš„å·ç§¯æ ¸æ„å‘³ç€è¾“å‡ºç‰¹å¾å›¾ä¸Šçš„æ¯ä¸ªå…ƒç´ æ˜¯ç”±è¾“å…¥ç‰¹å¾å›¾ä¸Šä¸€ä¸ª 3x3 çš„åŒºåŸŸè®¡ç®—å¾—åˆ°çš„ï¼Œå®ƒèƒ½å¤Ÿæ•æ‰åˆ°è¾“å…¥å›¾åƒä¸­ 3x3 é‚»åŸŸå†…çš„å±€éƒ¨ç‰¹å¾ã€‚è¾ƒå¤§çš„å·ç§¯æ ¸å¯ä»¥æ•æ‰åˆ°æ›´å¤§èŒƒå›´çš„ç‰¹å¾ï¼Œä½†åŒæ—¶ä¹Ÿä¼šå¢åŠ æ¨¡å‹çš„å‚æ•°æ•°é‡å’Œè®¡ç®—é‡ï¼›è¾ƒå°çš„å·ç§¯æ ¸åˆ™æ›´ä¾§é‡äºæ•æ‰å±€éƒ¨ç»†èŠ‚ç‰¹å¾ï¼Œå¹¶ä¸”è®¡ç®—æ•ˆç‡æ›´é«˜ã€‚</li>
</ul>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">conv_layer = nn.Conv2d(in_channels=<span class="number">3</span>, out_channels=<span class="number">16</span>, kernel_size=<span class="number">3</span>)</span><br><span class="line">input_image = torch.randn(<span class="number">1</span>, <span class="number">3</span>, <span class="number">224</span>, <span class="number">224</span>)  <span class="comment"># å‡è®¾è¾“å…¥ä¸º 1 å¼  3 é€šé“ã€224x224 çš„å›¾åƒ</span></span><br><span class="line">output = conv_layer(input_image)</span><br></pre></td></tr></table></figure>



<p>3.<code>torch.nn.ReLU</code>å®šä¹‰ ReLU æ¿€æ´»å‡½æ•°å±‚ã€‚æ¿€æ´»å‡½æ•°ç”¨äºå¼•å…¥éçº¿æ€§ï¼Œä½¿å¾—ç¥ç»ç½‘ç»œèƒ½å¤Ÿå­¦ä¹ æ›´å¤æ‚çš„å‡½æ•°ã€‚ReLU æ˜¯ä¸€ç§å¸¸ç”¨çš„æ¿€æ´»å‡½æ•°ï¼Œåœ¨è®¸å¤šç¥ç»ç½‘ç»œæ¶æ„ä¸­éƒ½æœ‰åº”ç”¨ã€‚</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">relu = nn.ReLU()</span><br><span class="line">input_tensor = torch.randn(<span class="number">1</span>, <span class="number">10</span>)</span><br><span class="line">output = relu(input_tensor)</span><br></pre></td></tr></table></figure>



<h4 id="ä¼˜åŒ–å™¨å’ŒæŸå¤±å‡½æ•°"><a href="#ä¼˜åŒ–å™¨å’ŒæŸå¤±å‡½æ•°" class="headerlink" title="ä¼˜åŒ–å™¨å’ŒæŸå¤±å‡½æ•°"></a>ä¼˜åŒ–å™¨å’ŒæŸå¤±å‡½æ•°</h4><p>1.<code>torch.optim.SGD</code>å®šä¹‰éšæœºæ¢¯åº¦ä¸‹é™ä¼˜åŒ–å™¨ã€‚åœ¨æ¨¡å‹è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œéœ€è¦ä½¿ç”¨ä¼˜åŒ–å™¨æ¥æ›´æ–°æ¨¡å‹çš„å‚æ•°ã€‚SGD æ˜¯ä¸€ç§åŸºæœ¬çš„ä¼˜åŒ–ç®—æ³•ï¼Œé€‚ç”¨äºå¤§å¤šæ•°åœºæ™¯ã€‚</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch.optim <span class="keyword">as</span> optim</span><br><span class="line"></span><br><span class="line">model = nn.Linear(<span class="number">10</span>, <span class="number">5</span>)</span><br><span class="line">optimizer = optim.SGD(model.parameters(), lr=<span class="number">0.01</span>)</span><br></pre></td></tr></table></figure>

<p>2.<code>torch.nn.MSELoss</code>å®šä¹‰å‡æ–¹è¯¯å·®æŸå¤±å‡½æ•°ã€‚å‡æ–¹è¯¯å·®æŸå¤±å‡½æ•°å¸¸ç”¨äºå›å½’é—®é¢˜ï¼Œç”¨äºè¡¡é‡é¢„æµ‹å€¼ä¸çœŸå®å€¼ä¹‹é—´çš„å·®å¼‚ã€‚</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">criterion = nn.MSELoss()</span><br><span class="line">predictions = torch.randn(<span class="number">1</span>, <span class="number">5</span>)</span><br><span class="line">targets = torch.randn(<span class="number">1</span>, <span class="number">5</span>)</span><br><span class="line">loss = criterion(predictions, targets)</span><br></pre></td></tr></table></figure>

<p>3.<code>torch.nn.CrossEntropyLoss</code>å®šä¹‰äº¤å‰ç†µæŸå¤±å‡½æ•°ã€‚äº¤å‰ç†µæŸå¤±å‡½æ•°å¸¸ç”¨äºåˆ†ç±»é—®é¢˜ï¼Œç”¨äºè¡¡é‡æ¨¡å‹è¾“å‡ºçš„æ¦‚ç‡åˆ†å¸ƒä¸çœŸå®æ ‡ç­¾ä¹‹é—´çš„å·®å¼‚ã€‚</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">criterion = nn.CrossEntropyLoss()</span><br><span class="line">logits = torch.randn(<span class="number">1</span>, <span class="number">5</span>)</span><br><span class="line">targets = torch.tensor([<span class="number">1</span>])</span><br><span class="line">loss = criterion(logits, targets)</span><br></pre></td></tr></table></figure>

<h4 id="é¢„è®­ç»ƒæ¨¡å‹ï¼ˆtorchvision-modelsï¼‰"><a href="#é¢„è®­ç»ƒæ¨¡å‹ï¼ˆtorchvision-modelsï¼‰" class="headerlink" title="é¢„è®­ç»ƒæ¨¡å‹ï¼ˆtorchvision.modelsï¼‰"></a>é¢„è®­ç»ƒæ¨¡å‹ï¼ˆtorchvision.modelsï¼‰</h4><h2 id="OSæ“ä½œç³»ç»Ÿæ¥å£æ¨¡å—"><a href="#OSæ“ä½œç³»ç»Ÿæ¥å£æ¨¡å—" class="headerlink" title="OSæ“ä½œç³»ç»Ÿæ¥å£æ¨¡å—"></a>OSæ“ä½œç³»ç»Ÿæ¥å£æ¨¡å—</h2><h2 id="Numpy"><a href="#Numpy" class="headerlink" title="Numpy"></a>Numpy</h2><p>np.stack</p>
]]></content>
      <categories>
        <category>ç§‘ç ”</category>
      </categories>
      <tags>
        <tag>ç§‘ç ”çŸ¥è¯†ç§¯ç´¯</tag>
      </tags>
  </entry>
</search>
